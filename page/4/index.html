<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"enpsl.github.io",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="my blog"><meta property="og:type" content="website"><meta property="og:title" content="å½­è¯—äº®çš„åšå®¢"><meta property="og:url" content="https://enpsl.github.io/page/4/index.html"><meta property="og:site_name" content="å½­è¯—äº®çš„åšå®¢"><meta property="og:description" content="my blog"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="enpsl"><meta property="article:tag" content="å½­è¯—äº® psl pengshiliang blog"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://enpsl.github.io/page/4/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>å½­è¯—äº®çš„åšå®¢</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">å½­è¯—äº®çš„åšå®¢</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> é¦–é¡µ</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> å½’æ¡£</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/03/02/2021-03-02-vagrant/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/03/02/2021-03-02-vagrant/" class="post-title-link" itemprop="url">VagrantåŸºæœ¬å‘½ä»¤</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-02 21:30:00" itemprop="dateCreated datePublished" datetime="2021-03-02T21:30:00+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="vagrant-ä½¿ç”¨"><a href="#vagrant-ä½¿ç”¨" class="headerlink" title="vagrant ä½¿ç”¨"></a>vagrant ä½¿ç”¨</h2><h2 id="init-centos"><a href="#init-centos" class="headerlink" title="init centos"></a>init centos</h2><p>centos7 box ä¸‹è½½åœ°å€<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1kVlAz59">centos7</a></p><p><strong>æ·»åŠ vagrant boxåˆ°box list</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add centos7 Vagrant-CentOS-7.box</span><br></pre></td></tr></table></figure><p><strong>åˆå§‹åŒ–ä¸€ä¸ªè™šæ‹Ÿæœºä½¿ç”¨åˆšæ‰æ·»åŠ çš„vagrant box</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> centos</span><br><span class="line"><span class="built_in">cd</span> centos</span><br><span class="line">vim Vagrantfile</span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ ä¸‹é¢å†…å®¹åˆ°Vagrantfileä¸­</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line">Vagrant.require_version <span class="string">&quot;&gt;= 1.6.0&quot;</span></span><br><span class="line"></span><br><span class="line">boxes = [</span><br><span class="line">    &#123;</span><br><span class="line">        :name =&gt; <span class="string">&quot;docker-node1&quot;</span>,</span><br><span class="line">        :eth1 =&gt; <span class="string">&quot;192.168.205.10&quot;</span>,</span><br><span class="line">        :mem =&gt; <span class="string">&quot;1024&quot;</span>,</span><br><span class="line">        :cpu =&gt; <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        :name =&gt; <span class="string">&quot;docker-node2&quot;</span>,</span><br><span class="line">        :eth1 =&gt; <span class="string">&quot;192.168.205.11&quot;</span>,</span><br><span class="line">        :mem =&gt; <span class="string">&quot;1024&quot;</span>,</span><br><span class="line">        :cpu =&gt; <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Vagrant.configure(2) <span class="keyword">do</span> |config|</span><br><span class="line"></span><br><span class="line">  config.vm.box = <span class="string">&quot;centos7&quot;</span></span><br><span class="line"></span><br><span class="line">  boxes.each <span class="keyword">do</span> |opts|</span><br><span class="line">      config.vm.define opts[:name] <span class="keyword">do</span> |config|</span><br><span class="line">        config.vm.hostname = opts[:name]</span><br><span class="line">        config.vm.provider <span class="string">&quot;vmware_fusion&quot;</span> <span class="keyword">do</span> |v|</span><br><span class="line">          v.vmx[<span class="string">&quot;memsize&quot;</span>] = opts[:mem]</span><br><span class="line">          v.vmx[<span class="string">&quot;numvcpus&quot;</span>] = opts[:cpu]</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        config.vm.provider <span class="string">&quot;virtualbox&quot;</span> <span class="keyword">do</span> |v|</span><br><span class="line">          v.customize [<span class="string">&quot;modifyvm&quot;</span>, :<span class="built_in">id</span>, <span class="string">&quot;--memory&quot;</span>, opts[:mem]]</span><br><span class="line">          v.customize [<span class="string">&quot;modifyvm&quot;</span>, :<span class="built_in">id</span>, <span class="string">&quot;--cpus&quot;</span>, opts[:cpu]]</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        config.vm.network :private_network, ip: opts[:eth1]</span><br><span class="line">      end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  config.vm.provision <span class="string">&quot;shell&quot;</span>, privileged: <span class="literal">true</span>, path: <span class="string">&quot;./setup.sh&quot;</span></span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>install dockerçš„setup.shæ–‡ä»¶</strong></p><p>åœ¨å½“å‰ç›®å½•åˆ›å»ºsetup.shæ–‡ä»¶å¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install some tools</span></span><br><span class="line">sudo yum install -y git vim gcc glibc-static telnet bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># install docker</span></span><br><span class="line">curl -fsSL get.docker.com -o get-docker.sh</span><br><span class="line">sh get-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># start docker service</span></span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker vagrant</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf get-docker.sh</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant up</span><br></pre></td></tr></table></figure><h2 id="vagrant-æŠ¥unknown-filesystem-type-â€˜vboxsfâ€™-è§£å†³æ–¹æ¡ˆ"><a href="#vagrant-æŠ¥unknown-filesystem-type-â€˜vboxsfâ€™-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="vagrant æŠ¥unknown filesystem type â€˜vboxsfâ€™ è§£å†³æ–¹æ¡ˆ"></a>vagrant æŠ¥unknown filesystem type â€˜vboxsfâ€™ è§£å†³æ–¹æ¡ˆ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vagrant plugin install vagrant-vbguest</span><br><span class="line">vagrant destroy &amp;&amp; vagrant up</span><br></pre></td></tr></table></figure><h2 id="init-ubuntu"><a href="#init-ubuntu" class="headerlink" title="init ubuntu"></a>init ubuntu</h2><p>ä½¿ç”¨<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/">æ¸…åæº</a></p><p><strong>ubuntu18çš„boxï¼Œç»ˆç«¯è¿è¡Œå¦‚ä¸‹å‘½ä»¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add \</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/bionic-server-cloudimg-amd64-vagrant.box \</span><br><span class="line">--name ubuntu/bionic</span><br></pre></td></tr></table></figure><p>Vagrantfileè¿™æ ·å†™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">config.vm.box = <span class="string">&quot;ubuntu/bionic&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ¥ç€å°±æ˜¯<code>vagrant up &amp;&amp; vagrant ssh</code>äº†</p><h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><h3 id="åˆ—å‡ºæ‰€æœ‰Box"><a href="#åˆ—å‡ºæ‰€æœ‰Box" class="headerlink" title="åˆ—å‡ºæ‰€æœ‰Box"></a>åˆ—å‡ºæ‰€æœ‰Box</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box list</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ ä¸€ä¸ªBox"><a href="#æ·»åŠ ä¸€ä¸ªBox" class="headerlink" title="æ·»åŠ ä¸€ä¸ªBox"></a>æ·»åŠ ä¸€ä¸ªBox</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add [options] &lt;name, url, or path</span><br></pre></td></tr></table></figure><h3 id="å¯ä»¥ä»https-app-vagrantup-com-boxes-searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶"><a href="#å¯ä»¥ä»https-app-vagrantup-com-boxes-searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶" class="headerlink" title="å¯ä»¥ä»https://app.vagrantup.com/boxes/searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶"></a>å¯ä»¥ä»<a target="_blank" rel="noopener" href="https://app.vagrantup.com/boxes/search%E4%B8%8B%E8%BD%BD%E5%90%84%E7%A7%8DVagrant%E6%98%A0%E5%83%8F%E6%96%87%E4%BB%B6">https://app.vagrantup.com/boxes/searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add ubuntu/trusty64</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box"><a href="#é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box" class="headerlink" title="é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box"></a>é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add https://atlas.hashicorp.com/ubuntu/boxes/trusty64</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ ä¸€ä¸ªæœ¬åœ°box"><a href="#æ·»åŠ ä¸€ä¸ªæœ¬åœ°box" class="headerlink" title="æ·»åŠ ä¸€ä¸ªæœ¬åœ°box"></a>æ·»åŠ ä¸€ä¸ªæœ¬åœ°box</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add &#123;box_name&#125; &#123;file_path&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM"><a href="#åˆå§‹åŒ–ä¸€ä¸ªæ–°VM" class="headerlink" title="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM"></a>åˆå§‹åŒ–ä¸€ä¸ªæ–°VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant init ubuntu/trustry64</span><br></pre></td></tr></table></figure><p>æ­¤å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ªåä¸ºVagrantfileçš„é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure(<span class="string">&quot;2&quot;</span>) <span class="keyword">do</span> |config|</span><br><span class="line">  config.vm.box = <span class="string">&quot;ubuntu/trusty64&quot;</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM-1"><a href="#åˆå§‹åŒ–ä¸€ä¸ªæ–°VM-1" class="headerlink" title="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM"></a>åˆå§‹åŒ–ä¸€ä¸ªæ–°VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant up</span><br></pre></td></tr></table></figure><h3 id="å¯ç”¨SSHç™»é™†VM"><a href="#å¯ç”¨SSHç™»é™†VM" class="headerlink" title="å¯ç”¨SSHç™»é™†VM"></a>å¯ç”¨SSHç™»é™†VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh &lt;node_name&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦ä»è™šæ‹Ÿæœºä¸­é€€å‡ºï¼Œç›´æ¥åœ¨è™šæ‹Ÿæœºä¸­çš„å‘½ä»¤è¡Œè¾“å…¥exitå‘½ä»¤å³å¯</p><h3 id="æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€"><a href="#æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€"></a>æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€</h3><p>è¿›å…¥Vagrantfileé…ç½®æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant status</span><br></pre></td></tr></table></figure><h3 id="å…³é—­VM"><a href="#å…³é—­VM" class="headerlink" title="å…³é—­VM"></a>å…³é—­VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant halt</span><br></pre></td></tr></table></figure><h3 id="é”€æ¯VM"><a href="#é”€æ¯VM" class="headerlink" title="é”€æ¯VM"></a>é”€æ¯VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant destory [name|<span class="built_in">id</span>]</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/03/02/2021-03-02-dockerfile/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/03/02/2021-03-02-dockerfile/" class="post-title-link" itemprop="url">Dockerfile è¯­æ³•æ¢³ç†</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-02 13:30:00" itemprop="dateCreated datePublished" datetime="2021-03-02T13:30:00+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="Dockerfileè¯­æ³•æ¢³ç†"><a href="#Dockerfileè¯­æ³•æ¢³ç†" class="headerlink" title="Dockerfileè¯­æ³•æ¢³ç†"></a>Dockerfileè¯­æ³•æ¢³ç†</h2><h3 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h3><p>from åé¢æ¥base image</p><p>eg:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br></pre></td></tr></table></figure><blockquote><p>å°½é‡ä½¿ç”¨å®˜æ–¹çš„image ä½œä¸ºbase image</p></blockquote><h3 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a>LABEL</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;username@gmail.com&quot;</span> </span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0&quot;</span> </span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> description=<span class="string">&quot;this is description&quot;</span> </span></span><br></pre></td></tr></table></figure><blockquote><p>MetaData ä¸å¯å°‘</p></blockquote><h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><p>æ‰§è¡Œå‘½ä»¤å¹¶åˆ›å»ºæ–°çš„IMAGE LAYER</p><p>ä¸ºäº†ç¾è§‚ï¼Œå¤æ‚çš„RUNç”¨åæ–œæ æ¢è¡Œï¼Œé¿å…æ— ç”¨åˆ†å±‚ï¼Œåˆå¹¶å¤šæ¡å‘½ä»¤æˆä¸€è¡Œã€‚</p><h4 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update &amp;&amp; yum install -y vim \</span></span><br><span class="line"><span class="language-bash">python-dev</span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y perl \</span></span><br><span class="line"><span class="language-bash">pwgen --no-install-recommends &amp;&amp; <span class="built_in">rm</span> -rf \</span></span><br><span class="line"><span class="language-bash">/var/lib/apt/lists/*     <span class="comment">#æ¸…ç†cache</span></span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> /bin/bash -c <span class="string">&#x27;source $HOME/.bashrc;echo #HOME&#x27;</span></span></span><br></pre></td></tr></table></figure><h3 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="built_in">test</span>       <span class="comment"># å¦‚æœæ²¡æœ‰ä¼šè‡ªåŠ¨åˆ›å»ºtestæ–‡ä»¶å¤¹</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> demo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">pwd</span>            <span class="comment"># æ‰“å°/test/demo</span></span></span><br></pre></td></tr></table></figure><blockquote><p>å°½é‡ä½¿ç”¨WORKDIR,ä¸è¦ä½¿ç”¨RUN cd,å°½é‡ä½¿ç”¨ç»å¯¹è·¯å¾„</p></blockquote><h3 id="ADD-and-COPY"><a href="#ADD-and-COPY" class="headerlink" title="ADD and COPY"></a>ADD and COPY</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello /</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> test.tar.gz / <span class="comment"># æ·»åŠ åˆ°æ ¹ç›®å½•å¹¶è§£å‹ç¼©</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello <span class="built_in">test</span> /    <span class="comment"># /root/test/hello</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hello <span class="built_in">test</span> /</span></span><br></pre></td></tr></table></figure><blockquote><p>å¤§éƒ¨åˆ†æƒ…å†µCOPYä¼˜äºï¼ŒADDæœ‰é¢å¤–çš„è§£å‹åŠŸèƒ½ï¼Œæ·»åŠ è¿œç¨‹æ–‡ä»¶æˆ–ç›®å½•ç”¨curlæˆ–wget</p></blockquote><h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> MYSQL_VERSION <span class="number">5.6</span> <span class="comment">#å¸¸é‡</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y mysql-server= <span class="string">&quot;<span class="variable">$&#123;MYSQL_VERSION&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure><h3 id="CMD-amp-ENTRYPOINT"><a href="#CMD-amp-ENTRYPOINT" class="headerlink" title="CMD &amp; ENTRYPOINT"></a>CMD &amp; ENTRYPOINT</h3><p>CMD:è®¾ç½®å®¹å™¨å¯åŠ¨åé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°<br>å¦‚æœdocker runæŒ‡å®šäº†å…¶å®ƒçš„å‘½ä»¤ï¼Œåˆ™å¿½ç•¥CMDå‘½ä»¤<br>å®šä¹‰å¤šä¸ªCMD,åªæœ‰æœ€åä¸€ä¸ªä¼šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run &lt;image&gt;</span><br><span class="line">docker run -it &lt;image&gt; /bin/bash    //æ­¤å‘½ä»¤ä¼šå¿½ç•¥CMDä¸­çš„å‘½ä»¤</span><br></pre></td></tr></table></figure><p>ENTRYPOINT:è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤<br>è®©å®¹å™¨å·²åº”ç”¨ç¨‹åºæˆ–è€…æœåŠ¡çš„æ–¹å¼æ‰§è¡Œ<br>ä¸ä¼šè¢«å¿½ç•¥ï¼Œä¸€å®šä¼šæ‰§è¡Œ</p><h4 id="SHELL-amp-EXEC"><a href="#SHELL-amp-EXEC" class="headerlink" title="SHELL &amp; EXEC"></a>SHELL &amp; EXEC</h4><p>SHELL:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br></pre></td></tr></table></figure><p>EXEC:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;apt-get&quot;</span>, <span class="string">&quot;install&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;vim&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>EXECæ–¹å¼éœ€è¦æŒ‡æ˜è¿è¡Œç¯å¢ƒï¼Œeg:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">ENV</span> name word</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;echo hello <span class="variable">$name</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ›´å¤šè¯¦è§<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">æ‰©å±•é˜…è¯»</a></p><h2 id="Dockerfileå®æˆ˜"><a href="#Dockerfileå®æˆ˜" class="headerlink" title="Dockerfileå®æˆ˜"></a>Dockerfileå®æˆ˜</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> flask-hello-word</span><br><span class="line"><span class="built_in">cd</span> flask-hello-word</span><br><span class="line">vim app.py</span><br></pre></td></tr></table></figure><p>app.pyå†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello docker&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>ç¼–å†™Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">2.7</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;peng.shiliang&lt;1390509500@qq.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /app/       <span class="comment"># appåé¢å¿…é¡»æ¥/ï¼Œå¦åˆ™ä¼šå½“ä½œæ–‡ä»¶</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span>             <span class="comment"># ç«¯å£æ˜ å°„,ä¿è¯è¿œç¨‹èƒ½å¤Ÿè®¿é—®</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t pengshiliang/flask-hello-word .</span><br><span class="line">docker push pengshiliang/flask-hello-word:latest</span><br></pre></td></tr></table></figure><p>è¿è¡Œflask-hello-word</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=demo pengshiliang/flask-hello-word     //--name ä¾¿äºdocker container æ“ä½œ</span><br><span class="line">docker <span class="built_in">exec</span> -it demo ip a       //æŸ¥çœ‹dockerå®¹å™¨ip</span><br><span class="line">curl &lt;demo ip&gt;      //è¾“å‡ºhello docker</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/03/02/2021-03-02-docker/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/03/02/2021-03-02-docker/" class="post-title-link" itemprop="url">Dockerå…¥é—¨</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-02 10:30:00" itemprop="dateCreated datePublished" datetime="2021-03-02T10:30:00+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="èµ‹äºˆdockeræƒé™"><a href="#èµ‹äºˆdockeræƒé™" class="headerlink" title="èµ‹äºˆdockeræƒé™"></a>èµ‹äºˆdockeræƒé™</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vagrant@ubuntu-bionic:~$ sudo groupadd docker</span><br><span class="line">groupadd: group <span class="string">&#x27;docker&#x27;</span> already exists</span><br><span class="line">vagrant@ubuntu-bionic:~$ sudo gpasswd -a vagrant docker</span><br><span class="line">Adding user vagrant to group docker</span><br><span class="line">vagrant@ubuntu-bionic:~$ sudo service docker restart</span><br></pre></td></tr></table></figure><p>é€€å‡ºvagrantåœ¨é‡æ–°è¿›å…¥</p><h2 id="dockeråŸºæœ¬å‘½ä»¤"><a href="#dockeråŸºæœ¬å‘½ä»¤" class="headerlink" title="dockeråŸºæœ¬å‘½ä»¤"></a>dockeråŸºæœ¬å‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// åˆ—ä¸¾æ‰€æœ‰é•œåƒ</span><br><span class="line">docker image <span class="built_in">ls</span></span><br><span class="line">// æŸ¥çœ‹image build å†å²</span><br><span class="line">docker <span class="built_in">history</span> &lt;image <span class="built_in">id</span>&gt;</span><br><span class="line">// è¿è¡Œä¸€ä¸ªimage</span><br><span class="line">docker run &lt;image <span class="built_in">id</span>&gt;</span><br><span class="line">// åˆ—ä¸¾æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span><br><span class="line">docker container <span class="built_in">ls</span></span><br><span class="line">// åˆ—ä¸¾æ‰€æœ‰çš„å®¹å™¨</span><br><span class="line">docker container <span class="built_in">ls</span> -a</span><br><span class="line">// äº¤äº’å¼è¿è¡Œè¿è¡Œï¼ˆå¸¸é©»è¿è¡Œï¼‰</span><br><span class="line">docker run -it &lt;image&gt;</span><br></pre></td></tr></table></figure><h2 id="docker-image-å‘½ä»¤"><a href="#docker-image-å‘½ä»¤" class="headerlink" title="docker image å‘½ä»¤"></a>docker image å‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker images   (docker image <span class="built_in">ls</span>ç¼©å†™)</span><br><span class="line">docker rmi &lt;image <span class="built_in">id</span>&gt;   (docker image <span class="built_in">rm</span> &lt;image <span class="built_in">id</span>&gt;ç¼©å†™)//ç§»é™¤ä¸€ä¸ªé•œåƒ</span><br></pre></td></tr></table></figure><h2 id="docker-containerå‘½ä»¤"><a href="#docker-containerå‘½ä»¤" class="headerlink" title="docker containerå‘½ä»¤"></a>docker containerå‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a    (docker container <span class="built_in">ls</span> -aç¼©å†™)</span><br><span class="line">docker <span class="built_in">rm</span> &lt;image <span class="built_in">id</span>&gt;    (docker container <span class="built_in">rm</span> &lt;image <span class="built_in">id</span>&gt;ç¼©å†™)  //åˆ é™¤ä¸€ä¸ªå®¹å™¨</span><br><span class="line">docker ps -aq   //åˆ—ä¸¾æ‰€æœ‰å®¹å™¨<span class="built_in">id</span></span><br><span class="line">docker ps -f <span class="string">&quot;status=exited&quot;</span> -q     //åˆ—ä¸¾æ‰€æœ‰å·²é€€å‡ºçš„å®¹å™¨</span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -aq)</span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -f <span class="string">&quot;status=exited&quot;</span> -q)</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-02/3.png" alt="avatar"><br><img src="/img/in-post/2019-03-02/4.png" alt="avatar"></p><h2 id="buildä¸€ä¸ªhello-word-image"><a href="#buildä¸€ä¸ªhello-word-image" class="headerlink" title="buildä¸€ä¸ªhello word image"></a>buildä¸€ä¸ªhello word image</h2><h3 id="ç”Ÿæˆhello-wordç¨‹åº"><a href="#ç”Ÿæˆhello-wordç¨‹åº" class="headerlink" title="ç”Ÿæˆhello-wordç¨‹åº"></a>ç”Ÿæˆhello-wordç¨‹åº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> hello-word</span><br><span class="line"><span class="built_in">cd</span> hello-word</span><br><span class="line">vim hello.c</span><br></pre></td></tr></table></figure><p>hello.cå†…å®¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello word\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gcc</span><br><span class="line">sudo apt-get install build-essential</span><br><span class="line">gcc -static hello.c -o hello</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-02/1.png" alt="avatar"></p><h3 id="ç¼–å†™Dockerfile"><a href="#ç¼–å†™Dockerfile" class="headerlink" title="ç¼–å†™Dockerfile"></a>ç¼–å†™Dockerfile</h3><p>æ‰§è¡Œ<code>vim Dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/hello&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="buildå‘½ä»¤"><a href="#buildå‘½ä»¤" class="headerlink" title="buildå‘½ä»¤"></a>buildå‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t &lt;tag&gt; &lt;<span class="built_in">dir</span>&gt;</span><br></pre></td></tr></table></figure><p>eg:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t pengshiliang/hello-word .</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-02/2.png" alt="avatar"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run pengshiliang/hello-word</span><br></pre></td></tr></table></figure><p>å‡ºç°hello word å³ä¸ºæ­£å¸¸build</p><h2 id="å‘å¸ƒ"><a href="#å‘å¸ƒ" class="headerlink" title="å‘å¸ƒ"></a>å‘å¸ƒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push pengshiliang/hello-word:latest</span><br></pre></td></tr></table></figure><h2 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h2><ol><li>é€šè¿‡imageåˆ›å»º</li><li>åœ¨Image layerä¹‹ä¸Šå»ºç«‹ä¸€ä¸ªCotainer layer</li><li>ç±»é¢å‘å¯¹è±¡ï¼šç±»å’Œå®ä¾‹</li><li>imageå¤åˆ¶å­˜å‚¨å’Œåˆ†å‘ï¼Œcontainerè´Ÿè´£è¿è¡Œapp</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/17/2021-02-17-CAP&BASE/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/17/2021-02-17-CAP&BASE/" class="post-title-link" itemprop="url">CAP&BASEç†è®º</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-17 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-17T19:30:00+08:00">2021-02-17</time></span></div></header><div class="post-body" itemprop="articleBody"><p>ç»å†è¿‡æŠ€æœ¯é¢è¯•çš„å°ä¼™ä¼´æƒ³å¿…å¯¹ CAP &amp; BASE è¿™ä¸ªä¸¤ä¸ªç†è®ºå·²ç»å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼</p><p>æˆ‘å½“å¹´å‚åŠ é¢è¯•çš„æ—¶å€™ï¼Œä¸å¤¸å¼ åœ°è¯´ï¼Œåªè¦é—®åˆ°åˆ†å¸ƒå¼ç›¸å…³çš„å†…å®¹ï¼Œé¢è¯•å®˜å‡ ä¹æ˜¯å¿…å®šä¼šé—®è¿™ä¸¤ä¸ªåˆ†å¸ƒå¼ç›¸å…³çš„ç†è®ºã€‚ä¸€æ˜¯å› ä¸ºè¿™ä¸¤ä¸ªåˆ†å¸ƒå¼åŸºç¡€ç†è®ºæ˜¯å­¦ä¹ åˆ†å¸ƒå¼çŸ¥è¯†çš„å¿…å¤‡å‰ç½®åŸºç¡€ï¼ŒäºŒæ˜¯å› ä¸ºå¾ˆå¤šé¢è¯•å®˜è‡ªå·±æ¯”è¾ƒç†Ÿæ‚‰è¿™ä¸¤ä¸ªç†è®ºï¼ˆæ–¹ä¾¿æé—®ï¼‰ã€‚</p><p>æˆ‘ä»¬éå¸¸æœ‰å¿…è¦å°†è¿™ä¸¤ä¸ªç†è®ºææ‡‚ï¼Œå¹¶ä¸”èƒ½å¤Ÿç”¨è‡ªå·±çš„ç†è§£ç»™åˆ«äººè®²å‡ºæ¥ã€‚</p><h2 id="CAP-ç†è®º"><a href="#CAP-ç†è®º" class="headerlink" title="# CAP ç†è®º"></a><a href="#cap-%E7%90%86%E8%AE%BA">#</a> CAP ç†è®º</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86">CAP ç†è®º&#x2F;å®šç†open in new window</a>èµ·æºäº 2000 å¹´ï¼Œç”±åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„ Eric Brewer æ•™æˆåœ¨åˆ†å¸ƒå¼è®¡ç®—åŸç†ç ”è®¨ä¼šï¼ˆPODCï¼‰ä¸Šæå‡ºï¼Œå› æ­¤ CAP å®šç†åˆè¢«ç§°ä½œ <strong>å¸ƒé²å°”å®šç†ï¼ˆBrewerâ€™s theoremï¼‰</strong></p><p>2 å¹´åï¼Œéº»çœç†å·¥å­¦é™¢çš„ Seth Gilbert å’Œ Nancy Lynch å‘è¡¨äº†å¸ƒé²å°”çŒœæƒ³çš„è¯æ˜ï¼ŒCAP ç†è®ºæ­£å¼æˆä¸ºåˆ†å¸ƒå¼é¢†åŸŸçš„å®šç†ã€‚</p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="# ç®€ä»‹"></a><a href="#%E7%AE%80%E4%BB%8B">#</a> ç®€ä»‹</h3><p><strong>CAP</strong> ä¹Ÿå°±æ˜¯ <strong>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰</strong>ã€<strong>Availabilityï¼ˆå¯ç”¨æ€§ï¼‰</strong>ã€<strong>Partition Toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰</strong> è¿™ä¸‰ä¸ªå•è¯é¦–å­—æ¯ç»„åˆã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-11/cap.png" alt="img"></p><p>CAP ç†è®ºçš„æå‡ºè€…å¸ƒé²å°”åœ¨æå‡º CAP çŒœæƒ³çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰è¯¦ç»†å®šä¹‰ <strong>Consistency</strong>ã€<strong>Availability</strong>ã€<strong>Partition Tolerance</strong> ä¸‰ä¸ªå•è¯çš„æ˜ç¡®å®šä¹‰ã€‚</p><p>å› æ­¤ï¼Œå¯¹äº CAP çš„æ°‘é—´è§£è¯»æœ‰å¾ˆå¤šï¼Œä¸€èˆ¬æ¯”è¾ƒè¢«å¤§å®¶æ¨èçš„æ˜¯ä¸‹é¢ ğŸ‘‡ è¿™ç§ç‰ˆæœ¬çš„è§£è¯»ã€‚</p><p>åœ¨ç†è®ºè®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒCAP å®šç†ï¼ˆCAP theoremï¼‰æŒ‡å‡ºå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œå½“è®¾è®¡è¯»å†™æ“ä½œæ—¶ï¼Œåªèƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç‚¹ä¸­çš„ä¸¤ä¸ªï¼š</p><ul><li><strong>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</strong> : æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬</li><li><strong>å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰</strong>: éæ•…éšœçš„èŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†çš„å“åº”ï¼ˆä¸æ˜¯é”™è¯¯æˆ–è€…è¶…æ—¶çš„å“åº”ï¼‰ã€‚</li><li><strong>åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition Toleranceï¼‰</strong> : åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œä»ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚</li></ul><p><strong>ä»€ä¹ˆæ˜¯ç½‘ç»œåˆ†åŒºï¼Ÿ</strong></p><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹å‰çš„ç½‘ç»œæœ¬æ¥æ˜¯è¿é€šçš„ï¼Œä½†æ˜¯å› ä¸ºæŸäº›æ•…éšœï¼ˆæ¯”å¦‚éƒ¨åˆ†èŠ‚ç‚¹ç½‘ç»œå‡ºäº†é—®é¢˜ï¼‰æŸäº›èŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šäº†ï¼Œæ•´ä¸ªç½‘ç»œå°±åˆ†æˆäº†å‡ å—åŒºåŸŸï¼Œè¿™å°±å« <strong>ç½‘ç»œåˆ†åŒº</strong>ã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-11/partition-tolerance.png" alt="partition-tolerance"></p><h3 id="ä¸æ˜¯æ‰€è°“çš„â€œ3-é€‰-2â€"><a href="#ä¸æ˜¯æ‰€è°“çš„â€œ3-é€‰-2â€" class="headerlink" title="# ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€"></a><a href="#%E4%B8%8D%E6%98%AF%E6%89%80%E8%B0%93%E7%9A%84-3-%E9%80%89-2">#</a> ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€</h3><p>å¤§éƒ¨åˆ†äººè§£é‡Šè¿™ä¸€å®šå¾‹æ—¶ï¼Œå¸¸å¸¸ç®€å•çš„è¡¨è¿°ä¸ºï¼šâ€œä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹å¿æ€§ä¸‰è€…ä½ åªèƒ½åŒæ—¶è¾¾åˆ°å…¶ä¸­ä¸¤ä¸ªï¼Œä¸å¯èƒ½åŒæ—¶è¾¾åˆ°â€ã€‚å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªéå¸¸å…·æœ‰è¯¯å¯¼æ€§è´¨çš„è¯´æ³•ï¼Œè€Œä¸”åœ¨ CAP ç†è®ºè¯ç”Ÿ 12 å¹´ä¹‹åï¼ŒCAP ä¹‹çˆ¶ä¹Ÿåœ¨ 2012 å¹´é‡å†™äº†ä¹‹å‰çš„è®ºæ–‡ã€‚</p><blockquote><p><strong>å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­æœåŠ¡ï¼Œé‚£ä¹ˆå¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§åªèƒ½ 2 é€‰ 1ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç½‘ç»œåˆ†åŒºä¹‹å P æ˜¯å‰æï¼Œå†³å®šäº† P ä¹‹åæ‰æœ‰ C å’Œ A çš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰æˆ‘ä»¬æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚</strong></p><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯ï¼šCAP ç†è®ºä¸­åˆ†åŒºå®¹é”™æ€§ P æ˜¯ä¸€å®šè¦æ»¡è¶³çš„ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œåªèƒ½æ»¡è¶³å¯ç”¨æ€§ A æˆ–è€…ä¸€è‡´æ€§ Cã€‚</p></blockquote><p>å› æ­¤ï¼Œ<strong>åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸Šä¸å¯èƒ½é€‰æ‹© CA æ¶æ„ï¼Œåªèƒ½é€‰æ‹© CP æˆ–è€… AP æ¶æ„ã€‚</strong> æ¯”å¦‚ ZooKeeperã€HBase å°±æ˜¯ CP æ¶æ„ï¼ŒCassandraã€Eureka å°±æ˜¯ AP æ¶æ„ï¼ŒNacos ä¸ä»…æ”¯æŒ CP æ¶æ„ä¹Ÿæ”¯æŒ AP æ¶æ„ã€‚</p><p><strong>ä¸ºå•¥ä¸å¯èƒ½é€‰æ‹© CA æ¶æ„å‘¢ï¼Ÿ</strong> ä¸¾ä¸ªä¾‹å­ï¼šè‹¥ç³»ç»Ÿå‡ºç°â€œåˆ†åŒºâ€ï¼Œç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹åœ¨è¿›è¡Œå†™æ“ä½œã€‚ä¸ºäº†ä¿è¯ Cï¼Œ å¿…é¡»è¦ç¦æ­¢å…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œï¼Œè¿™å°±å’Œ A å‘ç”Ÿå†²çªäº†ã€‚å¦‚æœä¸ºäº†ä¿è¯ Aï¼Œå…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œæ­£å¸¸çš„è¯ï¼Œé‚£å°±å’Œ C å‘ç”Ÿå†²çªäº†ã€‚</p><p><strong>é€‰æ‹© CP è¿˜æ˜¯ AP çš„å…³é”®åœ¨äºå½“å‰çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ²¡æœ‰å®šè®ºï¼Œæ¯”å¦‚å¯¹äºéœ€è¦ç¡®ä¿å¼ºä¸€è‡´æ€§çš„åœºæ™¯å¦‚é“¶è¡Œä¸€èˆ¬ä¼šé€‰æ‹©ä¿è¯ CP ã€‚</strong></p><p>å¦å¤–ï¼Œéœ€è¦è¡¥å……è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼š <strong>å¦‚æœç½‘ç»œåˆ†åŒºæ­£å¸¸çš„è¯ï¼ˆç³»ç»Ÿåœ¨ç»å¤§éƒ¨åˆ†æ—¶å€™æ‰€å¤„çš„çŠ¶æ€ï¼‰ï¼Œä¹Ÿå°±è¯´ä¸éœ€è¦ä¿è¯ P çš„æ—¶å€™ï¼ŒC å’Œ A èƒ½å¤ŸåŒæ—¶ä¿è¯ã€‚</strong></p><h3 id="CAP-å®é™…åº”ç”¨æ¡ˆä¾‹"><a href="#CAP-å®é™…åº”ç”¨æ¡ˆä¾‹" class="headerlink" title="# CAP å®é™…åº”ç”¨æ¡ˆä¾‹"></a><a href="#cap-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B">#</a> CAP å®é™…åº”ç”¨æ¡ˆä¾‹</h3><p>æˆ‘è¿™é‡Œä»¥æ³¨å†Œä¸­å¿ƒæ¥æ¢è®¨ä¸€ä¸‹ CAP çš„å®é™…åº”ç”¨ã€‚è€ƒè™‘åˆ°å¾ˆå¤šå°ä¼™ä¼´ä¸çŸ¥é“æ³¨å†Œä¸­å¿ƒæ˜¯å¹²å˜›çš„ï¼Œè¿™é‡Œç®€å•ä»¥ Dubbo ä¸ºä¾‹è¯´ä¸€è¯´ã€‚</p><p>ä¸‹å›¾æ˜¯ Dubbo çš„æ¶æ„å›¾ã€‚<strong>æ³¨å†Œä¸­å¿ƒ Registry åœ¨å…¶ä¸­æ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²å‘¢ï¼Ÿæä¾›äº†ä»€ä¹ˆæœåŠ¡å‘¢ï¼Ÿ</strong></p><p>æ³¨å†Œä¸­å¿ƒè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åªåœ¨å¯åŠ¨æ—¶ä¸æ³¨å†Œä¸­å¿ƒäº¤äº’ï¼Œæ³¨å†Œä¸­å¿ƒä¸è½¬å‘è¯·æ±‚ï¼Œå‹åŠ›è¾ƒå°ã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-11/dubbo-architecture.png" alt="img"></p><p>å¸¸è§çš„å¯ä»¥ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ç»„ä»¶æœ‰ï¼šZooKeeperã€Eurekaã€Nacosâ€¦ã€‚</p><ol><li><strong>ZooKeeper ä¿è¯çš„æ˜¯ CPã€‚</strong> ä»»ä½•æ—¶åˆ»å¯¹ ZooKeeper çš„è¯»è¯·æ±‚éƒ½èƒ½å¾—åˆ°ä¸€è‡´æ€§çš„ç»“æœï¼Œä½†æ˜¯ï¼Œ ZooKeeper ä¸ä¿è¯æ¯æ¬¡è¯·æ±‚çš„å¯ç”¨æ€§æ¯”å¦‚åœ¨ Leader é€‰ä¸¾è¿‡ç¨‹ä¸­æˆ–è€…åŠæ•°ä»¥ä¸Šçš„æœºå™¨ä¸å¯ç”¨çš„æ—¶å€™æœåŠ¡å°±æ˜¯ä¸å¯ç”¨çš„ã€‚</li><li><strong>Eureka ä¿è¯çš„åˆ™æ˜¯ APã€‚</strong> Eureka åœ¨è®¾è®¡çš„æ—¶å€™å°±æ˜¯ä¼˜å…ˆä¿è¯ A ï¼ˆå¯ç”¨æ€§ï¼‰ã€‚åœ¨ Eureka ä¸­ä¸å­˜åœ¨ä»€ä¹ˆ Leader èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€æ ·çš„ã€å¹³ç­‰çš„ã€‚å› æ­¤ Eureka ä¸ä¼šåƒ ZooKeeper é‚£æ ·å‡ºç°é€‰ä¸¾è¿‡ç¨‹ä¸­æˆ–è€…åŠæ•°ä»¥ä¸Šçš„æœºå™¨ä¸å¯ç”¨çš„æ—¶å€™æœåŠ¡å°±æ˜¯ä¸å¯ç”¨çš„æƒ…å†µã€‚ Eureka ä¿è¯å³ä½¿å¤§éƒ¨åˆ†èŠ‚ç‚¹æŒ‚æ‰ä¹Ÿä¸ä¼šå½±å“æ­£å¸¸æä¾›æœåŠ¡ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¯ç”¨çš„å°±è¡Œäº†ã€‚åªä¸è¿‡è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ã€‚</li><li><strong>Nacos ä¸ä»…æ”¯æŒ CP ä¹Ÿæ”¯æŒ APã€‚</strong></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="# æ€»ç»“"></a><a href="#%E6%80%BB%E7%BB%93">#</a> æ€»ç»“</h3><p>åœ¨è¿›è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡å’Œå¼€å‘æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä»…ä»…å±€é™åœ¨ CAP é—®é¢˜ä¸Šï¼Œè¿˜è¦å…³æ³¨ç³»ç»Ÿçš„æ‰©å±•æ€§ã€å¯ç”¨æ€§ç­‰ç­‰</p><p>åœ¨ç³»ç»Ÿå‘ç”Ÿâ€œåˆ†åŒºâ€çš„æƒ…å†µä¸‹ï¼ŒCAP ç†è®ºåªèƒ½æ»¡è¶³ CP æˆ–è€… APã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„å‰ææ˜¯ç³»ç»Ÿå‘ç”Ÿäº†â€œåˆ†åŒºâ€</p><p>å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼ŒèŠ‚ç‚¹é—´çš„ç½‘ç»œè¿æ¥é€šä¿¡æ­£å¸¸çš„è¯ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ P äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒæ—¶ä¿è¯ C å’Œ A äº†ã€‚</p><p>æ€»ç»“ï¼š<strong>å¦‚æœç³»ç»Ÿå‘ç”Ÿâ€œåˆ†åŒºâ€ï¼Œæˆ‘ä»¬è¦è€ƒè™‘é€‰æ‹© CP è¿˜æ˜¯ APã€‚å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼Œæˆ‘ä»¬è¦æ€è€ƒå¦‚ä½•ä¿è¯ CA ã€‚</strong></p><h3 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="# æ¨èé˜…è¯»"></a><a href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB">#</a> æ¨èé˜…è¯»</h3><ol><li><a target="_blank" rel="noopener" href="https://medium.com/@ravindraprasad/cap-theorem-simplified-28499a67eab4">CAP å®šç†ç®€åŒ–open in new window</a> ï¼ˆè‹±æ–‡ï¼Œæœ‰è¶£çš„æ¡ˆä¾‹ï¼‰</li><li><a target="_blank" rel="noopener" href="https://juejin.im/post/6844903936718012430">ç¥ä¸€æ ·çš„ CAP ç†è®ºè¢«åº”ç”¨åœ¨ä½•æ–¹open in new window</a> ï¼ˆä¸­æ–‡ï¼Œåˆ—ä¸¾äº†å¾ˆå¤šå®é™…çš„ä¾‹å­ï¼‰</li><li><a target="_blank" rel="noopener" href="https://martin.kleppmann.com/2015/05/11/please-stop-calling-databases-cp-or-ap.html">è¯·åœæ­¢å‘¼å«æ•°æ®åº“ CP æˆ– AP open in new window</a> ï¼ˆè‹±æ–‡ï¼Œå¸¦ç»™ä½ ä¸ä¸€æ ·çš„æ€è€ƒï¼‰</li></ol><h2 id="BASE-ç†è®º"><a href="#BASE-ç†è®º" class="headerlink" title="# BASE ç†è®º"></a><a href="#base-%E7%90%86%E8%AE%BA">#</a> BASE ç†è®º</h2><p><a target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/1394127.1394128">BASE ç†è®ºopen in new window</a>èµ·æºäº 2008 å¹´ï¼Œ ç”± eBay çš„æ¶æ„å¸ˆ Dan Pritchett åœ¨ ACM ä¸Šå‘è¡¨ã€‚</p><h3 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="# ç®€ä»‹"></a><a href="#%E7%AE%80%E4%BB%8B-1">#</a> ç®€ä»‹</h3><p><strong>BASE</strong> æ˜¯ <strong>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰</strong> ã€<strong>Soft-stateï¼ˆè½¯çŠ¶æ€ï¼‰</strong> å’Œ <strong>Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</strong> ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§ C å’Œå¯ç”¨æ€§ A æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œæ˜¯åŸºäº CAP å®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ï¼Œå®ƒå¤§å¤§é™ä½äº†æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„è¦æ±‚ã€‚</p><h3 id="BASE-ç†è®ºçš„æ ¸å¿ƒæ€æƒ³"><a href="#BASE-ç†è®ºçš„æ ¸å¿ƒæ€æƒ³" class="headerlink" title="# BASE ç†è®ºçš„æ ¸å¿ƒæ€æƒ³"></a><a href="#base-%E7%90%86%E8%AE%BA%E7%9A%84%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3">#</a> BASE ç†è®ºçš„æ ¸å¿ƒæ€æƒ³</h3><p>å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><blockquote><p>ä¹Ÿå°±æ˜¯ç‰ºç‰²æ•°æ®çš„ä¸€è‡´æ€§æ¥æ»¡è¶³ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œç³»ç»Ÿä¸­ä¸€éƒ¨åˆ†æ•°æ®ä¸å¯ç”¨æˆ–è€…ä¸ä¸€è‡´æ—¶ï¼Œä»éœ€è¦ä¿æŒç³»ç»Ÿæ•´ä½“â€œä¸»è¦å¯ç”¨â€ã€‚</p></blockquote><p><strong>BASE ç†è®ºæœ¬è´¨ä¸Šæ˜¯å¯¹ CAP çš„å»¶ä¼¸å’Œè¡¥å……ï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯å¯¹ CAP ä¸­ AP æ–¹æ¡ˆçš„ä¸€ä¸ªè¡¥å……ã€‚</strong></p><p><strong>ä¸ºä»€ä¹ˆè¿™æ ·è¯´å‘¢ï¼Ÿ</strong></p><p>CAP ç†è®ºè¿™èŠ‚æˆ‘ä»¬ä¹Ÿè¯´è¿‡äº†ï¼š</p><blockquote><p>å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼ŒèŠ‚ç‚¹é—´çš„ç½‘ç»œè¿æ¥é€šä¿¡æ­£å¸¸çš„è¯ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ P äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒæ—¶ä¿è¯ C å’Œ A äº†ã€‚å› æ­¤ï¼Œ<strong>å¦‚æœç³»ç»Ÿå‘ç”Ÿâ€œåˆ†åŒºâ€ï¼Œæˆ‘ä»¬è¦è€ƒè™‘é€‰æ‹© CP è¿˜æ˜¯ APã€‚å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼Œæˆ‘ä»¬è¦æ€è€ƒå¦‚ä½•ä¿è¯ CA ã€‚</strong></p></blockquote><p>å› æ­¤ï¼ŒAP æ–¹æ¡ˆåªæ˜¯åœ¨ç³»ç»Ÿå‘ç”Ÿåˆ†åŒºçš„æ—¶å€™æ”¾å¼ƒä¸€è‡´æ€§ï¼Œè€Œä¸æ˜¯æ°¸è¿œæ”¾å¼ƒä¸€è‡´æ€§ã€‚åœ¨åˆ†åŒºæ•…éšœæ¢å¤åï¼Œç³»ç»Ÿåº”è¯¥è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™ä¸€ç‚¹å…¶å®å°±æ˜¯ BASE ç†è®ºå»¶ä¼¸çš„åœ°æ–¹ã€‚</p><h3 id="BASE-ç†è®ºä¸‰è¦ç´ "><a href="#BASE-ç†è®ºä¸‰è¦ç´ " class="headerlink" title="# BASE ç†è®ºä¸‰è¦ç´ "></a><a href="#base-%E7%90%86%E8%AE%BA%E4%B8%89%E8%A6%81%E7%B4%A0">#</a> BASE ç†è®ºä¸‰è¦ç´ </h3><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC81LzI0LzE2MzkxNDgwNmQ5ZTE1YzY?x-oss-process=image/format,png" alt="BASEç†è®ºä¸‰è¦ç´ "></p><h4 id="åŸºæœ¬å¯ç”¨"><a href="#åŸºæœ¬å¯ç”¨" class="headerlink" title="# åŸºæœ¬å¯ç”¨"></a><a href="#%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8">#</a> åŸºæœ¬å¯ç”¨</h4><p>åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ä½†æ˜¯ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚</p><p><strong>ä»€ä¹ˆå«å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§å‘¢ï¼Ÿ</strong></p><ul><li><strong>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±</strong>: æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚éœ€è¦ 0.5s è¿”å›ç»“æœï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚çš„æ—¶é—´å˜ä¸º 3 sã€‚</li><li><strong>ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±</strong>ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ç³»ç»Ÿçš„å…¨éƒ¨åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿè®¿é—®é‡çªç„¶å‰§å¢ï¼Œç³»ç»Ÿçš„éƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ã€‚</li></ul><h4 id="è½¯çŠ¶æ€"><a href="#è½¯çŠ¶æ€" class="headerlink" title="# è½¯çŠ¶æ€"></a><a href="#%E8%BD%AF%E7%8A%B6%E6%80%81">#</a> è½¯çŠ¶æ€</h4><p>è½¯çŠ¶æ€æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼ˆ<strong>CAP ç†è®ºä¸­çš„æ•°æ®ä¸ä¸€è‡´</strong>ï¼‰ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚</p><h4 id="æœ€ç»ˆä¸€è‡´æ€§"><a href="#æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="# æœ€ç»ˆä¸€è‡´æ€§"></a><a href="#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7">#</a> æœ€ç»ˆä¸€è‡´æ€§</h4><p>æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</p><blockquote><p>åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„ 3 ç§çº§åˆ«ï¼š</p><ol><li><strong>å¼ºä¸€è‡´æ€§</strong> ï¼šç³»ç»Ÿå†™å…¥äº†ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„å°±æ˜¯ä»€ä¹ˆã€‚</li><li><strong>å¼±ä¸€è‡´æ€§</strong> ï¼šä¸ä¸€å®šå¯ä»¥è¯»å–åˆ°æœ€æ–°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸ä¿è¯å¤šå°‘æ—¶é—´ä¹‹åè¯»å–åˆ°çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œåªæ˜¯ä¼šå°½é‡ä¿è¯æŸä¸ªæ—¶åˆ»è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong> ï¼šå¼±ä¸€è‡´æ€§çš„å‡çº§ç‰ˆï¼Œç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚</li></ol><p><strong>ä¸šç•Œæ¯”è¾ƒæ¨å´‡æ˜¯æœ€ç»ˆä¸€è‡´æ€§çº§åˆ«ï¼Œä½†æ˜¯æŸäº›å¯¹æ•°æ®ä¸€è‡´è¦æ±‚ååˆ†ä¸¥æ ¼çš„åœºæ™¯æ¯”å¦‚é“¶è¡Œè½¬è´¦è¿˜æ˜¯è¦ä¿è¯å¼ºä¸€è‡´æ€§ã€‚</strong></p></blockquote><p>é‚£å®ç°æœ€ç»ˆä¸€è‡´æ€§çš„å…·ä½“æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢? <a target="_blank" rel="noopener" href="http://gk.link/a/10rZM">ã€Šåˆ†å¸ƒå¼åè®®ä¸ç®—æ³•å®æˆ˜ã€‹open in new window</a> ä¸­æ˜¯è¿™æ ·ä»‹ç»ï¼š</p><blockquote><ul><li><strong>è¯»æ—¶ä¿®å¤</strong> : åœ¨è¯»å–æ•°æ®æ—¶ï¼Œæ£€æµ‹æ•°æ®çš„ä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®å¤ã€‚æ¯”å¦‚ Cassandra çš„ Read Repair å®ç°ï¼Œå…·ä½“æ¥è¯´ï¼Œåœ¨å‘ Cassandra ç³»ç»ŸæŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹åˆ°ä¸åŒèŠ‚ç‚¹ çš„å‰¯æœ¬æ•°æ®ä¸ä¸€è‡´ï¼Œç³»ç»Ÿå°±è‡ªåŠ¨ä¿®å¤æ•°æ®ã€‚</li><li><strong>å†™æ—¶ä¿®å¤</strong> : åœ¨å†™å…¥æ•°æ®ï¼Œæ£€æµ‹æ•°æ®çš„ä¸ä¸€è‡´æ—¶ï¼Œè¿›è¡Œä¿®å¤ã€‚æ¯”å¦‚ Cassandra çš„ Hinted Handoff å®ç°ã€‚å…·ä½“æ¥è¯´ï¼ŒCassandra é›†ç¾¤çš„èŠ‚ç‚¹ä¹‹é—´è¿œç¨‹å†™æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœå†™å¤±è´¥ å°±å°†æ•°æ®ç¼“å­˜ä¸‹æ¥ï¼Œç„¶åå®šæ—¶é‡ä¼ ï¼Œä¿®å¤æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚</li><li><strong>å¼‚æ­¥ä¿®å¤</strong> : è¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œé€šè¿‡å®šæ—¶å¯¹è´¦æ£€æµ‹å‰¯æœ¬æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¹¶ä¿®å¤ã€‚</li></ul></blockquote><p>æ¯”è¾ƒæ¨è <strong>å†™æ—¶ä¿®å¤</strong>ï¼Œè¿™ç§æ–¹å¼å¯¹æ€§èƒ½æ¶ˆè€—æ¯”è¾ƒä½ã€‚</p><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="# æ€»ç»“"></a><a href="#%E6%80%BB%E7%BB%93-1">#</a> æ€»ç»“</h3><p><strong>ACID æ˜¯æ•°æ®åº“äº‹åŠ¡å®Œæ•´æ€§çš„ç†è®ºï¼ŒCAP æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ç†è®ºï¼ŒBASE æ˜¯ CAP ç†è®ºä¸­ AP æ–¹æ¡ˆçš„å»¶ä¼¸ã€‚</strong></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/17/2021-12-30-ZooKeeper%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E4%BA%8C%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/17/2021-12-30-ZooKeeper%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-17 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-17T19:30:00+08:00">2021-02-17</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"><a href="#1-2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰" class="headerlink" title="1. 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"></a>1. 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰</h2><p>ä¸¤é˜¶æ®µæäº¤æ˜¯ä¸€ç§ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§çš„åè®®ï¼Œç°åœ¨å¾ˆå¤šæ•°æ®åº“éƒ½æ˜¯é‡‡ç”¨çš„ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®Œæˆ <strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong> çš„å¤„ç†ã€‚</p><p>åœ¨ä»‹ç»2PCä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æƒ³æƒ³åˆ†å¸ƒå¼äº‹åŠ¡åˆ°åº•æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p><p>è¿˜æ‹¿ç§’æ€ç³»ç»Ÿçš„ä¸‹è®¢å•å’ŒåŠ ç§¯åˆ†ä¸¤ä¸ªç³»ç»Ÿæ¥ä¸¾ä¾‹å§ï¼ˆæˆ‘æƒ³ä½ ä»¬å¯èƒ½éƒ½åäº†ğŸ¤®ğŸ¤®ğŸ¤®ï¼‰ï¼Œæˆ‘ä»¬æ­¤æ—¶ä¸‹å®Œè®¢å•ä¼šå‘ä¸ªæ¶ˆæ¯ç»™ç§¯åˆ†ç³»ç»Ÿå‘Šè¯‰å®ƒä¸‹é¢è¯¥å¢åŠ ç§¯åˆ†äº†ã€‚å¦‚æœæˆ‘ä»¬ä»…ä»…æ˜¯å‘é€ä¸€ä¸ªæ¶ˆæ¯ä¹Ÿä¸æ”¶å›å¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è®¢å•ç³»ç»Ÿæ€ä¹ˆèƒ½çŸ¥é“ç§¯åˆ†ç³»ç»Ÿçš„æ”¶åˆ°æ¶ˆæ¯çš„æƒ…å†µå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬å¢åŠ ä¸€ä¸ªæ”¶å›å¤çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆå½“ç§¯åˆ†ç³»ç»Ÿæ”¶åˆ°æ¶ˆæ¯åè¿”å›ç»™è®¢å•ç³»ç»Ÿä¸€ä¸ª <code>Response</code> ï¼Œä½†åœ¨ä¸­é—´å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨ï¼Œé‚£ä¸ªå›å¤æ¶ˆæ¯æ²¡æœ‰å‘é€æˆåŠŸï¼Œè®¢å•ç³»ç»Ÿæ˜¯ä¸æ˜¯ä»¥ä¸ºç§¯åˆ†ç³»ç»Ÿæ¶ˆæ¯æ¥æ”¶å¤±è´¥äº†ï¼Ÿå®ƒæ˜¯ä¸æ˜¯ä¼šå›æ»šäº‹åŠ¡ï¼Ÿä½†æ­¤æ—¶ç§¯åˆ†ç³»ç»Ÿæ˜¯æˆåŠŸæ”¶åˆ°æ¶ˆæ¯çš„ï¼Œå®ƒå°±ä¼šå»å¤„ç†æ¶ˆæ¯ç„¶åç»™ç”¨æˆ·å¢åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°ç§¯åˆ†åŠ äº†ä½†æ˜¯è®¢å•æ²¡ä¸‹æˆåŠŸã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æ‰€éœ€è¦è§£å†³çš„æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•´ä¸ªè°ƒç”¨é“¾ä¸­ï¼Œæˆ‘ä»¬æ‰€æœ‰æœåŠ¡çš„æ•°æ®å¤„ç†è¦ä¹ˆéƒ½æˆåŠŸè¦ä¹ˆéƒ½å¤±è´¥ï¼Œå³æ‰€æœ‰æœåŠ¡çš„ <strong>åŸå­æ€§é—®é¢˜</strong> ã€‚</p><p>åœ¨ä¸¤é˜¶æ®µæäº¤ä¸­ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯åè°ƒè€…å’Œå‚ä¸è€…ã€‚</p><p>ç¬¬ä¸€é˜¶æ®µï¼šå½“è¦æ‰§è¡Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ—¶å€™ï¼Œäº‹åŠ¡å‘èµ·è€…é¦–å…ˆå‘åè°ƒè€…å‘èµ·äº‹åŠ¡è¯·æ±‚ï¼Œç„¶ååè°ƒè€…ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <code>prepare</code> è¯·æ±‚ï¼ˆå…¶ä¸­åŒ…æ‹¬äº‹åŠ¡å†…å®¹ï¼‰å‘Šè¯‰å‚ä¸è€…ä½ ä»¬éœ€è¦æ‰§è¡Œäº‹åŠ¡äº†ï¼Œå¦‚æœèƒ½æ‰§è¡Œæˆ‘å‘çš„äº‹åŠ¡å†…å®¹é‚£ä¹ˆå°±å…ˆæ‰§è¡Œä½†ä¸æäº¤ï¼Œæ‰§è¡Œåè¯·ç»™æˆ‘å›å¤ã€‚ç„¶åå‚ä¸è€…æ”¶åˆ° <code>prepare</code> æ¶ˆæ¯åï¼Œä»–ä»¬ä¼šå¼€å§‹æ‰§è¡Œäº‹åŠ¡ï¼ˆä½†ä¸æäº¤ï¼‰ï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œä¹‹åå‚ä¸è€…å°±å‘åè°ƒè€…åé¦ˆæ˜¯å¦å‡†å¤‡å¥½äº†ã€‚</p><p>ç¬¬äºŒé˜¶æ®µï¼šç¬¬äºŒé˜¶æ®µä¸»è¦æ˜¯åè°ƒè€…æ ¹æ®å‚ä¸è€…åé¦ˆçš„æƒ…å†µæ¥å†³å®šæ¥ä¸‹æ¥æ˜¯å¦å¯ä»¥è¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œï¼Œå³æäº¤äº‹åŠ¡æˆ–è€…å›æ»šäº‹åŠ¡ã€‚</p><p>æ¯”å¦‚è¿™ä¸ªæ—¶å€™ <strong>æ‰€æœ‰çš„å‚ä¸è€…</strong> éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å°±è¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œåè°ƒè€…æ­¤æ—¶ä¼šç»™æ‰€æœ‰çš„å‚ä¸è€…å‘é€ <strong><code>Commit</code> è¯·æ±‚</strong> ï¼Œå½“å‚ä¸è€…æ”¶åˆ° <code>Commit</code> è¯·æ±‚çš„æ—¶å€™ä¼šæ‰§è¡Œå‰é¢æ‰§è¡Œçš„äº‹åŠ¡çš„ <strong>æäº¤æ“ä½œ</strong> ï¼Œæäº¤å®Œæ¯•ä¹‹åå°†ç»™åè°ƒè€…å‘é€æäº¤æˆåŠŸçš„å“åº”ã€‚</p><p>è€Œå¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µå¹¶ä¸æ˜¯æ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ­¤æ—¶åè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <strong>å›æ»šäº‹åŠ¡çš„ <code>rollback</code> è¯·æ±‚</strong>ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå°†ä¼š <strong>å›æ»šå®ƒåœ¨ç¬¬ä¸€é˜¶æ®µæ‰€åšçš„äº‹åŠ¡å¤„ç†</strong> ï¼Œç„¶åå†å°†å¤„ç†æƒ…å†µè¿”å›ç»™åè°ƒè€…ï¼Œæœ€ç»ˆåè°ƒè€…æ”¶åˆ°å“åº”åä¾¿ç»™äº‹åŠ¡å‘èµ·è€…è¿”å›å¤„ç†å¤±è´¥çš„ç»“æœã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/36a877fb15e7da608af2f12c5279424b796782ff1075e2fffd1351e8180af7db/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37636534653430623638643632353637366262343263323965666365303436612e706e67"><img src="https://camo.githubusercontent.com/36a877fb15e7da608af2f12c5279424b796782ff1075e2fffd1351e8180af7db/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37636534653430623638643632353637366262343263323965666365303436612e706e67" alt="2PCæµç¨‹"></a></p><p>ä¸ªäººè§‰å¾— 2PC å®ç°å¾—è¿˜æ˜¯æ¯”è¾ƒé¸¡è‚‹çš„ï¼Œå› ä¸ºäº‹å®ä¸Šå®ƒåªè§£å†³äº†å„ä¸ªäº‹åŠ¡çš„åŸå­æ€§é—®é¢˜ï¼Œéšä¹‹ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šçš„é—®é¢˜ã€‚</p><ul><li><strong>å•ç‚¹æ•…éšœé—®é¢˜</strong>ï¼Œå¦‚æœåè°ƒè€…æŒ‚äº†é‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿéƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€äº†ã€‚</li><li><strong>é˜»å¡é—®é¢˜</strong>ï¼Œå³å½“åè°ƒè€…å‘é€ <code>prepare</code> è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå¦‚æœèƒ½å¤„ç†é‚£ä¹ˆå®ƒå°†ä¼šè¿›è¡Œäº‹åŠ¡çš„å¤„ç†ä½†å¹¶ä¸æäº¤ï¼Œè¿™ä¸ªæ—¶å€™ä¼šä¸€ç›´å ç”¨ç€èµ„æºä¸é‡Šæ”¾ï¼Œå¦‚æœæ­¤æ—¶åè°ƒè€…æŒ‚äº†ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºéƒ½ä¸ä¼šå†é‡Šæ”¾äº†ï¼Œè¿™ä¼šæå¤§å½±å“æ€§èƒ½ã€‚</li><li><strong>æ•°æ®ä¸ä¸€è‡´é—®é¢˜</strong>ï¼Œæ¯”å¦‚å½“ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…åªå‘é€äº†ä¸€éƒ¨åˆ†çš„ <code>commit</code> è¯·æ±‚å°±æŒ‚äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€ï¼Œæ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œè€Œåé¢æ²¡æ”¶åˆ°çš„åˆ™ä¸ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</li></ul><h2 id="2-3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰"><a href="#2-3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰" class="headerlink" title="2. 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰"></a>2. 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰</h2><p>å› ä¸º2PCå­˜åœ¨çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œæ¯”å¦‚å•ç‚¹ï¼Œå®¹é”™æœºåˆ¶ç¼ºé™·ç­‰ç­‰ï¼Œä»è€Œäº§ç”Ÿäº† <strong>3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰</strong> ã€‚é‚£ä¹ˆè¿™ä¸‰é˜¶æ®µåˆåˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>åƒä¸‡ä¸è¦å§PCç†è§£æˆä¸ªäººç”µè„‘äº†ï¼Œå…¶å®ä»–ä»¬æ˜¯ phase-commit çš„ç¼©å†™ï¼Œå³é˜¶æ®µæäº¤ã€‚</p></blockquote><ol><li><strong>CanCommité˜¶æ®µ</strong>ï¼šåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>CanCommit</code> è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°è¯·æ±‚åä¼šæ ¹æ®è‡ªèº«æƒ…å†µæŸ¥çœ‹æ˜¯å¦èƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œå¦‚æœå¯ä»¥åˆ™è¿”å› YES å“åº”å¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™è¿”å› NO ã€‚</li><li><strong>PreCommité˜¶æ®µ</strong>ï¼šåè°ƒè€…æ ¹æ®å‚ä¸è€…è¿”å›çš„å“åº”æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œä¸‹é¢çš„ <code>PreCommit</code> æ“ä½œã€‚å¦‚æœä¸Šé¢å‚ä¸è€…è¿”å›çš„éƒ½æ˜¯ YESï¼Œé‚£ä¹ˆåè°ƒè€…å°†å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>PreCommit</code> é¢„æäº¤è¯·æ±‚ï¼Œ<strong>å‚ä¸è€…æ”¶åˆ°é¢„æäº¤è¯·æ±‚åï¼Œä¼šè¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œæ“ä½œï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ä¸­</strong> ï¼Œæœ€åå¦‚æœå‚ä¸è€…é¡ºåˆ©æ‰§è¡Œäº†äº‹åŠ¡åˆ™ç»™åè°ƒè€…è¿”å›æˆåŠŸçš„å“åº”ã€‚å¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µåè°ƒè€…æ”¶åˆ°äº† <strong>ä»»ä½•ä¸€ä¸ª NO</strong> çš„ä¿¡æ¯ï¼Œæˆ–è€… <strong>åœ¨ä¸€å®šæ—¶é—´å†…</strong> å¹¶æ²¡æœ‰æ”¶åˆ°å…¨éƒ¨çš„å‚ä¸è€…çš„å“åº”ï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡ï¼Œå®ƒä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€ä¸­æ–­è¯·æ±‚ï¼ˆabortï¼‰ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ä¹‹åä¼šç«‹å³ä¸­æ–­äº‹åŠ¡ï¼Œæˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åè°ƒè€…çš„è¯·æ±‚ï¼Œå®ƒä¹Ÿä¼šä¸­æ–­äº‹åŠ¡ã€‚</li><li><strong>DoCommité˜¶æ®µ</strong>ï¼šè¿™ä¸ªé˜¶æ®µå…¶å®å’Œ <code>2PC</code> çš„ç¬¬äºŒé˜¶æ®µå·®ä¸å¤šï¼Œå¦‚æœåè°ƒè€…æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…åœ¨ <code>PreCommit</code> é˜¶æ®µçš„ YES å“åº”ï¼Œé‚£ä¹ˆåè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <code>DoCommit</code> è¯·æ±‚ï¼Œ<strong>å‚ä¸è€…æ”¶åˆ° <code>DoCommit</code> è¯·æ±‚ååˆ™ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤å·¥ä½œ</strong>ï¼Œå®Œæˆååˆ™ä¼šç»™åè°ƒè€…è¿”å›å“åº”ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…è¿”å›çš„äº‹åŠ¡æäº¤æˆåŠŸçš„å“åº”ä¹‹ååˆ™å®Œæˆäº‹åŠ¡ã€‚è‹¥åè°ƒè€…åœ¨ <code>PreCommit</code> é˜¶æ®µ <strong>æ”¶åˆ°äº†ä»»ä½•ä¸€ä¸ª NO æˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„å“åº”</strong> ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œä¸­æ–­è¯·æ±‚çš„å‘é€ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ååˆ™ä¼š <strong>é€šè¿‡ä¸Šé¢è®°å½•çš„å›æ»šæ—¥å¿—</strong> æ¥è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œå¹¶å‘åè°ƒè€…åé¦ˆå›æ»šçŠ¶å†µï¼Œåè°ƒè€…æ”¶åˆ°å‚ä¸è€…è¿”å›çš„æ¶ˆæ¯åï¼Œä¸­æ–­äº‹åŠ¡ã€‚</li></ol><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/1f5526f43f64af9da097a3e968567288354283c2abb7f997c90ed24ca969350f/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f64306234343336316337343635393366373061366534326332393862343133612e706e67"><img src="https://camo.githubusercontent.com/1f5526f43f64af9da097a3e968567288354283c2abb7f997c90ed24ca969350f/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f64306234343336316337343635393366373061366534326332393862343133612e706e67" alt="3PCæµç¨‹"></a></p><blockquote><p>è¿™é‡Œæ˜¯ <code>3PC</code> åœ¨æˆåŠŸçš„ç¯å¢ƒä¸‹çš„æµç¨‹å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>3PC</code> åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œäº†è¶…æ—¶ä¸­æ–­çš„å¤„ç†ï¼Œæ¯”å¦‚åè°ƒè€…åœ¨æŒ‡å®šæ—¶é—´å†…ä¸ºæ”¶åˆ°å…¨éƒ¨çš„ç¡®è®¤æ¶ˆæ¯åˆ™è¿›è¡Œäº‹åŠ¡ä¸­æ–­çš„å¤„ç†ï¼Œè¿™æ ·èƒ½ <strong>å‡å°‘åŒæ­¥é˜»å¡çš„æ—¶é—´</strong> ã€‚è¿˜æœ‰éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**<code>3PC</code> åœ¨ <code>DoCommit</code> é˜¶æ®µå‚ä¸è€…å¦‚æœªæ”¶åˆ°åè°ƒè€…å‘é€çš„æäº¤äº‹åŠ¡çš„è¯·æ±‚ï¼Œå®ƒä¼šåœ¨ä¸€å®šæ—¶é—´å†…è¿›è¡Œäº‹åŠ¡çš„æäº¤<strong>ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿæ˜¯å› ä¸ºè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‚¯å®š</strong>ä¿è¯äº†åœ¨ç¬¬ä¸€é˜¶æ®µæ‰€æœ‰çš„åè°ƒè€…å…¨éƒ¨è¿”å›äº†å¯ä»¥æ‰§è¡Œäº‹åŠ¡çš„å“åº”<strong>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ç†ç”±</strong>ç›¸ä¿¡å…¶ä»–ç³»ç»Ÿéƒ½èƒ½è¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œå’Œæäº¤<strong>ï¼Œæ‰€ä»¥</strong>ä¸ç®¡**åè°ƒè€…æœ‰æ²¡æœ‰å‘æ¶ˆæ¯ç»™å‚ä¸è€…ï¼Œè¿›å…¥ç¬¬ä¸‰é˜¶æ®µå‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œã€‚</p></blockquote><p>æ€»ä¹‹ï¼Œ<code>3PC</code> é€šè¿‡ä¸€ç³»åˆ—çš„è¶…æ—¶æœºåˆ¶å¾ˆå¥½çš„ç¼“è§£äº†é˜»å¡é—®é¢˜ï¼Œä½†æ˜¯æœ€é‡è¦çš„ä¸€è‡´æ€§å¹¶æ²¡æœ‰å¾—åˆ°æ ¹æœ¬çš„è§£å†³ï¼Œæ¯”å¦‚åœ¨ <code>PreCommit</code> é˜¶æ®µï¼Œå½“ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº†è¯·æ±‚ä¹‹åå…¶ä»–å‚ä¸è€…å’Œåè°ƒè€…æŒ‚äº†æˆ–è€…å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œè¿™ä¸ªæ—¶å€™æ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œè¿™å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</p><p>æ‰€ä»¥ï¼Œè¦è§£å†³ä¸€è‡´æ€§é—®é¢˜è¿˜éœ€è¦é  <code>Paxos</code> ç®—æ³•â­ï¸ â­ï¸ â­ï¸ ã€‚</p><h2 id="3-Paxos-ç®—æ³•"><a href="#3-Paxos-ç®—æ³•" class="headerlink" title="3.Paxos ç®—æ³•"></a>3.<code>Paxos</code> ç®—æ³•</h2><p><code>Paxos</code> ç®—æ³•æ˜¯åŸºäº<strong>æ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•</strong>ï¼Œæ˜¯ç›®å‰å…¬è®¤çš„è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜æœ€æœ‰æ•ˆçš„ç®—æ³•ä¹‹ä¸€ï¼Œ<strong>å…¶è§£å†³çš„é—®é¢˜å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å°±æŸä¸ªå€¼ï¼ˆå†³è®®ï¼‰è¾¾æˆä¸€è‡´</strong> ã€‚</p><p>åœ¨ <code>Paxos</code> ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º <code>Proposerææ¡ˆè€…</code>ã€<code>Acceptorè¡¨å†³è€…</code>ã€<code>Learnerå­¦ä¹ è€…</code>ã€‚<code>Paxos</code> ç®—æ³•å’Œ <code>2PC</code> ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸º <code>Prepare</code> å’Œ <code>accept</code> é˜¶æ®µã€‚</p><h3 id="3-1-prepare-é˜¶æ®µ"><a href="#3-1-prepare-é˜¶æ®µ" class="headerlink" title="3.1. prepare é˜¶æ®µ"></a>3.1. prepare é˜¶æ®µ</h3><ul><li><code>Proposerææ¡ˆè€…</code>ï¼šè´Ÿè´£æå‡º <code>proposal</code>ï¼Œæ¯ä¸ªææ¡ˆè€…åœ¨æå‡ºææ¡ˆæ—¶éƒ½ä¼šé¦–å…ˆè·å–åˆ°ä¸€ä¸ª <strong>å…·æœ‰å…¨å±€å”¯ä¸€æ€§çš„ã€é€’å¢çš„ææ¡ˆç¼–å·N</strong>ï¼Œå³åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ˜¯å”¯ä¸€çš„ç¼–å· Nï¼Œç„¶åå°†è¯¥ç¼–å·èµ‹äºˆå…¶è¦æå‡ºçš„ææ¡ˆï¼Œåœ¨<strong>ç¬¬ä¸€é˜¶æ®µæ˜¯åªå°†ææ¡ˆç¼–å·å‘é€ç»™æ‰€æœ‰çš„è¡¨å†³è€…</strong>ã€‚</li><li><code>Acceptorè¡¨å†³è€…</code>ï¼šæ¯ä¸ªè¡¨å†³è€…åœ¨ <code>accept</code> æŸææ¡ˆåï¼Œä¼šå°†è¯¥ææ¡ˆç¼–å·Nè®°å½•åœ¨æœ¬åœ°ï¼Œè¿™æ ·æ¯ä¸ªè¡¨å†³è€…ä¸­ä¿å­˜çš„å·²ç»è¢« accept çš„ææ¡ˆä¸­ä¼šå­˜åœ¨ä¸€ä¸ª<strong>ç¼–å·æœ€å¤§çš„ææ¡ˆ</strong>ï¼Œå…¶ç¼–å·å‡è®¾ä¸º <code>maxN</code>ã€‚æ¯ä¸ªè¡¨å†³è€…ä»…ä¼š <code>accept</code> ç¼–å·å¤§äºè‡ªå·±æœ¬åœ° <code>maxN</code> çš„ææ¡ˆï¼Œåœ¨æ‰¹å‡†ææ¡ˆæ—¶è¡¨å†³è€…ä¼šå°†ä»¥å‰æ¥å—è¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆä½œä¸ºå“åº”åé¦ˆç»™ <code>Proposer</code> ã€‚</li></ul><blockquote><p>ä¸‹é¢æ˜¯ <code>prepare</code> é˜¶æ®µçš„æµç¨‹å›¾ï¼Œä½ å¯ä»¥å¯¹ç…§ç€å‚è€ƒä¸€ä¸‹ã€‚</p></blockquote><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/958acf97caf9cb2405b7004dceb966a4c587f43bcc78af3bf150c932dbdf53e8/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f32326538643531326439353436373662646630636339326432303061663865662e706e67"><img src="https://camo.githubusercontent.com/958acf97caf9cb2405b7004dceb966a4c587f43bcc78af3bf150c932dbdf53e8/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f32326538643531326439353436373662646630636339326432303061663865662e706e67" alt="paxosç¬¬ä¸€é˜¶æ®µ"></a></p><h3 id="3-2-accept-é˜¶æ®µ"><a href="#3-2-accept-é˜¶æ®µ" class="headerlink" title="3.2. accept é˜¶æ®µ"></a>3.2. accept é˜¶æ®µ</h3><p>å½“ä¸€ä¸ªææ¡ˆè¢« <code>Proposer</code> æå‡ºåï¼Œå¦‚æœ <code>Proposer</code> æ”¶åˆ°äº†è¶…è¿‡åŠæ•°çš„ <code>Acceptor</code> çš„æ‰¹å‡†ï¼ˆ<code>Proposer</code> æœ¬èº«åŒæ„ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶ <code>Proposer</code> ä¼šç»™æ‰€æœ‰çš„ <code>Acceptor</code> å‘é€çœŸæ­£çš„ææ¡ˆï¼ˆä½ å¯ä»¥ç†è§£ä¸ºç¬¬ä¸€é˜¶æ®µä¸ºè¯•æ¢ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™ <code>Proposer</code> å°±ä¼šå‘é€ææ¡ˆçš„å†…å®¹å’Œææ¡ˆç¼–å·ã€‚</p><p>è¡¨å†³è€…æ”¶åˆ°ææ¡ˆè¯·æ±‚åä¼šå†æ¬¡æ¯”è¾ƒæœ¬èº«å·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ææ¡ˆç¼–å·å’Œè¯¥ææ¡ˆç¼–å·ï¼Œå¦‚æœè¯¥ææ¡ˆç¼–å· <strong>å¤§äºç­‰äº</strong> å·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ææ¡ˆç¼–å·ï¼Œé‚£ä¹ˆå°± <code>accept</code> è¯¥ææ¡ˆï¼ˆæ­¤æ—¶æ‰§è¡Œææ¡ˆå†…å®¹ä½†ä¸æäº¤ï¼‰ï¼Œéšåå°†æƒ…å†µè¿”å›ç»™ <code>Proposer</code> ã€‚å¦‚æœä¸æ»¡è¶³åˆ™ä¸å›åº”æˆ–è€…è¿”å› NO ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b14a7f3dbb14ca52f7c2c16ec32f607c16319a11da5e512b2270fdf7691c42de/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62383235333666393536663730613538346336613230633130313133663232352e706e67"><img src="https://camo.githubusercontent.com/b14a7f3dbb14ca52f7c2c16ec32f607c16319a11da5e512b2270fdf7691c42de/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62383235333666393536663730613538346336613230633130313133663232352e706e67" alt="paxosç¬¬äºŒé˜¶æ®µ1"></a></p><p>å½“ <code>Proposer</code> æ”¶åˆ°è¶…è¿‡åŠæ•°çš„ <code>accept</code> ï¼Œé‚£ä¹ˆå®ƒè¿™ä¸ªæ—¶å€™ä¼šå‘æ‰€æœ‰çš„ <code>acceptor</code> å‘é€ææ¡ˆçš„æäº¤è¯·æ±‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºä¸Šè¿°ä»…ä»…æ˜¯è¶…è¿‡åŠæ•°çš„ <code>acceptor</code> æ‰¹å‡†æ‰§è¡Œäº†è¯¥ææ¡ˆå†…å®¹ï¼Œå…¶ä»–æ²¡æœ‰æ‰¹å‡†çš„å¹¶æ²¡æœ‰æ‰§è¡Œè¯¥ææ¡ˆå†…å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™éœ€è¦<strong>å‘æœªæ‰¹å‡†çš„ <code>acceptor</code> å‘é€ææ¡ˆå†…å®¹å’Œææ¡ˆç¼–å·å¹¶è®©å®ƒæ— æ¡ä»¶æ‰§è¡Œå’Œæäº¤</strong>ï¼Œè€Œå¯¹äºå‰é¢å·²ç»æ‰¹å‡†è¿‡è¯¥ææ¡ˆçš„ <code>acceptor</code> æ¥è¯´ <strong>ä»…ä»…éœ€è¦å‘é€è¯¥ææ¡ˆçš„ç¼–å·</strong> ï¼Œè®© <code>acceptor</code> æ‰§è¡Œæäº¤å°±è¡Œäº†ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b52244dcbd9969bdf2938521312ab29333a6a9b2d6264335e0e430f2dcf3f4f0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37343338383962393734383566646665323039346535656630616636623134312e706e67"><img src="https://camo.githubusercontent.com/b52244dcbd9969bdf2938521312ab29333a6a9b2d6264335e0e430f2dcf3f4f0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37343338383962393734383566646665323039346535656630616636623134312e706e67" alt="paxosç¬¬äºŒé˜¶æ®µ2"></a></p><p>è€Œå¦‚æœ <code>Proposer</code> å¦‚æœæ²¡æœ‰æ”¶åˆ°è¶…è¿‡åŠæ•°çš„ <code>accept</code> é‚£ä¹ˆå®ƒå°†ä¼šå°† <strong>é€’å¢</strong> è¯¥ <code>Proposal</code> çš„ç¼–å·ï¼Œç„¶å <strong>é‡æ–°è¿›å…¥ <code>Prepare</code> é˜¶æ®µ</strong> ã€‚</p><blockquote><p>å¯¹äº <code>Learner</code> æ¥è¯´å¦‚ä½•å»å­¦ä¹  <code>Acceptor</code> æ‰¹å‡†çš„ææ¡ˆå†…å®¹ï¼Œè¿™æœ‰å¾ˆå¤šæ–¹å¼ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»äº†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šã€‚</p></blockquote><h3 id="3-3-paxos-ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜"><a href="#3-3-paxos-ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜" class="headerlink" title="3.3. paxos ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜"></a>3.3. <code>paxos</code> ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜</h3><p>å…¶å®å°±æœ‰ç‚¹ç±»ä¼¼äºä¸¤ä¸ªäººåµæ¶ï¼Œå°æ˜è¯´æˆ‘æ˜¯å¯¹çš„ï¼Œå°çº¢è¯´æˆ‘æ‰æ˜¯å¯¹çš„ï¼Œä¸¤ä¸ªäººæ®ç†åŠ›äº‰çš„è°ä¹Ÿä¸è®©è°ğŸ¤¬ğŸ¤¬ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œæ­¤æ—¶ææ¡ˆè€… P1 æå‡ºä¸€ä¸ªæ–¹æ¡ˆ M1ï¼Œå®Œæˆäº† <code>Prepare</code> é˜¶æ®µçš„å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™ <code>acceptor</code> åˆ™æ‰¹å‡†äº† M1ï¼Œä½†æ˜¯æ­¤æ—¶ææ¡ˆè€… P2 åŒæ—¶ä¹Ÿæå‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆ M2ï¼Œå®ƒä¹Ÿå®Œæˆäº† <code>Prepare</code> é˜¶æ®µçš„å·¥ä½œã€‚ç„¶å P1 çš„æ–¹æ¡ˆå·²ç»ä¸èƒ½åœ¨ç¬¬äºŒé˜¶æ®µè¢«æ‰¹å‡†äº†ï¼ˆå› ä¸º <code>acceptor</code> å·²ç»æ‰¹å‡†äº†æ¯” M1 æ›´å¤§çš„ M2ï¼‰ï¼Œæ‰€ä»¥ P1 è‡ªå¢æ–¹æ¡ˆå˜ä¸º M3 é‡æ–°è¿›å…¥ <code>Prepare</code> é˜¶æ®µï¼Œç„¶å <code>acceptor</code> ï¼Œåˆæ‰¹å‡†äº†æ–°çš„ M3 æ–¹æ¡ˆï¼Œå®ƒåˆä¸èƒ½æ‰¹å‡† M2 äº†ï¼Œè¿™ä¸ªæ—¶å€™ M2 åˆè‡ªå¢è¿›å…¥ <code>Prepare</code> é˜¶æ®µã€‚ã€‚ã€‚</p><p>å°±è¿™æ ·æ— ä¼‘æ— æ­¢çš„æ°¸è¿œææ¡ˆä¸‹å»ï¼Œè¿™å°±æ˜¯ <code>paxos</code> ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œäººå¤šäº†å®¹æ˜“åµæ¶ï¼Œæˆ‘ç°åœ¨ <strong>å°±å…è®¸ä¸€ä¸ªèƒ½ææ¡ˆ</strong> å°±è¡Œäº†ã€‚</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/15/2021-02-15-kafka%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/15/2021-02-15-kafka%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Kafkaé¢è¯•é—®é¢˜æ€»ç»“</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-15 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-15T19:30:00+08:00">2021-02-15</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-Apache-Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-Apache-Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1. Apache Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ"></a>1. Apache Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Apach Kafkaæ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼Œç”¨äºå®æ—¶æ„å»ºæµå¤„ç†åº”ç”¨ã€‚å®ƒæœ‰ä¸€ä¸ªæ ¸å¿ƒçš„åŠŸèƒ½å¹¿ä¸ºäººçŸ¥ï¼Œå³ä½œä¸ºä¼ä¸šçº§çš„æ¶ˆæ¯å¼•æ“è¢«å¹¿æ³›ä½¿ç”¨ï¼ˆé€šå¸¸ä¹Ÿä¼šç§°ä¹‹ä¸ºæ¶ˆæ¯æ€»çº¿message busï¼‰ã€‚</p><h2 id="2-Kafka-çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#2-Kafka-çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="2. Kafka çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>2. Kafka çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2><p>Kafka å°†æ¶ˆæ¯ä»¥ topic ä¸ºå•ä½è¿›è¡Œå½’çº³</p><p>å°†å‘ Kafka topic å‘å¸ƒæ¶ˆæ¯çš„ç¨‹åºæˆä¸º producers.</p><p>å°†é¢„è®¢ topics å¹¶æ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºæˆä¸º consumer.</p><p>Kafka ä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å«åšä¸€ä¸ª broker.</p><p>producers é€šè¿‡ç½‘ç»œå°†æ¶ˆæ¯å‘é€åˆ° Kafka é›†ç¾¤ï¼Œé›†ç¾¤å‘æ¶ˆè´¹è€…æä¾›æ¶ˆæ¯</p><h2 id="3-Kafka-å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ"><a href="#3-Kafka-å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ" class="headerlink" title="3. Kafka å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ"></a>3. Kafka å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ</h2><p><code>Kafka</code> çš„åŸºæœ¬æ¶æ„ç»„æˆæ˜¯ï¼šç”±å¤šä¸ª <code>broker</code> ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œæ¯ä¸ª <code>broker</code> æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼›å½“åˆ›å»ºä¸€ä¸ª <code>topic</code> æ—¶ï¼Œè¿™ä¸ª <code>topic</code> ä¼šè¢«åˆ’åˆ†ä¸ºå¤šä¸ª <code>partition</code>ï¼Œæ¯ä¸ª <code>partition</code> å¯ä»¥å­˜åœ¨äºä¸åŒçš„ <code>broker</code> ä¸Šï¼Œæ¯ä¸ª <code>partition</code> åªå­˜æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚</p><p>è¿™å°±æ˜¯<strong>å¤©ç„¶çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼Œå°±æ˜¯è¯´ä¸€ä¸ª <code>topic</code> çš„æ•°æ®ï¼Œæ˜¯<strong>åˆ†æ•£æ”¾åœ¨å¤šä¸ªæœºå™¨ä¸Šçš„ï¼Œæ¯ä¸ªæœºå™¨å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®</strong>ã€‚</p><p>åœ¨ <code>Kafka 0.8</code> ç‰ˆæœ¬ä¹‹å‰ï¼Œæ˜¯æ²¡æœ‰ <code>HA</code> æœºåˆ¶çš„ï¼Œå½“ä»»ä½•ä¸€ä¸ª <code>broker</code> æ‰€åœ¨èŠ‚ç‚¹å®•æœºäº†ï¼Œè¿™ä¸ª <code>broker</code> ä¸Šçš„ <code>partition</code> å°±æ— æ³•æä¾›è¯»å†™æœåŠ¡ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬ä¹‹å‰ï¼Œ<code>Kafka</code> æ²¡æœ‰ä»€ä¹ˆé«˜å¯ç”¨æ€§å¯è¨€ã€‚</p><p>åœ¨ <code>Kafka 0.8</code> ä»¥åï¼Œæä¾›äº† <code>HA</code> æœºåˆ¶ï¼Œå°±æ˜¯ <code>replica</code> å‰¯æœ¬æœºåˆ¶ã€‚æ¯ä¸ª <code>partition</code> ä¸Šçš„æ•°æ®éƒ½ä¼šåŒæ­¥åˆ°å…¶å®ƒæœºå™¨ï¼Œå½¢æˆè‡ªå·±çš„å¤šä¸ª <code>replica</code> å‰¯æœ¬ã€‚æ‰€æœ‰ <code>replica</code> ä¼šé€‰ä¸¾ä¸€ä¸ª <code>leader</code> å‡ºæ¥ï¼Œæ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½è·Ÿè¿™ä¸ª <code>leader</code> æ‰“äº¤é“ï¼Œå…¶ä»– <code>replica</code> ä½œä¸º <code>follower</code>ã€‚å†™çš„æ—¶å€™ï¼Œ<code>leader</code> ä¼šè´Ÿè´£æŠŠæ•°æ®åŒæ­¥åˆ°æ‰€æœ‰ <code>follower</code> ä¸Šå»ï¼Œè¯»çš„æ—¶å€™å°±ç›´æ¥è¯» <code>leader</code> ä¸Šçš„æ•°æ®å³å¯ã€‚<code>Kafka</code> è´Ÿè´£å‡åŒ€çš„å°†ä¸€ä¸ª <code>partition</code> çš„æ‰€æœ‰ <code>replica</code> åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™æ ·æ‰å¯ä»¥æé«˜å®¹é”™æ€§ã€‚</p><p><img src="http://blog-img.coolsen.cn/img/Solve-MQ-Problem-With-Kafka-01.png" alt="img"></p><p>æ‹¥æœ‰äº† <code>replica</code> å‰¯æœ¬æœºåˆ¶ï¼Œå¦‚æœæŸä¸ª <code>broker</code> å®•æœºäº†ï¼Œè¿™ä¸ª <code>broker</code> ä¸Šçš„ <code>partition</code> åœ¨å…¶ä»–æœºå™¨ä¸Šè¿˜å­˜åœ¨å‰¯æœ¬ã€‚å¦‚æœè¿™ä¸ªå®•æœºçš„ <code>broker</code> ä¸Šé¢æœ‰æŸä¸ª <code>partition</code> çš„ <code>leader</code>ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šä»å…¶ <code>follower</code> ä¸­é‡æ–°é€‰ä¸¾ä¸€ä¸ªæ–°çš„ <code>leader</code> å‡ºæ¥ï¼Œè¿™ä¸ªæ–°çš„ <code>leader</code> ä¼šç»§ç»­æä¾›è¯»å†™æœåŠ¡ï¼Œè¿™å°±æœ‰è¾¾åˆ°äº†æ‰€è°“çš„é«˜å¯ç”¨æ€§ã€‚</p><p>å†™æ•°æ®çš„æ—¶å€™ï¼Œç”Ÿäº§è€…åªå°†æ•°æ®å†™å…¥ <code>leader</code> èŠ‚ç‚¹ï¼Œ<code>leader</code> ä¼šå°†æ•°æ®å†™å…¥æœ¬åœ°ç£ç›˜ï¼Œæ¥ç€å…¶ä»– <code>follower</code> ä¼šä¸»åŠ¨ä» <code>leader</code> æ¥æ‹‰å–æ•°æ®ï¼Œ<code>follower</code> åŒæ­¥å¥½æ•°æ®äº†ï¼Œå°±ä¼šå‘é€ <code>ack</code> ç»™ <code>leader</code>ï¼Œ<code>leader</code> æ”¶åˆ°æ‰€æœ‰ <code>follower</code> çš„ <code>ack</code> ä¹‹åï¼Œå°±ä¼šè¿”å›å†™æˆåŠŸçš„æ¶ˆæ¯ç»™ç”Ÿäº§è€…ã€‚</p><p>æ¶ˆè´¹æ•°æ®çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…åªä¼šä» <code>leader</code> èŠ‚ç‚¹å»è¯»å–æ¶ˆæ¯ï¼Œä½†æ˜¯åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ <code>follower</code> éƒ½åŒæ­¥æˆåŠŸè¿”å› <code>ack</code> çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚</p><p><img src="https://gitee.com/dongzl/article-images/raw/master/2020/13-Solve-MQ-Problem-With-Kafka/Solve-MQ-Problem-With-Kafka-02.png" alt="img"></p><h2 id="4-Kafka-æ¶ˆæ¯æ˜¯é‡‡ç”¨-Pull-æ¨¡å¼ï¼Œè¿˜æ˜¯-Push-æ¨¡å¼ï¼Ÿ"><a href="#4-Kafka-æ¶ˆæ¯æ˜¯é‡‡ç”¨-Pull-æ¨¡å¼ï¼Œè¿˜æ˜¯-Push-æ¨¡å¼ï¼Ÿ" class="headerlink" title="4. Kafka æ¶ˆæ¯æ˜¯é‡‡ç”¨ Pull æ¨¡å¼ï¼Œè¿˜æ˜¯ Push æ¨¡å¼ï¼Ÿ"></a>4. Kafka æ¶ˆæ¯æ˜¯é‡‡ç”¨ Pull æ¨¡å¼ï¼Œè¿˜æ˜¯ Push æ¨¡å¼ï¼Ÿ</h2><p>ç”Ÿäº§è€…ä½¿ç”¨pushæ¨¡å¼å°†æ¶ˆæ¯å‘å¸ƒåˆ°Brokerï¼Œæ¶ˆè´¹è€…ä½¿ç”¨pullæ¨¡å¼ä»Brokerè®¢é˜…æ¶ˆæ¯ã€‚</p><p>pushæ¨¡å¼å¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå¦‚æœpushçš„é€Ÿåº¦å¤ªå¿«ï¼Œå®¹æ˜“é€ æˆæ¶ˆè´¹è€…æ‹’ç»æœåŠ¡æˆ–ç½‘ç»œæ‹¥å¡ï¼›å¦‚æœpushçš„é€Ÿåº¦å¤ªæ…¢ï¼Œå®¹æ˜“é€ æˆæ¶ˆè´¹è€…æ€§èƒ½æµªè´¹ã€‚ä½†æ˜¯é‡‡ç”¨pullçš„æ–¹å¼ä¹Ÿæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å½“Brokeræ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œæ¶ˆè´¹è€…ä¼šé™·å…¥ä¸æ–­åœ°è½®è¯¢ä¸­ï¼Œä¸ºäº†é¿å…è¿™ç‚¹ï¼Œkafkaæœ‰ä¸ªå‚æ•°å¯ä»¥è®©æ¶ˆè´¹è€…é˜»å¡çŸ¥é“æ˜¯å¦æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ã€‚</p><h2 id="5-Kafka-ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«"><a href="#5-Kafka-ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="5. Kafka ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«"></a>5. Kafka ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«</h2><ul><li><p>Kafka æŒä¹…åŒ–æ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—å¯ä»¥è¢«é‡å¤è¯»å–å’Œæ— é™æœŸä¿ç•™</p></li><li><p>Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼šå®ƒä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥çµæ´»ä¼¸ç¼©ï¼Œåœ¨å†…éƒ¨é€šè¿‡å¤åˆ¶æ•°æ®æå‡å®¹é”™èƒ½åŠ›å’Œé«˜å¯ç”¨æ€§</p></li><li><p>Kafka æ”¯æŒå®æ—¶çš„æµå¼å¤„ç†</p></li></ul><h2 id="6-ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ"><a href="#6-ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ" class="headerlink" title="6. ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ"></a>6. ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ</h2><p>æ¶ˆè´¹è€…ç»„æ˜¯Kafkaç‹¬æœ‰çš„æ¦‚å¿µï¼Œå³æ¶ˆè´¹è€…ç»„æ˜¯Kafkaæä¾›çš„å¯æ‰©å±•ä¸”å…·æœ‰å®¹é”™æ€§çš„æ¶ˆè´¹è€…æœºåˆ¶ã€‚</p><p>ä½†å®é™…ä¸Šï¼Œæ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰å…¶å®åŒ…å«ä¸¤ä¸ªæ¦‚å¿µï¼Œä½œä¸ºé˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ç»„å…è®¸ä½ åˆ†å‰²æ•°æ®å¤„ç†åˆ°ä¸€ç»„è¿›ç¨‹é›†åˆä¸Šï¼ˆå³ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæ¶ˆè´¹è€…è¿›ç¨‹ï¼Œä»–ä»¬å…±åŒæ¶ˆè´¹è¯¥topicçš„æ•°æ®ï¼‰ï¼Œè¿™æœ‰åŠ©äºä½ çš„æ¶ˆè´¹èƒ½åŠ›çš„åŠ¨æ€è°ƒæ•´ï¼›ä½œä¸ºå‘å¸ƒ-è®¢é˜…æ¨¡å‹ï¼ˆpublish-subscribeï¼‰ï¼ŒKafkaå…è®¸ä½ å°†åŒä¸€ä»½æ¶ˆæ¯å¹¿æ’­åˆ°å¤šä¸ªæ¶ˆè´¹è€…ç»„é‡Œï¼Œä»¥æ­¤æ¥ä¸°å¯Œå¤šç§æ•°æ®ä½¿ç”¨åœºæ™¯ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨æ¶ˆè´¹è€…ç»„ä¸­ï¼Œå¤šä¸ªå®ä¾‹å…±åŒè®¢é˜…è‹¥å¹²ä¸ªä¸»é¢˜ï¼Œå®ç°å…±åŒæ¶ˆè´¹ã€‚åŒä¸€ä¸ªç»„ä¸‹çš„æ¯ä¸ªå®ä¾‹éƒ½é…ç½®æœ‰ç›¸åŒçš„ç»„IDï¼Œè¢«åˆ†é…ä¸åŒçš„è®¢é˜…åˆ†åŒºã€‚å½“æŸä¸ªå®ä¾‹æŒ‚æ‰çš„æ—¶å€™ï¼Œå…¶ä»–å®ä¾‹ä¼šè‡ªåŠ¨åœ°æ‰¿æ‹…èµ·å®ƒè´Ÿè´£æ¶ˆè´¹çš„åˆ†åŒºã€‚ å› æ­¤ï¼Œæ¶ˆè´¹è€…ç»„åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿä¿è¯äº†æ¶ˆè´¹è€…ç¨‹åºçš„é«˜å¯ç”¨æ€§ã€‚</p><p><a target="_blank" rel="noopener" href="http://dockone.io/uploads/article/20201024/7b359b7a1381541fbacf3ecf20dfb347.jpg"><img src="http://dockone.io/uploads/article/20201024/7b359b7a1381541fbacf3ecf20dfb347.jpg" alt="1.jpg"></a></p><h2 id="7-åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#7-åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="7. åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>7. åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ç›®å‰ï¼ŒKafkaä½¿ç”¨ZooKeeperå­˜æ”¾é›†ç¾¤å…ƒæ•°æ®ã€æˆå‘˜ç®¡ç†ã€Controlleré€‰ä¸¾ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ç®¡ç†ç±»ä»»åŠ¡ã€‚ä¹‹åï¼Œç­‰KIP-500ææ¡ˆå®Œæˆåï¼ŒKafkaå°†å®Œå…¨ä¸å†ä¾èµ–äºZooKeeperã€‚</p><ul><li>â€œå­˜æ”¾å…ƒæ•°æ®â€æ˜¯æŒ‡ä¸»é¢˜åˆ†åŒºçš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ ZooKeeper ä¸­ï¼Œä¸”ä»¥å®ƒä¿å­˜çš„æ•°æ®ä¸ºæƒå¨ï¼Œå…¶ä»– â€œäººâ€ éƒ½è¦ä¸å®ƒä¿æŒå¯¹é½ã€‚</li><li>â€œæˆå‘˜ç®¡ç†â€ æ˜¯æŒ‡ Broker èŠ‚ç‚¹çš„æ³¨å†Œã€æ³¨é”€ä»¥åŠå±æ€§å˜æ›´ï¼Œç­‰ç­‰ã€‚</li><li>â€œController é€‰ä¸¾â€ æ˜¯æŒ‡é€‰ä¸¾é›†ç¾¤ Controllerï¼Œè€Œå…¶ä»–ç®¡ç†ç±»ä»»åŠ¡åŒ…æ‹¬ä½†ä¸é™äºä¸»é¢˜åˆ é™¤ã€å‚æ•°é…ç½®ç­‰ã€‚</li></ul><p>KIP-500 æ€æƒ³ï¼Œæ˜¯ä½¿ç”¨ç¤¾åŒºè‡ªç ”çš„åŸºäºRaftçš„å…±è¯†ç®—æ³•ï¼Œæ›¿ä»£ZooKeeperï¼Œå®ç°Controllerè‡ªé€‰ä¸¾ã€‚</p><h2 id="8-è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨"><a href="#8-è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨" class="headerlink" title="8. è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨"></a>8. è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨</h2><p>åœ¨Kafkaä¸­ï¼Œæ¯ä¸ªä¸»é¢˜åˆ†åŒºä¸‹çš„æ¯æ¡æ¶ˆæ¯éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªå”¯ä¸€çš„IDæ•°å€¼ï¼Œç”¨äºæ ‡è¯†å®ƒåœ¨åˆ†åŒºä¸­çš„ä½ç½®ã€‚è¿™ä¸ªIDæ•°å€¼ï¼Œå°±è¢«ç§°ä¸ºä½ç§»ï¼Œæˆ–è€…å«åç§»é‡ã€‚ä¸€æ—¦æ¶ˆæ¯è¢«å†™å…¥åˆ°åˆ†åŒºæ—¥å¿—ï¼Œå®ƒçš„ä½ç§»å€¼å°†ä¸èƒ½è¢«ä¿®æ”¹ã€‚</p><h2 id="9-kafka-ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ"><a href="#9-kafka-ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ" class="headerlink" title="9. kafka ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ"></a>9. kafka ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ</h2><ul><li>Cache Filesystem Cache PageCacheç¼“å­˜</li><li><code>é¡ºåºå†™</code>ï¼šç”±äºç°ä»£çš„æ“ä½œç³»ç»Ÿæä¾›äº†é¢„è¯»å’Œå†™æŠ€æœ¯ï¼Œç£ç›˜çš„é¡ºåºå†™å¤§å¤šæ•°æƒ…å†µä¸‹æ¯”éšæœºå†™å†…å­˜è¿˜è¦å¿«ã€‚</li><li><code>Zero-copy</code>ï¼šé›¶æ‹·æŠ€æœ¯å‡å°‘æ‹·è´æ¬¡æ•°</li><li><code>Batching of Messages</code>ï¼šæ‰¹é‡ï¥¾å¤„ç†ã€‚åˆå¹¶å°çš„è¯·æ±‚ï¼Œç„¶åä»¥æµçš„æ–¹å¼è¿›è¡Œäº¤äº’ï¼Œç›´é¡¶ç½‘ç»œä¸Šé™ã€‚</li><li><code>Pull æ‹‰æ¨¡å¼</code>ï¼šä½¿ç”¨æ‹‰æ¨¡å¼è¿›è¡Œæ¶ˆæ¯çš„è·å–æ¶ˆè´¹ï¼Œä¸æ¶ˆè´¹ç«¯å¤„ç†èƒ½åŠ›ç›¸ç¬¦ã€‚</li></ul><h2 id="10-kafka-producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"><a href="#10-kafka-producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ" class="headerlink" title="10. kafka producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"></a>10. kafka producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</h2><ul><li><code>1</code>ï¼ˆé»˜è®¤ï¼‰ æ•°æ®å‘é€åˆ°Kafkaåï¼Œç»è¿‡leaderæˆåŠŸæ¥æ”¶æ¶ˆæ¯çš„çš„ç¡®è®¤ï¼Œå°±ç®—æ˜¯å‘é€æˆåŠŸäº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœleaderå®•æœºäº†ï¼Œåˆ™ä¼šä¸¢å¤±æ•°æ®ã€‚</li><li><code>0</code> ç”Ÿäº§è€…å°†æ•°æ®å‘é€å‡ºå»å°±ä¸ç®¡äº†ï¼Œä¸å»ç­‰å¾…ä»»ä½•è¿”å›ã€‚è¿™ç§æƒ…å†µä¸‹æ•°æ®ä¼ è¾“æ•ˆç‡æœ€é«˜ï¼Œä½†æ˜¯æ•°æ®å¯é æ€§ç¡®æ˜¯æœ€ä½çš„ã€‚</li><li><code>-1</code>produceréœ€è¦ç­‰å¾…ISRä¸­çš„æ‰€æœ‰followeréƒ½ç¡®è®¤æ¥æ”¶åˆ°æ•°æ®åæ‰ç®—ä¸€æ¬¡å‘é€å®Œæˆï¼Œå¯é æ€§æœ€é«˜ã€‚å½“ISRä¸­æ‰€æœ‰Replicaéƒ½å‘Leaderå‘é€ACKæ—¶ï¼Œleaderæ‰commitï¼Œè¿™æ—¶å€™produceræ‰èƒ½è®¤ä¸ºä¸€ä¸ªè¯·æ±‚ä¸­çš„æ¶ˆæ¯éƒ½commitäº†ã€‚</li></ul><h2 id="11-Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±"><a href="#11-Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±" class="headerlink" title="11. Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±?"></a>11. Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±?</h2><p>é¦–å…ˆéœ€è¦å¼„æ˜ç™½æ¶ˆæ¯ä¸ºä»€ä¹ˆä¼šä¸¢å¤±ï¼Œå¯¹äºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¼šæœ‰ <code>ç”Ÿäº§è€…</code>ã€<code>MQ</code>ã€<code>æ¶ˆè´¹è€…</code> è¿™ä¸‰ä¸ªè§’è‰²ï¼Œåœ¨è¿™ä¸‰ä¸ªè§’è‰²æ•°æ®å¤„ç†å’Œä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œéƒ½æœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±ã€‚</p><p><img src="http://blog-img.coolsen.cn/img/Solve-MQ-Problem-With-Kafka-03.png" alt="img"></p><p>æ¶ˆæ¯ä¸¢å¤±çš„åŸå› ä»¥åŠè§£å†³åŠæ³•ï¼š</p><h3 id="æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"><a href="#æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"></a>æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±</h3><p>æ¶ˆè´¹è€…å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±çš„æƒ…å†µæ˜¯ï¼šæ¶ˆè´¹è€…è·å–åˆ°äº†è¿™æ¡æ¶ˆæ¯åï¼Œè¿˜æœªå¤„ç†ï¼Œ<code>Kafka</code> å°±è‡ªåŠ¨æäº¤äº† <code>offset</code>ï¼Œè¿™æ—¶ <code>Kafka</code> å°±è®¤ä¸ºæ¶ˆè´¹è€…å·²ç»å¤„ç†å®Œè¿™æ¡æ¶ˆæ¯ï¼Œå…¶å®æ¶ˆè´¹è€…æ‰åˆšå‡†å¤‡å¤„ç†è¿™æ¡æ¶ˆæ¯ï¼Œè¿™æ—¶å¦‚æœæ¶ˆè´¹è€…å®•æœºï¼Œé‚£è¿™æ¡æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚</p><p>æ¶ˆè´¹è€…å¼•èµ·æ¶ˆæ¯ä¸¢å¤±çš„ä¸»è¦åŸå› å°±æ˜¯æ¶ˆæ¯è¿˜æœªå¤„ç†å®Œ <code>Kafka</code> ä¼šè‡ªåŠ¨æäº¤äº† <code>offset</code>ï¼Œé‚£ä¹ˆåªè¦å…³é—­è‡ªåŠ¨æäº¤ <code>offset</code>ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†å®Œä¹‹åæ‰‹åŠ¨æäº¤ <code>offset</code>ï¼Œå°±å¯ä»¥ä¿è¯æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚ä½†æ˜¯æ­¤æ—¶éœ€è¦æ³¨æ„é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œæ¯”å¦‚æ¶ˆè´¹è€…åˆšå¤„ç†å®Œï¼Œè¿˜æ²¡æäº¤ <code>offset</code>ï¼Œè¿™æ—¶è‡ªå·±å®•æœºäº†ï¼Œæ­¤æ—¶è¿™æ¡æ¶ˆæ¯è‚¯å®šä¼šè¢«é‡å¤æ¶ˆè´¹ä¸€æ¬¡ï¼Œè¿™å°±éœ€è¦æ¶ˆè´¹è€…æ ¹æ®å®é™…æƒ…å†µä¿è¯å¹‚ç­‰æ€§ã€‚</p><h3 id="ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"><a href="#ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"></a>ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±</h3><p>å¯¹äºç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ•°æ®ä¸¢å¤±ä¸»å¸¸è§æƒ…å†µæ˜¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™ <code>Kafka</code>ï¼Œç”±äºç½‘ç»œç­‰åŸå› å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå¯¹äºè¿™ç§æƒ…å†µä¹Ÿæ˜¯é€šè¿‡åœ¨ <strong>producer</strong> ç«¯è®¾ç½® <strong>acks&#x3D;all</strong> æ¥å¤„ç†ï¼Œè¿™ä¸ªå‚æ•°æ˜¯è¦æ±‚ <code>leader</code> æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œéœ€è¦ç­‰åˆ°æ‰€æœ‰çš„ <code>follower</code> éƒ½åŒæ­¥åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œæ‰è®¤ä¸ºæœ¬æ¬¡å†™æˆåŠŸäº†ã€‚å¦‚æœæ²¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ã€‚</p><h3 id="Kafka-å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"><a href="#Kafka-å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="Kafka å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"></a>Kafka å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±</h3><p><code>Kafka</code> å¯¼è‡´çš„æ•°æ®ä¸¢å¤±ä¸€ä¸ªå¸¸è§çš„åœºæ™¯å°±æ˜¯ <code>Kafka</code> æŸä¸ª <code>broker</code> å®•æœºï¼Œï¼Œè€Œè¿™ä¸ªèŠ‚ç‚¹æ­£å¥½æ˜¯æŸä¸ª <code>partition</code> çš„ <code>leader</code> èŠ‚ç‚¹ï¼Œè¿™æ—¶éœ€è¦é‡æ–°é‡æ–°é€‰ä¸¾è¯¥ <code>partition</code> çš„ <code>leader</code>ã€‚å¦‚æœè¯¥ <code>partition</code> çš„ <code>leader</code> åœ¨å®•æœºæ—¶åˆšå¥½è¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥åˆ° <code>follower</code>ï¼Œæ­¤æ—¶ <code>leader</code> æŒ‚äº†ï¼Œåœ¨é€‰ä¸¾æŸä¸ª <code>follower</code> æˆ <code>leader</code> ä¹‹åï¼Œå°±ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ã€‚</p><p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œ<code>Kafka</code> å¯ä»¥è®¾ç½®å¦‚ä¸‹ 4 ä¸ªå‚æ•°ï¼Œæ¥å°½é‡é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼š</p><ul><li>ç»™ <code>topic</code> è®¾ç½® <code>replication.factor</code> å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº <code>1</code>ï¼Œè¦æ±‚æ¯ä¸ª <code>partition</code> å¿…é¡»æœ‰è‡³å°‘ <code>2</code> ä¸ªå‰¯æœ¬ï¼›</li><li>åœ¨ <code>Kafka</code> æœåŠ¡ç«¯è®¾ç½® <code>min.insync.replicas</code> å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº <code>1</code>ï¼Œè¿™ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ä¸€ä¸ª <code>leader</code> è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª <code>follower</code> è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ <code>leader</code> æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª <code>follower</code> èŠ‚ç‚¹ã€‚</li><li>åœ¨ <code>producer</code> ç«¯è®¾ç½® <code>acks=all</code>ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯å†™å…¥æ‰€æœ‰ <code>replica</code> ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†ï¼›</li><li>åœ¨ <code>producer</code> ç«¯è®¾ç½® <code>retries=MAX</code>ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚</li></ul><h2 id="13-Kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§"><a href="#13-Kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§" class="headerlink" title="13. Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§"></a>13. Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§</h2><p>åœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯å¯¹äºæœ‰é€»è¾‘å…³è”çš„å¤šæ¡MQæ¶ˆæ¯è¢«æŒ‰é¡ºåºå¤„ç†ï¼Œæ¯”å¦‚å¯¹äºæŸä¸€æ¡æ•°æ®ï¼Œæ­£å¸¸å¤„ç†é¡ºåºæ˜¯<code>æ–°å¢-æ›´æ–°-åˆ é™¤</code>ï¼Œæœ€ç»ˆç»“æœæ˜¯æ•°æ®è¢«åˆ é™¤ï¼›å¦‚æœæ¶ˆæ¯æ²¡æœ‰æŒ‰åºæ¶ˆè´¹ï¼Œå¤„ç†é¡ºåºå¯èƒ½æ˜¯<code>åˆ é™¤-æ–°å¢-æ›´æ–°</code>ï¼Œæœ€ç»ˆæ•°æ®æ²¡æœ‰è¢«åˆ æ‰ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä¸€äº›é€»è¾‘é”™è¯¯ã€‚å¯¹äºå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Œä¸»è¦éœ€è¦è€ƒè™‘å¦‚ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨ <code>Kafka</code> ä¸­é¡ºåºæ€§ï¼›</li><li>å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§ã€‚</li></ul><h3 id="å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨-Kafka-ä¸­é¡ºåºæ€§"><a href="#å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨-Kafka-ä¸­é¡ºåºæ€§" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨ Kafka ä¸­é¡ºåºæ€§"></a>å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨ Kafka ä¸­é¡ºåºæ€§</h3><p>å¯¹äº <code>Kafka</code>ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>topic</code>ï¼Œé»˜è®¤æœ‰ä¸‰ä¸ª <code>partition</code>ã€‚ç”Ÿäº§è€…åœ¨å†™æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ª <code>key</code>ï¼Œæ¯”å¦‚åœ¨è®¢å• <code>topic</code> ä¸­æˆ‘ä»¬å¯ä»¥æŒ‡å®šè®¢å• <code>id</code> ä½œä¸º <code>key</code>ï¼Œé‚£ä¹ˆç›¸åŒè®¢å• <code>id</code> çš„æ•°æ®ï¼Œä¸€å®šä¼šè¢«åˆ†å‘åˆ°åŒä¸€ä¸ª <code>partition</code> ä¸­å»ï¼Œè€Œä¸”è¿™ä¸ª <code>partition</code> ä¸­çš„æ•°æ®ä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚æ¶ˆè´¹è€…ä» <code>partition</code> ä¸­å–å‡ºæ¥æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚é€šè¿‡åˆ¶å®š <code>key</code> çš„æ–¹å¼é¦–å…ˆå¯ä»¥ä¿è¯åœ¨ <code>kafka</code> å†…éƒ¨æ¶ˆæ¯æ˜¯æœ‰åºçš„ã€‚</p><h3 id="å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§"><a href="#å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§"></a>å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§</h3><p>å¯¹äºæŸä¸ª <code>topic</code> çš„ä¸€ä¸ª <code>partition</code>ï¼Œåªèƒ½è¢«åŒç»„å†…éƒ¨çš„ä¸€ä¸ª <code>consumer</code> æ¶ˆè´¹ï¼Œå¦‚æœè¿™ä¸ª <code>consumer</code> å†…éƒ¨è¿˜æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œé‚£ä¹ˆå…¶å®åªè¦ä¿è¯æ¶ˆæ¯åœ¨ <code>MQ</code> å†…éƒ¨æ˜¯æœ‰é¡ºåºçš„å°±å¯ä»¥ä¿è¯æ¶ˆè´¹ä¹Ÿæ˜¯æœ‰é¡ºåºçš„ã€‚ä½†æ˜¯å•çº¿ç¨‹ååé‡å¤ªä½ï¼Œåœ¨å¤„ç†å¤§é‡ <code>MQ</code> æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå¼€å¯å¤šçº¿ç¨‹æ¶ˆè´¹æœºåˆ¶ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´æ˜¯è¢«é¡ºåºå¤„ç†çš„å‘¢ï¼Ÿå¯¹äºå¤šçº¿ç¨‹æ¶ˆè´¹æˆ‘ä»¬å¯ä»¥é¢„å…ˆè®¾ç½® <code>N</code> ä¸ªå†…å­˜ <code>Queue</code>ï¼Œå…·æœ‰ç›¸åŒ <code>key</code> çš„æ•°æ®éƒ½æ”¾åˆ°åŒä¸€ä¸ªå†…å­˜ <code>Queue</code> ä¸­ï¼›ç„¶åå¼€å¯ <code>N</code> ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜ <code>Queue</code> çš„æ•°æ®å³å¯ï¼Œè¿™æ ·å°±èƒ½ä¿è¯é¡ºåºæ€§ã€‚å½“ç„¶ï¼Œæ¶ˆæ¯æ”¾åˆ°å†…å­˜ <code>Queue</code> ä¸­ï¼Œæœ‰å¯èƒ½è¿˜æœªè¢«å¤„ç†ï¼Œ<code>consumer</code> å‘ç”Ÿå®•æœºï¼Œå†…å­˜ <code>Queue</code> ä¸­çš„æ•°æ®ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œè¿™å°±è½¬å˜ä¸ºä¸Šé¢æåˆ°çš„<strong>å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é ä¼ è¾“</strong>çš„é—®é¢˜äº†ã€‚</p><h2 id="14-Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ"><a href="#14-Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ" class="headerlink" title="14. Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ"></a>14. Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ</h2><ul><li><code>ISR</code>ï¼šIn-Sync Replicas å‰¯æœ¬åŒæ­¥é˜Ÿåˆ—</li><li><code>AR</code>:Assigned Replicas æ‰€æœ‰å‰¯æœ¬</li></ul><p>ISRæ˜¯ç”±leaderç»´æŠ¤ï¼Œfollowerä»leaderåŒæ­¥æ•°æ®æœ‰ä¸€äº›å»¶è¿Ÿï¼ˆåŒ…æ‹¬<code>å»¶è¿Ÿæ—¶é—´replica.lag.time.max.ms</code>å’Œ<code>å»¶è¿Ÿæ¡æ•°replica.lag.max.messages</code>ä¸¤ä¸ªç»´åº¦ï¼Œå½“å‰æœ€æ–°çš„ç‰ˆæœ¬0.10.xä¸­åªæ”¯æŒ<code>replica.lag.time.max.ms</code>è¿™ä¸ªç»´åº¦ï¼‰ï¼Œä»»æ„ä¸€ä¸ªè¶…è¿‡é˜ˆå€¼éƒ½ä¼šæŠŠfollowerå‰”é™¤å‡ºISRï¼Œå­˜å…¥OSRï¼ˆOutof-Sync Replicasï¼‰åˆ—è¡¨ï¼Œæ–°åŠ å…¥çš„followerä¹Ÿä¼šå…ˆå­˜æ”¾åœ¨OSRä¸­ã€‚</p><blockquote><p>AR&#x3D;ISR+OSRã€‚</p></blockquote><h2 id="15-æè¿°ä¸‹-Kafka-ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader-Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower-Replicaï¼‰çš„åŒºåˆ«"><a href="#15-æè¿°ä¸‹-Kafka-ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader-Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower-Replicaï¼‰çš„åŒºåˆ«" class="headerlink" title="15. æè¿°ä¸‹ Kafka ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower Replicaï¼‰çš„åŒºåˆ«"></a>15. æè¿°ä¸‹ Kafka ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower Replicaï¼‰çš„åŒºåˆ«</h2><p>Kafkaå‰¯æœ¬å½“å‰åˆ†ä¸ºé¢†å¯¼è€…å‰¯æœ¬å’Œè¿½éšè€…å‰¯æœ¬ã€‚åªæœ‰Leaderå‰¯æœ¬æ‰èƒ½å¯¹å¤–æä¾›è¯»å†™æœåŠ¡ï¼Œå“åº”Clientsç«¯çš„è¯·æ±‚ã€‚Followerå‰¯æœ¬åªæ˜¯é‡‡ç”¨æ‹‰ï¼ˆPULLï¼‰çš„æ–¹å¼ï¼Œè¢«åŠ¨åœ°åŒæ­¥Leaderå‰¯æœ¬ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨Leaderå‰¯æœ¬æ‰€åœ¨çš„Brokerå®•æœºåï¼Œéšæ—¶å‡†å¤‡åº”è˜Leaderå‰¯æœ¬ã€‚</p><p>åŠ åˆ†ç‚¹ï¼š</p><ul><li>å¼ºè°ƒFollowerå‰¯æœ¬ä¹Ÿèƒ½å¯¹å¤–æä¾›è¯»æœåŠ¡ã€‚è‡ªKafka 2.4ç‰ˆæœ¬å¼€å§‹ï¼Œç¤¾åŒºé€šè¿‡å¼•å…¥æ–°çš„Brokerç«¯å‚æ•°ï¼Œå…è®¸Followerå‰¯æœ¬æœ‰é™åº¦åœ°æä¾›è¯»æœåŠ¡ã€‚</li><li>å¼ºè°ƒLeaderå’ŒFollowerçš„æ¶ˆæ¯åºåˆ—åœ¨å®é™…åœºæ™¯ä¸­ä¸ä¸€è‡´ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¾ˆå¤šå› ç´ å¯èƒ½é€ æˆLeaderå’ŒFollowerä¹‹é—´çš„ä¸åŒæ­¥ï¼Œæ¯”å¦‚ç¨‹åºé—®é¢˜ï¼Œç½‘ç»œé—®é¢˜ï¼Œbrokeré—®é¢˜ç­‰ï¼ŒçŸ­æš‚çš„ä¸åŒæ­¥æˆ‘ä»¬å¯ä»¥å…³æ³¨ï¼ˆç§’çº§åˆ«ï¼‰ï¼Œä½†é•¿æ—¶é—´çš„ä¸åŒæ­¥å¯èƒ½å°±éœ€è¦æ·±å…¥æ’æŸ¥äº†ï¼Œå› ä¸ºä¸€æ—¦Leaderæ‰€åœ¨èŠ‚ç‚¹å¼‚å¸¸ï¼Œå¯èƒ½ç›´æ¥å½±å“å¯ç”¨æ€§ã€‚</li></ul><p>æ³¨æ„ï¼šä¹‹å‰ç¡®ä¿ä¸€è‡´æ€§çš„ä¸»è¦æ‰‹æ®µæ˜¯é«˜æ°´ä½æœºåˆ¶ï¼ˆHWï¼‰ï¼Œä½†é«˜æ°´ä½å€¼æ— æ³•ä¿è¯Leaderè¿ç»­å˜æ›´åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå› æ­¤ï¼Œç¤¾åŒºå¼•å…¥äº†Leader Epochæœºåˆ¶ï¼Œæ¥ä¿®å¤é«˜æ°´ä½å€¼çš„å¼Šç«¯ã€‚</p><h2 id="16-åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"><a href="#16-åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ" class="headerlink" title="16. åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"></a>16. åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ</h2><p>åˆ†åŒºçš„Leaderå‰¯æœ¬é€‰ä¸¾å¯¹ç”¨æˆ·æ˜¯å®Œå…¨é€æ˜çš„ï¼Œå®ƒæ˜¯ç”±Controllerç‹¬ç«‹å®Œæˆçš„ã€‚ä½ éœ€è¦å›ç­”çš„æ˜¯ï¼Œåœ¨å“ªäº›åœºæ™¯ä¸‹ï¼Œéœ€è¦æ‰§è¡Œåˆ†åŒºLeaderé€‰ä¸¾ã€‚æ¯ä¸€ç§åœºæ™¯å¯¹åº”äºä¸€ç§é€‰ä¸¾ç­–ç•¥ã€‚</p><ul><li>OfflinePartition Leaderé€‰ä¸¾ï¼šæ¯å½“æœ‰åˆ†åŒºä¸Šçº¿æ—¶ï¼Œå°±éœ€è¦æ‰§è¡ŒLeaderé€‰ä¸¾ã€‚æ‰€è°“çš„åˆ†åŒºä¸Šçº¿ï¼Œå¯èƒ½æ˜¯åˆ›å»ºäº†æ–°åˆ†åŒºï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰çš„ä¸‹çº¿åˆ†åŒºé‡æ–°ä¸Šçº¿ã€‚è¿™æ˜¯æœ€å¸¸è§çš„åˆ†åŒºLeaderé€‰ä¸¾åœºæ™¯ã€‚</li><li>ReassignPartition Leaderé€‰ä¸¾ï¼šå½“ä½ æ‰‹åŠ¨è¿è¡Œkafka-reassign-partitionså‘½ä»¤ï¼Œæˆ–è€…æ˜¯è°ƒç”¨Adminçš„alterPartitionReassignmentsæ–¹æ³•æ‰§è¡Œåˆ†åŒºå‰¯æœ¬é‡åˆ†é…æ—¶ï¼Œå¯èƒ½è§¦å‘æ­¤ç±»é€‰ä¸¾ã€‚å‡è®¾åŸæ¥çš„ARæ˜¯[1ï¼Œ2ï¼Œ3]ï¼ŒLeaderæ˜¯1ï¼Œå½“æ‰§è¡Œå‰¯æœ¬é‡åˆ†é…åï¼Œå‰¯æœ¬é›†åˆARè¢«è®¾ç½®æˆ[4ï¼Œ5ï¼Œ6]ï¼Œæ˜¾ç„¶ï¼ŒLeaderå¿…é¡»è¦å˜æ›´ï¼Œæ­¤æ—¶ä¼šå‘ç”ŸReassign Partition Leaderé€‰ä¸¾ã€‚</li><li>PreferredReplicaPartition Leaderé€‰ä¸¾ï¼šå½“ä½ æ‰‹åŠ¨è¿è¡Œkafka-preferred-replica-electionå‘½ä»¤ï¼Œæˆ–è‡ªåŠ¨è§¦å‘äº†Preferred Leaderé€‰ä¸¾æ—¶ï¼Œè¯¥ç±»ç­–ç•¥è¢«æ¿€æ´»ã€‚æ‰€è°“çš„Preferred Leaderï¼ŒæŒ‡çš„æ˜¯ARä¸­çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬ã€‚æ¯”å¦‚ARæ˜¯[3ï¼Œ2ï¼Œ1]ï¼Œé‚£ä¹ˆï¼ŒPreferred Leaderå°±æ˜¯3ã€‚</li><li>ControlledShutdownPartition Leaderé€‰ä¸¾ï¼šå½“Brokeræ­£å¸¸å…³é—­æ—¶ï¼Œè¯¥Brokerä¸Šçš„æ‰€æœ‰Leaderå‰¯æœ¬éƒ½ä¼šä¸‹çº¿ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸ºå—å½±å“çš„åˆ†åŒºæ‰§è¡Œç›¸åº”çš„Leaderé€‰ä¸¾ã€‚</li></ul><p>è¿™4ç±»é€‰ä¸¾ç­–ç•¥çš„å¤§è‡´æ€æƒ³æ˜¯ç±»ä¼¼çš„ï¼Œå³ä»ARä¸­æŒ‘é€‰é¦–ä¸ªåœ¨ISRä¸­çš„å‰¯æœ¬ï¼Œä½œä¸ºæ–°Leaderã€‚</p><h2 id="17-Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero-Copyï¼‰ï¼Ÿ"><a href="#17-Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero-Copyï¼‰ï¼Ÿ" class="headerlink" title="17. Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero Copyï¼‰ï¼Ÿ"></a>17. Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero Copyï¼‰ï¼Ÿ</h2><p>åœ¨Kafkaä¸­ï¼Œä½“ç°Zero Copyä½¿ç”¨åœºæ™¯çš„åœ°æ–¹æœ‰ä¸¤å¤„ï¼šåŸºäºmmapçš„ç´¢å¼•å’Œæ—¥å¿—æ–‡ä»¶è¯»å†™æ‰€ç”¨çš„TransportLayerã€‚</p><p>å…ˆè¯´ç¬¬ä¸€ä¸ªã€‚ç´¢å¼•éƒ½æ˜¯åŸºäºMappedByteBufferçš„ï¼Œä¹Ÿå°±æ˜¯è®©ç”¨æˆ·æ€å’Œå†…æ ¸æ€å…±äº«å†…æ ¸æ€çš„æ•°æ®ç¼“å†²åŒºï¼Œæ­¤æ—¶ï¼Œæ•°æ®ä¸éœ€è¦å¤åˆ¶åˆ°ç”¨æˆ·æ€ç©ºé—´ã€‚ä¸è¿‡ï¼Œmmapè™½ç„¶é¿å…äº†ä¸å¿…è¦çš„æ‹·è´ï¼Œä½†ä¸ä¸€å®šå°±èƒ½ä¿è¯å¾ˆé«˜çš„æ€§èƒ½ã€‚åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸‹ï¼Œmmapçš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚å¾ˆé«˜çš„åˆ›å»ºå’Œé”€æ¯å¼€é”€ä¼šæŠµæ¶ˆZero Copyå¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿ã€‚ç”±äºè¿™ç§ä¸ç¡®å®šæ€§ï¼Œåœ¨Kafkaä¸­ï¼Œåªæœ‰ç´¢å¼•åº”ç”¨äº†mmapï¼Œæœ€æ ¸å¿ƒçš„æ—¥å¿—å¹¶æœªä½¿ç”¨mmapæœºåˆ¶ã€‚</p><p>å†è¯´ç¬¬äºŒä¸ªã€‚TransportLayeræ˜¯Kafkaä¼ è¾“å±‚çš„æ¥å£ã€‚å®ƒçš„æŸä¸ªå®ç°ç±»ä½¿ç”¨äº†FileChannelçš„transferToæ–¹æ³•ã€‚è¯¥æ–¹æ³•åº•å±‚ä½¿ç”¨sendfileå®ç°äº†Zero Copyã€‚å¯¹Kafkaè€Œè¨€ï¼Œå¦‚æœI&#x2F;Oé€šé“ä½¿ç”¨æ™®é€šçš„PLAINTEXTï¼Œé‚£ä¹ˆï¼ŒKafkaå°±å¯ä»¥åˆ©ç”¨Zero Copyç‰¹æ€§ï¼Œç›´æ¥å°†é¡µç¼“å­˜ä¸­çš„æ•°æ®å‘é€åˆ°ç½‘å¡çš„Bufferä¸­ï¼Œé¿å…ä¸­é—´çš„å¤šæ¬¡æ‹·è´ã€‚ç›¸åï¼Œå¦‚æœI&#x2F;Oé€šé“å¯ç”¨äº†SSLï¼Œé‚£ä¹ˆï¼ŒKafkaä¾¿æ— æ³•åˆ©ç”¨Zero Copyç‰¹æ€§äº†ã€‚</p><h2 id="18-ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ"><a href="#18-ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ" class="headerlink" title="18. ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ"></a>18. ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ</h2><p>åœ¨ Kafka ä¸­ï¼Œç”Ÿäº§è€…å†™å…¥æ¶ˆæ¯ã€æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯çš„æ“ä½œéƒ½æ˜¯ä¸ leader å‰¯æœ¬è¿›è¡Œäº¤äº’çš„ï¼Œä» è€Œå®ç°çš„æ˜¯ä¸€ç§ä¸»å†™ä¸»è¯»çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ã€‚</p><p>Kafka å¹¶ä¸æ”¯æŒä¸»å†™ä»è¯»ï¼Œå› ä¸ºä¸»å†™ä»è¯»æœ‰ 2 ä¸ªå¾ˆæ˜ æ˜¾çš„ç¼ºç‚¹:</p><ul><li><strong>æ•°æ®ä¸€è‡´æ€§é—®é¢˜</strong>ã€‚æ•°æ®ä»ä¸»èŠ‚ç‚¹è½¬åˆ°ä»èŠ‚ç‚¹å¿…ç„¶ä¼šæœ‰ä¸€ä¸ªå»¶æ—¶çš„æ—¶é—´çª—å£ï¼Œè¿™ä¸ªæ—¶é—´ çª—å£ä¼šå¯¼è‡´ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¸ä¸€è‡´ã€‚æŸä¸€æ—¶åˆ»ï¼Œåœ¨ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ä¸­ A æ•°æ®çš„å€¼éƒ½ä¸º Xï¼Œ ä¹‹åå°†ä¸»èŠ‚ç‚¹ä¸­ A çš„å€¼ä¿®æ”¹ä¸º Yï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªå˜æ›´é€šçŸ¥åˆ°ä»èŠ‚ç‚¹ä¹‹å‰ï¼Œåº”ç”¨è¯»å–ä»èŠ‚ç‚¹ä¸­çš„ A æ•°æ®çš„å€¼å¹¶ä¸ä¸ºæœ€æ–°çš„ Yï¼Œç”±æ­¤ä¾¿äº§ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li><li><strong>å»¶æ—¶é—®é¢˜</strong>ã€‚ç±»ä¼¼ Redis è¿™ç§ç»„ä»¶ï¼Œæ•°æ®ä»å†™å…¥ä¸»èŠ‚ç‚¹åˆ°åŒæ­¥è‡³ä»èŠ‚ç‚¹ä¸­çš„è¿‡ç¨‹éœ€è¦ç»å†<code>ç½‘ç»œâ†’ä¸»èŠ‚ç‚¹å†…å­˜â†’ç½‘ç»œâ†’ä»èŠ‚ç‚¹å†…å­˜</code>è¿™å‡ ä¸ªé˜¶æ®µï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šè€—è´¹ä¸€å®šçš„æ—¶é—´ã€‚è€Œåœ¨ Kafka ä¸­ï¼Œä¸»ä»åŒæ­¥ä¼šæ¯” Redis æ›´åŠ è€—æ—¶ï¼Œå®ƒéœ€è¦ç»å†<code>ç½‘ç»œâ†’ä¸»èŠ‚ç‚¹å†…å­˜â†’ä¸»èŠ‚ç‚¹ç£ç›˜â†’ç½‘ç»œâ†’ä»èŠ‚ç‚¹å†…å­˜â†’ä»èŠ‚ç‚¹ç£ç›˜</code>è¿™å‡ ä¸ªé˜¶æ®µã€‚å¯¹å»¶æ—¶æ•æ„Ÿçš„åº”ç”¨è€Œè¨€ï¼Œä¸»å†™ä»è¯»çš„åŠŸèƒ½å¹¶ä¸å¤ªé€‚ç”¨ã€‚</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a target="_blank" rel="noopener" href="http://dockone.io/article/10853">http://dockone.io/article/10853</a></p><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000023716306">https://segmentfault.com/a/1190000023716306</a></p><p><a target="_blank" rel="noopener" href="https://dongzl.github.io/2020/03/16/13-Solve-MQ-Problem-With-Kafka/index.html">https://dongzl.github.io/2020/03/16/13-Solve-MQ-Problem-With-Kafka/index.html</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/01/16/2021-01-16-RAFT%E7%AE%97%E6%B3%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/01/16/2021-01-16-RAFT%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">RAFTç®—æ³•</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-16 19:30:00" itemprop="dateCreated datePublished" datetime="2021-01-16T19:30:00+08:00">2021-01-16</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1 èƒŒæ™¯"></a>1 èƒŒæ™¯</h2><p>å½“ä»Šçš„æ•°æ®ä¸­å¿ƒå’Œåº”ç”¨ç¨‹åºåœ¨é«˜åº¦åŠ¨æ€çš„ç¯å¢ƒä¸­è¿è¡Œï¼Œä¸ºäº†åº”å¯¹é«˜åº¦åŠ¨æ€çš„ç¯å¢ƒï¼Œå®ƒä»¬é€šè¿‡é¢å¤–çš„æœåŠ¡å™¨è¿›è¡Œæ¨ªå‘æ‰©å±•ï¼Œå¹¶ä¸”æ ¹æ®éœ€æ±‚è¿›è¡Œæ‰©å±•å’Œæ”¶ç¼©ã€‚åŒæ—¶ï¼ŒæœåŠ¡å™¨å’Œç½‘ç»œæ•…éšœä¹Ÿå¾ˆå¸¸è§ã€‚</p><p>å› æ­¤ï¼Œç³»ç»Ÿå¿…é¡»åœ¨æ­£å¸¸æ“ä½œæœŸé—´å¤„ç†æœåŠ¡å™¨çš„ä¸Šä¸‹çº¿ã€‚å®ƒä»¬å¿…é¡»å¯¹å˜æ•…åšå‡ºååº”å¹¶åœ¨å‡ ç§’é’Ÿå†…è‡ªåŠ¨é€‚åº”ï¼›å¯¹å®¢æˆ·æ¥è¯´çš„è¯ï¼Œæ˜æ˜¾çš„ä¸­æ–­é€šå¸¸æ˜¯ä¸å¯æ¥å—çš„ã€‚</p><p>å¹¸è¿çš„æ˜¯ï¼Œåˆ†å¸ƒå¼å…±è¯†å¯ä»¥å¸®åŠ©åº”å¯¹è¿™äº›æŒ‘æˆ˜ã€‚</p><h3 id="1-1-æ‹œå åº­å°†å†›"><a href="#1-1-æ‹œå åº­å°†å†›" class="headerlink" title="# 1.1 æ‹œå åº­å°†å†›"></a><a href="#_1-1-%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B">#</a> 1.1 æ‹œå åº­å°†å†›</h3><p>åœ¨ä»‹ç»å…±è¯†ç®—æ³•ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸€ä¸ªç®€åŒ–ç‰ˆæ‹œå åº­å°†å†›çš„ä¾‹å­æ¥å¸®åŠ©ç†è§£å…±è¯†ç®—æ³•ã€‚</p><blockquote><p>å‡è®¾å¤šä½æ‹œå åº­å°†å†›ä¸­æ²¡æœ‰å›å†›ï¼Œä¿¡ä½¿çš„ä¿¡æ¯å¯é ä½†æœ‰å¯èƒ½è¢«æš—æ€çš„æƒ…å†µä¸‹ï¼Œå°†å†›ä»¬å¦‚ä½•è¾¾æˆæ˜¯å¦è¦è¿›æ”»çš„ä¸€è‡´æ€§å†³å®šï¼Ÿ</p></blockquote><p>è§£å†³æ–¹æ¡ˆå¤§è‡´å¯ä»¥ç†è§£æˆï¼šå…ˆåœ¨æ‰€æœ‰çš„å°†å†›ä¸­é€‰å‡ºä¸€ä¸ªå¤§å°†å†›ï¼Œç”¨æ¥åšå‡ºæ‰€æœ‰çš„å†³å®šã€‚</p><p>ä¸¾ä¾‹å¦‚ä¸‹ï¼šå‡å¦‚ç°åœ¨ä¸€å…±æœ‰ 3 ä¸ªå°†å†› Aï¼ŒB å’Œ Cï¼Œæ¯ä¸ªå°†å†›éƒ½æœ‰ä¸€ä¸ªéšæœºæ—¶é—´çš„å€’è®¡æ—¶å™¨ï¼Œå€’è®¡æ—¶ä¸€ç»“æŸï¼Œè¿™ä¸ªå°†å†›å°±æŠŠè‡ªå·±å½“æˆå¤§å°†å†›å€™é€‰äººï¼Œç„¶åæ´¾ä¿¡ä½¿ä¼ é€’é€‰ä¸¾æŠ•ç¥¨çš„ä¿¡æ¯ç»™å°†å†› B å’Œ Cï¼Œå¦‚æœå°†å†› B å’Œ C è¿˜æ²¡æœ‰æŠŠè‡ªå·±å½“ä½œå€™é€‰äººï¼ˆè‡ªå·±çš„å€’è®¡æ—¶è¿˜æ²¡æœ‰ç»“æŸï¼‰ï¼Œå¹¶ä¸”æ²¡æœ‰æŠŠé€‰ä¸¾ç¥¨æŠ•ç»™å…¶ä»–äººï¼Œå®ƒä»¬å°±ä¼šæŠŠç¥¨æŠ•ç»™å°†å†› Aï¼Œä¿¡ä½¿å›åˆ°å°†å†› A æ—¶ï¼Œå°†å†› A çŸ¥é“è‡ªå·±æ”¶åˆ°äº†è¶³å¤Ÿçš„ç¥¨æ•°ï¼Œæˆä¸ºå¤§å°†å†›ã€‚åœ¨æœ‰äº†å¤§å°†å†›ä¹‹åï¼Œæ˜¯å¦éœ€è¦è¿›æ”»å°±ç”±å¤§å°†å†› A å†³å®šï¼Œç„¶åå†å»æ´¾ä¿¡ä½¿é€šçŸ¥å¦å¤–ä¸¤ä¸ªå°†å†›ï¼Œè‡ªå·±å·²ç»æˆä¸ºäº†å¤§å°†å†›ã€‚å¦‚æœä¸€æ®µæ—¶é—´è¿˜æ²¡æ”¶åˆ°å°†å†› B å’Œ C çš„å›å¤ï¼ˆä¿¡ä½¿å¯èƒ½ä¼šè¢«æš—æ€ï¼‰ï¼Œé‚£å°±å†é‡æ´¾ä¸€ä¸ªä¿¡ä½¿ï¼Œç›´åˆ°æ”¶åˆ°å›å¤ã€‚</p><h3 id="1-2-å…±è¯†ç®—æ³•"><a href="#1-2-å…±è¯†ç®—æ³•" class="headerlink" title="# 1.2 å…±è¯†ç®—æ³•"></a><a href="#_1-2-%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95">#</a> 1.2 å…±è¯†ç®—æ³•</h3><p>å…±è¯†æ˜¯å¯å®¹é”™ç³»ç»Ÿä¸­çš„ä¸€ä¸ªåŸºæœ¬é—®é¢˜ï¼šå³ä½¿é¢å¯¹æ•…éšœï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥åœ¨å…±äº«çŠ¶æ€ä¸Šè¾¾æˆä¸€è‡´ã€‚</p><p>å…±è¯†ç®—æ³•å…è®¸ä¸€ç»„èŠ‚ç‚¹åƒä¸€ä¸ªæ•´ä½“ä¸€æ ·ä¸€èµ·å·¥ä½œï¼Œå³ä½¿å…¶ä¸­çš„ä¸€äº›èŠ‚ç‚¹å‡ºç°æ•…éšœä¹Ÿèƒ½å¤Ÿç»§ç»­å·¥ä½œä¸‹å»ï¼Œå…¶æ­£ç¡®æ€§ä¸»è¦æ˜¯æºäºå¤åˆ¶çŠ¶æ€æœºçš„æ€§è´¨ï¼šä¸€ç»„<code>Server</code>çš„çŠ¶æ€æœºè®¡ç®—ç›¸åŒçŠ¶æ€çš„å‰¯æœ¬ï¼Œå³ä½¿æœ‰ä¸€éƒ¨åˆ†çš„<code>Server</code>å®•æœºäº†å®ƒä»¬ä»ç„¶èƒ½å¤Ÿç»§ç»­è¿è¡Œã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/paxos-rsm-architecture.png" alt="rsm-architecture.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å›¾-1 å¤åˆ¶çŠ¶æ€æœºæ¶æ„</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬é€šè¿‡ä½¿ç”¨å¤åˆ¶æ—¥å¿—æ¥å®ç°å¤åˆ¶çŠ¶æ€æœºã€‚æ¯ä¸ª<code>Server</code>å­˜å‚¨ç€ä¸€ä»½åŒ…æ‹¬å‘½ä»¤åºåˆ—çš„æ—¥å¿—æ–‡ä»¶ï¼ŒçŠ¶æ€æœºä¼šæŒ‰é¡ºåºæ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚å› ä¸ºæ¯ä¸ªæ—¥å¿—åŒ…å«ç›¸åŒçš„å‘½ä»¤ï¼Œå¹¶ä¸”é¡ºåºä¹Ÿç›¸åŒï¼Œæ‰€ä»¥æ¯ä¸ªçŠ¶æ€æœºå¤„ç†ç›¸åŒçš„å‘½ä»¤åºåˆ—ã€‚ç”±äºçŠ¶æ€æœºæ˜¯ç¡®å®šæ€§çš„ï¼Œæ‰€ä»¥å¤„ç†ç›¸åŒçš„çŠ¶æ€ï¼Œå¾—åˆ°ç›¸åŒçš„è¾“å‡ºã€‚</p><p>å› æ­¤å…±è¯†ç®—æ³•çš„å·¥ä½œå°±æ˜¯ä¿æŒå¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—ä»å®¢æˆ·ç«¯æ¥æ”¶å‘½ä»¤å¹¶å°†å®ƒä»¬æ·»åŠ åˆ°æ—¥å¿—ä¸­ã€‚å®ƒä¸å…¶ä»–æœåŠ¡å™¨ä¸Šçš„å…±è¯†æ¨¡å—é€šä¿¡ï¼Œä»¥ç¡®ä¿å³ä½¿æŸäº›æœåŠ¡å™¨å‘ç”Ÿæ•…éšœã€‚æ¯ä¸ªæ—¥å¿—æœ€ç»ˆåŒ…å«ç›¸åŒé¡ºåºçš„è¯·æ±‚ã€‚ä¸€æ—¦å‘½ä»¤è¢«æ­£ç¡®åœ°å¤åˆ¶ï¼Œå®ƒä»¬å°±è¢«ç§°ä¸ºå·²æäº¤ã€‚æ¯ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€æœºæŒ‰ç…§æ—¥å¿—é¡ºåºå¤„ç†å·²æäº¤çš„å‘½ä»¤ï¼Œå¹¶å°†è¾“å‡ºè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå› æ­¤ï¼Œè¿™äº›æœåŠ¡å™¨å½¢æˆäº†ä¸€ä¸ªå•ä¸€çš„ã€é«˜åº¦å¯é çš„çŠ¶æ€æœºã€‚</p><p>é€‚ç”¨äºå®é™…ç³»ç»Ÿçš„å…±è¯†ç®—æ³•é€šå¸¸å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ul><li>å®‰å…¨ã€‚ç¡®ä¿åœ¨éæ‹œå åº­æ¡ä»¶ï¼ˆä¹Ÿå°±æ˜¯ä¸Šæ–‡ä¸­æåˆ°çš„ç®€æ˜“ç‰ˆæ‹œå åº­ï¼‰ä¸‹çš„å®‰å…¨æ€§ï¼ŒåŒ…æ‹¬ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€åŒ…ä¸¢å¤±ã€å¤åˆ¶å’Œé‡æ–°æ’åºã€‚</li><li>é«˜å¯ç”¨ã€‚åªè¦å¤§å¤šæ•°æœåŠ¡å™¨éƒ½æ˜¯å¯æ“ä½œçš„ï¼Œå¹¶ä¸”å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä¸å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆè¿™äº›æœåŠ¡å™¨å°±å¯ä»¥çœ‹ä½œå®Œå…¨åŠŸèƒ½å¯ç”¨çš„ã€‚å› æ­¤ï¼Œä¸€ä¸ªå…¸å‹çš„ç”±äº”å°æœåŠ¡å™¨ç»„æˆçš„é›†ç¾¤å¯ä»¥å®¹å¿ä»»ä½•ä¸¤å°æœåŠ¡å™¨ç«¯æ•…éšœã€‚å‡è®¾æœåŠ¡å™¨å› åœæ­¢è€Œå‘ç”Ÿæ•…éšœï¼›å®ƒä»¬ç¨åå¯èƒ½ä¼šä»ç¨³å®šå­˜å‚¨ä¸Šçš„çŠ¶æ€ä¸­æ¢å¤å¹¶é‡æ–°åŠ å…¥é›†ç¾¤ã€‚</li><li>ä¸€è‡´æ€§ä¸ä¾èµ–æ—¶åºã€‚é”™è¯¯çš„æ—¶é’Ÿå’Œæç«¯çš„æ¶ˆæ¯å»¶è¿Ÿï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ä¹Ÿåªä¼šé€ æˆå¯ç”¨æ€§é—®é¢˜ï¼Œè€Œä¸ä¼šäº§ç”Ÿä¸€è‡´æ€§é—®é¢˜ã€‚</li><li>åœ¨é›†ç¾¤ä¸­å¤§å¤šæ•°æœåŠ¡å™¨å“åº”ï¼Œå‘½ä»¤å°±å¯ä»¥å®Œæˆï¼Œä¸ä¼šè¢«å°‘æ•°è¿è¡Œç¼“æ…¢çš„æœåŠ¡å™¨æ¥å½±å“æ•´ä½“ç³»ç»Ÿæ€§èƒ½ã€‚</li></ul><h2 id="2-åŸºç¡€"><a href="#2-åŸºç¡€" class="headerlink" title="# 2 åŸºç¡€"></a><a href="#_2-%E5%9F%BA%E7%A1%80">#</a> 2 åŸºç¡€</h2><h3 id="2-1-èŠ‚ç‚¹ç±»å‹"><a href="#2-1-èŠ‚ç‚¹ç±»å‹" class="headerlink" title="# 2.1 èŠ‚ç‚¹ç±»å‹"></a><a href="#_2-1-%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B">#</a> 2.1 èŠ‚ç‚¹ç±»å‹</h3><p>ä¸€ä¸ª Raft é›†ç¾¤åŒ…æ‹¬è‹¥å¹²æœåŠ¡å™¨ï¼Œä»¥å…¸å‹çš„ 5 æœåŠ¡å™¨é›†ç¾¤ä¸¾ä¾‹ã€‚åœ¨ä»»æ„çš„æ—¶é—´ï¼Œæ¯ä¸ªæœåŠ¡å™¨ä¸€å®šä¼šå¤„äºä»¥ä¸‹ä¸‰ä¸ªçŠ¶æ€ä¸­çš„ä¸€ä¸ªï¼š</p><ul><li><code>Leader</code>ï¼šè´Ÿè´£å‘èµ·å¿ƒè·³ï¼Œå“åº”å®¢æˆ·ç«¯ï¼Œåˆ›å»ºæ—¥å¿—ï¼ŒåŒæ­¥æ—¥å¿—ã€‚</li><li><code>Candidate</code>ï¼šLeader é€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶è§’è‰²ï¼Œç”± Follower è½¬åŒ–è€Œæ¥ï¼Œå‘èµ·æŠ•ç¥¨å‚ä¸ç«é€‰ã€‚</li><li><code>Follower</code>ï¼šæ¥å— Leader çš„å¿ƒè·³å’Œæ—¥å¿—åŒæ­¥æ•°æ®ï¼ŒæŠ•ç¥¨ç»™ Candidateã€‚</li></ul><p>åœ¨æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªæœåŠ¡å™¨æ˜¯ Leaderï¼Œå‰©ä¸‹çš„æœåŠ¡å™¨æ˜¯ Followerã€‚Follower æ˜¯è¢«åŠ¨çš„ï¼Œå®ƒä»¬ä¸ä¼šå‘é€ä»»ä½•è¯·æ±‚ï¼Œåªæ˜¯å“åº”æ¥è‡ª Leader å’Œ Candidate çš„è¯·æ±‚ã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/paxos-server-state.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å›¾-2ï¼šæœåŠ¡å™¨çš„çŠ¶æ€</span><br></pre></td></tr></table></figure><h3 id="2-2-ä»»æœŸ"><a href="#2-2-ä»»æœŸ" class="headerlink" title="# 2.2 ä»»æœŸ"></a><a href="#_2-2-%E4%BB%BB%E6%9C%9F">#</a> 2.2 ä»»æœŸ</h3><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/paxos-term.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å›¾-3ï¼šä»»æœŸ</span><br></pre></td></tr></table></figure><p>å¦‚å›¾ 3 æ‰€ç¤ºï¼Œraft ç®—æ³•å°†æ—¶é—´åˆ’åˆ†ä¸ºä»»æ„é•¿åº¦çš„ä»»æœŸï¼ˆtermï¼‰ï¼Œä»»æœŸç”¨è¿ç»­çš„æ•°å­—è¡¨ç¤ºï¼Œçœ‹ä½œå½“å‰ term å·ã€‚æ¯ä¸€ä¸ªä»»æœŸçš„å¼€å§‹éƒ½æ˜¯ä¸€æ¬¡é€‰ä¸¾ï¼Œåœ¨é€‰ä¸¾å¼€å§‹æ—¶ï¼Œä¸€ä¸ªæˆ–å¤šä¸ª Candidate ä¼šå°è¯•æˆä¸º Leaderã€‚å¦‚æœä¸€ä¸ª Candidate èµ¢å¾—äº†é€‰ä¸¾ï¼Œå®ƒå°±ä¼šåœ¨è¯¥ä»»æœŸå†…æ‹…ä»» Leaderã€‚å¦‚æœæ²¡æœ‰é€‰å‡º Leaderï¼Œå°†ä¼šå¼€å¯å¦ä¸€ä¸ªä»»æœŸï¼Œå¹¶ç«‹åˆ»å¼€å§‹ä¸‹ä¸€æ¬¡é€‰ä¸¾ã€‚raft ç®—æ³•ä¿è¯åœ¨ç»™å®šçš„ä¸€ä¸ªä»»æœŸæœ€å°‘è¦æœ‰ä¸€ä¸ª Leaderã€‚</p><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå­˜å‚¨å½“å‰çš„ term å·ï¼Œå½“æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶ä¼šäº¤æ¢å½“å‰çš„ term å·ï¼›å¦‚æœæœ‰æœåŠ¡å™¨å‘ç°è‡ªå·±çš„ term å·æ¯”å…¶ä»–äººå°ï¼Œé‚£ä¹ˆä»–ä¼šæ›´æ–°åˆ°è¾ƒå¤§çš„ term å€¼ã€‚å¦‚æœä¸€ä¸ª Candidate æˆ–è€… Leader å‘ç°è‡ªå·±çš„ term è¿‡æœŸäº†ï¼Œä»–ä¼šç«‹å³é€€å›æˆ Followerã€‚å¦‚æœä¸€å°æœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚çš„ term å·æ˜¯è¿‡æœŸçš„ï¼Œé‚£ä¹ˆå®ƒä¼šæ‹’ç»æ­¤æ¬¡è¯·æ±‚ã€‚</p><h3 id="2-3-æ—¥å¿—"><a href="#2-3-æ—¥å¿—" class="headerlink" title="# 2.3 æ—¥å¿—"></a><a href="#_2-3-%E6%97%A5%E5%BF%97">#</a> 2.3 æ—¥å¿—</h3><ul><li><code>entry</code>ï¼šæ¯ä¸€ä¸ªäº‹ä»¶æˆä¸º entryï¼Œåªæœ‰ Leader å¯ä»¥åˆ›å»º entryã€‚entry çš„å†…å®¹ä¸º<code>&lt;term,index,cmd&gt;</code>å…¶ä¸­ cmd æ˜¯å¯ä»¥åº”ç”¨åˆ°çŠ¶æ€æœºçš„æ“ä½œã€‚</li><li><code>log</code>ï¼šç”± entry æ„æˆçš„æ•°ç»„ï¼Œæ¯ä¸€ä¸ª entry éƒ½æœ‰ä¸€ä¸ªè¡¨æ˜è‡ªå·±åœ¨ log ä¸­çš„ indexã€‚åªæœ‰ Leader æ‰å¯ä»¥æ”¹å˜å…¶ä»–èŠ‚ç‚¹çš„ logã€‚entry æ€»æ˜¯å…ˆè¢« Leader æ·»åŠ åˆ°è‡ªå·±çš„ log æ•°ç»„ä¸­ï¼Œç„¶åå†å‘èµ·å…±è¯†è¯·æ±‚ï¼Œè·å¾—åŒæ„åæ‰ä¼šè¢« Leader æäº¤ç»™çŠ¶æ€æœºã€‚Follower åªèƒ½ä» Leader è·å–æ–°æ—¥å¿—å’Œå½“å‰çš„ commitIndexï¼Œç„¶åæŠŠå¯¹åº”çš„ entry åº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ã€‚</li></ul><h2 id="3-é¢†å¯¼äººé€‰ä¸¾"><a href="#3-é¢†å¯¼äººé€‰ä¸¾" class="headerlink" title="# 3 é¢†å¯¼äººé€‰ä¸¾"></a><a href="#_3-%E9%A2%86%E5%AF%BC%E4%BA%BA%E9%80%89%E4%B8%BE">#</a> 3 é¢†å¯¼äººé€‰ä¸¾</h2><p>raft ä½¿ç”¨å¿ƒè·³æœºåˆ¶æ¥è§¦å‘ Leader çš„é€‰ä¸¾ã€‚</p><p>å¦‚æœä¸€å°æœåŠ¡å™¨èƒ½å¤Ÿæ”¶åˆ°æ¥è‡ª Leader æˆ–è€… Candidate çš„æœ‰æ•ˆä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒä¼šä¸€ç›´ä¿æŒä¸º Follower çŠ¶æ€ï¼Œå¹¶ä¸”åˆ·æ–°è‡ªå·±çš„ electionElapsedï¼Œé‡æ–°è®¡æ—¶ã€‚</p><p>Leader ä¼šå‘æ‰€æœ‰çš„ Follower å‘¨æœŸæ€§å‘é€å¿ƒè·³æ¥ä¿è¯è‡ªå·±çš„ Leader åœ°ä½ã€‚å¦‚æœä¸€ä¸ª Follower åœ¨ä¸€ä¸ªå‘¨æœŸå†…æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ä¿¡æ¯ï¼Œå°±å«åšé€‰ä¸¾è¶…æ—¶ï¼Œç„¶åå®ƒå°±ä¼šè®¤ä¸ºæ­¤æ—¶æ²¡æœ‰å¯ç”¨çš„ Leaderï¼Œå¹¶ä¸”å¼€å§‹è¿›è¡Œä¸€æ¬¡é€‰ä¸¾ä»¥é€‰å‡ºä¸€ä¸ªæ–°çš„ Leaderã€‚</p><p>ä¸ºäº†å¼€å§‹æ–°çš„é€‰ä¸¾ï¼ŒFollower ä¼šè‡ªå¢è‡ªå·±çš„ term å·å¹¶ä¸”è½¬æ¢çŠ¶æ€ä¸º Candidateã€‚ç„¶åä»–ä¼šå‘æ‰€æœ‰èŠ‚ç‚¹å‘èµ· RequestVoteRPC è¯·æ±‚ï¼Œ Candidate çš„çŠ¶æ€ä¼šæŒç»­åˆ°ä»¥ä¸‹æƒ…å†µå‘ç”Ÿï¼š</p><ul><li>èµ¢å¾—é€‰ä¸¾</li><li>å…¶ä»–èŠ‚ç‚¹èµ¢å¾—é€‰ä¸¾</li><li>ä¸€è½®é€‰ä¸¾ç»“æŸï¼Œæ— äººèƒœå‡º</li></ul><p>èµ¢å¾—é€‰ä¸¾çš„æ¡ä»¶æ˜¯ï¼šä¸€ä¸ª Candidate åœ¨ä¸€ä¸ªä»»æœŸå†…æ”¶åˆ°äº†æ¥è‡ªé›†ç¾¤å†…çš„å¤šæ•°é€‰ç¥¨<code>ï¼ˆN/2+1ï¼‰</code>ï¼Œå°±å¯ä»¥æˆä¸º Leaderã€‚</p><p>åœ¨ Candidate ç­‰å¾…é€‰ç¥¨çš„æ—¶å€™ï¼Œå®ƒå¯èƒ½æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å£°æ˜è‡ªå·±æ˜¯ Leader çš„å¿ƒè·³ï¼Œæ­¤æ—¶æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>è¯¥ Leader çš„ term å·å¤§äºç­‰äºè‡ªå·±çš„ term å·ï¼Œè¯´æ˜å¯¹æ–¹å·²ç»æˆä¸º Leaderï¼Œåˆ™è‡ªå·±å›é€€ä¸º Followerã€‚</li><li>è¯¥ Leader çš„ term å·å°äºè‡ªå·±çš„ term å·ï¼Œé‚£ä¹ˆä¼šæ‹’ç»è¯¥è¯·æ±‚å¹¶è®©è¯¥èŠ‚ç‚¹æ›´æ–° termã€‚</li></ul><p>ç”±äºå¯èƒ½åŒä¸€æ—¶åˆ»å‡ºç°å¤šä¸ª Candidateï¼Œå¯¼è‡´æ²¡æœ‰ Candidate è·å¾—å¤§å¤šæ•°é€‰ç¥¨ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–æ‰‹æ®µæ¥é‡æ–°åˆ†é…é€‰ç¥¨çš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæ— é™é‡å¤ä¸‹å»ã€‚</p><p>raft ä½¿ç”¨äº†éšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´æ¥é¿å…ä¸Šè¿°æƒ…å†µã€‚æ¯ä¸€ä¸ª Candidate åœ¨å‘èµ·é€‰ä¸¾åï¼Œéƒ½ä¼šéšæœºåŒ–ä¸€ä¸ªæ–°çš„æšä¸¾è¶…æ—¶æ—¶é—´ï¼Œè¿™ç§æœºåˆ¶ä½¿å¾—å„ä¸ªæœåŠ¡å™¨èƒ½å¤Ÿåˆ†æ•£å¼€æ¥ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ä¼šç‡å…ˆè¶…æ—¶ï¼›å®ƒä¼šåœ¨å…¶ä»–æœåŠ¡å™¨è¶…æ—¶ä¹‹å‰èµ¢å¾—é€‰ä¸¾ã€‚</p><h2 id="4-æ—¥å¿—å¤åˆ¶"><a href="#4-æ—¥å¿—å¤åˆ¶" class="headerlink" title="# 4 æ—¥å¿—å¤åˆ¶"></a><a href="#_4-%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6">#</a> 4 æ—¥å¿—å¤åˆ¶</h2><p>ä¸€æ—¦é€‰å‡ºäº† Leaderï¼Œå®ƒå°±å¼€å§‹æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚æ¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½åŒ…å«ä¸€æ¡éœ€è¦è¢«å¤åˆ¶çŠ¶æ€æœºï¼ˆ<code>Replicated State Mechine</code>ï¼‰æ‰§è¡Œçš„å‘½ä»¤ã€‚</p><p>Leader æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œä¼šç”Ÿæˆä¸€ä¸ª entryï¼ŒåŒ…å«<code>&lt;index,term,cmd&gt;</code>ï¼Œå†å°†è¿™ä¸ª entry æ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—æœ«å°¾åï¼Œå‘æ‰€æœ‰çš„èŠ‚ç‚¹å¹¿æ’­è¯¥ entryï¼Œè¦æ±‚å…¶ä»–æœåŠ¡å™¨å¤åˆ¶è¿™æ¡ entryã€‚</p><p>å¦‚æœ Follower æ¥å—è¯¥ entryï¼Œåˆ™ä¼šå°† entry æ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—åé¢ï¼ŒåŒæ—¶è¿”å›ç»™ Leader åŒæ„ã€‚</p><p>å¦‚æœ Leader æ”¶åˆ°äº†å¤šæ•°çš„æˆåŠŸå“åº”ï¼ŒLeader ä¼šå°†è¿™ä¸ª entry åº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ï¼Œä¹‹åå¯ä»¥æˆä¸ºè¿™ä¸ª entry æ˜¯ committed çš„ï¼Œå¹¶ä¸”å‘å®¢æˆ·ç«¯è¿”å›æ‰§è¡Œç»“æœã€‚</p><p>raft ä¿è¯ä»¥ä¸‹ä¸¤ä¸ªæ€§è´¨ï¼š</p><ul><li>åœ¨ä¸¤ä¸ªæ—¥å¿—é‡Œï¼Œæœ‰ä¸¤ä¸ª entry æ‹¥æœ‰ç›¸åŒçš„ index å’Œ termï¼Œé‚£ä¹ˆå®ƒä»¬ä¸€å®šæœ‰ç›¸åŒçš„ cmd</li><li>åœ¨ä¸¤ä¸ªæ—¥å¿—é‡Œï¼Œæœ‰ä¸¤ä¸ª entry æ‹¥æœ‰ç›¸åŒçš„ index å’Œ termï¼Œé‚£ä¹ˆå®ƒä»¬å‰é¢çš„ entry ä¹Ÿä¸€å®šç›¸åŒ</li></ul><p>é€šè¿‡â€œä»…æœ‰ Leader å¯ä»¥ç”Ÿå­˜ entryâ€æ¥ä¿è¯ç¬¬ä¸€ä¸ªæ€§è´¨ï¼Œç¬¬äºŒä¸ªæ€§è´¨éœ€è¦ä¸€è‡´æ€§æ£€æŸ¥æ¥è¿›è¡Œä¿è¯ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒLeader å’Œ Follower çš„æ—¥å¿—ä¿æŒä¸€è‡´ï¼Œç„¶åï¼ŒLeader çš„å´©æºƒä¼šå¯¼è‡´æ—¥å¿—ä¸ä¸€æ ·ï¼Œè¿™æ ·ä¸€è‡´æ€§æ£€æŸ¥ä¼šäº§ç”Ÿå¤±è´¥ã€‚Leader é€šè¿‡å¼ºåˆ¶ Follower å¤åˆ¶è‡ªå·±çš„æ—¥å¿—æ¥å¤„ç†æ—¥å¿—çš„ä¸ä¸€è‡´ã€‚è¿™å°±æ„å‘³ç€ï¼Œåœ¨ Follower ä¸Šçš„å†²çªæ—¥å¿—ä¼šè¢«é¢†å¯¼è€…çš„æ—¥å¿—è¦†ç›–ã€‚</p><p>ä¸ºäº†ä½¿å¾— Follower çš„æ—¥å¿—å’Œè‡ªå·±çš„æ—¥å¿—ä¸€è‡´ï¼ŒLeader éœ€è¦æ‰¾åˆ° Follower ä¸å®ƒæ—¥å¿—ä¸€è‡´çš„åœ°æ–¹ï¼Œç„¶ååˆ é™¤ Follower åœ¨è¯¥ä½ç½®ä¹‹åçš„æ—¥å¿—ï¼Œæ¥ç€æŠŠè¿™ä¹‹åçš„æ—¥å¿—å‘é€ç»™ Followerã€‚</p><p><code>Leader</code> ç»™æ¯ä¸€ä¸ª<code>Follower</code> ç»´æŠ¤äº†ä¸€ä¸ª <code>nextIndex</code>ï¼Œå®ƒè¡¨ç¤º <code>Leader</code> å°†è¦å‘é€ç»™è¯¥è¿½éšè€…çš„ä¸‹ä¸€æ¡æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ã€‚å½“ä¸€ä¸ª <code>Leader</code> å¼€å§‹æŒæƒæ—¶ï¼Œå®ƒä¼šå°† <code>nextIndex</code> åˆå§‹åŒ–ä¸ºå®ƒçš„æœ€æ–°çš„æ—¥å¿—æ¡ç›®ç´¢å¼•æ•°+1ã€‚å¦‚æœä¸€ä¸ª <code>Follower</code> çš„æ—¥å¿—å’Œ <code>Leader</code> çš„ä¸ä¸€è‡´ï¼Œ<code>AppendEntries</code> ä¸€è‡´æ€§æ£€æŸ¥ä¼šåœ¨ä¸‹ä¸€æ¬¡ <code>AppendEntries RPC</code> æ—¶è¿”å›å¤±è´¥ã€‚åœ¨å¤±è´¥ä¹‹åï¼Œ<code>Leader</code> ä¼šå°† <code>nextIndex</code> é€’å‡ç„¶åé‡è¯• <code>AppendEntries RPC</code>ã€‚æœ€ç»ˆ <code>nextIndex</code> ä¼šè¾¾åˆ°ä¸€ä¸ª <code>Leader</code> å’Œ <code>Follower</code> æ—¥å¿—ä¸€è‡´çš„åœ°æ–¹ã€‚è¿™æ—¶ï¼Œ<code>AppendEntries</code> ä¼šè¿”å›æˆåŠŸï¼Œ<code>Follower</code> ä¸­å†²çªçš„æ—¥å¿—æ¡ç›®éƒ½è¢«ç§»é™¤äº†ï¼Œå¹¶ä¸”æ·»åŠ æ‰€ç¼ºå°‘çš„ä¸Šäº† <code>Leader</code> çš„æ—¥å¿—æ¡ç›®ã€‚ä¸€æ—¦ <code>AppendEntries</code> è¿”å›æˆåŠŸï¼Œ<code>Follower</code> å’Œ <code>Leader</code> çš„æ—¥å¿—å°±ä¸€è‡´äº†ï¼Œè¿™æ ·çš„çŠ¶æ€ä¼šä¿æŒåˆ°è¯¥ä»»æœŸç»“æŸã€‚</p><h2 id="5-å®‰å…¨æ€§"><a href="#5-å®‰å…¨æ€§" class="headerlink" title="# 5 å®‰å…¨æ€§"></a><a href="#_5-%E5%AE%89%E5%85%A8%E6%80%A7">#</a> 5 å®‰å…¨æ€§</h2><h3 id="5-1-é€‰ä¸¾é™åˆ¶"><a href="#5-1-é€‰ä¸¾é™åˆ¶" class="headerlink" title="# 5.1 é€‰ä¸¾é™åˆ¶"></a><a href="#_5-1-%E9%80%89%E4%B8%BE%E9%99%90%E5%88%B6">#</a> 5.1 é€‰ä¸¾é™åˆ¶</h3><p>Leader éœ€è¦ä¿è¯è‡ªå·±å­˜å‚¨å…¨éƒ¨å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚è¿™æ ·æ‰å¯ä»¥ä½¿æ—¥å¿—æ¡ç›®åªæœ‰ä¸€ä¸ªæµå‘ï¼šä» Leader æµå‘ Followerï¼ŒLeader æ°¸è¿œä¸ä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„æ—¥å¿—æ¡ç›®ã€‚</p><p>æ¯ä¸ª Candidate å‘é€ RequestVoteRPC æ—¶ï¼Œéƒ½ä¼šå¸¦ä¸Šæœ€åä¸€ä¸ª entry çš„ä¿¡æ¯ã€‚æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°æŠ•ç¥¨ä¿¡æ¯æ—¶ï¼Œä¼šå¯¹è¯¥ entry è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°è‡ªå·±çš„æ›´æ–°ï¼Œåˆ™æ‹’ç»æŠ•ç¥¨ç»™è¯¥ Candidateã€‚</p><p>åˆ¤æ–­æ—¥å¿—æ–°æ—§çš„æ–¹å¼ï¼šå¦‚æœä¸¤ä¸ªæ—¥å¿—çš„ term ä¸åŒï¼Œterm å¤§çš„æ›´æ–°ï¼›å¦‚æœ term ç›¸åŒï¼Œæ›´é•¿çš„ index æ›´æ–°ã€‚</p><h3 id="5-2-èŠ‚ç‚¹å´©æºƒ"><a href="#5-2-èŠ‚ç‚¹å´©æºƒ" class="headerlink" title="# 5.2 èŠ‚ç‚¹å´©æºƒ"></a><a href="#_5-2-%E8%8A%82%E7%82%B9%E5%B4%A9%E6%BA%83">#</a> 5.2 èŠ‚ç‚¹å´©æºƒ</h3><p>å¦‚æœ Leader å´©æºƒï¼Œé›†ç¾¤ä¸­çš„èŠ‚ç‚¹åœ¨ electionTimeout æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° Leader çš„å¿ƒè·³ä¿¡æ¯å°±ä¼šè§¦å‘æ–°ä¸€è½®çš„é€‰ä¸»ï¼Œåœ¨é€‰ä¸»æœŸé—´æ•´ä¸ªé›†ç¾¤å¯¹å¤–æ˜¯ä¸å¯ç”¨çš„ã€‚</p><p>å¦‚æœ Follower å’Œ Candidate å´©æºƒï¼Œå¤„ç†æ–¹å¼ä¼šç®€å•å¾ˆå¤šã€‚ä¹‹åå‘é€ç»™å®ƒçš„ RequestVoteRPC å’Œ AppendEntriesRPC ä¼šå¤±è´¥ã€‚ç”±äº raft çš„æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥å¤±è´¥çš„è¯ä¼šæ— é™çš„é‡è¯•ã€‚å¦‚æœå´©æºƒæ¢å¤åï¼Œå°±å¯ä»¥æ”¶åˆ°æ–°çš„è¯·æ±‚ï¼Œç„¶åé€‰æ‹©è¿½åŠ æˆ–è€…æ‹’ç» entryã€‚</p><h3 id="5-3-æ—¶é—´ä¸å¯ç”¨æ€§"><a href="#5-3-æ—¶é—´ä¸å¯ç”¨æ€§" class="headerlink" title="# 5.3 æ—¶é—´ä¸å¯ç”¨æ€§"></a><a href="#_5-3-%E6%97%B6%E9%97%B4%E4%B8%8E%E5%8F%AF%E7%94%A8%E6%80%A7">#</a> 5.3 æ—¶é—´ä¸å¯ç”¨æ€§</h3><p>raft çš„è¦æ±‚ä¹‹ä¸€å°±æ˜¯å®‰å…¨æ€§ä¸ä¾èµ–äºæ—¶é—´ï¼šç³»ç»Ÿä¸èƒ½ä»…ä»…å› ä¸ºä¸€äº›äº‹ä»¶å‘ç”Ÿçš„æ¯”é¢„æƒ³çš„å¿«ä¸€äº›æˆ–è€…æ…¢ä¸€äº›å°±äº§ç”Ÿé”™è¯¯ã€‚ä¸ºäº†ä¿è¯ä¸Šè¿°è¦æ±‚ï¼Œæœ€å¥½èƒ½æ»¡è¶³ä»¥ä¸‹çš„æ—¶é—´æ¡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">broadcastTime &lt;&lt; electionTimeout &lt;&lt; MTBF</span><br></pre></td></tr></table></figure><ul><li><code>broadcastTime</code>ï¼šå‘å…¶ä»–èŠ‚ç‚¹å¹¶å‘å‘é€æ¶ˆæ¯çš„å¹³å‡å“åº”æ—¶é—´ï¼›</li><li><code>electionTimeout</code>ï¼šé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼›</li><li><code>MTBF(mean time between failures)</code>ï¼šå•å°æœºå™¨çš„å¹³å‡å¥åº·æ—¶é—´ï¼›</li></ul><p><code>broadcastTime</code>åº”è¯¥æ¯”<code>electionTimeout</code>å°ä¸€ä¸ªæ•°é‡çº§ï¼Œä¸ºçš„æ˜¯ä½¿<code>Leader</code>èƒ½å¤ŸæŒç»­å‘é€å¿ƒè·³ä¿¡æ¯ï¼ˆheartbeatï¼‰æ¥é˜»æ­¢<code>Follower</code>å¼€å§‹é€‰ä¸¾ï¼›</p><p><code>electionTimeout</code>ä¹Ÿè¦æ¯”<code>MTBF</code>å°å‡ ä¸ªæ•°é‡çº§ï¼Œä¸ºçš„æ˜¯ä½¿å¾—ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚å½“<code>Leader</code>å´©æºƒæ—¶ï¼Œå¤§çº¦ä¼šåœ¨æ•´ä¸ª<code>electionTimeout</code>çš„æ—¶é—´å†…ä¸å¯ç”¨ï¼›æˆ‘ä»¬å¸Œæœ›è¿™ç§æƒ…å†µä»…å å…¨éƒ¨æ—¶é—´çš„å¾ˆå°ä¸€éƒ¨åˆ†ã€‚</p><p>ç”±äº<code>broadcastTime</code>å’Œ<code>MTBF</code>æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„å±æ€§ï¼Œå› æ­¤éœ€è¦å†³å®š<code>electionTimeout</code>çš„æ—¶é—´ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼ŒbroadcastTime ä¸€èˆ¬ä¸º <code>0.5ï½20ms</code>ï¼ŒelectionTimeout å¯ä»¥è®¾ç½®ä¸º <code>10ï½500ms</code>ï¼ŒMTBF ä¸€èˆ¬ä¸ºä¸€ä¸¤ä¸ªæœˆã€‚</p><h2 id="6-å‚è€ƒ"><a href="#6-å‚è€ƒ" class="headerlink" title="# 6 å‚è€ƒ"></a><a href="#_6-%E5%8F%82%E8%80%83">#</a> 6 å‚è€ƒ</h2><ul><li><a target="_blank" rel="noopener" href="https://tanxinyu.work/raft/">https://tanxinyu.work/raft/</a></li><li><a target="_blank" rel="noopener" href="https://github.com/OneSizeFitsQuorum/raft-thesis-zh_cn/blob/master/raft-thesis-zh_cn.md">https://github.com/OneSizeFitsQuorum/raft-thesis-zh_cn/blob/master/raft-thesis-zh_cn.md</a></li><li><a target="_blank" rel="noopener" href="https://github.com/ongardie/dissertation/blob/master/stanford.pdf">https://github.com/ongardie/dissertation/blob/master/stanford.pdf</a></li><li><a target="_blank" rel="noopener" href="https://knowledge-sharing.gitbooks.io/raft/content/chapter5.html">https://knowledge-sharing.gitbooks.io/raft/content/chapter5.html</a></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2020/10/02/2020-01-10-redis-slave/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2020/10/02/2020-01-10-redis-slave/" class="post-title-link" itemprop="url">Redisé«˜å¯ç”¨</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2020-10-02 13:30:00" itemprop="dateCreated datePublished" datetime="2020-10-02T13:30:00+08:00">2020-10-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="å•æœºç‰ˆRedisé—®é¢˜"><a href="#å•æœºç‰ˆRedisé—®é¢˜" class="headerlink" title="å•æœºç‰ˆRedisé—®é¢˜"></a>å•æœºç‰ˆRedisé—®é¢˜</h2><ul><li>æœºå™¨æ•…éšœéœ€è¦åšæ•°æ®æ‰‹åŠ¨è¿ç§»</li><li>å®¹é‡ç“¶é¢ˆ</li><li>QPSç“¶é¢ˆ</li></ul><h2 id="å¼•å…¥æ­£é¢˜"><a href="#å¼•å…¥æ­£é¢˜" class="headerlink" title="å¼•å…¥æ­£é¢˜"></a>å¼•å…¥æ­£é¢˜</h2><p>å‰é¢åˆ—å‡ºçš„å®¹é‡ç“¶é¢ˆå’ŒQPSç“¶é¢ˆæ˜¯redisåˆ†å¸ƒå¼è¦è§£å†³çš„é—®é¢˜ï¼Œæœ¬ç¯‡è¿˜æ˜¯ä¸»è¦è§£å†³<br>redisæ€ä¹ˆå®ç°é«˜å¯ç”¨ï¼Œæœºå™¨æ•…éšœçš„é—®é¢˜</p><h2 id="ä¸»ä»å¤åˆ¶ä»‹ç»"><a href="#ä¸»ä»å¤åˆ¶ä»‹ç»" class="headerlink" title="ä¸»ä»å¤åˆ¶ä»‹ç»"></a>ä¸»ä»å¤åˆ¶ä»‹ç»</h2><p>ä½œç”¨ï¼š</p><ul><li>æµé‡åˆ†æµå’Œè´Ÿè½½å‡è¡¡</li><li>æä¾›å¤šä¸ªæ•°æ®åˆ†å¸ƒ</li><li>æ‰©å±•redisè¯»æ€§èƒ½</li></ul><h3 id="ç®€å•æ€»ç»“"><a href="#ç®€å•æ€»ç»“" class="headerlink" title="ç®€å•æ€»ç»“"></a>ç®€å•æ€»ç»“</h3><ul><li>ä¸€ä¸ªmasterå¯ä»¥æœ‰å¤šä¸ªslave</li><li>ä¸€ä¸ªslaveåªèƒ½æœ‰ä¸€ä¸ªmaster</li><li>æ•°æ®æµå‘æ˜¯å•å‘çš„ï¼Œmasteråˆ°slave</li></ul><h2 id="ä¸»ä»å¤åˆ¶æ“ä½œ"><a href="#ä¸»ä»å¤åˆ¶æ“ä½œ" class="headerlink" title="ä¸»ä»å¤åˆ¶æ“ä½œ"></a>ä¸»ä»å¤åˆ¶æ“ä½œ</h2><p>masterèŠ‚ç‚¹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp $&#123;redis_src&#125;/redis.conf redis-6379.conf</span><br><span class="line">vim redis-6379.conf</span><br></pre></td></tr></table></figure><p>æ”¹åŠ¨é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis-6379.pid</span><br><span class="line">logfile &quot;6379.log&quot;</span><br><span class="line">logfile &quot;6379.log&quot;</span><br><span class="line">#save 900 1</span><br><span class="line">#save 300 10</span><br><span class="line">#save 60 10000</span><br><span class="line">dbfilename dump-6379.rdb</span><br><span class="line">dir /opt/soft/data</span><br></pre></td></tr></table></figure><p>slaveèŠ‚ç‚¹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp $&#123;redis_src&#125;/redis.conf redis-6380.conf</span><br><span class="line">vim redis-6380.conf</span><br></pre></td></tr></table></figure><p>æ”¹åŠ¨é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis-6380.pid</span><br><span class="line">logfile &quot;6380.log&quot;</span><br><span class="line">logfile &quot;6380.log&quot;</span><br><span class="line">#save 900 1</span><br><span class="line">#save 300 10</span><br><span class="line">#save 60 10000</span><br><span class="line">dbfilename dump-6380.rdb</span><br><span class="line">dir /opt/soft/data</span><br><span class="line">salveof 127.0.0.1 6379  #masterèŠ‚ç‚¹ ip port</span><br><span class="line">masterauth  #ä¸»èŠ‚ç‚¹è®¾ç½®å¯†ç æ—¶éœ€è¦é…ç½®</span><br></pre></td></tr></table></figure><p>å¯åŠ¨:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server 6379.conf</span><br><span class="line">redis-server 6380.conf</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ä¸»ä»çŠ¶æ€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line">127.0.0.1:6379&gt; set hello world</span><br><span class="line">127.0.0.1:6380&gt; get hello</span><br></pre></td></tr></table></figure><h2 id="runidå’Œå¤åˆ¶åç§»é‡"><a href="#runidå’Œå¤åˆ¶åç§»é‡" class="headerlink" title="runidå’Œå¤åˆ¶åç§»é‡"></a>runidå’Œå¤åˆ¶åç§»é‡</h2><h3 id="runid"><a href="#runid" class="headerlink" title="runid"></a>runid</h3><p>redisæ¯æ¬¡å¯åŠ¨åéƒ½ä¼šéšæœºç”Ÿæˆä¸€ä¸ªrunidæ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 6379 info server |grep run</span><br><span class="line">redis-cli -p 6380 info server |grep run</span><br></pre></td></tr></table></figure><blockquote><p>redisæ¯æ¬¡é‡å¯runidä¼šå‘ç”Ÿå˜åŒ–ï¼Œredisä»èŠ‚ç‚¹æ¯æ¬¡ä¼šæ£€æµ‹ä¸»èŠ‚ç‚¹runidå˜åŒ–æ¥è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶</p></blockquote><h3 id="åç§»é‡"><a href="#åç§»é‡" class="headerlink" title="åç§»é‡"></a>åç§»é‡</h3><p>ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éƒ½ä¼šè®°å½•æ‰§è¡Œä¸€æ¡å‘½ä»¤æ—¶æ•°æ®å†™å…¥çš„å­—èŠ‚æ•°ï¼Œå½“åç§»é‡è¾¾åˆ°ä¸€è‡´æ—¶ï¼Œæ•°æ®æ‰ä¼šåŒæ­¥å®Œæˆ</p><h2 id="å…¨é‡å¤åˆ¶"><a href="#å…¨é‡å¤åˆ¶" class="headerlink" title="å…¨é‡å¤åˆ¶"></a>å…¨é‡å¤åˆ¶</h2><p><img src="/img/in-post/2018-01-10/1.png"></p><p><strong>å…¨é‡å¤åˆ¶å¼€é”€</strong></p><ul><li>bgsaveæ—¶é—´</li><li>RDBæ–‡ä»¶ç½‘ç»œä¼ è¾“æ—¶é—´</li><li>ä»èŠ‚ç‚¹æ¸…ç©ºæ•°æ®æ—¶é—´</li><li>ä»èŠ‚ç‚¹åŠ è½½RDBæ—¶é—´</li><li>å¦‚æœé…ç½®AOFå¼€å¯ä¼šæœ‰AOFé‡å†™æ—¶é—´</li></ul><h2 id="éƒ¨åˆ†å¤åˆ¶"><a href="#éƒ¨åˆ†å¤åˆ¶" class="headerlink" title="éƒ¨åˆ†å¤åˆ¶"></a>éƒ¨åˆ†å¤åˆ¶</h2><p><img src="/img/in-post/2018-01-10/2.png"></p><h2 id="å¼€å‘è¿ç»´ä¸­çš„é—®é¢˜"><a href="#å¼€å‘è¿ç»´ä¸­çš„é—®é¢˜" class="headerlink" title="å¼€å‘è¿ç»´ä¸­çš„é—®é¢˜"></a>å¼€å‘è¿ç»´ä¸­çš„é—®é¢˜</h2><p><strong>è§„é¿å…¨é‡å¤åˆ¶ï¼š</strong></p><p>1ï¼šç¬¬ä¸€æ¬¡å…¨é‡å¤åˆ¶</p><ul><li>é—®é¢˜ï¼šç¬¬ä¸€æ¬¡ä¸å¯é¿å…</li><li>è§£å†³ï¼šå°ä¸»èŠ‚ç‚¹ï¼Œä½å³°</li></ul><p>2ï¼šèŠ‚ç‚¹è¿è¡ŒIDä¸åŒ¹é…</p><ul><li>é—®é¢˜ï¼šä¸»èŠ‚ç‚¹é‡å¯runidå˜åŒ–</li><li>è§£å†³ï¼šæ•…éšœè½¬ç§»ï¼Œä¾‹å¦‚å“¨å…µæˆ–é›†ç¾¤</li></ul><p>3ï¼šå¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸è¶³</p><ul><li>é—®é¢˜ï¼šç½‘ç»œä¸­æ–­ï¼Œéƒ¨åˆ†å¤åˆ¶æ— æ³•æ»¡è¶³</li><li>è§£å†³ï¼šå¢å¤§å¤åˆ¶ç¼“å†²åŒºé…ç½®rel_backlog_size</li></ul><p><strong>è§„é¿å¤åˆ¶é£æš´ï¼š</strong></p><p>1ï¼šå•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´</p><ul><li>é—®é¢˜ï¼šä¸»èŠ‚ç‚¹é‡å¯ï¼Œå¤šä»èŠ‚ç‚¹å¤åˆ¶</li><li>è§£å†³ï¼šæ›´æ¢å¤åˆ¶æ‹“æ‰‘(æ ‘å½¢æ¶æ„)</li></ul><p>1ï¼šå•æœºå™¨å¤åˆ¶é£æš´</p><ul><li>é—®é¢˜ï¼šæœºå™¨å®•æœºåï¼Œå¤§é‡å…¨é‡å¤åˆ¶</li><li>è§£å†³ï¼šä¸»èŠ‚ç‚¹åˆ†æ•£å¤šæœºå™¨</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2020/10/01/2020-01-08-redis/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2020/10/01/2020-01-08-redis/" class="post-title-link" itemprop="url">RedisæŒä¹…åŒ–</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2020-10-01 13:30:00" itemprop="dateCreated datePublished" datetime="2020-10-01T13:30:00+08:00">2020-10-01</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¯ä¸å¤šè¯´ç›´å¥”ä¸»é¢˜â€¦</p><h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><h3 id="ä¸»è¦è§¦å‘æœºåˆ¶"><a href="#ä¸»è¦è§¦å‘æœºåˆ¶" class="headerlink" title="ä¸»è¦è§¦å‘æœºåˆ¶"></a>ä¸»è¦è§¦å‘æœºåˆ¶</h3><h4 id="save"><a href="#save" class="headerlink" title="save"></a>save</h4><p><strong>cliå‘½ä»¤:</strong> save</p><p><strong>æ–‡ä»¶ç­–ç•¥ï¼š</strong> å¦‚æœå­˜åœ¨è€çš„RDBæ–‡ä»¶ï¼Œæ–°çš„å°†å…¶æ›¿æ¢æ‰</p><p><strong>æ—¶é—´å¤æ‚åº¦ï¼š</strong> O(n)</p><p>æˆ‘ä»¬æŠŠå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç”¨ä¸€ä¸ªå›¾æ¥è¡¨ç¤ºï¼Œsaveæ—¶ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªRDBæ–‡ä»¶<br><img src="/img/in-post/2019-01-08/1.png"></p><blockquote><p>ç”±äºå®ƒæ˜¯åŒæ­¥å‘½ä»¤ï¼Œå¹¶ä¸”åœ¨å•çº¿ç¨‹ä¸­æ‰§è¡Œ,åœ¨æ•°æ®é‡éå¸¸å¤šçš„æ—¶å€™ï¼Œæ­¤æ—¶æ‰§è¡Œsaveå‘½ä»¤ï¼Œä»–ä¼šå°†æ•°æ®è¿›è¡Œå®Œæ•´æ‹·è´ï¼Œå¯èƒ½ä¼šé€ æˆredisé˜»å¡ã€‚</p></blockquote><h4 id="bgsave"><a href="#bgsave" class="headerlink" title="bgsave"></a>bgsave</h4><p><img src="/img/in-post/2019-01-08/2.png"></p><blockquote><p>é€šè¿‡åœ¨åå°forkä¸€ä¸ªå­è¿›ç¨‹å®Œæˆå¤åˆ¶</p></blockquote><h4 id="è‡ªåŠ¨"><a href="#è‡ªåŠ¨" class="headerlink" title="è‡ªåŠ¨"></a>è‡ªåŠ¨</h4><p>æ ¹æ®REDISé…ç½®å®šæ—¶åŒæ­¥æ•°æ®åˆ°RDBæ–‡ä»¶</p><table><tr><th>é…ç½®</th><th>Seconds</th><th>Changes</th></tr><tr><td>save</td><td>900</td><td>1</td></tr><tr><td>save</td><td>300</td><td>10</td></tr><tr><td>save</td><td>60</td><td>10000</td></tr></table><blockquote><p>eg:60ç§’ä¸­æ”¹å˜äº†10000æ¬¡ä¼šå‘ç”Ÿå¤‡ä»½RDB</p></blockquote><h4 id="è§¦å‘æœºåˆ¶-ä¸å®¹å¿½ç•¥çš„æ–¹å¼"><a href="#è§¦å‘æœºåˆ¶-ä¸å®¹å¿½ç•¥çš„æ–¹å¼" class="headerlink" title="è§¦å‘æœºåˆ¶-ä¸å®¹å¿½ç•¥çš„æ–¹å¼"></a>è§¦å‘æœºåˆ¶-ä¸å®¹å¿½ç•¥çš„æ–¹å¼</h4><ul><li>å…¨é‡å¤åˆ¶</li><li>Debug Reload</li><li>shutdown</li></ul><h3 id="save-or-bgsave"><a href="#save-or-bgsave" class="headerlink" title="save or bgsave ?"></a>save or bgsave ?</h3><table><tr><th>å‘½ä»¤</th><th>save</th><th>bgsave</th></tr><tr><td>IOç±»å‹</td><td>åŒæ­¥</td><td>å¼‚æ­¥</td></tr><tr><td>é˜»å¡</td><td>æ˜¯</td><td>å‘ç”Ÿåœ¨forkæ—¶</td></tr><tr><td>å¤æ‚åº¦</td><td>O(N)</td><td>O(N)</td></tr><tr><td>ä¼˜ç‚¹</td><td>ä¸ä¼šæ¶ˆè€—å†…å­˜</td><td>ä¸é˜»å¡å®¢æˆ·ç«¯å‘½ä»¤</td></tr><tr><td>ç¼ºç‚¹</td><td>é˜»å¡å®¢æˆ·ç«¯å‘½ä»¤</td><td>æ¶ˆè€—å†…å­˜</td></tr></table> ### é…ç½®<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir ./</span><br><span class="line">stop-writes-on-bgsave-error yes //bgsaveå‡ºç°é—®é¢˜ä¼šåœæ­¢å†™å…¥</span><br><span class="line">rdbcompression yes  //å‹ç¼©æ¨¡å¼</span><br><span class="line">rdbchecksum yes //å¯¹RDBè¿›è¡Œæ ¡éªŒå’Œæ£€éªŒ</span><br></pre></td></tr></table></figure> #### æœ€ä½³é…ç½®<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dbfilename dump-$&#123;port&#125;.rdb</span><br><span class="line">dir bigdiskpath //é€‰æ‹©å¤§çš„ç¡¬ç›˜</span><br><span class="line">stop-writes-on-bgsave-error yes //bgsaveå‡ºç°é—®é¢˜ä¼šåœæ­¢å†™å…¥</span><br><span class="line">rdbcompression yes  //å‹ç¼©æ¨¡å¼</span><br><span class="line">rdbchecksum yes //å¯¹RDBè¿›è¡Œæ ¡éªŒå’Œæ£€éªŒ</span><br></pre></td></tr></table></figure><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul><li>RDBæ˜¯Rediså†…å­˜åˆ°ç¡¬ç›˜çš„å¿«ç…§ï¼Œç”¨äºæŒä¹…åŒ–</li><li>saveé€šå¸¸ä¼šé˜»å¡Redis</li><li>bgsaveä¸ä¼šé˜»å¡Redisï¼Œä½†æ˜¯ä¼šforkå­è¿›ç¨‹</li><li>saveè‡ªåŠ¨é…ç½®æ»¡è¶³å…¶ä¸€å°±ä¼šè¢«æ‰§è¡Œ</li><li>æœ‰äº›è§¦å‘æœºåˆ¶ä¸å®¹å¿½è§†</li></ul><h3 id="RDBé—®é¢˜"><a href="#RDBé—®é¢˜" class="headerlink" title="RDBé—®é¢˜"></a>RDBé—®é¢˜</h3><p><strong>è€—æ—¶è€—æ€§èƒ½</strong></p><blockquote><p>O(N)æ•°æ®è€—æ—¶<br><br>forkè€—å†…å­˜<br><br>Disk I&#x2F;O:IOæ€§èƒ½</p></blockquote><p><strong>ä¸å¯æ§ä¸¢å¤±æ•°æ®</strong></p><table><tr><th>æ—¶é—´æˆ³</th><th>save</th></tr><tr><td>T1</td><td>æ‰§è¡Œå¤šä¸ªå‘½ä»¤</td></tr><tr><td>T2</td><td>æ»¡è¶³RDBè‡ªåŠ¨åˆ›å»ºæ¡ä»¶</td></tr><tr><td>T3</td><td>å†æ¬¡æ‰§è¡Œå¤šæ¡å‘½ä»¤</td></tr><tr><td>T4</td><td>å®•æœº</td></tr></table><blockquote><p>å®•æœºä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±</p></blockquote><h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><h3 id="ä¸‰ç§ç­–ç•¥"><a href="#ä¸‰ç§ç­–ç•¥" class="headerlink" title="ä¸‰ç§ç­–ç•¥"></a>ä¸‰ç§ç­–ç•¥</h3><h4 id="everysec"><a href="#everysec" class="headerlink" title="everysec"></a>everysec</h4><p><img src="/img/in-post/2019-01-08/4.png"></p><h4 id="always"><a href="#always" class="headerlink" title="always"></a>always</h4><p>åŒeverysecæµç¨‹ï¼Œåªä¸è¿‡alwaysä¼šæŠŠæ¯æ¡å‘½ä»¤éƒ½å†™å…¥åˆ°AOFæ–‡ä»¶ä¸­</p><h4 id="no"><a href="#no" class="headerlink" title="no"></a>no</h4><p>ç”±æ“ä½œç³»ç»Ÿæ¥å†³å®šæ˜¯å¦åˆ·æ–°</p><h4 id="æ¯”è¾ƒ"><a href="#æ¯”è¾ƒ" class="headerlink" title="æ¯”è¾ƒ"></a>æ¯”è¾ƒ</h4><table><tr><th>å‘½ä»¤</th><th>always</th><th>everysec</th><th>no</th></tr><tr><td>ä¼˜ç‚¹</td><td>ä¸ä¸¢å¤±æ•°æ®</td><td>æ¯ç§’ä¸€æ¬¡fsyncä¸¢1ç§’æ•°æ®</td><td>ä¸ç”¨ç®¡ç†</td></tr><tr><td>ç¼ºç‚¹</td><td>IOå¼€é”€æ¯”è¾ƒå¤§</td><td>ä¸¢1ç§’æ•°æ®</td><td>ä¸å¯æ§</td></tr></table> ### AOFé‡å†™<h4 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h4><ul><li>å‡å°‘ç¡¬ç›˜å ç”¨é‡</li><li>åŠ å¿«å›å¤é€Ÿåº¦</li></ul><h3 id="é‡å†™ä¸¤ç§æ–¹å¼"><a href="#é‡å†™ä¸¤ç§æ–¹å¼" class="headerlink" title="é‡å†™ä¸¤ç§æ–¹å¼"></a>é‡å†™ä¸¤ç§æ–¹å¼</h3><h4 id="bgrewriteaof"><a href="#bgrewriteaof" class="headerlink" title="bgrewriteaof"></a>bgrewriteaof</h4><p><strong>å‘½ä»¤ï¼šbgrewriteaof</strong></p><p><img src="/img/in-post/2019-01-08/6.png"></p><p><strong>é‡å†™é…ç½®</strong></p><table><tr><th>é…ç½®å</th><th>å«ä¹‰</th></tr><tr><td>auto-aof-rewirte-min-size</td><td>auto-aof-rewirte-percentage</td></tr><tr><td>AOFæ–‡ä»¶é‡å†™å°ºå¯¸</td><td>AOFæ–‡ä»¶å¢é•¿ç‡</td></tr></table> **ç»Ÿè®¡**<table><tr><th>ç»Ÿè®¡å</th><th>å«ä¹‰</th></tr><tr><td>auto-current-size</td><td>auto-base-size</td></tr><tr><td>AOFå½“å‰å°ºå¯¸</td><td>AOFä¸Šæ¬¡å¯åŠ¨å’Œé‡å†™çš„å°ºå¯¸</td></tr></table> #### è‡ªåŠ¨è§¦å‘æ—¶æœº<ul><li>auto-current-size &gt; auto-aof-rewirte-min-size</li><li>(auto-current-size - auto-base-size) &#x2F; auto-base-size &gt; auto-aof-rewirte-percentage</li></ul><h3 id="AOFé‡å†™æµç¨‹"><a href="#AOFé‡å†™æµç¨‹" class="headerlink" title="AOFé‡å†™æµç¨‹"></a>AOFé‡å†™æµç¨‹</h3><p><img src="/img/in-post/2019-01-08/8.jpg"></p><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><ul><li>appendonly yes</li><li>appendfilename â€œappendonly-${port}.aofâ€</li><li>appendfsync everysec</li><li>dir &#x2F;bigdisk</li><li>no-appendfsync-on-rewrite no &#x2F;&#x2F;aofé‡å†™å¤±è´¥æ˜¯å¦å…è®¸ä¸¢å¤±æ•°æ®</li><li>auto-aof-rewrite-percentage 100 &#x2F;&#x2F;å¢é•¿ç‡</li><li>auto-aof-rewrite-min-size 64mb &#x2F;&#x2F;æœ€å°å°ºå¯¸</li></ul><h2 id="RDB-å’Œ-AOF-æŠ‰æ‹©"><a href="#RDB-å’Œ-AOF-æŠ‰æ‹©" class="headerlink" title="RDB å’Œ AOF æŠ‰æ‹©"></a>RDB å’Œ AOF æŠ‰æ‹©</h2><table><tr><th>å‘½ä»¤</th><th>RDB</th><th>AOF</th></tr><tr><td>å¯åŠ¨ä¼˜å…ˆçº§</td><td>ä½</td><td>é«˜</td></tr><tr><td>ä½“ç§¯</td><td>å°</td><td>å¤§</td></tr><tr><td>æ¢å¤é€Ÿåº¦</td><td>å¿«</td><td>æ…¢</td></tr><tr><td>æ•°æ®å®‰å…¨æ€§</td><td>ä¸¢æ•°æ®</td><td>æ ¹æ®ç­–ç•¥å†³å®š</td></tr><tr><td>è½»é‡</td><td>é‡</td><td>è½»</td></tr></table></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2020/01/25/2020-01-25-redis-cluster-out/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2020/01/25/2020-01-25-redis-cluster-out/" class="post-title-link" itemprop="url">Redis cluster æ•…éšœè½¬ç§»</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2020-01-25 21:30:00" itemprop="dateCreated datePublished" datetime="2020-01-25T21:30:00+08:00">2020-01-25</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="æ•…éšœå‘ç°"><a href="#æ•…éšœå‘ç°" class="headerlink" title="æ•…éšœå‘ç°"></a>æ•…éšœå‘ç°</h2><p>é€šè¿‡ping&#x2F;pongæ¶ˆæ¯å®ç°æ•…éšœå‘ç°ï¼Œä¸ä¾èµ–sentinel</p><h2 id="ä¸»è§‚ä¸‹çº¿"><a href="#ä¸»è§‚ä¸‹çº¿" class="headerlink" title="ä¸»è§‚ä¸‹çº¿"></a>ä¸»è§‚ä¸‹çº¿</h2><p>å®šä¹‰ï¼šæŸä¸ªèŠ‚ç‚¹è®¤ä¸ºå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨â€œåè§â€</p><p>ä¸»è§‚ä¸‹çº¿æµç¨‹ï¼š<br><img src="/img/in-post/2019-01-25/1.png"></p><h2 id="å®¢è§‚ä¸‹çº¿"><a href="#å®¢è§‚ä¸‹çº¿" class="headerlink" title="å®¢è§‚ä¸‹çº¿"></a>å®¢è§‚ä¸‹çº¿</h2><p>å®šä¹‰ï¼šå½“åŠæ•°ä»¥ä¸ŠæŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹éƒ½æ ‡è®°æŸèŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿</p><p>å®¢è§‚ä¸‹çº¿æµç¨‹ï¼š<br><img src="/img/in-post/2019-01-25/2.png"></p><h2 id="æ•…éšœæ¢å¤"><a href="#æ•…éšœæ¢å¤" class="headerlink" title="æ•…éšœæ¢å¤"></a>æ•…éšœæ¢å¤</h2><h3 id="èµ„æ ¼æ£€æŸ¥"><a href="#èµ„æ ¼æ£€æŸ¥" class="headerlink" title="èµ„æ ¼æ£€æŸ¥"></a>èµ„æ ¼æ£€æŸ¥</h3><ul><li>æ¯ä¸ªä»èŠ‚ç‚¹æ£€æŸ¥ä¸æ•…éšœèŠ‚ç‚¹çš„æ–­çº¿æ—¶é—´</li><li>è¶…è¿‡cluster-node-timeout*cluster-slave-validity-factorå–æ¶ˆèµ„æ ¼</li><li>cluster-slave-validity-factorï¼šé»˜è®¤ä¸º10</li></ul><h3 id="å‡†å¤‡é€‰ä¸¾æ—¶é—´"><a href="#å‡†å¤‡é€‰ä¸¾æ—¶é—´" class="headerlink" title="å‡†å¤‡é€‰ä¸¾æ—¶é—´"></a>å‡†å¤‡é€‰ä¸¾æ—¶é—´</h3><p><img src="/img/in-post/2019-01-25/3.png"></p><h3 id="é€‰ä¸¾æŠ•ç¥¨"><a href="#é€‰ä¸¾æŠ•ç¥¨" class="headerlink" title="é€‰ä¸¾æŠ•ç¥¨"></a>é€‰ä¸¾æŠ•ç¥¨</h3><p><img src="/img/in-post/2019-01-25/4.png"></p><h3 id="æ›¿æ¢ä¸»èŠ‚ç‚¹"><a href="#æ›¿æ¢ä¸»èŠ‚ç‚¹" class="headerlink" title="æ›¿æ¢ä¸»èŠ‚ç‚¹"></a>æ›¿æ¢ä¸»èŠ‚ç‚¹</h3><ul><li>å½“å‰ä»èŠ‚ç‚¹å¤åˆ¶å˜ä¸ºä¸»èŠ‚ç‚¹ã€‚(slaveof no one)</li><li>æ‰§è¡ŒclusterDelSlotæ’¤é”€æ•…éšœä¸»èŠ‚ç‚¹è´Ÿè´£çš„æ§½ï¼Œå¹¶æ‰§è¡ŒclusterAddSlot<br>æŠŠè¿™äº›æ§½åˆ†é…ç»™è‡ªå·±</li><li>å‘ç¾¤å¹¿æ’­è‡ªå·±çš„pongæ¶ˆæ¯ï¼Œè¡¨æ˜å·²æ›¿æ¢äº†æ•…éšœä»èŠ‚ç‚¹</li></ul><h2 id="redis-cluster-å¼€å‘å¸¸è§é—®é¢˜"><a href="#redis-cluster-å¼€å‘å¸¸è§é—®é¢˜" class="headerlink" title="redis cluster å¼€å‘å¸¸è§é—®é¢˜"></a>redis cluster å¼€å‘å¸¸è§é—®é¢˜</h2><h3 id="é›†ç¾¤å®Œæ•´æ€§"><a href="#é›†ç¾¤å®Œæ•´æ€§" class="headerlink" title="é›†ç¾¤å®Œæ•´æ€§"></a>é›†ç¾¤å®Œæ•´æ€§</h3><p><code>cluster-require-full-coverage</code>é»˜è®¤ä¸ºyes<br>é—®é¢˜ï¼š</p><ul><li>é›†ç¾¤ä¸­16384ä¸ªæ§½å…¨éƒ¨å¯ç”¨ï¼Œä¿è¯å®Œæ•´æ€§</li><li>èŠ‚ç‚¹æ•…éšœè½¬ç§»æˆ–æ­£åœ¨è½¬ç§»<br>å¤§å¤šæ•°ä¸šåŠ¡æ— æ³•å®¹å¿ï¼Œå»ºè®®è®¾ç½®ä¸ºno<blockquote><p>å½“å…¶ä¸­ä¸€å°æœºå™¨å‘ç”Ÿæ•…éšœï¼Œæ­¤æ—¶é›†ç¾¤çŠ¶æ€ä¸å¯ç”¨ï¼Œä¸å¯ä»¥set ket,ä¸å»ºè®®è®¾ç½®ä¸ºyes</p></blockquote></li></ul><h3 id="å®½å¸¦æ¶ˆè€—"><a href="#å®½å¸¦æ¶ˆè€—" class="headerlink" title="å®½å¸¦æ¶ˆè€—"></a>å®½å¸¦æ¶ˆè€—</h3><p>å®˜æ–¹å»ºè®®ï¼š1000ä¸ªèŠ‚ç‚¹</p><ul><li>æ¶ˆæ¯é¢‘ç‡ èŠ‚ç‚¹å‘ç°å’ŒèŠ‚ç‚¹æœ€åé€šä¿¡æ—¶é—´è¶…è¿‡cluster-node-timeout&#x2F;2æ—¶ä¼šå‘é€pingæ¶ˆæ¯</li><li>æ¶ˆæ¯æ•°æ®é‡ slotsæ•°æ®ç»„(2k)å’Œæ•´ä¸ªé›†ç¾¤1&#x2F;10çš„çŠ¶æ€æ•°æ®(10ä¸ªèŠ‚ç‚¹çŠ¶æ€æ•°æ®çº¦1k)</li><li>èŠ‚ç‚¹éƒ¨ç½²æœºå™¨è§„æ¨¡ åˆ†å¸ƒæœºå™¨è¶Šå¤šä¸”æ¯å°æœºå™¨åˆ’åˆ†çš„èŠ‚ç‚¹è¶Šå‡åŒ€ï¼Œæ•´ä½“çš„å¯ç”¨å¸¦å®½è¶Šé«˜<br>ä¾‹å­ï¼š200ä¸ªèŠ‚ç‚¹ï¼Œ20ä¸ªç‰©ç†æœºå™¨ï¼ˆæ¯å°10ä¸ªèŠ‚ç‚¹ï¼‰</li></ul><p>cluster-node-timeout&#x3D;15000 ping&#x2F;pongå¸¦å®½çº¦25MB</p><p>cluster-node-timeout&#x3D;20000 ping&#x2F;pongå¸¦ä½äº15MB</p><h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><ul><li>é¿å…å¤šä¸šåŠ¡ä½¿ç”¨å¤šé›†ç¾¤ï¼Œå¤§ä¸šåŠ¡å¯ä»¥å¤šé›†ç¾¤</li><li>cluster-node-timeout å¸¦å®½å’Œæ•…éšœè½¬ç§»é€Ÿåº¦çš„å‡è¡¡</li><li>å°½é‡å‡åŒ€åˆ†é…å¤šä¸ªæœºå™¨ï¼Œä¿è¯å¸¦å®½</li></ul><h3 id="PUB-x2F-SUBå¹¿æ’­"><a href="#PUB-x2F-SUBå¹¿æ’­" class="headerlink" title="PUB&#x2F;SUBå¹¿æ’­"></a>PUB&#x2F;SUBå¹¿æ’­</h3><p>é—®é¢˜ï¼špublishåœ¨é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹å¹¿æ’­ï¼šåŠ é‡å¸¦å®½<br>è§£å†³ï¼šå•ç‹¬èµ°ä¸€å¥—redis sentinel</p><h3 id="æ•°æ®å€¾æ–œ"><a href="#æ•°æ®å€¾æ–œ" class="headerlink" title="æ•°æ®å€¾æ–œ"></a>æ•°æ®å€¾æ–œ</h3><p><strong>æ•°æ®å€¾æ–œï¼šå†…å­˜ä¸å‡åŒ€</strong></p><p><strong>èŠ‚ç‚¹å’Œæ§½åˆ†é…ä¸å‡åŒ€</strong></p><p><strong>ä¸åŒæ§½å¯¹åº”é”®å€¼æ•°å·®å¼‚å¤§</strong></p><ul><li>å¯èƒ½å­˜åœ¨has_tag</li><li>cluster countkeysinslot {slot}è·å–æ§½å¯¹åº”é”®å€¼ä¸ªæ•°</li></ul><p><strong>åŒ…å«bigkey</strong></p><ul><li>ä¾‹å¦‚å¤§å­—ç¬¦ä¸²ï¼Œå‡ ç™¾ä¸‡å…ƒç´ çš„hash,setç­‰</li><li>ä»èŠ‚ç‚¹ï¼Œredis-cli â€“bigkeys</li><li>ä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œæ‹†åˆ†key</li></ul><p><strong>å†…å­˜ç›¸å…³é…ç½®ä¸ä¸€è‡´</strong></p><ul><li>hash-max-ziplist-value, set-max-intset-entriesç­‰</li></ul><p><strong>è¯·æ±‚å€¾æ–œï¼škeyçƒ­ç‚¹</strong>é‡è¦çš„keyæˆ–è€…bigkey<br>ä¼˜åŒ–ï¼š</p><ul><li>é¿å…big_key</li><li>çƒ­é”®ä¸è¦ä½¿ç”¨hash_tagï¼ˆé¿å…è½åœ¨ä¸€ä¸ªèŠ‚ç‚¹ï¼‰</li><li>å½“ä¸€è‡´æ€§ä¸é«˜æ—¶å¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜+MQ</li></ul><h3 id="è¯»å†™åˆ†ç¦»"><a href="#è¯»å†™åˆ†ç¦»" class="headerlink" title="è¯»å†™åˆ†ç¦»"></a>è¯»å†™åˆ†ç¦»</h3><p>åªè¯»è¿æ¥ï¼šé›†ç¾¤æ¨¡å¼çš„ä»èŠ‚ç‚¹ä¸æ¥å—ä»»ä½•è¯»å†™è¯·æ±‚</p><ul><li>é‡å®šå‘åˆ°è´Ÿè´£æ§½çš„ä¸»èŠ‚ç‚¹</li><li>readonlyå‘½ä»¤å¯ä»¥è¯»ï¼šè¿æ¥çº§çš„å‘½ä»¤<br>è¯»å†™åˆ†ç¦»ï¼šæ›´åŠ å¤æ‚</li><li>å¤åˆ¶å»¶è¿Ÿï¼Œä»èŠ‚ç‚¹æ•…éšœï¼Œè¯»å–è¿‡æœŸæ•°æ®</li><li>ä¿®æ”¹å®¢æˆ·ç«¯ï¼šcluster slaves {nodeid}</li></ul><h3 id="æ•°æ®è¿ç§»"><a href="#æ•°æ®è¿ç§»" class="headerlink" title="æ•°æ®è¿ç§»"></a>æ•°æ®è¿ç§»</h3><p>å®˜æ–¹å·¥å…·ï¼šredis-trib.rb import</p><ul><li>åªèƒ½ä»å•æœºè¿ç§»åˆ°é›†ç¾¤</li><li>ä¸æ”¯æŒåœ¨çº¿è¿ç§»ï¼Œsourceéœ€è¦åœå†™</li><li>ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ </li><li>å•çº¿ç¨‹è¿ç§»ï¼Œå½±å“é€Ÿåº¦<br>åœ¨çº¿è¿ç§»ï¼š</li></ul><p>å”¯å“ä¼šï¼šredis-migrate-tool</p><p>è±Œè±†èšï¼šredis-port</p><h3 id="é›†ç¾¤VSå•æœº"><a href="#é›†ç¾¤VSå•æœº" class="headerlink" title="é›†ç¾¤VSå•æœº"></a>é›†ç¾¤VSå•æœº</h3><p>é›†ç¾¤é™åˆ¶<br></p><ul><li>keyæ‰¹é‡æ“ä½œé™åˆ¶</li><li>keyäº‹ç‰©å’Œluaæ”¯æŒæœ‰é™ï¼Œæ“ä½œçš„keyå¿…é¡»åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹</li><li>keyæ˜¯æ•°æ®åˆ†åŒºçš„æœ€å°ç²’åº¦ï¼šä¸æ”¯æŒbigkeyåˆ†åŒº</li><li>ä¸æ”¯æŒå¤šä¸ªæ•°æ®åº“ï¼šé›†ç¾¤æ¨¡å¼ä¸‹åªæœ‰ä¸€ä¸ªdb0</li><li>å¤åˆ¶åªæ”¯æŒä¸€å±‚ï¼Œä¸æ”¯æŒæ ‘å½¢</li></ul><ol><li>Redis Cluster: æ»¡è¶³å®¹é‡å’Œæ€§èƒ½çš„æ‰©å±•æ€§ï¼šå¾ˆå¤šä¸šåŠ¡ä¸éœ€è¦</li><li>å¾ˆå¤šåœºæ™¯Redis Sentinelè¶³å¤Ÿå¥½</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"><a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a> <a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a></nav></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview"> ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">enpsl</p><div class="site-description" itemprop="description">my blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span></div><div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script></body></html>