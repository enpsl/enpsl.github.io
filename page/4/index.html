<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"enpsl.github.io",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="my blog"><meta property="og:type" content="website"><meta property="og:title" content="å½­è¯—äº®çš„åšå®¢"><meta property="og:url" content="https://enpsl.github.io/page/4/index.html"><meta property="og:site_name" content="å½­è¯—äº®çš„åšå®¢"><meta property="og:description" content="my blog"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="enpsl"><meta property="article:tag" content="å½­è¯—äº® psl pengshiliang blog"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://enpsl.github.io/page/4/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>å½­è¯—äº®çš„åšå®¢</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">å½­è¯—äº®çš„åšå®¢</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> é¦–é¡µ</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> å½’æ¡£</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/03/02/2021-03-02-vagrant/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/03/02/2021-03-02-vagrant/" class="post-title-link" itemprop="url">VagrantåŸºæœ¬å‘½ä»¤</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-02 21:30:00" itemprop="dateCreated datePublished" datetime="2021-03-02T21:30:00+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="vagrant-ä½¿ç”¨"><a href="#vagrant-ä½¿ç”¨" class="headerlink" title="vagrant ä½¿ç”¨"></a>vagrant ä½¿ç”¨</h2><h2 id="init-centos"><a href="#init-centos" class="headerlink" title="init centos"></a>init centos</h2><p>centos7 box ä¸‹è½½åœ°å€<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1kVlAz59">centos7</a></p><p><strong>æ·»åŠ vagrant boxåˆ°box list</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add centos7 Vagrant-CentOS-7.box</span><br></pre></td></tr></table></figure><p><strong>åˆå§‹åŒ–ä¸€ä¸ªè™šæ‹Ÿæœºä½¿ç”¨åˆšæ‰æ·»åŠ çš„vagrant box</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> centos</span><br><span class="line"><span class="built_in">cd</span> centos</span><br><span class="line">vim Vagrantfile</span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ ä¸‹é¢å†…å®¹åˆ°Vagrantfileä¸­</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line">Vagrant.require_version <span class="string">&quot;&gt;= 1.6.0&quot;</span></span><br><span class="line"></span><br><span class="line">boxes = [</span><br><span class="line">    &#123;</span><br><span class="line">        :name =&gt; <span class="string">&quot;docker-node1&quot;</span>,</span><br><span class="line">        :eth1 =&gt; <span class="string">&quot;192.168.205.10&quot;</span>,</span><br><span class="line">        :mem =&gt; <span class="string">&quot;1024&quot;</span>,</span><br><span class="line">        :cpu =&gt; <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        :name =&gt; <span class="string">&quot;docker-node2&quot;</span>,</span><br><span class="line">        :eth1 =&gt; <span class="string">&quot;192.168.205.11&quot;</span>,</span><br><span class="line">        :mem =&gt; <span class="string">&quot;1024&quot;</span>,</span><br><span class="line">        :cpu =&gt; <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Vagrant.configure(2) <span class="keyword">do</span> |config|</span><br><span class="line"></span><br><span class="line">  config.vm.box = <span class="string">&quot;centos7&quot;</span></span><br><span class="line"></span><br><span class="line">  boxes.each <span class="keyword">do</span> |opts|</span><br><span class="line">      config.vm.define opts[:name] <span class="keyword">do</span> |config|</span><br><span class="line">        config.vm.hostname = opts[:name]</span><br><span class="line">        config.vm.provider <span class="string">&quot;vmware_fusion&quot;</span> <span class="keyword">do</span> |v|</span><br><span class="line">          v.vmx[<span class="string">&quot;memsize&quot;</span>] = opts[:mem]</span><br><span class="line">          v.vmx[<span class="string">&quot;numvcpus&quot;</span>] = opts[:cpu]</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        config.vm.provider <span class="string">&quot;virtualbox&quot;</span> <span class="keyword">do</span> |v|</span><br><span class="line">          v.customize [<span class="string">&quot;modifyvm&quot;</span>, :<span class="built_in">id</span>, <span class="string">&quot;--memory&quot;</span>, opts[:mem]]</span><br><span class="line">          v.customize [<span class="string">&quot;modifyvm&quot;</span>, :<span class="built_in">id</span>, <span class="string">&quot;--cpus&quot;</span>, opts[:cpu]]</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        config.vm.network :private_network, ip: opts[:eth1]</span><br><span class="line">      end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  config.vm.provision <span class="string">&quot;shell&quot;</span>, privileged: <span class="literal">true</span>, path: <span class="string">&quot;./setup.sh&quot;</span></span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>install dockerçš„setup.shæ–‡ä»¶</strong></p><p>åœ¨å½“å‰ç›®å½•åˆ›å»ºsetup.shæ–‡ä»¶å¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install some tools</span></span><br><span class="line">sudo yum install -y git vim gcc glibc-static telnet bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># install docker</span></span><br><span class="line">curl -fsSL get.docker.com -o get-docker.sh</span><br><span class="line">sh get-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># start docker service</span></span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker vagrant</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf get-docker.sh</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant up</span><br></pre></td></tr></table></figure><h2 id="vagrant-æŠ¥unknown-filesystem-type-â€˜vboxsfâ€™-è§£å†³æ–¹æ¡ˆ"><a href="#vagrant-æŠ¥unknown-filesystem-type-â€˜vboxsfâ€™-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="vagrant æŠ¥unknown filesystem type â€˜vboxsfâ€™ è§£å†³æ–¹æ¡ˆ"></a>vagrant æŠ¥unknown filesystem type â€˜vboxsfâ€™ è§£å†³æ–¹æ¡ˆ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vagrant plugin install vagrant-vbguest</span><br><span class="line">vagrant destroy &amp;&amp; vagrant up</span><br></pre></td></tr></table></figure><h2 id="init-ubuntu"><a href="#init-ubuntu" class="headerlink" title="init ubuntu"></a>init ubuntu</h2><p>ä½¿ç”¨<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/">æ¸…åæº</a></p><p><strong>ubuntu18çš„boxï¼Œç»ˆç«¯è¿è¡Œå¦‚ä¸‹å‘½ä»¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add \</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/bionic-server-cloudimg-amd64-vagrant.box \</span><br><span class="line">--name ubuntu/bionic</span><br></pre></td></tr></table></figure><p>Vagrantfileè¿™æ ·å†™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">config.vm.box = <span class="string">&quot;ubuntu/bionic&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ¥ç€å°±æ˜¯<code>vagrant up &amp;&amp; vagrant ssh</code>äº†</p><h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><h3 id="åˆ—å‡ºæ‰€æœ‰Box"><a href="#åˆ—å‡ºæ‰€æœ‰Box" class="headerlink" title="åˆ—å‡ºæ‰€æœ‰Box"></a>åˆ—å‡ºæ‰€æœ‰Box</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box list</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ ä¸€ä¸ªBox"><a href="#æ·»åŠ ä¸€ä¸ªBox" class="headerlink" title="æ·»åŠ ä¸€ä¸ªBox"></a>æ·»åŠ ä¸€ä¸ªBox</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add [options] &lt;name, url, or path</span><br></pre></td></tr></table></figure><h3 id="å¯ä»¥ä»https-app-vagrantup-com-boxes-searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶"><a href="#å¯ä»¥ä»https-app-vagrantup-com-boxes-searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶" class="headerlink" title="å¯ä»¥ä»https://app.vagrantup.com/boxes/searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶"></a>å¯ä»¥ä»<a target="_blank" rel="noopener" href="https://app.vagrantup.com/boxes/search%E4%B8%8B%E8%BD%BD%E5%90%84%E7%A7%8DVagrant%E6%98%A0%E5%83%8F%E6%96%87%E4%BB%B6">https://app.vagrantup.com/boxes/searchä¸‹è½½å„ç§Vagrantæ˜ åƒæ–‡ä»¶</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add ubuntu/trusty64</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box"><a href="#é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box" class="headerlink" title="é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box"></a>é€šè¿‡æŒ‡å®šçš„URLæ·»åŠ è¿œç¨‹box</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add https://atlas.hashicorp.com/ubuntu/boxes/trusty64</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ ä¸€ä¸ªæœ¬åœ°box"><a href="#æ·»åŠ ä¸€ä¸ªæœ¬åœ°box" class="headerlink" title="æ·»åŠ ä¸€ä¸ªæœ¬åœ°box"></a>æ·»åŠ ä¸€ä¸ªæœ¬åœ°box</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box add &#123;box_name&#125; &#123;file_path&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM"><a href="#åˆå§‹åŒ–ä¸€ä¸ªæ–°VM" class="headerlink" title="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM"></a>åˆå§‹åŒ–ä¸€ä¸ªæ–°VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant init ubuntu/trustry64</span><br></pre></td></tr></table></figure><p>æ­¤å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ªåä¸ºVagrantfileçš„é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure(<span class="string">&quot;2&quot;</span>) <span class="keyword">do</span> |config|</span><br><span class="line">  config.vm.box = <span class="string">&quot;ubuntu/trusty64&quot;</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM-1"><a href="#åˆå§‹åŒ–ä¸€ä¸ªæ–°VM-1" class="headerlink" title="åˆå§‹åŒ–ä¸€ä¸ªæ–°VM"></a>åˆå§‹åŒ–ä¸€ä¸ªæ–°VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant up</span><br></pre></td></tr></table></figure><h3 id="å¯ç”¨SSHç™»é™†VM"><a href="#å¯ç”¨SSHç™»é™†VM" class="headerlink" title="å¯ç”¨SSHç™»é™†VM"></a>å¯ç”¨SSHç™»é™†VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh &lt;node_name&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦ä»è™šæ‹Ÿæœºä¸­é€€å‡ºï¼Œç›´æ¥åœ¨è™šæ‹Ÿæœºä¸­çš„å‘½ä»¤è¡Œè¾“å…¥exitå‘½ä»¤å³å¯</p><h3 id="æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€"><a href="#æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€"></a>æŸ¥çœ‹VMå½“å‰çš„çŠ¶æ€</h3><p>è¿›å…¥Vagrantfileé…ç½®æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant status</span><br></pre></td></tr></table></figure><h3 id="å…³é—­VM"><a href="#å…³é—­VM" class="headerlink" title="å…³é—­VM"></a>å…³é—­VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant halt</span><br></pre></td></tr></table></figure><h3 id="é”€æ¯VM"><a href="#é”€æ¯VM" class="headerlink" title="é”€æ¯VM"></a>é”€æ¯VM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant destory [name|<span class="built_in">id</span>]</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/03/02/2021-03-02-dockerfile/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/03/02/2021-03-02-dockerfile/" class="post-title-link" itemprop="url">Dockerfile è¯­æ³•æ¢³ç†</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-02 13:30:00" itemprop="dateCreated datePublished" datetime="2021-03-02T13:30:00+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="Dockerfileè¯­æ³•æ¢³ç†"><a href="#Dockerfileè¯­æ³•æ¢³ç†" class="headerlink" title="Dockerfileè¯­æ³•æ¢³ç†"></a>Dockerfileè¯­æ³•æ¢³ç†</h2><h3 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h3><p>from åé¢æ¥base image</p><p>eg:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br></pre></td></tr></table></figure><blockquote><p>å°½é‡ä½¿ç”¨å®˜æ–¹çš„image ä½œä¸ºbase image</p></blockquote><h3 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a>LABEL</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;username@gmail.com&quot;</span> </span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0&quot;</span> </span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> description=<span class="string">&quot;this is description&quot;</span> </span></span><br></pre></td></tr></table></figure><blockquote><p>MetaData ä¸å¯å°‘</p></blockquote><h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><p>æ‰§è¡Œå‘½ä»¤å¹¶åˆ›å»ºæ–°çš„IMAGE LAYER</p><p>ä¸ºäº†ç¾è§‚ï¼Œå¤æ‚çš„RUNç”¨åæ–œæ æ¢è¡Œï¼Œé¿å…æ— ç”¨åˆ†å±‚ï¼Œåˆå¹¶å¤šæ¡å‘½ä»¤æˆä¸€è¡Œã€‚</p><h4 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update &amp;&amp; yum install -y vim \</span></span><br><span class="line"><span class="language-bash">python-dev</span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y perl \</span></span><br><span class="line"><span class="language-bash">pwgen --no-install-recommends &amp;&amp; <span class="built_in">rm</span> -rf \</span></span><br><span class="line"><span class="language-bash">/var/lib/apt/lists/*     <span class="comment">#æ¸…ç†cache</span></span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> /bin/bash -c <span class="string">&#x27;source $HOME/.bashrc;echo #HOME&#x27;</span></span></span><br></pre></td></tr></table></figure><h3 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="built_in">test</span>       <span class="comment"># å¦‚æœæ²¡æœ‰ä¼šè‡ªåŠ¨åˆ›å»ºtestæ–‡ä»¶å¤¹</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> demo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">pwd</span>            <span class="comment"># æ‰“å°/test/demo</span></span></span><br></pre></td></tr></table></figure><blockquote><p>å°½é‡ä½¿ç”¨WORKDIR,ä¸è¦ä½¿ç”¨RUN cd,å°½é‡ä½¿ç”¨ç»å¯¹è·¯å¾„</p></blockquote><h3 id="ADD-and-COPY"><a href="#ADD-and-COPY" class="headerlink" title="ADD and COPY"></a>ADD and COPY</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello /</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> test.tar.gz / <span class="comment"># æ·»åŠ åˆ°æ ¹ç›®å½•å¹¶è§£å‹ç¼©</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello <span class="built_in">test</span> /    <span class="comment"># /root/test/hello</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hello <span class="built_in">test</span> /</span></span><br></pre></td></tr></table></figure><blockquote><p>å¤§éƒ¨åˆ†æƒ…å†µCOPYä¼˜äºï¼ŒADDæœ‰é¢å¤–çš„è§£å‹åŠŸèƒ½ï¼Œæ·»åŠ è¿œç¨‹æ–‡ä»¶æˆ–ç›®å½•ç”¨curlæˆ–wget</p></blockquote><h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> MYSQL_VERSION <span class="number">5.6</span> <span class="comment">#å¸¸é‡</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y mysql-server= <span class="string">&quot;<span class="variable">$&#123;MYSQL_VERSION&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure><h3 id="CMD-amp-ENTRYPOINT"><a href="#CMD-amp-ENTRYPOINT" class="headerlink" title="CMD &amp; ENTRYPOINT"></a>CMD &amp; ENTRYPOINT</h3><p>CMD:è®¾ç½®å®¹å™¨å¯åŠ¨åé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°<br>å¦‚æœdocker runæŒ‡å®šäº†å…¶å®ƒçš„å‘½ä»¤ï¼Œåˆ™å¿½ç•¥CMDå‘½ä»¤<br>å®šä¹‰å¤šä¸ªCMD,åªæœ‰æœ€åä¸€ä¸ªä¼šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run &lt;image&gt;</span><br><span class="line">docker run -it &lt;image&gt; /bin/bash    //æ­¤å‘½ä»¤ä¼šå¿½ç•¥CMDä¸­çš„å‘½ä»¤</span><br></pre></td></tr></table></figure><p>ENTRYPOINT:è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤<br>è®©å®¹å™¨å·²åº”ç”¨ç¨‹åºæˆ–è€…æœåŠ¡çš„æ–¹å¼æ‰§è¡Œ<br>ä¸ä¼šè¢«å¿½ç•¥ï¼Œä¸€å®šä¼šæ‰§è¡Œ</p><h4 id="SHELL-amp-EXEC"><a href="#SHELL-amp-EXEC" class="headerlink" title="SHELL &amp; EXEC"></a>SHELL &amp; EXEC</h4><p>SHELL:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y vim</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello docker&quot;</span></span></span><br></pre></td></tr></table></figure><p>EXEC:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;apt-get&quot;</span>, <span class="string">&quot;install&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;vim&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;hello docker&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>EXECæ–¹å¼éœ€è¦æŒ‡æ˜è¿è¡Œç¯å¢ƒï¼Œeg:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">ENV</span> name word</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;echo hello <span class="variable">$name</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ›´å¤šè¯¦è§<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">æ‰©å±•é˜…è¯»</a></p><h2 id="Dockerfileå®æˆ˜"><a href="#Dockerfileå®æˆ˜" class="headerlink" title="Dockerfileå®æˆ˜"></a>Dockerfileå®æˆ˜</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> flask-hello-word</span><br><span class="line"><span class="built_in">cd</span> flask-hello-word</span><br><span class="line">vim app.py</span><br></pre></td></tr></table></figure><p>app.pyå†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello docker&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>ç¼–å†™Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">2.7</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;peng.shiliang&lt;1390509500@qq.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install flask</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.py /app/       <span class="comment"># appåé¢å¿…é¡»æ¥/ï¼Œå¦åˆ™ä¼šå½“ä½œæ–‡ä»¶</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span>             <span class="comment"># ç«¯å£æ˜ å°„,ä¿è¯è¿œç¨‹èƒ½å¤Ÿè®¿é—®</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t pengshiliang/flask-hello-word .</span><br><span class="line">docker push pengshiliang/flask-hello-word:latest</span><br></pre></td></tr></table></figure><p>è¿è¡Œflask-hello-word</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=demo pengshiliang/flask-hello-word     //--name ä¾¿äºdocker container æ“ä½œ</span><br><span class="line">docker <span class="built_in">exec</span> -it demo ip a       //æŸ¥çœ‹dockerå®¹å™¨ip</span><br><span class="line">curl &lt;demo ip&gt;      //è¾“å‡ºhello docker</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/03/02/2021-03-02-docker/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/03/02/2021-03-02-docker/" class="post-title-link" itemprop="url">Dockerå…¥é—¨</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-02 10:30:00" itemprop="dateCreated datePublished" datetime="2021-03-02T10:30:00+08:00">2021-03-02</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="èµ‹äºˆdockeræƒé™"><a href="#èµ‹äºˆdockeræƒé™" class="headerlink" title="èµ‹äºˆdockeræƒé™"></a>èµ‹äºˆdockeræƒé™</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vagrant@ubuntu-bionic:~$ sudo groupadd docker</span><br><span class="line">groupadd: group <span class="string">&#x27;docker&#x27;</span> already exists</span><br><span class="line">vagrant@ubuntu-bionic:~$ sudo gpasswd -a vagrant docker</span><br><span class="line">Adding user vagrant to group docker</span><br><span class="line">vagrant@ubuntu-bionic:~$ sudo service docker restart</span><br></pre></td></tr></table></figure><p>é€€å‡ºvagrantåœ¨é‡æ–°è¿›å…¥</p><h2 id="dockeråŸºæœ¬å‘½ä»¤"><a href="#dockeråŸºæœ¬å‘½ä»¤" class="headerlink" title="dockeråŸºæœ¬å‘½ä»¤"></a>dockeråŸºæœ¬å‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// åˆ—ä¸¾æ‰€æœ‰é•œåƒ</span><br><span class="line">docker image <span class="built_in">ls</span></span><br><span class="line">// æŸ¥çœ‹image build å†å²</span><br><span class="line">docker <span class="built_in">history</span> &lt;image <span class="built_in">id</span>&gt;</span><br><span class="line">// è¿è¡Œä¸€ä¸ªimage</span><br><span class="line">docker run &lt;image <span class="built_in">id</span>&gt;</span><br><span class="line">// åˆ—ä¸¾æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span><br><span class="line">docker container <span class="built_in">ls</span></span><br><span class="line">// åˆ—ä¸¾æ‰€æœ‰çš„å®¹å™¨</span><br><span class="line">docker container <span class="built_in">ls</span> -a</span><br><span class="line">// äº¤äº’å¼è¿è¡Œè¿è¡Œï¼ˆå¸¸é©»è¿è¡Œï¼‰</span><br><span class="line">docker run -it &lt;image&gt;</span><br></pre></td></tr></table></figure><h2 id="docker-image-å‘½ä»¤"><a href="#docker-image-å‘½ä»¤" class="headerlink" title="docker image å‘½ä»¤"></a>docker image å‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker images   (docker image <span class="built_in">ls</span>ç¼©å†™)</span><br><span class="line">docker rmi &lt;image <span class="built_in">id</span>&gt;   (docker image <span class="built_in">rm</span> &lt;image <span class="built_in">id</span>&gt;ç¼©å†™)//ç§»é™¤ä¸€ä¸ªé•œåƒ</span><br></pre></td></tr></table></figure><h2 id="docker-containerå‘½ä»¤"><a href="#docker-containerå‘½ä»¤" class="headerlink" title="docker containerå‘½ä»¤"></a>docker containerå‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a    (docker container <span class="built_in">ls</span> -aç¼©å†™)</span><br><span class="line">docker <span class="built_in">rm</span> &lt;image <span class="built_in">id</span>&gt;    (docker container <span class="built_in">rm</span> &lt;image <span class="built_in">id</span>&gt;ç¼©å†™)  //åˆ é™¤ä¸€ä¸ªå®¹å™¨</span><br><span class="line">docker ps -aq   //åˆ—ä¸¾æ‰€æœ‰å®¹å™¨<span class="built_in">id</span></span><br><span class="line">docker ps -f <span class="string">&quot;status=exited&quot;</span> -q     //åˆ—ä¸¾æ‰€æœ‰å·²é€€å‡ºçš„å®¹å™¨</span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -aq)</span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -f <span class="string">&quot;status=exited&quot;</span> -q)</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-02/3.png" alt="avatar"><br><img src="/img/in-post/2019-03-02/4.png" alt="avatar"></p><h2 id="buildä¸€ä¸ªhello-word-image"><a href="#buildä¸€ä¸ªhello-word-image" class="headerlink" title="buildä¸€ä¸ªhello word image"></a>buildä¸€ä¸ªhello word image</h2><h3 id="ç”Ÿæˆhello-wordç¨‹åº"><a href="#ç”Ÿæˆhello-wordç¨‹åº" class="headerlink" title="ç”Ÿæˆhello-wordç¨‹åº"></a>ç”Ÿæˆhello-wordç¨‹åº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> hello-word</span><br><span class="line"><span class="built_in">cd</span> hello-word</span><br><span class="line">vim hello.c</span><br></pre></td></tr></table></figure><p>hello.cå†…å®¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello word\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gcc</span><br><span class="line">sudo apt-get install build-essential</span><br><span class="line">gcc -static hello.c -o hello</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-02/1.png" alt="avatar"></p><h3 id="ç¼–å†™Dockerfile"><a href="#ç¼–å†™Dockerfile" class="headerlink" title="ç¼–å†™Dockerfile"></a>ç¼–å†™Dockerfile</h3><p>æ‰§è¡Œ<code>vim Dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/hello&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="buildå‘½ä»¤"><a href="#buildå‘½ä»¤" class="headerlink" title="buildå‘½ä»¤"></a>buildå‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t &lt;tag&gt; &lt;<span class="built_in">dir</span>&gt;</span><br></pre></td></tr></table></figure><p>eg:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t pengshiliang/hello-word .</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-02/2.png" alt="avatar"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run pengshiliang/hello-word</span><br></pre></td></tr></table></figure><p>å‡ºç°hello word å³ä¸ºæ­£å¸¸build</p><h2 id="å‘å¸ƒ"><a href="#å‘å¸ƒ" class="headerlink" title="å‘å¸ƒ"></a>å‘å¸ƒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push pengshiliang/hello-word:latest</span><br></pre></td></tr></table></figure><h2 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h2><ol><li>é€šè¿‡imageåˆ›å»º</li><li>åœ¨Image layerä¹‹ä¸Šå»ºç«‹ä¸€ä¸ªCotainer layer</li><li>ç±»é¢å‘å¯¹è±¡ï¼šç±»å’Œå®ä¾‹</li><li>imageå¤åˆ¶å­˜å‚¨å’Œåˆ†å‘ï¼Œcontainerè´Ÿè´£è¿è¡Œapp</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/17/2021-02-17-CAP&BASE/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/17/2021-02-17-CAP&BASE/" class="post-title-link" itemprop="url">CAP&BASEç†è®º</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-17 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-17T19:30:00+08:00">2021-02-17</time></span></div></header><div class="post-body" itemprop="articleBody"><p>ç»å†è¿‡æŠ€æœ¯é¢è¯•çš„å°ä¼™ä¼´æƒ³å¿…å¯¹ CAP &amp; BASE è¿™ä¸ªä¸¤ä¸ªç†è®ºå·²ç»å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼</p><p>æˆ‘å½“å¹´å‚åŠ é¢è¯•çš„æ—¶å€™ï¼Œä¸å¤¸å¼ åœ°è¯´ï¼Œåªè¦é—®åˆ°åˆ†å¸ƒå¼ç›¸å…³çš„å†…å®¹ï¼Œé¢è¯•å®˜å‡ ä¹æ˜¯å¿…å®šä¼šé—®è¿™ä¸¤ä¸ªåˆ†å¸ƒå¼ç›¸å…³çš„ç†è®ºã€‚ä¸€æ˜¯å› ä¸ºè¿™ä¸¤ä¸ªåˆ†å¸ƒå¼åŸºç¡€ç†è®ºæ˜¯å­¦ä¹ åˆ†å¸ƒå¼çŸ¥è¯†çš„å¿…å¤‡å‰ç½®åŸºç¡€ï¼ŒäºŒæ˜¯å› ä¸ºå¾ˆå¤šé¢è¯•å®˜è‡ªå·±æ¯”è¾ƒç†Ÿæ‚‰è¿™ä¸¤ä¸ªç†è®ºï¼ˆæ–¹ä¾¿æé—®ï¼‰ã€‚</p><p>æˆ‘ä»¬éå¸¸æœ‰å¿…è¦å°†è¿™ä¸¤ä¸ªç†è®ºææ‡‚ï¼Œå¹¶ä¸”èƒ½å¤Ÿç”¨è‡ªå·±çš„ç†è§£ç»™åˆ«äººè®²å‡ºæ¥ã€‚</p><h2 id="CAP-ç†è®º"><a href="#CAP-ç†è®º" class="headerlink" title="# CAP ç†è®º"></a><a href="#cap-%E7%90%86%E8%AE%BA">#</a> CAP ç†è®º</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86">CAP ç†è®º&#x2F;å®šç†open in new window</a>èµ·æºäº 2000 å¹´ï¼Œç”±åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„ Eric Brewer æ•™æˆåœ¨åˆ†å¸ƒå¼è®¡ç®—åŸç†ç ”è®¨ä¼šï¼ˆPODCï¼‰ä¸Šæå‡ºï¼Œå› æ­¤ CAP å®šç†åˆè¢«ç§°ä½œ <strong>å¸ƒé²å°”å®šç†ï¼ˆBrewerâ€™s theoremï¼‰</strong></p><p>2 å¹´åï¼Œéº»çœç†å·¥å­¦é™¢çš„ Seth Gilbert å’Œ Nancy Lynch å‘è¡¨äº†å¸ƒé²å°”çŒœæƒ³çš„è¯æ˜ï¼ŒCAP ç†è®ºæ­£å¼æˆä¸ºåˆ†å¸ƒå¼é¢†åŸŸçš„å®šç†ã€‚</p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="# ç®€ä»‹"></a><a href="#%E7%AE%80%E4%BB%8B">#</a> ç®€ä»‹</h3><p><strong>CAP</strong> ä¹Ÿå°±æ˜¯ <strong>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰</strong>ã€<strong>Availabilityï¼ˆå¯ç”¨æ€§ï¼‰</strong>ã€<strong>Partition Toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰</strong> è¿™ä¸‰ä¸ªå•è¯é¦–å­—æ¯ç»„åˆã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-11/cap.png" alt="img"></p><p>CAP ç†è®ºçš„æå‡ºè€…å¸ƒé²å°”åœ¨æå‡º CAP çŒœæƒ³çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰è¯¦ç»†å®šä¹‰ <strong>Consistency</strong>ã€<strong>Availability</strong>ã€<strong>Partition Tolerance</strong> ä¸‰ä¸ªå•è¯çš„æ˜ç¡®å®šä¹‰ã€‚</p><p>å› æ­¤ï¼Œå¯¹äº CAP çš„æ°‘é—´è§£è¯»æœ‰å¾ˆå¤šï¼Œä¸€èˆ¬æ¯”è¾ƒè¢«å¤§å®¶æ¨èçš„æ˜¯ä¸‹é¢ ğŸ‘‡ è¿™ç§ç‰ˆæœ¬çš„è§£è¯»ã€‚</p><p>åœ¨ç†è®ºè®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒCAP å®šç†ï¼ˆCAP theoremï¼‰æŒ‡å‡ºå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œå½“è®¾è®¡è¯»å†™æ“ä½œæ—¶ï¼Œåªèƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç‚¹ä¸­çš„ä¸¤ä¸ªï¼š</p><ul><li><strong>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</strong> : æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬</li><li><strong>å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰</strong>: éæ•…éšœçš„èŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†çš„å“åº”ï¼ˆä¸æ˜¯é”™è¯¯æˆ–è€…è¶…æ—¶çš„å“åº”ï¼‰ã€‚</li><li><strong>åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition Toleranceï¼‰</strong> : åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œä»ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚</li></ul><p><strong>ä»€ä¹ˆæ˜¯ç½‘ç»œåˆ†åŒºï¼Ÿ</strong></p><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹å‰çš„ç½‘ç»œæœ¬æ¥æ˜¯è¿é€šçš„ï¼Œä½†æ˜¯å› ä¸ºæŸäº›æ•…éšœï¼ˆæ¯”å¦‚éƒ¨åˆ†èŠ‚ç‚¹ç½‘ç»œå‡ºäº†é—®é¢˜ï¼‰æŸäº›èŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šäº†ï¼Œæ•´ä¸ªç½‘ç»œå°±åˆ†æˆäº†å‡ å—åŒºåŸŸï¼Œè¿™å°±å« <strong>ç½‘ç»œåˆ†åŒº</strong>ã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-11/partition-tolerance.png" alt="partition-tolerance"></p><h3 id="ä¸æ˜¯æ‰€è°“çš„â€œ3-é€‰-2â€"><a href="#ä¸æ˜¯æ‰€è°“çš„â€œ3-é€‰-2â€" class="headerlink" title="# ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€"></a><a href="#%E4%B8%8D%E6%98%AF%E6%89%80%E8%B0%93%E7%9A%84-3-%E9%80%89-2">#</a> ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€</h3><p>å¤§éƒ¨åˆ†äººè§£é‡Šè¿™ä¸€å®šå¾‹æ—¶ï¼Œå¸¸å¸¸ç®€å•çš„è¡¨è¿°ä¸ºï¼šâ€œä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹å¿æ€§ä¸‰è€…ä½ åªèƒ½åŒæ—¶è¾¾åˆ°å…¶ä¸­ä¸¤ä¸ªï¼Œä¸å¯èƒ½åŒæ—¶è¾¾åˆ°â€ã€‚å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªéå¸¸å…·æœ‰è¯¯å¯¼æ€§è´¨çš„è¯´æ³•ï¼Œè€Œä¸”åœ¨ CAP ç†è®ºè¯ç”Ÿ 12 å¹´ä¹‹åï¼ŒCAP ä¹‹çˆ¶ä¹Ÿåœ¨ 2012 å¹´é‡å†™äº†ä¹‹å‰çš„è®ºæ–‡ã€‚</p><blockquote><p><strong>å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­æœåŠ¡ï¼Œé‚£ä¹ˆå¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§åªèƒ½ 2 é€‰ 1ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç½‘ç»œåˆ†åŒºä¹‹å P æ˜¯å‰æï¼Œå†³å®šäº† P ä¹‹åæ‰æœ‰ C å’Œ A çš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰æˆ‘ä»¬æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚</strong></p><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯ï¼šCAP ç†è®ºä¸­åˆ†åŒºå®¹é”™æ€§ P æ˜¯ä¸€å®šè¦æ»¡è¶³çš„ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œåªèƒ½æ»¡è¶³å¯ç”¨æ€§ A æˆ–è€…ä¸€è‡´æ€§ Cã€‚</p></blockquote><p>å› æ­¤ï¼Œ<strong>åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸Šä¸å¯èƒ½é€‰æ‹© CA æ¶æ„ï¼Œåªèƒ½é€‰æ‹© CP æˆ–è€… AP æ¶æ„ã€‚</strong> æ¯”å¦‚ ZooKeeperã€HBase å°±æ˜¯ CP æ¶æ„ï¼ŒCassandraã€Eureka å°±æ˜¯ AP æ¶æ„ï¼ŒNacos ä¸ä»…æ”¯æŒ CP æ¶æ„ä¹Ÿæ”¯æŒ AP æ¶æ„ã€‚</p><p><strong>ä¸ºå•¥ä¸å¯èƒ½é€‰æ‹© CA æ¶æ„å‘¢ï¼Ÿ</strong> ä¸¾ä¸ªä¾‹å­ï¼šè‹¥ç³»ç»Ÿå‡ºç°â€œåˆ†åŒºâ€ï¼Œç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹åœ¨è¿›è¡Œå†™æ“ä½œã€‚ä¸ºäº†ä¿è¯ Cï¼Œ å¿…é¡»è¦ç¦æ­¢å…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œï¼Œè¿™å°±å’Œ A å‘ç”Ÿå†²çªäº†ã€‚å¦‚æœä¸ºäº†ä¿è¯ Aï¼Œå…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œæ­£å¸¸çš„è¯ï¼Œé‚£å°±å’Œ C å‘ç”Ÿå†²çªäº†ã€‚</p><p><strong>é€‰æ‹© CP è¿˜æ˜¯ AP çš„å…³é”®åœ¨äºå½“å‰çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ²¡æœ‰å®šè®ºï¼Œæ¯”å¦‚å¯¹äºéœ€è¦ç¡®ä¿å¼ºä¸€è‡´æ€§çš„åœºæ™¯å¦‚é“¶è¡Œä¸€èˆ¬ä¼šé€‰æ‹©ä¿è¯ CP ã€‚</strong></p><p>å¦å¤–ï¼Œéœ€è¦è¡¥å……è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼š <strong>å¦‚æœç½‘ç»œåˆ†åŒºæ­£å¸¸çš„è¯ï¼ˆç³»ç»Ÿåœ¨ç»å¤§éƒ¨åˆ†æ—¶å€™æ‰€å¤„çš„çŠ¶æ€ï¼‰ï¼Œä¹Ÿå°±è¯´ä¸éœ€è¦ä¿è¯ P çš„æ—¶å€™ï¼ŒC å’Œ A èƒ½å¤ŸåŒæ—¶ä¿è¯ã€‚</strong></p><h3 id="CAP-å®é™…åº”ç”¨æ¡ˆä¾‹"><a href="#CAP-å®é™…åº”ç”¨æ¡ˆä¾‹" class="headerlink" title="# CAP å®é™…åº”ç”¨æ¡ˆä¾‹"></a><a href="#cap-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B">#</a> CAP å®é™…åº”ç”¨æ¡ˆä¾‹</h3><p>æˆ‘è¿™é‡Œä»¥æ³¨å†Œä¸­å¿ƒæ¥æ¢è®¨ä¸€ä¸‹ CAP çš„å®é™…åº”ç”¨ã€‚è€ƒè™‘åˆ°å¾ˆå¤šå°ä¼™ä¼´ä¸çŸ¥é“æ³¨å†Œä¸­å¿ƒæ˜¯å¹²å˜›çš„ï¼Œè¿™é‡Œç®€å•ä»¥ Dubbo ä¸ºä¾‹è¯´ä¸€è¯´ã€‚</p><p>ä¸‹å›¾æ˜¯ Dubbo çš„æ¶æ„å›¾ã€‚<strong>æ³¨å†Œä¸­å¿ƒ Registry åœ¨å…¶ä¸­æ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²å‘¢ï¼Ÿæä¾›äº†ä»€ä¹ˆæœåŠ¡å‘¢ï¼Ÿ</strong></p><p>æ³¨å†Œä¸­å¿ƒè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åªåœ¨å¯åŠ¨æ—¶ä¸æ³¨å†Œä¸­å¿ƒäº¤äº’ï¼Œæ³¨å†Œä¸­å¿ƒä¸è½¬å‘è¯·æ±‚ï¼Œå‹åŠ›è¾ƒå°ã€‚</p><p><img src="https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-11/dubbo-architecture.png" alt="img"></p><p>å¸¸è§çš„å¯ä»¥ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ç»„ä»¶æœ‰ï¼šZooKeeperã€Eurekaã€Nacosâ€¦ã€‚</p><ol><li><strong>ZooKeeper ä¿è¯çš„æ˜¯ CPã€‚</strong> ä»»ä½•æ—¶åˆ»å¯¹ ZooKeeper çš„è¯»è¯·æ±‚éƒ½èƒ½å¾—åˆ°ä¸€è‡´æ€§çš„ç»“æœï¼Œä½†æ˜¯ï¼Œ ZooKeeper ä¸ä¿è¯æ¯æ¬¡è¯·æ±‚çš„å¯ç”¨æ€§æ¯”å¦‚åœ¨ Leader é€‰ä¸¾è¿‡ç¨‹ä¸­æˆ–è€…åŠæ•°ä»¥ä¸Šçš„æœºå™¨ä¸å¯ç”¨çš„æ—¶å€™æœåŠ¡å°±æ˜¯ä¸å¯ç”¨çš„ã€‚</li><li><strong>Eureka ä¿è¯çš„åˆ™æ˜¯ APã€‚</strong> Eureka åœ¨è®¾è®¡çš„æ—¶å€™å°±æ˜¯ä¼˜å…ˆä¿è¯ A ï¼ˆå¯ç”¨æ€§ï¼‰ã€‚åœ¨ Eureka ä¸­ä¸å­˜åœ¨ä»€ä¹ˆ Leader èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€æ ·çš„ã€å¹³ç­‰çš„ã€‚å› æ­¤ Eureka ä¸ä¼šåƒ ZooKeeper é‚£æ ·å‡ºç°é€‰ä¸¾è¿‡ç¨‹ä¸­æˆ–è€…åŠæ•°ä»¥ä¸Šçš„æœºå™¨ä¸å¯ç”¨çš„æ—¶å€™æœåŠ¡å°±æ˜¯ä¸å¯ç”¨çš„æƒ…å†µã€‚ Eureka ä¿è¯å³ä½¿å¤§éƒ¨åˆ†èŠ‚ç‚¹æŒ‚æ‰ä¹Ÿä¸ä¼šå½±å“æ­£å¸¸æä¾›æœåŠ¡ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¯ç”¨çš„å°±è¡Œäº†ã€‚åªä¸è¿‡è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ã€‚</li><li><strong>Nacos ä¸ä»…æ”¯æŒ CP ä¹Ÿæ”¯æŒ APã€‚</strong></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="# æ€»ç»“"></a><a href="#%E6%80%BB%E7%BB%93">#</a> æ€»ç»“</h3><p>åœ¨è¿›è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡å’Œå¼€å‘æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä»…ä»…å±€é™åœ¨ CAP é—®é¢˜ä¸Šï¼Œè¿˜è¦å…³æ³¨ç³»ç»Ÿçš„æ‰©å±•æ€§ã€å¯ç”¨æ€§ç­‰ç­‰</p><p>åœ¨ç³»ç»Ÿå‘ç”Ÿâ€œåˆ†åŒºâ€çš„æƒ…å†µä¸‹ï¼ŒCAP ç†è®ºåªèƒ½æ»¡è¶³ CP æˆ–è€… APã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„å‰ææ˜¯ç³»ç»Ÿå‘ç”Ÿäº†â€œåˆ†åŒºâ€</p><p>å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼ŒèŠ‚ç‚¹é—´çš„ç½‘ç»œè¿æ¥é€šä¿¡æ­£å¸¸çš„è¯ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ P äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒæ—¶ä¿è¯ C å’Œ A äº†ã€‚</p><p>æ€»ç»“ï¼š<strong>å¦‚æœç³»ç»Ÿå‘ç”Ÿâ€œåˆ†åŒºâ€ï¼Œæˆ‘ä»¬è¦è€ƒè™‘é€‰æ‹© CP è¿˜æ˜¯ APã€‚å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼Œæˆ‘ä»¬è¦æ€è€ƒå¦‚ä½•ä¿è¯ CA ã€‚</strong></p><h3 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="# æ¨èé˜…è¯»"></a><a href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB">#</a> æ¨èé˜…è¯»</h3><ol><li><a target="_blank" rel="noopener" href="https://medium.com/@ravindraprasad/cap-theorem-simplified-28499a67eab4">CAP å®šç†ç®€åŒ–open in new window</a> ï¼ˆè‹±æ–‡ï¼Œæœ‰è¶£çš„æ¡ˆä¾‹ï¼‰</li><li><a target="_blank" rel="noopener" href="https://juejin.im/post/6844903936718012430">ç¥ä¸€æ ·çš„ CAP ç†è®ºè¢«åº”ç”¨åœ¨ä½•æ–¹open in new window</a> ï¼ˆä¸­æ–‡ï¼Œåˆ—ä¸¾äº†å¾ˆå¤šå®é™…çš„ä¾‹å­ï¼‰</li><li><a target="_blank" rel="noopener" href="https://martin.kleppmann.com/2015/05/11/please-stop-calling-databases-cp-or-ap.html">è¯·åœæ­¢å‘¼å«æ•°æ®åº“ CP æˆ– AP open in new window</a> ï¼ˆè‹±æ–‡ï¼Œå¸¦ç»™ä½ ä¸ä¸€æ ·çš„æ€è€ƒï¼‰</li></ol><h2 id="BASE-ç†è®º"><a href="#BASE-ç†è®º" class="headerlink" title="# BASE ç†è®º"></a><a href="#base-%E7%90%86%E8%AE%BA">#</a> BASE ç†è®º</h2><p><a target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/1394127.1394128">BASE ç†è®ºopen in new window</a>èµ·æºäº 2008 å¹´ï¼Œ ç”± eBay çš„æ¶æ„å¸ˆ Dan Pritchett åœ¨ ACM ä¸Šå‘è¡¨ã€‚</p><h3 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="# ç®€ä»‹"></a><a href="#%E7%AE%80%E4%BB%8B-1">#</a> ç®€ä»‹</h3><p><strong>BASE</strong> æ˜¯ <strong>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰</strong> ã€<strong>Soft-stateï¼ˆè½¯çŠ¶æ€ï¼‰</strong> å’Œ <strong>Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</strong> ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§ C å’Œå¯ç”¨æ€§ A æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œæ˜¯åŸºäº CAP å®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ï¼Œå®ƒå¤§å¤§é™ä½äº†æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„è¦æ±‚ã€‚</p><h3 id="BASE-ç†è®ºçš„æ ¸å¿ƒæ€æƒ³"><a href="#BASE-ç†è®ºçš„æ ¸å¿ƒæ€æƒ³" class="headerlink" title="# BASE ç†è®ºçš„æ ¸å¿ƒæ€æƒ³"></a><a href="#base-%E7%90%86%E8%AE%BA%E7%9A%84%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3">#</a> BASE ç†è®ºçš„æ ¸å¿ƒæ€æƒ³</h3><p>å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><blockquote><p>ä¹Ÿå°±æ˜¯ç‰ºç‰²æ•°æ®çš„ä¸€è‡´æ€§æ¥æ»¡è¶³ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œç³»ç»Ÿä¸­ä¸€éƒ¨åˆ†æ•°æ®ä¸å¯ç”¨æˆ–è€…ä¸ä¸€è‡´æ—¶ï¼Œä»éœ€è¦ä¿æŒç³»ç»Ÿæ•´ä½“â€œä¸»è¦å¯ç”¨â€ã€‚</p></blockquote><p><strong>BASE ç†è®ºæœ¬è´¨ä¸Šæ˜¯å¯¹ CAP çš„å»¶ä¼¸å’Œè¡¥å……ï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯å¯¹ CAP ä¸­ AP æ–¹æ¡ˆçš„ä¸€ä¸ªè¡¥å……ã€‚</strong></p><p><strong>ä¸ºä»€ä¹ˆè¿™æ ·è¯´å‘¢ï¼Ÿ</strong></p><p>CAP ç†è®ºè¿™èŠ‚æˆ‘ä»¬ä¹Ÿè¯´è¿‡äº†ï¼š</p><blockquote><p>å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼ŒèŠ‚ç‚¹é—´çš„ç½‘ç»œè¿æ¥é€šä¿¡æ­£å¸¸çš„è¯ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ P äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒæ—¶ä¿è¯ C å’Œ A äº†ã€‚å› æ­¤ï¼Œ<strong>å¦‚æœç³»ç»Ÿå‘ç”Ÿâ€œåˆ†åŒºâ€ï¼Œæˆ‘ä»¬è¦è€ƒè™‘é€‰æ‹© CP è¿˜æ˜¯ APã€‚å¦‚æœç³»ç»Ÿæ²¡æœ‰å‘ç”Ÿâ€œåˆ†åŒºâ€çš„è¯ï¼Œæˆ‘ä»¬è¦æ€è€ƒå¦‚ä½•ä¿è¯ CA ã€‚</strong></p></blockquote><p>å› æ­¤ï¼ŒAP æ–¹æ¡ˆåªæ˜¯åœ¨ç³»ç»Ÿå‘ç”Ÿåˆ†åŒºçš„æ—¶å€™æ”¾å¼ƒä¸€è‡´æ€§ï¼Œè€Œä¸æ˜¯æ°¸è¿œæ”¾å¼ƒä¸€è‡´æ€§ã€‚åœ¨åˆ†åŒºæ•…éšœæ¢å¤åï¼Œç³»ç»Ÿåº”è¯¥è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™ä¸€ç‚¹å…¶å®å°±æ˜¯ BASE ç†è®ºå»¶ä¼¸çš„åœ°æ–¹ã€‚</p><h3 id="BASE-ç†è®ºä¸‰è¦ç´ "><a href="#BASE-ç†è®ºä¸‰è¦ç´ " class="headerlink" title="# BASE ç†è®ºä¸‰è¦ç´ "></a><a href="#base-%E7%90%86%E8%AE%BA%E4%B8%89%E8%A6%81%E7%B4%A0">#</a> BASE ç†è®ºä¸‰è¦ç´ </h3><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC81LzI0LzE2MzkxNDgwNmQ5ZTE1YzY?x-oss-process=image/format,png" alt="BASEç†è®ºä¸‰è¦ç´ "></p><h4 id="åŸºæœ¬å¯ç”¨"><a href="#åŸºæœ¬å¯ç”¨" class="headerlink" title="# åŸºæœ¬å¯ç”¨"></a><a href="#%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8">#</a> åŸºæœ¬å¯ç”¨</h4><p>åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ä½†æ˜¯ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚</p><p><strong>ä»€ä¹ˆå«å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§å‘¢ï¼Ÿ</strong></p><ul><li><strong>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±</strong>: æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚éœ€è¦ 0.5s è¿”å›ç»“æœï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚çš„æ—¶é—´å˜ä¸º 3 sã€‚</li><li><strong>ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±</strong>ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ç³»ç»Ÿçš„å…¨éƒ¨åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿè®¿é—®é‡çªç„¶å‰§å¢ï¼Œç³»ç»Ÿçš„éƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ã€‚</li></ul><h4 id="è½¯çŠ¶æ€"><a href="#è½¯çŠ¶æ€" class="headerlink" title="# è½¯çŠ¶æ€"></a><a href="#%E8%BD%AF%E7%8A%B6%E6%80%81">#</a> è½¯çŠ¶æ€</h4><p>è½¯çŠ¶æ€æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼ˆ<strong>CAP ç†è®ºä¸­çš„æ•°æ®ä¸ä¸€è‡´</strong>ï¼‰ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚</p><h4 id="æœ€ç»ˆä¸€è‡´æ€§"><a href="#æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="# æœ€ç»ˆä¸€è‡´æ€§"></a><a href="#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7">#</a> æœ€ç»ˆä¸€è‡´æ€§</h4><p>æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</p><blockquote><p>åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„ 3 ç§çº§åˆ«ï¼š</p><ol><li><strong>å¼ºä¸€è‡´æ€§</strong> ï¼šç³»ç»Ÿå†™å…¥äº†ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„å°±æ˜¯ä»€ä¹ˆã€‚</li><li><strong>å¼±ä¸€è‡´æ€§</strong> ï¼šä¸ä¸€å®šå¯ä»¥è¯»å–åˆ°æœ€æ–°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸ä¿è¯å¤šå°‘æ—¶é—´ä¹‹åè¯»å–åˆ°çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œåªæ˜¯ä¼šå°½é‡ä¿è¯æŸä¸ªæ—¶åˆ»è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong> ï¼šå¼±ä¸€è‡´æ€§çš„å‡çº§ç‰ˆï¼Œç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚</li></ol><p><strong>ä¸šç•Œæ¯”è¾ƒæ¨å´‡æ˜¯æœ€ç»ˆä¸€è‡´æ€§çº§åˆ«ï¼Œä½†æ˜¯æŸäº›å¯¹æ•°æ®ä¸€è‡´è¦æ±‚ååˆ†ä¸¥æ ¼çš„åœºæ™¯æ¯”å¦‚é“¶è¡Œè½¬è´¦è¿˜æ˜¯è¦ä¿è¯å¼ºä¸€è‡´æ€§ã€‚</strong></p></blockquote><p>é‚£å®ç°æœ€ç»ˆä¸€è‡´æ€§çš„å…·ä½“æ–¹å¼æ˜¯ä»€ä¹ˆå‘¢? <a target="_blank" rel="noopener" href="http://gk.link/a/10rZM">ã€Šåˆ†å¸ƒå¼åè®®ä¸ç®—æ³•å®æˆ˜ã€‹open in new window</a> ä¸­æ˜¯è¿™æ ·ä»‹ç»ï¼š</p><blockquote><ul><li><strong>è¯»æ—¶ä¿®å¤</strong> : åœ¨è¯»å–æ•°æ®æ—¶ï¼Œæ£€æµ‹æ•°æ®çš„ä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®å¤ã€‚æ¯”å¦‚ Cassandra çš„ Read Repair å®ç°ï¼Œå…·ä½“æ¥è¯´ï¼Œåœ¨å‘ Cassandra ç³»ç»ŸæŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹åˆ°ä¸åŒèŠ‚ç‚¹ çš„å‰¯æœ¬æ•°æ®ä¸ä¸€è‡´ï¼Œç³»ç»Ÿå°±è‡ªåŠ¨ä¿®å¤æ•°æ®ã€‚</li><li><strong>å†™æ—¶ä¿®å¤</strong> : åœ¨å†™å…¥æ•°æ®ï¼Œæ£€æµ‹æ•°æ®çš„ä¸ä¸€è‡´æ—¶ï¼Œè¿›è¡Œä¿®å¤ã€‚æ¯”å¦‚ Cassandra çš„ Hinted Handoff å®ç°ã€‚å…·ä½“æ¥è¯´ï¼ŒCassandra é›†ç¾¤çš„èŠ‚ç‚¹ä¹‹é—´è¿œç¨‹å†™æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœå†™å¤±è´¥ å°±å°†æ•°æ®ç¼“å­˜ä¸‹æ¥ï¼Œç„¶åå®šæ—¶é‡ä¼ ï¼Œä¿®å¤æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚</li><li><strong>å¼‚æ­¥ä¿®å¤</strong> : è¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œé€šè¿‡å®šæ—¶å¯¹è´¦æ£€æµ‹å‰¯æœ¬æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¹¶ä¿®å¤ã€‚</li></ul></blockquote><p>æ¯”è¾ƒæ¨è <strong>å†™æ—¶ä¿®å¤</strong>ï¼Œè¿™ç§æ–¹å¼å¯¹æ€§èƒ½æ¶ˆè€—æ¯”è¾ƒä½ã€‚</p><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="# æ€»ç»“"></a><a href="#%E6%80%BB%E7%BB%93-1">#</a> æ€»ç»“</h3><p><strong>ACID æ˜¯æ•°æ®åº“äº‹åŠ¡å®Œæ•´æ€§çš„ç†è®ºï¼ŒCAP æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ç†è®ºï¼ŒBASE æ˜¯ CAP ç†è®ºä¸­ AP æ–¹æ¡ˆçš„å»¶ä¼¸ã€‚</strong></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/17/2021-12-29-ZooKeeper%20%E5%AE%9E%E6%88%98/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/17/2021-12-29-ZooKeeper%20%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">ZooKeeperå®æˆ˜</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-17 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-17T19:30:00+08:00">2021-02-17</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1. å‰è¨€"></a>1. å‰è¨€</h2><p>è¿™ç¯‡æ–‡ç« ç®€å•ç»™æ¼”ç¤ºä¸€ä¸‹ ZooKeeper å¸¸è§å‘½ä»¤çš„ä½¿ç”¨ä»¥åŠ ZooKeeper Javaå®¢æˆ·ç«¯ Curator çš„åŸºæœ¬ä½¿ç”¨ã€‚ä»‹ç»åˆ°çš„å†…å®¹éƒ½æ˜¯æœ€åŸºæœ¬çš„æ“ä½œï¼Œèƒ½æ»¡è¶³æ—¥å¸¸å·¥ä½œçš„åŸºæœ¬éœ€è¦ã€‚</p><p>å¦‚æœæ–‡ç« æœ‰ä»»ä½•éœ€è¦æ”¹å–„å’Œå®Œå–„çš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæŒ‡å‡ºï¼Œå…±åŒè¿›æ­¥ï¼</p><h2 id="2-ZooKeeper-å®‰è£…å’Œä½¿ç”¨"><a href="#2-ZooKeeper-å®‰è£…å’Œä½¿ç”¨" class="headerlink" title="2. ZooKeeper å®‰è£…å’Œä½¿ç”¨"></a>2. ZooKeeper å®‰è£…å’Œä½¿ç”¨</h2><h3 id="2-1-ä½¿ç”¨Docker-å®‰è£…-zookeeper"><a href="#2-1-ä½¿ç”¨Docker-å®‰è£…-zookeeper" class="headerlink" title="2.1. ä½¿ç”¨Docker å®‰è£… zookeeper"></a>2.1. ä½¿ç”¨Docker å®‰è£… zookeeper</h3><p><strong>a.ä½¿ç”¨ Docker ä¸‹è½½ ZooKeeper</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper:3.5.8</span><br></pre></td></tr></table></figure><p><strong>b.è¿è¡Œ ZooKeeper</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name zookeeper -p 2181:2181 zookeeper:3.5.8</span><br></pre></td></tr></table></figure><h3 id="2-2-è¿æ¥-ZooKeeper-æœåŠ¡"><a href="#2-2-è¿æ¥-ZooKeeper-æœåŠ¡" class="headerlink" title="2.2. è¿æ¥ ZooKeeper æœåŠ¡"></a>2.2. è¿æ¥ ZooKeeper æœåŠ¡</h3><p><strong>a.è¿›å…¥ZooKeeperå®¹å™¨ä¸­</strong></p><p>å…ˆä½¿ç”¨ <code>docker ps</code> æŸ¥çœ‹ ZooKeeper çš„ ContainerIDï¼Œç„¶åä½¿ç”¨ <code>docker exec -it ContainerID /bin/bash</code> å‘½ä»¤è¿›å…¥å®¹å™¨ä¸­ã€‚</p><p><strong>b.å…ˆè¿›å…¥ bin ç›®å½•,ç„¶åé€šè¿‡ <code>./zkCli.sh -server 127.0.0.1:2181</code>å‘½ä»¤è¿æ¥ZooKeeper æœåŠ¡</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@eaf70fc620cb:/apache-zookeeper-3.5.8-bin# cd bin</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ çœ‹åˆ°æ§åˆ¶å°æˆåŠŸæ‰“å°å‡ºå¦‚ä¸‹ä¿¡æ¯çš„è¯ï¼Œè¯´æ˜ä½ å·²ç»æˆåŠŸè¿æ¥ ZooKeeper æœåŠ¡ã€‚</p><p><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/JavaGuide/blob/main/docs/distributed-system/distributed-process-coordination/zookeeper/images/%E8%BF%9E%E6%8E%A5ZooKeeper%E6%9C%8D%E5%8A%A1.png"><img src="https://github.com/Snailclimb/JavaGuide/raw/main/docs/distributed-system/distributed-process-coordination/zookeeper/images/%E8%BF%9E%E6%8E%A5ZooKeeper%E6%9C%8D%E5%8A%A1.png" alt="img"></a></p><h3 id="2-3-å¸¸ç”¨å‘½ä»¤æ¼”ç¤º"><a href="#2-3-å¸¸ç”¨å‘½ä»¤æ¼”ç¤º" class="headerlink" title="2.3. å¸¸ç”¨å‘½ä»¤æ¼”ç¤º"></a>2.3. å¸¸ç”¨å‘½ä»¤æ¼”ç¤º</h3><h4 id="2-3-1-æŸ¥çœ‹å¸¸ç”¨å‘½ä»¤-help-å‘½ä»¤"><a href="#2-3-1-æŸ¥çœ‹å¸¸ç”¨å‘½ä»¤-help-å‘½ä»¤" class="headerlink" title="2.3.1. æŸ¥çœ‹å¸¸ç”¨å‘½ä»¤(help å‘½ä»¤)"></a>2.3.1. æŸ¥çœ‹å¸¸ç”¨å‘½ä»¤(help å‘½ä»¤)</h4><p>é€šè¿‡ <code>help</code> å‘½ä»¤æŸ¥çœ‹ ZooKeeper å¸¸ç”¨å‘½ä»¤</p><h4 id="2-3-2-åˆ›å»ºèŠ‚ç‚¹-create-å‘½ä»¤"><a href="#2-3-2-åˆ›å»ºèŠ‚ç‚¹-create-å‘½ä»¤" class="headerlink" title="2.3.2. åˆ›å»ºèŠ‚ç‚¹(create å‘½ä»¤)"></a>2.3.2. åˆ›å»ºèŠ‚ç‚¹(create å‘½ä»¤)</h4><p>é€šè¿‡ <code>create</code> å‘½ä»¤åœ¨æ ¹ç›®å½•åˆ›å»ºäº† node1 èŠ‚ç‚¹ï¼Œä¸å®ƒå…³è”çš„å­—ç¬¦ä¸²æ˜¯â€node1â€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 34] create /node1 â€œnode1â€</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>create</code> å‘½ä»¤åœ¨æ ¹ç›®å½•åˆ›å»ºäº† node1 èŠ‚ç‚¹ï¼Œä¸å®ƒå…³è”çš„å†…å®¹æ˜¯æ•°å­— 123</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 1] create /node1/node1.1 123</span><br><span class="line">Created /node1/node1.1</span><br></pre></td></tr></table></figure><h4 id="2-3-3-æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹-set-å‘½ä»¤"><a href="#2-3-3-æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹-set-å‘½ä»¤" class="headerlink" title="2.3.3. æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹(set å‘½ä»¤)"></a>2.3.3. æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹(set å‘½ä»¤)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 11] set /node1 &quot;set node1&quot;</span><br></pre></td></tr></table></figure><h4 id="2-3-4-è·å–èŠ‚ç‚¹çš„æ•°æ®-get-å‘½ä»¤"><a href="#2-3-4-è·å–èŠ‚ç‚¹çš„æ•°æ®-get-å‘½ä»¤" class="headerlink" title="2.3.4. è·å–èŠ‚ç‚¹çš„æ•°æ®(get å‘½ä»¤)"></a>2.3.4. è·å–èŠ‚ç‚¹çš„æ•°æ®(get å‘½ä»¤)</h4><p><code>get</code> å‘½ä»¤å¯ä»¥è·å–æŒ‡å®šèŠ‚ç‚¹çš„æ•°æ®å†…å®¹å’ŒèŠ‚ç‚¹çš„çŠ¶æ€,å¯ä»¥çœ‹å‡ºæˆ‘ä»¬é€šè¿‡ <code>set</code> å‘½ä»¤å·²ç»å°†èŠ‚ç‚¹æ•°æ®å†…å®¹æ”¹ä¸º â€œset node1â€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">set node1</span><br><span class="line">cZxid = 0x47</span><br><span class="line">ctime = Sun Jan 20 10:22:59 CST 2019</span><br><span class="line">mZxid = 0x4b</span><br><span class="line">mtime = Sun Jan 20 10:41:10 CST 2019</span><br><span class="line">pZxid = 0x4a</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 9</span><br><span class="line">numChildren = 1</span><br></pre></td></tr></table></figure><h4 id="2-3-5-æŸ¥çœ‹æŸä¸ªç›®å½•ä¸‹çš„å­èŠ‚ç‚¹-ls-å‘½ä»¤"><a href="#2-3-5-æŸ¥çœ‹æŸä¸ªç›®å½•ä¸‹çš„å­èŠ‚ç‚¹-ls-å‘½ä»¤" class="headerlink" title="2.3.5. æŸ¥çœ‹æŸä¸ªç›®å½•ä¸‹çš„å­èŠ‚ç‚¹(ls å‘½ä»¤)"></a>2.3.5. æŸ¥çœ‹æŸä¸ªç›®å½•ä¸‹çš„å­èŠ‚ç‚¹(ls å‘½ä»¤)</h4><p>é€šè¿‡ <code>ls</code> å‘½ä»¤æŸ¥çœ‹æ ¹ç›®å½•ä¸‹çš„èŠ‚ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 37] ls /</span><br><span class="line">[dubbo, ZooKeeper, node1]</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>ls</code> å‘½ä»¤æŸ¥çœ‹ node1 ç›®å½•ä¸‹çš„èŠ‚ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 5] ls /node1</span><br><span class="line">[node1.1]</span><br></pre></td></tr></table></figure><p>ZooKeeper ä¸­çš„ ls å‘½ä»¤å’Œ linux å‘½ä»¤ä¸­çš„ ls ç±»ä¼¼ï¼Œ è¿™ä¸ªå‘½ä»¤å°†åˆ—å‡ºç»å¯¹è·¯å¾„ path ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ä¿¡æ¯ï¼ˆåˆ—å‡º 1 çº§ï¼Œå¹¶ä¸é€’å½’ï¼‰</p><h4 id="2-3-6-æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€-stat-å‘½ä»¤"><a href="#2-3-6-æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€-stat-å‘½ä»¤" class="headerlink" title="2.3.6. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€(stat å‘½ä»¤)"></a>2.3.6. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€(stat å‘½ä»¤)</h4><p>é€šè¿‡ <code>stat</code> å‘½ä»¤æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 10] stat /node1</span><br><span class="line">cZxid = 0x47</span><br><span class="line">ctime = Sun Jan 20 10:22:59 CST 2019</span><br><span class="line">mZxid = 0x47</span><br><span class="line">mtime = Sun Jan 20 10:22:59 CST 2019</span><br><span class="line">pZxid = 0x4a</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 11</span><br><span class="line">numChildren = 1</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¾ç¤ºçš„ä¸€äº›ä¿¡æ¯æ¯”å¦‚ cversionã€aclVersionã€numChildren ç­‰ç­‰ï¼Œæˆ‘åœ¨ä¸Šé¢ â€œ<a target="_blank" rel="noopener" href="https://javaguide.cn/distributed-system/distributed-process-coordination/zookeeper/zookeeper-intro.html">ZooKeeper ç›¸å…³æ¦‚å¿µæ€»ç»“(å…¥é—¨)</a>â€ è¿™ç¯‡æ–‡ç« ä¸­å·²ç»ä»‹ç»åˆ°ã€‚</p><h4 id="2-3-7-æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯å’ŒçŠ¶æ€-ls2-å‘½ä»¤"><a href="#2-3-7-æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯å’ŒçŠ¶æ€-ls2-å‘½ä»¤" class="headerlink" title="2.3.7. æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯å’ŒçŠ¶æ€(ls2 å‘½ä»¤)"></a>2.3.7. æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯å’ŒçŠ¶æ€(ls2 å‘½ä»¤)</h4><p><code>ls2</code> å‘½ä»¤æ›´åƒæ˜¯ <code>ls</code> å‘½ä»¤å’Œ <code>stat</code> å‘½ä»¤çš„ç»“åˆã€‚ <code>ls2</code> å‘½ä»¤è¿”å›çš„ä¿¡æ¯åŒ…æ‹¬ 2 éƒ¨åˆ†ï¼š</p><ol><li>å­èŠ‚ç‚¹åˆ—è¡¨</li><li>å½“å‰èŠ‚ç‚¹çš„ stat ä¿¡æ¯ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 7] ls2 /node1</span><br><span class="line">[node1.1]</span><br><span class="line">cZxid = 0x47</span><br><span class="line">ctime = Sun Jan 20 10:22:59 CST 2019</span><br><span class="line">mZxid = 0x47</span><br><span class="line">mtime = Sun Jan 20 10:22:59 CST 2019</span><br><span class="line">pZxid = 0x4a</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 11</span><br><span class="line">numChildren = 1</span><br></pre></td></tr></table></figure><h4 id="2-3-8-åˆ é™¤èŠ‚ç‚¹-delete-å‘½ä»¤"><a href="#2-3-8-åˆ é™¤èŠ‚ç‚¹-delete-å‘½ä»¤" class="headerlink" title="2.3.8. åˆ é™¤èŠ‚ç‚¹(delete å‘½ä»¤)"></a>2.3.8. åˆ é™¤èŠ‚ç‚¹(delete å‘½ä»¤)</h4><p>è¿™ä¸ªå‘½ä»¤å¾ˆç®€å•ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯å¦‚æœä½ è¦åˆ é™¤æŸä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å¿…é¡»æ— å­èŠ‚ç‚¹æ‰è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 3] delete /node1/node1.1</span><br></pre></td></tr></table></figure><p>åœ¨åé¢æˆ‘ä¼šä»‹ç»åˆ° Java å®¢æˆ·ç«¯ API çš„ä½¿ç”¨ä»¥åŠå¼€æº ZooKeeper å®¢æˆ·ç«¯ ZkClient å’Œ Curator çš„ä½¿ç”¨ã€‚</p><h2 id="3-ZooKeeper-Javaå®¢æˆ·ç«¯-Curatorç®€å•ä½¿ç”¨"><a href="#3-ZooKeeper-Javaå®¢æˆ·ç«¯-Curatorç®€å•ä½¿ç”¨" class="headerlink" title="3. ZooKeeper Javaå®¢æˆ·ç«¯ Curatorç®€å•ä½¿ç”¨"></a>3. ZooKeeper Javaå®¢æˆ·ç«¯ Curatorç®€å•ä½¿ç”¨</h2><p>Curator æ˜¯Netflixå…¬å¸å¼€æºçš„ä¸€å¥— ZooKeeper Javaå®¢æˆ·ç«¯æ¡†æ¶ï¼Œç›¸æ¯”äº Zookeeper è‡ªå¸¦çš„å®¢æˆ·ç«¯ zookeeper æ¥è¯´ï¼ŒCurator çš„å°è£…æ›´åŠ å®Œå–„ï¼Œå„ç§ API éƒ½å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿åœ°ä½¿ç”¨ã€‚</p><p><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/JavaGuide/blob/main/docs/distributed-system/distributed-process-coordination/zookeeper/images/curator.png"><img src="https://github.com/Snailclimb/JavaGuide/raw/main/docs/distributed-system/distributed-process-coordination/zookeeper/images/curator.png" alt="img"></a></p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥ç®€å•åœ°æ¼”ç¤ºä¸€ä¸‹ Curator çš„ä½¿ç”¨å§ï¼</p><p>Curator4.0+ç‰ˆæœ¬å¯¹ZooKeeper 3.5.xæ”¯æŒæ¯”è¾ƒå¥½ã€‚å¼€å§‹ä¹‹å‰ï¼Œè¯·å…ˆå°†ä¸‹é¢çš„ä¾èµ–æ·»åŠ è¿›ä½ çš„é¡¹ç›®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="3-1-è¿æ¥-ZooKeeper-å®¢æˆ·ç«¯"><a href="#3-1-è¿æ¥-ZooKeeper-å®¢æˆ·ç«¯" class="headerlink" title="3.1. è¿æ¥ ZooKeeper å®¢æˆ·ç«¯"></a>3.1. è¿æ¥ ZooKeeper å®¢æˆ·ç«¯</h3><p>é€šè¿‡ <code>CuratorFrameworkFactory</code> åˆ›å»º <code>CuratorFramework</code> å¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨ <code>CuratorFramework</code> å¯¹è±¡çš„ <code>start()</code> æ–¹æ³•å³å¯ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private static final int BASE_SLEEP_TIME = 1000;</span><br><span class="line">private static final int MAX_RETRIES = 3;</span><br><span class="line"></span><br><span class="line">// Retry strategy. Retry 3 times, and will increase the sleep time between retries.</span><br><span class="line">RetryPolicy retryPolicy = new ExponentialBackoffRetry(BASE_SLEEP_TIME, MAX_RETRIES);</span><br><span class="line">CuratorFramework zkClient = CuratorFrameworkFactory.builder()</span><br><span class="line">    // the server to connect to (can be a server list)</span><br><span class="line">    .connectString(&quot;127.0.0.1:2181&quot;)</span><br><span class="line">    .retryPolicy(retryPolicy)</span><br><span class="line">    .build();</span><br><span class="line">zkClient.start();</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸€äº›åŸºæœ¬å‚æ•°çš„è¯´æ˜ï¼š</p><ul><li><code>baseSleepTimeMs</code>ï¼šé‡è¯•ä¹‹é—´ç­‰å¾…çš„åˆå§‹æ—¶é—´</li><li><code>maxRetries</code> ï¼šæœ€å¤§é‡è¯•æ¬¡æ•°</li><li><code>connectString</code> ï¼šè¦è¿æ¥çš„æœåŠ¡å™¨åˆ—è¡¨</li><li><code>retryPolicy</code> ï¼šé‡è¯•ç­–ç•¥</li></ul><h3 id="3-2-æ•°æ®èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥"><a href="#3-2-æ•°æ®èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥" class="headerlink" title="3.2. æ•°æ®èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥"></a>3.2. æ•°æ®èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥</h3><h4 id="3-2-1-åˆ›å»ºèŠ‚ç‚¹"><a href="#3-2-1-åˆ›å»ºèŠ‚ç‚¹" class="headerlink" title="3.2.1. åˆ›å»ºèŠ‚ç‚¹"></a>3.2.1. åˆ›å»ºèŠ‚ç‚¹</h4><p>æˆ‘ä»¬åœ¨ <a target="_blank" rel="noopener" href="https://github.com/Snailclimb/JavaGuide/blob/main/docs/distributed-system/distributed-process-coordination/zookeeper/zookeeper-intro.md">ZooKeeperå¸¸è§æ¦‚å¿µè§£è¯»</a> ä¸­ä»‹ç»åˆ°ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯å°† znode åˆ†ä¸º 4 å¤§ç±»ï¼š</p><ul><li><strong>æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹</strong> ï¼šä¸€æ—¦åˆ›å»ºå°±ä¸€ç›´å­˜åœ¨å³ä½¿ ZooKeeper é›†ç¾¤å®•æœºï¼Œç›´åˆ°å°†å…¶åˆ é™¤ã€‚</li><li><strong>ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹</strong> ï¼šä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ <strong>å®¢æˆ·ç«¯ä¼šè¯ï¼ˆsessionï¼‰</strong> ç»‘å®šçš„ï¼Œ<strong>ä¼šè¯æ¶ˆå¤±åˆ™èŠ‚ç‚¹æ¶ˆå¤±</strong> ã€‚å¹¶ä¸”ï¼Œä¸´æ—¶èŠ‚ç‚¹ <strong>åªèƒ½åšå¶å­èŠ‚ç‚¹</strong> ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</li><li><strong>æŒä¹…é¡ºåºï¼ˆPERSISTENT_SEQUENTIALï¼‰èŠ‚ç‚¹</strong> ï¼šé™¤äº†å…·æœ‰æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œ å­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§ã€‚æ¯”å¦‚ <code>/node1/app0000000001</code> ã€<code>/node1/app0000000002</code> ã€‚</li><li><strong>ä¸´æ—¶é¡ºåºï¼ˆEPHEMERAL_SEQUENTIALï¼‰èŠ‚ç‚¹</strong> ï¼šé™¤äº†å…·å¤‡ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œå­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§ã€‚</li></ul><p>ä½ åœ¨ä½¿ç”¨çš„ZooKeeper çš„æ—¶å€™ï¼Œä¼šå‘ç° <code>CreateMode</code> ç±»ä¸­å®é™…æœ‰ 7ç§ znode ç±»å‹ ï¼Œä½†æ˜¯ç”¨çš„æœ€å¤šçš„è¿˜æ˜¯ä¸Šé¢ä»‹ç»çš„ 4 ç§ã€‚</p><p><strong>a.åˆ›å»ºæŒä¹…åŒ–èŠ‚ç‚¹</strong></p><p>ä½ å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ç§æ–¹å¼åˆ›å»ºæŒä¹…åŒ–çš„èŠ‚ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//æ³¨æ„:ä¸‹é¢çš„ä»£ç ä¼šæŠ¥é”™ï¼Œä¸‹æ–‡è¯´äº†å…·ä½“åŸå› </span><br><span class="line">zkClient.create().forPath(&quot;/node1/00001&quot;);</span><br><span class="line">zkClient.create().withMode(CreateMode.PERSISTENT).forPath(&quot;/node1/00002&quot;);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œä½ è¿è¡Œä¸Šé¢çš„ä»£ç ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯å› ä¸ºçš„çˆ¶èŠ‚ç‚¹<code>node1</code>è¿˜æœªåˆ›å»ºã€‚</p><p>ä½ å¯ä»¥å…ˆåˆ›å»ºçˆ¶èŠ‚ç‚¹ <code>node1</code> ï¼Œç„¶åå†æ‰§è¡Œä¸Šé¢çš„ä»£ç å°±ä¸ä¼šæŠ¥é”™äº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkClient.create().forPath(&quot;/node1&quot;);</span><br></pre></td></tr></table></figure><p>æ›´æ¨èçš„æ–¹å¼æ˜¯é€šè¿‡ä¸‹é¢è¿™è¡Œä»£ç ï¼Œ <strong><code>creatingParentsIfNeeded()</code> å¯ä»¥ä¿è¯çˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºçˆ¶èŠ‚ç‚¹ï¼Œè¿™æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkClient.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(&quot;/node1/00001&quot;);</span><br></pre></td></tr></table></figure><p><strong>b.åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkClient.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(&quot;/node1/00001&quot;);</span><br></pre></td></tr></table></figure><p><strong>c.åˆ›å»ºèŠ‚ç‚¹å¹¶æŒ‡å®šæ•°æ®å†…å®¹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zkClient.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(&quot;/node1/00001&quot;,&quot;java&quot;.getBytes());</span><br><span class="line">zkClient.getData().forPath(&quot;/node1/00001&quot;);//è·å–èŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼Œè·å–åˆ°çš„æ˜¯ byteæ•°ç»„</span><br></pre></td></tr></table></figure><p><strong>d.æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦åˆ›å»ºæˆåŠŸ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkClient.checkExists().forPath(&quot;/node1/00001&quot;);//ä¸ä¸ºnullçš„è¯ï¼Œè¯´æ˜èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ</span><br></pre></td></tr></table></figure><h4 id="3-2-2-åˆ é™¤èŠ‚ç‚¹"><a href="#3-2-2-åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="3.2.2. åˆ é™¤èŠ‚ç‚¹"></a>3.2.2. åˆ é™¤èŠ‚ç‚¹</h4><p><strong>a.åˆ é™¤ä¸€ä¸ªå­èŠ‚ç‚¹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkClient.delete().forPath(&quot;/node1/00001&quot;);</span><br></pre></td></tr></table></figure><p><strong>b.åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ä»¥åŠå…¶ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkClient.delete().deletingChildrenIfNeeded().forPath(&quot;/node1&quot;);</span><br></pre></td></tr></table></figure><h4 id="3-2-3-è·å–-x2F-æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹"><a href="#3-2-3-è·å–-x2F-æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹" class="headerlink" title="3.2.3. è·å–&#x2F;æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹"></a>3.2.3. è·å–&#x2F;æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zkClient.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(&quot;/node1/00001&quot;,&quot;java&quot;.getBytes());</span><br><span class="line">zkClient.getData().forPath(&quot;/node1/00001&quot;);//è·å–èŠ‚ç‚¹çš„æ•°æ®å†…å®¹</span><br><span class="line">zkClient.setData().forPath(&quot;/node1/00001&quot;,&quot;c++&quot;.getBytes());//æ›´æ–°èŠ‚ç‚¹æ•°æ®å†…å®¹</span><br></pre></td></tr></table></figure><h4 id="3-2-4-è·å–æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„"><a href="#3-2-4-è·å–æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„" class="headerlink" title="3.2.4. è·å–æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„"></a>3.2.4. è·å–æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; childrenPaths = zkClient.getChildren().forPath(&quot;/node1&quot;);</span><br></pre></td></tr></table></figure><details class="details-reset details-overlay details-overlay-dark" id="jumpto-line-details-dialog" style="box-sizing:border-box;display:block"><summary data-hotkey="l" aria-label="Jump to line" role="button" style="box-sizing:border-box;display:list-item;cursor:pointer;list-style:none;transition:color 80ms cubic-bezier(.33,1,.68,1) 0s,background-color,box-shadow,border-color"></summary></details></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/17/2021-12-30-ZooKeeper%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E4%B8%80%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/17/2021-12-30-ZooKeeper%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">ZooKeeperåŸºç¡€çŸ¥è¯†ï¼ˆä¸€ï¼‰</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-17 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-17T19:30:00+08:00">2021-02-17</time></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="ZooKeeper-ç›¸å…³æ¦‚å¿µæ€»ç»“-å…¥é—¨"><a href="#ZooKeeper-ç›¸å…³æ¦‚å¿µæ€»ç»“-å…¥é—¨" class="headerlink" title="ZooKeeper ç›¸å…³æ¦‚å¿µæ€»ç»“(å…¥é—¨)"></a>ZooKeeper ç›¸å…³æ¦‚å¿µæ€»ç»“(å…¥é—¨)</h1><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1. å‰è¨€"></a>1. å‰è¨€</h2><p>ç›¸ä¿¡å¤§å®¶å¯¹ ZooKeeper åº”è¯¥ä¸ç®—é™Œç”Ÿã€‚ä½†æ˜¯ä½ çœŸçš„äº†è§£ ZooKeeper åˆ°åº•æœ‰å•¥ç”¨ä¸ï¼Ÿå¦‚æœåˆ«äºº&#x2F;é¢è¯•å®˜è®©ä½ ç»™ä»–è®²è®²å¯¹äº ZooKeeper çš„è®¤è¯†ï¼Œä½ èƒ½å›ç­”åˆ°ä»€ä¹ˆåœ°æ­¥å‘¢ï¼Ÿ</p><p>æ‹¿æˆ‘è‡ªå·±æ¥è¯´å§ï¼æˆ‘æœ¬äººæ›¾ç»ä½¿ç”¨ Dubbo æ¥åšåˆ†å¸ƒå¼é¡¹ç›®çš„æ—¶å€™ï¼Œä½¿ç”¨äº† ZooKeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚ä¸ºäº†ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿèƒ½å¤ŸåŒæ­¥è®¿é—®æŸä¸ªèµ„æºï¼Œæˆ‘è¿˜ä½¿ç”¨ ZooKeeper åšè¿‡åˆ†å¸ƒå¼é”ã€‚å¦å¤–ï¼Œæˆ‘åœ¨å­¦ä¹  Kafka çš„æ—¶å€™ï¼ŒçŸ¥é“ Kafka å¾ˆå¤šåŠŸèƒ½çš„å®ç°ä¾èµ–äº† ZooKeeperã€‚</p><p>å‰å‡ å¤©ï¼Œæ€»ç»“é¡¹ç›®ç»éªŒçš„æ—¶å€™ï¼Œæˆ‘çªç„¶é—®è‡ªå·± ZooKeeper åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿæƒ³äº†åŠå¤©ï¼Œè„‘æµ·ä¸­åªæ˜¯ç®€å•çš„èƒ½æµ®ç°å‡ºå‡ å¥è¯ï¼š</p><ol><li>ZooKeeper å¯ä»¥è¢«ç”¨ä½œæ³¨å†Œä¸­å¿ƒã€åˆ†å¸ƒå¼é”ï¼›</li><li>ZooKeeper æ˜¯ Hadoop ç”Ÿæ€ç³»ç»Ÿçš„ä¸€å‘˜ï¼›</li><li>æ„å»º ZooKeeper é›†ç¾¤çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æœåŠ¡å™¨æœ€å¥½æ˜¯å¥‡æ•°å°ã€‚</li></ol><p>ç”±æ­¤å¯è§ï¼Œæˆ‘å¯¹äº ZooKeeper çš„ç†è§£ä»…ä»…æ˜¯åœç•™åœ¨äº†è¡¨é¢ã€‚</p><p>æ‰€ä»¥ï¼Œé€šè¿‡æœ¬æ–‡ï¼Œå¸Œæœ›å¸¦å¤§å®¶ç¨å¾®è¯¦ç»†çš„äº†è§£ä¸€ä¸‹ ZooKeeper ã€‚å¦‚æœæ²¡æœ‰å­¦è¿‡ ZooKeeper ï¼Œé‚£ä¹ˆæœ¬æ–‡å°†ä¼šæ˜¯ä½ è¿›å…¥ ZooKeeper å¤§é—¨çš„å«è„šç –ã€‚å¦‚æœä½ å·²ç»æ¥è§¦è¿‡ ZooKeeper ï¼Œé‚£ä¹ˆæœ¬æ–‡å°†å¸¦ä½ å›é¡¾ä¸€ä¸‹ ZooKeeper çš„ä¸€äº›åŸºç¡€æ¦‚å¿µã€‚</p><p>å¦å¤–ï¼Œæœ¬æ–‡ä¸å…‰ä¼šæ¶‰åŠåˆ° ZooKeeper çš„ä¸€äº›æ¦‚å¿µï¼Œåé¢çš„æ–‡ç« ä¼šä»‹ç»åˆ° ZooKeeper å¸¸è§å‘½ä»¤çš„ä½¿ç”¨ä»¥åŠä½¿ç”¨ Apache Curator ä½œä¸º ZooKeeper çš„å®¢æˆ·ç«¯ã€‚</p><p><em>å¦‚æœæ–‡ç« æœ‰ä»»ä½•éœ€è¦æ”¹å–„å’Œå®Œå–„çš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæŒ‡å‡ºï¼Œå…±åŒè¿›æ­¥ï¼</em></p><h2 id="2-ZooKeeper-ä»‹ç»"><a href="#2-ZooKeeper-ä»‹ç»" class="headerlink" title="2. ZooKeeper ä»‹ç»"></a>2. ZooKeeper ä»‹ç»</h2><h3 id="2-1-ZooKeeper-ç”±æ¥"><a href="#2-1-ZooKeeper-ç”±æ¥" class="headerlink" title="2.1. ZooKeeper ç”±æ¥"></a>2.1. ZooKeeper ç”±æ¥</h3><p>æ­£å¼ä»‹ç» ZooKeeper ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ ZooKeeper çš„ç”±æ¥ï¼Œè¿˜æŒºæœ‰æ„æ€çš„ã€‚</p><p>ä¸‹é¢è¿™æ®µå†…å®¹æ‘˜è‡ªã€Šä» Paxos åˆ° ZooKeeper ã€‹ç¬¬å››ç« ç¬¬ä¸€èŠ‚ï¼Œæ¨èå¤§å®¶é˜…è¯»ä¸€ä¸‹ï¼š</p><blockquote><p>ZooKeeper æœ€æ—©èµ·æºäºé›…è™ç ”ç©¶é™¢çš„ä¸€ä¸ªç ”ç©¶å°ç»„ã€‚åœ¨å½“æ—¶ï¼Œç ”ç©¶äººå‘˜å‘ç°ï¼Œåœ¨é›…è™å†…éƒ¨å¾ˆå¤šå¤§å‹ç³»ç»ŸåŸºæœ¬éƒ½éœ€è¦ä¾èµ–ä¸€ä¸ªç±»ä¼¼çš„ç³»ç»Ÿæ¥è¿›è¡Œåˆ†å¸ƒå¼åè°ƒï¼Œä½†æ˜¯è¿™äº›ç³»ç»Ÿå¾€å¾€éƒ½å­˜åœ¨åˆ†å¸ƒå¼å•ç‚¹é—®é¢˜ã€‚æ‰€ä»¥ï¼Œé›…è™çš„å¼€å‘äººå‘˜å°±è¯•å›¾å¼€å‘ä¸€ä¸ªé€šç”¨çš„æ— å•ç‚¹é—®é¢˜çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ï¼Œä»¥ä¾¿è®©å¼€å‘äººå‘˜å°†ç²¾åŠ›é›†ä¸­åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚</p><p>å…³äºâ€œZooKeeperâ€è¿™ä¸ªé¡¹ç›®çš„åå­—ï¼Œå…¶å®ä¹Ÿæœ‰ä¸€æ®µè¶£é—»ã€‚åœ¨ç«‹é¡¹åˆæœŸï¼Œè€ƒè™‘åˆ°ä¹‹å‰å†…éƒ¨å¾ˆå¤šé¡¹ç›®éƒ½æ˜¯ä½¿ç”¨åŠ¨ç‰©çš„åå­—æ¥å‘½åçš„ï¼ˆä¾‹å¦‚è‘—åçš„ Pig é¡¹ç›®),é›…è™çš„å·¥ç¨‹å¸ˆå¸Œæœ›ç»™è¿™ä¸ªé¡¹ç›®ä¹Ÿå–ä¸€ä¸ªåŠ¨ç‰©çš„åå­—ã€‚æ—¶ä»»ç ”ç©¶é™¢çš„é¦–å¸­ç§‘å­¦å®¶ RaghuRamakrishnan å¼€ç©ç¬‘åœ°è¯´ï¼šâ€œåœ¨è¿™æ ·ä¸‹å»ï¼Œæˆ‘ä»¬è¿™å„¿å°±å˜æˆåŠ¨ç‰©å›­äº†ï¼â€æ­¤è¯ä¸€å‡ºï¼Œå¤§å®¶çº·çº·è¡¨ç¤ºå°±å«åŠ¨ç‰©å›­ç®¡ç†å‘˜å§ä¸€ä¸€ä¸€å› ä¸ºå„ä¸ªä»¥åŠ¨ç‰©å‘½åçš„åˆ†å¸ƒå¼ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œé›…è™çš„æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçœ‹ä¸Šå»å°±åƒä¸€ä¸ªå¤§å‹çš„åŠ¨ç‰©å›­äº†ï¼Œè€Œ ZooKeeper æ­£å¥½è¦ç”¨æ¥è¿›è¡Œåˆ†å¸ƒå¼ç¯å¢ƒçš„åè°ƒä¸€ä¸€äºæ˜¯ï¼ŒZooKeeper çš„åå­—ä¹Ÿå°±ç”±æ­¤è¯ç”Ÿäº†ã€‚</p></blockquote><h3 id="2-2-ZooKeeper-æ¦‚è§ˆ"><a href="#2-2-ZooKeeper-æ¦‚è§ˆ" class="headerlink" title="2.2. ZooKeeper æ¦‚è§ˆ"></a>2.2. ZooKeeper æ¦‚è§ˆ</h3><p>ZooKeeper æ˜¯ä¸€ä¸ªå¼€æºçš„<strong>åˆ†å¸ƒå¼åè°ƒæœåŠ¡</strong>ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯å°†é‚£äº›å¤æ‚ä¸”å®¹æ˜“å‡ºé”™çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§æœåŠ¡å°è£…èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªé«˜æ•ˆå¯é çš„åŸè¯­é›†ï¼Œå¹¶ä»¥ä¸€ç³»åˆ—ç®€å•æ˜“ç”¨çš„æ¥å£æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p><blockquote><p><strong>åŸè¯­ï¼š</strong> æ“ä½œç³»ç»Ÿæˆ–è®¡ç®—æœºç½‘ç»œç”¨è¯­èŒƒç•´ã€‚æ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®Œæˆä¸€å®šåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚å…·æœ‰ä¸å¯åˆ†å‰²æ€§Â·å³åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ã€‚</p></blockquote><p><strong>ZooKeeper ä¸ºæˆ‘ä»¬æä¾›äº†é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€ç¨³å®šçš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆï¼Œé€šå¸¸è¢«ç”¨äºå®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ&#x2F;é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Master é€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚</strong></p><p>å¦å¤–ï¼Œ<strong>ZooKeeper å°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ€§èƒ½æ˜¯éå¸¸æ£’çš„ã€‚ åœ¨â€œè¯»â€å¤šäºâ€œå†™â€çš„åº”ç”¨ç¨‹åºä¸­å°¤å…¶åœ°é«˜æ€§èƒ½ï¼Œå› ä¸ºâ€œå†™â€ä¼šå¯¼è‡´æ‰€æœ‰çš„æœåŠ¡å™¨é—´åŒæ­¥çŠ¶æ€ã€‚ï¼ˆâ€œè¯»â€å¤šäºâ€œå†™â€æ˜¯åè°ƒæœåŠ¡çš„å…¸å‹åœºæ™¯ï¼‰ã€‚</strong></p><h3 id="2-3-ZooKeeper-ç‰¹ç‚¹"><a href="#2-3-ZooKeeper-ç‰¹ç‚¹" class="headerlink" title="2.3. ZooKeeper ç‰¹ç‚¹"></a>2.3. ZooKeeper ç‰¹ç‚¹</h3><ul><li><strong>é¡ºåºä¸€è‡´æ€§ï¼š</strong> ä»åŒä¸€å®¢æˆ·ç«¯å‘èµ·çš„äº‹åŠ¡è¯·æ±‚ï¼Œæœ€ç»ˆå°†ä¼šä¸¥æ ¼åœ°æŒ‰ç…§é¡ºåºè¢«åº”ç”¨åˆ° ZooKeeper ä¸­å»ã€‚</li><li><strong>åŸå­æ€§ï¼š</strong> æ‰€æœ‰äº‹åŠ¡è¯·æ±‚çš„å¤„ç†ç»“æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¸Šçš„åº”ç”¨æƒ…å†µæ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦ä¹ˆæ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰çš„æœºå™¨éƒ½æˆåŠŸåº”ç”¨äº†æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½æ²¡æœ‰åº”ç”¨ã€‚</li><li><strong>å•ä¸€ç³»ç»Ÿæ˜ åƒ ï¼š</strong> æ— è®ºå®¢æˆ·ç«¯è¿åˆ°å“ªä¸€ä¸ª ZooKeeper æœåŠ¡å™¨ä¸Šï¼Œå…¶çœ‹åˆ°çš„æœåŠ¡ç«¯æ•°æ®æ¨¡å‹éƒ½æ˜¯ä¸€è‡´çš„ã€‚</li><li><strong>å¯é æ€§ï¼š</strong> ä¸€æ—¦ä¸€æ¬¡æ›´æ”¹è¯·æ±‚è¢«åº”ç”¨ï¼Œæ›´æ”¹çš„ç»“æœå°±ä¼šè¢«æŒä¹…åŒ–ï¼Œç›´åˆ°è¢«ä¸‹ä¸€æ¬¡æ›´æ”¹è¦†ç›–ã€‚</li></ul><h3 id="2-4-ZooKeeper-å…¸å‹åº”ç”¨åœºæ™¯"><a href="#2-4-ZooKeeper-å…¸å‹åº”ç”¨åœºæ™¯" class="headerlink" title="2.4. ZooKeeper å…¸å‹åº”ç”¨åœºæ™¯"></a>2.4. ZooKeeper å…¸å‹åº”ç”¨åœºæ™¯</h3><p>ZooKeeper æ¦‚è§ˆä¸­ï¼Œæˆ‘ä»¬ä»‹ç»åˆ°ä½¿ç”¨å…¶é€šå¸¸è¢«ç”¨äºå®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ&#x2F;é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Master é€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚</p><p>ä¸‹é¢é€‰ 3 ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯æ¥ä¸“é—¨è¯´è¯´ï¼š</p><ol><li><strong>åˆ†å¸ƒå¼é”</strong> ï¼š é€šè¿‡åˆ›å»ºå”¯ä¸€èŠ‚ç‚¹è·å¾—åˆ†å¸ƒå¼é”ï¼Œå½“è·å¾—é”çš„ä¸€æ–¹æ‰§è¡Œå®Œç›¸å…³ä»£ç æˆ–è€…æ˜¯æŒ‚æ‰ä¹‹åå°±é‡Šæ”¾é”ã€‚</li><li><strong>å‘½åæœåŠ¡</strong> ï¼šå¯ä»¥é€šè¿‡ ZooKeeper çš„é¡ºåºèŠ‚ç‚¹ç”Ÿæˆå…¨å±€å”¯ä¸€ ID</li><li><strong>æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…</strong> ï¼šé€šè¿‡ <strong>Watcher æœºåˆ¶</strong> å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€‚å½“ä½ å°†æ•°æ®å‘å¸ƒåˆ° ZooKeeper è¢«ç›‘å¬çš„èŠ‚ç‚¹ä¸Šï¼Œå…¶ä»–æœºå™¨å¯é€šè¿‡ç›‘å¬ ZooKeeper ä¸ŠèŠ‚ç‚¹çš„å˜åŒ–æ¥å®ç°é…ç½®çš„åŠ¨æ€æ›´æ–°ã€‚</li></ol><p>å®é™…ä¸Šï¼Œè¿™äº›åŠŸèƒ½çš„å®ç°åŸºæœ¬éƒ½å¾—ç›Šäº ZooKeeper å¯ä»¥ä¿å­˜æ•°æ®çš„åŠŸèƒ½ï¼Œä½†æ˜¯ ZooKeeper ä¸é€‚åˆä¿å­˜å¤§é‡æ•°æ®ï¼Œè¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ã€‚</p><h3 id="2-5-æœ‰å“ªäº›è‘—åçš„å¼€æºé¡¹ç›®ç”¨åˆ°äº†-ZooKeeper"><a href="#2-5-æœ‰å“ªäº›è‘—åçš„å¼€æºé¡¹ç›®ç”¨åˆ°äº†-ZooKeeper" class="headerlink" title="2.5. æœ‰å“ªäº›è‘—åçš„å¼€æºé¡¹ç›®ç”¨åˆ°äº† ZooKeeper?"></a>2.5. æœ‰å“ªäº›è‘—åçš„å¼€æºé¡¹ç›®ç”¨åˆ°äº† ZooKeeper?</h3><ol><li><strong>Kafka</strong> : ZooKeeper ä¸»è¦ä¸º Kafka æä¾› Broker å’Œ Topic çš„æ³¨å†Œä»¥åŠå¤šä¸ª Partition çš„è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ã€‚</li><li><strong>Hbase</strong> : ZooKeeper ä¸º Hbase æä¾›ç¡®ä¿æ•´ä¸ªé›†ç¾¤åªæœ‰ä¸€ä¸ª Master ä»¥åŠä¿å­˜å’Œæä¾› regionserver çŠ¶æ€ä¿¡æ¯ï¼ˆæ˜¯å¦åœ¨çº¿ï¼‰ç­‰åŠŸèƒ½ã€‚</li><li><strong>Hadoop</strong> : ZooKeeper ä¸º Namenode æä¾›é«˜å¯ç”¨æ”¯æŒã€‚</li></ol><h2 id="3-ZooKeeper-é‡è¦æ¦‚å¿µè§£è¯»"><a href="#3-ZooKeeper-é‡è¦æ¦‚å¿µè§£è¯»" class="headerlink" title="3. ZooKeeper é‡è¦æ¦‚å¿µè§£è¯»"></a>3. ZooKeeper é‡è¦æ¦‚å¿µè§£è¯»</h2><p><em>ç ´éŸ³ï¼šæ‹¿å‡ºå°æœ¬æœ¬ï¼Œä¸‹é¢çš„å†…å®¹éå¸¸é‡è¦å“¦ï¼</em></p><h3 id="3-1-Data-modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰"><a href="#3-1-Data-modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰" class="headerlink" title="3.1. Data modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰"></a>3.1. Data modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰</h3><p>ZooKeeper æ•°æ®æ¨¡å‹é‡‡ç”¨å±‚æ¬¡åŒ–çš„å¤šå‰æ ‘å½¢ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥å­˜å‚¨æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ˜¯æ•°å­—ã€å­—ç¬¦ä¸²æˆ–è€…æ˜¯äºŒçº§åˆ¶åºåˆ—ã€‚å¹¶ä¸”ã€‚æ¯ä¸ªèŠ‚ç‚¹è¿˜å¯ä»¥æ‹¥æœ‰ N ä¸ªå­èŠ‚ç‚¹ï¼Œæœ€ä¸Šå±‚æ˜¯æ ¹èŠ‚ç‚¹ä»¥â€œ&#x2F;â€æ¥ä»£è¡¨ã€‚æ¯ä¸ªæ•°æ®èŠ‚ç‚¹åœ¨ ZooKeeper ä¸­è¢«ç§°ä¸º <strong>znode</strong>ï¼Œå®ƒæ˜¯ ZooKeeper ä¸­æ•°æ®çš„æœ€å°å•å…ƒã€‚å¹¶ä¸”ï¼Œæ¯ä¸ª znode éƒ½ä¸€ä¸ªå”¯ä¸€çš„è·¯å¾„æ ‡è¯†ã€‚</p><p>å¼ºè°ƒä¸€å¥ï¼š<strong>ZooKeeper ä¸»è¦æ˜¯ç”¨æ¥åè°ƒæœåŠ¡çš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥å­˜å‚¨ä¸šåŠ¡æ•°æ®çš„ï¼Œæ‰€ä»¥ä¸è¦æ”¾æ¯”è¾ƒå¤§çš„æ•°æ®åœ¨ znode ä¸Šï¼ŒZooKeeper ç»™å‡ºçš„ä¸Šé™æ˜¯æ¯ä¸ªç»“ç‚¹çš„æ•°æ®å¤§å°æœ€å¤§æ˜¯ 1Mã€‚</strong></p><p>ä»ä¸‹å›¾å¯ä»¥æ›´ç›´è§‚åœ°çœ‹å‡ºï¼šZooKeeper èŠ‚ç‚¹è·¯å¾„æ ‡è¯†æ–¹å¼å’Œ Unix æ–‡ä»¶ç³»ç»Ÿè·¯å¾„éå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯ç”±ä¸€ç³»åˆ—ä½¿ç”¨æ–œæ â€&#x2F;â€œè¿›è¡Œåˆ†å‰²çš„è·¯å¾„è¡¨ç¤ºï¼Œå¼€å‘äººå‘˜å¯ä»¥å‘è¿™ä¸ªèŠ‚ç‚¹ä¸­å†™å…¥æ•°æ®ï¼Œä¹Ÿå¯ä»¥åœ¨èŠ‚ç‚¹ä¸‹é¢åˆ›å»ºå­èŠ‚ç‚¹ã€‚è¿™äº›æ“ä½œæˆ‘ä»¬åé¢éƒ½ä¼šä»‹ç»åˆ°ã€‚</p><p><img src="https://javaguide.cn/assets/znode-structure.19119dbd.png" alt="ZooKeeper æ•°æ®æ¨¡å‹"></p><h3 id="3-2-znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰"><a href="#3-2-znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰" class="headerlink" title="3.2. znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰"></a>3.2. znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰</h3><p>ä»‹ç»äº† ZooKeeper æ ‘å½¢æ•°æ®æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªæ•°æ®èŠ‚ç‚¹åœ¨ ZooKeeper ä¸­è¢«ç§°ä¸º <strong>znode</strong>ï¼Œå®ƒæ˜¯ ZooKeeper ä¸­æ•°æ®çš„æœ€å°å•å…ƒã€‚ä½ è¦å­˜æ”¾çš„æ•°æ®å°±æ”¾åœ¨ä¸Šé¢ï¼Œæ˜¯ä½ ä½¿ç”¨ ZooKeeper è¿‡ç¨‹ä¸­ç»å¸¸éœ€è¦æ¥è§¦åˆ°çš„ä¸€ä¸ªæ¦‚å¿µã€‚</p><h4 id="3-2-1-znode-4-ç§ç±»å‹"><a href="#3-2-1-znode-4-ç§ç±»å‹" class="headerlink" title="3.2.1. znode 4 ç§ç±»å‹"></a>3.2.1. znode 4 ç§ç±»å‹</h4><p>æˆ‘ä»¬é€šå¸¸æ˜¯å°† znode åˆ†ä¸º 4 å¤§ç±»ï¼š</p><ul><li><strong>æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹</strong> ï¼šä¸€æ—¦åˆ›å»ºå°±ä¸€ç›´å­˜åœ¨å³ä½¿ ZooKeeper é›†ç¾¤å®•æœºï¼Œç›´åˆ°å°†å…¶åˆ é™¤ã€‚</li><li><strong>ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹</strong> ï¼šä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ <strong>å®¢æˆ·ç«¯ä¼šè¯ï¼ˆsessionï¼‰</strong> ç»‘å®šçš„ï¼Œ<strong>ä¼šè¯æ¶ˆå¤±åˆ™èŠ‚ç‚¹æ¶ˆå¤±</strong> ã€‚å¹¶ä¸”ï¼Œ<strong>ä¸´æ—¶èŠ‚ç‚¹åªèƒ½åšå¶å­èŠ‚ç‚¹</strong> ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</li><li><strong>æŒä¹…é¡ºåºï¼ˆPERSISTENT_SEQUENTIALï¼‰èŠ‚ç‚¹</strong> ï¼šé™¤äº†å…·æœ‰æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œ å­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§ã€‚æ¯”å¦‚ <code>/node1/app0000000001</code> ã€<code>/node1/app0000000002</code> ã€‚</li><li><strong>ä¸´æ—¶é¡ºåºï¼ˆEPHEMERAL_SEQUENTIALï¼‰èŠ‚ç‚¹</strong> ï¼šé™¤äº†å…·å¤‡ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œå­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§ã€‚</li></ul><h4 id="3-2-2-znode-æ•°æ®ç»“æ„"><a href="#3-2-2-znode-æ•°æ®ç»“æ„" class="headerlink" title="3.2.2. znode æ•°æ®ç»“æ„"></a>3.2.2. znode æ•°æ®ç»“æ„</h4><p>æ¯ä¸ª znode ç”± 2 éƒ¨åˆ†ç»„æˆ:</p><ul><li><strong>stat</strong> ï¼šçŠ¶æ€ä¿¡æ¯</li><li><strong>data</strong> ï¼š èŠ‚ç‚¹å­˜æ”¾çš„æ•°æ®çš„å…·ä½“å†…å®¹</li></ul><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘é€šè¿‡ get å‘½ä»¤æ¥è·å– æ ¹ç›®å½•ä¸‹çš„ dubbo èŠ‚ç‚¹çš„å†…å®¹ã€‚ï¼ˆget å‘½ä»¤åœ¨ä¸‹é¢ä¼šä»‹ç»åˆ°ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 6] get /dubbo</span><br><span class="line"># è¯¥æ•°æ®èŠ‚ç‚¹å…³è”çš„æ•°æ®å†…å®¹ä¸ºç©º</span><br><span class="line">null</span><br><span class="line"># ä¸‹é¢æ˜¯è¯¥æ•°æ®èŠ‚ç‚¹çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œå…¶å®å°±æ˜¯ Stat å¯¹è±¡çš„æ ¼å¼åŒ–è¾“å‡º</span><br><span class="line">cZxid = 0x2</span><br><span class="line">ctime = Tue Nov 27 11:05:34 CST 2018</span><br><span class="line">mZxid = 0x2</span><br><span class="line">mtime = Tue Nov 27 11:05:34 CST 2018</span><br><span class="line">pZxid = 0x3</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 1</span><br></pre></td></tr></table></figure><p>Stat ç±»ä¸­åŒ…å«äº†ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯çš„å­—æ®µï¼ŒåŒ…æ‹¬äº‹åŠ¡ ID-cZxidã€èŠ‚ç‚¹åˆ›å»ºæ—¶é—´-ctime å’Œå­èŠ‚ç‚¹ä¸ªæ•°-numChildren ç­‰ç­‰ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¯ä¸ª znode çŠ¶æ€ä¿¡æ¯ç©¶ç«Ÿä»£è¡¨çš„æ˜¯ä»€ä¹ˆå§ï¼ï¼ˆä¸‹é¢çš„å†…å®¹æ¥æºäºã€Šä» Paxos åˆ° ZooKeeper åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå› ä¸º Guide ç¡®å®ä¹Ÿä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œè¦å­¦ä¼šå‚è€ƒèµ„æ–™çš„å˜›ï¼ ï¼‰ ï¼š</p><table><thead><tr><th>znode çŠ¶æ€ä¿¡æ¯</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>cZxid</td><td>create ZXIDï¼Œå³è¯¥æ•°æ®èŠ‚ç‚¹è¢«åˆ›å»ºæ—¶çš„äº‹åŠ¡ id</td></tr><tr><td>ctime</td><td>create timeï¼Œå³è¯¥èŠ‚ç‚¹çš„åˆ›å»ºæ—¶é—´</td></tr><tr><td>mZxid</td><td>modified ZXIDï¼Œå³è¯¥èŠ‚ç‚¹æœ€ç»ˆä¸€æ¬¡æ›´æ–°æ—¶çš„äº‹åŠ¡ id</td></tr><tr><td>mtime</td><td>modified timeï¼Œå³è¯¥èŠ‚ç‚¹æœ€åä¸€æ¬¡çš„æ›´æ–°æ—¶é—´</td></tr><tr><td>pZxid</td><td>è¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨æœ€åä¸€æ¬¡ä¿®æ”¹æ—¶çš„äº‹åŠ¡ idï¼Œåªæœ‰å­èŠ‚ç‚¹åˆ—è¡¨å˜æ›´æ‰ä¼šæ›´æ–° pZxidï¼Œå­èŠ‚ç‚¹å†…å®¹å˜æ›´ä¸ä¼šæ›´æ–°</td></tr><tr><td>cversion</td><td>å­èŠ‚ç‚¹ç‰ˆæœ¬å·ï¼Œå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ¯æ¬¡å˜åŒ–æ—¶å€¼å¢åŠ  1</td></tr><tr><td>dataVersion</td><td>æ•°æ®èŠ‚ç‚¹å†…å®¹ç‰ˆæœ¬å·ï¼ŒèŠ‚ç‚¹åˆ›å»ºæ—¶ä¸º 0ï¼Œæ¯æ›´æ–°ä¸€æ¬¡èŠ‚ç‚¹å†…å®¹(ä¸ç®¡å†…å®¹æœ‰æ— å˜åŒ–)è¯¥ç‰ˆæœ¬å·çš„å€¼å¢åŠ  1</td></tr><tr><td>aclVersion</td><td>èŠ‚ç‚¹çš„ ACL ç‰ˆæœ¬å·ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ ACL ä¿¡æ¯å˜æ›´æ¬¡æ•°</td></tr><tr><td>ephemeralOwner</td><td>åˆ›å»ºè¯¥ä¸´æ—¶èŠ‚ç‚¹çš„ä¼šè¯çš„ sessionIdï¼›å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ï¼Œåˆ™ ephemeralOwner&#x3D;0</td></tr><tr><td>dataLength</td><td>æ•°æ®èŠ‚ç‚¹å†…å®¹é•¿åº¦</td></tr><tr><td>numChildren</td><td>å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°</td></tr></tbody></table><h3 id="3-3-ç‰ˆæœ¬ï¼ˆversionï¼‰"><a href="#3-3-ç‰ˆæœ¬ï¼ˆversionï¼‰" class="headerlink" title="3.3. ç‰ˆæœ¬ï¼ˆversionï¼‰"></a>3.3. ç‰ˆæœ¬ï¼ˆversionï¼‰</h3><p>åœ¨å‰é¢æˆ‘ä»¬å·²ç»æåˆ°ï¼Œå¯¹åº”äºæ¯ä¸ª znodeï¼ŒZooKeeper éƒ½ä¼šä¸ºå…¶ç»´æŠ¤ä¸€ä¸ªå«ä½œ <strong>Stat</strong> çš„æ•°æ®ç»“æ„ï¼ŒStat ä¸­è®°å½•äº†è¿™ä¸ª znode çš„ä¸‰ä¸ªç›¸å…³çš„ç‰ˆæœ¬ï¼š</p><ul><li><strong>dataVersion</strong> ï¼šå½“å‰ znode èŠ‚ç‚¹çš„ç‰ˆæœ¬å·</li><li><strong>cversion</strong> ï¼š å½“å‰ znode å­èŠ‚ç‚¹çš„ç‰ˆæœ¬</li><li><strong>aclVersion</strong> ï¼š å½“å‰ znode çš„ ACL çš„ç‰ˆæœ¬ã€‚</li></ul><h3 id="3-4-ACLï¼ˆæƒé™æ§åˆ¶ï¼‰"><a href="#3-4-ACLï¼ˆæƒé™æ§åˆ¶ï¼‰" class="headerlink" title="3.4. ACLï¼ˆæƒé™æ§åˆ¶ï¼‰"></a>3.4. ACLï¼ˆæƒé™æ§åˆ¶ï¼‰</h3><p>ZooKeeper é‡‡ç”¨ ACLï¼ˆAccessControlListsï¼‰ç­–ç•¥æ¥è¿›è¡Œæƒé™æ§åˆ¶ï¼Œç±»ä¼¼äº UNIX æ–‡ä»¶ç³»ç»Ÿçš„æƒé™æ§åˆ¶ã€‚</p><p>å¯¹äº znode æ“ä½œçš„æƒé™ï¼ŒZooKeeper æä¾›äº†ä»¥ä¸‹ 5 ç§ï¼š</p><ul><li><strong>CREATE</strong> : èƒ½åˆ›å»ºå­èŠ‚ç‚¹</li><li><strong>READ</strong> ï¼šèƒ½è·å–èŠ‚ç‚¹æ•°æ®å’Œåˆ—å‡ºå…¶å­èŠ‚ç‚¹</li><li><strong>WRITE</strong> : èƒ½è®¾ç½®&#x2F;æ›´æ–°èŠ‚ç‚¹æ•°æ®</li><li><strong>DELETE</strong> : èƒ½åˆ é™¤å­èŠ‚ç‚¹</li><li><strong>ADMIN</strong> : èƒ½è®¾ç½®èŠ‚ç‚¹ ACL çš„æƒé™</li></ul><p>å…¶ä¸­å°¤å…¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>CREATE</strong> å’Œ <strong>DELETE</strong> è¿™ä¸¤ç§æƒé™éƒ½æ˜¯é’ˆå¯¹ <strong>å­èŠ‚ç‚¹</strong> çš„æƒé™æ§åˆ¶ã€‚</p><p>å¯¹äºèº«ä»½è®¤è¯ï¼Œæä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><ul><li><strong>world</strong> ï¼š é»˜è®¤æ–¹å¼ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯æ— æ¡ä»¶è®¿é—®ã€‚</li><li><strong>auth</strong> :ä¸ä½¿ç”¨ä»»ä½• idï¼Œä»£è¡¨ä»»ä½•å·²è®¤è¯çš„ç”¨æˆ·ã€‚</li><li><strong>digest</strong> :ç”¨æˆ·å:å¯†ç è®¤è¯æ–¹å¼ï¼š <em>username:password</em> ã€‚</li><li><strong>ip</strong> : å¯¹æŒ‡å®š ip è¿›è¡Œé™åˆ¶ã€‚</li></ul><h3 id="3-5-Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰"><a href="#3-5-Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰" class="headerlink" title="3.5. Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰"></a>3.5. Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰</h3><p>Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰ï¼Œæ˜¯ ZooKeeper ä¸­çš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ã€‚ZooKeeper å…è®¸ç”¨æˆ·åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€äº› Watcherï¼Œå¹¶ä¸”åœ¨ä¸€äº›ç‰¹å®šäº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼ŒZooKeeper æœåŠ¡ç«¯ä¼šå°†äº‹ä»¶é€šçŸ¥åˆ°æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯ä¸Šå»ï¼Œè¯¥æœºåˆ¶æ˜¯ ZooKeeper å®ç°åˆ†å¸ƒå¼åè°ƒæœåŠ¡çš„é‡è¦ç‰¹æ€§ã€‚</p><p><img src="https://javaguide.cn/assets/watche%E6%9C%BA%E5%88%B6.f523bd89.png" alt="watcheræœºåˆ¶"></p><p><em>ç ´éŸ³ï¼šéå¸¸æœ‰ç”¨çš„ä¸€ä¸ªç‰¹æ€§ï¼Œéƒ½æ‹¿å‡ºå°æœ¬æœ¬è®°å¥½äº†ï¼Œåé¢ç”¨åˆ° ZooKeeper åŸºæœ¬ç¦»ä¸å¼€ Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰æœºåˆ¶ã€‚</em></p><h3 id="3-6-ä¼šè¯ï¼ˆSessionï¼‰"><a href="#3-6-ä¼šè¯ï¼ˆSessionï¼‰" class="headerlink" title="3.6. ä¼šè¯ï¼ˆSessionï¼‰"></a>3.6. ä¼šè¯ï¼ˆSessionï¼‰</h3><p>Session å¯ä»¥çœ‹ä½œæ˜¯ ZooKeeper æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„ä¹‹é—´çš„ä¸€ä¸ª TCP é•¿è¿æ¥ï¼Œé€šè¿‡è¿™ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡å¿ƒè·³æ£€æµ‹ä¸æœåŠ¡å™¨ä¿æŒæœ‰æ•ˆçš„ä¼šè¯ï¼Œä¹Ÿèƒ½å¤Ÿå‘ ZooKeeper æœåŠ¡å™¨å‘é€è¯·æ±‚å¹¶æ¥å—å“åº”ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿé€šè¿‡è¯¥è¿æ¥æ¥æ”¶æ¥è‡ªæœåŠ¡å™¨çš„ Watcher äº‹ä»¶é€šçŸ¥ã€‚</p><p>Session æœ‰ä¸€ä¸ªå±æ€§å«åšï¼š<code>sessionTimeout</code> ï¼Œ<code>sessionTimeout</code> ä»£è¡¨ä¼šè¯çš„è¶…æ—¶æ—¶é—´ã€‚å½“ç”±äºæœåŠ¡å™¨å‹åŠ›å¤ªå¤§ã€ç½‘ç»œæ•…éšœæˆ–æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ç­‰å„ç§åŸå› å¯¼è‡´å®¢æˆ·ç«¯è¿æ¥æ–­å¼€æ—¶ï¼Œåªè¦åœ¨<code>sessionTimeout</code>è§„å®šçš„æ—¶é—´å†…èƒ½å¤Ÿé‡æ–°è¿æ¥ä¸Šé›†ç¾¤ä¸­ä»»æ„ä¸€å°æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä¹‹å‰åˆ›å»ºçš„ä¼šè¯ä»ç„¶æœ‰æ•ˆã€‚</p><p>å¦å¤–ï¼Œåœ¨ä¸ºå®¢æˆ·ç«¯åˆ›å»ºä¼šè¯ä¹‹å‰ï¼ŒæœåŠ¡ç«¯é¦–å…ˆä¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯éƒ½åˆ†é…ä¸€ä¸ª <code>sessionID</code>ã€‚ç”±äº <code>sessionID</code>æ˜¯ ZooKeeper ä¼šè¯çš„ä¸€ä¸ªé‡è¦æ ‡è¯†ï¼Œè®¸å¤šä¸ä¼šè¯ç›¸å…³çš„è¿è¡Œæœºåˆ¶éƒ½æ˜¯åŸºäºè¿™ä¸ª <code>sessionID</code> çš„ï¼Œå› æ­¤ï¼Œæ— è®ºæ˜¯å“ªå°æœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯åˆ†é…çš„ <code>sessionID</code>ï¼Œéƒ½åŠ¡å¿…ä¿è¯å…¨å±€å”¯ä¸€ã€‚</p><h2 id="4-ZooKeeper-é›†ç¾¤"><a href="#4-ZooKeeper-é›†ç¾¤" class="headerlink" title="4. ZooKeeper é›†ç¾¤"></a>4. ZooKeeper é›†ç¾¤</h2><p>ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œæœ€å¥½æ˜¯ä»¥é›†ç¾¤å½¢æ€æ¥éƒ¨ç½² ZooKeeperï¼Œè¿™æ ·åªè¦é›†ç¾¤ä¸­å¤§éƒ¨åˆ†æœºå™¨æ˜¯å¯ç”¨çš„ï¼ˆèƒ½å¤Ÿå®¹å¿ä¸€å®šçš„æœºå™¨æ•…éšœï¼‰ï¼Œé‚£ä¹ˆ ZooKeeper æœ¬èº«ä»ç„¶æ˜¯å¯ç”¨çš„ã€‚é€šå¸¸ 3 å°æœåŠ¡å™¨å°±å¯ä»¥æ„æˆä¸€ä¸ª ZooKeeper é›†ç¾¤äº†ã€‚ZooKeeper å®˜æ–¹æä¾›çš„æ¶æ„å›¾å°±æ˜¯ä¸€ä¸ª ZooKeeper é›†ç¾¤æ•´ä½“å¯¹å¤–æä¾›æœåŠ¡ã€‚</p><p><img src="https://javaguide.cn/assets/zookeeper%E9%9B%86%E7%BE%A4.6fdcc61e.png" alt="img"></p><p>ä¸Šå›¾ä¸­æ¯ä¸€ä¸ª Server ä»£è¡¨ä¸€ä¸ªå®‰è£… ZooKeeper æœåŠ¡çš„æœåŠ¡å™¨ã€‚ç»„æˆ ZooKeeper æœåŠ¡çš„æœåŠ¡å™¨éƒ½ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤å½“å‰çš„æœåŠ¡å™¨çŠ¶æ€ï¼Œå¹¶ä¸”æ¯å°æœåŠ¡å™¨ä¹‹é—´éƒ½äº’ç›¸ä¿æŒç€é€šä¿¡ã€‚é›†ç¾¤é—´é€šè¿‡ ZAB åè®®ï¼ˆZooKeeper Atomic Broadcastï¼‰æ¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><p><strong>æœ€å…¸å‹é›†ç¾¤æ¨¡å¼ï¼š Master&#x2F;Slave æ¨¡å¼ï¼ˆä¸»å¤‡æ¨¡å¼ï¼‰</strong>ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œé€šå¸¸ Master æœåŠ¡å™¨ä½œä¸ºä¸»æœåŠ¡å™¨æä¾›å†™æœåŠ¡ï¼Œå…¶ä»–çš„ Slave æœåŠ¡å™¨ä»æœåŠ¡å™¨é€šè¿‡å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼è·å– Master æœåŠ¡å™¨æœ€æ–°çš„æ•°æ®æä¾›è¯»æœåŠ¡ã€‚</p><h3 id="4-1-ZooKeeper-é›†ç¾¤è§’è‰²"><a href="#4-1-ZooKeeper-é›†ç¾¤è§’è‰²" class="headerlink" title="4.1. ZooKeeper é›†ç¾¤è§’è‰²"></a>4.1. ZooKeeper é›†ç¾¤è§’è‰²</h3><p>ä½†æ˜¯ï¼Œåœ¨ ZooKeeper ä¸­æ²¡æœ‰é€‰æ‹©ä¼ ç»Ÿçš„ Master&#x2F;Slave æ¦‚å¿µï¼Œè€Œæ˜¯å¼•å…¥äº† Leaderã€Follower å’Œ Observer ä¸‰ç§è§’è‰²ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://javaguide.cn/assets/zookeeper%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2.ffff8ef5.png" alt="img"></p><p>ZooKeeper é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨é€šè¿‡ä¸€ä¸ª <strong>Leader é€‰ä¸¾è¿‡ç¨‹</strong> æ¥é€‰å®šä¸€å°ç§°ä¸º â€œ<strong>Leader</strong>â€ çš„æœºå™¨ï¼ŒLeader æ—¢å¯ä»¥ä¸ºå®¢æˆ·ç«¯æä¾›å†™æœåŠ¡åˆèƒ½æä¾›è¯»æœåŠ¡ã€‚é™¤äº† Leader å¤–ï¼Œ<strong>Follower</strong> å’Œ <strong>Observer</strong> éƒ½åªèƒ½æä¾›è¯»æœåŠ¡ã€‚Follower å’Œ Observer å”¯ä¸€çš„åŒºåˆ«åœ¨äº Observer æœºå™¨ä¸å‚ä¸ Leader çš„é€‰ä¸¾è¿‡ç¨‹ï¼Œä¹Ÿä¸å‚ä¸å†™æ“ä½œçš„â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ï¼Œå› æ­¤ Observer æœºå™¨å¯ä»¥åœ¨ä¸å½±å“å†™æ€§èƒ½çš„æƒ…å†µä¸‹æå‡é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚</p><table><thead><tr><th>è§’è‰²</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Leader</td><td>ä¸ºå®¢æˆ·ç«¯æä¾›è¯»å’Œå†™çš„æœåŠ¡ï¼Œè´Ÿè´£æŠ•ç¥¨çš„å‘èµ·å’Œå†³è®®ï¼Œæ›´æ–°ç³»ç»ŸçŠ¶æ€ã€‚</td></tr><tr><td>Follower</td><td>ä¸ºå®¢æˆ·ç«¯æä¾›è¯»æœåŠ¡ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åˆ™è½¬å‘ç»™ Leaderã€‚å‚ä¸é€‰ä¸¾è¿‡ç¨‹ä¸­çš„æŠ•ç¥¨ã€‚</td></tr><tr><td>Observer</td><td>ä¸ºå®¢æˆ·ç«¯æä¾›è¯»æœåŠ¡ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åˆ™è½¬å‘ç»™ Leaderã€‚ä¸å‚ä¸é€‰ä¸¾è¿‡ç¨‹ä¸­çš„æŠ•ç¥¨ï¼Œä¹Ÿä¸å‚ä¸â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ã€‚åœ¨ä¸å½±å“å†™æ€§èƒ½çš„æƒ…å†µä¸‹æå‡é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚æ­¤è§’è‰²äº ZooKeeper3.3 ç³»åˆ—æ–°å¢çš„è§’è‰²ã€‚</td></tr></tbody></table><p>å½“ Leader æœåŠ¡å™¨å‡ºç°ç½‘ç»œä¸­æ–­ã€å´©æºƒé€€å‡ºä¸é‡å¯ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼Œå°±ä¼šè¿›å…¥ Leader é€‰ä¸¾è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šé€‰ä¸¾äº§ç”Ÿæ–°çš„ Leader æœåŠ¡å™¨ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p><ol><li><strong>Leader electionï¼ˆé€‰ä¸¾é˜¶æ®µï¼‰</strong>ï¼šèŠ‚ç‚¹åœ¨ä¸€å¼€å§‹éƒ½å¤„äºé€‰ä¸¾é˜¶æ®µï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹å¾—åˆ°è¶…åŠæ•°èŠ‚ç‚¹çš„ç¥¨æ•°ï¼Œå®ƒå°±å¯ä»¥å½“é€‰å‡† leaderã€‚</li><li><strong>Discoveryï¼ˆå‘ç°é˜¶æ®µï¼‰</strong> ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œfollowers è·Ÿå‡† leader è¿›è¡Œé€šä¿¡ï¼ŒåŒæ­¥ followers æœ€è¿‘æ¥æ”¶çš„äº‹åŠ¡æè®®ã€‚</li><li><strong>Synchronizationï¼ˆåŒæ­¥é˜¶æ®µï¼‰</strong> :åŒæ­¥é˜¶æ®µä¸»è¦æ˜¯åˆ©ç”¨ leader å‰ä¸€é˜¶æ®µè·å¾—çš„æœ€æ–°æè®®å†å²ï¼ŒåŒæ­¥é›†ç¾¤ä¸­æ‰€æœ‰çš„å‰¯æœ¬ã€‚åŒæ­¥å®Œæˆä¹‹å å‡† leader æ‰ä¼šæˆä¸ºçœŸæ­£çš„ leaderã€‚</li><li><strong>Broadcastï¼ˆå¹¿æ’­é˜¶æ®µï¼‰</strong> :åˆ°äº†è¿™ä¸ªé˜¶æ®µï¼ŒZooKeeper é›†ç¾¤æ‰èƒ½æ­£å¼å¯¹å¤–æä¾›äº‹åŠ¡æœåŠ¡ï¼Œå¹¶ä¸” leader å¯ä»¥è¿›è¡Œæ¶ˆæ¯å¹¿æ’­ã€‚åŒæ—¶å¦‚æœæœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥ï¼Œè¿˜éœ€è¦å¯¹æ–°èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ã€‚</li></ol><h3 id="4-2-ZooKeeper-é›†ç¾¤ä¸­çš„æœåŠ¡å™¨çŠ¶æ€"><a href="#4-2-ZooKeeper-é›†ç¾¤ä¸­çš„æœåŠ¡å™¨çŠ¶æ€" class="headerlink" title="4.2. ZooKeeper é›†ç¾¤ä¸­çš„æœåŠ¡å™¨çŠ¶æ€"></a>4.2. ZooKeeper é›†ç¾¤ä¸­çš„æœåŠ¡å™¨çŠ¶æ€</h3><ul><li><strong>LOOKING</strong> ï¼šå¯»æ‰¾ Leaderã€‚</li><li><strong>LEADING</strong> ï¼šLeader çŠ¶æ€ï¼Œå¯¹åº”çš„èŠ‚ç‚¹ä¸º Leaderã€‚</li><li><strong>FOLLOWING</strong> ï¼šFollower çŠ¶æ€ï¼Œå¯¹åº”çš„èŠ‚ç‚¹ä¸º Followerã€‚</li><li><strong>OBSERVING</strong> ï¼šObserver çŠ¶æ€ï¼Œå¯¹åº”èŠ‚ç‚¹ä¸º Observerï¼Œè¯¥èŠ‚ç‚¹ä¸å‚ä¸ Leader é€‰ä¸¾ã€‚</li></ul><h3 id="4-3-ZooKeeper-é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ"><a href="#4-3-ZooKeeper-é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ" class="headerlink" title="4.3. ZooKeeper é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ"></a>4.3. ZooKeeper é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ</h3><p>ZooKeeper é›†ç¾¤åœ¨å®•æ‰å‡ ä¸ª ZooKeeper æœåŠ¡å™¨ä¹‹åï¼Œå¦‚æœå‰©ä¸‹çš„ ZooKeeper æœåŠ¡å™¨ä¸ªæ•°å¤§äºå®•æ‰çš„ä¸ªæ•°çš„è¯æ•´ä¸ª ZooKeeper æ‰ä¾ç„¶å¯ç”¨ã€‚å‡å¦‚æˆ‘ä»¬çš„é›†ç¾¤ä¸­æœ‰ n å° ZooKeeper æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯å‰©ä¸‹çš„æœåŠ¡æ•°å¿…é¡»å¤§äº n&#x2F;2ã€‚å…ˆè¯´ä¸€ä¸‹ç»“è®ºï¼Œ2n å’Œ 2n-1 çš„å®¹å¿åº¦æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ n-1ï¼Œå¤§å®¶å¯ä»¥å…ˆè‡ªå·±ä»”ç»†æƒ³ä¸€æƒ³ï¼Œè¿™åº”è¯¥æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ•°å­¦é—®é¢˜äº†ã€‚</p><p>æ¯”å¦‚å‡å¦‚æˆ‘ä»¬æœ‰ 3 å°ï¼Œé‚£ä¹ˆæœ€å¤§å…è®¸å®•æ‰ 1 å° ZooKeeper æœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 4 å°çš„çš„æ—¶å€™ä¹ŸåŒæ ·åªå…è®¸å®•æ‰ 1 å°ã€‚ å‡å¦‚æˆ‘ä»¬æœ‰ 5 å°ï¼Œé‚£ä¹ˆæœ€å¤§å…è®¸å®•æ‰ 2 å° ZooKeeper æœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 6 å°çš„çš„æ—¶å€™ä¹ŸåŒæ ·åªå…è®¸å®•æ‰ 2 å°ã€‚</p><p>ç»¼ä¸Šï¼Œä½•å¿…å¢åŠ é‚£ä¸€ä¸ªä¸å¿…è¦çš„ ZooKeeper å‘¢ï¼Ÿ</p><h3 id="4-4-ZooKeeper-é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚"><a href="#4-4-ZooKeeper-é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚" class="headerlink" title="4.4. ZooKeeper é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚"></a>4.4. ZooKeeper é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚</h3><p><strong>ä½•ä¸ºé›†ç¾¤è„‘è£‚ï¼Ÿ</strong></p><p>å¯¹äºä¸€ä¸ªé›†ç¾¤ï¼Œé€šå¸¸å¤šå°æœºå™¨ä¼šéƒ¨ç½²åœ¨ä¸åŒæœºæˆ¿ï¼Œæ¥æé«˜è¿™ä¸ªé›†ç¾¤çš„å¯ç”¨æ€§ã€‚ä¿è¯å¯ç”¨æ€§çš„åŒæ—¶ï¼Œä¼šå‘ç”Ÿä¸€ç§æœºæˆ¿é—´ç½‘ç»œçº¿è·¯æ•…éšœï¼Œå¯¼è‡´æœºæˆ¿é—´ç½‘ç»œä¸é€šï¼Œè€Œé›†ç¾¤è¢«å‰²è£‚æˆå‡ ä¸ªå°é›†ç¾¤ã€‚è¿™æ—¶å€™å­é›†ç¾¤å„è‡ªé€‰ä¸»å¯¼è‡´â€œè„‘è£‚â€çš„æƒ…å†µã€‚</p><p>ä¸¾ä¾‹è¯´æ˜ï¼šæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªç”± 6 å°æœåŠ¡å™¨æ‰€ç»„æˆçš„ä¸€ä¸ªé›†ç¾¤ï¼Œéƒ¨ç½²åœ¨äº† 2 ä¸ªæœºæˆ¿ï¼Œæ¯ä¸ªæœºæˆ¿ 3 å°ã€‚æ­£å¸¸æƒ…å†µä¸‹åªæœ‰ 1 ä¸ª leaderï¼Œä½†æ˜¯å½“ä¸¤ä¸ªæœºæˆ¿ä¸­é—´ç½‘ç»œæ–­å¼€çš„æ—¶å€™ï¼Œæ¯ä¸ªæœºæˆ¿çš„ 3 å°æœåŠ¡å™¨éƒ½ä¼šè®¤ä¸ºå¦ä¸€ä¸ªæœºæˆ¿çš„ 3 å°æœåŠ¡å™¨ä¸‹çº¿ï¼Œè€Œé€‰å‡ºè‡ªå·±çš„ leader å¹¶å¯¹å¤–æä¾›æœåŠ¡ã€‚è‹¥æ²¡æœ‰è¿‡åŠæœºåˆ¶ï¼Œå½“ç½‘ç»œæ¢å¤çš„æ—¶å€™ä¼šå‘ç°æœ‰ 2 ä¸ª leaderã€‚ä»¿ä½›æ˜¯ 1 ä¸ªå¤§è„‘ï¼ˆleaderï¼‰åˆ†æ•£æˆäº† 2 ä¸ªå¤§è„‘ï¼Œè¿™å°±å‘ç”Ÿäº†è„‘è£‚ç°è±¡ã€‚è„‘è£‚æœŸé—´ 2 ä¸ªå¤§è„‘éƒ½å¯èƒ½å¯¹å¤–æä¾›äº†æœåŠ¡ï¼Œè¿™å°†ä¼šå¸¦æ¥æ•°æ®ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚</p><p><strong>è¿‡åŠæœºåˆ¶æ˜¯å¦‚ä½•é˜²æ­¢è„‘è£‚ç°è±¡äº§ç”Ÿçš„ï¼Ÿ</strong></p><p>ZooKeeper çš„è¿‡åŠæœºåˆ¶å¯¼è‡´ä¸å¯èƒ½äº§ç”Ÿ 2 ä¸ª leaderï¼Œå› ä¸ºå°‘äºç­‰äºä¸€åŠæ˜¯ä¸å¯èƒ½äº§ç”Ÿ leader çš„ï¼Œè¿™å°±ä½¿å¾—ä¸è®ºæœºæˆ¿çš„æœºå™¨å¦‚ä½•åˆ†é…éƒ½ä¸å¯èƒ½å‘ç”Ÿè„‘è£‚ã€‚</p><h2 id="5-ZAB-åè®®å’Œ-Paxos-ç®—æ³•"><a href="#5-ZAB-åè®®å’Œ-Paxos-ç®—æ³•" class="headerlink" title="5. ZAB åè®®å’Œ Paxos ç®—æ³•"></a>5. ZAB åè®®å’Œ Paxos ç®—æ³•</h2><p>Paxos ç®—æ³•åº”è¯¥å¯ä»¥è¯´æ˜¯ ZooKeeper çš„çµé­‚äº†ã€‚ä½†æ˜¯ï¼ŒZooKeeper å¹¶æ²¡æœ‰å®Œå…¨é‡‡ç”¨ Paxos ç®—æ³• ï¼Œè€Œæ˜¯ä½¿ç”¨ ZAB åè®®ä½œä¸ºå…¶ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„æ ¸å¿ƒç®—æ³•ã€‚å¦å¤–ï¼Œåœ¨ ZooKeeper çš„å®˜æ–¹æ–‡æ¡£ä¸­ä¹ŸæŒ‡å‡ºï¼ŒZAB åè®®å¹¶ä¸åƒ Paxos ç®—æ³•é‚£æ ·ï¼Œæ˜¯ä¸€ç§é€šç”¨çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹åˆ«ä¸º Zookeeper è®¾è®¡çš„å´©æºƒå¯æ¢å¤çš„åŸå­æ¶ˆæ¯å¹¿æ’­ç®—æ³•ã€‚</p><h3 id="5-1-ZAB-åè®®ä»‹ç»"><a href="#5-1-ZAB-åè®®ä»‹ç»" class="headerlink" title="5.1. ZAB åè®®ä»‹ç»"></a>5.1. ZAB åè®®ä»‹ç»</h3><p>ZABï¼ˆZooKeeper Atomic Broadcast åŸå­å¹¿æ’­ï¼‰ åè®®æ˜¯ä¸ºåˆ†å¸ƒå¼åè°ƒæœåŠ¡ ZooKeeper ä¸“é—¨è®¾è®¡çš„ä¸€ç§æ”¯æŒå´©æºƒæ¢å¤çš„åŸå­å¹¿æ’­åè®®ã€‚ åœ¨ ZooKeeper ä¸­ï¼Œä¸»è¦ä¾èµ– ZAB åè®®æ¥å®ç°åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§ï¼ŒåŸºäºè¯¥åè®®ï¼ŒZooKeeper å®ç°äº†ä¸€ç§ä¸»å¤‡æ¨¡å¼çš„ç³»ç»Ÿæ¶æ„æ¥ä¿æŒé›†ç¾¤ä¸­å„ä¸ªå‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><h3 id="5-2-ZAB-åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­"><a href="#5-2-ZAB-åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­" class="headerlink" title="5.2. ZAB åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­"></a>5.2. ZAB åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­</h3><p>ZAB åè®®åŒ…æ‹¬ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯</p><ul><li><strong>å´©æºƒæ¢å¤</strong> ï¼šå½“æ•´ä¸ªæœåŠ¡æ¡†æ¶åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæˆ–æ˜¯å½“ Leader æœåŠ¡å™¨å‡ºç°ç½‘ç»œä¸­æ–­ã€å´©æºƒé€€å‡ºä¸é‡å¯ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼ŒZAB åè®®å°±ä¼šè¿›å…¥æ¢å¤æ¨¡å¼å¹¶é€‰ä¸¾äº§ç”Ÿæ–°çš„ Leader æœåŠ¡å™¨ã€‚å½“é€‰ä¸¾äº§ç”Ÿäº†æ–°çš„ Leader æœåŠ¡å™¨ï¼ŒåŒæ—¶é›†ç¾¤ä¸­å·²ç»æœ‰è¿‡åŠçš„æœºå™¨ä¸è¯¥ Leader æœåŠ¡å™¨å®Œæˆäº†çŠ¶æ€åŒæ­¥ä¹‹åï¼ŒZAB åè®®å°±ä¼šé€€å‡ºæ¢å¤æ¨¡å¼ã€‚å…¶ä¸­ï¼Œ<strong>æ‰€è°“çš„çŠ¶æ€åŒæ­¥æ˜¯æŒ‡æ•°æ®åŒæ­¥ï¼Œç”¨æ¥ä¿è¯é›†ç¾¤ä¸­å­˜åœ¨è¿‡åŠçš„æœºå™¨èƒ½å¤Ÿå’Œ Leader æœåŠ¡å™¨çš„æ•°æ®çŠ¶æ€ä¿æŒä¸€è‡´</strong>ã€‚</li><li><strong>æ¶ˆæ¯å¹¿æ’­</strong> ï¼š<strong>å½“é›†ç¾¤ä¸­å·²ç»æœ‰è¿‡åŠçš„ Follower æœåŠ¡å™¨å®Œæˆäº†å’Œ Leader æœåŠ¡å™¨çš„çŠ¶æ€åŒæ­¥ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡æ¡†æ¶å°±å¯ä»¥è¿›å…¥æ¶ˆæ¯å¹¿æ’­æ¨¡å¼äº†ã€‚</strong> å½“ä¸€å°åŒæ ·éµå®ˆ ZAB åè®®çš„æœåŠ¡å™¨å¯åŠ¨ååŠ å…¥åˆ°é›†ç¾¤ä¸­æ—¶ï¼Œå¦‚æœæ­¤æ—¶é›†ç¾¤ä¸­å·²ç»å­˜åœ¨ä¸€ä¸ª Leader æœåŠ¡å™¨åœ¨è´Ÿè´£è¿›è¡Œæ¶ˆæ¯å¹¿æ’­ï¼Œé‚£ä¹ˆæ–°åŠ å…¥çš„æœåŠ¡å™¨å°±ä¼šè‡ªè§‰åœ°è¿›å…¥æ•°æ®æ¢å¤æ¨¡å¼ï¼šæ‰¾åˆ° Leader æ‰€åœ¨çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸å…¶è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œç„¶åä¸€èµ·å‚ä¸åˆ°æ¶ˆæ¯å¹¿æ’­æµç¨‹ä¸­å»ã€‚</li></ul><p>å…³äº <strong>ZAB åè®®&amp;Paxos ç®—æ³•</strong> éœ€è¦è®²å’Œç†è§£çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li><a target="_blank" rel="noopener" href="http://codemacro.com/2014/10/15/explain-poxos/">å›¾è§£ Paxos ä¸€è‡´æ€§åè®®</a></li><li><a target="_blank" rel="noopener" href="https://dbaplus.cn/news-141-1875-1.html">Zookeeper ZAB åè®®åˆ†æ</a></li></ul><h2 id="6-æ€»ç»“"><a href="#6-æ€»ç»“" class="headerlink" title="6. æ€»ç»“"></a>6. æ€»ç»“</h2><ol><li>ZooKeeper æœ¬èº«å°±æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç¨‹åºï¼ˆåªè¦åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å­˜æ´»ï¼ŒZooKeeper å°±èƒ½æ­£å¸¸æœåŠ¡ï¼‰ã€‚</li><li>ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œæœ€å¥½æ˜¯ä»¥é›†ç¾¤å½¢æ€æ¥éƒ¨ç½² ZooKeeperï¼Œè¿™æ ·åªè¦é›†ç¾¤ä¸­å¤§éƒ¨åˆ†æœºå™¨æ˜¯å¯ç”¨çš„ï¼ˆèƒ½å¤Ÿå®¹å¿ä¸€å®šçš„æœºå™¨æ•…éšœï¼‰ï¼Œé‚£ä¹ˆ ZooKeeper æœ¬èº«ä»ç„¶æ˜¯å¯ç”¨çš„ã€‚</li><li>ZooKeeper å°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè¿™ä¹Ÿå°±ä¿è¯äº† é«˜ååé‡å’Œä½å»¶è¿Ÿï¼ˆä½†æ˜¯å†…å­˜é™åˆ¶äº†èƒ½å¤Ÿå­˜å‚¨çš„å®¹é‡ä¸å¤ªå¤§ï¼Œæ­¤é™åˆ¶ä¹Ÿæ˜¯ä¿æŒ znode ä¸­å­˜å‚¨çš„æ•°æ®é‡è¾ƒå°çš„è¿›ä¸€æ­¥åŸå› ï¼‰ã€‚</li><li>ZooKeeper æ˜¯é«˜æ€§èƒ½çš„ã€‚ åœ¨â€œè¯»â€å¤šäºâ€œå†™â€çš„åº”ç”¨ç¨‹åºä¸­å°¤å…¶åœ°æ˜æ˜¾ï¼Œå› ä¸ºâ€œå†™â€ä¼šå¯¼è‡´æ‰€æœ‰çš„æœåŠ¡å™¨é—´åŒæ­¥çŠ¶æ€ã€‚ï¼ˆâ€œè¯»â€å¤šäºâ€œå†™â€æ˜¯åè°ƒæœåŠ¡çš„å…¸å‹åœºæ™¯ã€‚ï¼‰</li><li>ZooKeeper æœ‰ä¸´æ—¶èŠ‚ç‚¹çš„æ¦‚å¿µã€‚ å½“åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¼šè¯ä¸€ç›´ä¿æŒæ´»åŠ¨ï¼Œç¬æ—¶èŠ‚ç‚¹å°±ä¸€ç›´å­˜åœ¨ã€‚è€Œå½“ä¼šè¯ç»ˆç»“æ—¶ï¼Œç¬æ—¶èŠ‚ç‚¹è¢«åˆ é™¤ã€‚æŒä¹…èŠ‚ç‚¹æ˜¯æŒ‡ä¸€æ—¦è¿™ä¸ª znode è¢«åˆ›å»ºäº†ï¼Œé™¤éä¸»åŠ¨è¿›è¡Œ znode çš„ç§»é™¤æ“ä½œï¼Œå¦åˆ™è¿™ä¸ª znode å°†ä¸€ç›´ä¿å­˜åœ¨ ZooKeeper ä¸Šã€‚</li><li>ZooKeeper åº•å±‚å…¶å®åªæä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼šâ‘  ç®¡ç†ï¼ˆå­˜å‚¨ã€è¯»å–ï¼‰ç”¨æˆ·ç¨‹åºæäº¤çš„æ•°æ®ï¼›â‘¡ ä¸ºç”¨æˆ·ç¨‹åºæä¾›æ•°æ®èŠ‚ç‚¹ç›‘å¬æœåŠ¡ã€‚</li></ol><h2 id="7-å‚è€ƒ"><a href="#7-å‚è€ƒ" class="headerlink" title="7. å‚è€ƒ"></a>7. å‚è€ƒ</h2><ol><li>ã€Šä» Paxos åˆ° ZooKeeper åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/17/2021-12-30-ZooKeeper%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E4%BA%8C%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/17/2021-12-30-ZooKeeper%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">ZooKeeperåŸºç¡€çŸ¥è¯†ï¼ˆäºŒï¼‰</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-17 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-17T19:30:00+08:00">2021-02-17</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-å¥½ä¹…ä¸è§"><a href="#1-å¥½ä¹…ä¸è§" class="headerlink" title="1. å¥½ä¹…ä¸è§"></a>1. å¥½ä¹…ä¸è§</h2><blockquote><p>æ–‡ç« å¾ˆé•¿ï¼Œå…ˆèµåçœ‹ï¼Œå…»æˆä¹ æƒ¯ã€‚â¤ï¸ ğŸ§¡ ğŸ’› ğŸ’š ğŸ’™ ğŸ’œ</p></blockquote><h2 id="2-ä»€ä¹ˆæ˜¯ZooKeeper"><a href="#2-ä»€ä¹ˆæ˜¯ZooKeeper" class="headerlink" title="2. ä»€ä¹ˆæ˜¯ZooKeeper"></a>2. ä»€ä¹ˆæ˜¯ZooKeeper</h2><p><code>ZooKeeper</code> ç”± <code>Yahoo</code> å¼€å‘ï¼Œåæ¥æèµ ç»™äº† <code>Apache</code> ï¼Œç°å·²æˆä¸º <code>Apache</code> é¡¶çº§é¡¹ç›®ã€‚<code>ZooKeeper</code> æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡å™¨ï¼Œå…¶ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæä¾›ä¸€è‡´æ€§æœåŠ¡ã€‚å…¶ä¸€è‡´æ€§æ˜¯é€šè¿‡åŸºäº <code>Paxos</code> ç®—æ³•çš„ <code>ZAB</code> åè®®å®Œæˆçš„ã€‚å…¶ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼šé…ç½®ç»´æŠ¤ã€åˆ†å¸ƒå¼åŒæ­¥ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼äº‹åŠ¡ç­‰ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f61e695882d4e6820fc5e9b9c37dfd61f5d606c8b7385687777ea7fc995a32d9/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37633334393839316237373336373135313461363866303537623265313466382e706e67"><img src="https://img-blog.csdnimg.cn/img_convert/7c349891b773671514a68f057b2e14f8.png" alt="zookeeper"></a></p><p>ç®€å•æ¥è¯´ï¼Œ <code>ZooKeeper</code> æ˜¯ä¸€ä¸ª <strong>åˆ†å¸ƒå¼åè°ƒæœåŠ¡æ¡†æ¶</strong> ã€‚åˆ†å¸ƒå¼ï¼Ÿåè°ƒæœåŠ¡ï¼Ÿè¿™å•¥ç©æ„ï¼ŸğŸ¤”ğŸ¤”</p><p>å…¶å®è§£é‡Šåˆ°åˆ†å¸ƒå¼è¿™ä¸ªæ¦‚å¿µçš„æ—¶å€™ï¼Œæˆ‘å‘ç°æœ‰äº›åŒå­¦å¹¶ä¸æ˜¯èƒ½æŠŠ **åˆ†å¸ƒå¼å’Œé›†ç¾¤ **è¿™ä¸¤ä¸ªæ¦‚å¿µå¾ˆå¥½çš„ç†è§£é€ã€‚å‰æ®µæ—¶é—´æœ‰åŒå­¦å’Œæˆ‘æ¢è®¨èµ·åˆ†å¸ƒå¼çš„ä¸œè¥¿ï¼Œä»–è¯´åˆ†å¸ƒå¼ä¸å°±æ˜¯åŠ æœºå™¨å—ï¼Ÿä¸€å°æœºå™¨ä¸å¤Ÿç”¨å†åŠ ä¸€å°æŠ—å‹å‘—ã€‚å½“ç„¶åŠ æœºå™¨è¿™ç§è¯´æ³•ä¹Ÿæ— å¯åšéï¼Œä½ ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…å®šæ¶‰åŠåˆ°å¤šä¸ªæœºå™¨ï¼Œä½†æ˜¯ä½ åˆ«å¿˜äº†ï¼Œè®¡ç®—æœºå­¦ç§‘ä¸­è¿˜æœ‰ä¸€ä¸ªç›¸ä¼¼çš„æ¦‚å¿µâ€”â€” <code>Cluster</code> ï¼Œé›†ç¾¤ä¸ä¹Ÿæ˜¯åŠ æœºå™¨å—ï¼Ÿä½†æ˜¯ é›†ç¾¤ å’Œ åˆ†å¸ƒå¼ å…¶å®å°±æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æ¦‚å¿µã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªç§’æ€æœåŠ¡ï¼Œå¹¶å‘é‡å¤ªå¤§å•æœºç³»ç»Ÿæ‰¿å—ä¸ä½ï¼Œé‚£æˆ‘åŠ å‡ å°æœåŠ¡å™¨ä¹Ÿ <strong>ä¸€æ ·</strong> æä¾›ç§’æ€æœåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯ <strong><code>Cluster</code> é›†ç¾¤</strong> ã€‚</p><p><img src="https://img-blog.csdnimg.cn/img_convert/ffcb080eb66f242ffcd8d2047a7f46aa.png" alt="cluster"></p><p>ä½†æ˜¯ï¼Œæˆ‘ç°åœ¨æ¢ä¸€ç§æ–¹å¼ï¼Œæˆ‘å°†ä¸€ä¸ªç§’æ€æœåŠ¡ <strong>æ‹†åˆ†æˆå¤šä¸ªå­æœåŠ¡</strong> ï¼Œæ¯”å¦‚åˆ›å»ºè®¢å•æœåŠ¡ï¼Œå¢åŠ ç§¯åˆ†æœåŠ¡ï¼Œæ‰£ä¼˜æƒ åˆ¸æœåŠ¡ç­‰ç­‰ï¼Œ<strong>ç„¶åæˆ‘å°†è¿™äº›å­æœåŠ¡éƒ½éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Š</strong> ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯ <strong><code>Distributed</code> åˆ†å¸ƒå¼</strong> ã€‚</p><p><img src="https://img-blog.csdnimg.cn/img_convert/07191f38aa947b0075e5c0a6a019a11d.png" alt="distributed"></p><p>è€Œæˆ‘ä¸ºä»€ä¹ˆåé©³åŒå­¦æ‰€è¯´çš„åˆ†å¸ƒå¼å°±æ˜¯åŠ æœºå™¨å‘¢ï¼Ÿå› ä¸ºæˆ‘è®¤ä¸ºåŠ æœºå™¨æ›´åŠ é€‚ç”¨äºæ„å»ºé›†ç¾¤ï¼Œå› ä¸ºå®ƒçœŸæ˜¯åªæœ‰åŠ æœºå™¨ã€‚è€Œå¯¹äºåˆ†å¸ƒå¼æ¥è¯´ï¼Œä½ é¦–å…ˆéœ€è¦å°†ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åå†åŠ æœºå™¨ï¼ˆä¸ä»…ä»…æ˜¯åŠ æœºå™¨é‚£ä¹ˆç®€å•ï¼‰ï¼ŒåŒæ—¶ä½ è¿˜è¦å»è§£å†³åˆ†å¸ƒå¼å¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚</p><p><img src="https://img-blog.csdnimg.cn/img_convert/2b2fbc21abfb3f6547a2121f28c6d00f.png" alt="img"></p><p>æ¯”å¦‚å„ä¸ªåˆ†å¸ƒå¼ç»„ä»¶å¦‚ä½•åè°ƒèµ·æ¥ï¼Œå¦‚ä½•å‡å°‘å„ä¸ªç³»ç»Ÿä¹‹é—´çš„è€¦åˆåº¦ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„å¤„ç†ï¼Œå¦‚ä½•å»é…ç½®æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿç­‰ç­‰ã€‚<code>ZooKeeper</code> ä¸»è¦å°±æ˜¯è§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p><h2 id="3-ä¸€è‡´æ€§é—®é¢˜"><a href="#3-ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="3. ä¸€è‡´æ€§é—®é¢˜"></a>3. ä¸€è‡´æ€§é—®é¢˜</h2><p>è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…å®šä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜â€”â€” <strong>å› ä¸ºåˆ†åŒºå®¹å¿æ€§ï¼ˆpartition toleranceï¼‰çš„å­˜åœ¨ï¼Œå°±å¿…å®šè¦æ±‚æˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿå¯ç”¨æ€§ï¼ˆavailabilityï¼‰å’Œæ•°æ®ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ä¸­åšå‡ºæƒè¡¡</strong> ã€‚è¿™å°±æ˜¯è‘—åçš„ <code>CAP</code> å®šç†ã€‚</p><p>ç†è§£èµ·æ¥å…¶å®å¾ˆç®€å•ï¼Œæ¯”å¦‚è¯´æŠŠä¸€ä¸ªç­çº§ä½œä¸ºæ•´ä¸ªç³»ç»Ÿï¼Œè€Œå­¦ç”Ÿæ˜¯ç³»ç»Ÿä¸­çš„ä¸€ä¸ªä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿã€‚è¿™ä¸ªæ—¶å€™ç­é‡Œçš„å°çº¢å°æ˜å·å·è°ˆæ‹çˆ±è¢«ç­é‡Œçš„å¤§å˜´å·´å°èŠ±å‘ç°äº†ï¼Œå°èŠ±æ¬£å–œè‹¥ç‹‚å‘Šè¯‰äº†å‘¨å›´çš„äººï¼Œç„¶åå°çº¢å°æ˜è°ˆæ‹çˆ±çš„æ¶ˆæ¯åœ¨ç­çº§é‡Œä¼ æ’­èµ·æ¥äº†ã€‚å½“åœ¨æ¶ˆæ¯çš„ä¼ æ’­ï¼ˆæ•£å¸ƒï¼‰è¿‡ç¨‹ä¸­ï¼Œä½ æŠ“åˆ°ä¸€ä¸ªåŒå­¦é—®ä»–ä»¬çš„æƒ…å†µï¼Œå¦‚æœå›ç­”ä½ ä¸çŸ¥é“ï¼Œé‚£ä¹ˆè¯´æ˜æ•´ä¸ªç­çº§ç³»ç»Ÿå‡ºç°äº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆå› ä¸ºå°èŠ±å·²ç»çŸ¥é“è¿™ä¸ªæ¶ˆæ¯äº†ï¼‰ã€‚è€Œå¦‚æœä»–ç›´æ¥ä¸å›ç­”ä½ ï¼Œå› ä¸ºæ•´ä¸ªç­çº§æœ‰æ¶ˆæ¯åœ¨è¿›è¡Œä¼ æ’­ï¼ˆä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œéœ€è¦æ‰€æœ‰äººéƒ½çŸ¥é“æ‰å¯æä¾›æœåŠ¡ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±å‡ºç°äº†ç³»ç»Ÿçš„å¯ç”¨æ€§é—®é¢˜ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d5cf7c19c674ced29a7a1d71795941b0961087c402a8017859bd7c457379de83/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f33346666666634316636636134663232316361396439616436663062353437302e706e67"><img src="https://camo.githubusercontent.com/d5cf7c19c674ced29a7a1d71795941b0961087c402a8017859bd7c457379de83/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f33346666666634316636636134663232316361396439616436663062353437302e706e67" alt="img"></a></p><p>è€Œä¸Šè¿°å‰è€…å°±æ˜¯ <code>Eureka</code> çš„å¤„ç†æ–¹å¼ï¼Œå®ƒä¿è¯äº†APï¼ˆå¯ç”¨æ€§ï¼‰ï¼Œåè€…å°±æ˜¯æˆ‘ä»¬ä»Šå¤©æ‰€è¦è®²çš„ <code>ZooKeeper</code> çš„å¤„ç†æ–¹å¼ï¼Œå®ƒä¿è¯äº†CPï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰ã€‚</p><h2 id="4-ä¸€è‡´æ€§åè®®å’Œç®—æ³•"><a href="#4-ä¸€è‡´æ€§åè®®å’Œç®—æ³•" class="headerlink" title="4. ä¸€è‡´æ€§åè®®å’Œç®—æ³•"></a>4. ä¸€è‡´æ€§åè®®å’Œç®—æ³•</h2><p>è€Œä¸ºäº†è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œåœ¨ç§‘å­¦å®¶å’Œç¨‹åºå‘˜çš„ä¸æ–­æ¢ç´¢ä¸­ï¼Œå°±å‡ºç°äº†å¾ˆå¤šçš„ä¸€è‡´æ€§åè®®å’Œç®—æ³•ã€‚æ¯”å¦‚ 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ï¼Œ3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰ï¼ŒPaxosç®—æ³•ç­‰ç­‰ã€‚</p><p>è¿™æ—¶å€™è¯·ä½ æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼ŒåŒå­¦ä¹‹é—´å¦‚æœé‡‡ç”¨ä¼ çº¸æ¡çš„æ–¹å¼å»ä¼ æ’­æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜â€”â€”æˆ‘å’‹çŸ¥é“æˆ‘çš„å°çº¸æ¡æœ‰æ²¡æœ‰ä¼ åˆ°æˆ‘æƒ³è¦ä¼ é€’çš„é‚£ä¸ªäººæ‰‹ä¸­å‘¢ï¼Ÿä¸‡ä¸€è¢«å“ªä¸ªå°å®¶ä¼™ç»™åŠ«æŒç¯¡æ”¹äº†å‘¢ï¼Œå¯¹å§ï¼Ÿ</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ccbffd4b7bfc60eb24b17ecb6deb520b1c21f44a3b557d3dfd4af38c94eca760/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62306530316665333231336463633135333563333132393862613962646662632e706e67"><img src="https://camo.githubusercontent.com/ccbffd4b7bfc60eb24b17ecb6deb520b1c21f44a3b557d3dfd4af38c94eca760/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62306530316665333231336463633135333563333132393862613962646662632e706e67" alt="img"></a></p><p>è¿™ä¸ªæ—¶å€™å°±å¼•ç”³å‡ºä¸€ä¸ªæ¦‚å¿µâ€”â€” <strong>æ‹œå åº­å°†å†›é—®é¢˜</strong> ã€‚å®ƒæ„æŒ‡ <strong>åœ¨ä¸å¯é ä¿¡é“ä¸Šè¯•å›¾é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼è¾¾åˆ°ä¸€è‡´æ€§æ˜¯ä¸å¯èƒ½çš„</strong>ï¼Œ æ‰€ä»¥æ‰€æœ‰çš„ä¸€è‡´æ€§ç®—æ³•çš„ <strong>å¿…è¦å‰æ</strong> å°±æ˜¯å®‰å…¨å¯é çš„æ¶ˆæ¯é€šé“ã€‚</p><p>è€Œä¸ºä»€ä¹ˆè¦å»è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Ÿä½ æƒ³æƒ³ï¼Œå¦‚æœä¸€ä¸ªç§’æ€ç³»ç»Ÿå°†æœåŠ¡æ‹†åˆ†æˆäº†ä¸‹è®¢å•å’ŒåŠ ç§¯åˆ†æœåŠ¡ï¼Œè¿™ä¸¤ä¸ªæœåŠ¡éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨ä¸Šäº†ï¼Œä¸‡ä¸€åœ¨æ¶ˆæ¯çš„ä¼ æ’­è¿‡ç¨‹ä¸­ç§¯åˆ†ç³»ç»Ÿå®•æœºäº†ï¼Œæ€»ä¸èƒ½ä½ è¿™è¾¹ä¸‹äº†è®¢å•å´æ²¡åŠ ç§¯åˆ†å§ï¼Ÿä½ æ€»å¾—ä¿è¯ä¸¤è¾¹çš„æ•°æ®éœ€è¦ä¸€è‡´å§ï¼Ÿ</p><h3 id="4-1-2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"><a href="#4-1-2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰" class="headerlink" title="4.1. 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"></a>4.1. 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰</h3><p>ä¸¤é˜¶æ®µæäº¤æ˜¯ä¸€ç§ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§çš„åè®®ï¼Œç°åœ¨å¾ˆå¤šæ•°æ®åº“éƒ½æ˜¯é‡‡ç”¨çš„ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®Œæˆ <strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong> çš„å¤„ç†ã€‚</p><p>åœ¨ä»‹ç»2PCä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æƒ³æƒ³åˆ†å¸ƒå¼äº‹åŠ¡åˆ°åº•æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p><p>è¿˜æ‹¿ç§’æ€ç³»ç»Ÿçš„ä¸‹è®¢å•å’ŒåŠ ç§¯åˆ†ä¸¤ä¸ªç³»ç»Ÿæ¥ä¸¾ä¾‹å§ï¼ˆæˆ‘æƒ³ä½ ä»¬å¯èƒ½éƒ½åäº†ğŸ¤®ğŸ¤®ğŸ¤®ï¼‰ï¼Œæˆ‘ä»¬æ­¤æ—¶ä¸‹å®Œè®¢å•ä¼šå‘ä¸ªæ¶ˆæ¯ç»™ç§¯åˆ†ç³»ç»Ÿå‘Šè¯‰å®ƒä¸‹é¢è¯¥å¢åŠ ç§¯åˆ†äº†ã€‚å¦‚æœæˆ‘ä»¬ä»…ä»…æ˜¯å‘é€ä¸€ä¸ªæ¶ˆæ¯ä¹Ÿä¸æ”¶å›å¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è®¢å•ç³»ç»Ÿæ€ä¹ˆèƒ½çŸ¥é“ç§¯åˆ†ç³»ç»Ÿçš„æ”¶åˆ°æ¶ˆæ¯çš„æƒ…å†µå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬å¢åŠ ä¸€ä¸ªæ”¶å›å¤çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆå½“ç§¯åˆ†ç³»ç»Ÿæ”¶åˆ°æ¶ˆæ¯åè¿”å›ç»™è®¢å•ç³»ç»Ÿä¸€ä¸ª <code>Response</code> ï¼Œä½†åœ¨ä¸­é—´å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨ï¼Œé‚£ä¸ªå›å¤æ¶ˆæ¯æ²¡æœ‰å‘é€æˆåŠŸï¼Œè®¢å•ç³»ç»Ÿæ˜¯ä¸æ˜¯ä»¥ä¸ºç§¯åˆ†ç³»ç»Ÿæ¶ˆæ¯æ¥æ”¶å¤±è´¥äº†ï¼Ÿå®ƒæ˜¯ä¸æ˜¯ä¼šå›æ»šäº‹åŠ¡ï¼Ÿä½†æ­¤æ—¶ç§¯åˆ†ç³»ç»Ÿæ˜¯æˆåŠŸæ”¶åˆ°æ¶ˆæ¯çš„ï¼Œå®ƒå°±ä¼šå»å¤„ç†æ¶ˆæ¯ç„¶åç»™ç”¨æˆ·å¢åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°ç§¯åˆ†åŠ äº†ä½†æ˜¯è®¢å•æ²¡ä¸‹æˆåŠŸã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æ‰€éœ€è¦è§£å†³çš„æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•´ä¸ªè°ƒç”¨é“¾ä¸­ï¼Œæˆ‘ä»¬æ‰€æœ‰æœåŠ¡çš„æ•°æ®å¤„ç†è¦ä¹ˆéƒ½æˆåŠŸè¦ä¹ˆéƒ½å¤±è´¥ï¼Œå³æ‰€æœ‰æœåŠ¡çš„ <strong>åŸå­æ€§é—®é¢˜</strong> ã€‚</p><p>åœ¨ä¸¤é˜¶æ®µæäº¤ä¸­ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯åè°ƒè€…å’Œå‚ä¸è€…ã€‚</p><p>ç¬¬ä¸€é˜¶æ®µï¼šå½“è¦æ‰§è¡Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ—¶å€™ï¼Œäº‹åŠ¡å‘èµ·è€…é¦–å…ˆå‘åè°ƒè€…å‘èµ·äº‹åŠ¡è¯·æ±‚ï¼Œç„¶ååè°ƒè€…ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <code>prepare</code> è¯·æ±‚ï¼ˆå…¶ä¸­åŒ…æ‹¬äº‹åŠ¡å†…å®¹ï¼‰å‘Šè¯‰å‚ä¸è€…ä½ ä»¬éœ€è¦æ‰§è¡Œäº‹åŠ¡äº†ï¼Œå¦‚æœèƒ½æ‰§è¡Œæˆ‘å‘çš„äº‹åŠ¡å†…å®¹é‚£ä¹ˆå°±å…ˆæ‰§è¡Œä½†ä¸æäº¤ï¼Œæ‰§è¡Œåè¯·ç»™æˆ‘å›å¤ã€‚ç„¶åå‚ä¸è€…æ”¶åˆ° <code>prepare</code> æ¶ˆæ¯åï¼Œä»–ä»¬ä¼šå¼€å§‹æ‰§è¡Œäº‹åŠ¡ï¼ˆä½†ä¸æäº¤ï¼‰ï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œä¹‹åå‚ä¸è€…å°±å‘åè°ƒè€…åé¦ˆæ˜¯å¦å‡†å¤‡å¥½äº†ã€‚</p><p>ç¬¬äºŒé˜¶æ®µï¼šç¬¬äºŒé˜¶æ®µä¸»è¦æ˜¯åè°ƒè€…æ ¹æ®å‚ä¸è€…åé¦ˆçš„æƒ…å†µæ¥å†³å®šæ¥ä¸‹æ¥æ˜¯å¦å¯ä»¥è¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œï¼Œå³æäº¤äº‹åŠ¡æˆ–è€…å›æ»šäº‹åŠ¡ã€‚</p><p>æ¯”å¦‚è¿™ä¸ªæ—¶å€™ <strong>æ‰€æœ‰çš„å‚ä¸è€…</strong> éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å°±è¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œåè°ƒè€…æ­¤æ—¶ä¼šç»™æ‰€æœ‰çš„å‚ä¸è€…å‘é€ <strong><code>Commit</code> è¯·æ±‚</strong> ï¼Œå½“å‚ä¸è€…æ”¶åˆ° <code>Commit</code> è¯·æ±‚çš„æ—¶å€™ä¼šæ‰§è¡Œå‰é¢æ‰§è¡Œçš„äº‹åŠ¡çš„ <strong>æäº¤æ“ä½œ</strong> ï¼Œæäº¤å®Œæ¯•ä¹‹åå°†ç»™åè°ƒè€…å‘é€æäº¤æˆåŠŸçš„å“åº”ã€‚</p><p>è€Œå¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µå¹¶ä¸æ˜¯æ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ­¤æ—¶åè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <strong>å›æ»šäº‹åŠ¡çš„ <code>rollback</code> è¯·æ±‚</strong>ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå°†ä¼š <strong>å›æ»šå®ƒåœ¨ç¬¬ä¸€é˜¶æ®µæ‰€åšçš„äº‹åŠ¡å¤„ç†</strong> ï¼Œç„¶åå†å°†å¤„ç†æƒ…å†µè¿”å›ç»™åè°ƒè€…ï¼Œæœ€ç»ˆåè°ƒè€…æ”¶åˆ°å“åº”åä¾¿ç»™äº‹åŠ¡å‘èµ·è€…è¿”å›å¤„ç†å¤±è´¥çš„ç»“æœã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/36a877fb15e7da608af2f12c5279424b796782ff1075e2fffd1351e8180af7db/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37636534653430623638643632353637366262343263323965666365303436612e706e67"><img src="https://camo.githubusercontent.com/36a877fb15e7da608af2f12c5279424b796782ff1075e2fffd1351e8180af7db/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37636534653430623638643632353637366262343263323965666365303436612e706e67" alt="2PCæµç¨‹"></a></p><p>ä¸ªäººè§‰å¾— 2PC å®ç°å¾—è¿˜æ˜¯æ¯”è¾ƒé¸¡è‚‹çš„ï¼Œå› ä¸ºäº‹å®ä¸Šå®ƒåªè§£å†³äº†å„ä¸ªäº‹åŠ¡çš„åŸå­æ€§é—®é¢˜ï¼Œéšä¹‹ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šçš„é—®é¢˜ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/8a9f827367cc9e4971b6fd22580e28734d3913244bcb85e829598f0be44d7035/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f39616631616436383531373536316138653966356433343535613332313332642e706e67"><img src="https://camo.githubusercontent.com/8a9f827367cc9e4971b6fd22580e28734d3913244bcb85e829598f0be44d7035/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f39616631616436383531373536316138653966356433343535613332313332642e706e67" alt="img"></a></p><ul><li><strong>å•ç‚¹æ•…éšœé—®é¢˜</strong>ï¼Œå¦‚æœåè°ƒè€…æŒ‚äº†é‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿéƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€äº†ã€‚</li><li><strong>é˜»å¡é—®é¢˜</strong>ï¼Œå³å½“åè°ƒè€…å‘é€ <code>prepare</code> è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå¦‚æœèƒ½å¤„ç†é‚£ä¹ˆå®ƒå°†ä¼šè¿›è¡Œäº‹åŠ¡çš„å¤„ç†ä½†å¹¶ä¸æäº¤ï¼Œè¿™ä¸ªæ—¶å€™ä¼šä¸€ç›´å ç”¨ç€èµ„æºä¸é‡Šæ”¾ï¼Œå¦‚æœæ­¤æ—¶åè°ƒè€…æŒ‚äº†ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºéƒ½ä¸ä¼šå†é‡Šæ”¾äº†ï¼Œè¿™ä¼šæå¤§å½±å“æ€§èƒ½ã€‚</li><li><strong>æ•°æ®ä¸ä¸€è‡´é—®é¢˜</strong>ï¼Œæ¯”å¦‚å½“ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…åªå‘é€äº†ä¸€éƒ¨åˆ†çš„ <code>commit</code> è¯·æ±‚å°±æŒ‚äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€ï¼Œæ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œè€Œåé¢æ²¡æ”¶åˆ°çš„åˆ™ä¸ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</li></ul><h3 id="4-2-3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰"><a href="#4-2-3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰" class="headerlink" title="4.2. 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰"></a>4.2. 3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰</h3><p>å› ä¸º2PCå­˜åœ¨çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œæ¯”å¦‚å•ç‚¹ï¼Œå®¹é”™æœºåˆ¶ç¼ºé™·ç­‰ç­‰ï¼Œä»è€Œäº§ç”Ÿäº† <strong>3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰</strong> ã€‚é‚£ä¹ˆè¿™ä¸‰é˜¶æ®µåˆåˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>åƒä¸‡ä¸è¦å§PCç†è§£æˆä¸ªäººç”µè„‘äº†ï¼Œå…¶å®ä»–ä»¬æ˜¯ phase-commit çš„ç¼©å†™ï¼Œå³é˜¶æ®µæäº¤ã€‚</p></blockquote><ol><li><strong>CanCommité˜¶æ®µ</strong>ï¼šåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>CanCommit</code> è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°è¯·æ±‚åä¼šæ ¹æ®è‡ªèº«æƒ…å†µæŸ¥çœ‹æ˜¯å¦èƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œå¦‚æœå¯ä»¥åˆ™è¿”å› YES å“åº”å¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™è¿”å› NO ã€‚</li><li><strong>PreCommité˜¶æ®µ</strong>ï¼šåè°ƒè€…æ ¹æ®å‚ä¸è€…è¿”å›çš„å“åº”æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œä¸‹é¢çš„ <code>PreCommit</code> æ“ä½œã€‚å¦‚æœä¸Šé¢å‚ä¸è€…è¿”å›çš„éƒ½æ˜¯ YESï¼Œé‚£ä¹ˆåè°ƒè€…å°†å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>PreCommit</code> é¢„æäº¤è¯·æ±‚ï¼Œ<strong>å‚ä¸è€…æ”¶åˆ°é¢„æäº¤è¯·æ±‚åï¼Œä¼šè¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œæ“ä½œï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ä¸­</strong> ï¼Œæœ€åå¦‚æœå‚ä¸è€…é¡ºåˆ©æ‰§è¡Œäº†äº‹åŠ¡åˆ™ç»™åè°ƒè€…è¿”å›æˆåŠŸçš„å“åº”ã€‚å¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µåè°ƒè€…æ”¶åˆ°äº† <strong>ä»»ä½•ä¸€ä¸ª NO</strong> çš„ä¿¡æ¯ï¼Œæˆ–è€… <strong>åœ¨ä¸€å®šæ—¶é—´å†…</strong> å¹¶æ²¡æœ‰æ”¶åˆ°å…¨éƒ¨çš„å‚ä¸è€…çš„å“åº”ï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡ï¼Œå®ƒä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€ä¸­æ–­è¯·æ±‚ï¼ˆabortï¼‰ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ä¹‹åä¼šç«‹å³ä¸­æ–­äº‹åŠ¡ï¼Œæˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åè°ƒè€…çš„è¯·æ±‚ï¼Œå®ƒä¹Ÿä¼šä¸­æ–­äº‹åŠ¡ã€‚</li><li><strong>DoCommité˜¶æ®µ</strong>ï¼šè¿™ä¸ªé˜¶æ®µå…¶å®å’Œ <code>2PC</code> çš„ç¬¬äºŒé˜¶æ®µå·®ä¸å¤šï¼Œå¦‚æœåè°ƒè€…æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…åœ¨ <code>PreCommit</code> é˜¶æ®µçš„ YES å“åº”ï¼Œé‚£ä¹ˆåè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <code>DoCommit</code> è¯·æ±‚ï¼Œ<strong>å‚ä¸è€…æ”¶åˆ° <code>DoCommit</code> è¯·æ±‚ååˆ™ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤å·¥ä½œ</strong>ï¼Œå®Œæˆååˆ™ä¼šç»™åè°ƒè€…è¿”å›å“åº”ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…è¿”å›çš„äº‹åŠ¡æäº¤æˆåŠŸçš„å“åº”ä¹‹ååˆ™å®Œæˆäº‹åŠ¡ã€‚è‹¥åè°ƒè€…åœ¨ <code>PreCommit</code> é˜¶æ®µ <strong>æ”¶åˆ°äº†ä»»ä½•ä¸€ä¸ª NO æˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„å“åº”</strong> ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œä¸­æ–­è¯·æ±‚çš„å‘é€ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ååˆ™ä¼š <strong>é€šè¿‡ä¸Šé¢è®°å½•çš„å›æ»šæ—¥å¿—</strong> æ¥è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œå¹¶å‘åè°ƒè€…åé¦ˆå›æ»šçŠ¶å†µï¼Œåè°ƒè€…æ”¶åˆ°å‚ä¸è€…è¿”å›çš„æ¶ˆæ¯åï¼Œä¸­æ–­äº‹åŠ¡ã€‚</li></ol><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/1f5526f43f64af9da097a3e968567288354283c2abb7f997c90ed24ca969350f/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f64306234343336316337343635393366373061366534326332393862343133612e706e67"><img src="https://camo.githubusercontent.com/1f5526f43f64af9da097a3e968567288354283c2abb7f997c90ed24ca969350f/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f64306234343336316337343635393366373061366534326332393862343133612e706e67" alt="3PCæµç¨‹"></a></p><blockquote><p>è¿™é‡Œæ˜¯ <code>3PC</code> åœ¨æˆåŠŸçš„ç¯å¢ƒä¸‹çš„æµç¨‹å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>3PC</code> åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œäº†è¶…æ—¶ä¸­æ–­çš„å¤„ç†ï¼Œæ¯”å¦‚åè°ƒè€…åœ¨æŒ‡å®šæ—¶é—´å†…ä¸ºæ”¶åˆ°å…¨éƒ¨çš„ç¡®è®¤æ¶ˆæ¯åˆ™è¿›è¡Œäº‹åŠ¡ä¸­æ–­çš„å¤„ç†ï¼Œè¿™æ ·èƒ½ <strong>å‡å°‘åŒæ­¥é˜»å¡çš„æ—¶é—´</strong> ã€‚è¿˜æœ‰éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**<code>3PC</code> åœ¨ <code>DoCommit</code> é˜¶æ®µå‚ä¸è€…å¦‚æœªæ”¶åˆ°åè°ƒè€…å‘é€çš„æäº¤äº‹åŠ¡çš„è¯·æ±‚ï¼Œå®ƒä¼šåœ¨ä¸€å®šæ—¶é—´å†…è¿›è¡Œäº‹åŠ¡çš„æäº¤<strong>ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿæ˜¯å› ä¸ºè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‚¯å®š</strong>ä¿è¯äº†åœ¨ç¬¬ä¸€é˜¶æ®µæ‰€æœ‰çš„åè°ƒè€…å…¨éƒ¨è¿”å›äº†å¯ä»¥æ‰§è¡Œäº‹åŠ¡çš„å“åº”<strong>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ç†ç”±</strong>ç›¸ä¿¡å…¶ä»–ç³»ç»Ÿéƒ½èƒ½è¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œå’Œæäº¤<strong>ï¼Œæ‰€ä»¥</strong>ä¸ç®¡**åè°ƒè€…æœ‰æ²¡æœ‰å‘æ¶ˆæ¯ç»™å‚ä¸è€…ï¼Œè¿›å…¥ç¬¬ä¸‰é˜¶æ®µå‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œã€‚</p></blockquote><p>æ€»ä¹‹ï¼Œ<code>3PC</code> é€šè¿‡ä¸€ç³»åˆ—çš„è¶…æ—¶æœºåˆ¶å¾ˆå¥½çš„ç¼“è§£äº†é˜»å¡é—®é¢˜ï¼Œä½†æ˜¯æœ€é‡è¦çš„ä¸€è‡´æ€§å¹¶æ²¡æœ‰å¾—åˆ°æ ¹æœ¬çš„è§£å†³ï¼Œæ¯”å¦‚åœ¨ <code>PreCommit</code> é˜¶æ®µï¼Œå½“ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº†è¯·æ±‚ä¹‹åå…¶ä»–å‚ä¸è€…å’Œåè°ƒè€…æŒ‚äº†æˆ–è€…å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œè¿™ä¸ªæ—¶å€™æ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œè¿™å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</p><p>æ‰€ä»¥ï¼Œè¦è§£å†³ä¸€è‡´æ€§é—®é¢˜è¿˜éœ€è¦é  <code>Paxos</code> ç®—æ³•â­ï¸ â­ï¸ â­ï¸ ã€‚</p><h3 id="4-3-Paxos-ç®—æ³•"><a href="#4-3-Paxos-ç®—æ³•" class="headerlink" title="4.3. Paxos ç®—æ³•"></a>4.3. <code>Paxos</code> ç®—æ³•</h3><p><code>Paxos</code> ç®—æ³•æ˜¯åŸºäº<strong>æ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•</strong>ï¼Œæ˜¯ç›®å‰å…¬è®¤çš„è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜æœ€æœ‰æ•ˆçš„ç®—æ³•ä¹‹ä¸€ï¼Œ<strong>å…¶è§£å†³çš„é—®é¢˜å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å°±æŸä¸ªå€¼ï¼ˆå†³è®®ï¼‰è¾¾æˆä¸€è‡´</strong> ã€‚</p><p>åœ¨ <code>Paxos</code> ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º <code>Proposerææ¡ˆè€…</code>ã€<code>Acceptorè¡¨å†³è€…</code>ã€<code>Learnerå­¦ä¹ è€…</code>ã€‚<code>Paxos</code> ç®—æ³•å’Œ <code>2PC</code> ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸º <code>Prepare</code> å’Œ <code>accept</code> é˜¶æ®µã€‚</p><h4 id="4-3-1-prepare-é˜¶æ®µ"><a href="#4-3-1-prepare-é˜¶æ®µ" class="headerlink" title="4.3.1. prepare é˜¶æ®µ"></a>4.3.1. prepare é˜¶æ®µ</h4><ul><li><code>Proposerææ¡ˆè€…</code>ï¼šè´Ÿè´£æå‡º <code>proposal</code>ï¼Œæ¯ä¸ªææ¡ˆè€…åœ¨æå‡ºææ¡ˆæ—¶éƒ½ä¼šé¦–å…ˆè·å–åˆ°ä¸€ä¸ª <strong>å…·æœ‰å…¨å±€å”¯ä¸€æ€§çš„ã€é€’å¢çš„ææ¡ˆç¼–å·N</strong>ï¼Œå³åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ˜¯å”¯ä¸€çš„ç¼–å· Nï¼Œç„¶åå°†è¯¥ç¼–å·èµ‹äºˆå…¶è¦æå‡ºçš„ææ¡ˆï¼Œåœ¨<strong>ç¬¬ä¸€é˜¶æ®µæ˜¯åªå°†ææ¡ˆç¼–å·å‘é€ç»™æ‰€æœ‰çš„è¡¨å†³è€…</strong>ã€‚</li><li><code>Acceptorè¡¨å†³è€…</code>ï¼šæ¯ä¸ªè¡¨å†³è€…åœ¨ <code>accept</code> æŸææ¡ˆåï¼Œä¼šå°†è¯¥ææ¡ˆç¼–å·Nè®°å½•åœ¨æœ¬åœ°ï¼Œè¿™æ ·æ¯ä¸ªè¡¨å†³è€…ä¸­ä¿å­˜çš„å·²ç»è¢« accept çš„ææ¡ˆä¸­ä¼šå­˜åœ¨ä¸€ä¸ª<strong>ç¼–å·æœ€å¤§çš„ææ¡ˆ</strong>ï¼Œå…¶ç¼–å·å‡è®¾ä¸º <code>maxN</code>ã€‚æ¯ä¸ªè¡¨å†³è€…ä»…ä¼š <code>accept</code> ç¼–å·å¤§äºè‡ªå·±æœ¬åœ° <code>maxN</code> çš„ææ¡ˆï¼Œåœ¨æ‰¹å‡†ææ¡ˆæ—¶è¡¨å†³è€…ä¼šå°†ä»¥å‰æ¥å—è¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆä½œä¸ºå“åº”åé¦ˆç»™ <code>Proposer</code> ã€‚</li></ul><blockquote><p>ä¸‹é¢æ˜¯ <code>prepare</code> é˜¶æ®µçš„æµç¨‹å›¾ï¼Œä½ å¯ä»¥å¯¹ç…§ç€å‚è€ƒä¸€ä¸‹ã€‚</p></blockquote><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/958acf97caf9cb2405b7004dceb966a4c587f43bcc78af3bf150c932dbdf53e8/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f32326538643531326439353436373662646630636339326432303061663865662e706e67"><img src="https://camo.githubusercontent.com/958acf97caf9cb2405b7004dceb966a4c587f43bcc78af3bf150c932dbdf53e8/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f32326538643531326439353436373662646630636339326432303061663865662e706e67" alt="paxosç¬¬ä¸€é˜¶æ®µ"></a></p><h4 id="4-3-2-accept-é˜¶æ®µ"><a href="#4-3-2-accept-é˜¶æ®µ" class="headerlink" title="4.3.2. accept é˜¶æ®µ"></a>4.3.2. accept é˜¶æ®µ</h4><p>å½“ä¸€ä¸ªææ¡ˆè¢« <code>Proposer</code> æå‡ºåï¼Œå¦‚æœ <code>Proposer</code> æ”¶åˆ°äº†è¶…è¿‡åŠæ•°çš„ <code>Acceptor</code> çš„æ‰¹å‡†ï¼ˆ<code>Proposer</code> æœ¬èº«åŒæ„ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶ <code>Proposer</code> ä¼šç»™æ‰€æœ‰çš„ <code>Acceptor</code> å‘é€çœŸæ­£çš„ææ¡ˆï¼ˆä½ å¯ä»¥ç†è§£ä¸ºç¬¬ä¸€é˜¶æ®µä¸ºè¯•æ¢ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™ <code>Proposer</code> å°±ä¼šå‘é€ææ¡ˆçš„å†…å®¹å’Œææ¡ˆç¼–å·ã€‚</p><p>è¡¨å†³è€…æ”¶åˆ°ææ¡ˆè¯·æ±‚åä¼šå†æ¬¡æ¯”è¾ƒæœ¬èº«å·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ææ¡ˆç¼–å·å’Œè¯¥ææ¡ˆç¼–å·ï¼Œå¦‚æœè¯¥ææ¡ˆç¼–å· <strong>å¤§äºç­‰äº</strong> å·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ææ¡ˆç¼–å·ï¼Œé‚£ä¹ˆå°± <code>accept</code> è¯¥ææ¡ˆï¼ˆæ­¤æ—¶æ‰§è¡Œææ¡ˆå†…å®¹ä½†ä¸æäº¤ï¼‰ï¼Œéšåå°†æƒ…å†µè¿”å›ç»™ <code>Proposer</code> ã€‚å¦‚æœä¸æ»¡è¶³åˆ™ä¸å›åº”æˆ–è€…è¿”å› NO ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b14a7f3dbb14ca52f7c2c16ec32f607c16319a11da5e512b2270fdf7691c42de/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62383235333666393536663730613538346336613230633130313133663232352e706e67"><img src="https://camo.githubusercontent.com/b14a7f3dbb14ca52f7c2c16ec32f607c16319a11da5e512b2270fdf7691c42de/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62383235333666393536663730613538346336613230633130313133663232352e706e67" alt="paxosç¬¬äºŒé˜¶æ®µ1"></a></p><p>å½“ <code>Proposer</code> æ”¶åˆ°è¶…è¿‡åŠæ•°çš„ <code>accept</code> ï¼Œé‚£ä¹ˆå®ƒè¿™ä¸ªæ—¶å€™ä¼šå‘æ‰€æœ‰çš„ <code>acceptor</code> å‘é€ææ¡ˆçš„æäº¤è¯·æ±‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºä¸Šè¿°ä»…ä»…æ˜¯è¶…è¿‡åŠæ•°çš„ <code>acceptor</code> æ‰¹å‡†æ‰§è¡Œäº†è¯¥ææ¡ˆå†…å®¹ï¼Œå…¶ä»–æ²¡æœ‰æ‰¹å‡†çš„å¹¶æ²¡æœ‰æ‰§è¡Œè¯¥ææ¡ˆå†…å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™éœ€è¦<strong>å‘æœªæ‰¹å‡†çš„ <code>acceptor</code> å‘é€ææ¡ˆå†…å®¹å’Œææ¡ˆç¼–å·å¹¶è®©å®ƒæ— æ¡ä»¶æ‰§è¡Œå’Œæäº¤</strong>ï¼Œè€Œå¯¹äºå‰é¢å·²ç»æ‰¹å‡†è¿‡è¯¥ææ¡ˆçš„ <code>acceptor</code> æ¥è¯´ <strong>ä»…ä»…éœ€è¦å‘é€è¯¥ææ¡ˆçš„ç¼–å·</strong> ï¼Œè®© <code>acceptor</code> æ‰§è¡Œæäº¤å°±è¡Œäº†ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b52244dcbd9969bdf2938521312ab29333a6a9b2d6264335e0e430f2dcf3f4f0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37343338383962393734383566646665323039346535656630616636623134312e706e67"><img src="https://camo.githubusercontent.com/b52244dcbd9969bdf2938521312ab29333a6a9b2d6264335e0e430f2dcf3f4f0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37343338383962393734383566646665323039346535656630616636623134312e706e67" alt="paxosç¬¬äºŒé˜¶æ®µ2"></a></p><p>è€Œå¦‚æœ <code>Proposer</code> å¦‚æœæ²¡æœ‰æ”¶åˆ°è¶…è¿‡åŠæ•°çš„ <code>accept</code> é‚£ä¹ˆå®ƒå°†ä¼šå°† <strong>é€’å¢</strong> è¯¥ <code>Proposal</code> çš„ç¼–å·ï¼Œç„¶å <strong>é‡æ–°è¿›å…¥ <code>Prepare</code> é˜¶æ®µ</strong> ã€‚</p><blockquote><p>å¯¹äº <code>Learner</code> æ¥è¯´å¦‚ä½•å»å­¦ä¹  <code>Acceptor</code> æ‰¹å‡†çš„ææ¡ˆå†…å®¹ï¼Œè¿™æœ‰å¾ˆå¤šæ–¹å¼ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»äº†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šã€‚</p></blockquote><h4 id="4-3-3-paxos-ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜"><a href="#4-3-3-paxos-ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜" class="headerlink" title="4.3.3. paxos ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜"></a>4.3.3. <code>paxos</code> ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜</h4><p>å…¶å®å°±æœ‰ç‚¹ç±»ä¼¼äºä¸¤ä¸ªäººåµæ¶ï¼Œå°æ˜è¯´æˆ‘æ˜¯å¯¹çš„ï¼Œå°çº¢è¯´æˆ‘æ‰æ˜¯å¯¹çš„ï¼Œä¸¤ä¸ªäººæ®ç†åŠ›äº‰çš„è°ä¹Ÿä¸è®©è°ğŸ¤¬ğŸ¤¬ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œæ­¤æ—¶ææ¡ˆè€… P1 æå‡ºä¸€ä¸ªæ–¹æ¡ˆ M1ï¼Œå®Œæˆäº† <code>Prepare</code> é˜¶æ®µçš„å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™ <code>acceptor</code> åˆ™æ‰¹å‡†äº† M1ï¼Œä½†æ˜¯æ­¤æ—¶ææ¡ˆè€… P2 åŒæ—¶ä¹Ÿæå‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆ M2ï¼Œå®ƒä¹Ÿå®Œæˆäº† <code>Prepare</code> é˜¶æ®µçš„å·¥ä½œã€‚ç„¶å P1 çš„æ–¹æ¡ˆå·²ç»ä¸èƒ½åœ¨ç¬¬äºŒé˜¶æ®µè¢«æ‰¹å‡†äº†ï¼ˆå› ä¸º <code>acceptor</code> å·²ç»æ‰¹å‡†äº†æ¯” M1 æ›´å¤§çš„ M2ï¼‰ï¼Œæ‰€ä»¥ P1 è‡ªå¢æ–¹æ¡ˆå˜ä¸º M3 é‡æ–°è¿›å…¥ <code>Prepare</code> é˜¶æ®µï¼Œç„¶å <code>acceptor</code> ï¼Œåˆæ‰¹å‡†äº†æ–°çš„ M3 æ–¹æ¡ˆï¼Œå®ƒåˆä¸èƒ½æ‰¹å‡† M2 äº†ï¼Œè¿™ä¸ªæ—¶å€™ M2 åˆè‡ªå¢è¿›å…¥ <code>Prepare</code> é˜¶æ®µã€‚ã€‚ã€‚</p><p>å°±è¿™æ ·æ— ä¼‘æ— æ­¢çš„æ°¸è¿œææ¡ˆä¸‹å»ï¼Œè¿™å°±æ˜¯ <code>paxos</code> ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/05d4b58c74150218cc596a50dd74075dcfebff91d900147ac4dc33de24a44627/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37326363663635636463313037333436666632613161383831643239366132622e706e67"><img src="https://camo.githubusercontent.com/05d4b58c74150218cc596a50dd74075dcfebff91d900147ac4dc33de24a44627/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f37326363663635636463313037333436666632613161383831643239366132622e706e67" alt="img"></a></p><p>é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œäººå¤šäº†å®¹æ˜“åµæ¶ï¼Œæˆ‘ç°åœ¨ <strong>å°±å…è®¸ä¸€ä¸ªèƒ½ææ¡ˆ</strong> å°±è¡Œäº†ã€‚</p><h2 id="5-å¼•å‡º-ZAB"><a href="#5-å¼•å‡º-ZAB" class="headerlink" title="5. å¼•å‡º ZAB"></a>5. å¼•å‡º <code>ZAB</code></h2><h3 id="5-1-Zookeeper-æ¶æ„"><a href="#5-1-Zookeeper-æ¶æ„" class="headerlink" title="5.1. Zookeeper æ¶æ„"></a>5.1. <code>Zookeeper</code> æ¶æ„</h3><p>ä½œä¸ºä¸€ä¸ªä¼˜ç§€é«˜æ•ˆä¸”å¯é çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ï¼Œ<code>ZooKeeper</code> åœ¨è§£å†³åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§é—®é¢˜æ—¶å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ <code>Paxos</code> ï¼Œè€Œæ˜¯ä¸“é—¨å®šåˆ¶äº†ä¸€è‡´æ€§åè®®å«åš <code>ZAB(ZooKeeper Atomic Broadcast)</code> åŸå­å¹¿æ’­åè®®ï¼Œè¯¥åè®®èƒ½å¤Ÿå¾ˆå¥½åœ°æ”¯æŒ <strong>å´©æºƒæ¢å¤</strong> ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/077fd611729e99b56c3b2c6af07c4d145b89d620189bfe4d4460536e9d5f8c1e/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f30633338643038656130323665323562663338343963633736353461346537392e706e67"><img src="https://camo.githubusercontent.com/077fd611729e99b56c3b2c6af07c4d145b89d620189bfe4d4460536e9d5f8c1e/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f30633338643038656130323665323562663338343963633736353461346537392e706e67" alt="Zookeeperæ¶æ„"></a></p><h3 id="5-2-ZAB-ä¸­çš„ä¸‰ä¸ªè§’è‰²"><a href="#5-2-ZAB-ä¸­çš„ä¸‰ä¸ªè§’è‰²" class="headerlink" title="5.2. ZAB ä¸­çš„ä¸‰ä¸ªè§’è‰²"></a>5.2. <code>ZAB</code> ä¸­çš„ä¸‰ä¸ªè§’è‰²</h3><p>å’Œä»‹ç» <code>Paxos</code> ä¸€æ ·ï¼Œåœ¨ä»‹ç» <code>ZAB</code> åè®®ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹åœ¨ <code>ZAB</code> ä¸­ä¸‰ä¸ªä¸»è¦çš„è§’è‰²ï¼Œ<code>Leader é¢†å¯¼è€…</code>ã€<code>Followerè·Ÿéšè€…</code>ã€<code>Observerè§‚å¯Ÿè€…</code> ã€‚</p><ul><li><code>Leader</code> ï¼šé›†ç¾¤ä¸­ <strong>å”¯ä¸€çš„å†™è¯·æ±‚å¤„ç†è€…</strong> ï¼Œèƒ½å¤Ÿå‘èµ·æŠ•ç¥¨ï¼ˆæŠ•ç¥¨ä¹Ÿæ˜¯ä¸ºäº†è¿›è¡Œå†™è¯·æ±‚ï¼‰ã€‚</li><li><code>Follower</code>ï¼šèƒ½å¤Ÿæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¦‚æœæ˜¯è¯»è¯·æ±‚åˆ™å¯ä»¥è‡ªå·±å¤„ç†ï¼Œ<strong>å¦‚æœæ˜¯å†™è¯·æ±‚åˆ™è¦è½¬å‘ç»™ <code>Leader</code></strong> ã€‚åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ä¼šå‚ä¸æŠ•ç¥¨ï¼Œ<strong>æœ‰é€‰ä¸¾æƒå’Œè¢«é€‰ä¸¾æƒ</strong> ã€‚</li><li><code>Observer</code> ï¼šå°±æ˜¯æ²¡æœ‰é€‰ä¸¾æƒå’Œè¢«é€‰ä¸¾æƒçš„ <code>Follower</code> ã€‚</li></ul><p>åœ¨ <code>ZAB</code> åè®®ä¸­å¯¹ <code>zkServer</code>(å³ä¸Šé¢æˆ‘ä»¬è¯´çš„ä¸‰ä¸ªè§’è‰²çš„æ€»ç§°) è¿˜æœ‰ä¸¤ç§æ¨¡å¼çš„å®šä¹‰ï¼Œåˆ†åˆ«æ˜¯ <strong>æ¶ˆæ¯å¹¿æ’­</strong> å’Œ <strong>å´©æºƒæ¢å¤</strong> ã€‚</p><h3 id="5-3-æ¶ˆæ¯å¹¿æ’­æ¨¡å¼"><a href="#5-3-æ¶ˆæ¯å¹¿æ’­æ¨¡å¼" class="headerlink" title="5.3. æ¶ˆæ¯å¹¿æ’­æ¨¡å¼"></a>5.3. æ¶ˆæ¯å¹¿æ’­æ¨¡å¼</h3><p>è¯´ç™½äº†å°±æ˜¯ <code>ZAB</code> åè®®æ˜¯å¦‚ä½•å¤„ç†å†™è¯·æ±‚çš„ï¼Œä¸Šé¢æˆ‘ä»¬ä¸æ˜¯è¯´åªæœ‰ <code>Leader</code> èƒ½å¤„ç†å†™è¯·æ±‚å˜›ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬çš„ <code>Follower</code> å’Œ <code>Observer</code> æ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦ <strong>åŒæ­¥æ›´æ–°æ•°æ®</strong> å‘¢ï¼Ÿæ€»ä¸èƒ½æ•°æ®åªåœ¨ <code>Leader</code> ä¸­æ›´æ–°äº†ï¼Œå…¶ä»–è§’è‰²éƒ½æ²¡æœ‰å¾—åˆ°æ›´æ–°å§ï¼Ÿ</p><p>ä¸å°±æ˜¯ <strong>åœ¨æ•´ä¸ªé›†ç¾¤ä¸­ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§</strong> å˜›ï¼Ÿå¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿ</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0bc03fe182c291f01eb9c7869c69408887d4a32d3ffe7d4319ab55a8f1140ca5/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f65363036346165613732396463633264393237643564383163343739376537342e706e67"><img src="https://camo.githubusercontent.com/0bc03fe182c291f01eb9c7869c69408887d4a32d3ffe7d4319ab55a8f1140ca5/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f65363036346165613732396463633264393237643564383163343739376537342e706e67" alt="img"></a></p><p>åºŸè¯ï¼Œç¬¬ä¸€æ­¥è‚¯å®šéœ€è¦ <code>Leader</code> å°†å†™è¯·æ±‚ <strong>å¹¿æ’­</strong> å‡ºå»å‘€ï¼Œè®© <code>Leader</code> é—®é—® <code>Followers</code> æ˜¯å¦åŒæ„æ›´æ–°ï¼Œå¦‚æœè¶…è¿‡åŠæ•°ä»¥ä¸Šçš„åŒæ„é‚£ä¹ˆå°±è¿›è¡Œ <code>Follower</code> å’Œ <code>Observer</code> çš„æ›´æ–°ï¼ˆå’Œ <code>Paxos</code> ä¸€æ ·ï¼‰ã€‚å½“ç„¶è¿™ä¹ˆè¯´æœ‰ç‚¹è™šï¼Œç”»å¼ å›¾ç†è§£ä¸€ä¸‹ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/597f31bca7f3b432b292df30c09b8fef9f703a5b0439c5c2cf23c173af262da0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f30386363636534383139306665346564636263626232323364363233313837362e706e67"><img src="https://camo.githubusercontent.com/597f31bca7f3b432b292df30c09b8fef9f703a5b0439c5c2cf23c173af262da0/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f30386363636534383139306665346564636263626232323364363233313837362e706e67" alt="æ¶ˆæ¯å¹¿æ’­"></a></p><p>å—¯ã€‚ã€‚ã€‚çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œè²Œä¼¼æ‡‚äº†ğŸ¤¥ğŸ¤¥ğŸ¤¥ã€‚è¿™ä¸¤ä¸ª <code>Queue</code> å“ªå†’å‡ºæ¥çš„ï¼Ÿç­”æ¡ˆæ˜¯ <strong><code>ZAB</code> éœ€è¦è®© <code>Follower</code> å’Œ <code>Observer</code> ä¿è¯é¡ºåºæ€§</strong> ã€‚ä½•ä¸ºé¡ºåºæ€§ï¼Œæ¯”å¦‚æˆ‘ç°åœ¨æœ‰ä¸€ä¸ªå†™è¯·æ±‚Aï¼Œæ­¤æ—¶ <code>Leader</code> å°†è¯·æ±‚Aå¹¿æ’­å‡ºå»ï¼Œå› ä¸ºåªéœ€è¦åŠæ•°åŒæ„å°±è¡Œï¼Œæ‰€ä»¥å¯èƒ½è¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ª <code>Follower</code> F1å› ä¸ºç½‘ç»œåŸå› æ²¡æœ‰æ”¶åˆ°ï¼Œè€Œ <code>Leader</code> åˆå¹¿æ’­äº†ä¸€ä¸ªè¯·æ±‚Bï¼Œå› ä¸ºç½‘ç»œåŸå› ï¼ŒF1ç«Ÿç„¶å…ˆæ”¶åˆ°äº†è¯·æ±‚Bç„¶åæ‰æ”¶åˆ°äº†è¯·æ±‚Aï¼Œè¿™ä¸ªæ—¶å€™è¯·æ±‚å¤„ç†çš„é¡ºåºä¸åŒå°±ä¼šå¯¼è‡´æ•°æ®çš„ä¸åŒï¼Œä»è€Œ <strong>äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´é—®é¢˜</strong> ã€‚</p><p>æ‰€ä»¥åœ¨ <code>Leader</code> è¿™ç«¯ï¼Œå®ƒä¸ºæ¯ä¸ªå…¶ä»–çš„ <code>zkServer</code> å‡†å¤‡äº†ä¸€ä¸ª <strong>é˜Ÿåˆ—</strong> ï¼Œé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼å‘é€æ¶ˆæ¯ã€‚ç”±äºåè®®æ˜¯ **é€šè¿‡ <code>TCP</code> **æ¥è¿›è¡Œç½‘ç»œé€šä¿¡çš„ï¼Œä¿è¯äº†æ¶ˆæ¯çš„å‘é€é¡ºåºæ€§ï¼Œæ¥å—é¡ºåºæ€§ä¹Ÿå¾—åˆ°äº†ä¿è¯ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨ <code>ZAB</code> ä¸­è¿˜å®šä¹‰äº†ä¸€ä¸ª <strong>å…¨å±€å•è°ƒé€’å¢çš„äº‹åŠ¡ID <code>ZXID</code></strong> ï¼Œå®ƒæ˜¯ä¸€ä¸ª64ä½longå‹ï¼Œå…¶ä¸­é«˜32ä½è¡¨ç¤º <code>epoch</code> å¹´ä»£ï¼Œä½32ä½è¡¨ç¤ºäº‹åŠ¡idã€‚<code>epoch</code> æ˜¯ä¼šæ ¹æ® <code>Leader</code> çš„å˜åŒ–è€Œå˜åŒ–çš„ï¼Œå½“ä¸€ä¸ª <code>Leader</code> æŒ‚äº†ï¼Œæ–°çš„ <code>Leader</code> ä¸Šä½çš„æ—¶å€™ï¼Œå¹´ä»£ï¼ˆ<code>epoch</code>ï¼‰å°±å˜äº†ã€‚è€Œä½32ä½å¯ä»¥ç®€å•ç†è§£ä¸ºé€’å¢çš„äº‹åŠ¡idã€‚</p><p>å®šä¹‰è¿™ä¸ªçš„åŸå› ä¹Ÿæ˜¯ä¸ºäº†é¡ºåºæ€§ï¼Œæ¯ä¸ª <code>proposal</code> åœ¨ <code>Leader</code> ä¸­ç”Ÿæˆåéœ€è¦ <strong>é€šè¿‡å…¶ <code>ZXID</code> æ¥è¿›è¡Œæ’åº</strong> ï¼Œæ‰èƒ½å¾—åˆ°å¤„ç†ã€‚</p><h3 id="5-4-å´©æºƒæ¢å¤æ¨¡å¼"><a href="#5-4-å´©æºƒæ¢å¤æ¨¡å¼" class="headerlink" title="5.4. å´©æºƒæ¢å¤æ¨¡å¼"></a>5.4. å´©æºƒæ¢å¤æ¨¡å¼</h3><p>è¯´åˆ°å´©æºƒæ¢å¤æˆ‘ä»¬é¦–å…ˆè¦æåˆ° <code>ZAB</code> ä¸­çš„ <code>Leader</code> é€‰ä¸¾ç®—æ³•ï¼Œå½“ç³»ç»Ÿå‡ºç°å´©æºƒå½±å“æœ€å¤§åº”è¯¥æ˜¯ <code>Leader</code> çš„å´©æºƒï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ª <code>Leader</code> ï¼Œæ‰€ä»¥å½“ <code>Leader</code> å‡ºç°é—®é¢˜çš„æ—¶å€™æˆ‘ä»¬åŠ¿å¿…éœ€è¦é‡æ–°é€‰ä¸¾ <code>Leader</code> ã€‚</p><p><code>Leader</code> é€‰ä¸¾å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„é˜¶æ®µï¼Œç¬¬ä¸€ä¸ªæ˜¯æˆ‘ä»¬æåˆ°çš„ <code>Leader</code> å®•æœºéœ€è¦é‡æ–°é€‰ä¸¾ï¼Œç¬¬äºŒåˆ™æ˜¯å½“ <code>Zookeeper</code> å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œç³»ç»Ÿçš„ <code>Leader</code> åˆå§‹åŒ–é€‰ä¸¾ã€‚ä¸‹é¢æˆ‘å…ˆæ¥ä»‹ç»ä¸€ä¸‹ <code>ZAB</code> æ˜¯å¦‚ä½•è¿›è¡Œåˆå§‹åŒ–é€‰ä¸¾çš„ã€‚</p><p>å‡è®¾æˆ‘ä»¬é›†ç¾¤ä¸­æœ‰3å°æœºå™¨ï¼Œé‚£ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸¤å°ä»¥ä¸ŠåŒæ„ï¼ˆè¶…è¿‡åŠæ•°ï¼‰ã€‚æ¯”å¦‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯åŠ¨äº† <code>server1</code> ï¼Œå®ƒä¼šé¦–å…ˆ <strong>æŠ•ç¥¨ç»™è‡ªå·±</strong> ï¼ŒæŠ•ç¥¨å†…å®¹ä¸ºæœåŠ¡å™¨çš„ <code>myid</code> å’Œ <code>ZXID</code> ï¼Œå› ä¸ºåˆå§‹åŒ–æ‰€ä»¥ <code>ZXID</code> éƒ½ä¸º0ï¼Œæ­¤æ—¶ <code>server1</code> å‘å‡ºçš„æŠ•ç¥¨ä¸º (1,0)ã€‚ä½†æ­¤æ—¶ <code>server1</code> çš„æŠ•ç¥¨ä»…ä¸º1ï¼Œæ‰€ä»¥ä¸èƒ½ä½œä¸º <code>Leader</code> ï¼Œæ­¤æ—¶è¿˜åœ¨é€‰ä¸¾é˜¶æ®µæ‰€ä»¥æ•´ä¸ªé›†ç¾¤å¤„äº <strong><code>Looking</code> çŠ¶æ€</strong>ã€‚</p><p>æ¥ç€ <code>server2</code> å¯åŠ¨äº†ï¼Œå®ƒé¦–å…ˆä¹Ÿä¼šå°†æŠ•ç¥¨é€‰ç»™è‡ªå·±(2,0)ï¼Œå¹¶å°†æŠ•ç¥¨ä¿¡æ¯å¹¿æ’­å‡ºå»ï¼ˆ<code>server1</code>ä¹Ÿä¼šï¼Œåªæ˜¯å®ƒé‚£æ—¶æ²¡æœ‰å…¶ä»–çš„æœåŠ¡å™¨äº†ï¼‰ï¼Œ<code>server1</code> åœ¨æ”¶åˆ° <code>server2</code> çš„æŠ•ç¥¨ä¿¡æ¯åä¼šå°†æŠ•ç¥¨ä¿¡æ¯ä¸è‡ªå·±çš„ä½œæ¯”è¾ƒã€‚**é¦–å…ˆå®ƒä¼šæ¯”è¾ƒ <code>ZXID</code> ï¼Œ<code>ZXID</code> å¤§çš„ä¼˜å…ˆä¸º <code>Leader</code>ï¼Œå¦‚æœç›¸åŒåˆ™æ¯”è¾ƒ <code>myid</code>ï¼Œ<code>myid</code> å¤§çš„ä¼˜å…ˆä½œä¸º <code>Leader</code>**ã€‚æ‰€ä»¥æ­¤æ—¶<code>server1</code> å‘ç° <code>server2</code> æ›´é€‚åˆåš <code>Leader</code>ï¼Œå®ƒå°±ä¼šå°†è‡ªå·±çš„æŠ•ç¥¨ä¿¡æ¯æ›´æ”¹ä¸º(2,0)ç„¶åå†å¹¿æ’­å‡ºå»ï¼Œä¹‹å<code>server2</code> æ”¶åˆ°ä¹‹åå‘ç°å’Œè‡ªå·±çš„ä¸€æ ·æ— éœ€åšæ›´æ”¹ï¼Œå¹¶ä¸”è‡ªå·±çš„ <strong>æŠ•ç¥¨å·²ç»è¶…è¿‡åŠæ•°</strong> ï¼Œåˆ™ **ç¡®å®š <code>server2</code> ä¸º <code>Leader</code>**ï¼Œ<code>server1</code> ä¹Ÿä¼šå°†è‡ªå·±æœåŠ¡å™¨è®¾ç½®ä¸º <code>Following</code> å˜ä¸º <code>Follower</code>ã€‚æ•´ä¸ªæœåŠ¡å™¨å°±ä» <code>Looking</code> å˜ä¸ºäº†æ­£å¸¸çŠ¶æ€ã€‚</p><p>å½“ <code>server3</code> å¯åŠ¨å‘ç°é›†ç¾¤æ²¡æœ‰å¤„äº <code>Looking</code> çŠ¶æ€æ—¶ï¼Œå®ƒä¼šç›´æ¥ä»¥ <code>Follower</code> çš„èº«ä»½åŠ å…¥é›†ç¾¤ã€‚</p><p>è¿˜æ˜¯å‰é¢ä¸‰ä¸ª <code>server</code> çš„ä¾‹å­ï¼Œå¦‚æœåœ¨æ•´ä¸ªé›†ç¾¤è¿è¡Œçš„è¿‡ç¨‹ä¸­ <code>server2</code> æŒ‚äº†ï¼Œé‚£ä¹ˆæ•´ä¸ªé›†ç¾¤ä¼šå¦‚ä½•é‡æ–°é€‰ä¸¾ <code>Leader</code> å‘¢ï¼Ÿå…¶å®å’Œåˆå§‹åŒ–é€‰ä¸¾å·®ä¸å¤šã€‚</p><p>é¦–å…ˆæ¯«æ— ç–‘é—®çš„æ˜¯å‰©ä¸‹çš„ä¸¤ä¸ª <code>Follower</code> ä¼šå°†è‡ªå·±çš„çŠ¶æ€ <strong>ä» <code>Following</code> å˜ä¸º <code>Looking</code> çŠ¶æ€</strong> ï¼Œç„¶åæ¯ä¸ª <code>server</code> ä¼šå‘åˆå§‹åŒ–æŠ•ç¥¨ä¸€æ ·é¦–å…ˆç»™è‡ªå·±æŠ•ç¥¨ï¼ˆè¿™ä¸è¿‡è¿™é‡Œçš„ <code>zxid</code> å¯èƒ½ä¸æ˜¯0äº†ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿éšä¾¿å–ä¸ªæ•°å­—ï¼‰ã€‚</p><p>å‡è®¾ <code>server1</code> ç»™è‡ªå·±æŠ•ç¥¨ä¸º(1,99)ï¼Œç„¶åå¹¿æ’­ç»™å…¶ä»– <code>server</code>ï¼Œ<code>server3</code> é¦–å…ˆä¹Ÿä¼šç»™è‡ªå·±æŠ•ç¥¨(3,95)ï¼Œç„¶åä¹Ÿå¹¿æ’­ç»™å…¶ä»– <code>server</code>ã€‚<code>server1</code> å’Œ <code>server3</code> æ­¤æ—¶ä¼šæ”¶åˆ°å½¼æ­¤çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œå’Œä¸€å¼€å§‹é€‰ä¸¾ä¸€æ ·ï¼Œä»–ä»¬ä¹Ÿä¼šæ¯”è¾ƒè‡ªå·±çš„æŠ•ç¥¨å’Œæ”¶åˆ°çš„æŠ•ç¥¨ï¼ˆ<code>zxid</code> å¤§çš„ä¼˜å…ˆï¼Œå¦‚æœç›¸åŒé‚£ä¹ˆå°± <code>myid</code> å¤§çš„ä¼˜å…ˆï¼‰ã€‚è¿™ä¸ªæ—¶å€™ <code>server1</code> æ”¶åˆ°äº† <code>server3</code> çš„æŠ•ç¥¨å‘ç°æ²¡è‡ªå·±çš„åˆé€‚æ•…ä¸å˜ï¼Œ<code>server3</code> æ”¶åˆ° <code>server1</code> çš„æŠ•ç¥¨ç»“æœåå‘ç°æ¯”è‡ªå·±çš„åˆé€‚äºæ˜¯æ›´æ”¹æŠ•ç¥¨ä¸º(1,99)ç„¶åå¹¿æ’­å‡ºå»ï¼Œæœ€å <code>server1</code> æ”¶åˆ°äº†å‘ç°è‡ªå·±çš„æŠ•ç¥¨å·²ç»è¶…è¿‡åŠæ•°å°±æŠŠè‡ªå·±è®¾ä¸º <code>Leader</code>ï¼Œ<code>server3</code> ä¹Ÿéšä¹‹å˜ä¸º <code>Follower</code>ã€‚</p><blockquote><p>è¯·æ³¨æ„ <code>ZooKeeper</code> ä¸ºä»€ä¹ˆè¦è®¾ç½®å¥‡æ•°ä¸ªç»“ç‚¹ï¼Ÿæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸‰ä¸ªï¼ŒæŒ‚äº†ä¸€ä¸ªæˆ‘ä»¬è¿˜èƒ½æ­£å¸¸å·¥ä½œï¼ŒæŒ‚äº†ä¸¤ä¸ªæˆ‘ä»¬å°±ä¸èƒ½æ­£å¸¸å·¥ä½œäº†ï¼ˆå·²ç»æ²¡æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹æ•°äº†ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡ŒæŠ•ç¥¨ç­‰æ“ä½œäº†ï¼‰ã€‚è€Œå‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰å››ä¸ªï¼ŒæŒ‚äº†ä¸€ä¸ªä¹Ÿèƒ½å·¥ä½œï¼Œ<strong>ä½†æ˜¯æŒ‚äº†ä¸¤ä¸ªä¹Ÿä¸èƒ½æ­£å¸¸å·¥ä½œäº†</strong>ï¼Œè¿™æ˜¯å’Œä¸‰ä¸ªä¸€æ ·çš„ï¼Œè€Œä¸‰ä¸ªæ¯”å››ä¸ªè¿˜å°‘ä¸€ä¸ªï¼Œå¸¦æ¥çš„æ•ˆç›Šæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ <code>Zookeeper</code> æ¨èå¥‡æ•°ä¸ª <code>server</code> ã€‚</p></blockquote><p>é‚£ä¹ˆè¯´å®Œäº† <code>ZAB</code> ä¸­çš„ <code>Leader</code> é€‰ä¸¾æ–¹å¼ä¹‹åæˆ‘ä»¬å†æ¥äº†è§£ä¸€ä¸‹ <strong>å´©æºƒæ¢å¤</strong> æ˜¯ä»€ä¹ˆç©æ„ï¼Ÿ</p><p>å…¶å®ä¸»è¦å°±æ˜¯ <strong>å½“é›†ç¾¤ä¸­æœ‰æœºå™¨æŒ‚äº†ï¼Œæˆ‘ä»¬æ•´ä¸ªé›†ç¾¤å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</strong></p><p>å¦‚æœåªæ˜¯ <code>Follower</code> æŒ‚äº†ï¼Œè€Œä¸”æŒ‚çš„æ²¡è¶…è¿‡åŠæ•°çš„æ—¶å€™ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€å¼€å§‹è®²äº†åœ¨ <code>Leader</code> ä¸­ä¼šç»´æŠ¤é˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒåé¢çš„æ•°æ®æ²¡æ¥æ”¶åˆ°å¯¼è‡´æ•°æ®ä¸ä¸€è‡´æ€§ã€‚</p><p>å¦‚æœ <code>Leader</code> æŒ‚äº†é‚£å°±éº»çƒ¦äº†ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦å…ˆæš‚åœæœåŠ¡å˜ä¸º <code>Looking</code> çŠ¶æ€ç„¶åè¿›è¡Œ <code>Leader</code> çš„é‡æ–°é€‰ä¸¾ï¼ˆä¸Šé¢æˆ‘è®²è¿‡äº†ï¼‰ï¼Œä½†è¿™ä¸ªå°±è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µäº†ï¼Œåˆ†åˆ«æ˜¯ <strong>ç¡®ä¿å·²ç»è¢«Leaderæäº¤çš„ææ¡ˆæœ€ç»ˆèƒ½å¤Ÿè¢«æ‰€æœ‰çš„Followeræäº¤</strong> å’Œ <strong>è·³è¿‡é‚£äº›å·²ç»è¢«ä¸¢å¼ƒçš„ææ¡ˆ</strong> ã€‚</p><p>ç¡®ä¿å·²ç»è¢«Leaderæäº¤çš„ææ¡ˆæœ€ç»ˆèƒ½å¤Ÿè¢«æ‰€æœ‰çš„Followeræäº¤æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><p>å‡è®¾ <code>Leader (server2)</code> å‘é€ <code>commit</code> è¯·æ±‚ï¼ˆå¿˜äº†è¯·çœ‹ä¸Šé¢çš„æ¶ˆæ¯å¹¿æ’­æ¨¡å¼ï¼‰ï¼Œä»–å‘é€ç»™äº† <code>server3</code>ï¼Œç„¶åè¦å‘ç»™ <code>server1</code> çš„æ—¶å€™çªç„¶æŒ‚äº†ã€‚è¿™ä¸ªæ—¶å€™é‡æ–°é€‰ä¸¾çš„æ—¶å€™æˆ‘ä»¬å¦‚æœæŠŠ <code>server1</code> ä½œä¸º <code>Leader</code> çš„è¯ï¼Œé‚£ä¹ˆè‚¯å®šä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§ï¼Œå› ä¸º <code>server3</code> è‚¯å®šä¼šæäº¤åˆšåˆš <code>server2</code> å‘é€çš„ <code>commit</code> è¯·æ±‚çš„ææ¡ˆï¼Œè€Œ <code>server1</code> æ ¹æœ¬æ²¡æ”¶åˆ°æ‰€ä»¥ä¼šä¸¢å¼ƒã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/77dce0fe55188c51fd83aa9e9475c662a5a4d8156c8c1899b4d848daeaeb32a1/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f66666362313263366662326261643736616337313035363936363535653835632e706e67"><img src="https://camo.githubusercontent.com/77dce0fe55188c51fd83aa9e9475c662a5a4d8156c8c1899b4d848daeaeb32a1/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f66666362313263366662326261643736616337313035363936363535653835632e706e67" alt="å´©æºƒæ¢å¤"></a></p><p>é‚£æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>èªæ˜çš„åŒå­¦è‚¯å®šä¼šè´¨ç–‘ï¼Œ<strong>è¿™ä¸ªæ—¶å€™ <code>server1</code> å·²ç»ä¸å¯èƒ½æˆä¸º <code>Leader</code> äº†ï¼Œå› ä¸º <code>server1</code> å’Œ <code>server3</code> è¿›è¡ŒæŠ•ç¥¨é€‰ä¸¾çš„æ—¶å€™ä¼šæ¯”è¾ƒ <code>ZXID</code> ï¼Œè€Œæ­¤æ—¶ <code>server3</code> çš„ <code>ZXID</code> è‚¯å®šæ¯” <code>server1</code> çš„å¤§äº†</strong>ã€‚(ä¸ç†è§£å¯ä»¥çœ‹å‰é¢çš„é€‰ä¸¾ç®—æ³•)</p><p>é‚£ä¹ˆè·³è¿‡é‚£äº›å·²ç»è¢«ä¸¢å¼ƒçš„ææ¡ˆåˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><p>å‡è®¾ <code>Leader (server2)</code> æ­¤æ—¶åŒæ„äº†ææ¡ˆN1ï¼Œè‡ªèº«æäº¤äº†è¿™ä¸ªäº‹åŠ¡å¹¶ä¸”è¦å‘é€ç»™æ‰€æœ‰ <code>Follower</code> è¦ <code>commit</code> çš„è¯·æ±‚ï¼Œå´åœ¨è¿™ä¸ªæ—¶å€™æŒ‚äº†ï¼Œæ­¤æ—¶è‚¯å®šè¦é‡æ–°è¿›è¡Œ <code>Leader</code> çš„é€‰ä¸¾ï¼Œæ¯”å¦‚è¯´æ­¤æ—¶é€‰ <code>server1</code> ä¸º <code>Leader</code> ï¼ˆè¿™æ— æ‰€è°“ï¼‰ã€‚ä½†æ˜¯è¿‡äº†ä¸€ä¼šï¼Œè¿™ä¸ª <strong>æŒ‚æ‰çš„ <code>Leader</code> åˆé‡æ–°æ¢å¤äº†</strong> ï¼Œæ­¤æ—¶å®ƒè‚¯å®šä¼šä½œä¸º <code>Follower</code> çš„èº«ä»½è¿›å…¥é›†ç¾¤ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åˆšåˆš <code>server2</code> å·²ç»åŒæ„æäº¤äº†ææ¡ˆN1ï¼Œä½†å…¶ä»– <code>server</code> å¹¶æ²¡æœ‰æ”¶åˆ°å®ƒçš„ <code>commit</code> ä¿¡æ¯ï¼Œæ‰€ä»¥å…¶ä»– <code>server</code> ä¸å¯èƒ½å†æäº¤è¿™ä¸ªææ¡ˆN1äº†ï¼Œè¿™æ ·å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜äº†ï¼Œæ‰€ä»¥ <strong>è¯¥ææ¡ˆN1æœ€ç»ˆéœ€è¦è¢«æŠ›å¼ƒæ‰</strong> ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/bc42dd3ff23dea6e243e5bda08d91368ef5809cfe3fca57d4f005c7eb8e3db2e/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f61626236656663376434646639633832623136326362656362313239613665332e706e67"><img src="https://camo.githubusercontent.com/bc42dd3ff23dea6e243e5bda08d91368ef5809cfe3fca57d4f005c7eb8e3db2e/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f61626236656663376434646639633832623136326362656362313239613665332e706e67" alt="å´©æºƒæ¢å¤"></a></p><h2 id="6-Zookeeperçš„å‡ ä¸ªç†è®ºçŸ¥è¯†"><a href="#6-Zookeeperçš„å‡ ä¸ªç†è®ºçŸ¥è¯†" class="headerlink" title="6. Zookeeperçš„å‡ ä¸ªç†è®ºçŸ¥è¯†"></a>6. Zookeeperçš„å‡ ä¸ªç†è®ºçŸ¥è¯†</h2><p>äº†è§£äº† <code>ZAB</code> åè®®è¿˜ä¸å¤Ÿï¼Œå®ƒä»…ä»…æ˜¯ <code>Zookeeper</code> å†…éƒ¨å®ç°çš„ä¸€ç§æ–¹å¼ï¼Œè€Œæˆ‘ä»¬å¦‚ä½•é€šè¿‡ <code>Zookeeper</code> å»åšä¸€äº›å…¸å‹çš„åº”ç”¨åœºæ™¯å‘¢ï¼Ÿæ¯”å¦‚è¯´é›†ç¾¤ç®¡ç†ï¼Œåˆ†å¸ƒå¼é”ï¼Œ<code>Master</code> é€‰ä¸¾ç­‰ç­‰ã€‚</p><p>è¿™å°±æ¶‰åŠåˆ°å¦‚ä½•ä½¿ç”¨ <code>Zookeeper</code> äº†ï¼Œä½†åœ¨ä½¿ç”¨ä¹‹å‰æˆ‘ä»¬è¿˜éœ€è¦æŒæ¡å‡ ä¸ªæ¦‚å¿µã€‚æ¯”å¦‚ <code>Zookeeper</code> çš„ <strong>æ•°æ®æ¨¡å‹</strong> ã€<strong>ä¼šè¯æœºåˆ¶</strong>ã€<strong>ACL</strong>ã€<strong>Watcheræœºåˆ¶</strong> ç­‰ç­‰ã€‚</p><h3 id="6-1-æ•°æ®æ¨¡å‹"><a href="#6-1-æ•°æ®æ¨¡å‹" class="headerlink" title="6.1. æ•°æ®æ¨¡å‹"></a>6.1. æ•°æ®æ¨¡å‹</h3><p><code>zookeeper</code> æ•°æ®å­˜å‚¨ç»“æ„ä¸æ ‡å‡†çš„ <code>Unix</code> æ–‡ä»¶ç³»ç»Ÿéå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯åœ¨æ ¹èŠ‚ç‚¹ä¸‹æŒ‚å¾ˆå¤šå­èŠ‚ç‚¹(æ ‘å‹)ã€‚ä½†æ˜¯ <code>zookeeper</code> ä¸­æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿä¸­ç›®å½•ä¸æ–‡ä»¶çš„æ¦‚å¿µï¼Œè€Œæ˜¯ <strong>ä½¿ç”¨äº† <code>znode</code> ä½œä¸ºæ•°æ®èŠ‚ç‚¹</strong> ã€‚<code>znode</code> æ˜¯ <code>zookeeper</code> ä¸­çš„æœ€å°æ•°æ®å•å…ƒï¼Œæ¯ä¸ª <code>znode</code> ä¸Šéƒ½å¯ä»¥ä¿å­˜æ•°æ®ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‚è½½å­èŠ‚ç‚¹ï¼Œå½¢æˆä¸€ä¸ªæ ‘å½¢åŒ–å‘½åç©ºé—´ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/1e6f78a5b23fde663c00b29f76710c83620711ee095e6b16eaf4158dcb839bdb/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f38663335646261386334346334613130643831653333393564663937316365372e706e67"><img src="https://camo.githubusercontent.com/1e6f78a5b23fde663c00b29f76710c83620711ee095e6b16eaf4158dcb839bdb/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f38663335646261386334346334613130643831653333393564663937316365372e706e67" alt="zkæ•°æ®æ¨¡å‹"></a></p><p>æ¯ä¸ª <code>znode</code> éƒ½æœ‰è‡ªå·±æ‰€å±çš„ <strong>èŠ‚ç‚¹ç±»å‹</strong> å’Œ <strong>èŠ‚ç‚¹çŠ¶æ€</strong>ã€‚</p><p>å…¶ä¸­èŠ‚ç‚¹ç±»å‹å¯ä»¥åˆ†ä¸º <strong>æŒä¹…èŠ‚ç‚¹</strong>ã€<strong>æŒä¹…é¡ºåºèŠ‚ç‚¹</strong>ã€<strong>ä¸´æ—¶èŠ‚ç‚¹</strong> å’Œ <strong>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</strong>ã€‚</p><ul><li>æŒä¹…èŠ‚ç‚¹ï¼šä¸€æ—¦åˆ›å»ºå°±ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°å°†å…¶åˆ é™¤ã€‚</li><li>æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼šä¸€ä¸ªçˆ¶èŠ‚ç‚¹å¯ä»¥ä¸ºå…¶å­èŠ‚ç‚¹ <strong>ç»´æŠ¤ä¸€ä¸ªåˆ›å»ºçš„å…ˆåé¡ºåº</strong> ï¼Œè¿™ä¸ªé¡ºåºä½“ç°åœ¨ <strong>èŠ‚ç‚¹åç§°</strong> ä¸Šï¼Œæ˜¯èŠ‚ç‚¹åç§°åè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªç”± 10 ä½æ•°å­—ç»„æˆçš„æ•°å­—ä¸²ï¼Œä» 0 å¼€å§‹è®¡æ•°ã€‚</li><li>ä¸´æ—¶èŠ‚ç‚¹ï¼šä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ <strong>å®¢æˆ·ç«¯ä¼šè¯</strong> ç»‘å®šçš„ï¼Œ<strong>ä¼šè¯æ¶ˆå¤±åˆ™èŠ‚ç‚¹æ¶ˆå¤±</strong> ã€‚ä¸´æ—¶èŠ‚ç‚¹ <strong>åªèƒ½åšå¶å­èŠ‚ç‚¹</strong> ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</li><li>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼šçˆ¶èŠ‚ç‚¹å¯ä»¥åˆ›å»ºä¸€ä¸ªç»´æŒäº†é¡ºåºçš„ä¸´æ—¶èŠ‚ç‚¹(å’Œå‰é¢çš„æŒä¹…é¡ºåºæ€§èŠ‚ç‚¹ä¸€æ ·)ã€‚</li></ul><p>èŠ‚ç‚¹çŠ¶æ€ä¸­åŒ…å«äº†å¾ˆå¤šèŠ‚ç‚¹çš„å±æ€§æ¯”å¦‚ <code>czxid</code> ã€<code>mzxid</code> ç­‰ç­‰ï¼Œåœ¨ <code>zookeeper</code> ä¸­æ˜¯ä½¿ç”¨ <code>Stat</code> è¿™ä¸ªç±»æ¥ç»´æŠ¤çš„ã€‚ä¸‹é¢æˆ‘åˆ—ä¸¾ä¸€äº›å±æ€§è§£é‡Šã€‚</p><ul><li><code>czxid</code>ï¼š<code>Created ZXID</code>ï¼Œè¯¥æ•°æ®èŠ‚ç‚¹è¢« <strong>åˆ›å»º</strong> æ—¶çš„äº‹åŠ¡IDã€‚</li><li><code>mzxid</code>ï¼š<code>Modified ZXID</code>ï¼ŒèŠ‚ç‚¹ <strong>æœ€åä¸€æ¬¡è¢«æ›´æ–°æ—¶</strong> çš„äº‹åŠ¡IDã€‚</li><li><code>ctime</code>ï¼š<code>Created Time</code>ï¼Œè¯¥èŠ‚ç‚¹è¢«åˆ›å»ºçš„æ—¶é—´ã€‚</li><li><code>mtime</code>ï¼š <code>Modified Time</code>ï¼Œè¯¥èŠ‚ç‚¹æœ€åä¸€æ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ã€‚</li><li><code>version</code>ï¼šèŠ‚ç‚¹çš„ç‰ˆæœ¬å·ã€‚</li><li><code>cversion</code>ï¼š<strong>å­èŠ‚ç‚¹</strong> çš„ç‰ˆæœ¬å·ã€‚</li><li><code>aversion</code>ï¼šèŠ‚ç‚¹çš„ <code>ACL</code> ç‰ˆæœ¬å·ã€‚</li><li><code>ephemeralOwner</code>ï¼šåˆ›å»ºè¯¥èŠ‚ç‚¹çš„ä¼šè¯çš„ <code>sessionID</code> ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ï¼Œè¯¥å€¼ä¸º0ã€‚</li><li><code>dataLength</code>ï¼šèŠ‚ç‚¹æ•°æ®å†…å®¹çš„é•¿åº¦ã€‚</li><li><code>numChildre</code>ï¼šè¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°ï¼Œå¦‚æœä¸ºä¸´æ—¶èŠ‚ç‚¹ä¸º0ã€‚</li><li><code>pzxid</code>ï¼šè¯¥èŠ‚ç‚¹å­èŠ‚ç‚¹åˆ—è¡¨æœ€åä¸€æ¬¡è¢«ä¿®æ”¹æ—¶çš„äº‹åŠ¡IDï¼Œæ³¨æ„æ˜¯å­èŠ‚ç‚¹çš„ <strong>åˆ—è¡¨</strong> ï¼Œä¸æ˜¯å†…å®¹ã€‚</li></ul><h3 id="6-2-ä¼šè¯"><a href="#6-2-ä¼šè¯" class="headerlink" title="6.2. ä¼šè¯"></a>6.2. ä¼šè¯</h3><p>æˆ‘æƒ³è¿™ä¸ªå¯¹äºåç«¯å¼€å‘çš„æœ‹å‹è‚¯å®šä¸é™Œç”Ÿï¼Œä¸å°±æ˜¯ <code>session</code> å—ï¼Ÿåªä¸è¿‡ <code>zk</code> å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯é€šè¿‡ <strong><code>TCP</code> é•¿è¿æ¥</strong> ç»´æŒçš„ä¼šè¯æœºåˆ¶ï¼Œå…¶å®å¯¹äºä¼šè¯æ¥è¯´ä½ å¯ä»¥ç†è§£ä¸º <strong>ä¿æŒè¿æ¥çŠ¶æ€</strong> ã€‚</p><p>åœ¨ <code>zookeeper</code> ä¸­ï¼Œä¼šè¯è¿˜æœ‰å¯¹åº”çš„äº‹ä»¶ï¼Œæ¯”å¦‚ <code>CONNECTION_LOSS è¿æ¥ä¸¢å¤±äº‹ä»¶</code> ã€<code>SESSION_MOVED ä¼šè¯è½¬ç§»äº‹ä»¶</code> ã€<code>SESSION_EXPIRED ä¼šè¯è¶…æ—¶å¤±æ•ˆäº‹ä»¶</code> ã€‚</p><h3 id="6-3-ACL"><a href="#6-3-ACL" class="headerlink" title="6.3. ACL"></a>6.3. ACL</h3><p><code>ACL</code> ä¸º <code>Access Control Lists</code> ï¼Œå®ƒæ˜¯ä¸€ç§æƒé™æ§åˆ¶ã€‚åœ¨ <code>zookeeper</code> ä¸­å®šä¹‰äº†5ç§æƒé™ï¼Œå®ƒä»¬åˆ†åˆ«ä¸ºï¼š</p><ul><li><code>CREATE</code> ï¼šåˆ›å»ºå­èŠ‚ç‚¹çš„æƒé™ã€‚</li><li><code>READ</code>ï¼šè·å–èŠ‚ç‚¹æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨çš„æƒé™ã€‚</li><li><code>WRITE</code>ï¼šæ›´æ–°èŠ‚ç‚¹æ•°æ®çš„æƒé™ã€‚</li><li><code>DELETE</code>ï¼šåˆ é™¤å­èŠ‚ç‚¹çš„æƒé™ã€‚</li><li><code>ADMIN</code>ï¼šè®¾ç½®èŠ‚ç‚¹ ACL çš„æƒé™ã€‚</li></ul><h3 id="6-4-Watcheræœºåˆ¶"><a href="#6-4-Watcheræœºåˆ¶" class="headerlink" title="6.4. Watcheræœºåˆ¶"></a>6.4. Watcheræœºåˆ¶</h3><p><code>Watcher</code> ä¸ºäº‹ä»¶ç›‘å¬å™¨ï¼Œæ˜¯ <code>zk</code> éå¸¸é‡è¦çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½ä¾èµ–äºå®ƒï¼Œå®ƒæœ‰ç‚¹ç±»ä¼¼äºè®¢é˜…çš„æ–¹å¼ï¼Œå³å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ <strong>æ³¨å†Œ</strong> æŒ‡å®šçš„ <code>watcher</code> ï¼Œå½“æœåŠ¡ç«¯ç¬¦åˆäº† <code>watcher</code> çš„æŸäº›äº‹ä»¶æˆ–è¦æ±‚åˆ™ä¼š <strong>å‘å®¢æˆ·ç«¯å‘é€äº‹ä»¶é€šçŸ¥</strong> ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°é€šçŸ¥åæ‰¾åˆ°è‡ªå·±å®šä¹‰çš„ <code>Watcher</code> ç„¶å <strong>æ‰§è¡Œç›¸åº”çš„å›è°ƒæ–¹æ³•</strong> ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/6a11f5f5204500938b548bbabeffbe59c450c785aa5e66c10c84e22e66be88df/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f32343161623863633337353731303334666139383433323262373533633762612e706e67"><img src="https://camo.githubusercontent.com/6a11f5f5204500938b548bbabeffbe59c450c785aa5e66c10c84e22e66be88df/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f32343161623863633337353731303334666139383433323262373533633762612e706e67" alt="watcheræœºåˆ¶"></a></p><h2 id="7-Zookeeperçš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯"><a href="#7-Zookeeperçš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯" class="headerlink" title="7. Zookeeperçš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯"></a>7. Zookeeperçš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯</h2><p>å‰é¢è¯´äº†è¿™ä¹ˆå¤šçš„ç†è®ºçŸ¥è¯†ï¼Œä½ å¯èƒ½å¬å¾—ä¸€å¤´é›¾æ°´ï¼Œè¿™äº›ç©æ„æœ‰å•¥ç”¨ï¼Ÿèƒ½å¹²å•¥äº‹ï¼Ÿåˆ«æ€¥ï¼Œå¬æˆ‘æ…¢æ…¢é“æ¥ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/a838fc021a499e66e0fc6ea594a4978bf6a73fc64ef6eeba86c73dff4a5fc870/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f39633962643261383932653233653062373538323337306335303131376438632e706e67"><img src="https://camo.githubusercontent.com/a838fc021a499e66e0fc6ea594a4978bf6a73fc64ef6eeba86c73dff4a5fc870/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f39633962643261383932653233653062373538323337306335303131376438632e706e67" alt="img"></a></p><h3 id="7-1-é€‰ä¸»"><a href="#7-1-é€‰ä¸»" class="headerlink" title="7.1. é€‰ä¸»"></a>7.1. é€‰ä¸»</h3><p>è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬çš„æ‰€è¯´çš„ä¸´æ—¶èŠ‚ç‚¹å—ï¼Ÿå› ä¸º <code>Zookeeper</code> çš„å¼ºä¸€è‡´æ€§ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°åœ¨ä¿è¯ <strong>åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¿è¯èŠ‚ç‚¹åˆ›å»ºçš„å…¨å±€å”¯ä¸€æ€§</strong> (å³æ— æ³•é‡å¤åˆ›å»ºåŒæ ·çš„èŠ‚ç‚¹)ã€‚</p><p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ <strong>è®©å¤šä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæŒ‡å®šçš„èŠ‚ç‚¹</strong> ï¼Œåˆ›å»ºæˆåŠŸçš„å°±æ˜¯ <code>master</code>ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸ª <code>master</code> æŒ‚äº†æ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿ</p><p>ä½ æƒ³æƒ³ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Ÿè¿˜è®°å¾—ä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ<code>master</code> æŒ‚äº†æ˜¯ä¸æ˜¯ä»£è¡¨ä¼šè¯æ–­äº†ï¼Ÿä¼šè¯æ–­äº†æ˜¯ä¸æ˜¯æ„å‘³ç€è¿™ä¸ªèŠ‚ç‚¹æ²¡äº†ï¼Ÿè¿˜è®°å¾— <code>watcher</code> å—ï¼Ÿæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ <strong>è®©å…¶ä»–ä¸æ˜¯ <code>master</code> çš„èŠ‚ç‚¹ç›‘å¬èŠ‚ç‚¹çš„çŠ¶æ€</strong> ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ç›‘å¬è¿™ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹ä¸ªæ•°å˜äº†å°±ä»£è¡¨ <code>master</code> æŒ‚äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ <strong>è§¦å‘å›è°ƒå‡½æ•°è¿›è¡Œé‡æ–°é€‰ä¸¾</strong> ï¼Œæˆ–è€…æˆ‘ä»¬ç›´æ¥ç›‘å¬èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡èŠ‚ç‚¹æ˜¯å¦å·²ç»å¤±å»è¿æ¥æ¥åˆ¤æ–­ <code>master</code> æ˜¯å¦æŒ‚äº†ç­‰ç­‰ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d699db5d4e7733aadf1908e223eb0090a5b96d868a6c9c74d789d466ef801ac4/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f61393437303730323863353538316338313566373266626130663530663433612e706e67"><img src="https://camo.githubusercontent.com/d699db5d4e7733aadf1908e223eb0090a5b96d868a6c9c74d789d466ef801ac4/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f61393437303730323863353538316338313566373266626130663530663433612e706e67" alt="é€‰ä¸»"></a></p><p>æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨ <strong>åˆ©ç”¨ ä¸´æ—¶èŠ‚ç‚¹ã€èŠ‚ç‚¹çŠ¶æ€ å’Œ <code>watcher</code> æ¥å®ç°é€‰ä¸»çš„åŠŸèƒ½</strong>ï¼Œä¸´æ—¶èŠ‚ç‚¹ä¸»è¦ç”¨æ¥é€‰ä¸¾ï¼ŒèŠ‚ç‚¹çŠ¶æ€å’Œ<code>watcher</code> å¯ä»¥ç”¨æ¥åˆ¤æ–­ <code>master</code> çš„æ´»æ€§å’Œè¿›è¡Œé‡æ–°é€‰ä¸¾ã€‚</p><h3 id="7-2-åˆ†å¸ƒå¼é”"><a href="#7-2-åˆ†å¸ƒå¼é”" class="headerlink" title="7.2. åˆ†å¸ƒå¼é”"></a>7.2. åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ <code>Redis</code> ã€æ•°æ®åº“ ã€<code>zookeeper</code> ç­‰ã€‚ä¸ªäººè®¤ä¸º <code>zookeeper</code> åœ¨å®ç°åˆ†å¸ƒå¼é”è¿™æ–¹é¢æ˜¯éå¸¸éå¸¸ç®€å•çš„ã€‚</p><p>ä¸Šé¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡äº† <strong>zkåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¿è¯èŠ‚ç‚¹åˆ›å»ºçš„å…¨å±€å”¯ä¸€æ€§</strong>ï¼Œè¿™ç©æ„ä¸€çœ‹å°±çŸ¥é“èƒ½å¹²å•¥äº†ã€‚å®ç°äº’æ–¥é”å‘—ï¼Œåˆå› ä¸ºèƒ½åœ¨åˆ†å¸ƒå¼çš„æƒ…å†µä¸‹ï¼Œæ‰€ä»¥èƒ½å®ç°åˆ†å¸ƒå¼é”å‘—ã€‚</p><p>å¦‚ä½•å®ç°å‘¢ï¼Ÿè¿™ç©æ„å…¶å®è·Ÿé€‰ä¸»åŸºæœ¬ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨ä¸´æ—¶èŠ‚ç‚¹çš„åˆ›å»ºæ¥å®ç°ã€‚</p><p>é¦–å…ˆè‚¯å®šæ˜¯å¦‚ä½•è·å–é”ï¼Œå› ä¸ºåˆ›å»ºèŠ‚ç‚¹çš„å”¯ä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è®©å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œ<strong>åˆ›å»ºæˆåŠŸçš„å°±è¯´æ˜è·å–åˆ°äº†é”</strong> ã€‚ç„¶åæ²¡æœ‰è·å–åˆ°é”çš„å®¢æˆ·ç«¯ä¹Ÿåƒä¸Šé¢é€‰ä¸»çš„éä¸»èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª <code>watcher</code> è¿›è¡ŒèŠ‚ç‚¹çŠ¶æ€çš„ç›‘å¬ï¼Œå¦‚æœè¿™ä¸ªäº’æ–¥é”è¢«é‡Šæ”¾äº†ï¼ˆå¯èƒ½è·å–é”çš„å®¢æˆ·ç«¯å®•æœºäº†ï¼Œæˆ–è€…é‚£ä¸ªå®¢æˆ·ç«¯ä¸»åŠ¨é‡Šæ”¾äº†é”ï¼‰å¯ä»¥è°ƒç”¨å›è°ƒå‡½æ•°é‡æ–°è·å¾—é”ã€‚</p><blockquote><p><code>zk</code> ä¸­ä¸éœ€è¦å‘ <code>redis</code> é‚£æ ·è€ƒè™‘é”å¾—ä¸åˆ°é‡Šæ”¾çš„é—®é¢˜äº†ï¼Œå› ä¸ºå½“å®¢æˆ·ç«¯æŒ‚äº†ï¼ŒèŠ‚ç‚¹ä¹ŸæŒ‚äº†ï¼Œé”ä¹Ÿé‡Šæ”¾äº†ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿ</p></blockquote><p>é‚£èƒ½ä¸èƒ½ä½¿ç”¨ <code>zookeeper</code> åŒæ—¶å®ç° <strong>å…±äº«é”å’Œç‹¬å é”</strong> å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡ç¨å¾®æœ‰ç‚¹å¤æ‚è€Œå·²ã€‚</p><p>è¿˜è®°å¾— <strong>æœ‰åºçš„èŠ‚ç‚¹</strong> å—ï¼Ÿ</p><p>è¿™ä¸ªæ—¶å€™æˆ‘è§„å®šæ‰€æœ‰åˆ›å»ºèŠ‚ç‚¹å¿…é¡»æœ‰åºï¼Œå½“ä½ æ˜¯è¯»è¯·æ±‚ï¼ˆè¦è·å–å…±äº«é”ï¼‰çš„è¯ï¼Œå¦‚æœ <strong>æ²¡æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹ï¼Œæˆ–æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹éƒ½æ˜¯è¯»è¯·æ±‚</strong> ï¼Œåˆ™å¯ä»¥è·å–åˆ°è¯»é”ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹è¯»äº†ã€‚<strong>è‹¥æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹ä¸­æœ‰å†™è¯·æ±‚</strong> ï¼Œåˆ™å½“å‰å®¢æˆ·ç«¯æ— æ³•è·å–åˆ°è¯»é”ï¼Œåªèƒ½ç­‰å¾…å‰é¢çš„å†™è¯·æ±‚å®Œæˆã€‚</p><p>å¦‚æœä½ æ˜¯å†™è¯·æ±‚ï¼ˆè·å–ç‹¬å é”ï¼‰ï¼Œè‹¥ <strong>æ²¡æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹</strong> ï¼Œåˆ™è¡¨ç¤ºå½“å‰å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥è·å–åˆ°å†™é”ï¼Œå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚è‹¥å‘ç° <strong>æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹ï¼Œæ— è®ºæ˜¯è¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œï¼Œå½“å‰å®¢æˆ·ç«¯éƒ½æ— æ³•è·å–åˆ°å†™é”</strong> ï¼Œç­‰å¾…æ‰€æœ‰å‰é¢çš„æ“ä½œå®Œæˆã€‚</p><p>è¿™å°±å¾ˆå¥½åœ°åŒæ—¶å®ç°äº†å…±äº«é”å’Œç‹¬å é”ï¼Œå½“ç„¶è¿˜æœ‰ä¼˜åŒ–çš„åœ°æ–¹ï¼Œæ¯”å¦‚å½“ä¸€ä¸ªé”å¾—åˆ°é‡Šæ”¾å®ƒä¼šé€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„å®¢æˆ·ç«¯ä»è€Œé€ æˆ <strong>ç¾Šç¾¤æ•ˆåº”</strong> ã€‚æ­¤æ—¶ä½ å¯ä»¥é€šè¿‡è®©ç­‰å¾…çš„èŠ‚ç‚¹åªç›‘å¬ä»–ä»¬å‰é¢çš„èŠ‚ç‚¹ã€‚</p><p>å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œä½ å¯ä»¥è®© <strong>è¯»è¯·æ±‚ç›‘å¬æ¯”è‡ªå·±å°çš„æœ€åä¸€ä¸ªå†™è¯·æ±‚èŠ‚ç‚¹ï¼Œå†™è¯·æ±‚åªç›‘å¬æ¯”è‡ªå·±å°çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</strong> ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸€ä¸‹ã€‚</p><h3 id="7-3-å‘½åæœåŠ¡"><a href="#7-3-å‘½åæœåŠ¡" class="headerlink" title="7.3. å‘½åæœåŠ¡"></a>7.3. å‘½åæœåŠ¡</h3><p>å¦‚ä½•ç»™ä¸€ä¸ªå¯¹è±¡è®¾ç½®IDï¼Œå¤§å®¶å¯èƒ½éƒ½ä¼šæƒ³åˆ° <code>UUID</code>ï¼Œä½†æ˜¯ <code>UUID</code> æœ€å¤§çš„é—®é¢˜å°±åœ¨äºå®ƒå¤ªé•¿äº†ã€‚ã€‚ã€‚(å¤ªé•¿ä¸ä¸€å®šæ˜¯å¥½äº‹ï¼Œå˜¿å˜¿å˜¿)ã€‚é‚£ä¹ˆåœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½ä½¿ç”¨ <code>zookeeper</code> æ¥å®ç°å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ <code>zookeeper</code> æ˜¯é€šè¿‡ <strong>æ ‘å½¢ç»“æ„</strong> æ¥å­˜å‚¨æ•°æ®èŠ‚ç‚¹çš„ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸ªèŠ‚ç‚¹çš„ <strong>å…¨è·¯å¾„</strong>ï¼Œå®ƒå¿…å®šæ˜¯å”¯ä¸€çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹çš„å…¨è·¯å¾„ä½œä¸ºå‘½åæ–¹å¼äº†ã€‚è€Œä¸”æ›´é‡è¦çš„æ˜¯ï¼Œè·¯å¾„æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰çš„ï¼Œè¿™å¯¹äºæˆ‘ä»¬å¯¹æœ‰äº›æœ‰è¯­æ„çš„å¯¹è±¡çš„IDè®¾ç½®å¯ä»¥æ›´åŠ ä¾¿äºç†è§£ã€‚</p><h3 id="7-4-é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ"><a href="#7-4-é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="7.4. é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ"></a>7.4. é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ</h3><p>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯è§‰å¾— <code>zookeeper</code> å®åœ¨æ˜¯å¤ªå¼ºå¤§äº†ï¼Œå®ƒæ€ä¹ˆèƒ½è¿™ä¹ˆèƒ½å¹²ï¼</p><p>åˆ«æ€¥ï¼Œå®ƒèƒ½å¹²çš„äº‹æƒ…è¿˜å¾ˆå¤šå‘¢ã€‚å¯èƒ½æˆ‘ä»¬ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£æ•´ä¸ªé›†ç¾¤ä¸­æœ‰å¤šå°‘æœºå™¨åœ¨å·¥ä½œï¼Œæˆ‘ä»¬æƒ³å¯¹é›†ç¾¤ä¸­çš„æ¯å°æœºå™¨çš„è¿è¡Œæ—¶çŠ¶æ€è¿›è¡Œæ•°æ®é‡‡é›†ï¼Œå¯¹é›†ç¾¤ä¸­æœºå™¨è¿›è¡Œä¸Šä¸‹çº¿æ“ä½œç­‰ç­‰ã€‚</p><p>è€Œ <code>zookeeper</code> å¤©ç„¶æ”¯æŒçš„ <code>watcher</code> å’Œ ä¸´æ—¶èŠ‚ç‚¹èƒ½å¾ˆå¥½çš„å®ç°è¿™äº›éœ€æ±‚ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºæ¯æ¡æœºå™¨åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Œå¹¶ç›‘æ§å…¶çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹åˆ—è¡¨æœ‰å˜åŠ¨ï¼ˆæˆ‘ä»¬å¯èƒ½åˆ›å»ºåˆ é™¤äº†ä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨å…¶çˆ¶èŠ‚ç‚¹ç»‘å®šçš„ <code>watcher</code> è¿›è¡ŒçŠ¶æ€ç›‘æ§å’Œå›è°ƒã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/74084b1a9ca9db8ae26f336e8338e014e2b7c7a3f5ae38bd6b6b6e23592728c6/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f36313135383230323139633335633638626362326339613835356562616365332e706e67"><img src="https://camo.githubusercontent.com/74084b1a9ca9db8ae26f336e8338e014e2b7c7a3f5ae38bd6b6b6e23592728c6/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f36313135383230323139633335633638626362326339613835356562616365332e706e67" alt="é›†ç¾¤ç®¡ç†"></a></p><p>è‡³äºæ³¨å†Œä¸­å¿ƒä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿæ˜¯è®© <strong>æœåŠ¡æä¾›è€…</strong> åœ¨ <code>zookeeper</code> ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹å¹¶ä¸”å°†è‡ªå·±çš„ <code>ipã€portã€è°ƒç”¨æ–¹å¼</code> å†™å…¥èŠ‚ç‚¹ï¼Œå½“ <strong>æœåŠ¡æ¶ˆè´¹è€…</strong> éœ€è¦è¿›è¡Œè°ƒç”¨çš„æ—¶å€™ä¼š <strong>é€šè¿‡æ³¨å†Œä¸­å¿ƒæ‰¾åˆ°ç›¸åº”çš„æœåŠ¡çš„åœ°å€åˆ—è¡¨(IPç«¯å£ä»€ä¹ˆçš„)</strong> ï¼Œå¹¶ç¼“å­˜åˆ°æœ¬åœ°(æ–¹ä¾¿ä»¥åè°ƒç”¨)ï¼Œå½“æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡æ—¶ï¼Œä¸ä¼šå†å»è¯·æ±‚æ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•ä»åœ°å€åˆ—è¡¨ä¸­å–ä¸€ä¸ªæœåŠ¡æä¾›è€…çš„æœåŠ¡å™¨è°ƒç”¨æœåŠ¡ã€‚</p><p>å½“æœåŠ¡æä¾›è€…çš„æŸå°æœåŠ¡å™¨å®•æœºæˆ–ä¸‹çº¿æ—¶ï¼Œç›¸åº”çš„åœ°å€ä¼šä»æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨ä¸­ç§»é™¤ã€‚åŒæ—¶ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå°†æ–°çš„æœåŠ¡åœ°å€åˆ—è¡¨å‘é€ç»™æœåŠ¡æ¶ˆè´¹è€…çš„æœºå™¨å¹¶ç¼“å­˜åœ¨æ¶ˆè´¹è€…æœ¬æœºï¼ˆå½“ç„¶ä½ å¯ä»¥è®©æ¶ˆè´¹è€…è¿›è¡ŒèŠ‚ç‚¹ç›‘å¬ï¼Œæˆ‘è®°å¾— <code>Eureka</code> ä¼šå…ˆè¯•é”™ï¼Œç„¶åå†æ›´æ–°ï¼‰ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/595441ee538e1ac20ea08cd64fe0e83f91a8b92011b4a8b5a7f02299956ff914/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f30623562333931316137633264616532333339316431376339313431366232392e706e67"><img src="https://camo.githubusercontent.com/595441ee538e1ac20ea08cd64fe0e83f91a8b92011b4a8b5a7f02299956ff914/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f30623562333931316137633264616532333339316431376339313431366232392e706e67" alt="æ³¨å†Œä¸­å¿ƒ"></a></p><h2 id="8-æ€»ç»“"><a href="#8-æ€»ç»“" class="headerlink" title="8. æ€»ç»“"></a>8. æ€»ç»“</h2><p>çœ‹åˆ°è¿™é‡Œçš„åŒå­¦å®åœ¨æ˜¯å¤ªæœ‰è€å¿ƒäº†ğŸ‘ğŸ‘ğŸ‘ï¼Œå¦‚æœè§‰å¾—æˆ‘å†™å¾—ä¸é”™çš„è¯ç‚¹ä¸ªèµå“ˆã€‚</p><p>ä¸çŸ¥é“å¤§å®¶æ˜¯å¦è¿˜è®°å¾—æˆ‘è®²äº†ä»€ä¹ˆğŸ˜’ã€‚</p><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/7f6c8deb2178bf3b85184b9ec0a9b714a02e00a28f5c5b125e48a9289f2ecc0d/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62306264653966333937396238663139313837653663333734616439383939332e706e67"><img src="https://camo.githubusercontent.com/7f6c8deb2178bf3b85184b9ec0a9b714a02e00a28f5c5b125e48a9289f2ecc0d/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f62306264653966333937396238663139313837653663333734616439383939332e706e67" alt="img"></a></p><p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘å¸¦å¤§å®¶å…¥é—¨äº† <code>zookeeper</code> è¿™ä¸ªå¼ºå¤§çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ã€‚ç°åœ¨æˆ‘ä»¬æ¥ç®€å•æ¢³ç†ä¸€ä¸‹æ•´ç¯‡æ–‡ç« çš„å†…å®¹ã€‚</p><ul><li><p>åˆ†å¸ƒå¼ä¸é›†ç¾¤çš„åŒºåˆ«</p></li><li><p><code>2PC</code> ã€<code>3PC</code> ä»¥åŠ <code>paxos</code> ç®—æ³•è¿™äº›ä¸€è‡´æ€§æ¡†æ¶çš„åŸç†å’Œå®ç°ã€‚</p></li><li><p><code>zookeeper</code> ä¸“é—¨çš„ä¸€è‡´æ€§ç®—æ³• <code>ZAB</code> åŸå­å¹¿æ’­åè®®çš„å†…å®¹ï¼ˆ<code>Leader</code> é€‰ä¸¾ã€å´©æºƒæ¢å¤ã€æ¶ˆæ¯å¹¿æ’­ï¼‰ã€‚</p></li><li><p><code>zookeeper</code> ä¸­çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œæ¯”å¦‚ <code>ACL</code>ï¼Œæ•°æ®èŠ‚ç‚¹ï¼Œä¼šè¯ï¼Œ<code>watcher</code>æœºåˆ¶ç­‰ç­‰ã€‚</p></li><li><p><code>zookeeper</code> çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚é€‰ä¸»ï¼Œæ³¨å†Œä¸­å¿ƒç­‰ç­‰ã€‚</p><p>å¦‚æœå¿˜äº†å¯ä»¥å›å»çœ‹çœ‹å†æ¬¡ç†è§£ä¸€ä¸‹ï¼Œå¦‚æœæœ‰ç–‘é—®å’Œå»ºè®®æ¬¢è¿æå‡ºğŸ¤ğŸ¤ğŸ¤ã€‚</p></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/16/2021-02-16-MQ%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/16/2021-02-16-MQ%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">MQé¢è¯•é—®é¢˜æ€»ç»“</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-16 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-16T19:30:00+08:00">2021-02-16</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨MQï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨MQï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨MQï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨MQï¼Ÿ</h2><p>ä½¿ç”¨MQçš„åœºæ™¯å¾ˆå¤šï¼Œä¸»è¦æœ‰ä¸‰ä¸ªï¼šè§£è€¦ã€å¼‚æ­¥ã€å‰Šå³°ã€‚</p><ul><li>è§£è€¦ï¼šå‡è®¾ç°åœ¨ï¼Œæ—¥å¿—ä¸å…‰è¦æ’å…¥åˆ°æ•°æ®åº“é‡Œï¼Œè¿˜è¦åœ¨ç¡¬ç›˜ä¸­å¢åŠ æ–‡ä»¶ç±»å‹çš„æ—¥å¿—ï¼ŒåŒæ—¶ï¼Œä¸€äº›å…³é”®æ—¥å¿—è¿˜è¦é€šè¿‡é‚®ä»¶çš„æ–¹å¼å‘é€ç»™æŒ‡å®šçš„äººã€‚é‚£ä¹ˆï¼Œå¦‚æœæŒ‰ç…§åŸæ¥çš„é€»è¾‘ï¼ŒAå¯èƒ½å°±éœ€è¦åœ¨åŸæ¥çš„ä»£ç ä¸Šåšæ‰©å±•ï¼Œé™¤äº†BæœåŠ¡ï¼Œè¿˜è¦åŠ ä¸Šæ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨å’Œæ—¥å¿—é‚®ä»¶çš„å‘é€ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ä½¿ç”¨äº†MQï¼Œé‚£ä¹ˆï¼ŒAæœåŠ¡æ˜¯ä¸éœ€è¦åšæ›´æ”¹çš„ï¼Œå®ƒè¿˜æ˜¯å°†æ¶ˆæ¯æ”¾åˆ°MQä¸­å³å¯ï¼Œå…¶å®ƒçš„æœåŠ¡ï¼Œæ— è®ºæ˜¯åŸæ¥çš„BæœåŠ¡è¿˜æ˜¯æ–°å¢çš„æ—¥å¿—æ–‡ä»¶å­˜å‚¨æœåŠ¡æˆ–æ—¥å¿—é‚®ä»¶å‘é€æœåŠ¡ï¼Œéƒ½ç›´æ¥ä»MQä¸­è·å–æ¶ˆæ¯å¹¶å¤„ç†å³å¯ã€‚è¿™å°±æ˜¯è§£è€¦ï¼Œå®ƒçš„å¥½å¤„æ˜¯æé«˜ç³»ç»Ÿçµæ´»æ€§ï¼Œæ‰©å±•æ€§ã€‚</li><li>å¼‚æ­¥ï¼šå¯ä»¥å°†ä¸€äº›éæ ¸å¿ƒæµç¨‹ï¼Œå¦‚æ—¥å¿—ï¼ŒçŸ­ä¿¡ï¼Œé‚®ä»¶ç­‰ï¼Œé€šè¿‡MQçš„æ–¹å¼å¼‚æ­¥å»å¤„ç†ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ç¼©çŸ­ä¸»æµç¨‹çš„å“åº”æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚</li><li>å‰Šå³°ï¼šMQçš„æœ¬è´¨å°±æ˜¯ä¸šåŠ¡çš„æ’é˜Ÿã€‚æ‰€ä»¥ï¼Œé¢å¯¹çªç„¶åˆ°æ¥çš„é«˜å¹¶å‘ï¼ŒMQä¹Ÿå¯ä»¥ä¸ç”¨æ…Œå¿™ï¼Œå…ˆæ’å¥½é˜Ÿï¼Œä¸è¦ç€æ€¥ï¼Œä¸€ä¸ªä¸€ä¸ªæ¥ã€‚å‰Šå³°çš„å¥½å¤„å°±æ˜¯é¿å…é«˜å¹¶å‘å‹å®ç³»ç»Ÿçš„å…³é”®ç»„ä»¶ï¼Œå¦‚æŸä¸ªæ ¸å¿ƒæœåŠ¡æˆ–æ•°æ®åº“ç­‰ã€‚</li></ul><p>ä¸‹é¢é™„åœºæ™¯è§£é‡Šï¼š</p><h3 id="è§£è€¦"><a href="#è§£è€¦" class="headerlink" title="è§£è€¦"></a>è§£è€¦</h3><p>åœºæ™¯ï¼šA ç³»ç»Ÿå‘é€æ•°æ®åˆ° BCD ä¸‰ä¸ªç³»ç»Ÿï¼Œé€šè¿‡æ¥å£è°ƒç”¨å‘é€ã€‚å¦‚æœ E ç³»ç»Ÿä¹Ÿè¦è¿™ä¸ªæ•°æ®å‘¢ï¼Ÿé‚£å¦‚æœ C ç³»ç»Ÿç°åœ¨ä¸éœ€è¦äº†å‘¢ï¼ŸA ç³»ç»Ÿè´Ÿè´£äººå‡ ä¹å´©æºƒâ€¦â€¦</p><p><img src="http://blog-img.coolsen.cn/img/727602-20200108091205317-949408193.png" alt="img"></p><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒA ç³»ç»Ÿè·Ÿå…¶å®ƒå„ç§ä¹±ä¸ƒå…«ç³Ÿçš„ç³»ç»Ÿä¸¥é‡è€¦åˆï¼ŒA ç³»ç»Ÿäº§ç”Ÿä¸€æ¡æ¯”è¾ƒå…³é”®çš„æ•°æ®ï¼Œå¾ˆå¤šç³»ç»Ÿéƒ½éœ€è¦ A ç³»ç»Ÿå°†è¿™ä¸ªæ•°æ®å‘é€è¿‡æ¥ã€‚A ç³»ç»Ÿè¦æ—¶æ—¶åˆ»åˆ»è€ƒè™‘ BCDE å››ä¸ªç³»ç»Ÿå¦‚æœæŒ‚äº†è¯¥å’‹åŠï¼Ÿè¦ä¸è¦é‡å‘ï¼Œè¦ä¸è¦æŠŠæ¶ˆæ¯å­˜èµ·æ¥ï¼Ÿå¤´å‘éƒ½ç™½äº†å•Šï¼</p><p>å¦‚æœä½¿ç”¨ MQï¼ŒA ç³»ç»Ÿäº§ç”Ÿä¸€æ¡æ•°æ®ï¼Œå‘é€åˆ° MQ é‡Œé¢å»ï¼Œå“ªä¸ªç³»ç»Ÿéœ€è¦æ•°æ®è‡ªå·±å» MQ é‡Œé¢æ¶ˆè´¹ã€‚å¦‚æœæ–°ç³»ç»Ÿéœ€è¦æ•°æ®ï¼Œç›´æ¥ä» MQ é‡Œæ¶ˆè´¹å³å¯ï¼›å¦‚æœæŸä¸ªç³»ç»Ÿä¸éœ€è¦è¿™æ¡æ•°æ®äº†ï¼Œå°±å–æ¶ˆå¯¹ MQ æ¶ˆæ¯çš„æ¶ˆè´¹å³å¯ã€‚è¿™æ ·ä¸‹æ¥ï¼ŒA ç³»ç»Ÿå‹æ ¹å„¿ä¸éœ€è¦å»è€ƒè™‘è¦ç»™è°å‘é€æ•°æ®ï¼Œä¸éœ€è¦ç»´æŠ¤è¿™ä¸ªä»£ç ï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘äººå®¶æ˜¯å¦è°ƒç”¨æˆåŠŸã€å¤±è´¥è¶…æ—¶ç­‰æƒ…å†µã€‚</p><p><img src="http://blog-img.coolsen.cn/img/727602-20200108091329888-1880681145.png" alt="img"></p><p>æ€»ç»“ï¼šé€šè¿‡ä¸€ä¸ª MQï¼ŒPub&#x2F;Sub å‘å¸ƒè®¢é˜…æ¶ˆæ¯è¿™ä¹ˆä¸€ä¸ªæ¨¡å‹ï¼ŒA ç³»ç»Ÿå°±è·Ÿå…¶å®ƒç³»ç»Ÿå½»åº•è§£è€¦äº†ã€‚</p><h3 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h3><p>åœºæ™¯ï¼šA ç³»ç»Ÿæ¥æ”¶ä¸€ä¸ªè¯·æ±‚ï¼Œéœ€è¦åœ¨è‡ªå·±æœ¬åœ°å†™åº“ï¼Œè¿˜éœ€è¦åœ¨ BCD ä¸‰ä¸ªç³»ç»Ÿå†™åº“ï¼Œè‡ªå·±æœ¬åœ°å†™åº“è¦ 3msï¼ŒBCD ä¸‰ä¸ªç³»ç»Ÿåˆ†åˆ«å†™åº“è¦ 300msã€450msã€200msã€‚æœ€ç»ˆè¯·æ±‚æ€»å»¶æ—¶æ˜¯ 3 + 300 + 450 + 200 &#x3D; 953msï¼Œæ¥è¿‘ 1sï¼Œç”¨æˆ·æ„Ÿè§‰æä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œæ…¢æ­»äº†æ…¢æ­»äº†ã€‚ç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‘èµ·è¯·æ±‚ï¼Œç­‰å¾…ä¸ª 1sï¼Œè¿™å‡ ä¹æ˜¯ä¸å¯æ¥å—çš„ã€‚</p><p><img src="http://blog-img.coolsen.cn/img/727602-20200108091632167-740723329.png" alt="img"></p><p>ä¸€èˆ¬äº’è”ç½‘ç±»çš„ä¼ä¸šï¼Œå¯¹äºç”¨æˆ·ç›´æ¥çš„æ“ä½œï¼Œä¸€èˆ¬è¦æ±‚æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»åœ¨ 200 ms ä»¥å†…å®Œæˆï¼Œå¯¹ç”¨æˆ·å‡ ä¹æ˜¯æ— æ„ŸçŸ¥çš„ã€‚</p><p>å¦‚æœä½¿ç”¨ MQï¼Œé‚£ä¹ˆ A ç³»ç»Ÿè¿ç»­å‘é€ 3 æ¡æ¶ˆæ¯åˆ° MQ é˜Ÿåˆ—ä¸­ï¼Œå‡å¦‚è€—æ—¶ 5msï¼ŒA ç³»ç»Ÿä»æ¥å—ä¸€ä¸ªè¯·æ±‚åˆ°è¿”å›å“åº”ç»™ç”¨æˆ·ï¼Œæ€»æ—¶é•¿æ˜¯ 3 + 5 &#x3D; 8msï¼Œå¯¹äºç”¨æˆ·è€Œè¨€ï¼Œå…¶å®æ„Ÿè§‰ä¸Šå°±æ˜¯ç‚¹ä¸ªæŒ‰é’®ï¼Œ8ms ä»¥åå°±ç›´æ¥è¿”å›äº†ã€‚</p><p><img src="http://blog-img.coolsen.cn/img/727602-20200108091722601-747710174.png" alt="img"></p><h3 id="å‰Šå³°"><a href="#å‰Šå³°" class="headerlink" title="å‰Šå³°"></a>å‰Šå³°</h3><p>åœºæ™¯ï¼šæ¯å¤© 0:00 åˆ° 12:00ï¼ŒA ç³»ç»Ÿé£å¹³æµªé™ï¼Œæ¯ç§’å¹¶å‘è¯·æ±‚æ•°é‡å°± 50 ä¸ªã€‚ç»“æœæ¯æ¬¡ä¸€åˆ° 12:00 ~ 13:00 ï¼Œæ¯ç§’å¹¶å‘è¯·æ±‚æ•°é‡çªç„¶ä¼šæš´å¢åˆ° 5k+ æ¡ã€‚ä½†æ˜¯ç³»ç»Ÿæ˜¯ç›´æ¥åŸºäº MySQL çš„ï¼Œå¤§é‡çš„è¯·æ±‚æ¶Œå…¥ MySQLï¼Œæ¯ç§’é’Ÿå¯¹ MySQL æ‰§è¡Œçº¦ 5k æ¡ SQLã€‚</p><p>ä½¿ç”¨ MQï¼Œæ¯ç§’ 5k ä¸ªè¯·æ±‚å†™å…¥ MQï¼ŒA ç³»ç»Ÿæ¯ç§’é’Ÿæœ€å¤šå¤„ç† 2k ä¸ªè¯·æ±‚ï¼Œå› ä¸º MySQL æ¯ç§’é’Ÿæœ€å¤šå¤„ç† 2k ä¸ªã€‚A ç³»ç»Ÿä» MQ ä¸­æ…¢æ…¢æ‹‰å–è¯·æ±‚ï¼Œæ¯ç§’é’Ÿå°±æ‹‰å– 2k ä¸ªè¯·æ±‚ï¼Œä¸è¦è¶…è¿‡è‡ªå·±æ¯ç§’èƒ½å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°é‡å°± okï¼Œè¿™æ ·ä¸‹æ¥ï¼Œå“ªæ€•æ˜¯é«˜å³°æœŸçš„æ—¶å€™ï¼ŒA ç³»ç»Ÿä¹Ÿç»å¯¹ä¸ä¼šæŒ‚æ‰ã€‚è€Œ MQ æ¯ç§’é’Ÿ 5k ä¸ªè¯·æ±‚è¿›æ¥ï¼Œå°± 2k ä¸ªè¯·æ±‚å‡ºå»ï¼Œç»“æœå°±å¯¼è‡´åœ¨ä¸­åˆé«˜å³°æœŸï¼ˆ1 ä¸ªå°æ—¶ï¼‰ï¼Œå¯èƒ½æœ‰å‡ åä¸‡ç”šè‡³å‡ ç™¾ä¸‡çš„è¯·æ±‚ç§¯å‹åœ¨ MQ ä¸­ã€‚</p><p><img src="http://blog-img.coolsen.cn/img/727602-20200108091915241-1598228624.png" alt="img"></p><p>è¿™ä¸ªçŸ­æš‚çš„é«˜å³°æœŸç§¯å‹æ˜¯ ok çš„ï¼Œå› ä¸ºé«˜å³°æœŸè¿‡äº†ä¹‹åï¼Œæ¯ç§’é’Ÿå°± 50 ä¸ªè¯·æ±‚è¿› MQï¼Œä½†æ˜¯ A ç³»ç»Ÿä¾ç„¶ä¼šæŒ‰ç…§æ¯ç§’ 2k ä¸ªè¯·æ±‚çš„é€Ÿåº¦åœ¨å¤„ç†ã€‚æ‰€ä»¥è¯´ï¼Œåªè¦é«˜å³°æœŸä¸€è¿‡ï¼ŒA ç³»ç»Ÿå°±ä¼šå¿«é€Ÿå°†ç§¯å‹çš„æ¶ˆæ¯ç»™è§£å†³æ‰ã€‚</p><h2 id="æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹"><a href="#æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹"></a>æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹</h2><p>1ã€ ç³»ç»Ÿå¯ç”¨æ€§é™ä½</p><p>ç³»ç»Ÿå¼•å…¥çš„å¤–éƒ¨ä¾èµ–è¶Šå¤šï¼Œè¶Šå®¹æ˜“æŒ‚æ‰ã€‚</p><p>2ã€ ç³»ç»Ÿå¤æ‚åº¦æé«˜</p><p>åŠ å…¥äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¦å¤šè€ƒè™‘å¾ˆå¤šæ–¹é¢çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼šä¸€è‡´æ€§é—®é¢˜ã€å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ã€å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§ä¼ è¾“ç­‰ã€‚å› æ­¤ï¼Œéœ€è¦è€ƒè™‘çš„ä¸œè¥¿æ›´å¤šï¼Œå¤æ‚æ€§å¢å¤§ã€‚</p><p>3ã€ ä¸€è‡´æ€§é—®é¢˜</p><p>A ç³»ç»Ÿå¤„ç†å®Œäº†ç›´æ¥è¿”å›æˆåŠŸäº†ï¼Œäººéƒ½ä»¥ä¸ºä½ è¿™ä¸ªè¯·æ±‚å°±æˆåŠŸäº†ï¼›ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œè¦æ˜¯ BCD ä¸‰ä¸ªç³»ç»Ÿé‚£é‡Œï¼ŒBD ä¸¤ä¸ªç³»ç»Ÿå†™åº“æˆåŠŸäº†ï¼Œç»“æœ C ç³»ç»Ÿå†™åº“å¤±è´¥äº†ï¼Œè¿™å°±æ•°æ®ä¸ä¸€è‡´äº†ã€‚</p><h2 id="Kafkaã€ActiveMQã€RabbitMQã€RocketMQ-æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"><a href="#Kafkaã€ActiveMQã€RabbitMQã€RocketMQ-æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ" class="headerlink" title="Kafkaã€ActiveMQã€RabbitMQã€RocketMQ æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"></a>Kafkaã€ActiveMQã€RabbitMQã€RocketMQ æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</h2><table><thead><tr><th>ç‰¹æ€§</th><th>ActiveMQ</th><th>RabbitMQ</th><th>RocketMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>å¼€å‘è¯­è¨€</td><td>java</td><td>erlang</td><td>java</td><td>scala</td></tr><tr><td>å•æœºååé‡</td><td>ä¸‡çº§ï¼Œæ¯” RocketMQã€Kafka ä½ä¸€ä¸ªæ•°é‡çº§</td><td>åŒ ActiveMQ</td><td>10 ä¸‡çº§ï¼Œæ”¯æ’‘é«˜åå</td><td>10 ä¸‡çº§ï¼Œé«˜ååï¼Œä¸€èˆ¬é…åˆå¤§æ•°æ®ç±»çš„ç³»ç»Ÿæ¥è¿›è¡Œå®æ—¶æ•°æ®è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯</td></tr><tr><td>topic æ•°é‡å¯¹ååé‡çš„å½±å“</td><td></td><td></td><td>topic å¯ä»¥è¾¾åˆ°å‡ ç™¾&#x2F;å‡ åƒçš„çº§åˆ«ï¼Œååé‡ä¼šæœ‰è¾ƒå°å¹…åº¦çš„ä¸‹é™ï¼Œè¿™æ˜¯ RocketMQ çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼Œå¯ä»¥æ”¯æ’‘å¤§é‡çš„ topic</td><td>topic ä»å‡ ååˆ°å‡ ç™¾ä¸ªæ—¶å€™ï¼Œååé‡ä¼šå¤§å¹…åº¦ä¸‹é™ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼ŒKafka å°½é‡ä¿è¯ topic æ•°é‡ä¸è¦è¿‡å¤šï¼Œå¦‚æœè¦æ”¯æ’‘å¤§è§„æ¨¡çš„ topicï¼Œéœ€è¦å¢åŠ æ›´å¤šçš„æœºå™¨èµ„æº</td></tr><tr><td>æ—¶æ•ˆæ€§</td><td>ms çº§</td><td>å¾®ç§’çº§ï¼Œè¿™æ˜¯ RabbitMQ çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå»¶è¿Ÿæœ€ä½</td><td>ms çº§</td><td>å»¶è¿Ÿåœ¨ ms çº§ä»¥å†…</td></tr><tr><td>å¯ç”¨æ€§</td><td>é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°é«˜å¯ç”¨</td><td>åŒ ActiveMQ</td><td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼æ¶æ„</td><td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼Œå°‘æ•°æœºå™¨å®•æœºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´ä¸å¯ç”¨</td></tr><tr><td>æ¶ˆæ¯å¯é æ€§</td><td>æœ‰è¾ƒä½çš„æ¦‚ç‡ä¸¢å¤±æ•°æ®</td><td>åŸºæœ¬ä¸ä¸¢</td><td>ç»è¿‡å‚æ•°ä¼˜åŒ–é…ç½®ï¼Œå¯ä»¥åšåˆ° 0 ä¸¢å¤±</td><td>åŒ RocketMQ</td></tr><tr><td>åŠŸèƒ½æ”¯æŒ</td><td>MQ é¢†åŸŸçš„åŠŸèƒ½æå…¶å®Œå¤‡</td><td>åŸºäº erlang å¼€å‘ï¼Œå¹¶å‘èƒ½åŠ›å¾ˆå¼ºï¼Œæ€§èƒ½æå¥½ï¼Œå»¶æ—¶å¾ˆä½</td><td>MQ åŠŸèƒ½è¾ƒä¸ºå®Œå–„ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰©å±•æ€§å¥½</td><td>åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ”¯æŒç®€å•çš„ MQ åŠŸèƒ½ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ä»¥åŠæ—¥å¿—é‡‡é›†è¢«å¤§è§„æ¨¡ä½¿ç”¨</td></tr><tr><td>ç¤¾åŒºæ´»è·ƒåº¦</td><td>ä½</td><td>å¾ˆé«˜</td><td>ä¸€èˆ¬</td><td>å¾ˆé«˜</td></tr></tbody></table><ul><li>ä¸­å°å‹å…¬å¸ï¼ŒæŠ€æœ¯å®åŠ›è¾ƒä¸ºä¸€èˆ¬ï¼ŒæŠ€æœ¯æŒ‘æˆ˜ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œç”¨ RabbitMQ æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›</li><li>å¤§å‹å…¬å¸ï¼ŒåŸºç¡€æ¶æ„ç ”å‘å®åŠ›è¾ƒå¼ºï¼Œç”¨ RocketMQ æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚</li><li>å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯ï¼Œç”¨ Kafka æ˜¯ä¸šå†…æ ‡å‡†çš„ï¼Œå‡ ä¹æ˜¯å…¨ä¸–ç•Œè¿™ä¸ªé¢†åŸŸçš„äº‹å®æ€§è§„èŒƒã€‚</li></ul><h1 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h1><h2 id="1-RabbitMQæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-RabbitMQæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1. RabbitMQæ˜¯ä»€ä¹ˆï¼Ÿ"></a>1. RabbitMQæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>RabbitMQæ˜¯å®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆäº¦ç§°é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰ã€‚RabbitMQæœåŠ¡å™¨æ˜¯ç”¨Erlangè¯­è¨€ç¼–å†™çš„ï¼Œè€Œç¾¤é›†å’Œæ•…éšœè½¬ç§»æ˜¯æ„å»ºåœ¨å¼€æ”¾ç”µä¿¡å¹³å°æ¡†æ¶ä¸Šçš„ã€‚æ‰€æœ‰ä¸»è¦çš„ç¼–ç¨‹è¯­è¨€å‡æœ‰ä¸ä»£ç†æ¥å£é€šè®¯çš„å®¢æˆ·ç«¯åº“ã€‚</p><h2 id="2-RabbitMQç‰¹ç‚¹"><a href="#2-RabbitMQç‰¹ç‚¹" class="headerlink" title="2. RabbitMQç‰¹ç‚¹?"></a>2. RabbitMQç‰¹ç‚¹?</h2><p>å¯é æ€§: RabbitMQä½¿ç”¨ä¸€äº›æœºåˆ¶æ¥ä¿è¯å¯é æ€§ï¼Œ å¦‚æŒä¹…åŒ–ã€ä¼ è¾“ç¡®è®¤åŠå‘å¸ƒç¡®è®¤ç­‰ã€‚</p><p>çµæ´»çš„è·¯ç”± : åœ¨æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ä¹‹å‰ï¼Œé€šè¿‡äº¤æ¢å™¨æ¥è·¯ç”±æ¶ˆæ¯ã€‚å¯¹äºå…¸å‹çš„è·¯ç”±åŠŸèƒ½ï¼Œ RabbitMQ å·±ç»æä¾›äº†ä¸€äº›å†…ç½®çš„äº¤æ¢å™¨æ¥å®ç°ã€‚é’ˆå¯¹æ›´å¤æ‚çš„è·¯ç”±åŠŸèƒ½ï¼Œå¯ä»¥å°†å¤šä¸ª äº¤æ¢å™¨ç»‘å®šåœ¨ä¸€èµ·ï¼Œ ä¹Ÿå¯ä»¥é€šè¿‡æ’ä»¶æœºåˆ¶æ¥å®ç°è‡ªå·±çš„äº¤æ¢å™¨ã€‚</p><p>æ‰©å±•æ€§: å¤šä¸ªRabbitMQèŠ‚ç‚¹å¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µåŠ¨æ€åœ°æ‰©å±• é›†ç¾¤ä¸­èŠ‚ç‚¹ã€‚</p><p>é«˜å¯ç”¨æ€§ : é˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„æœºå™¨ä¸Šè®¾ç½®é•œåƒï¼Œä½¿å¾—åœ¨éƒ¨åˆ†èŠ‚ç‚¹å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹é˜Ÿ åˆ—ä»ç„¶å¯ç”¨ã€‚</p><p>å¤šç§åè®®: RabbitMQé™¤äº†åŸç”Ÿæ”¯æŒAMQPåè®®ï¼Œè¿˜æ”¯æŒSTOMPï¼Œ MQTTç­‰å¤šç§æ¶ˆæ¯ ä¸­é—´ä»¶åè®®ã€‚</p><p>å¤šè¯­è¨€å®¢æˆ·ç«¯ :RabbitMQ å‡ ä¹æ”¯æŒæ‰€æœ‰å¸¸ç”¨è¯­è¨€ï¼Œæ¯”å¦‚ Javaã€ Pythonã€ Rubyã€ PHPã€ C#ã€ JavaScript ç­‰ã€‚</p><p>ç®¡ç†ç•Œé¢ : RabbitMQ æä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ç›‘æ§å’Œç®¡ç†æ¶ˆæ¯ã€é›† ç¾¤ä¸­çš„èŠ‚ç‚¹ç­‰ã€‚</p><p>ä»¤æ’ä»¶æœºåˆ¶: RabbitMQ æä¾›äº†è®¸å¤šæ’ä»¶ ï¼Œ ä»¥å®ç°ä»å¤šæ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç¼–å†™è‡ª å·±çš„æ’ä»¶ã€‚</p><h2 id="3-AMQPæ˜¯ä»€ä¹ˆ"><a href="#3-AMQPæ˜¯ä»€ä¹ˆ" class="headerlink" title="3. AMQPæ˜¯ä»€ä¹ˆ?"></a>3. AMQPæ˜¯ä»€ä¹ˆ?</h2><p>RabbitMQå°±æ˜¯ AMQP åè®®çš„ <code>Erlang</code> çš„å®ç°(å½“ç„¶ RabbitMQ è¿˜æ”¯æŒ <code>STOMP2</code>ã€ <code>MQTT3</code> ç­‰åè®® ) AMQP çš„æ¨¡å‹æ¶æ„ å’Œ RabbitMQ çš„æ¨¡å‹æ¶æ„æ˜¯ä¸€æ ·çš„ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™äº¤æ¢å™¨ï¼Œäº¤æ¢å™¨å’Œé˜Ÿåˆ—ç»‘å®š ã€‚</p><p>RabbitMQ ä¸­çš„äº¤æ¢å™¨ã€äº¤æ¢å™¨ç±»å‹ã€é˜Ÿåˆ—ã€ç»‘å®šã€è·¯ç”±é”®ç­‰éƒ½æ˜¯éµå¾ªçš„ AMQP åè®®ä¸­ç›¸ åº”çš„æ¦‚å¿µã€‚ç›®å‰ RabbitMQ æœ€æ–°ç‰ˆæœ¬é»˜è®¤æ”¯æŒçš„æ˜¯ AMQP 0-9-1ã€‚</p><h2 id="4-AMQPçš„3å±‚åè®®ï¼Ÿ"><a href="#4-AMQPçš„3å±‚åè®®ï¼Ÿ" class="headerlink" title="4. AMQPçš„3å±‚åè®®ï¼Ÿ"></a>4. AMQPçš„3å±‚åè®®ï¼Ÿ</h2><p>Module Layer:åè®®æœ€é«˜å±‚ï¼Œä¸»è¦å®šä¹‰äº†ä¸€äº›å®¢æˆ·ç«¯è°ƒç”¨çš„å‘½ä»¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç”¨è¿™äº›å‘½ä»¤å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>Session Layer:ä¸­é—´å±‚ï¼Œä¸»è¦è´Ÿè´£å®¢æˆ·ç«¯å‘½ä»¤å‘é€ç»™æœåŠ¡å™¨ï¼Œå†å°†æœåŠ¡ç«¯åº”ç­”è¿”å›å®¢æˆ·ç«¯ï¼Œæä¾›å¯é æ€§åŒæ­¥æœºåˆ¶å’Œé”™è¯¯å¤„ç†ã€‚</p><p>TransportLayer:æœ€åº•å±‚ï¼Œä¸»è¦ä¼ è¾“äºŒè¿›åˆ¶æ•°æ®æµï¼Œæä¾›å¸§çš„å¤„ç†ã€ä¿¡é“æœç”¨ã€é”™è¯¯æ£€æµ‹å’Œæ•°æ®è¡¨ç¤ºç­‰ã€‚</p><h2 id="5-è¯´è¯´BrokeræœåŠ¡èŠ‚ç‚¹ã€Queueé˜Ÿåˆ—ã€Exchangeäº¤æ¢å™¨ï¼Ÿ"><a href="#5-è¯´è¯´BrokeræœåŠ¡èŠ‚ç‚¹ã€Queueé˜Ÿåˆ—ã€Exchangeäº¤æ¢å™¨ï¼Ÿ" class="headerlink" title="5. è¯´è¯´BrokeræœåŠ¡èŠ‚ç‚¹ã€Queueé˜Ÿåˆ—ã€Exchangeäº¤æ¢å™¨ï¼Ÿ"></a>5. è¯´è¯´BrokeræœåŠ¡èŠ‚ç‚¹ã€Queueé˜Ÿåˆ—ã€Exchangeäº¤æ¢å™¨ï¼Ÿ</h2><ul><li>Brokerå¯ä»¥çœ‹åšRabbitMQçš„æœåŠ¡èŠ‚ç‚¹ã€‚ä¸€èˆ¬è¯·ä¸‹ä¸€ä¸ªBrokerå¯ä»¥çœ‹åšä¸€ä¸ªRabbitMQæœåŠ¡å™¨ã€‚</li><li>Queue:RabbitMQçš„å†…éƒ¨å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨æ¶ˆæ¯ã€‚å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…åŒä¸€é˜Ÿåˆ—ï¼Œè¿™æ—¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šè¢«å¹³æ‘Šï¼ˆè½®è¯¢ï¼‰ç»™å¤šä¸ªæ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ã€‚</li><li>Exchange:ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢å™¨ï¼Œç”±äº¤æ¢å™¨å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé˜Ÿåˆ—ä¸­ã€‚å½“è·¯ç”±ä¸åˆ°æ—¶ï¼Œæˆ–è¿”å›ç»™ç”Ÿäº§è€…æˆ–ç›´æ¥ä¸¢å¼ƒã€‚</li></ul><h2 id="6-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ"><a href="#6-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ" class="headerlink" title="6. å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ"></a>6. å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Ÿ</h2><p>åˆ†ä¸‰ç‚¹ï¼š</p><ul><li>ç”Ÿäº§è€…åˆ°RabbitMQï¼šäº‹åŠ¡æœºåˆ¶å’ŒConfirmæœºåˆ¶ï¼Œæ³¨æ„ï¼šäº‹åŠ¡æœºåˆ¶å’Œ Confirm æœºåˆ¶æ˜¯äº’æ–¥çš„ï¼Œä¸¤è€…ä¸èƒ½å…±å­˜ï¼Œä¼šå¯¼è‡´ RabbitMQ æŠ¥é”™ã€‚</li><li>RabbitMQè‡ªèº«ï¼šæŒä¹…åŒ–ã€é›†ç¾¤ã€æ™®é€šæ¨¡å¼ã€é•œåƒæ¨¡å¼ã€‚</li><li>RabbitMQåˆ°æ¶ˆè´¹è€…ï¼šbasicAckæœºåˆ¶ã€æ­»ä¿¡é˜Ÿåˆ—ã€æ¶ˆæ¯è¡¥å¿æœºåˆ¶ã€‚</li></ul><h2 id="7-ç”Ÿäº§è€…æ¶ˆæ¯è¿è½¬çš„æµç¨‹ï¼Ÿ"><a href="#7-ç”Ÿäº§è€…æ¶ˆæ¯è¿è½¬çš„æµç¨‹ï¼Ÿ" class="headerlink" title="7. ç”Ÿäº§è€…æ¶ˆæ¯è¿è½¬çš„æµç¨‹ï¼Ÿ"></a>7. ç”Ÿäº§è€…æ¶ˆæ¯è¿è½¬çš„æµç¨‹ï¼Ÿ</h2><ol><li><p><code>Producer</code>å…ˆè¿æ¥åˆ°Broker,å»ºç«‹è¿æ¥Connection,å¼€å¯ä¸€ä¸ªä¿¡é“(Channel)ã€‚</p></li><li><p><code>Producer</code>å£°æ˜ä¸€ä¸ªäº¤æ¢å™¨å¹¶è®¾ç½®å¥½ç›¸å…³å±æ€§ã€‚</p></li><li><p><code>Producer</code>å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—å¹¶è®¾ç½®å¥½ç›¸å…³å±æ€§ã€‚</p></li><li><p><code>Producer</code>é€šè¿‡è·¯ç”±é”®å°†äº¤æ¢å™¨å’Œé˜Ÿåˆ—ç»‘å®šèµ·æ¥ã€‚</p></li><li><p><code>Producer</code>å‘é€æ¶ˆæ¯åˆ°<code>Broker</code>,å…¶ä¸­åŒ…å«è·¯ç”±é”®ã€äº¤æ¢å™¨ç­‰ä¿¡æ¯ã€‚</p></li><li><p>ç›¸åº”çš„äº¤æ¢å™¨æ ¹æ®æ¥æ”¶åˆ°çš„è·¯ç”±é”®æŸ¥æ‰¾åŒ¹é…çš„é˜Ÿåˆ—ã€‚</p></li><li><p>å¦‚æœæ‰¾åˆ°ï¼Œå°†æ¶ˆæ¯å­˜å…¥å¯¹åº”çš„é˜Ÿåˆ—ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä¼šæ ¹æ®ç”Ÿäº§è€…çš„é…ç½®ä¸¢å¼ƒæˆ–è€…é€€å›ç»™ç”Ÿäº§è€…ã€‚</p></li><li><p>å…³é—­ä¿¡é“ã€‚</p></li><li><p>ç®¡ç†è¿æ¥ã€‚</p></li></ol><h2 id="8-æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯è¿‡ç¨‹ï¼Ÿ"><a href="#8-æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯è¿‡ç¨‹ï¼Ÿ" class="headerlink" title="8.æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯è¿‡ç¨‹ï¼Ÿ"></a>8.æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯è¿‡ç¨‹ï¼Ÿ</h2><ol><li><p><code>Producer</code>å…ˆè¿æ¥åˆ°<code>Broker</code>,å»ºç«‹è¿æ¥<code>Connection</code>,å¼€å¯ä¸€ä¸ªä¿¡é“(<code>Channel</code>)ã€‚</p></li><li><p>å‘<code>Broker</code>è¯·æ±‚æ¶ˆè´¹å“åº”çš„é˜Ÿåˆ—ä¸­æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šè®¾ç½®å“åº”çš„å›è°ƒå‡½æ•°ã€‚</p></li><li><p>ç­‰å¾…<code>Broker</code>å›åº”å¹¶æŠ•é€’ç›¸åº”é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæ¥æ”¶æ¶ˆæ¯ã€‚</p></li><li><p>æ¶ˆè´¹è€…ç¡®è®¤æ”¶åˆ°çš„æ¶ˆæ¯,<code>ack</code>ã€‚</p></li><li><p><code>RabbitMq</code>ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²ç»ç¡®å®šçš„æ¶ˆæ¯ã€‚</p></li><li><p>å…³é—­ä¿¡é“ã€‚</p></li><li><p>å…³é—­è¿æ¥ã€‚</p></li></ol><h2 id="9-ç”Ÿäº§è€…å¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°RabbitMQï¼Ÿ"><a href="#9-ç”Ÿäº§è€…å¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°RabbitMQï¼Ÿ" class="headerlink" title="9. ç”Ÿäº§è€…å¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°RabbitMQï¼Ÿ"></a>9. ç”Ÿäº§è€…å¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°RabbitMQï¼Ÿ</h2><ol><li><p>Clientå‘é€æ¶ˆæ¯ç»™MQ</p></li><li><p>MQå°†æ¶ˆæ¯æŒä¹…åŒ–åï¼Œå‘é€Ackæ¶ˆæ¯ç»™Clientï¼Œæ­¤å¤„æœ‰å¯èƒ½å› ä¸ºç½‘ç»œé—®é¢˜å¯¼è‡´Ackæ¶ˆæ¯æ— æ³•å‘é€åˆ°Clientï¼Œé‚£ä¹ˆClientåœ¨ç­‰å¾…è¶…æ—¶åï¼Œä¼šé‡ä¼ æ¶ˆæ¯ï¼›</p></li><li><p>Clientæ”¶åˆ°Ackæ¶ˆæ¯åï¼Œè®¤ä¸ºæ¶ˆæ¯å·²ç»æŠ•é€’æˆåŠŸã€‚</p></li></ol><h2 id="10-RabbitMQå¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°æ¶ˆè´¹è€…ï¼Ÿ"><a href="#10-RabbitMQå¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°æ¶ˆè´¹è€…ï¼Ÿ" class="headerlink" title="10. RabbitMQå¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°æ¶ˆè´¹è€…ï¼Ÿ"></a>10. RabbitMQå¦‚ä½•å°†æ¶ˆæ¯å¯é æŠ•é€’åˆ°æ¶ˆè´¹è€…ï¼Ÿ</h2><ol><li><p>MQå°†æ¶ˆæ¯pushç»™Clientï¼ˆæˆ–Clientæ¥pullæ¶ˆæ¯ï¼‰</p></li><li><p>Clientå¾—åˆ°æ¶ˆæ¯å¹¶åšå®Œä¸šåŠ¡é€»è¾‘</p></li><li><p>Clientå‘é€Ackæ¶ˆæ¯ç»™MQï¼Œé€šçŸ¥MQåˆ é™¤è¯¥æ¶ˆæ¯ï¼Œæ­¤å¤„æœ‰å¯èƒ½å› ä¸ºç½‘ç»œé—®é¢˜å¯¼è‡´Ackå¤±è´¥ï¼Œé‚£ä¹ˆClientä¼šé‡å¤æ¶ˆæ¯ï¼Œè¿™é‡Œå°±å¼•å‡ºæ¶ˆè´¹å¹‚ç­‰çš„é—®é¢˜ï¼›</p></li><li><p>MQå°†å·²æ¶ˆè´¹çš„æ¶ˆæ¯åˆ é™¤ã€‚</p></li></ol><h2 id="11-å¦‚ä½•ä¿è¯RabbitMQæ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨"><a href="#11-å¦‚ä½•ä¿è¯RabbitMQæ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨" class="headerlink" title="11. å¦‚ä½•ä¿è¯RabbitMQæ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨?"></a>11. å¦‚ä½•ä¿è¯RabbitMQæ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨?</h2><p>RabbitMQ æœ‰ä¸‰ç§æ¨¡å¼ï¼š<code>å•æœºæ¨¡å¼</code>ï¼Œ<code>æ™®é€šé›†ç¾¤æ¨¡å¼</code>ï¼Œ<code>é•œåƒé›†ç¾¤æ¨¡å¼</code>ã€‚</p><p><strong>å•æœºæ¨¡å¼</strong>ï¼šå°±æ˜¯demoçº§åˆ«çš„ï¼Œä¸€èˆ¬å°±æ˜¯ä½ æœ¬åœ°å¯åŠ¨äº†ç©ç©å„¿çš„ï¼Œæ²¡äººç”Ÿäº§ç”¨å•æœºæ¨¡å¼</p><p><strong>æ™®é€šé›†ç¾¤æ¨¡å¼</strong>ï¼šæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ªRabbitMQå®ä¾‹ï¼Œæ¯ä¸ªæœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚</p><p><strong>é•œåƒé›†ç¾¤æ¨¡å¼</strong>ï¼šè¿™ç§æ¨¡å¼ï¼Œæ‰æ˜¯æ‰€è°“çš„RabbitMQçš„é«˜å¯ç”¨æ¨¡å¼ï¼Œè·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œä½ åˆ›å»ºçš„queueï¼Œæ— è®ºå…ƒæ•°æ®(å…ƒæ•°æ®æŒ‡RabbitMQçš„é…ç½®æ•°æ®)è¿˜æ˜¯queueé‡Œçš„æ¶ˆæ¯éƒ½ä¼šå­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Šï¼Œç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ°queueçš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠæ¶ˆæ¯åˆ°å¤šä¸ªå®ä¾‹çš„queueé‡Œè¿›è¡Œæ¶ˆæ¯åŒæ­¥ã€‚</p><h1 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h1><h2 id="1-RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1. RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ"></a>1. RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>RocketMQ æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶ã€‚æ”¯æŒäº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€æ‰¹é‡æ¶ˆæ¯ã€å®šæ—¶æ¶ˆæ¯ã€æ¶ˆæ¯å›æº¯ç­‰ã€‚å®ƒé‡Œé¢æœ‰å‡ ä¸ªåŒºåˆ«äºæ ‡å‡†æ¶ˆæ¯ä¸­ä»¶é—´çš„æ¦‚å¿µï¼Œå¦‚Groupã€Topicã€Queueç­‰ã€‚ç³»ç»Ÿç»„æˆåˆ™ç”±Producerã€Consumerã€Brokerã€NameServerç­‰ã€‚</p><p><strong>RocketMQ ç‰¹ç‚¹</strong></p><ul><li>æ˜¯ä¸€ä¸ªé˜Ÿåˆ—æ¨¡å‹çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€é«˜å¯é ã€é«˜å®æ—¶ã€åˆ†å¸ƒå¼ç­‰ç‰¹ç‚¹</li><li>Producerã€Consumerã€é˜Ÿåˆ—éƒ½å¯ä»¥åˆ†å¸ƒå¼</li><li>Producer å‘ä¸€äº›é˜Ÿåˆ—è½®æµå‘é€æ¶ˆæ¯ï¼Œé˜Ÿåˆ—é›†åˆç§°ä¸º Topicï¼ŒConsumer å¦‚æœåšå¹¿æ’­æ¶ˆè´¹ï¼Œåˆ™ä¸€ä¸ª Consumer å®ä¾‹æ¶ˆè´¹è¿™ä¸ª Topic å¯¹åº”çš„æ‰€æœ‰é˜Ÿåˆ—ï¼Œå¦‚æœåšé›†ç¾¤æ¶ˆè´¹ï¼Œåˆ™å¤šä¸ª Consumer å®ä¾‹å¹³å‡æ¶ˆè´¹è¿™ä¸ª Topic å¯¹åº”çš„é˜Ÿåˆ—é›†åˆ</li><li>èƒ½å¤Ÿä¿è¯ä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåº</li><li>æ”¯æŒæ‹‰ï¼ˆpullï¼‰å’Œæ¨ï¼ˆpushï¼‰ä¸¤ç§æ¶ˆæ¯æ¨¡å¼</li><li>é«˜æ•ˆçš„è®¢é˜…è€…æ°´å¹³æ‰©å±•èƒ½åŠ›</li><li>å®æ—¶çš„æ¶ˆæ¯è®¢é˜…æœºåˆ¶</li><li>äº¿çº§æ¶ˆæ¯å †ç§¯èƒ½åŠ›</li><li>æ”¯æŒå¤šç§æ¶ˆæ¯åè®®ï¼Œå¦‚ JMSã€OpenMessaging ç­‰</li><li>è¾ƒå°‘çš„ä¾èµ–</li></ul><h2 id="2-RocketMQç”±å“ªäº›è§’è‰²ç»„æˆï¼Œæ¯ä¸ªè§’è‰²ä½œç”¨å’Œç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-RocketMQç”±å“ªäº›è§’è‰²ç»„æˆï¼Œæ¯ä¸ªè§’è‰²ä½œç”¨å’Œç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2. RocketMQç”±å“ªäº›è§’è‰²ç»„æˆï¼Œæ¯ä¸ªè§’è‰²ä½œç”¨å’Œç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2. RocketMQç”±å“ªäº›è§’è‰²ç»„æˆï¼Œæ¯ä¸ªè§’è‰²ä½œç”¨å’Œç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</h2><table><thead><tr><th>è§’è‰²</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>Nameserver</td><td>æ— çŠ¶æ€ï¼ŒåŠ¨æ€åˆ—è¡¨ï¼›è¿™ä¹Ÿæ˜¯å’Œzookeeperçš„é‡è¦åŒºåˆ«ä¹‹ä¸€ã€‚zookeeperæ˜¯æœ‰çŠ¶æ€çš„ã€‚</td></tr><tr><td>Producer</td><td>æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œè´Ÿè´£å‘æ¶ˆæ¯åˆ°Brokerã€‚</td></tr><tr><td>Broker</td><td>å°±æ˜¯MQæœ¬èº«ï¼Œè´Ÿè´£æ”¶å‘æ¶ˆæ¯ã€æŒä¹…åŒ–æ¶ˆæ¯ç­‰ã€‚</td></tr><tr><td>Consumer</td><td>æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œè´Ÿè´£ä»Brokerä¸Šæ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œæ¶ˆè´¹å®Œè¿›è¡Œackã€‚</td></tr></tbody></table><h2 id="3-RocketMQæ¶ˆè´¹æ¨¡å¼æœ‰å‡ ç§ï¼Ÿ"><a href="#3-RocketMQæ¶ˆè´¹æ¨¡å¼æœ‰å‡ ç§ï¼Ÿ" class="headerlink" title="3. RocketMQæ¶ˆè´¹æ¨¡å¼æœ‰å‡ ç§ï¼Ÿ"></a>3. RocketMQæ¶ˆè´¹æ¨¡å¼æœ‰å‡ ç§ï¼Ÿ</h2><p>æ¶ˆè´¹æ¨¡å‹ç”±Consumerå†³å®šï¼Œæ¶ˆè´¹ç»´åº¦ä¸ºTopicã€‚</p><p>1ã€é›†ç¾¤æ¶ˆè´¹</p><ul><li><p>ä¸€æ¡æ¶ˆæ¯åªä¼šè¢«åŒGroupä¸­çš„ä¸€ä¸ªConsumeræ¶ˆè´¹</p></li><li><p>å¤šä¸ªGroupåŒæ—¶æ¶ˆè´¹ä¸€ä¸ªTopicæ—¶ï¼Œæ¯ä¸ªGroupéƒ½ä¼šæœ‰ä¸€ä¸ªConsumeræ¶ˆè´¹åˆ°æ•°æ®</p></li></ul><p>2ã€å¹¿æ’­æ¶ˆè´¹</p><p>æ¶ˆæ¯å°†å¯¹ä¸€ ä¸ªConsumer Group ä¸‹çš„å„ä¸ª Consumer å®ä¾‹éƒ½æ¶ˆè´¹ä¸€éã€‚å³å³ä½¿è¿™äº› Consumer å±äºåŒä¸€ä¸ªConsumer Group ï¼Œæ¶ˆæ¯ä¹Ÿä¼šè¢« Consumer Group ä¸­çš„æ¯ä¸ª Consumer éƒ½æ¶ˆè´¹ä¸€æ¬¡ã€‚</p><h2 id="4-RocketMQæ¶ˆè´¹æ¶ˆæ¯æ˜¯pushè¿˜æ˜¯pullï¼Ÿ"><a href="#4-RocketMQæ¶ˆè´¹æ¶ˆæ¯æ˜¯pushè¿˜æ˜¯pullï¼Ÿ" class="headerlink" title="4. RocketMQæ¶ˆè´¹æ¶ˆæ¯æ˜¯pushè¿˜æ˜¯pullï¼Ÿ"></a>4. RocketMQæ¶ˆè´¹æ¶ˆæ¯æ˜¯pushè¿˜æ˜¯pullï¼Ÿ</h2><p>RocketMQæ²¡æœ‰çœŸæ­£æ„ä¹‰çš„pushï¼Œéƒ½æ˜¯pullï¼Œè™½ç„¶æœ‰pushç±»ï¼Œä½†å®é™…åº•å±‚å®ç°é‡‡ç”¨çš„æ˜¯<strong>é•¿è½®è¯¢æœºåˆ¶</strong>ï¼Œå³æ‹‰å–æ–¹å¼</p><blockquote><p>brokerç«¯å±æ€§ longPollingEnable æ ‡è®°æ˜¯å¦å¼€å¯é•¿è½®è¯¢ã€‚é»˜è®¤å¼€å¯</p></blockquote><h3 id="è¿½é—®ï¼šä¸ºä»€ä¹ˆè¦ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯è€Œä¸ä½¿ç”¨äº‹ä»¶ç›‘å¬æ–¹å¼ï¼Ÿ"><a href="#è¿½é—®ï¼šä¸ºä»€ä¹ˆè¦ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯è€Œä¸ä½¿ç”¨äº‹ä»¶ç›‘å¬æ–¹å¼ï¼Ÿ" class="headerlink" title="è¿½é—®ï¼šä¸ºä»€ä¹ˆè¦ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯è€Œä¸ä½¿ç”¨äº‹ä»¶ç›‘å¬æ–¹å¼ï¼Ÿ"></a>è¿½é—®ï¼šä¸ºä»€ä¹ˆè¦ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯è€Œä¸ä½¿ç”¨äº‹ä»¶ç›‘å¬æ–¹å¼ï¼Ÿ</h3><p>äº‹ä»¶é©±åŠ¨æ–¹å¼æ˜¯å»ºç«‹å¥½é•¿è¿æ¥ï¼Œç”±äº‹ä»¶ï¼ˆå‘é€æ•°æ®ï¼‰çš„æ–¹å¼æ¥å®æ—¶æ¨é€ã€‚</p><p>å¦‚æœbrokerä¸»åŠ¨æ¨é€æ¶ˆæ¯çš„è¯æœ‰å¯èƒ½pushé€Ÿåº¦å¿«ï¼Œæ¶ˆè´¹é€Ÿåº¦æ…¢çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆæ¶ˆæ¯åœ¨consumerç«¯å †ç§¯è¿‡å¤šï¼ŒåŒæ—¶åˆä¸èƒ½è¢«å…¶ä»–consumeræ¶ˆè´¹çš„æƒ…å†µã€‚è€Œpullçš„æ–¹å¼å¯ä»¥æ ¹æ®å½“å‰è‡ªèº«æƒ…å†µæ¥pullï¼Œä¸ä¼šé€ æˆè¿‡å¤šçš„å‹åŠ›è€Œé€ æˆç“¶é¢ˆã€‚æ‰€ä»¥é‡‡å–äº†pullçš„æ–¹å¼ã€‚</p><h2 id="5-brokerå¦‚ä½•å¤„ç†æ‹‰å–è¯·æ±‚çš„ï¼Ÿ"><a href="#5-brokerå¦‚ä½•å¤„ç†æ‹‰å–è¯·æ±‚çš„ï¼Ÿ" class="headerlink" title="5. brokerå¦‚ä½•å¤„ç†æ‹‰å–è¯·æ±‚çš„ï¼Ÿ"></a>5. brokerå¦‚ä½•å¤„ç†æ‹‰å–è¯·æ±‚çš„ï¼Ÿ</h2><p>Consumeré¦–æ¬¡è¯·æ±‚Broker</p><ul><li><p>Brokerä¸­æ˜¯å¦æœ‰ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯</p></li><li><p>æœ‰</p></li><li><ul><li>å“åº”Consumer</li></ul></li><li><p>ç­‰å¾…ä¸‹æ¬¡Consumerçš„è¯·æ±‚</p></li><li><p>æ²¡æœ‰</p></li><li><ul><li>DefaultMessageStore#ReputMessageService#runæ–¹æ³•</li></ul></li><li><p>PullRequestHoldService æ¥Holdè¿æ¥ï¼Œæ¯ä¸ª5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥pullRequestTableæœ‰æ²¡æœ‰æ¶ˆæ¯ï¼Œæœ‰çš„è¯ç«‹å³æ¨é€</p></li><li><p>æ¯éš”1msæ£€æŸ¥commitLogä¸­æ˜¯å¦æœ‰æ–°æ¶ˆæ¯ï¼Œæœ‰çš„è¯å†™å…¥åˆ°pullRequestTable</p></li><li><p>å½“æœ‰æ–°æ¶ˆæ¯çš„æ—¶å€™è¿”å›è¯·æ±‚</p></li><li><p>æŒ‚èµ·consumerçš„è¯·æ±‚ï¼Œå³ä¸æ–­å¼€è¿æ¥ï¼Œä¹Ÿä¸è¿”å›æ•°æ®</p></li><li><p>ä½¿ç”¨consumerçš„offsetï¼Œ</p></li></ul><h2 id="6-å¦‚ä½•è®©RocketMQä¿è¯æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹ï¼Ÿ"><a href="#6-å¦‚ä½•è®©RocketMQä¿è¯æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹ï¼Ÿ" class="headerlink" title="6. å¦‚ä½•è®©RocketMQä¿è¯æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹ï¼Ÿ"></a>6. å¦‚ä½•è®©RocketMQä¿è¯æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹ï¼Ÿ</h2><p>é¦–å…ˆå¤šä¸ªqueueåªèƒ½ä¿è¯å•ä¸ªqueueé‡Œçš„é¡ºåºï¼Œqueueæ˜¯å…¸å‹çš„FIFOï¼Œå¤©ç„¶é¡ºåºã€‚å¤šä¸ªqueueåŒæ—¶æ¶ˆè´¹æ˜¯æ— æ³•ç»å¯¹ä¿è¯æ¶ˆæ¯çš„æœ‰åºæ€§çš„ã€‚æ‰€ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p><p>åŒä¸€topicï¼ŒåŒä¸€ä¸ªQUEUEï¼Œå‘æ¶ˆæ¯çš„æ—¶å€™ä¸€ä¸ªçº¿ç¨‹å»å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹çš„æ—¶å€™ ä¸€ä¸ªçº¿ç¨‹å»æ¶ˆè´¹ä¸€ä¸ªqueueé‡Œçš„æ¶ˆæ¯ã€‚</p><h2 id="7-RocketMQå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ"><a href="#7-RocketMQå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ" class="headerlink" title="7. RocketMQå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ"></a>7. RocketMQå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ</h2><p>é¦–å…ˆåœ¨å¦‚ä¸‹ä¸‰ä¸ªéƒ¨åˆ†éƒ½å¯èƒ½ä¼šå‡ºç°ä¸¢å¤±æ¶ˆæ¯çš„æƒ…å†µï¼š</p><ul><li>Producerç«¯</li><li>Brokerç«¯</li><li>Consumerç«¯</li></ul><p>1 ã€Producerç«¯å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±</p><ul><li><p>é‡‡å–send()åŒæ­¥å‘æ¶ˆæ¯ï¼Œå‘é€ç»“æœæ˜¯åŒæ­¥æ„ŸçŸ¥çš„ã€‚</p></li><li><p>å‘é€å¤±è´¥åå¯ä»¥é‡è¯•ï¼Œè®¾ç½®é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤3æ¬¡ã€‚</p></li><li><p>é›†ç¾¤éƒ¨ç½²ï¼Œæ¯”å¦‚å‘é€å¤±è´¥äº†çš„åŸå› å¯èƒ½æ˜¯å½“å‰Brokerå®•æœºäº†ï¼Œé‡è¯•çš„æ—¶å€™ä¼šå‘é€åˆ°å…¶ä»–Brokerä¸Šã€‚</p></li></ul><p>2ã€Brokerç«¯å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±</p><ul><li><p>ä¿®æ”¹åˆ·ç›˜ç­–ç•¥ä¸ºåŒæ­¥åˆ·ç›˜ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯å¼‚æ­¥åˆ·ç›˜çš„ã€‚</p></li><li><p>é›†ç¾¤éƒ¨ç½²ï¼Œä¸»ä»æ¨¡å¼ï¼Œé«˜å¯ç”¨ã€‚</p></li></ul><p>3ã€Consumerç«¯å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±</p><ul><li>å®Œå…¨æ¶ˆè´¹æ­£å¸¸ååœ¨è¿›è¡Œæ‰‹åŠ¨ackç¡®è®¤ã€‚</li></ul><h2 id="7-rocketMQçš„æ¶ˆæ¯å †ç§¯å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#7-rocketMQçš„æ¶ˆæ¯å †ç§¯å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="7. rocketMQçš„æ¶ˆæ¯å †ç§¯å¦‚ä½•å¤„ç†ï¼Ÿ"></a>7. rocketMQçš„æ¶ˆæ¯å †ç§¯å¦‚ä½•å¤„ç†ï¼Ÿ</h2><p>é¦–å…ˆè¦æ‰¾åˆ°æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„æ¶ˆæ¯å †ç§¯ï¼Œæ˜¯Producerå¤ªå¤šäº†ï¼ŒConsumerå¤ªå°‘äº†å¯¼è‡´çš„è¿˜æ˜¯è¯´å…¶ä»–æƒ…å†µï¼Œæ€»ä¹‹å…ˆå®šä½é—®é¢˜ã€‚</p><p>ç„¶åçœ‹ä¸‹æ¶ˆæ¯æ¶ˆè´¹é€Ÿåº¦æ˜¯å¦æ­£å¸¸ï¼Œæ­£å¸¸çš„è¯ï¼Œå¯ä»¥é€šè¿‡ä¸Šçº¿æ›´å¤šconsumerä¸´æ—¶è§£å†³æ¶ˆæ¯å †ç§¯é—®é¢˜</p><h3 id="è¿½é—®ï¼šå¦‚æœConsumerå’ŒQueueä¸å¯¹ç­‰ï¼Œä¸Šçº¿äº†å¤šå°ä¹Ÿåœ¨çŸ­æ—¶é—´å†…æ— æ³•æ¶ˆè´¹å®Œå †ç§¯çš„æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿ"><a href="#è¿½é—®ï¼šå¦‚æœConsumerå’ŒQueueä¸å¯¹ç­‰ï¼Œä¸Šçº¿äº†å¤šå°ä¹Ÿåœ¨çŸ­æ—¶é—´å†…æ— æ³•æ¶ˆè´¹å®Œå †ç§¯çš„æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="è¿½é—®ï¼šå¦‚æœConsumerå’ŒQueueä¸å¯¹ç­‰ï¼Œä¸Šçº¿äº†å¤šå°ä¹Ÿåœ¨çŸ­æ—¶é—´å†…æ— æ³•æ¶ˆè´¹å®Œå †ç§¯çš„æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿ"></a>è¿½é—®ï¼šå¦‚æœConsumerå’ŒQueueä¸å¯¹ç­‰ï¼Œä¸Šçº¿äº†å¤šå°ä¹Ÿåœ¨çŸ­æ—¶é—´å†…æ— æ³•æ¶ˆè´¹å®Œå †ç§¯çš„æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿ</h3><ul><li>å‡†å¤‡ä¸€ä¸ªä¸´æ—¶çš„topic</li><li>queueçš„æ•°é‡æ˜¯å †ç§¯çš„å‡ å€</li><li>queueåˆ†å¸ƒåˆ°å¤šBrokerä¸­</li><li>ä¸Šçº¿ä¸€å°Consumeråšæ¶ˆæ¯çš„æ¬è¿å·¥ï¼ŒæŠŠåŸæ¥Topicä¸­çš„æ¶ˆæ¯æŒªåˆ°æ–°çš„Topicé‡Œï¼Œä¸åšä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œåªæ˜¯æŒªè¿‡å»</li><li>ä¸Šçº¿Nå°ConsumeråŒæ—¶æ¶ˆè´¹ä¸´æ—¶Topicä¸­çš„æ•°æ®</li><li>æ”¹bug</li><li>æ¢å¤åŸæ¥çš„Consumerï¼Œç»§ç»­æ¶ˆè´¹ä¹‹å‰çš„Topic</li></ul><h3 id="è¿½é—®ï¼šå †ç§¯æ—¶é—´è¿‡é•¿æ¶ˆæ¯è¶…æ—¶äº†ï¼Ÿ"><a href="#è¿½é—®ï¼šå †ç§¯æ—¶é—´è¿‡é•¿æ¶ˆæ¯è¶…æ—¶äº†ï¼Ÿ" class="headerlink" title="è¿½é—®ï¼šå †ç§¯æ—¶é—´è¿‡é•¿æ¶ˆæ¯è¶…æ—¶äº†ï¼Ÿ"></a>è¿½é—®ï¼šå †ç§¯æ—¶é—´è¿‡é•¿æ¶ˆæ¯è¶…æ—¶äº†ï¼Ÿ</h3><p>RocketMQä¸­çš„æ¶ˆæ¯åªä¼šåœ¨commitLogè¢«åˆ é™¤çš„æ—¶å€™æ‰ä¼šæ¶ˆå¤±ï¼Œä¸ä¼šè¶…æ—¶ã€‚ä¹Ÿå°±æ˜¯è¯´æœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯ä¸ä¼šå­˜åœ¨è¶…æ—¶åˆ é™¤è¿™æƒ…å†µã€‚</p><h3 id="è¿½é—®ï¼šå †ç§¯çš„æ¶ˆæ¯ä¼šä¸ä¼šè¿›æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ"><a href="#è¿½é—®ï¼šå †ç§¯çš„æ¶ˆæ¯ä¼šä¸ä¼šè¿›æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ" class="headerlink" title="è¿½é—®ï¼šå †ç§¯çš„æ¶ˆæ¯ä¼šä¸ä¼šè¿›æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ"></a>è¿½é—®ï¼šå †ç§¯çš„æ¶ˆæ¯ä¼šä¸ä¼šè¿›æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ</h3><p>ä¸ä¼šï¼Œæ¶ˆæ¯åœ¨æ¶ˆè´¹å¤±è´¥åä¼šè¿›å…¥é‡è¯•é˜Ÿåˆ—ï¼ˆ%RETRY%+ConsumerGroupï¼‰ï¼Œ18æ¬¡ï¼ˆé»˜è®¤18æ¬¡ï¼Œç½‘ä¸Šæ‰€æœ‰æ–‡ç« éƒ½è¯´æ˜¯16æ¬¡ï¼Œæ— ä¸€ä¾‹å¤–ã€‚ä½†æ˜¯æˆ‘æ²¡ææ‡‚ä¸ºå•¥æ˜¯16æ¬¡ï¼Œè¿™ä¸æ˜¯18ä¸ªæ—¶é—´å— ï¼Ÿï¼‰æ‰ä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼ˆ%DLQ%+ConsumerGroupï¼‰ã€‚</p><h2 id="8-RocketMQä¸ºä»€ä¹ˆè‡ªç ”nameserverè€Œä¸ç”¨zkï¼Ÿ"><a href="#8-RocketMQä¸ºä»€ä¹ˆè‡ªç ”nameserverè€Œä¸ç”¨zkï¼Ÿ" class="headerlink" title="8. RocketMQä¸ºä»€ä¹ˆè‡ªç ”nameserverè€Œä¸ç”¨zkï¼Ÿ"></a>8. RocketMQä¸ºä»€ä¹ˆè‡ªç ”nameserverè€Œä¸ç”¨zkï¼Ÿ</h2><ol><li>RocketMQåªéœ€è¦ä¸€ä¸ªè½»é‡çº§çš„ç»´æŠ¤å…ƒæ•°æ®ä¿¡æ¯çš„ç»„ä»¶ï¼Œä¸ºæ­¤å¼•å…¥zkå¢åŠ ç»´æŠ¤æˆæœ¬è¿˜å¼ºä¾èµ–å¦ä¸€ä¸ªä¸­é—´ä»¶äº†ã€‚</li><li>RocketMQè¿½æ±‚çš„æ˜¯APï¼Œè€Œä¸æ˜¯CPï¼Œä¹Ÿå°±æ˜¯éœ€è¦é«˜å¯ç”¨ã€‚<ul><li>zkæ˜¯CPï¼Œå› ä¸ºzkèŠ‚ç‚¹é—´é€šè¿‡zapåè®®æœ‰æ•°æ®å…±äº«ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ•°æ®ä¼šä¸€è‡´ï¼Œä½†æ˜¯zké›†ç¾¤å½“æŒ‚äº†ä¸€åŠä»¥ä¸Šçš„èŠ‚ç‚¹å°±æ²¡æ³•ä½¿ç”¨äº†ã€‚</li><li>nameserveræ˜¯APï¼ŒèŠ‚ç‚¹é—´ä¸é€šä¿¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´èŠ‚ç‚¹é—´æ•°æ®ä¿¡æ¯ä¼šå‘ç”ŸçŸ­æš‚çš„ä¸ä¸€è‡´ï¼Œä½†æ¯ä¸ªbrokeréƒ½ä¼šå®šæ—¶å‘æ‰€æœ‰nameserverä¸ŠæŠ¥è·¯ç”±ä¿¡æ¯å’Œå¿ƒè·³ã€‚å½“æŸä¸ªbrokerä¸‹çº¿äº†ï¼Œnameserverä¹Ÿä¼šå»¶æ—¶30sæ‰çŸ¥é“ï¼Œè€Œä¸”ä¸ä¼šé€šçŸ¥å®¢æˆ·ç«¯ï¼ˆç”Ÿäº§å’Œæ¶ˆè´¹è€…ï¼‰ï¼Œåªèƒ½é å®¢æˆ·ç«¯è‡ªå·±æ¥æ‹‰ï¼ŒrocketMQæ˜¯é æ¶ˆæ¯é‡è¯•æœºåˆ¶è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œæ‰€ä»¥æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚ä½†nameserveré›†ç¾¤åªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹å°±å¯ç”¨ã€‚<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904068771479559">https://juejin.cn/post/6844904068771479559</a></li></ul></li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/15/2021-02-15-kafka%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/15/2021-02-15-kafka%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Kafkaé¢è¯•é—®é¢˜æ€»ç»“</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-15 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-15T19:30:00+08:00">2021-02-15</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-Apache-Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-Apache-Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1. Apache Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ"></a>1. Apache Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Apach Kafkaæ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼Œç”¨äºå®æ—¶æ„å»ºæµå¤„ç†åº”ç”¨ã€‚å®ƒæœ‰ä¸€ä¸ªæ ¸å¿ƒçš„åŠŸèƒ½å¹¿ä¸ºäººçŸ¥ï¼Œå³ä½œä¸ºä¼ä¸šçº§çš„æ¶ˆæ¯å¼•æ“è¢«å¹¿æ³›ä½¿ç”¨ï¼ˆé€šå¸¸ä¹Ÿä¼šç§°ä¹‹ä¸ºæ¶ˆæ¯æ€»çº¿message busï¼‰ã€‚</p><h2 id="2-Kafka-çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#2-Kafka-çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="2. Kafka çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>2. Kafka çš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2><p>Kafka å°†æ¶ˆæ¯ä»¥ topic ä¸ºå•ä½è¿›è¡Œå½’çº³</p><p>å°†å‘ Kafka topic å‘å¸ƒæ¶ˆæ¯çš„ç¨‹åºæˆä¸º producers.</p><p>å°†é¢„è®¢ topics å¹¶æ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºæˆä¸º consumer.</p><p>Kafka ä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å«åšä¸€ä¸ª broker.</p><p>producers é€šè¿‡ç½‘ç»œå°†æ¶ˆæ¯å‘é€åˆ° Kafka é›†ç¾¤ï¼Œé›†ç¾¤å‘æ¶ˆè´¹è€…æä¾›æ¶ˆæ¯</p><h2 id="3-Kafka-å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ"><a href="#3-Kafka-å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ" class="headerlink" title="3. Kafka å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ"></a>3. Kafka å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ</h2><p><code>Kafka</code> çš„åŸºæœ¬æ¶æ„ç»„æˆæ˜¯ï¼šç”±å¤šä¸ª <code>broker</code> ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œæ¯ä¸ª <code>broker</code> æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼›å½“åˆ›å»ºä¸€ä¸ª <code>topic</code> æ—¶ï¼Œè¿™ä¸ª <code>topic</code> ä¼šè¢«åˆ’åˆ†ä¸ºå¤šä¸ª <code>partition</code>ï¼Œæ¯ä¸ª <code>partition</code> å¯ä»¥å­˜åœ¨äºä¸åŒçš„ <code>broker</code> ä¸Šï¼Œæ¯ä¸ª <code>partition</code> åªå­˜æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚</p><p>è¿™å°±æ˜¯<strong>å¤©ç„¶çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼Œå°±æ˜¯è¯´ä¸€ä¸ª <code>topic</code> çš„æ•°æ®ï¼Œæ˜¯<strong>åˆ†æ•£æ”¾åœ¨å¤šä¸ªæœºå™¨ä¸Šçš„ï¼Œæ¯ä¸ªæœºå™¨å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®</strong>ã€‚</p><p>åœ¨ <code>Kafka 0.8</code> ç‰ˆæœ¬ä¹‹å‰ï¼Œæ˜¯æ²¡æœ‰ <code>HA</code> æœºåˆ¶çš„ï¼Œå½“ä»»ä½•ä¸€ä¸ª <code>broker</code> æ‰€åœ¨èŠ‚ç‚¹å®•æœºäº†ï¼Œè¿™ä¸ª <code>broker</code> ä¸Šçš„ <code>partition</code> å°±æ— æ³•æä¾›è¯»å†™æœåŠ¡ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬ä¹‹å‰ï¼Œ<code>Kafka</code> æ²¡æœ‰ä»€ä¹ˆé«˜å¯ç”¨æ€§å¯è¨€ã€‚</p><p>åœ¨ <code>Kafka 0.8</code> ä»¥åï¼Œæä¾›äº† <code>HA</code> æœºåˆ¶ï¼Œå°±æ˜¯ <code>replica</code> å‰¯æœ¬æœºåˆ¶ã€‚æ¯ä¸ª <code>partition</code> ä¸Šçš„æ•°æ®éƒ½ä¼šåŒæ­¥åˆ°å…¶å®ƒæœºå™¨ï¼Œå½¢æˆè‡ªå·±çš„å¤šä¸ª <code>replica</code> å‰¯æœ¬ã€‚æ‰€æœ‰ <code>replica</code> ä¼šé€‰ä¸¾ä¸€ä¸ª <code>leader</code> å‡ºæ¥ï¼Œæ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½è·Ÿè¿™ä¸ª <code>leader</code> æ‰“äº¤é“ï¼Œå…¶ä»– <code>replica</code> ä½œä¸º <code>follower</code>ã€‚å†™çš„æ—¶å€™ï¼Œ<code>leader</code> ä¼šè´Ÿè´£æŠŠæ•°æ®åŒæ­¥åˆ°æ‰€æœ‰ <code>follower</code> ä¸Šå»ï¼Œè¯»çš„æ—¶å€™å°±ç›´æ¥è¯» <code>leader</code> ä¸Šçš„æ•°æ®å³å¯ã€‚<code>Kafka</code> è´Ÿè´£å‡åŒ€çš„å°†ä¸€ä¸ª <code>partition</code> çš„æ‰€æœ‰ <code>replica</code> åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™æ ·æ‰å¯ä»¥æé«˜å®¹é”™æ€§ã€‚</p><p><img src="http://blog-img.coolsen.cn/img/Solve-MQ-Problem-With-Kafka-01.png" alt="img"></p><p>æ‹¥æœ‰äº† <code>replica</code> å‰¯æœ¬æœºåˆ¶ï¼Œå¦‚æœæŸä¸ª <code>broker</code> å®•æœºäº†ï¼Œè¿™ä¸ª <code>broker</code> ä¸Šçš„ <code>partition</code> åœ¨å…¶ä»–æœºå™¨ä¸Šè¿˜å­˜åœ¨å‰¯æœ¬ã€‚å¦‚æœè¿™ä¸ªå®•æœºçš„ <code>broker</code> ä¸Šé¢æœ‰æŸä¸ª <code>partition</code> çš„ <code>leader</code>ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šä»å…¶ <code>follower</code> ä¸­é‡æ–°é€‰ä¸¾ä¸€ä¸ªæ–°çš„ <code>leader</code> å‡ºæ¥ï¼Œè¿™ä¸ªæ–°çš„ <code>leader</code> ä¼šç»§ç»­æä¾›è¯»å†™æœåŠ¡ï¼Œè¿™å°±æœ‰è¾¾åˆ°äº†æ‰€è°“çš„é«˜å¯ç”¨æ€§ã€‚</p><p>å†™æ•°æ®çš„æ—¶å€™ï¼Œç”Ÿäº§è€…åªå°†æ•°æ®å†™å…¥ <code>leader</code> èŠ‚ç‚¹ï¼Œ<code>leader</code> ä¼šå°†æ•°æ®å†™å…¥æœ¬åœ°ç£ç›˜ï¼Œæ¥ç€å…¶ä»– <code>follower</code> ä¼šä¸»åŠ¨ä» <code>leader</code> æ¥æ‹‰å–æ•°æ®ï¼Œ<code>follower</code> åŒæ­¥å¥½æ•°æ®äº†ï¼Œå°±ä¼šå‘é€ <code>ack</code> ç»™ <code>leader</code>ï¼Œ<code>leader</code> æ”¶åˆ°æ‰€æœ‰ <code>follower</code> çš„ <code>ack</code> ä¹‹åï¼Œå°±ä¼šè¿”å›å†™æˆåŠŸçš„æ¶ˆæ¯ç»™ç”Ÿäº§è€…ã€‚</p><p>æ¶ˆè´¹æ•°æ®çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…åªä¼šä» <code>leader</code> èŠ‚ç‚¹å»è¯»å–æ¶ˆæ¯ï¼Œä½†æ˜¯åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ <code>follower</code> éƒ½åŒæ­¥æˆåŠŸè¿”å› <code>ack</code> çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚</p><p><img src="https://gitee.com/dongzl/article-images/raw/master/2020/13-Solve-MQ-Problem-With-Kafka/Solve-MQ-Problem-With-Kafka-02.png" alt="img"></p><h2 id="4-Kafka-æ¶ˆæ¯æ˜¯é‡‡ç”¨-Pull-æ¨¡å¼ï¼Œè¿˜æ˜¯-Push-æ¨¡å¼ï¼Ÿ"><a href="#4-Kafka-æ¶ˆæ¯æ˜¯é‡‡ç”¨-Pull-æ¨¡å¼ï¼Œè¿˜æ˜¯-Push-æ¨¡å¼ï¼Ÿ" class="headerlink" title="4. Kafka æ¶ˆæ¯æ˜¯é‡‡ç”¨ Pull æ¨¡å¼ï¼Œè¿˜æ˜¯ Push æ¨¡å¼ï¼Ÿ"></a>4. Kafka æ¶ˆæ¯æ˜¯é‡‡ç”¨ Pull æ¨¡å¼ï¼Œè¿˜æ˜¯ Push æ¨¡å¼ï¼Ÿ</h2><p>ç”Ÿäº§è€…ä½¿ç”¨pushæ¨¡å¼å°†æ¶ˆæ¯å‘å¸ƒåˆ°Brokerï¼Œæ¶ˆè´¹è€…ä½¿ç”¨pullæ¨¡å¼ä»Brokerè®¢é˜…æ¶ˆæ¯ã€‚</p><p>pushæ¨¡å¼å¾ˆéš¾é€‚åº”æ¶ˆè´¹é€Ÿç‡ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå¦‚æœpushçš„é€Ÿåº¦å¤ªå¿«ï¼Œå®¹æ˜“é€ æˆæ¶ˆè´¹è€…æ‹’ç»æœåŠ¡æˆ–ç½‘ç»œæ‹¥å¡ï¼›å¦‚æœpushçš„é€Ÿåº¦å¤ªæ…¢ï¼Œå®¹æ˜“é€ æˆæ¶ˆè´¹è€…æ€§èƒ½æµªè´¹ã€‚ä½†æ˜¯é‡‡ç”¨pullçš„æ–¹å¼ä¹Ÿæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å½“Brokeræ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œæ¶ˆè´¹è€…ä¼šé™·å…¥ä¸æ–­åœ°è½®è¯¢ä¸­ï¼Œä¸ºäº†é¿å…è¿™ç‚¹ï¼Œkafkaæœ‰ä¸ªå‚æ•°å¯ä»¥è®©æ¶ˆè´¹è€…é˜»å¡çŸ¥é“æ˜¯å¦æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ã€‚</p><h2 id="5-Kafka-ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«"><a href="#5-Kafka-ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="5. Kafka ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«"></a>5. Kafka ä¸ä¼ ç»Ÿæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«</h2><ul><li><p>Kafka æŒä¹…åŒ–æ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—å¯ä»¥è¢«é‡å¤è¯»å–å’Œæ— é™æœŸä¿ç•™</p></li><li><p>Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼šå®ƒä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥çµæ´»ä¼¸ç¼©ï¼Œåœ¨å†…éƒ¨é€šè¿‡å¤åˆ¶æ•°æ®æå‡å®¹é”™èƒ½åŠ›å’Œé«˜å¯ç”¨æ€§</p></li><li><p>Kafka æ”¯æŒå®æ—¶çš„æµå¼å¤„ç†</p></li></ul><h2 id="6-ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ"><a href="#6-ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ" class="headerlink" title="6. ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ"></a>6. ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ</h2><p>æ¶ˆè´¹è€…ç»„æ˜¯Kafkaç‹¬æœ‰çš„æ¦‚å¿µï¼Œå³æ¶ˆè´¹è€…ç»„æ˜¯Kafkaæä¾›çš„å¯æ‰©å±•ä¸”å…·æœ‰å®¹é”™æ€§çš„æ¶ˆè´¹è€…æœºåˆ¶ã€‚</p><p>ä½†å®é™…ä¸Šï¼Œæ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰å…¶å®åŒ…å«ä¸¤ä¸ªæ¦‚å¿µï¼Œä½œä¸ºé˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ç»„å…è®¸ä½ åˆ†å‰²æ•°æ®å¤„ç†åˆ°ä¸€ç»„è¿›ç¨‹é›†åˆä¸Šï¼ˆå³ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæ¶ˆè´¹è€…è¿›ç¨‹ï¼Œä»–ä»¬å…±åŒæ¶ˆè´¹è¯¥topicçš„æ•°æ®ï¼‰ï¼Œè¿™æœ‰åŠ©äºä½ çš„æ¶ˆè´¹èƒ½åŠ›çš„åŠ¨æ€è°ƒæ•´ï¼›ä½œä¸ºå‘å¸ƒ-è®¢é˜…æ¨¡å‹ï¼ˆpublish-subscribeï¼‰ï¼ŒKafkaå…è®¸ä½ å°†åŒä¸€ä»½æ¶ˆæ¯å¹¿æ’­åˆ°å¤šä¸ªæ¶ˆè´¹è€…ç»„é‡Œï¼Œä»¥æ­¤æ¥ä¸°å¯Œå¤šç§æ•°æ®ä½¿ç”¨åœºæ™¯ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨æ¶ˆè´¹è€…ç»„ä¸­ï¼Œå¤šä¸ªå®ä¾‹å…±åŒè®¢é˜…è‹¥å¹²ä¸ªä¸»é¢˜ï¼Œå®ç°å…±åŒæ¶ˆè´¹ã€‚åŒä¸€ä¸ªç»„ä¸‹çš„æ¯ä¸ªå®ä¾‹éƒ½é…ç½®æœ‰ç›¸åŒçš„ç»„IDï¼Œè¢«åˆ†é…ä¸åŒçš„è®¢é˜…åˆ†åŒºã€‚å½“æŸä¸ªå®ä¾‹æŒ‚æ‰çš„æ—¶å€™ï¼Œå…¶ä»–å®ä¾‹ä¼šè‡ªåŠ¨åœ°æ‰¿æ‹…èµ·å®ƒè´Ÿè´£æ¶ˆè´¹çš„åˆ†åŒºã€‚ å› æ­¤ï¼Œæ¶ˆè´¹è€…ç»„åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿä¿è¯äº†æ¶ˆè´¹è€…ç¨‹åºçš„é«˜å¯ç”¨æ€§ã€‚</p><p><a target="_blank" rel="noopener" href="http://dockone.io/uploads/article/20201024/7b359b7a1381541fbacf3ecf20dfb347.jpg"><img src="http://dockone.io/uploads/article/20201024/7b359b7a1381541fbacf3ecf20dfb347.jpg" alt="1.jpg"></a></p><h2 id="7-åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#7-åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="7. åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>7. åœ¨Kafkaä¸­ï¼ŒZooKeeperçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ç›®å‰ï¼ŒKafkaä½¿ç”¨ZooKeeperå­˜æ”¾é›†ç¾¤å…ƒæ•°æ®ã€æˆå‘˜ç®¡ç†ã€Controlleré€‰ä¸¾ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ç®¡ç†ç±»ä»»åŠ¡ã€‚ä¹‹åï¼Œç­‰KIP-500ææ¡ˆå®Œæˆåï¼ŒKafkaå°†å®Œå…¨ä¸å†ä¾èµ–äºZooKeeperã€‚</p><ul><li>â€œå­˜æ”¾å…ƒæ•°æ®â€æ˜¯æŒ‡ä¸»é¢˜åˆ†åŒºçš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ ZooKeeper ä¸­ï¼Œä¸”ä»¥å®ƒä¿å­˜çš„æ•°æ®ä¸ºæƒå¨ï¼Œå…¶ä»– â€œäººâ€ éƒ½è¦ä¸å®ƒä¿æŒå¯¹é½ã€‚</li><li>â€œæˆå‘˜ç®¡ç†â€ æ˜¯æŒ‡ Broker èŠ‚ç‚¹çš„æ³¨å†Œã€æ³¨é”€ä»¥åŠå±æ€§å˜æ›´ï¼Œç­‰ç­‰ã€‚</li><li>â€œController é€‰ä¸¾â€ æ˜¯æŒ‡é€‰ä¸¾é›†ç¾¤ Controllerï¼Œè€Œå…¶ä»–ç®¡ç†ç±»ä»»åŠ¡åŒ…æ‹¬ä½†ä¸é™äºä¸»é¢˜åˆ é™¤ã€å‚æ•°é…ç½®ç­‰ã€‚</li></ul><p>KIP-500 æ€æƒ³ï¼Œæ˜¯ä½¿ç”¨ç¤¾åŒºè‡ªç ”çš„åŸºäºRaftçš„å…±è¯†ç®—æ³•ï¼Œæ›¿ä»£ZooKeeperï¼Œå®ç°Controllerè‡ªé€‰ä¸¾ã€‚</p><h2 id="8-è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨"><a href="#8-è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨" class="headerlink" title="8. è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨"></a>8. è§£é‡Šä¸‹Kafkaä¸­ä½ç§»ï¼ˆoffsetï¼‰çš„ä½œç”¨</h2><p>åœ¨Kafkaä¸­ï¼Œæ¯ä¸ªä¸»é¢˜åˆ†åŒºä¸‹çš„æ¯æ¡æ¶ˆæ¯éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªå”¯ä¸€çš„IDæ•°å€¼ï¼Œç”¨äºæ ‡è¯†å®ƒåœ¨åˆ†åŒºä¸­çš„ä½ç½®ã€‚è¿™ä¸ªIDæ•°å€¼ï¼Œå°±è¢«ç§°ä¸ºä½ç§»ï¼Œæˆ–è€…å«åç§»é‡ã€‚ä¸€æ—¦æ¶ˆæ¯è¢«å†™å…¥åˆ°åˆ†åŒºæ—¥å¿—ï¼Œå®ƒçš„ä½ç§»å€¼å°†ä¸èƒ½è¢«ä¿®æ”¹ã€‚</p><h2 id="9-kafka-ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ"><a href="#9-kafka-ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ" class="headerlink" title="9. kafka ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ"></a>9. kafka ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ</h2><ul><li>Cache Filesystem Cache PageCacheç¼“å­˜</li><li><code>é¡ºåºå†™</code>ï¼šç”±äºç°ä»£çš„æ“ä½œç³»ç»Ÿæä¾›äº†é¢„è¯»å’Œå†™æŠ€æœ¯ï¼Œç£ç›˜çš„é¡ºåºå†™å¤§å¤šæ•°æƒ…å†µä¸‹æ¯”éšæœºå†™å†…å­˜è¿˜è¦å¿«ã€‚</li><li><code>Zero-copy</code>ï¼šé›¶æ‹·æŠ€æœ¯å‡å°‘æ‹·è´æ¬¡æ•°</li><li><code>Batching of Messages</code>ï¼šæ‰¹é‡ï¥¾å¤„ç†ã€‚åˆå¹¶å°çš„è¯·æ±‚ï¼Œç„¶åä»¥æµçš„æ–¹å¼è¿›è¡Œäº¤äº’ï¼Œç›´é¡¶ç½‘ç»œä¸Šé™ã€‚</li><li><code>Pull æ‹‰æ¨¡å¼</code>ï¼šä½¿ç”¨æ‹‰æ¨¡å¼è¿›è¡Œæ¶ˆæ¯çš„è·å–æ¶ˆè´¹ï¼Œä¸æ¶ˆè´¹ç«¯å¤„ç†èƒ½åŠ›ç›¸ç¬¦ã€‚</li></ul><h2 id="10-kafka-producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"><a href="#10-kafka-producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ" class="headerlink" title="10. kafka producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"></a>10. kafka producerå‘é€æ•°æ®ï¼Œackä¸º0ï¼Œ1ï¼Œ-1åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</h2><ul><li><code>1</code>ï¼ˆé»˜è®¤ï¼‰ æ•°æ®å‘é€åˆ°Kafkaåï¼Œç»è¿‡leaderæˆåŠŸæ¥æ”¶æ¶ˆæ¯çš„çš„ç¡®è®¤ï¼Œå°±ç®—æ˜¯å‘é€æˆåŠŸäº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœleaderå®•æœºäº†ï¼Œåˆ™ä¼šä¸¢å¤±æ•°æ®ã€‚</li><li><code>0</code> ç”Ÿäº§è€…å°†æ•°æ®å‘é€å‡ºå»å°±ä¸ç®¡äº†ï¼Œä¸å»ç­‰å¾…ä»»ä½•è¿”å›ã€‚è¿™ç§æƒ…å†µä¸‹æ•°æ®ä¼ è¾“æ•ˆç‡æœ€é«˜ï¼Œä½†æ˜¯æ•°æ®å¯é æ€§ç¡®æ˜¯æœ€ä½çš„ã€‚</li><li><code>-1</code>produceréœ€è¦ç­‰å¾…ISRä¸­çš„æ‰€æœ‰followeréƒ½ç¡®è®¤æ¥æ”¶åˆ°æ•°æ®åæ‰ç®—ä¸€æ¬¡å‘é€å®Œæˆï¼Œå¯é æ€§æœ€é«˜ã€‚å½“ISRä¸­æ‰€æœ‰Replicaéƒ½å‘Leaderå‘é€ACKæ—¶ï¼Œleaderæ‰commitï¼Œè¿™æ—¶å€™produceræ‰èƒ½è®¤ä¸ºä¸€ä¸ªè¯·æ±‚ä¸­çš„æ¶ˆæ¯éƒ½commitäº†ã€‚</li></ul><h2 id="11-Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±"><a href="#11-Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±" class="headerlink" title="11. Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±?"></a>11. Kafkaå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±?</h2><p>é¦–å…ˆéœ€è¦å¼„æ˜ç™½æ¶ˆæ¯ä¸ºä»€ä¹ˆä¼šä¸¢å¤±ï¼Œå¯¹äºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¼šæœ‰ <code>ç”Ÿäº§è€…</code>ã€<code>MQ</code>ã€<code>æ¶ˆè´¹è€…</code> è¿™ä¸‰ä¸ªè§’è‰²ï¼Œåœ¨è¿™ä¸‰ä¸ªè§’è‰²æ•°æ®å¤„ç†å’Œä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œéƒ½æœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±ã€‚</p><p><img src="http://blog-img.coolsen.cn/img/Solve-MQ-Problem-With-Kafka-03.png" alt="img"></p><p>æ¶ˆæ¯ä¸¢å¤±çš„åŸå› ä»¥åŠè§£å†³åŠæ³•ï¼š</p><h3 id="æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"><a href="#æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"></a>æ¶ˆè´¹è€…å¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±</h3><p>æ¶ˆè´¹è€…å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±çš„æƒ…å†µæ˜¯ï¼šæ¶ˆè´¹è€…è·å–åˆ°äº†è¿™æ¡æ¶ˆæ¯åï¼Œè¿˜æœªå¤„ç†ï¼Œ<code>Kafka</code> å°±è‡ªåŠ¨æäº¤äº† <code>offset</code>ï¼Œè¿™æ—¶ <code>Kafka</code> å°±è®¤ä¸ºæ¶ˆè´¹è€…å·²ç»å¤„ç†å®Œè¿™æ¡æ¶ˆæ¯ï¼Œå…¶å®æ¶ˆè´¹è€…æ‰åˆšå‡†å¤‡å¤„ç†è¿™æ¡æ¶ˆæ¯ï¼Œè¿™æ—¶å¦‚æœæ¶ˆè´¹è€…å®•æœºï¼Œé‚£è¿™æ¡æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚</p><p>æ¶ˆè´¹è€…å¼•èµ·æ¶ˆæ¯ä¸¢å¤±çš„ä¸»è¦åŸå› å°±æ˜¯æ¶ˆæ¯è¿˜æœªå¤„ç†å®Œ <code>Kafka</code> ä¼šè‡ªåŠ¨æäº¤äº† <code>offset</code>ï¼Œé‚£ä¹ˆåªè¦å…³é—­è‡ªåŠ¨æäº¤ <code>offset</code>ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†å®Œä¹‹åæ‰‹åŠ¨æäº¤ <code>offset</code>ï¼Œå°±å¯ä»¥ä¿è¯æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚ä½†æ˜¯æ­¤æ—¶éœ€è¦æ³¨æ„é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œæ¯”å¦‚æ¶ˆè´¹è€…åˆšå¤„ç†å®Œï¼Œè¿˜æ²¡æäº¤ <code>offset</code>ï¼Œè¿™æ—¶è‡ªå·±å®•æœºäº†ï¼Œæ­¤æ—¶è¿™æ¡æ¶ˆæ¯è‚¯å®šä¼šè¢«é‡å¤æ¶ˆè´¹ä¸€æ¬¡ï¼Œè¿™å°±éœ€è¦æ¶ˆè´¹è€…æ ¹æ®å®é™…æƒ…å†µä¿è¯å¹‚ç­‰æ€§ã€‚</p><h3 id="ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"><a href="#ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"></a>ç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±</h3><p>å¯¹äºç”Ÿäº§è€…æ•°æ®ä¼ è¾“å¯¼è‡´çš„æ•°æ®ä¸¢å¤±ä¸»å¸¸è§æƒ…å†µæ˜¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™ <code>Kafka</code>ï¼Œç”±äºç½‘ç»œç­‰åŸå› å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå¯¹äºè¿™ç§æƒ…å†µä¹Ÿæ˜¯é€šè¿‡åœ¨ <strong>producer</strong> ç«¯è®¾ç½® <strong>acks&#x3D;all</strong> æ¥å¤„ç†ï¼Œè¿™ä¸ªå‚æ•°æ˜¯è¦æ±‚ <code>leader</code> æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œéœ€è¦ç­‰åˆ°æ‰€æœ‰çš„ <code>follower</code> éƒ½åŒæ­¥åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œæ‰è®¤ä¸ºæœ¬æ¬¡å†™æˆåŠŸäº†ã€‚å¦‚æœæ²¡æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ã€‚</p><h3 id="Kafka-å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"><a href="#Kafka-å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±" class="headerlink" title="Kafka å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±"></a>Kafka å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±</h3><p><code>Kafka</code> å¯¼è‡´çš„æ•°æ®ä¸¢å¤±ä¸€ä¸ªå¸¸è§çš„åœºæ™¯å°±æ˜¯ <code>Kafka</code> æŸä¸ª <code>broker</code> å®•æœºï¼Œï¼Œè€Œè¿™ä¸ªèŠ‚ç‚¹æ­£å¥½æ˜¯æŸä¸ª <code>partition</code> çš„ <code>leader</code> èŠ‚ç‚¹ï¼Œè¿™æ—¶éœ€è¦é‡æ–°é‡æ–°é€‰ä¸¾è¯¥ <code>partition</code> çš„ <code>leader</code>ã€‚å¦‚æœè¯¥ <code>partition</code> çš„ <code>leader</code> åœ¨å®•æœºæ—¶åˆšå¥½è¿˜æœ‰äº›æ•°æ®æ²¡æœ‰åŒæ­¥åˆ° <code>follower</code>ï¼Œæ­¤æ—¶ <code>leader</code> æŒ‚äº†ï¼Œåœ¨é€‰ä¸¾æŸä¸ª <code>follower</code> æˆ <code>leader</code> ä¹‹åï¼Œå°±ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ã€‚</p><p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œ<code>Kafka</code> å¯ä»¥è®¾ç½®å¦‚ä¸‹ 4 ä¸ªå‚æ•°ï¼Œæ¥å°½é‡é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼š</p><ul><li>ç»™ <code>topic</code> è®¾ç½® <code>replication.factor</code> å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº <code>1</code>ï¼Œè¦æ±‚æ¯ä¸ª <code>partition</code> å¿…é¡»æœ‰è‡³å°‘ <code>2</code> ä¸ªå‰¯æœ¬ï¼›</li><li>åœ¨ <code>Kafka</code> æœåŠ¡ç«¯è®¾ç½® <code>min.insync.replicas</code> å‚æ•°ï¼šè¿™ä¸ªå€¼å¿…é¡»å¤§äº <code>1</code>ï¼Œè¿™ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ä¸€ä¸ª <code>leader</code> è‡³å°‘æ„ŸçŸ¥åˆ°æœ‰è‡³å°‘ä¸€ä¸ª <code>follower</code> è¿˜è·Ÿè‡ªå·±ä¿æŒè”ç³»ï¼Œæ²¡æ‰é˜Ÿï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ <code>leader</code> æŒ‚äº†è¿˜æœ‰ä¸€ä¸ª <code>follower</code> èŠ‚ç‚¹ã€‚</li><li>åœ¨ <code>producer</code> ç«¯è®¾ç½® <code>acks=all</code>ï¼Œè¿™ä¸ªæ˜¯è¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯å†™å…¥æ‰€æœ‰ <code>replica</code> ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºæ˜¯å†™æˆåŠŸäº†ï¼›</li><li>åœ¨ <code>producer</code> ç«¯è®¾ç½® <code>retries=MAX</code>ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ï¼šè¿™ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚</li></ul><h2 id="13-Kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§"><a href="#13-Kafka-å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§" class="headerlink" title="13. Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§"></a>13. Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§</h2><p>åœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯å¯¹äºæœ‰é€»è¾‘å…³è”çš„å¤šæ¡MQæ¶ˆæ¯è¢«æŒ‰é¡ºåºå¤„ç†ï¼Œæ¯”å¦‚å¯¹äºæŸä¸€æ¡æ•°æ®ï¼Œæ­£å¸¸å¤„ç†é¡ºåºæ˜¯<code>æ–°å¢-æ›´æ–°-åˆ é™¤</code>ï¼Œæœ€ç»ˆç»“æœæ˜¯æ•°æ®è¢«åˆ é™¤ï¼›å¦‚æœæ¶ˆæ¯æ²¡æœ‰æŒ‰åºæ¶ˆè´¹ï¼Œå¤„ç†é¡ºåºå¯èƒ½æ˜¯<code>åˆ é™¤-æ–°å¢-æ›´æ–°</code>ï¼Œæœ€ç»ˆæ•°æ®æ²¡æœ‰è¢«åˆ æ‰ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä¸€äº›é€»è¾‘é”™è¯¯ã€‚å¯¹äºå¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Œä¸»è¦éœ€è¦è€ƒè™‘å¦‚ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨ <code>Kafka</code> ä¸­é¡ºåºæ€§ï¼›</li><li>å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§ã€‚</li></ul><h3 id="å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨-Kafka-ä¸­é¡ºåºæ€§"><a href="#å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨-Kafka-ä¸­é¡ºåºæ€§" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨ Kafka ä¸­é¡ºåºæ€§"></a>å¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨ Kafka ä¸­é¡ºåºæ€§</h3><p>å¯¹äº <code>Kafka</code>ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª <code>topic</code>ï¼Œé»˜è®¤æœ‰ä¸‰ä¸ª <code>partition</code>ã€‚ç”Ÿäº§è€…åœ¨å†™æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ª <code>key</code>ï¼Œæ¯”å¦‚åœ¨è®¢å• <code>topic</code> ä¸­æˆ‘ä»¬å¯ä»¥æŒ‡å®šè®¢å• <code>id</code> ä½œä¸º <code>key</code>ï¼Œé‚£ä¹ˆç›¸åŒè®¢å• <code>id</code> çš„æ•°æ®ï¼Œä¸€å®šä¼šè¢«åˆ†å‘åˆ°åŒä¸€ä¸ª <code>partition</code> ä¸­å»ï¼Œè€Œä¸”è¿™ä¸ª <code>partition</code> ä¸­çš„æ•°æ®ä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚æ¶ˆè´¹è€…ä» <code>partition</code> ä¸­å–å‡ºæ¥æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚é€šè¿‡åˆ¶å®š <code>key</code> çš„æ–¹å¼é¦–å…ˆå¯ä»¥ä¿è¯åœ¨ <code>kafka</code> å†…éƒ¨æ¶ˆæ¯æ˜¯æœ‰åºçš„ã€‚</p><h3 id="å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§"><a href="#å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§" class="headerlink" title="å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§"></a>å¦‚ä½•ä¿è¯æ¶ˆè´¹è€…å¤„ç†æ¶ˆè´¹çš„é¡ºåºæ€§</h3><p>å¯¹äºæŸä¸ª <code>topic</code> çš„ä¸€ä¸ª <code>partition</code>ï¼Œåªèƒ½è¢«åŒç»„å†…éƒ¨çš„ä¸€ä¸ª <code>consumer</code> æ¶ˆè´¹ï¼Œå¦‚æœè¿™ä¸ª <code>consumer</code> å†…éƒ¨è¿˜æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œé‚£ä¹ˆå…¶å®åªè¦ä¿è¯æ¶ˆæ¯åœ¨ <code>MQ</code> å†…éƒ¨æ˜¯æœ‰é¡ºåºçš„å°±å¯ä»¥ä¿è¯æ¶ˆè´¹ä¹Ÿæ˜¯æœ‰é¡ºåºçš„ã€‚ä½†æ˜¯å•çº¿ç¨‹ååé‡å¤ªä½ï¼Œåœ¨å¤„ç†å¤§é‡ <code>MQ</code> æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå¼€å¯å¤šçº¿ç¨‹æ¶ˆè´¹æœºåˆ¶ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯æ¶ˆæ¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´æ˜¯è¢«é¡ºåºå¤„ç†çš„å‘¢ï¼Ÿå¯¹äºå¤šçº¿ç¨‹æ¶ˆè´¹æˆ‘ä»¬å¯ä»¥é¢„å…ˆè®¾ç½® <code>N</code> ä¸ªå†…å­˜ <code>Queue</code>ï¼Œå…·æœ‰ç›¸åŒ <code>key</code> çš„æ•°æ®éƒ½æ”¾åˆ°åŒä¸€ä¸ªå†…å­˜ <code>Queue</code> ä¸­ï¼›ç„¶åå¼€å¯ <code>N</code> ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜ <code>Queue</code> çš„æ•°æ®å³å¯ï¼Œè¿™æ ·å°±èƒ½ä¿è¯é¡ºåºæ€§ã€‚å½“ç„¶ï¼Œæ¶ˆæ¯æ”¾åˆ°å†…å­˜ <code>Queue</code> ä¸­ï¼Œæœ‰å¯èƒ½è¿˜æœªè¢«å¤„ç†ï¼Œ<code>consumer</code> å‘ç”Ÿå®•æœºï¼Œå†…å­˜ <code>Queue</code> ä¸­çš„æ•°æ®ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œè¿™å°±è½¬å˜ä¸ºä¸Šé¢æåˆ°çš„<strong>å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é ä¼ è¾“</strong>çš„é—®é¢˜äº†ã€‚</p><h2 id="14-Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ"><a href="#14-Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ" class="headerlink" title="14. Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ"></a>14. Kafkaä¸­çš„ISRã€ARä»£è¡¨ä»€ä¹ˆï¼ŸISRçš„ä¼¸ç¼©æŒ‡ä»€ä¹ˆï¼Ÿ</h2><ul><li><code>ISR</code>ï¼šIn-Sync Replicas å‰¯æœ¬åŒæ­¥é˜Ÿåˆ—</li><li><code>AR</code>:Assigned Replicas æ‰€æœ‰å‰¯æœ¬</li></ul><p>ISRæ˜¯ç”±leaderç»´æŠ¤ï¼Œfollowerä»leaderåŒæ­¥æ•°æ®æœ‰ä¸€äº›å»¶è¿Ÿï¼ˆåŒ…æ‹¬<code>å»¶è¿Ÿæ—¶é—´replica.lag.time.max.ms</code>å’Œ<code>å»¶è¿Ÿæ¡æ•°replica.lag.max.messages</code>ä¸¤ä¸ªç»´åº¦ï¼Œå½“å‰æœ€æ–°çš„ç‰ˆæœ¬0.10.xä¸­åªæ”¯æŒ<code>replica.lag.time.max.ms</code>è¿™ä¸ªç»´åº¦ï¼‰ï¼Œä»»æ„ä¸€ä¸ªè¶…è¿‡é˜ˆå€¼éƒ½ä¼šæŠŠfollowerå‰”é™¤å‡ºISRï¼Œå­˜å…¥OSRï¼ˆOutof-Sync Replicasï¼‰åˆ—è¡¨ï¼Œæ–°åŠ å…¥çš„followerä¹Ÿä¼šå…ˆå­˜æ”¾åœ¨OSRä¸­ã€‚</p><blockquote><p>AR&#x3D;ISR+OSRã€‚</p></blockquote><h2 id="15-æè¿°ä¸‹-Kafka-ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader-Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower-Replicaï¼‰çš„åŒºåˆ«"><a href="#15-æè¿°ä¸‹-Kafka-ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader-Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower-Replicaï¼‰çš„åŒºåˆ«" class="headerlink" title="15. æè¿°ä¸‹ Kafka ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower Replicaï¼‰çš„åŒºåˆ«"></a>15. æè¿°ä¸‹ Kafka ä¸­çš„é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader Replicaï¼‰å’Œè¿½éšè€…å‰¯æœ¬ï¼ˆFollower Replicaï¼‰çš„åŒºåˆ«</h2><p>Kafkaå‰¯æœ¬å½“å‰åˆ†ä¸ºé¢†å¯¼è€…å‰¯æœ¬å’Œè¿½éšè€…å‰¯æœ¬ã€‚åªæœ‰Leaderå‰¯æœ¬æ‰èƒ½å¯¹å¤–æä¾›è¯»å†™æœåŠ¡ï¼Œå“åº”Clientsç«¯çš„è¯·æ±‚ã€‚Followerå‰¯æœ¬åªæ˜¯é‡‡ç”¨æ‹‰ï¼ˆPULLï¼‰çš„æ–¹å¼ï¼Œè¢«åŠ¨åœ°åŒæ­¥Leaderå‰¯æœ¬ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨Leaderå‰¯æœ¬æ‰€åœ¨çš„Brokerå®•æœºåï¼Œéšæ—¶å‡†å¤‡åº”è˜Leaderå‰¯æœ¬ã€‚</p><p>åŠ åˆ†ç‚¹ï¼š</p><ul><li>å¼ºè°ƒFollowerå‰¯æœ¬ä¹Ÿèƒ½å¯¹å¤–æä¾›è¯»æœåŠ¡ã€‚è‡ªKafka 2.4ç‰ˆæœ¬å¼€å§‹ï¼Œç¤¾åŒºé€šè¿‡å¼•å…¥æ–°çš„Brokerç«¯å‚æ•°ï¼Œå…è®¸Followerå‰¯æœ¬æœ‰é™åº¦åœ°æä¾›è¯»æœåŠ¡ã€‚</li><li>å¼ºè°ƒLeaderå’ŒFollowerçš„æ¶ˆæ¯åºåˆ—åœ¨å®é™…åœºæ™¯ä¸­ä¸ä¸€è‡´ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¾ˆå¤šå› ç´ å¯èƒ½é€ æˆLeaderå’ŒFollowerä¹‹é—´çš„ä¸åŒæ­¥ï¼Œæ¯”å¦‚ç¨‹åºé—®é¢˜ï¼Œç½‘ç»œé—®é¢˜ï¼Œbrokeré—®é¢˜ç­‰ï¼ŒçŸ­æš‚çš„ä¸åŒæ­¥æˆ‘ä»¬å¯ä»¥å…³æ³¨ï¼ˆç§’çº§åˆ«ï¼‰ï¼Œä½†é•¿æ—¶é—´çš„ä¸åŒæ­¥å¯èƒ½å°±éœ€è¦æ·±å…¥æ’æŸ¥äº†ï¼Œå› ä¸ºä¸€æ—¦Leaderæ‰€åœ¨èŠ‚ç‚¹å¼‚å¸¸ï¼Œå¯èƒ½ç›´æ¥å½±å“å¯ç”¨æ€§ã€‚</li></ul><p>æ³¨æ„ï¼šä¹‹å‰ç¡®ä¿ä¸€è‡´æ€§çš„ä¸»è¦æ‰‹æ®µæ˜¯é«˜æ°´ä½æœºåˆ¶ï¼ˆHWï¼‰ï¼Œä½†é«˜æ°´ä½å€¼æ— æ³•ä¿è¯Leaderè¿ç»­å˜æ›´åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå› æ­¤ï¼Œç¤¾åŒºå¼•å…¥äº†Leader Epochæœºåˆ¶ï¼Œæ¥ä¿®å¤é«˜æ°´ä½å€¼çš„å¼Šç«¯ã€‚</p><h2 id="16-åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"><a href="#16-åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ" class="headerlink" title="16. åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"></a>16. åˆ†åŒºLeaderé€‰ä¸¾ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ</h2><p>åˆ†åŒºçš„Leaderå‰¯æœ¬é€‰ä¸¾å¯¹ç”¨æˆ·æ˜¯å®Œå…¨é€æ˜çš„ï¼Œå®ƒæ˜¯ç”±Controllerç‹¬ç«‹å®Œæˆçš„ã€‚ä½ éœ€è¦å›ç­”çš„æ˜¯ï¼Œåœ¨å“ªäº›åœºæ™¯ä¸‹ï¼Œéœ€è¦æ‰§è¡Œåˆ†åŒºLeaderé€‰ä¸¾ã€‚æ¯ä¸€ç§åœºæ™¯å¯¹åº”äºä¸€ç§é€‰ä¸¾ç­–ç•¥ã€‚</p><ul><li>OfflinePartition Leaderé€‰ä¸¾ï¼šæ¯å½“æœ‰åˆ†åŒºä¸Šçº¿æ—¶ï¼Œå°±éœ€è¦æ‰§è¡ŒLeaderé€‰ä¸¾ã€‚æ‰€è°“çš„åˆ†åŒºä¸Šçº¿ï¼Œå¯èƒ½æ˜¯åˆ›å»ºäº†æ–°åˆ†åŒºï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰çš„ä¸‹çº¿åˆ†åŒºé‡æ–°ä¸Šçº¿ã€‚è¿™æ˜¯æœ€å¸¸è§çš„åˆ†åŒºLeaderé€‰ä¸¾åœºæ™¯ã€‚</li><li>ReassignPartition Leaderé€‰ä¸¾ï¼šå½“ä½ æ‰‹åŠ¨è¿è¡Œkafka-reassign-partitionså‘½ä»¤ï¼Œæˆ–è€…æ˜¯è°ƒç”¨Adminçš„alterPartitionReassignmentsæ–¹æ³•æ‰§è¡Œåˆ†åŒºå‰¯æœ¬é‡åˆ†é…æ—¶ï¼Œå¯èƒ½è§¦å‘æ­¤ç±»é€‰ä¸¾ã€‚å‡è®¾åŸæ¥çš„ARæ˜¯[1ï¼Œ2ï¼Œ3]ï¼ŒLeaderæ˜¯1ï¼Œå½“æ‰§è¡Œå‰¯æœ¬é‡åˆ†é…åï¼Œå‰¯æœ¬é›†åˆARè¢«è®¾ç½®æˆ[4ï¼Œ5ï¼Œ6]ï¼Œæ˜¾ç„¶ï¼ŒLeaderå¿…é¡»è¦å˜æ›´ï¼Œæ­¤æ—¶ä¼šå‘ç”ŸReassign Partition Leaderé€‰ä¸¾ã€‚</li><li>PreferredReplicaPartition Leaderé€‰ä¸¾ï¼šå½“ä½ æ‰‹åŠ¨è¿è¡Œkafka-preferred-replica-electionå‘½ä»¤ï¼Œæˆ–è‡ªåŠ¨è§¦å‘äº†Preferred Leaderé€‰ä¸¾æ—¶ï¼Œè¯¥ç±»ç­–ç•¥è¢«æ¿€æ´»ã€‚æ‰€è°“çš„Preferred Leaderï¼ŒæŒ‡çš„æ˜¯ARä¸­çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬ã€‚æ¯”å¦‚ARæ˜¯[3ï¼Œ2ï¼Œ1]ï¼Œé‚£ä¹ˆï¼ŒPreferred Leaderå°±æ˜¯3ã€‚</li><li>ControlledShutdownPartition Leaderé€‰ä¸¾ï¼šå½“Brokeræ­£å¸¸å…³é—­æ—¶ï¼Œè¯¥Brokerä¸Šçš„æ‰€æœ‰Leaderå‰¯æœ¬éƒ½ä¼šä¸‹çº¿ï¼Œå› æ­¤ï¼Œéœ€è¦ä¸ºå—å½±å“çš„åˆ†åŒºæ‰§è¡Œç›¸åº”çš„Leaderé€‰ä¸¾ã€‚</li></ul><p>è¿™4ç±»é€‰ä¸¾ç­–ç•¥çš„å¤§è‡´æ€æƒ³æ˜¯ç±»ä¼¼çš„ï¼Œå³ä»ARä¸­æŒ‘é€‰é¦–ä¸ªåœ¨ISRä¸­çš„å‰¯æœ¬ï¼Œä½œä¸ºæ–°Leaderã€‚</p><h2 id="17-Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero-Copyï¼‰ï¼Ÿ"><a href="#17-Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero-Copyï¼‰ï¼Ÿ" class="headerlink" title="17. Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero Copyï¼‰ï¼Ÿ"></a>17. Kafkaçš„å“ªäº›åœºæ™¯ä¸­ä½¿ç”¨äº†é›¶æ‹·è´ï¼ˆZero Copyï¼‰ï¼Ÿ</h2><p>åœ¨Kafkaä¸­ï¼Œä½“ç°Zero Copyä½¿ç”¨åœºæ™¯çš„åœ°æ–¹æœ‰ä¸¤å¤„ï¼šåŸºäºmmapçš„ç´¢å¼•å’Œæ—¥å¿—æ–‡ä»¶è¯»å†™æ‰€ç”¨çš„TransportLayerã€‚</p><p>å…ˆè¯´ç¬¬ä¸€ä¸ªã€‚ç´¢å¼•éƒ½æ˜¯åŸºäºMappedByteBufferçš„ï¼Œä¹Ÿå°±æ˜¯è®©ç”¨æˆ·æ€å’Œå†…æ ¸æ€å…±äº«å†…æ ¸æ€çš„æ•°æ®ç¼“å†²åŒºï¼Œæ­¤æ—¶ï¼Œæ•°æ®ä¸éœ€è¦å¤åˆ¶åˆ°ç”¨æˆ·æ€ç©ºé—´ã€‚ä¸è¿‡ï¼Œmmapè™½ç„¶é¿å…äº†ä¸å¿…è¦çš„æ‹·è´ï¼Œä½†ä¸ä¸€å®šå°±èƒ½ä¿è¯å¾ˆé«˜çš„æ€§èƒ½ã€‚åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸‹ï¼Œmmapçš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚å¾ˆé«˜çš„åˆ›å»ºå’Œé”€æ¯å¼€é”€ä¼šæŠµæ¶ˆZero Copyå¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿ã€‚ç”±äºè¿™ç§ä¸ç¡®å®šæ€§ï¼Œåœ¨Kafkaä¸­ï¼Œåªæœ‰ç´¢å¼•åº”ç”¨äº†mmapï¼Œæœ€æ ¸å¿ƒçš„æ—¥å¿—å¹¶æœªä½¿ç”¨mmapæœºåˆ¶ã€‚</p><p>å†è¯´ç¬¬äºŒä¸ªã€‚TransportLayeræ˜¯Kafkaä¼ è¾“å±‚çš„æ¥å£ã€‚å®ƒçš„æŸä¸ªå®ç°ç±»ä½¿ç”¨äº†FileChannelçš„transferToæ–¹æ³•ã€‚è¯¥æ–¹æ³•åº•å±‚ä½¿ç”¨sendfileå®ç°äº†Zero Copyã€‚å¯¹Kafkaè€Œè¨€ï¼Œå¦‚æœI&#x2F;Oé€šé“ä½¿ç”¨æ™®é€šçš„PLAINTEXTï¼Œé‚£ä¹ˆï¼ŒKafkaå°±å¯ä»¥åˆ©ç”¨Zero Copyç‰¹æ€§ï¼Œç›´æ¥å°†é¡µç¼“å­˜ä¸­çš„æ•°æ®å‘é€åˆ°ç½‘å¡çš„Bufferä¸­ï¼Œé¿å…ä¸­é—´çš„å¤šæ¬¡æ‹·è´ã€‚ç›¸åï¼Œå¦‚æœI&#x2F;Oé€šé“å¯ç”¨äº†SSLï¼Œé‚£ä¹ˆï¼ŒKafkaä¾¿æ— æ³•åˆ©ç”¨Zero Copyç‰¹æ€§äº†ã€‚</p><h2 id="18-ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ"><a href="#18-ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ" class="headerlink" title="18. ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ"></a>18. ä¸ºä»€ä¹ˆKafkaä¸æ”¯æŒè¯»å†™åˆ†ç¦»ï¼Ÿ</h2><p>åœ¨ Kafka ä¸­ï¼Œç”Ÿäº§è€…å†™å…¥æ¶ˆæ¯ã€æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯çš„æ“ä½œéƒ½æ˜¯ä¸ leader å‰¯æœ¬è¿›è¡Œäº¤äº’çš„ï¼Œä» è€Œå®ç°çš„æ˜¯ä¸€ç§ä¸»å†™ä¸»è¯»çš„ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ã€‚</p><p>Kafka å¹¶ä¸æ”¯æŒä¸»å†™ä»è¯»ï¼Œå› ä¸ºä¸»å†™ä»è¯»æœ‰ 2 ä¸ªå¾ˆæ˜ æ˜¾çš„ç¼ºç‚¹:</p><ul><li><strong>æ•°æ®ä¸€è‡´æ€§é—®é¢˜</strong>ã€‚æ•°æ®ä»ä¸»èŠ‚ç‚¹è½¬åˆ°ä»èŠ‚ç‚¹å¿…ç„¶ä¼šæœ‰ä¸€ä¸ªå»¶æ—¶çš„æ—¶é—´çª—å£ï¼Œè¿™ä¸ªæ—¶é—´ çª—å£ä¼šå¯¼è‡´ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¸ä¸€è‡´ã€‚æŸä¸€æ—¶åˆ»ï¼Œåœ¨ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ä¸­ A æ•°æ®çš„å€¼éƒ½ä¸º Xï¼Œ ä¹‹åå°†ä¸»èŠ‚ç‚¹ä¸­ A çš„å€¼ä¿®æ”¹ä¸º Yï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªå˜æ›´é€šçŸ¥åˆ°ä»èŠ‚ç‚¹ä¹‹å‰ï¼Œåº”ç”¨è¯»å–ä»èŠ‚ç‚¹ä¸­çš„ A æ•°æ®çš„å€¼å¹¶ä¸ä¸ºæœ€æ–°çš„ Yï¼Œç”±æ­¤ä¾¿äº§ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li><li><strong>å»¶æ—¶é—®é¢˜</strong>ã€‚ç±»ä¼¼ Redis è¿™ç§ç»„ä»¶ï¼Œæ•°æ®ä»å†™å…¥ä¸»èŠ‚ç‚¹åˆ°åŒæ­¥è‡³ä»èŠ‚ç‚¹ä¸­çš„è¿‡ç¨‹éœ€è¦ç»å†<code>ç½‘ç»œâ†’ä¸»èŠ‚ç‚¹å†…å­˜â†’ç½‘ç»œâ†’ä»èŠ‚ç‚¹å†…å­˜</code>è¿™å‡ ä¸ªé˜¶æ®µï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šè€—è´¹ä¸€å®šçš„æ—¶é—´ã€‚è€Œåœ¨ Kafka ä¸­ï¼Œä¸»ä»åŒæ­¥ä¼šæ¯” Redis æ›´åŠ è€—æ—¶ï¼Œå®ƒéœ€è¦ç»å†<code>ç½‘ç»œâ†’ä¸»èŠ‚ç‚¹å†…å­˜â†’ä¸»èŠ‚ç‚¹ç£ç›˜â†’ç½‘ç»œâ†’ä»èŠ‚ç‚¹å†…å­˜â†’ä»èŠ‚ç‚¹ç£ç›˜</code>è¿™å‡ ä¸ªé˜¶æ®µã€‚å¯¹å»¶æ—¶æ•æ„Ÿçš„åº”ç”¨è€Œè¨€ï¼Œä¸»å†™ä»è¯»çš„åŠŸèƒ½å¹¶ä¸å¤ªé€‚ç”¨ã€‚</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a target="_blank" rel="noopener" href="http://dockone.io/article/10853">http://dockone.io/article/10853</a></p><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000023716306">https://segmentfault.com/a/1190000023716306</a></p><p><a target="_blank" rel="noopener" href="https://dongzl.github.io/2020/03/16/13-Solve-MQ-Problem-With-Kafka/index.html">https://dongzl.github.io/2020/03/16/13-Solve-MQ-Problem-With-Kafka/index.html</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/02/13/2021-02-13-RocketMQ%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/02/13/2021-02-13-RocketMQ%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">RocketMQåŸºç¡€çŸ¥è¯†æ€»ç»“</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-13 19:30:00" itemprop="dateCreated datePublished" datetime="2021-02-13T19:30:00+08:00">2021-02-13</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²"><a href="#æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²"></a>æ¶ˆæ¯é˜Ÿåˆ—æ‰«ç›²</h2><p>æ¶ˆæ¯é˜Ÿåˆ—é¡¾åæ€ä¹‰å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æˆ‘å°±ä¸è§£é‡Šäº†ï¼Œåˆ«å‘Šè¯‰æˆ‘ä½ è¿é˜Ÿåˆ—éƒ½ä¸çŸ¥é“æ˜¯å•¥å§ï¼Ÿ</p><p>æ‰€ä»¥é—®é¢˜å¹¶ä¸æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä»€ä¹ˆï¼Œè€Œæ˜¯ <strong>æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿç”¨å®ƒæ¥å¹²è¿™äº›äº‹ä¼šå¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ</strong></p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ" class="headerlink" title="# æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ"></a><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%87%BA%E7%8E%B0">#</a> æ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ</h3><p>æ¶ˆæ¯é˜Ÿåˆ—ç®—æ˜¯ä½œä¸ºåç«¯ç¨‹åºå‘˜çš„ä¸€ä¸ªå¿…å¤‡æŠ€èƒ½å§ï¼Œå› ä¸º<strong>åˆ†å¸ƒå¼åº”ç”¨å¿…å®šæ¶‰åŠåˆ°å„ä¸ªç³»ç»Ÿä¹‹é—´çš„é€šä¿¡é—®é¢˜</strong>ï¼Œè¿™ä¸ªæ—¶å€™æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿåº”è¿è€Œç”Ÿäº†ã€‚å¯ä»¥è¯´åˆ†å¸ƒå¼çš„äº§ç”Ÿæ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºç¡€ï¼Œè€Œåˆ†å¸ƒå¼æ€•æ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„æ¦‚å¿µäº†å§ï¼Œæ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„ä¸­é—´ä»¶äº†ã€‚</p><h3 id="æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ" class="headerlink" title="# æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ"></a><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%83%BD%E7%94%A8%E6%9D%A5%E5%B9%B2%E4%BB%80%E4%B9%88">#</a> æ¶ˆæ¯é˜Ÿåˆ—èƒ½ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ</h3><h4 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="# å¼‚æ­¥"></a><a href="#%E5%BC%82%E6%AD%A5">#</a> å¼‚æ­¥</h4><p>ä½ å¯èƒ½ä¼šåé©³æˆ‘ï¼Œåº”ç”¨ä¹‹é—´çš„é€šä¿¡åˆä¸æ˜¯åªèƒ½ç”±æ¶ˆæ¯é˜Ÿåˆ—è§£å†³ï¼Œå¥½å¥½çš„é€šä¿¡ä¸ºä»€ä¹ˆä¸­é—´éè¦æ’ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘¢ï¼Ÿæˆ‘ä¸èƒ½ç›´æ¥è¿›è¡Œé€šä¿¡å—ï¼Ÿ</p><p>å¾ˆå¥½ğŸ‘ï¼Œä½ åˆæå‡ºäº†ä¸€ä¸ªæ¦‚å¿µï¼Œ<strong>åŒæ­¥é€šä¿¡</strong>ã€‚å°±æ¯”å¦‚ç°åœ¨ä¸šç•Œä½¿ç”¨æ¯”è¾ƒå¤šçš„ <code>Dubbo</code> å°±æ˜¯ä¸€ä¸ªé€‚ç”¨äºå„ä¸ªç³»ç»Ÿä¹‹é—´åŒæ­¥é€šä¿¡çš„ <code>RPC</code> æ¡†æ¶ã€‚</p><p>æˆ‘æ¥ä¸¾ä¸ªğŸŒ°å§ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªè´­ç¥¨ç³»ç»Ÿï¼Œéœ€æ±‚æ˜¯ç”¨æˆ·åœ¨è´­ä¹°å®Œä¹‹åèƒ½æ¥æ”¶åˆ°è´­ä¹°å®Œæˆçš„çŸ­ä¿¡ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef37fee7e09230.jpg" alt="img"></p><p>æˆ‘ä»¬çœç•¥ä¸­é—´çš„ç½‘ç»œé€šä¿¡æ—¶é—´æ¶ˆè€—ï¼Œå‡å¦‚è´­ç¥¨ç³»ç»Ÿå¤„ç†éœ€è¦ 150ms ï¼ŒçŸ­ä¿¡ç³»ç»Ÿå¤„ç†éœ€è¦ 200ms ï¼Œé‚£ä¹ˆæ•´ä¸ªå¤„ç†æµç¨‹çš„æ—¶é—´æ¶ˆè€—å°±æ˜¯ 150ms + 200ms &#x3D; 350msã€‚</p><p>å½“ç„¶ï¼Œä¹çœ‹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚å¯æ˜¯ä»”ç»†ä¸€æƒ³ä½ å°±æ„Ÿè§‰æœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘ç”¨æˆ·è´­ç¥¨åœ¨è´­ç¥¨ç³»ç»Ÿçš„æ—¶å€™å…¶å®å°±å·²ç»å®Œæˆäº†è´­ä¹°ï¼Œè€Œæˆ‘ç°åœ¨é€šè¿‡åŒæ­¥è°ƒç”¨éè¦è®©æ•´ä¸ªè¯·æ±‚æ‹‰é•¿æ—¶é—´ï¼Œè€ŒçŸ­ä¿¡ç³»ç»Ÿè¿™ç©æ„åˆä¸æ˜¯å¾ˆæœ‰å¿…è¦ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªè¾…åŠ©åŠŸèƒ½å¢å¼ºç”¨æˆ·ä½“éªŒæ„Ÿè€Œå·²ã€‚æˆ‘ç°åœ¨æ•´ä¸ªè°ƒç”¨æµç¨‹å°±æœ‰ç‚¹ <strong>å¤´é‡è„šè½»</strong> çš„æ„Ÿè§‰äº†ï¼Œè´­ç¥¨æ˜¯ä¸€ä¸ªä¸å¤ªè€—æ—¶çš„æµç¨‹ï¼Œè€Œæˆ‘ç°åœ¨å› ä¸ºåŒæ­¥è°ƒç”¨ï¼Œéè¦ç­‰å¾…å‘é€çŸ­ä¿¡è¿™ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œæ‰è¿”å›ç»“æœã€‚é‚£æˆ‘å¦‚æœå†åŠ ä¸€ä¸ªå‘é€é‚®ä»¶å‘¢ï¼Ÿ</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef380429cf373e.jpg" alt="img"></p><p>è¿™æ ·æ•´ä¸ªç³»ç»Ÿçš„è°ƒç”¨é“¾åˆå˜é•¿äº†ï¼Œæ•´ä¸ªæ—¶é—´å°±å˜æˆäº†550msã€‚</p><p>å½“æˆ‘ä»¬åœ¨å­¦ç”Ÿæ—¶ä»£éœ€è¦åœ¨é£Ÿå ‚æ’é˜Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬å’Œé£Ÿå ‚å¤§å¦ˆå°±æ˜¯ä¸€ä¸ªåŒæ­¥çš„æ¨¡å‹ã€‚</p><p>æˆ‘ä»¬éœ€è¦å‘Šè¯‰é£Ÿå ‚å¤§å¦ˆï¼šâ€œå§å§ï¼Œç»™æˆ‘åŠ ä¸ªé¸¡è…¿ï¼Œå†åŠ ä¸ªé…¸è¾£åœŸè±†ä¸ï¼Œå¸®æˆ‘æµ‡ç‚¹æ±ä¸Šå»ï¼Œå¤šæ‰“ç‚¹é¥­å“¦ğŸ˜‹ğŸ˜‹ğŸ˜‹â€ å’¦~~~ ä¸ºäº†å¤šåƒç‚¹ï¼ŒçœŸæ¶å¿ƒã€‚</p><p>ç„¶åå¤§å¦ˆå¸®æˆ‘ä»¬æ‰“é¥­é…èœï¼Œæˆ‘ä»¬çœ‹ç€å¤§å¦ˆé‚£é¢¤æŠ–çš„æ‰‹å’Œæ‰è½çš„åœŸè±†ä¸ä¸ç¦å’½äº†å’½å£æ°´ã€‚</p><p>æœ€ç»ˆæˆ‘ä»¬ä»å¤§å¦ˆæ‰‹ä¸­æ¥è¿‡é¥­èœç„¶åå»å¯»æ‰¾åº§ä½äº†â€¦</p><p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨ç»™å¤§å¦ˆå‘é€éœ€è¦çš„ä¿¡æ¯ä¹‹åæˆ‘ä»¬æ˜¯ <strong>åŒæ­¥ç­‰å¾…å¤§å¦ˆç»™æˆ‘é…å¥½é¥­èœ</strong> çš„ï¼Œä¸Šé¢æˆ‘ä»¬åªæ˜¯åŠ äº†é¸¡è…¿å’ŒåœŸè±†ä¸ï¼Œä¸‡ä¸€æˆ‘å†åŠ ä¸€ä¸ªç•ªèŒ„ç‰›è…©ï¼ŒéŸ­èœé¸¡è›‹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å¤§å¦ˆæ‰“é¥­é…èœçš„æµç¨‹å°±ä¼šå˜é•¿ï¼Œæˆ‘ä»¬ç­‰å¾…çš„æ—¶é—´ä¹Ÿä¼šç›¸åº”çš„å˜é•¿ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/006APoFYly1fvd9cwjlfrj30as0b03ym.jpg" alt="img"></p><p>é‚£åæ¥ï¼Œæˆ‘ä»¬å·¥ä½œèµšé’±äº†æœ‰é’±å»é¥­åº—åƒé¥­äº†ï¼Œæˆ‘ä»¬å‘Šè¯‰æœåŠ¡å‘˜æ¥ä¸€ç¢—ç‰›è‚‰é¢åŠ ä¸ªè·åŒ…è›‹ <strong>(ä¼ è¾¾ä¸€ä¸ªæ¶ˆæ¯)</strong> ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨é¥­æ¡Œä¸Šå®‰å¿ƒçš„ç©æ‰‹æœºäº† <strong>(å¹²è‡ªå·±å…¶ä»–äº‹æƒ…)</strong> ï¼Œç­‰åˆ°æˆ‘ä»¬çš„ç‰›è‚‰é¢ä¸Šäº†æˆ‘ä»¬å°±å¯ä»¥åƒäº†ã€‚è¿™å…¶ä¸­æˆ‘ä»¬ä¹Ÿå°±ä¼ è¾¾äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åæˆ‘ä»¬åˆè½¬è¿‡å¤´å¹²å…¶ä»–äº‹æƒ…äº†ã€‚è¿™å…¶ä¸­è™½ç„¶åšé¢çš„æ—¶é—´æ²¡æœ‰å˜çŸ­ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ä¼ è¾¾ä¸€ä¸ªæ¶ˆæ¯å°±å¯ä»¥å¹²å…¶ä»–äº‹æƒ…äº†ï¼Œè¿™æ˜¯ä¸€ä¸ª <strong>å¼‚æ­¥</strong> çš„æ¦‚å¿µã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†è§£å†³è¿™ä¸€ä¸ªé—®é¢˜ï¼Œèªæ˜çš„ç¨‹åºå‘˜åœ¨ä¸­é—´ä¹ŸåŠ äº†ä¸ªç±»ä¼¼äºæœåŠ¡å‘˜çš„ä¸­é—´ä»¶â€”â€”æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æŠŠæ¨¡å‹ç»™æ”¹é€ äº†ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef38124f55eaea.jpg" alt="img"></p><p>è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨å°†æ¶ˆæ¯å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¿”å›äº†(æˆ‘ä»¬å‘Šè¯‰æœåŠ¡å‘˜æˆ‘ä»¬è¦åƒä»€ä¹ˆç„¶åç©æ‰‹æœº)ï¼Œæ‰€ä»¥æ•´ä¸ªè€—æ—¶åªæ˜¯ 150ms + 10ms &#x3D; 160msã€‚</p><blockquote><p>ä½†æ˜¯ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•´ä¸ªæµç¨‹çš„æ—¶é•¿æ˜¯æ²¡å˜çš„ï¼Œå°±åƒä½ ä»…ä»…å‘Šè¯‰æœåŠ¡å‘˜è¦åƒä»€ä¹ˆæ˜¯ä¸ä¼šå½±å“åˆ°åšé¢çš„é€Ÿåº¦çš„ã€‚</p></blockquote><h4 id="è§£è€¦"><a href="#è§£è€¦" class="headerlink" title="# è§£è€¦"></a><a href="#%E8%A7%A3%E8%80%A6">#</a> è§£è€¦</h4><p>å›åˆ°æœ€åˆåŒæ­¥è°ƒç”¨çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å†™ä¸ªä¼ªä»£ç ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef381a505d3e1f.jpg" alt="img"></p><p>é‚£ä¹ˆç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åˆæ·»åŠ äº†ä¸€ä¸ªå‘é€é‚®ä»¶ï¼Œæˆ‘ä»¬å°±å¾—é‡æ–°å»ä¿®æ”¹ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬åˆåŠ ä¸€ä¸ªéœ€æ±‚ï¼šç”¨æˆ·è´­ä¹°å®Œè¿˜éœ€è¦ç»™ä»–åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ˜¯ä¸æ˜¯åˆå¾—æ”¹ä»£ç ï¼Ÿ</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef381c4e1b1ac7.jpg" alt="img"></p><p>å¦‚æœä½ è§‰å¾—è¿˜è¡Œï¼Œé‚£ä¹ˆæˆ‘è¿™ä¸ªæ—¶å€™ä¸è¦å‘é‚®ä»¶è¿™ä¸ªæœåŠ¡äº†å‘¢ï¼Œæˆ‘æ˜¯ä¸æ˜¯åˆå¾—æ”¹ä»£ç ï¼Œåˆå¾—é‡å¯åº”ç”¨ï¼Ÿ</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef381f273a66bd.jpg" alt="img"></p><p>è¿™æ ·æ”¹æ¥æ”¹å»æ˜¯ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆ <strong>æ­¤æ—¶æˆ‘ä»¬å°±ç”¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åœ¨ä¸­é—´è¿›è¡Œè§£è€¦</strong> ã€‚ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åé¢çš„å‘é€çŸ­ä¿¡ã€å‘é€é‚®ä»¶ã€æ·»åŠ ç§¯åˆ†ç­‰ä¸€äº›æ“ä½œéƒ½ä¾èµ–äºä¸Šé¢çš„ <code>result</code> ï¼Œè¿™ä¸œè¥¿æŠ½è±¡å‡ºæ¥å°±æ˜¯è´­ç¥¨çš„å¤„ç†ç»“æœå‘€ï¼Œæ¯”å¦‚è®¢å•å·ï¼Œç”¨æˆ·è´¦å·ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åé¢çš„ä¸€ç³»åˆ—æœåŠ¡éƒ½æ˜¯éœ€è¦åŒæ ·çš„æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†ã€‚æ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡ <strong>â€œå¹¿æ’­æ¶ˆæ¯â€</strong> æ¥å®ç°ã€‚</p><p>æˆ‘ä¸Šé¢æ‰€è®²çš„â€œå¹¿æ’­â€å¹¶ä¸æ˜¯çœŸæ­£çš„å¹¿æ’­ï¼Œè€Œæ˜¯æ¥ä¸‹æ¥çš„ç³»ç»Ÿä½œä¸ºæ¶ˆè´¹è€…å» <strong>è®¢é˜…</strong> ç‰¹å®šçš„ä¸»é¢˜ã€‚æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„ä¸»é¢˜å°±å¯ä»¥å«åš <code>è®¢ç¥¨</code> ï¼Œæˆ‘ä»¬è´­ä¹°ç³»ç»Ÿä½œä¸ºä¸€ä¸ªç”Ÿäº§è€…å»ç”Ÿäº§è¿™æ¡æ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åæ¶ˆè´¹è€…è®¢é˜…äº†è¿™ä¸ªä¸»é¢˜ï¼Œä¼šä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚å°±æ¯”å¦‚æˆ‘ä»¬åˆšåˆšç”»çš„é‚£å¼ å›¾ï¼Œä½ ä¼šå‘ç°ï¼Œåœ¨ç”Ÿäº§è€…è¿™è¾¹æˆ‘ä»¬åªéœ€è¦å…³æ³¨ <strong>ç”Ÿäº§æ¶ˆæ¯åˆ°æŒ‡å®šä¸»é¢˜ä¸­</strong> ï¼Œè€Œ <strong>æ¶ˆè´¹è€…åªéœ€è¦å…³æ³¨ä»æŒ‡å®šä¸»é¢˜ä¸­æ‹‰å–æ¶ˆæ¯</strong> å°±è¡Œäº†ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef382674b66892.jpg" alt="img"></p><blockquote><p>å¦‚æœæ²¡æœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯å½“ä¸€ä¸ªæ–°çš„ä¸šåŠ¡æ¥å…¥ï¼Œæˆ‘ä»¬éƒ½è¦åœ¨ä¸»ç³»ç»Ÿè°ƒç”¨æ–°æ¥å£ã€æˆ–è€…å½“æˆ‘ä»¬å–æ¶ˆæŸäº›ä¸šåŠ¡ï¼Œæˆ‘ä»¬ä¹Ÿå¾—åœ¨ä¸»ç³»ç»Ÿåˆ é™¤æŸäº›æ¥å£è°ƒç”¨ã€‚æœ‰äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæ¶ˆæ¯æ˜¯å¦é€è¾¾äº†é˜Ÿåˆ—ï¼Œè‡³äºè°å¸Œæœ›è®¢é˜…ï¼Œæ¥ä¸‹æ¥æ”¶åˆ°æ¶ˆæ¯å¦‚ä½•å¤„ç†ï¼Œæ˜¯ä¸‹æ¸¸çš„äº‹æƒ…ï¼Œæ— ç–‘æå¤§åœ°å‡å°‘äº†å¼€å‘å’Œè”è°ƒçš„å·¥ä½œé‡ã€‚</p></blockquote><h4 id="å‰Šå³°"><a href="#å‰Šå³°" class="headerlink" title="# å‰Šå³°"></a><a href="#%E5%89%8A%E5%B3%B0">#</a> å‰Šå³°</h4><p>æˆ‘ä»¬å†æ¬¡å›åˆ°ä¸€å¼€å§‹æˆ‘ä»¬ä½¿ç”¨åŒæ­¥è°ƒç”¨ç³»ç»Ÿçš„æƒ…å†µï¼Œå¹¶ä¸”æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœæ­¤æ—¶æœ‰å¤§é‡ç”¨æˆ·è¯·æ±‚è´­ç¥¨æ•´ä¸ªç³»ç»Ÿä¼šå˜æˆä»€ä¹ˆæ ·ï¼Ÿ</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef382a9756bb1c.jpg" alt="img"></p><p>å¦‚æœï¼Œæ­¤æ—¶æœ‰ä¸€ä¸‡çš„è¯·æ±‚è¿›å…¥è´­ç¥¨ç³»ç»Ÿï¼Œæˆ‘ä»¬çŸ¥é“è¿è¡Œæˆ‘ä»¬ä¸»ä¸šåŠ¡çš„æœåŠ¡å™¨é…ç½®ä¸€èˆ¬ä¼šæ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å‡è®¾è´­ç¥¨ç³»ç»Ÿèƒ½æ‰¿å—è¿™ä¸€ä¸‡çš„ç”¨æˆ·è¯·æ±‚ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬åŒæ—¶ä¹Ÿä¼šå‡ºç°ä¸€ä¸‡è°ƒç”¨å‘çŸ­ä¿¡æœåŠ¡çš„è¯·æ±‚ã€‚è€Œå¯¹äºçŸ­ä¿¡ç³»ç»Ÿæ¥è¯´å¹¶ä¸æ˜¯æˆ‘ä»¬çš„ä¸»è¦ä¸šåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬é…å¤‡çš„ç¡¬ä»¶èµ„æºå¹¶ä¸ä¼šå¤ªé«˜ï¼Œé‚£ä¹ˆä½ è§‰å¾—ç°åœ¨è¿™ä¸ªçŸ­ä¿¡ç³»ç»Ÿèƒ½æ‰¿å—è¿™ä¸€ä¸‡çš„å³°å€¼ä¹ˆï¼Œä¸”ä¸è¯´èƒ½ä¸èƒ½æ‰¿å—ï¼Œç³»ç»Ÿä¼šä¸ä¼š <strong>ç›´æ¥å´©æºƒ</strong> äº†ï¼Ÿ</p><p>çŸ­ä¿¡ä¸šåŠ¡åˆä¸æ˜¯æˆ‘ä»¬çš„ä¸»ä¸šåŠ¡ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½ <strong>æŠ˜ä¸­å¤„ç†</strong> å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬æŠŠè´­ä¹°å®Œæˆçš„ä¿¡æ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œè€ŒçŸ­ä¿¡ç³»ç»Ÿ <strong>å°½è‡ªå·±æ‰€èƒ½åœ°å»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯</strong> ï¼Œå³ä½¿å¤„ç†é€Ÿåº¦æ…¢ä¸€ç‚¹ä¹Ÿæ— æ‰€è°“ï¼Œåªè¦æˆ‘ä»¬çš„ç³»ç»Ÿæ²¡æœ‰å´©æºƒå°±è¡Œäº†ã€‚</p><p>ç•™å¾—æ±Ÿå±±åœ¨ï¼Œè¿˜æ€•æ²¡æŸ´çƒ§ï¼Ÿä½ æ•¢è¯´æ¯æ¬¡å‘é€éªŒè¯ç çš„æ—¶å€™æ˜¯ä¸€å‘ä½ å°±æ”¶åˆ°äº†çš„ä¹ˆï¼Ÿ</p><h4 id="æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ" class="headerlink" title="# æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ"></a><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%83%BD%E5%B8%A6%E6%9D%A5%E4%BB%80%E4%B9%88%E5%A5%BD%E5%A4%84">#</a> æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ</h4><p>å…¶å®ä¸Šé¢æˆ‘å·²ç»è¯´äº†ã€‚<strong>å¼‚æ­¥ã€è§£è€¦ã€å‰Šå³°ã€‚</strong> å“ªæ€•ä½ ä¸Šé¢çš„éƒ½æ²¡çœ‹æ‡‚ä¹Ÿåƒä¸‡è¦è®°ä½è¿™å…­ä¸ªå­—ï¼Œå› ä¸ºä»–ä¸ä»…æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ç²¾åï¼Œæ›´æ˜¯ç¼–ç¨‹å’Œæ¶æ„çš„ç²¾åã€‚</p><h4 id="æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ"><a href="#æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ" class="headerlink" title="# æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ"></a><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BC%9A%E5%B8%A6%E6%9D%A5%E5%89%AF%E4%BD%9C%E7%94%A8%E5%90%97">#</a> æ¶ˆæ¯é˜Ÿåˆ—ä¼šå¸¦æ¥å‰¯ä½œç”¨å—ï¼Ÿ</h4><p>æ²¡æœ‰å“ªä¸€é—¨æŠ€æœ¯æ˜¯â€œé“¶å¼¹â€ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæœ‰å®ƒçš„å‰¯ä½œç”¨ã€‚</p><p>æ¯”å¦‚ï¼Œæœ¬æ¥å¥½å¥½çš„ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´çš„è°ƒç”¨ï¼Œæˆ‘ä¸­é—´åŠ äº†ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—æŒ‚äº†æ€ä¹ˆåŠå‘¢ï¼Ÿæ˜¯ä¸æ˜¯ <strong>é™ä½äº†ç³»ç»Ÿçš„å¯ç”¨æ€§</strong> ï¼Ÿ</p><p>é‚£è¿™æ ·æ˜¯ä¸æ˜¯è¦ä¿è¯HA(é«˜å¯ç”¨)ï¼Ÿæ˜¯ä¸æ˜¯è¦æé›†ç¾¤ï¼Ÿé‚£ä¹ˆæˆ‘ <strong>æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚åº¦æ˜¯ä¸æ˜¯ä¸Šå‡äº†</strong> ï¼Ÿ</p><p>æŠ›å¼€ä¸Šé¢çš„é—®é¢˜ä¸è®²ï¼Œä¸‡ä¸€æˆ‘å‘é€æ–¹å‘é€å¤±è´¥äº†ï¼Œç„¶åæ‰§è¡Œé‡è¯•ï¼Œè¿™æ ·å°±å¯èƒ½äº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ã€‚</p><p>æˆ–è€…æˆ‘æ¶ˆè´¹ç«¯å¤„ç†å¤±è´¥äº†ï¼Œè¯·æ±‚é‡å‘ï¼Œè¿™æ ·ä¹Ÿä¼šäº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ã€‚</p><p>å¯¹äºä¸€äº›å¾®æœåŠ¡æ¥è¯´ï¼Œæ¶ˆè´¹é‡å¤æ¶ˆæ¯ä¼šå¸¦æ¥æ›´å¤§çš„éº»çƒ¦ï¼Œæ¯”å¦‚å¢åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘åŠ äº†å¤šæ¬¡æ˜¯ä¸æ˜¯å¯¹å…¶ä»–ç”¨æˆ·ä¸å…¬å¹³ï¼Ÿ</p><p>é‚£ä¹ˆï¼Œåˆ <strong>å¦‚ä½•è§£å†³é‡å¤æ¶ˆè´¹æ¶ˆæ¯çš„é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>å¦‚æœæˆ‘ä»¬æ­¤æ—¶çš„æ¶ˆæ¯éœ€è¦ä¿è¯ä¸¥æ ¼çš„é¡ºåºæ€§æ€ä¹ˆåŠå‘¢ï¼Ÿæ¯”å¦‚ç”Ÿäº§è€…ç”Ÿäº§äº†ä¸€ç³»åˆ—çš„æœ‰åºæ¶ˆæ¯(å¯¹ä¸€ä¸ªidä¸º1çš„è®°å½•è¿›è¡Œåˆ é™¤å¢åŠ ä¿®æ”¹)ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨å‘å¸ƒè®¢é˜…æ¨¡å‹ä¸­ï¼Œå¯¹äºä¸»é¢˜æ˜¯æ— é¡ºåºçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¼šå¯¼è‡´å¯¹äºæ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™æ²¡æœ‰æŒ‰ç…§ç”Ÿäº§è€…çš„å‘é€é¡ºåºæ¶ˆè´¹ï¼Œæ¯”å¦‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ¶ˆè´¹çš„é¡ºåºä¸ºä¿®æ”¹åˆ é™¤å¢åŠ ï¼Œå¦‚æœè¯¥è®°å½•æ¶‰åŠåˆ°é‡‘é¢çš„è¯æ˜¯ä¸æ˜¯ä¼šå‡ºå¤§äº‹æƒ…ï¼Ÿ</p><p>é‚£ä¹ˆï¼Œåˆ <strong>å¦‚ä½•è§£å†³æ¶ˆæ¯çš„é¡ºåºæ¶ˆè´¹é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>å°±æ‹¿æˆ‘ä»¬ä¸Šé¢æ‰€è®²çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œç”¨æˆ·è´­ç¥¨å®Œæˆä¹‹åæ˜¯ä¸æ˜¯éœ€è¦å¢åŠ è´¦æˆ·ç§¯åˆ†ï¼Ÿåœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨äº‹åŠ¡æ¥è¿›è¡Œè§£å†³ï¼Œå¦‚æœç”¨ <code>Spring</code> çš„è¯æˆ‘ä»¬åœ¨ä¸Šé¢ä¼ªä»£ç ä¸­åŠ å…¥ <code>@Transactional</code> æ³¨è§£å°±å¥½äº†ã€‚ä½†æ˜¯åœ¨ä¸åŒç³»ç»Ÿä¸­å¦‚ä½•ä¿è¯äº‹åŠ¡å‘¢ï¼Ÿæ€»ä¸èƒ½è¿™ä¸ªç³»ç»Ÿæˆ‘æ‰£é’±æˆåŠŸäº†ä½ é‚£ç§¯åˆ†ç³»ç»Ÿç§¯åˆ†æ²¡åŠ å§ï¼Ÿæˆ–è€…è¯´æˆ‘è¿™æ‰£é’±æ˜æ˜å¤±è´¥äº†ï¼Œä½ é‚£ç§¯åˆ†ç³»ç»Ÿç»™æˆ‘åŠ äº†ç§¯åˆ†ã€‚</p><p>é‚£ä¹ˆï¼Œåˆå¦‚ä½• <strong>è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬åˆšåˆšè¯´äº†ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥è¿›è¡Œå‰Šå³°æ“ä½œï¼Œé‚£å¦‚æœæˆ‘çš„æ¶ˆè´¹è€…å¦‚æœæ¶ˆè´¹å¾ˆæ…¢æˆ–è€…ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯å¾ˆå¿«ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯ä¼šå°†æ¶ˆæ¯å †ç§¯åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Ÿ</p><p>é‚£ä¹ˆï¼Œåˆå¦‚ä½• <strong>è§£å†³æ¶ˆæ¯å †ç§¯çš„é—®é¢˜</strong> å‘¢ï¼Ÿ</p><p>å¯ç”¨æ€§é™ä½ï¼Œå¤æ‚åº¦ä¸Šå‡ï¼Œåˆå¸¦æ¥ä¸€ç³»åˆ—çš„é‡å¤æ¶ˆè´¹ï¼Œé¡ºåºæ¶ˆè´¹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ¶ˆæ¯å †ç§¯çš„é—®é¢˜ï¼Œè¿™æ¶ˆæ¯é˜Ÿåˆ—è¿˜æ€ä¹ˆç”¨å•ŠğŸ˜µï¼Ÿ</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef382d709abc9d.png" alt="img"></p><p>åˆ«æ€¥ï¼ŒåŠæ³•æ€»æ˜¯æœ‰çš„ã€‚</p><h2 id="RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="# RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ"></a><a href="#rocketmq%E6%98%AF%E4%BB%80%E4%B9%88">#</a> RocketMQæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef383014430799.jpg" alt="img"></p><p>å“‡ï¼Œä½ ä¸ªæ··è›‹ï¼ä¸Šé¢ç»™æˆ‘æŠ›å‡ºé‚£ä¹ˆå¤šé—®é¢˜ï¼Œä½ ç°åœ¨åˆè®² <code>RocketMQ</code> ï¼Œè¿˜è®©ä¸è®©äººæ´»äº†ï¼Ÿï¼ğŸ¤¬</p><p>åˆ«æ€¥åˆ«æ€¥ï¼Œè¯è¯´ä½ ç°åœ¨æ¸…æ¥š <code>MQ</code> çš„æ„é€ å—ï¼Œæˆ‘è¿˜æ²¡è®²å‘¢ï¼Œæˆ‘ä»¬å…ˆææ˜ç™½ <code>MQ</code> çš„å†…éƒ¨æ„é€ ï¼Œå†æ¥çœ‹çœ‹å¦‚ä½•è§£å†³ä¸Šé¢çš„ä¸€ç³»åˆ—é—®é¢˜å§ï¼Œä¸è¿‡ä½ æœ€å¥½å¸¦ç€é—®é¢˜å»é˜…è¯»å’Œäº†è§£å–”ã€‚</p><p><code>RocketMQ</code> æ˜¯ä¸€ä¸ª <strong>é˜Ÿåˆ—æ¨¡å‹</strong> çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå…·æœ‰<strong>é«˜æ€§èƒ½ã€é«˜å¯é ã€é«˜å®æ—¶ã€åˆ†å¸ƒå¼</strong> çš„ç‰¹ç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªé‡‡ç”¨ <code>Java</code> è¯­è¨€å¼€å‘çš„åˆ†å¸ƒå¼çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œç”±é˜¿é‡Œå·´å·´å›¢é˜Ÿå¼€å‘ï¼Œåœ¨2016å¹´åº•è´¡çŒ®ç»™ <code>Apache</code>ï¼Œæˆä¸ºäº† <code>Apache</code> çš„ä¸€ä¸ªé¡¶çº§é¡¹ç›®ã€‚ åœ¨é˜¿é‡Œå†…éƒ¨ï¼Œ<code>RocketMQ</code> å¾ˆå¥½åœ°æœåŠ¡äº†é›†å›¢å¤§å¤§å°å°ä¸Šåƒä¸ªåº”ç”¨ï¼Œåœ¨æ¯å¹´çš„åŒåä¸€å½“å¤©ï¼Œæ›´æœ‰ä¸å¯æ€è®®çš„ä¸‡äº¿çº§æ¶ˆæ¯é€šè¿‡ <code>RocketMQ</code> æµè½¬ã€‚</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œæƒ³è¦äº†è§£ <code>RocketMQ</code> å†å²çš„åŒå­¦å¯ä»¥è‡ªå·±å»æœå¯»èµ„æ–™ã€‚å¬å®Œä¸Šé¢çš„ä»‹ç»ï¼Œä½ åªè¦çŸ¥é“ <code>RocketMQ</code> å¾ˆå¿«ã€å¾ˆç‰›ã€è€Œä¸”ç»å†è¿‡åŒåä¸€çš„å®è·µå°±è¡Œäº†ï¼</p><h2 id="é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹"><a href="#é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹" class="headerlink" title="# é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹"></a><a href="#%E9%98%9F%E5%88%97%E6%A8%A1%E5%9E%8B%E5%92%8C%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%9E%8B">#</a> é˜Ÿåˆ—æ¨¡å‹å’Œä¸»é¢˜æ¨¡å‹</h2><p>åœ¨è°ˆ <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä¸¤ä¸ªåè¯æ¦‚å¿µâ€”â€”<strong>é˜Ÿåˆ—æ¨¡å‹</strong> å’Œ <strong>ä¸»é¢˜æ¨¡å‹</strong> ã€‚</p><p>é¦–å…ˆæˆ‘é—®ä¸€ä¸ªé—®é¢˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆè¦å«æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</p><p>ä½ å¯èƒ½è§‰å¾—å¾ˆå¼±æ™ºï¼Œè¿™ç©æ„ä¸å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—å˜›ï¼Ÿä¸å«æ¶ˆæ¯é˜Ÿåˆ—å«ä»€ä¹ˆï¼Ÿ</p><p>çš„ç¡®ï¼Œæ—©æœŸçš„æ¶ˆæ¯ä¸­é—´ä»¶æ˜¯é€šè¿‡ <strong>é˜Ÿåˆ—</strong> è¿™ä¸€æ¨¡å‹æ¥å®ç°çš„ï¼Œå¯èƒ½æ˜¯å†å²åŸå› ï¼Œæˆ‘ä»¬éƒ½ä¹ æƒ¯æŠŠæ¶ˆæ¯ä¸­é—´ä»¶æˆä¸ºæ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚ä»Šä¾‹å¦‚ <code>RocketMQ</code> ã€<code>Kafka</code> è¿™äº›ä¼˜ç§€çš„æ¶ˆæ¯ä¸­é—´ä»¶ä¸ä»…ä»…æ˜¯é€šè¿‡ä¸€ä¸ª <strong>é˜Ÿåˆ—</strong> æ¥å®ç°æ¶ˆæ¯å­˜å‚¨çš„ã€‚</p><h3 id="é˜Ÿåˆ—æ¨¡å‹"><a href="#é˜Ÿåˆ—æ¨¡å‹" class="headerlink" title="# é˜Ÿåˆ—æ¨¡å‹"></a><a href="#%E9%98%9F%E5%88%97%E6%A8%A1%E5%9E%8B">#</a> é˜Ÿåˆ—æ¨¡å‹</h3><p>å°±åƒæˆ‘ä»¬ç†è§£é˜Ÿåˆ—ä¸€æ ·ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶çš„é˜Ÿåˆ—æ¨¡å‹å°±çœŸçš„åªæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ã€‚ã€‚ã€‚æˆ‘ç”»ä¸€å¼ å›¾ç»™å¤§å®¶ç†è§£ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef3834ae653469.jpg" alt="img"></p><p>åœ¨ä¸€å¼€å§‹æˆ‘è·Ÿä½ æåˆ°äº†ä¸€ä¸ª <strong>â€œå¹¿æ’­â€</strong> çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ­¤æ—¶æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªæ¶ˆæ¯å‘é€ç»™å¤šä¸ªæ¶ˆè´¹è€…(æ¯”å¦‚æ­¤æ—¶æˆ‘éœ€è¦å°†ä¿¡æ¯å‘é€ç»™çŸ­ä¿¡ç³»ç»Ÿå’Œé‚®ä»¶ç³»ç»Ÿ)ï¼Œè¿™ä¸ªæ—¶å€™å•ä¸ªé˜Ÿåˆ—å³ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†ã€‚</p><p>å½“ç„¶ä½ å¯ä»¥è®© <code>Producer</code> ç”Ÿäº§æ¶ˆæ¯æ”¾å…¥å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæ¯ä¸ªé˜Ÿåˆ—å»å¯¹åº”æ¯ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚é—®é¢˜æ˜¯å¯ä»¥è§£å†³ï¼Œåˆ›å»ºå¤šä¸ªé˜Ÿåˆ—å¹¶ä¸”å¤åˆ¶å¤šä»½æ¶ˆæ¯æ˜¯ä¼šå¾ˆå½±å“èµ„æºå’Œæ€§èƒ½çš„ã€‚è€Œä¸”ï¼Œè¿™æ ·å­å°±ä¼šå¯¼è‡´ç”Ÿäº§è€…éœ€è¦çŸ¥é“å…·ä½“æ¶ˆè´¹è€…ä¸ªæ•°ç„¶åå»å¤åˆ¶å¯¹åº”æ•°é‡çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™å°±è¿èƒŒæˆ‘ä»¬æ¶ˆæ¯ä¸­é—´ä»¶çš„ <strong>è§£è€¦</strong> è¿™ä¸€åŸåˆ™ã€‚</p><h3 id="ä¸»é¢˜æ¨¡å‹"><a href="#ä¸»é¢˜æ¨¡å‹" class="headerlink" title="# ä¸»é¢˜æ¨¡å‹"></a><a href="#%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%9E%8B">#</a> ä¸»é¢˜æ¨¡å‹</h3><p>é‚£ä¹ˆæœ‰æ²¡æœ‰å¥½çš„æ–¹æ³•å»è§£å†³è¿™ä¸€ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ‰ï¼Œé‚£å°±æ˜¯ <strong>ä¸»é¢˜æ¨¡å‹</strong> æˆ–è€…å¯ä»¥ç§°ä¸º <strong>å‘å¸ƒè®¢é˜…æ¨¡å‹</strong> ã€‚</p><blockquote><p>æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»äº†è§£ä¸€ä¸‹è®¾è®¡æ¨¡å¼é‡Œé¢çš„è§‚å¯Ÿè€…æ¨¡å¼å¹¶ä¸”æ‰‹åŠ¨å®ç°ä¸€ä¸‹ï¼Œæˆ‘ç›¸ä¿¡ä½ ä¼šæœ‰æ‰€æ”¶è·çš„ã€‚</p></blockquote><p>åœ¨ä¸»é¢˜æ¨¡å‹ä¸­ï¼Œæ¶ˆæ¯çš„ç”Ÿäº§è€…ç§°ä¸º <strong>å‘å¸ƒè€…(Publisher)</strong> ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹è€…ç§°ä¸º <strong>è®¢é˜…è€…(Subscriber)</strong> ï¼Œå­˜æ”¾æ¶ˆæ¯çš„å®¹å™¨ç§°ä¸º <strong>ä¸»é¢˜(Topic)</strong> ã€‚</p><p>å…¶ä¸­ï¼Œå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šä¸»é¢˜ä¸­ï¼Œè®¢é˜…è€…éœ€è¦ <strong>æå‰è®¢é˜…ä¸»é¢˜</strong> æ‰èƒ½æ¥å—ç‰¹å®šä¸»é¢˜çš„æ¶ˆæ¯ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef3837887d9a54sds.jpg" alt="img"></p><h3 id="RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹"><a href="#RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹" class="headerlink" title="# RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹"></a><a href="#rocketmq%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B">#</a> RocketMQä¸­çš„æ¶ˆæ¯æ¨¡å‹</h3><p><code>RocketMQ</code> ä¸­çš„æ¶ˆæ¯æ¨¡å‹å°±æ˜¯æŒ‰ç…§ <strong>ä¸»é¢˜æ¨¡å‹</strong> æ‰€å®ç°çš„ã€‚ä½ å¯èƒ½ä¼šå¥½å¥‡è¿™ä¸ª <strong>ä¸»é¢˜</strong> åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä½ ä¸Šé¢ä¹Ÿæ²¡æœ‰è®²åˆ°å‘€ï¼</p><p>å…¶å®å¯¹äºä¸»é¢˜æ¨¡å‹çš„å®ç°æ¥è¯´æ¯ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶çš„åº•å±‚è®¾è®¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå°±æ¯”å¦‚ <code>Kafka</code> ä¸­çš„ <strong>åˆ†åŒº</strong> ï¼Œ<code>RocketMQ</code> ä¸­çš„ <strong>é˜Ÿåˆ—</strong> ï¼Œ<code>RabbitMQ</code> ä¸­çš„ <code>Exchange</code> ã€‚æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º <strong>ä¸»é¢˜æ¨¡å‹&#x2F;å‘å¸ƒè®¢é˜…æ¨¡å‹</strong> å°±æ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œé‚£äº›ä¸­é—´ä»¶åªä¸è¿‡ç…§ç€è¿™ä¸ªæ ‡å‡†å»å®ç°è€Œå·²ã€‚</p><p>æ‰€ä»¥ï¼Œ<code>RocketMQ</code> ä¸­çš„ <strong>ä¸»é¢˜æ¨¡å‹</strong> åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ç”»ä¸€å¼ å›¾ï¼Œå¤§å®¶å°è¯•ç€å»ç†è§£ä¸€ä¸‹ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef383d3e8c9788.jpg" alt="img"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ•´ä¸ªå›¾ä¸­æœ‰ <code>Producer Group</code> ã€<code>Topic</code> ã€<code>Consumer Group</code> ä¸‰ä¸ªè§’è‰²ï¼Œæˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ä»–ä»¬ã€‚</p><ul><li><code>Producer Group</code> ç”Ÿäº§è€…ç»„ï¼š ä»£è¡¨æŸä¸€ç±»çš„ç”Ÿäº§è€…ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰å¤šä¸ªç§’æ€ç³»ç»Ÿä½œä¸ºç”Ÿäº§è€…ï¼Œè¿™å¤šä¸ªåˆåœ¨ä¸€èµ·å°±æ˜¯ä¸€ä¸ª <code>Producer Group</code> ç”Ÿäº§è€…ç»„ï¼Œå®ƒä»¬ä¸€èˆ¬ç”Ÿäº§ç›¸åŒçš„æ¶ˆæ¯ã€‚</li><li><code>Consumer Group</code> æ¶ˆè´¹è€…ç»„ï¼š ä»£è¡¨æŸä¸€ç±»çš„æ¶ˆè´¹è€…ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰å¤šä¸ªçŸ­ä¿¡ç³»ç»Ÿä½œä¸ºæ¶ˆè´¹è€…ï¼Œè¿™å¤šä¸ªåˆåœ¨ä¸€èµ·å°±æ˜¯ä¸€ä¸ª <code>Consumer Group</code> æ¶ˆè´¹è€…ç»„ï¼Œå®ƒä»¬ä¸€èˆ¬æ¶ˆè´¹ç›¸åŒçš„æ¶ˆæ¯ã€‚</li><li><code>Topic</code> ä¸»é¢˜ï¼š ä»£è¡¨ä¸€ç±»æ¶ˆæ¯ï¼Œæ¯”å¦‚è®¢å•æ¶ˆæ¯ï¼Œç‰©æµæ¶ˆæ¯ç­‰ç­‰ã€‚</li></ul><p>ä½ å¯ä»¥çœ‹åˆ°å›¾ä¸­ç”Ÿäº§è€…ç»„ä¸­çš„ç”Ÿäº§è€…ä¼šå‘ä¸»é¢˜å‘é€æ¶ˆæ¯ï¼Œè€Œ <strong>ä¸»é¢˜ä¸­å­˜åœ¨å¤šä¸ªé˜Ÿåˆ—</strong>ï¼Œç”Ÿäº§è€…æ¯æ¬¡ç”Ÿäº§æ¶ˆæ¯ä¹‹åæ˜¯æŒ‡å®šä¸»é¢˜ä¸­çš„æŸä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯çš„ã€‚</p><p>æ¯ä¸ªä¸»é¢˜ä¸­éƒ½æœ‰å¤šä¸ªé˜Ÿåˆ—(åˆ†å¸ƒåœ¨ä¸åŒçš„ <code>Broker</code>ä¸­ï¼Œå¦‚æœæ˜¯é›†ç¾¤çš„è¯ï¼Œ<code>Broker</code>åˆåˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸­)ï¼Œé›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…é›†ç¾¤å¤šå°æœºå™¨å…±åŒæ¶ˆè´¹ä¸€ä¸ª <code>topic</code> çš„å¤šä¸ªé˜Ÿåˆ—ï¼Œ<strong>ä¸€ä¸ªé˜Ÿåˆ—åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</strong>ã€‚å¦‚æœæŸä¸ªæ¶ˆè´¹è€…æŒ‚æ‰ï¼Œåˆ†ç»„å†…å…¶å®ƒæ¶ˆè´¹è€…ä¼šæ¥æ›¿æŒ‚æ‰çš„æ¶ˆè´¹è€…ç»§ç»­æ¶ˆè´¹ã€‚å°±åƒä¸Šå›¾ä¸­ <code>Consumer1</code> å’Œ <code>Consumer2</code> åˆ†åˆ«å¯¹åº”ç€ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œè€Œ <code>Consumer3</code> æ˜¯æ²¡æœ‰é˜Ÿåˆ—å¯¹åº”çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è®²è¦æ§åˆ¶ <strong>æ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ä¸ªæ•°å’Œä¸»é¢˜ä¸­é˜Ÿåˆ—ä¸ªæ•°ç›¸åŒ</strong> ã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥æ¶ˆè´¹è€…ä¸ªæ•°å°äºé˜Ÿåˆ—ä¸ªæ•°ï¼Œåªä¸è¿‡ä¸å¤ªå»ºè®®ã€‚å¦‚ä¸‹å›¾ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef3850c808d707.jpg" alt="img"></p><p><strong>æ¯ä¸ªæ¶ˆè´¹ç»„åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸Šç»´æŠ¤ä¸€ä¸ªæ¶ˆè´¹ä½ç½®</strong> ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å› ä¸ºæˆ‘ä»¬åˆšåˆšç”»çš„ä»…ä»…æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ä¸€èˆ¬ä¼šæ¶‰åŠåˆ°å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè€Œæ¯ä¸ªæ¶ˆè´¹è€…ç»„åœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆè´¹ä½ç½®éƒ½æ˜¯ä¸åŒçš„ã€‚å¦‚æœæ­¤æ—¶æœ‰å¤šä¸ªæ¶ˆè´¹è€…ç»„ï¼Œé‚£ä¹ˆæ¶ˆæ¯è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ç»„æ¶ˆè´¹å®Œä¹‹åæ˜¯ä¸ä¼šåˆ é™¤çš„(å› ä¸ºå…¶å®ƒæ¶ˆè´¹è€…ç»„ä¹Ÿéœ€è¦å‘€)ï¼Œå®ƒä»…ä»…æ˜¯ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…ç»„ç»´æŠ¤ä¸€ä¸ª <strong>æ¶ˆè´¹ä½ç§»(offset)</strong> ï¼Œæ¯æ¬¡æ¶ˆè´¹è€…ç»„æ¶ˆè´¹å®Œä¼šè¿”å›ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼Œç„¶åé˜Ÿåˆ—å†æŠŠç»´æŠ¤çš„æ¶ˆè´¹ä½ç§»åŠ ä¸€ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°åˆšåˆšæ¶ˆè´¹è¿‡çš„æ¶ˆæ¯å†ä¸€æ¬¡è¢«æ¶ˆè´¹äº†ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef3857fefaa079.jpg" alt="img"></p><p>å¯èƒ½ä½ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>ä¸ºä»€ä¹ˆä¸€ä¸ªä¸»é¢˜ä¸­éœ€è¦ç»´æŠ¤å¤šä¸ªé˜Ÿåˆ—</strong> ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ <strong>æé«˜å¹¶å‘èƒ½åŠ›</strong> ã€‚çš„ç¡®ï¼Œæ¯ä¸ªä¸»é¢˜ä¸­åªå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä½ æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ¯ä¸ªä¸»é¢˜ä¸­åªå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¸­ä¹Ÿç»´æŠ¤ç€æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥åšåˆ° <strong>å‘å¸ƒè®¢é˜…æ¨¡å¼</strong> ã€‚å¦‚ä¸‹å›¾ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef38600cdb6d4b.jpg" alt="img"></p><p>ä½†æ˜¯ï¼Œè¿™æ ·æˆ‘ç”Ÿäº§è€…æ˜¯ä¸æ˜¯åªèƒ½å‘ä¸€ä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Ÿåˆå› ä¸ºéœ€è¦ç»´æŠ¤æ¶ˆè´¹ä½ç½®æ‰€ä»¥ä¸€ä¸ªé˜Ÿåˆ—åªèƒ½å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å…¶ä»–çš„ <code>Consumer</code> å°±æ²¡æœ‰ç”¨æ­¦ä¹‹åœ°äº†ï¼Ÿä»è¿™ä¸¤ä¸ªè§’åº¦æ¥è®²ï¼Œå¹¶å‘åº¦ä¸€ä¸‹å­å°±å°äº†å¾ˆå¤šã€‚</p><p>æ‰€ä»¥æ€»ç»“æ¥è¯´ï¼Œ<code>RocketMQ</code> é€šè¿‡<strong>ä½¿ç”¨åœ¨ä¸€ä¸ª <code>Topic</code> ä¸­é…ç½®å¤šä¸ªé˜Ÿåˆ—å¹¶ä¸”æ¯ä¸ªé˜Ÿåˆ—ç»´æŠ¤æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®</strong> å®ç°äº† <strong>ä¸»é¢˜æ¨¡å¼&#x2F;å‘å¸ƒè®¢é˜…æ¨¡å¼</strong> ã€‚</p><h2 id="RocketMQçš„æ¶æ„å›¾"><a href="#RocketMQçš„æ¶æ„å›¾" class="headerlink" title="# RocketMQçš„æ¶æ„å›¾"></a><a href="#rocketmq%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE">#</a> RocketMQçš„æ¶æ„å›¾</h2><p>è®²å®Œäº†æ¶ˆæ¯æ¨¡å‹ï¼Œæˆ‘ä»¬ç†è§£èµ· <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„èµ·æ¥å°±å®¹æ˜“å¤šäº†ã€‚</p><p><code>RocketMQ</code> æŠ€æœ¯æ¶æ„ä¸­æœ‰å››å¤§è§’è‰² <code>NameServer</code> ã€<code>Broker</code> ã€<code>Producer</code> ã€<code>Consumer</code> ã€‚æˆ‘æ¥å‘å¤§å®¶åˆ†åˆ«è§£é‡Šä¸€ä¸‹è¿™å››ä¸ªè§’è‰²æ˜¯å¹²å•¥çš„ã€‚</p><ul><li><p><code>Broker</code>ï¼š ä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ã€‚è¯´ç™½äº†å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å˜›ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯åˆ° <code>Broker</code> ï¼Œæ¶ˆè´¹è€…ä» <code>Broker</code> æ‹‰å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘è¿˜å¾—æ™®åŠä¸€ä¸‹å…³äº <code>Broker</code> ã€<code>Topic</code> å’Œ é˜Ÿåˆ—çš„å…³ç³»ã€‚ä¸Šé¢æˆ‘è®²è§£äº† <code>Topic</code> å’Œé˜Ÿåˆ—çš„å…³ç³»â€”â€”ä¸€ä¸ª <code>Topic</code> ä¸­å­˜åœ¨å¤šä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>Topic</code> å’Œé˜Ÿåˆ—å­˜æ”¾åœ¨å“ªå‘¢ï¼Ÿ</p><p><strong>ä¸€ä¸ª <code>Topic</code> åˆ†å¸ƒåœ¨å¤šä¸ª <code>Broker</code>ä¸Šï¼Œä¸€ä¸ª <code>Broker</code> å¯ä»¥é…ç½®å¤šä¸ª <code>Topic</code> ï¼Œå®ƒä»¬æ˜¯å¤šå¯¹å¤šçš„å…³ç³»</strong>ã€‚</p><p>å¦‚æœæŸä¸ª <code>Topic</code> æ¶ˆæ¯é‡å¾ˆå¤§ï¼Œåº”è¯¥ç»™å®ƒå¤šé…ç½®å‡ ä¸ªé˜Ÿåˆ—(ä¸Šæ–‡ä¸­æåˆ°äº†æé«˜å¹¶å‘èƒ½åŠ›)ï¼Œå¹¶ä¸” <strong>å°½é‡å¤šåˆ†å¸ƒåœ¨ä¸åŒ <code>Broker</code> ä¸Šï¼Œä»¥å‡è½»æŸä¸ª <code>Broker</code> çš„å‹åŠ›</strong> ã€‚</p><p><code>Topic</code> æ¶ˆæ¯é‡éƒ½æ¯”è¾ƒå‡åŒ€çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸä¸ª <code>broker</code> ä¸Šçš„é˜Ÿåˆ—è¶Šå¤šï¼Œåˆ™è¯¥ <code>broker</code> å‹åŠ›è¶Šå¤§ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef38687488a5a4.jpg" alt="img"></p><blockquote><p>æ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦é…ç½®å¤šä¸ªBrokerã€‚</p></blockquote></li><li><p><code>NameServer</code>ï¼š ä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰æ¥è§¦è¿‡ <code>ZooKeeper</code> å’Œ <code>Spring Cloud</code> ä¸­çš„ <code>Eureka</code> ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ª <strong>æ³¨å†Œä¸­å¿ƒ</strong> ï¼Œä¸»è¦æä¾›ä¸¤ä¸ªåŠŸèƒ½ï¼š<strong>Brokerç®¡ç†</strong> å’Œ <strong>è·¯ç”±ä¿¡æ¯ç®¡ç†</strong> ã€‚è¯´ç™½äº†å°±æ˜¯ <code>Broker</code> ä¼šå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° <code>NameServer</code> ä¸­ï¼Œæ­¤æ—¶ <code>NameServer</code> å°±å­˜æ”¾äº†å¾ˆå¤š <code>Broker</code> çš„ä¿¡æ¯(Brokerçš„è·¯ç”±è¡¨)ï¼Œæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å°±ä» <code>NameServer</code> ä¸­è·å–è·¯ç”±è¡¨ç„¶åç…§ç€è·¯ç”±è¡¨çš„ä¿¡æ¯å’Œå¯¹åº”çš„ <code>Broker</code> è¿›è¡Œé€šä¿¡(ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å®šæœŸä¼šå‘ <code>NameServer</code> å»æŸ¥è¯¢ç›¸å…³çš„ <code>Broker</code> çš„ä¿¡æ¯)ã€‚</p></li><li><p><code>Producer</code>ï¼š æ¶ˆæ¯å‘å¸ƒçš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚è¯´ç™½äº†å°±æ˜¯ç”Ÿäº§è€…ã€‚</p></li><li><p><code>Consumer</code>ï¼š æ¶ˆæ¯æ¶ˆè´¹çš„è§’è‰²ï¼Œæ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚æ”¯æŒä»¥pushæ¨ï¼Œpullæ‹‰ä¸¤ç§æ¨¡å¼å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚åŒæ—¶ä¹Ÿæ”¯æŒé›†ç¾¤æ–¹å¼å’Œå¹¿æ’­æ–¹å¼çš„æ¶ˆè´¹ï¼Œå®ƒæä¾›å®æ—¶æ¶ˆæ¯è®¢é˜…æœºåˆ¶ã€‚è¯´ç™½äº†å°±æ˜¯æ¶ˆè´¹è€…ã€‚</p></li></ul><p>å¬å®Œäº†ä¸Šé¢çš„è§£é‡Šä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œè¿™ç©æ„å¥½ç®€å•ã€‚ä¸å°±æ˜¯è¿™æ ·çš„ä¹ˆï¼Ÿ</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef386c6d1e8bdb.jpg" alt="img"></p><p>å—¯ï¼Ÿä½ å¯èƒ½ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œè¿™è€å®¶ä¼™ <code>NameServer</code> å¹²å•¥ç”¨çš„ï¼Œè¿™ä¸å¤šä½™å—ï¼Ÿç›´æ¥ <code>Producer</code> ã€<code>Consumer</code> å’Œ <code>Broker</code> ç›´æ¥è¿›è¡Œç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ¶ˆæ¯ä¸å°±å¥½äº†ä¹ˆï¼Ÿ</p><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸Šæ–‡æåˆ°è¿‡ <code>Broker</code> æ˜¯éœ€è¦ä¿è¯é«˜å¯ç”¨çš„ï¼Œå¦‚æœæ•´ä¸ªç³»ç»Ÿä»…ä»…é ç€ä¸€ä¸ª <code>Broker</code> æ¥ç»´æŒçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>Broker</code> çš„å‹åŠ›ä¼šä¸ä¼šå¾ˆå¤§ï¼Ÿæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¤šä¸ª <code>Broker</code> æ¥ä¿è¯ <strong>è´Ÿè½½å‡è¡¡</strong> ã€‚</p><p>å¦‚æœè¯´ï¼Œæˆ‘ä»¬çš„æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ç›´æ¥å’Œå¤šä¸ª <code>Broker</code> ç›¸è¿ï¼Œé‚£ä¹ˆå½“ <code>Broker</code> ä¿®æ”¹çš„æ—¶å€™å¿…å®šä¼šç‰µè¿ç€æ¯ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿè€¦åˆé—®é¢˜ï¼Œè€Œ <code>NameServer</code> æ³¨å†Œä¸­å¿ƒå°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p><blockquote><p>å¦‚æœè¿˜ä¸æ˜¯å¾ˆç†è§£çš„è¯ï¼Œå¯ä»¥å»çœ‹æˆ‘ä»‹ç» <code>Spring Cloud</code> çš„é‚£ç¯‡æ–‡ç« ï¼Œå…¶ä¸­ä»‹ç»äº† <code>Eureka</code> æ³¨å†Œä¸­å¿ƒã€‚</p></blockquote><p>å½“ç„¶ï¼Œ<code>RocketMQ</code> ä¸­çš„æŠ€æœ¯æ¶æ„è‚¯å®šä¸æ­¢å‰é¢é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºä¸Šé¢å›¾ä¸­çš„å››ä¸ªè§’è‰²éƒ½æ˜¯éœ€è¦åšé›†ç¾¤çš„ã€‚æˆ‘ç»™å‡ºä¸€å¼ å®˜ç½‘çš„æ¶æ„å›¾ï¼Œå¤§å®¶å°è¯•ç†è§£ä¸€ä¸‹ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef386fa3be1e53.jpg" alt="img"></p><p>å…¶å®å’Œæˆ‘ä»¬æœ€å¼€å§‹ç”»çš„é‚£å¼ ä¹ä¸ç‰ˆçš„æ¶æ„å›¾ä¹Ÿæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä¸»è¦æ˜¯ä¸€äº›ç»†èŠ‚ä¸Šçš„å·®åˆ«ã€‚å¬æˆ‘ç»†ç»†é“æ¥ğŸ¤¨ã€‚</p><p>ç¬¬ä¸€ã€æˆ‘ä»¬çš„ <code>Broker</code> <strong>åšäº†é›†ç¾¤å¹¶ä¸”è¿˜è¿›è¡Œäº†ä¸»ä»éƒ¨ç½²</strong> ï¼Œç”±äºæ¶ˆæ¯åˆ†å¸ƒåœ¨å„ä¸ª <code>Broker</code> ä¸Šï¼Œä¸€æ—¦æŸä¸ª <code>Broker</code> å®•æœºï¼Œåˆ™è¯¥<code>Broker</code> ä¸Šçš„æ¶ˆæ¯è¯»å†™éƒ½ä¼šå—åˆ°å½±å“ã€‚æ‰€ä»¥ <code>Rocketmq</code> æä¾›äº† <code>master/slave</code> çš„ç»“æ„ï¼Œ <code>salve</code> å®šæ—¶ä» <code>master</code> åŒæ­¥æ•°æ®(åŒæ­¥åˆ·ç›˜æˆ–è€…å¼‚æ­¥åˆ·ç›˜)ï¼Œå¦‚æœ <code>master</code> å®•æœºï¼Œ<strong>åˆ™ <code>slave</code> æä¾›æ¶ˆè´¹æœåŠ¡ï¼Œä½†æ˜¯ä¸èƒ½å†™å…¥æ¶ˆæ¯</strong> (åé¢æˆ‘è¿˜ä¼šæåˆ°å“¦)ã€‚</p><p>ç¬¬äºŒã€ä¸ºäº†ä¿è¯ <code>HA</code> ï¼Œæˆ‘ä»¬çš„ <code>NameServer</code> ä¹Ÿåšäº†é›†ç¾¤éƒ¨ç½²ï¼Œä½†æ˜¯è¯·æ³¨æ„å®ƒæ˜¯ <strong>å»ä¸­å¿ƒåŒ–</strong> çš„ã€‚ä¹Ÿå°±æ„å‘³ç€å®ƒæ²¡æœ‰ä¸»èŠ‚ç‚¹ï¼Œä½ å¯ä»¥å¾ˆæ˜æ˜¾åœ°çœ‹å‡º <code>NameServer</code> çš„æ‰€æœ‰èŠ‚ç‚¹æ˜¯æ²¡æœ‰è¿›è¡Œ <code>Info Replicate</code> çš„ï¼Œåœ¨ <code>RocketMQ</code> ä¸­æ˜¯é€šè¿‡ <strong>å•ä¸ªBrokerå’Œæ‰€æœ‰NameServerä¿æŒé•¿è¿æ¥</strong> ï¼Œå¹¶ä¸”åœ¨æ¯éš”30ç§’ <code>Broker</code> ä¼šå‘æ‰€æœ‰ <code>Nameserver</code> å‘é€å¿ƒè·³ï¼Œå¿ƒè·³åŒ…å«äº†è‡ªèº«çš„ <code>Topic</code> é…ç½®ä¿¡æ¯ï¼Œè¿™ä¸ªæ­¥éª¤å°±å¯¹åº”è¿™ä¸Šé¢çš„ <code>Routing Info</code> ã€‚</p><p>ç¬¬ä¸‰ã€åœ¨ç”Ÿäº§è€…éœ€è¦å‘ <code>Broker</code> å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œ<strong>éœ€è¦å…ˆä» <code>NameServer</code> è·å–å…³äº <code>Broker</code> çš„è·¯ç”±ä¿¡æ¯</strong>ï¼Œç„¶åé€šè¿‡ <strong>è½®è¯¢</strong> çš„æ–¹æ³•å»å‘æ¯ä¸ªé˜Ÿåˆ—ä¸­ç”Ÿäº§æ•°æ®ä»¥è¾¾åˆ° <strong>è´Ÿè½½å‡è¡¡</strong> çš„æ•ˆæœã€‚</p><p>ç¬¬å››ã€æ¶ˆè´¹è€…é€šè¿‡ <code>NameServer</code> è·å–æ‰€æœ‰ <code>Broker</code> çš„è·¯ç”±ä¿¡æ¯åï¼Œå‘ <code>Broker</code> å‘é€ <code>Pull</code> è¯·æ±‚æ¥è·å–æ¶ˆæ¯æ•°æ®ã€‚<code>Consumer</code> å¯ä»¥ä»¥ä¸¤ç§æ¨¡å¼å¯åŠ¨â€”â€” <strong>å¹¿æ’­ï¼ˆBroadcastï¼‰å’Œé›†ç¾¤ï¼ˆClusterï¼‰</strong>ã€‚å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œä¸€æ¡æ¶ˆæ¯ä¼šå‘é€ç»™ <strong>åŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„æ‰€æœ‰æ¶ˆè´¹è€…</strong> ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹æ¶ˆæ¯åªä¼šå‘é€ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚</p><h2 id="å¦‚ä½•è§£å†³-é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹"><a href="#å¦‚ä½•è§£å†³-é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹" class="headerlink" title="# å¦‚ä½•è§£å†³ é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹"></a><a href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9%E3%80%81%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9">#</a> å¦‚ä½•è§£å†³ é¡ºåºæ¶ˆè´¹ã€é‡å¤æ¶ˆè´¹</h2><p>å…¶å®ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯æˆ‘åœ¨ä»‹ç»æ¶ˆæ¯é˜Ÿåˆ—å¸¦æ¥çš„ä¸€äº›å‰¯ä½œç”¨çš„æ—¶å€™æåˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›é—®é¢˜ä¸ä»…ä»…æŒ‚é’©äº <code>RocketMQ</code> ï¼Œè€Œæ˜¯åº”è¯¥æ¯ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶éƒ½éœ€è¦å»è§£å†³çš„ã€‚</p><p>åœ¨ä¸Šé¢æˆ‘ä»‹ç» <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„çš„æ—¶å€™æˆ‘å·²ç»å‘ä½ å±•ç¤ºäº† <strong>å®ƒæ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨çš„</strong> ï¼Œè¿™é‡Œä¸æ¶‰åŠè¿ç»´æ–¹é¢çš„æ­å»ºï¼Œå¦‚æœä½ æ„Ÿå…´è¶£å¯ä»¥è‡ªå·±å»å®˜ç½‘ä¸Šç…§ç€ä¾‹å­æ­å»ºå±äºä½ è‡ªå·±çš„ <code>RocketMQ</code> é›†ç¾¤ã€‚</p><blockquote><p>å…¶å® <code>Kafka</code> çš„æ¶æ„åŸºæœ¬å’Œ <code>RocketMQ</code> ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ³¨å†Œä¸­å¿ƒä½¿ç”¨äº† <code>Zookeeper</code> ã€å®ƒçš„ <strong>åˆ†åŒº</strong> å°±ç›¸å½“äº <code>RocketMQ</code> ä¸­çš„ <strong>é˜Ÿåˆ—</strong> ã€‚è¿˜æœ‰ä¸€äº›å°ç»†èŠ‚ä¸åŒä¼šåœ¨åé¢æåˆ°ã€‚</p></blockquote><h3 id="é¡ºåºæ¶ˆè´¹"><a href="#é¡ºåºæ¶ˆè´¹" class="headerlink" title="# é¡ºåºæ¶ˆè´¹"></a><a href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9">#</a> é¡ºåºæ¶ˆè´¹</h3><p>åœ¨ä¸Šé¢çš„æŠ€æœ¯æ¶æ„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† <strong><code>RocketMQ</code> åœ¨ä¸»é¢˜ä¸Šæ˜¯æ— åºçš„ã€å®ƒåªæœ‰åœ¨é˜Ÿåˆ—å±‚é¢æ‰æ˜¯ä¿è¯æœ‰åº</strong> çš„ã€‚</p><p>è¿™åˆæ‰¯åˆ°ä¸¤ä¸ªæ¦‚å¿µâ€”â€”<strong>æ™®é€šé¡ºåº</strong> å’Œ <strong>ä¸¥æ ¼é¡ºåº</strong> ã€‚</p><p>æ‰€è°“æ™®é€šé¡ºåºæ˜¯æŒ‡ æ¶ˆè´¹è€…é€šè¿‡ <strong>åŒä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„</strong> ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„ã€‚æ™®é€šé¡ºåºæ¶ˆæ¯åœ¨ <code>Broker</code> <strong>é‡å¯æƒ…å†µä¸‹ä¸ä¼šä¿è¯æ¶ˆæ¯é¡ºåºæ€§</strong> (çŸ­æš‚æ—¶é—´) ã€‚</p><p>æ‰€è°“ä¸¥æ ¼é¡ºåºæ˜¯æŒ‡ æ¶ˆè´¹è€…æ”¶åˆ°çš„ <strong>æ‰€æœ‰æ¶ˆæ¯</strong> å‡æ˜¯æœ‰é¡ºåºçš„ã€‚ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ <strong>å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿä¼šä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§</strong> ã€‚</p><p>ä½†æ˜¯ï¼Œä¸¥æ ¼é¡ºåºçœ‹èµ·æ¥è™½å¥½ï¼Œå®ç°å®ƒå¯ä¼šä»˜å‡ºå·¨å¤§çš„ä»£ä»·ã€‚å¦‚æœä½ ä½¿ç”¨ä¸¥æ ¼é¡ºåºæ¨¡å¼ï¼Œ<code>Broker</code> é›†ç¾¤ä¸­åªè¦æœ‰ä¸€å°æœºå™¨ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¸å¯ç”¨ã€‚ä½ è¿˜ç”¨å•¥ï¼Ÿç°åœ¨ä¸»è¦åœºæ™¯ä¹Ÿå°±åœ¨ <code>binlog</code> åŒæ­¥ã€‚</p><p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬çš„ <code>MQ</code> éƒ½æ˜¯èƒ½å®¹å¿çŸ­æš‚çš„ä¹±åºï¼Œæ‰€ä»¥æ¨èä½¿ç”¨æ™®é€šé¡ºåºæ¨¡å¼ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨äº† <strong>æ™®é€šé¡ºåºæ¨¡å¼</strong> ï¼Œæˆ‘ä»¬ä»ä¸Šé¢å­¦ä¹ çŸ¥é“äº†åœ¨ <code>Producer</code> ç”Ÿäº§æ¶ˆæ¯çš„æ—¶å€™ä¼šè¿›è¡Œè½®è¯¢(å–å†³ä½ çš„è´Ÿè½½å‡è¡¡ç­–ç•¥)æ¥å‘åŒä¸€ä¸»é¢˜çš„ä¸åŒæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚é‚£ä¹ˆå¦‚æœæ­¤æ—¶æˆ‘æœ‰å‡ ä¸ªæ¶ˆæ¯åˆ†åˆ«æ˜¯åŒä¸€ä¸ªè®¢å•çš„åˆ›å»ºã€æ”¯ä»˜ã€å‘è´§ï¼Œåœ¨è½®è¯¢çš„ç­–ç•¥ä¸‹è¿™ <strong>ä¸‰ä¸ªæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°ä¸åŒé˜Ÿåˆ—</strong> ï¼Œå› ä¸ºåœ¨ä¸åŒçš„é˜Ÿåˆ—æ­¤æ—¶å°±æ— æ³•ä½¿ç”¨ <code>RocketMQ</code> å¸¦æ¥çš„é˜Ÿåˆ—æœ‰åºç‰¹æ€§æ¥ä¿è¯æ¶ˆæ¯æœ‰åºæ€§äº†ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef3874585e096e.jpg" alt="img"></p><p>é‚£ä¹ˆï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†çš„ä»…ä»…æ˜¯å°†åŒä¸€è¯­ä¹‰ä¸‹çš„æ¶ˆæ¯æ”¾å…¥åŒä¸€ä¸ªé˜Ÿåˆ—(æ¯”å¦‚è¿™é‡Œæ˜¯åŒä¸€ä¸ªè®¢å•)ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <strong>Hashå–æ¨¡æ³•</strong> æ¥ä¿è¯åŒä¸€ä¸ªè®¢å•åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­å°±è¡Œäº†ã€‚</p><h3 id="é‡å¤æ¶ˆè´¹"><a href="#é‡å¤æ¶ˆè´¹" class="headerlink" title="# é‡å¤æ¶ˆè´¹"></a><a href="#%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9">#</a> é‡å¤æ¶ˆè´¹</h3><p>emmmï¼Œå°±ä¸¤ä¸ªå­—â€”â€” <strong>å¹‚ç­‰</strong> ã€‚åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ª<em>å¹‚ç­‰</em> æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚æ¯”å¦‚è¯´ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•çš„å¤„ç†ç§¯åˆ†çš„ç³»ç»Ÿï¼Œæ¯å½“æ¥ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™å®ƒå°±è´Ÿè´£ä¸ºåˆ›å»ºè¿™ä¸ªè®¢å•çš„ç”¨æˆ·çš„ç§¯åˆ†åŠ ä¸Šç›¸åº”çš„æ•°å€¼ã€‚å¯æ˜¯æœ‰ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™è®¢å•ç³»ç»Ÿ FrancisQ çš„è®¢å•ä¿¡æ¯ï¼Œå…¶è¦æ±‚æ˜¯ç»™ FrancisQ çš„ç§¯åˆ†åŠ ä¸Š 500ã€‚ä½†æ˜¯ç§¯åˆ†ç³»ç»Ÿåœ¨æ”¶åˆ° FrancisQ çš„è®¢å•ä¿¡æ¯å¤„ç†å®Œæˆä¹‹åè¿”å›ç»™æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æˆåŠŸçš„ä¿¡æ¯çš„æ—¶å€™å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨(å½“ç„¶è¿˜æœ‰å¾ˆå¤šç§æƒ…å†µï¼Œæ¯”å¦‚Brokeræ„å¤–é‡å¯ç­‰ç­‰)ï¼Œè¿™æ¡å›åº”æ²¡æœ‰å‘é€æˆåŠŸã€‚</p><p>é‚£ä¹ˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ²¡æ”¶åˆ°ç§¯åˆ†ç³»ç»Ÿçš„å›åº”ä¼šä¸ä¼šå°è¯•é‡å‘è¿™ä¸ªæ¶ˆæ¯ï¼Ÿé—®é¢˜å°±æ¥äº†ï¼Œæˆ‘å†å‘è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸‡ä¸€å®ƒåˆç»™ FrancisQ çš„è´¦æˆ·åŠ ä¸Š 500 ç§¯åˆ†æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™æˆ‘ä»¬çš„æ¶ˆè´¹è€…å®ç° <strong>å¹‚ç­‰</strong> ï¼Œä¹Ÿå°±æ˜¯å¯¹åŒä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ç»“æœï¼Œæ‰§è¡Œå¤šå°‘æ¬¡éƒ½ä¸å˜ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•ç»™ä¸šåŠ¡å®ç°å¹‚ç­‰å‘¢ï¼Ÿè¿™ä¸ªè¿˜æ˜¯éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡çš„ã€‚ä½ å¯ä»¥ä½¿ç”¨ <strong>å†™å…¥ <code>Redis</code></strong> æ¥ä¿è¯ï¼Œå› ä¸º <code>Redis</code> çš„ <code>key</code> å’Œ <code>value</code> å°±æ˜¯å¤©ç„¶æ”¯æŒå¹‚ç­‰çš„ã€‚å½“ç„¶è¿˜æœ‰ä½¿ç”¨ <strong>æ•°æ®åº“æ’å…¥æ³•</strong> ï¼ŒåŸºäºæ•°æ®åº“çš„å”¯ä¸€é”®æ¥ä¿è¯é‡å¤æ•°æ®ä¸ä¼šè¢«æ’å…¥å¤šæ¡ã€‚</p><p>ä¸è¿‡æœ€ä¸»è¦çš„è¿˜æ˜¯éœ€è¦ <strong>æ ¹æ®ç‰¹å®šåœºæ™¯ä½¿ç”¨ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆ</strong> ï¼Œä½ è¦çŸ¥é“ä½ çš„æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¦æ˜¯å®Œå…¨ä¸å¯é‡å¤æ¶ˆè´¹è¿˜æ˜¯å¯ä»¥å¿å—é‡å¤æ¶ˆè´¹çš„ï¼Œç„¶åå†é€‰æ‹©å¼ºæ ¡éªŒå’Œå¼±æ ¡éªŒçš„æ–¹å¼ã€‚æ¯•ç«Ÿåœ¨ CS é¢†åŸŸè¿˜æ˜¯å¾ˆå°‘æœ‰æŠ€æœ¯é“¶å¼¹çš„è¯´æ³•ã€‚</p><p>è€Œåœ¨æ•´ä¸ªäº’è”ç½‘é¢†åŸŸï¼Œå¹‚ç­‰ä¸ä»…ä»…é€‚ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—çš„é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œè¿™äº›å®ç°å¹‚ç­‰çš„æ–¹æ³•ï¼Œä¹ŸåŒæ ·é€‚ç”¨äºï¼Œ<strong>åœ¨å…¶ä»–åœºæ™¯ä¸­æ¥è§£å†³é‡å¤è¯·æ±‚æˆ–è€…é‡å¤è°ƒç”¨çš„é—®é¢˜</strong> ã€‚æ¯”å¦‚å°†HTTPæœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œ<strong>è§£å†³å‰ç«¯æˆ–è€…APPé‡å¤æäº¤è¡¨å•æ•°æ®çš„é—®é¢˜</strong> ï¼Œä¹Ÿå¯ä»¥å°†ä¸€ä¸ªå¾®æœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œè§£å†³ <code>RPC</code> æ¡†æ¶è‡ªåŠ¨é‡è¯•å¯¼è‡´çš„ <strong>é‡å¤è°ƒç”¨é—®é¢˜</strong> ã€‚</p><h2 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="# åˆ†å¸ƒå¼äº‹åŠ¡"></a><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1">#</a> åˆ†å¸ƒå¼äº‹åŠ¡</h2><p>å¦‚ä½•è§£é‡Šåˆ†å¸ƒå¼äº‹åŠ¡å‘¢ï¼Ÿäº‹åŠ¡å¤§å®¶éƒ½çŸ¥é“å§ï¼Ÿ<strong>è¦ä¹ˆéƒ½æ‰§è¡Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œ</strong> ã€‚åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å®ç°äº‹åŠ¡ï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šæœåŠ¡æ˜¯éƒ¨ç½²åœ¨ä¸åŒç³»ç»Ÿä¹‹é—´çš„ï¼Œè€Œä¸åŒæœåŠ¡ä¹‹é—´åˆéœ€è¦è¿›è¡Œè°ƒç”¨ã€‚æ¯”å¦‚æ­¤æ—¶æˆ‘ä¸‹è®¢å•ç„¶åå¢åŠ ç§¯åˆ†ï¼Œå¦‚æœä¿è¯ä¸äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„è¯ï¼Œå°±ä¼šå‡ºç°Aç³»ç»Ÿä¸‹äº†è®¢å•ï¼Œä½†æ˜¯Bç³»ç»Ÿå¢åŠ ç§¯åˆ†å¤±è´¥æˆ–è€…Aç³»ç»Ÿæ²¡æœ‰ä¸‹è®¢å•ï¼ŒBç³»ç»Ÿå´å¢åŠ äº†ç§¯åˆ†ã€‚å‰è€…å¯¹ç”¨æˆ·ä¸å‹å¥½ï¼Œåè€…å¯¹è¿è¥å•†ä¸åˆ©ï¼Œè¿™æ˜¯æˆ‘ä»¬éƒ½ä¸æ„¿æ„è§åˆ°çš„ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚ä½•å»è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>å¦‚ä»Šæ¯”è¾ƒå¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡å®ç°æœ‰ 2PCã€TCC å’Œäº‹åŠ¡æ¶ˆæ¯(half åŠæ¶ˆæ¯æœºåˆ¶)ã€‚æ¯ä¸€ç§å®ç°éƒ½æœ‰å…¶ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯ï¼Œä½†æ˜¯ä¹Ÿæœ‰å„è‡ªçš„é—®é¢˜ï¼Œ<strong>éƒ½ä¸æ˜¯å®Œç¾çš„è§£å†³æ–¹æ¡ˆ</strong>ã€‚</p><p>åœ¨ <code>RocketMQ</code> ä¸­ä½¿ç”¨çš„æ˜¯ <strong>äº‹åŠ¡æ¶ˆæ¯åŠ ä¸Šäº‹åŠ¡åæŸ¥æœºåˆ¶</strong> æ¥è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„ã€‚æˆ‘ç”»äº†å¼ å›¾ï¼Œå¤§å®¶å¯ä»¥å¯¹ç…§ç€å›¾è¿›è¡Œç†è§£ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef38798d7a987f.png" alt="img"></p><p>åœ¨ç¬¬ä¸€æ­¥å‘é€çš„ half æ¶ˆæ¯ ï¼Œå®ƒçš„æ„æ€æ˜¯ <strong>åœ¨äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œå¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ä¸å¯è§çš„</strong> ã€‚</p><blockquote><p>é‚£ä¹ˆï¼Œå¦‚ä½•åšåˆ°å†™å…¥æ¶ˆæ¯ä½†æ˜¯å¯¹ç”¨æˆ·ä¸å¯è§å‘¢ï¼ŸRocketMQäº‹åŠ¡æ¶ˆæ¯çš„åšæ³•æ˜¯ï¼šå¦‚æœæ¶ˆæ¯æ˜¯halfæ¶ˆæ¯ï¼Œå°†å¤‡ä»½åŸæ¶ˆæ¯çš„ä¸»é¢˜ä¸æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œç„¶å <strong>æ”¹å˜ä¸»é¢˜</strong> ä¸ºRMQ_SYS_TRANS_HALF_TOPICã€‚ç”±äºæ¶ˆè´¹ç»„æœªè®¢é˜…è¯¥ä¸»é¢˜ï¼Œæ•…æ¶ˆè´¹ç«¯æ— æ³•æ¶ˆè´¹halfç±»å‹çš„æ¶ˆæ¯ï¼Œ<strong>ç„¶åRocketMQä¼šå¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä»Topicä¸ºRMQ_SYS_TRANS_HALF_TOPICä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹</strong>ï¼Œæ ¹æ®ç”Ÿäº§è€…ç»„è·å–ä¸€ä¸ªæœåŠ¡æä¾›è€…å‘é€å›æŸ¥äº‹åŠ¡çŠ¶æ€è¯·æ±‚ï¼Œæ ¹æ®äº‹åŠ¡çŠ¶æ€æ¥å†³å®šæ˜¯æäº¤æˆ–å›æ»šæ¶ˆæ¯ã€‚</p></blockquote><p>ä½ å¯ä»¥è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰ä»ç¬¬5æ­¥å¼€å§‹çš„ <strong>äº‹åŠ¡åæŸ¥æœºåˆ¶</strong> ï¼Œå¦‚æœå‡ºç°ç½‘è·¯æ³¢åŠ¨ç¬¬4æ­¥æ²¡æœ‰å‘é€æˆåŠŸï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿ MQ ä¸çŸ¥é“æ˜¯ä¸æ˜¯éœ€è¦ç»™æ¶ˆè´¹è€…æ¶ˆè´¹çš„é—®é¢˜ï¼Œä»–å°±åƒä¸€ä¸ªæ— å¤´è‹è‡ä¸€æ ·ã€‚åœ¨ <code>RocketMQ</code> ä¸­å°±æ˜¯ä½¿ç”¨çš„ä¸Šè¿°çš„äº‹åŠ¡åæŸ¥æ¥è§£å†³çš„ï¼Œè€Œåœ¨ <code>Kafka</code> ä¸­é€šå¸¸æ˜¯ç›´æ¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸è®©ç”¨æˆ·æ¥è‡ªè¡Œè§£å†³ã€‚</p><p>ä½ è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>MQ Server</code> æŒ‡å‘ç³»ç»ŸBçš„æ“ä½œå·²ç»å’Œç³»ç»ŸAä¸ç›¸å…³äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯â€”â€”<strong>æœ¬åœ°äº‹åŠ¡å’Œå­˜å‚¨æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—æ‰æ˜¯åŒä¸€ä¸ªäº‹åŠ¡</strong>ã€‚è¿™æ ·ä¹Ÿå°±äº§ç”Ÿäº†äº‹åŠ¡çš„<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œ<strong>æ¯ä¸ªç³»ç»Ÿåªè¦ä¿è¯å®ƒè‡ªå·±é‚£ä¸€éƒ¨åˆ†çš„äº‹åŠ¡å°±è¡Œäº†</strong>ã€‚</p><h2 id="æ¶ˆæ¯å †ç§¯é—®é¢˜"><a href="#æ¶ˆæ¯å †ç§¯é—®é¢˜" class="headerlink" title="# æ¶ˆæ¯å †ç§¯é—®é¢˜"></a><a href="#%E6%B6%88%E6%81%AF%E5%A0%86%E7%A7%AF%E9%97%AE%E9%A2%98">#</a> æ¶ˆæ¯å †ç§¯é—®é¢˜</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½â€”â€”<strong>å‰Šå³°</strong> ã€‚é‚£ä¹ˆå¦‚æœè¿™ä¸ªå³°å€¼å¤ªå¤§äº†å¯¼è‡´æ¶ˆæ¯å †ç§¯åœ¨é˜Ÿåˆ—ä¸­æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>å…¶å®è¿™ä¸ªé—®é¢˜å¯ä»¥å°†å®ƒå¹¿ä¹‰åŒ–ï¼Œå› ä¸ºäº§ç”Ÿæ¶ˆæ¯å †ç§¯çš„æ ¹æºå…¶å®å°±åªæœ‰ä¸¤ä¸ªâ€”â€”ç”Ÿäº§è€…ç”Ÿäº§å¤ªå¿«æˆ–è€…æ¶ˆè´¹è€…æ¶ˆè´¹å¤ªæ…¢ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä»å¤šä¸ªè§’åº¦å»æ€è€ƒè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“æµé‡åˆ°å³°å€¼çš„æ—¶å€™æ˜¯å› ä¸ºç”Ÿäº§è€…ç”Ÿäº§å¤ªå¿«ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº› <strong>é™æµé™çº§</strong> çš„æ–¹æ³•ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å¢åŠ å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹å»æ°´å¹³æ‰©å±•å¢åŠ æ¶ˆè´¹èƒ½åŠ›æ¥åŒ¹é…ç”Ÿäº§çš„æ¿€å¢ã€‚å¦‚æœæ¶ˆè´¹è€…æ¶ˆè´¹è¿‡æ…¢çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ£€æŸ¥ <strong>æ˜¯å¦æ˜¯æ¶ˆè´¹è€…å‡ºç°äº†å¤§é‡çš„æ¶ˆè´¹é”™è¯¯</strong> ï¼Œæˆ–è€…æ‰“å°ä¸€ä¸‹æ—¥å¿—æŸ¥çœ‹æ˜¯å¦æ˜¯å“ªä¸€ä¸ªçº¿ç¨‹å¡æ­»ï¼Œå‡ºç°äº†é”èµ„æºä¸é‡Šæ”¾ç­‰ç­‰çš„é—®é¢˜ã€‚</p><blockquote><p>å½“ç„¶ï¼Œæœ€å¿«é€Ÿè§£å†³æ¶ˆæ¯å †ç§¯é—®é¢˜çš„æ–¹æ³•è¿˜æ˜¯å¢åŠ æ¶ˆè´¹è€…å®ä¾‹ï¼Œä¸è¿‡ <strong>åŒæ—¶ä½ è¿˜éœ€è¦å¢åŠ æ¯ä¸ªä¸»é¢˜çš„é˜Ÿåˆ—æ•°é‡</strong> ã€‚</p><p>åˆ«å¿˜äº†åœ¨ <code>RocketMQ</code> ä¸­ï¼Œ<strong>ä¸€ä¸ªé˜Ÿåˆ—åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</strong> ï¼Œå¦‚æœä½ ä»…ä»…æ˜¯å¢åŠ æ¶ˆè´¹è€…å®ä¾‹å°±ä¼šå‡ºç°æˆ‘ä¸€å¼€å§‹ç»™ä½ ç”»æ¶æ„å›¾çš„é‚£ç§æƒ…å†µã€‚</p></blockquote><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef387d939ab66d.jpg" alt="img"></p><h2 id="å›æº¯æ¶ˆè´¹"><a href="#å›æº¯æ¶ˆè´¹" class="headerlink" title="# å›æº¯æ¶ˆè´¹"></a><a href="#%E5%9B%9E%E6%BA%AF%E6%B6%88%E8%B4%B9">#</a> å›æº¯æ¶ˆè´¹</h2><p>å›æº¯æ¶ˆè´¹æ˜¯æŒ‡ <code>Consumer</code> å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œç”±äºä¸šåŠ¡ä¸Šéœ€æ±‚éœ€è¦é‡æ–°æ¶ˆè´¹ï¼Œåœ¨<code>RocketMQ</code> ä¸­ï¼Œ <code>Broker</code> åœ¨å‘<code>Consumer</code> æŠ•é€’æˆåŠŸæ¶ˆæ¯åï¼Œ<strong>æ¶ˆæ¯ä»ç„¶éœ€è¦ä¿ç•™</strong> ã€‚å¹¶ä¸”é‡æ–°æ¶ˆè´¹ä¸€èˆ¬æ˜¯æŒ‰ç…§æ—¶é—´ç»´åº¦ï¼Œä¾‹å¦‚ç”±äº <code>Consumer</code> ç³»ç»Ÿæ•…éšœï¼Œæ¢å¤åéœ€è¦é‡æ–°æ¶ˆè´¹1å°æ—¶å‰çš„æ•°æ®ï¼Œé‚£ä¹ˆ <code>Broker</code> è¦æä¾›ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥æŒ‰ç…§æ—¶é—´ç»´åº¦æ¥å›é€€æ¶ˆè´¹è¿›åº¦ã€‚<code>RocketMQ</code> æ”¯æŒæŒ‰ç…§æ—¶é—´å›æº¯æ¶ˆè´¹ï¼Œæ—¶é—´ç»´åº¦ç²¾ç¡®åˆ°æ¯«ç§’ã€‚</p><p>è¿™æ˜¯å®˜æ–¹æ–‡æ¡£çš„è§£é‡Šï¼Œæˆ‘ç›´æ¥ç…§æ¬è¿‡æ¥å°±å½“ç§‘æ™®äº†ğŸ˜ğŸ˜ğŸ˜ã€‚</p><h2 id="RocketMQ-çš„åˆ·ç›˜æœºåˆ¶"><a href="#RocketMQ-çš„åˆ·ç›˜æœºåˆ¶" class="headerlink" title="# RocketMQ çš„åˆ·ç›˜æœºåˆ¶"></a><a href="#rocketmq-%E7%9A%84%E5%88%B7%E7%9B%98%E6%9C%BA%E5%88%B6">#</a> RocketMQ çš„åˆ·ç›˜æœºåˆ¶</h2><p>ä¸Šé¢æˆ‘è®²äº†é‚£ä¹ˆå¤šçš„ <code>RocketMQ</code> çš„æ¶æ„å’Œè®¾è®¡åŸç†ï¼Œä½ æœ‰æ²¡æœ‰å¥½å¥‡</p><p>åœ¨ <code>Topic</code> ä¸­çš„ <strong>é˜Ÿåˆ—æ˜¯ä»¥ä»€ä¹ˆæ ·çš„å½¢å¼å­˜åœ¨çš„ï¼Ÿ</strong></p><p><strong>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆæ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨æŒä¹…åŒ–çš„å‘¢ï¼Ÿ</strong></p><p>æˆ‘åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ <strong>åŒæ­¥åˆ·ç›˜</strong> å’Œ <strong>å¼‚æ­¥åˆ·ç›˜</strong> åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒä»¬ä¼šç»™æŒä¹…åŒ–å¸¦æ¥ä»€ä¹ˆæ ·çš„å½±å“å‘¢ï¼Ÿ</p><p>ä¸‹é¢æˆ‘å°†ç»™ä½ ä»¬ä¸€ä¸€è§£é‡Šã€‚</p><h3 id="åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜"><a href="#åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜" class="headerlink" title="# åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜"></a><a href="#%E5%90%8C%E6%AD%A5%E5%88%B7%E7%9B%98%E5%92%8C%E5%BC%82%E6%AD%A5%E5%88%B7%E7%9B%98">#</a> åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜</h3><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef387fba311cda.jpg" alt="img"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨åŒæ­¥åˆ·ç›˜ä¸­éœ€è¦ç­‰å¾…ä¸€ä¸ªåˆ·ç›˜æˆåŠŸçš„ <code>ACK</code> ï¼ŒåŒæ­¥åˆ·ç›˜å¯¹ <code>MQ</code> æ¶ˆæ¯å¯é æ€§æ¥è¯´æ˜¯ä¸€ç§ä¸é”™çš„ä¿éšœï¼Œä½†æ˜¯ <strong>æ€§èƒ½ä¸Šä¼šæœ‰è¾ƒå¤§å½±å“</strong> ï¼Œä¸€èˆ¬åœ°é€‚ç”¨äºé‡‘èç­‰ç‰¹å®šä¸šåŠ¡åœºæ™¯ã€‚</p><p>è€Œå¼‚æ­¥åˆ·ç›˜å¾€å¾€æ˜¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»å¼‚æ­¥åœ°æ‰§è¡Œåˆ·ç›˜æ“ä½œã€‚æ¶ˆæ¯åˆ·ç›˜é‡‡ç”¨åå°å¼‚æ­¥çº¿ç¨‹æäº¤çš„æ–¹å¼è¿›è¡Œï¼Œ <strong>é™ä½äº†è¯»å†™å»¶è¿Ÿ</strong> ï¼Œæé«˜äº† <code>MQ</code> çš„æ€§èƒ½å’Œååé‡ï¼Œä¸€èˆ¬é€‚ç”¨äºå¦‚å‘éªŒè¯ç ç­‰å¯¹äºæ¶ˆæ¯ä¿è¯è¦æ±‚ä¸å¤ªé«˜çš„ä¸šåŠ¡åœºæ™¯ã€‚</p><p>ä¸€èˆ¬åœ°ï¼Œ<strong>å¼‚æ­¥åˆ·ç›˜åªæœ‰åœ¨ <code>Broker</code> æ„å¤–å®•æœºçš„æ—¶å€™ä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ®</strong>ï¼Œä½ å¯ä»¥è®¾ç½® <code>Broker</code> çš„å‚æ•° <code>FlushDiskType</code> æ¥è°ƒæ•´ä½ çš„åˆ·ç›˜ç­–ç•¥(ASYNC_FLUSH æˆ–è€… SYNC_FLUSH)ã€‚</p><h3 id="åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶"><a href="#åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶" class="headerlink" title="# åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶"></a><a href="#%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E5%92%8C%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6">#</a> åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶</h3><p>ä¸Šé¢çš„åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜æ˜¯åœ¨å•ä¸ªç»“ç‚¹å±‚é¢çš„ï¼Œè€ŒåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ä¸»è¦æ˜¯æŒ‡çš„ <code>Borker</code> ä¸»ä»æ¨¡å¼ä¸‹ï¼Œä¸»èŠ‚ç‚¹è¿”å›æ¶ˆæ¯ç»™å®¢æˆ·ç«¯çš„æ—¶å€™æ˜¯å¦éœ€è¦åŒæ­¥ä»èŠ‚ç‚¹ã€‚</p><ul><li>åŒæ­¥å¤åˆ¶ï¼š ä¹Ÿå« â€œåŒæ­¥åŒå†™â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åªæœ‰æ¶ˆæ¯åŒæ­¥åŒå†™åˆ°ä¸»ä»èŠ‚ç‚¹ä¸Šæ—¶æ‰è¿”å›å†™å…¥æˆåŠŸ</strong> ã€‚</li><li>å¼‚æ­¥å¤åˆ¶ï¼š <strong>æ¶ˆæ¯å†™å…¥ä¸»èŠ‚ç‚¹ä¹‹åå°±ç›´æ¥è¿”å›å†™å…¥æˆåŠŸ</strong> ã€‚</li></ul><p>ç„¶è€Œï¼Œå¾ˆå¤šäº‹æƒ…æ˜¯æ²¡æœ‰å®Œç¾çš„æ–¹æ¡ˆçš„ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬è¿›è¡Œæ¶ˆæ¯å†™å…¥çš„èŠ‚ç‚¹è¶Šå¤šå°±æ›´èƒ½ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†æ˜¯éšä¹‹çš„æ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼Œæ‰€ä»¥éœ€è¦ç¨‹åºå‘˜æ ¹æ®ç‰¹å®šä¸šåŠ¡åœºæ™¯å»é€‰æ‹©é€‚åº”çš„ä¸»ä»å¤åˆ¶æ–¹æ¡ˆã€‚</p><p>é‚£ä¹ˆï¼Œ<strong>å¼‚æ­¥å¤åˆ¶ä¼šä¸ä¼šä¹Ÿåƒå¼‚æ­¥åˆ·ç›˜é‚£æ ·å½±å“æ¶ˆæ¯çš„å¯é æ€§å‘¢ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œå› ä¸ºä¸¤è€…å°±æ˜¯ä¸åŒçš„æ¦‚å¿µï¼Œå¯¹äºæ¶ˆæ¯å¯é æ€§æ˜¯é€šè¿‡ä¸åŒçš„åˆ·ç›˜ç­–ç•¥ä¿è¯çš„ï¼Œè€Œåƒå¼‚æ­¥åŒæ­¥å¤åˆ¶ç­–ç•¥ä»…ä»…æ˜¯å½±å“åˆ°äº† <strong>å¯ç”¨æ€§</strong> ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶ä¸»è¦åŸå› <strong>æ˜¯ <code>RocketMQ</code> æ˜¯ä¸æ”¯æŒè‡ªåŠ¨ä¸»ä»åˆ‡æ¢çš„ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼Œç”Ÿäº§è€…å°±ä¸èƒ½å†ç»™è¿™ä¸ªä¸»èŠ‚ç‚¹ç”Ÿäº§æ¶ˆæ¯äº†</strong>ã€‚</p><p>æ¯”å¦‚è¿™ä¸ªæ—¶å€™é‡‡ç”¨å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œåœ¨ä¸»èŠ‚ç‚¹è¿˜æœªå‘é€å®Œéœ€è¦åŒæ­¥çš„æ¶ˆæ¯çš„æ—¶å€™ä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œè¿™ä¸ªæ—¶å€™ä»èŠ‚ç‚¹å°±å°‘äº†ä¸€éƒ¨åˆ†æ¶ˆæ¯ã€‚ä½†æ˜¯æ­¤æ—¶ç”Ÿäº§è€…æ— æ³•å†ç»™ä¸»èŠ‚ç‚¹ç”Ÿäº§æ¶ˆæ¯äº†ï¼Œ<strong>æ¶ˆè´¹è€…å¯ä»¥è‡ªåŠ¨åˆ‡æ¢åˆ°ä»èŠ‚ç‚¹è¿›è¡Œæ¶ˆè´¹</strong>(ä»…ä»…æ˜¯æ¶ˆè´¹)ï¼Œæ‰€ä»¥åœ¨ä¸»èŠ‚ç‚¹æŒ‚æ‰çš„æ—¶é—´åªä¼šäº§ç”Ÿä¸»ä»ç»“ç‚¹çŸ­æš‚çš„æ¶ˆæ¯ä¸ä¸€è‡´çš„æƒ…å†µï¼Œé™ä½äº†å¯ç”¨æ€§ï¼Œè€Œå½“ä¸»èŠ‚ç‚¹é‡å¯ä¹‹åï¼Œä»èŠ‚ç‚¹é‚£éƒ¨åˆ†æœªæ¥å¾—åŠå¤åˆ¶çš„æ¶ˆæ¯è¿˜ä¼šç»§ç»­å¤åˆ¶ã€‚</p><p>åœ¨å•ä¸»ä»æ¶æ„ä¸­ï¼Œå¦‚æœä¸€ä¸ªä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€æ•´ä¸ªç³»ç»Ÿä¸èƒ½å†ç”Ÿäº§äº†ã€‚é‚£ä¹ˆè¿™ä¸ªå¯ç”¨æ€§çš„é—®é¢˜èƒ½å¦è§£å†³å‘¢ï¼Ÿ<strong>ä¸€ä¸ªä¸»ä»ä¸è¡Œé‚£å°±å¤šä¸ªä¸»ä»çš„å‘—</strong>ï¼Œåˆ«å¿˜äº†åœ¨æˆ‘ä»¬æœ€åˆçš„æ¶æ„å›¾ä¸­ï¼Œæ¯ä¸ª <code>Topic</code> æ˜¯åˆ†å¸ƒåœ¨ä¸åŒ <code>Broker</code> ä¸­çš„ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef38687488a5a4.jpg" alt="img"></p><p>ä½†æ˜¯è¿™ç§å¤åˆ¶æ–¹å¼åŒæ ·ä¹Ÿä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ— æ³•ä¿è¯ <strong>ä¸¥æ ¼é¡ºåº</strong> ã€‚åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°äº†å¦‚ä½•ä¿è¯çš„æ¶ˆæ¯é¡ºåºæ€§æ˜¯é€šè¿‡å°†ä¸€ä¸ªè¯­ä¹‰çš„æ¶ˆæ¯å‘é€åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä½¿ç”¨ <code>Topic</code> ä¸‹çš„é˜Ÿåˆ—æ¥ä¿è¯é¡ºåºæ€§çš„ã€‚å¦‚æœæ­¤æ—¶æˆ‘ä»¬ä¸»èŠ‚ç‚¹Aè´Ÿè´£çš„æ˜¯è®¢å•Açš„ä¸€ç³»åˆ—è¯­ä¹‰æ¶ˆæ¯ï¼Œç„¶åå®ƒæŒ‚äº†ï¼Œè¿™æ ·å…¶ä»–èŠ‚ç‚¹æ˜¯æ— æ³•ä»£æ›¿ä¸»èŠ‚ç‚¹Açš„ï¼Œå¦‚æœæˆ‘ä»¬ä»»æ„èŠ‚ç‚¹éƒ½å¯ä»¥å­˜å…¥ä»»ä½•æ¶ˆæ¯ï¼Œé‚£å°±æ²¡æœ‰é¡ºåºæ€§å¯è¨€äº†ã€‚</p><p>è€Œåœ¨ <code>RocketMQ</code> ä¸­é‡‡ç”¨äº† <code>Dledger</code> è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä»–è¦æ±‚åœ¨å†™å…¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¦æ±‚<strong>è‡³å°‘æ¶ˆæ¯å¤åˆ¶åˆ°åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹ä¹‹å</strong>ï¼Œæ‰ç»™å®¢â¼¾ç«¯è¿”å›å†™â¼ŠæˆåŠŸï¼Œå¹¶ä¸”å®ƒæ˜¯â½€æŒé€šè¿‡é€‰ä¸¾æ¥åŠ¨æ€åˆ‡æ¢ä¸»èŠ‚ç‚¹çš„ã€‚è¿™é‡Œæˆ‘å°±ä¸å±•å¼€è¯´æ˜äº†ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»äº†è§£ã€‚</p><blockquote><p>ä¹Ÿä¸æ˜¯è¯´ <code>Dledger</code> æ˜¯ä¸ªå®Œç¾çš„æ–¹æ¡ˆï¼Œè‡³å°‘åœ¨ <code>Dledger</code> é€‰ä¸¾è¿‡ç¨‹ä¸­æ˜¯æ— æ³•æä¾›æœåŠ¡çš„ï¼Œè€Œä¸”ä»–å¿…é¡»è¦ä½¿ç”¨ä¸‰ä¸ªèŠ‚ç‚¹æˆ–ä»¥ä¸Šï¼Œå¦‚æœå¤šæ•°èŠ‚ç‚¹åŒæ—¶æŒ‚æ‰ä»–ä¹Ÿæ˜¯æ— æ³•ä¿è¯å¯ç”¨æ€§çš„ï¼Œè€Œä¸”è¦æ±‚æ¶ˆæ¯å¤åˆ¶åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹çš„æ•ˆç‡å’Œç›´æ¥å¼‚æ­¥å¤åˆ¶è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®è·çš„ã€‚</p></blockquote><h3 id="å­˜å‚¨æœºåˆ¶"><a href="#å­˜å‚¨æœºåˆ¶" class="headerlink" title="# å­˜å‚¨æœºåˆ¶"></a><a href="#%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6">#</a> å­˜å‚¨æœºåˆ¶</h3><p>è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬ä¸€å¼€å§‹çš„ä¸‰ä¸ªé—®é¢˜å—ï¼Ÿåˆ°è¿™é‡Œç¬¬ä¸‰ä¸ªé—®é¢˜å·²ç»è§£å†³äº†ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨ <code>Topic</code> ä¸­çš„ <strong>é˜Ÿåˆ—æ˜¯ä»¥ä»€ä¹ˆæ ·çš„å½¢å¼å­˜åœ¨çš„ï¼Ÿé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆæ˜¯å¦‚ä½•è¿›è¡Œå­˜å‚¨æŒä¹…åŒ–çš„å‘¢ï¼Ÿ</strong> è¿˜æœªè§£å†³ï¼Œå…¶å®è¿™é‡Œæ¶‰åŠåˆ°äº† <code>RocketMQ</code> æ˜¯å¦‚ä½•è®¾è®¡å®ƒçš„å­˜å‚¨ç»“æ„äº†ã€‚æˆ‘é¦–å…ˆæƒ³å¤§å®¶ä»‹ç» <code>RocketMQ</code> æ¶ˆæ¯å­˜å‚¨æ¶æ„ä¸­çš„ä¸‰å¤§è§’è‰²â€”â€”<code>CommitLog</code> ã€<code>ConsumeQueue</code> å’Œ <code>IndexFile</code> ã€‚</p><ul><li><code>CommitLog</code>ï¼š <strong>æ¶ˆæ¯ä¸»ä½“ä»¥åŠå…ƒæ•°æ®çš„å­˜å‚¨ä¸»ä½“</strong>ï¼Œå­˜å‚¨ <code>Producer</code> ç«¯å†™å…¥çš„æ¶ˆæ¯ä¸»ä½“å†…å®¹,æ¶ˆæ¯å†…å®¹ä¸æ˜¯å®šé•¿çš„ã€‚å•ä¸ªæ–‡ä»¶å¤§å°é»˜è®¤1G ï¼Œæ–‡ä»¶åé•¿åº¦ä¸º20ä½ï¼Œå·¦è¾¹è¡¥é›¶ï¼Œå‰©ä½™ä¸ºèµ·å§‹åç§»é‡ï¼Œæ¯”å¦‚00000000000000000000ä»£è¡¨äº†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œèµ·å§‹åç§»é‡ä¸º0ï¼Œæ–‡ä»¶å¤§å°ä¸º1G&#x3D;1073741824ï¼›å½“ç¬¬ä¸€ä¸ªæ–‡ä»¶å†™æ»¡äº†ï¼Œç¬¬äºŒä¸ªæ–‡ä»¶ä¸º00000000001073741824ï¼Œèµ·å§‹åç§»é‡ä¸º1073741824ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ¶ˆæ¯ä¸»è¦æ˜¯<strong>é¡ºåºå†™å…¥æ—¥å¿—æ–‡ä»¶</strong>ï¼Œå½“æ–‡ä»¶æ»¡äº†ï¼Œå†™å…¥ä¸‹ä¸€ä¸ªæ–‡ä»¶ã€‚</li><li><code>ConsumeQueue</code>ï¼š æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œ<strong>å¼•å…¥çš„ç›®çš„ä¸»è¦æ˜¯æé«˜æ¶ˆæ¯æ¶ˆè´¹çš„æ€§èƒ½</strong>(æˆ‘ä»¬å†å‰é¢ä¹Ÿè®²äº†)ï¼Œç”±äº<code>RocketMQ</code> æ˜¯åŸºäºä¸»é¢˜ <code>Topic</code> çš„è®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯é’ˆå¯¹ä¸»é¢˜è¿›è¡Œçš„ï¼Œå¦‚æœè¦éå† <code>commitlog</code> æ–‡ä»¶ä¸­æ ¹æ® <code>Topic</code> æ£€ç´¢æ¶ˆæ¯æ˜¯éå¸¸ä½æ•ˆçš„ã€‚<code>Consumer</code> å³å¯æ ¹æ® <code>ConsumeQueue</code> æ¥æŸ¥æ‰¾å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å…¶ä¸­ï¼Œ<code>ConsumeQueue</code>ï¼ˆé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—ï¼‰<strong>ä½œä¸ºæ¶ˆè´¹æ¶ˆæ¯çš„ç´¢å¼•</strong>ï¼Œä¿å­˜äº†æŒ‡å®š <code>Topic</code> ä¸‹çš„é˜Ÿåˆ—æ¶ˆæ¯åœ¨ <code>CommitLog</code> ä¸­çš„**èµ·å§‹ç‰©ç†åç§»é‡ <code>offset</code> *<em>ï¼Œæ¶ˆæ¯å¤§å° <code>size</code> å’Œæ¶ˆæ¯ <code>Tag</code> çš„ <code>HashCode</code> å€¼ã€‚*</em><code>consumequeue</code> æ–‡ä»¶å¯ä»¥çœ‹æˆæ˜¯åŸºäº <code>topic</code> çš„ <code>commitlog</code> ç´¢å¼•æ–‡ä»¶**ï¼Œæ•… <code>consumequeue</code> æ–‡ä»¶å¤¹çš„ç»„ç»‡æ–¹å¼å¦‚ä¸‹ï¼štopic&#x2F;queue&#x2F;fileä¸‰å±‚ç»„ç»‡ç»“æ„ï¼Œå…·ä½“å­˜å‚¨è·¯å¾„ä¸ºï¼š$HOME&#x2F;store&#x2F;consumequeue&#x2F;{topic}&#x2F;{queueId}&#x2F;{fileName}ã€‚åŒæ · <code>consumequeue</code> æ–‡ä»¶é‡‡å–å®šé•¿è®¾è®¡ï¼Œæ¯ä¸€ä¸ªæ¡ç›®å…±20ä¸ªå­—èŠ‚ï¼Œåˆ†åˆ«ä¸º8å­—èŠ‚çš„ <code>commitlog</code> ç‰©ç†åç§»é‡ã€4å­—èŠ‚çš„æ¶ˆæ¯é•¿åº¦ã€8å­—èŠ‚tag <code>hashcode</code>ï¼Œå•ä¸ªæ–‡ä»¶ç”±30Wä¸ªæ¡ç›®ç»„æˆï¼Œå¯ä»¥åƒæ•°ç»„ä¸€æ ·éšæœºè®¿é—®æ¯ä¸€ä¸ªæ¡ç›®ï¼Œæ¯ä¸ª <code>ConsumeQueue</code>æ–‡ä»¶å¤§å°çº¦5.72Mï¼›</li><li><code>IndexFile</code>ï¼š <code>IndexFile</code>ï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰æä¾›äº†ä¸€ç§å¯ä»¥é€šè¿‡keyæˆ–æ—¶é—´åŒºé—´æ¥æŸ¥è¯¢æ¶ˆæ¯çš„æ–¹æ³•ã€‚è¿™é‡Œåªåšç§‘æ™®ä¸åšè¯¦ç»†ä»‹ç»ã€‚</li></ul><p>æ€»ç»“æ¥è¯´ï¼Œæ•´ä¸ªæ¶ˆæ¯å­˜å‚¨çš„ç»“æ„ï¼Œæœ€ä¸»è¦çš„å°±æ˜¯ <code>CommitLoq</code> å’Œ <code>ConsumeQueue</code> ã€‚è€Œ <code>ConsumeQueue</code> ä½ å¯ä»¥å¤§æ¦‚ç†è§£ä¸º <code>Topic</code> ä¸­çš„é˜Ÿåˆ—ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef3884c02acc72.png" alt="img"></p><p><code>RocketMQ</code> é‡‡ç”¨çš„æ˜¯ <strong>æ··åˆå‹çš„å­˜å‚¨ç»“æ„</strong> ï¼Œå³ä¸º <code>Broker</code> å•ä¸ªå®ä¾‹ä¸‹æ‰€æœ‰çš„é˜Ÿåˆ—å…±ç”¨ä¸€ä¸ªæ—¥å¿—æ•°æ®æ–‡ä»¶æ¥å­˜å‚¨æ¶ˆæ¯ã€‚æœ‰æ„æ€çš„æ˜¯åœ¨åŒæ ·é«˜å¹¶å‘çš„ <code>Kafka</code> ä¸­ä¼šä¸ºæ¯ä¸ª <code>Topic</code> åˆ†é…ä¸€ä¸ªå­˜å‚¨æ–‡ä»¶ã€‚è¿™å°±æœ‰ç‚¹ç±»ä¼¼äºæˆ‘ä»¬æœ‰ä¸€å¤§å †ä¹¦éœ€è¦è£…ä¸Šä¹¦æ¶ï¼Œ<code>RockeMQ</code> æ˜¯ä¸åˆ†ä¹¦çš„ç§ç±»ç›´æ¥æˆæ‰¹çš„å¡ä¸Šå»çš„ï¼Œè€Œ <code>Kafka</code> æ˜¯å°†ä¹¦æœ¬æ”¾å…¥æŒ‡å®šçš„åˆ†ç±»åŒºåŸŸçš„ã€‚</p><p>è€Œ <code>RocketMQ</code> ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼ŸåŸå› æ˜¯ <strong>æé«˜æ•°æ®çš„å†™å…¥æ•ˆç‡</strong> ï¼Œä¸åˆ† <code>Topic</code> æ„å‘³ç€æˆ‘ä»¬æœ‰æ›´å¤§çš„å‡ ç‡è·å– <strong>æˆæ‰¹</strong> çš„æ¶ˆæ¯è¿›è¡Œæ•°æ®å†™å…¥ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥ä¸€ä¸ªéº»çƒ¦å°±æ˜¯è¯»å–æ¶ˆæ¯çš„æ—¶å€™éœ€è¦éå†æ•´ä¸ªå¤§æ–‡ä»¶ï¼Œè¿™æ˜¯éå¸¸è€—æ—¶çš„ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨ <code>RocketMQ</code> ä¸­åˆä½¿ç”¨äº† <code>ConsumeQueue</code> ä½œä¸ºæ¯ä¸ªé˜Ÿåˆ—çš„ç´¢å¼•æ–‡ä»¶æ¥ <strong>æå‡è¯»å–æ¶ˆæ¯çš„æ•ˆç‡</strong>ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥æ ¹æ®é˜Ÿåˆ—çš„æ¶ˆæ¯åºå·ï¼Œè®¡ç®—å‡ºç´¢å¼•çš„å…¨å±€ä½ç½®ï¼ˆç´¢å¼•åºå·*ç´¢å¼•å›ºå®šâ»“åº¦20ï¼‰ï¼Œç„¶åç›´æ¥è¯»å–è¿™æ¡ç´¢å¼•ï¼Œå†æ ¹æ®ç´¢å¼•ä¸­è®°å½•çš„æ¶ˆæ¯çš„å…¨å±€ä½ç½®ï¼Œæ‰¾åˆ°æ¶ˆæ¯ã€‚</p><p>è®²åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½å¯¹ <code>RockeMQ</code> çš„å­˜å‚¨æ¶æ„è¿˜æœ‰äº›æ¨¡ç³Šï¼Œæ²¡äº‹ï¼Œæˆ‘ä»¬ç»“åˆç€å›¾æ¥ç†è§£ä¸€ä¸‹ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/16ef388763c25c62.jpg" alt="img"></p><p>emmmï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€ç‚¹å¤æ‚ğŸ¤£ï¼Œçœ‹è‹±æ–‡å›¾ç‰‡å’Œè‹±æ–‡æ–‡æ¡£çš„æ—¶å€™å°±ä¸è¦æ€‚ï¼Œç¡¬ç€å¤´çš®å¾€ä¸‹çœ‹å°±è¡Œã€‚</p><blockquote><p>å¦‚æœä¸Šé¢æ²¡çœ‹æ‡‚çš„è¯»è€…ä¸€å®šè¦è®¤çœŸçœ‹ä¸‹é¢çš„æµç¨‹åˆ†æï¼</p></blockquote><p>é¦–å…ˆï¼Œåœ¨æœ€ä¸Šé¢çš„é‚£ä¸€å—å°±æ˜¯æˆ‘åˆšåˆšè®²çš„ä½ ç°åœ¨å¯ä»¥ç›´æ¥ **æŠŠ <code>ConsumerQueue</code> ç†è§£ä¸º <code>Queue</code>**ã€‚</p><p>åœ¨å›¾ä¸­æœ€å·¦è¾¹è¯´æ˜äº†çº¢è‰²æ–¹å—ä»£è¡¨è¢«å†™å…¥çš„æ¶ˆæ¯ï¼Œè™šçº¿æ–¹å—ä»£è¡¨ç­‰å¾…è¢«å†™å…¥çš„ã€‚å·¦è¾¹çš„ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¼šæŒ‡å®š <code>Topic</code> ã€<code>QueueId</code> å’Œå…·ä½“æ¶ˆæ¯å†…å®¹ï¼Œè€Œåœ¨ <code>Broker</code> ä¸­ç®¡ä½ æ˜¯å“ªé—¨å­æ¶ˆæ¯ï¼Œä»–ç›´æ¥ <strong>å…¨éƒ¨é¡ºåºå­˜å‚¨åˆ°äº† CommitLog</strong>ã€‚è€Œæ ¹æ®ç”Ÿäº§è€…æŒ‡å®šçš„ <code>Topic</code> å’Œ <code>QueueId</code> å°†è¿™æ¡æ¶ˆæ¯æœ¬èº«åœ¨ <code>CommitLog</code> çš„åç§»(offset)ï¼Œæ¶ˆæ¯æœ¬èº«å¤§å°ï¼Œå’Œtagçš„hashå€¼å­˜å…¥å¯¹åº”çš„ <code>ConsumeQueue</code> ç´¢å¼•æ–‡ä»¶ä¸­ã€‚è€Œåœ¨æ¯ä¸ªé˜Ÿåˆ—ä¸­éƒ½ä¿å­˜äº† <code>ConsumeOffset</code> å³æ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç½®(æˆ‘åœ¨æ¶æ„é‚£é‡Œæåˆ°äº†ï¼Œå¿˜äº†çš„åŒå­¦å¯ä»¥å›å»çœ‹ä¸€ä¸‹)ï¼Œè€Œæ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹çš„æ—¶å€™åªéœ€è¦æ ¹æ® <code>ConsumeOffset</code> è·å–ä¸‹ä¸€ä¸ªæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯å°±è¡Œäº†ã€‚</p><p>ä¸Šè¿°å°±æ˜¯æˆ‘å¯¹äºæ•´ä¸ªæ¶ˆæ¯å­˜å‚¨æ¶æ„çš„å¤§æ¦‚ç†è§£(è¿™é‡Œä¸æ¶‰åŠåˆ°ä¸€äº›ç»†èŠ‚è®¨è®ºï¼Œæ¯”å¦‚ç¨€ç–ç´¢å¼•ç­‰ç­‰é—®é¢˜)ï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©ã€‚</p><p>å› ä¸ºæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹å› ä¸ºå†™å—¨äº†å¿˜è®²äº†ï¼Œæƒ³æƒ³åœ¨å“ªé‡ŒåŠ ä¹Ÿä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ç•™ç»™å¤§å®¶å»æ€è€ƒğŸ¤”ğŸ¤”ä¸€ä¸‹å§ã€‚</p><p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-11/e314ee45gy1g05zgr67bbj20gp0b3aba.jpg" alt="img"></p><p>ä¸ºä»€ä¹ˆ <code>CommitLog</code> æ–‡ä»¶è¦è®¾è®¡æˆå›ºå®šå¤§å°çš„é•¿åº¦å‘¢ï¼Ÿæé†’ï¼š<strong>å†…å­˜æ˜ å°„æœºåˆ¶</strong>ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="# æ€»ç»“"></a><a href="#%E6%80%BB%E7%BB%93">#</a> æ€»ç»“</h2><p>æ€»ç®—æŠŠè¿™ç¯‡åšå®¢å†™å®Œäº†ã€‚æˆ‘è®²çš„ä½ ä»¬è¿˜è®°å¾—å—ğŸ˜…ï¼Ÿ</p><p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä¸»è¦æƒ³å¤§å®¶ä»‹ç»äº†</p><ol><li>æ¶ˆæ¯é˜Ÿåˆ—å‡ºç°çš„åŸå› </li><li>æ¶ˆæ¯é˜Ÿåˆ—çš„ä½œç”¨(å¼‚æ­¥ï¼Œè§£è€¦ï¼Œå‰Šå³°)</li><li>æ¶ˆæ¯é˜Ÿåˆ—å¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜(æ¶ˆæ¯å †ç§¯ã€é‡å¤æ¶ˆè´¹ã€é¡ºåºæ¶ˆè´¹ã€åˆ†å¸ƒå¼äº‹åŠ¡ç­‰ç­‰)</li><li>æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸¤ç§æ¶ˆæ¯æ¨¡å‹â€”â€”é˜Ÿåˆ—å’Œä¸»é¢˜æ¨¡å¼</li><li>åˆ†æäº† <code>RocketMQ</code> çš„æŠ€æœ¯æ¶æ„(<code>NameServer</code> ã€<code>Broker</code> ã€<code>Producer</code> ã€<code>Comsumer</code>)</li><li>ç»“åˆ <code>RocketMQ</code> å›ç­”äº†æ¶ˆæ¯é˜Ÿåˆ—å‰¯ä½œç”¨çš„è§£å†³æ–¹æ¡ˆ</li><li>ä»‹ç»äº† <code>RocketMQ</code> çš„å­˜å‚¨æœºåˆ¶å’Œåˆ·ç›˜ç­–ç•¥ã€‚</li></ol><p>ç­‰ç­‰ã€‚ã€‚ã€‚</p><blockquote><p>å¦‚æœå–œæ¬¢å¯ä»¥ç‚¹èµå“ŸğŸ‘ğŸ‘ğŸ‘ã€‚</p></blockquote></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"><a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a> <a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a></nav></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview"> ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">enpsl</p><div class="site-description" itemprop="description">my blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">50</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span></div><div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script></body></html>