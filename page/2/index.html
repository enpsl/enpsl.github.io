<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"enpsl.github.io",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="my blog"><meta property="og:type" content="website"><meta property="og:title" content="彭诗亮的博客"><meta property="og:url" content="https://enpsl.github.io/page/2/index.html"><meta property="og:site_name" content="彭诗亮的博客"><meta property="og:description" content="my blog"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="enpsl"><meta property="article:tag" content="彭诗亮 psl pengshiliang blog"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://enpsl.github.io/page/2/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>彭诗亮的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">彭诗亮的博客</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/03/08/2022-03-08-elasticsearch/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/03/08/2022-03-08-elasticsearch/" class="post-title-link" itemprop="url">elasticsearch入门</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-08 14:30:00" itemprop="dateCreated datePublished" datetime="2022-03-08T14:30:00+08:00">2022-03-08</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="入门介绍"><a href="#入门介绍" class="headerlink" title="入门介绍"></a>入门介绍</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol><li>ElasticSearch需要的jdk版本至少是1.8的，所以安装之前先查看jdk版本号</li></ol><p>2.下载ElasticSearch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/elastic/elasticsearch/archive/v6.5.0.tar.gz</span><br><span class="line">tar -zxvf elasticsearch-6.5.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> elasticsearch-6.5.0</span><br></pre></td></tr></table></figure><p>简单本地集群环境搭建</p><p>vim config&#x2F;elasticsearch.yml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: my-application    注释打开</span><br></pre></td></tr></table></figure><p>启动三个集群命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch -Ehttp.port=7200 -Epath.data=node3</span><br><span class="line">./bin/elasticsearch -Ehttp.port=8200 -Epath.data=node2</span><br><span class="line">./bin/elasticsearch</span><br></pre></td></tr></table></figure><p>集群状态查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pengshiliang@pengshiliang-OptiPlex-3020:~$ curl 127.0.0.1:9200/_cat/nodes?v</span><br><span class="line">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">127.0.0.1           30          98   2    2.03    0.96     0.53 mdi       -      dRA_DV4</span><br><span class="line">127.0.0.1           30          98   2    2.03    0.96     0.53 mdi       -      j8_g2SD</span><br><span class="line">127.0.0.1           31          98   3    2.03    0.96     0.53 mdi       *      3cYY9cL</span><br><span class="line">pengshiliang@pengshiliang-OptiPlex-3020:~$ curl 127.0.0.1:9200/_cluster/stats</span><br><span class="line">&#123;<span class="string">&quot;_nodes&quot;</span>:&#123;<span class="string">&quot;total&quot;</span>:3,<span class="string">&quot;successful&quot;</span>:3,<span class="string">&quot;failed&quot;</span>:0&#125;,<span class="string">&quot;cluster_name&quot;</span>:<span class="string">&quot;my-application&quot;</span>,<span class="string">&quot;cluster_uuid&quot;</span>:<span class="string">&quot;5nD6JB_MRyiin3n7QTCoDg&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:1552028850410,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;green&quot;</span>,<span class="string">&quot;indices&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:0,<span class="string">&quot;shards&quot;</span>:&#123;&#125;,<span class="string">&quot;docs&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:0,<span class="string">&quot;deleted&quot;</span>:0&#125;,<span class="string">&quot;store&quot;</span>:&#123;<span class="string">&quot;size_in_bytes&quot;</span>:0&#125;,<span class="string">&quot;fielddata&quot;</span>:&#123;<span class="string">&quot;memory_size_in_bytes&quot;</span>:0,<span class="string">&quot;evictions&quot;</span>:0&#125;,<span class="string">&quot;query_cache&quot;</span>:&#123;<span class="string">&quot;memory_size_in_bytes&quot;</span>:0,<span class="string">&quot;total_count&quot;</span>:0,<span class="string">&quot;hit_count&quot;</span>:0,<span class="string">&quot;miss_count&quot;</span>:0,<span class="string">&quot;cache_size&quot;</span>:0,<span class="string">&quot;cache_count&quot;</span>:0,<span class="string">&quot;evictions&quot;</span>:0&#125;,<span class="string">&quot;completion&quot;</span>:&#123;<span class="string">&quot;size_in_bytes&quot;</span>:0&#125;,<span class="string">&quot;segments&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:0,<span class="string">&quot;memory_in_bytes&quot;</span>:0,<span class="string">&quot;terms_memory_in_bytes&quot;</span>:0,<span class="string">&quot;stored_fields_memory_in_bytes&quot;</span>:0,<span class="string">&quot;term_vectors_memory_in_bytes&quot;</span>:0,<span class="string">&quot;norms_memory_in_bytes&quot;</span>:0,<span class="string">&quot;points_memory_in_bytes&quot;</span>:0,<span class="string">&quot;doc_values_memory_in_bytes&quot;</span>:0,<span class="string">&quot;index_writer_memory_in_bytes&quot;</span>:0,<span class="string">&quot;version_map_memory_in_bytes&quot;</span>:0,<span class="string">&quot;fixed_bit_set_memory_in_bytes&quot;</span>:0,<span class="string">&quot;max_unsafe_auto_id_timestamp&quot;</span>:-9223372036854775808,<span class="string">&quot;file_sizes&quot;</span>:&#123;&#125;&#125;&#125;,<span class="string">&quot;nodes&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:&#123;<span class="string">&quot;total&quot;</span>:3,<span class="string">&quot;data&quot;</span>:3,<span class="string">&quot;coordinating_only&quot;</span>:0,<span class="string">&quot;master&quot;</span>:3,<span class="string">&quot;ingest&quot;</span>:3&#125;,<span class="string">&quot;versions&quot;</span>:[<span class="string">&quot;6.5.0&quot;</span>],<span class="string">&quot;os&quot;</span>:&#123;<span class="string">&quot;available_processors&quot;</span>:12,<span class="string">&quot;allocated_processors&quot;</span>:12,<span class="string">&quot;names&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Linux&quot;</span>,<span class="string">&quot;count&quot;</span>:3&#125;],<span class="string">&quot;mem&quot;</span>:&#123;<span class="string">&quot;total_in_bytes&quot;</span>:24839368704,<span class="string">&quot;free_in_bytes&quot;</span>:437612544,<span class="string">&quot;used_in_bytes&quot;</span>:24401756160,<span class="string">&quot;free_percent&quot;</span>:2,<span class="string">&quot;used_percent&quot;</span>:98&#125;&#125;,<span class="string">&quot;process&quot;</span>:&#123;<span class="string">&quot;cpu&quot;</span>:&#123;<span class="string">&quot;percent&quot;</span>:0&#125;,<span class="string">&quot;open_file_descriptors&quot;</span>:&#123;<span class="string">&quot;min&quot;</span>:305,<span class="string">&quot;max&quot;</span>:306,<span class="string">&quot;avg&quot;</span>:305&#125;&#125;,<span class="string">&quot;jvm&quot;</span>:&#123;<span class="string">&quot;max_uptime_in_millis&quot;</span>:74396,<span class="string">&quot;versions&quot;</span>:[&#123;<span class="string">&quot;version&quot;</span>:<span class="string">&quot;1.8.0_171&quot;</span>,<span class="string">&quot;vm_name&quot;</span>:<span class="string">&quot;Java HotSpot(TM) 64-Bit Server VM&quot;</span>,<span class="string">&quot;vm_version&quot;</span>:<span class="string">&quot;25.171-b11&quot;</span>,<span class="string">&quot;vm_vendor&quot;</span>:<span class="string">&quot;Oracle Corporation&quot;</span>,<span class="string">&quot;count&quot;</span>:3&#125;],<span class="string">&quot;mem&quot;</span>:&#123;<span class="string">&quot;heap_used_in_bytes&quot;</span>:972703928,<span class="string">&quot;heap_max_in_bytes&quot;</span>:3116630016&#125;,<span class="string">&quot;threads&quot;</span>:143&#125;,<span class="string">&quot;fs&quot;</span>:&#123;<span class="string">&quot;total_in_bytes&quot;</span>:483753484288,<span class="string">&quot;free_in_bytes&quot;</span>:438342832128,<span class="string">&quot;available_in_bytes&quot;</span>:413745967104&#125;,<span class="string">&quot;plugins&quot;</span>:[],<span class="string">&quot;network_types&quot;</span>:&#123;<span class="string">&quot;transport_types&quot;</span>:&#123;<span class="string">&quot;security4&quot;</span>:3&#125;,<span class="string">&quot;http_types&quot;</span>:&#123;<span class="string">&quot;security4&quot;</span>:3&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="多机部署"><a href="#多机部署" class="headerlink" title="多机部署"></a>多机部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">network.host: your ip <span class="comment">#（主机地址）对外发布的网络地址 </span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;<span class="variable">$ip</span>&quot;</span>]  <span class="variable">$ip</span>一定要包含该集群中其他机器的ip</span><br></pre></td></tr></table></figure><h3 id="Elasticsearch-常用术语"><a href="#Elasticsearch-常用术语" class="headerlink" title="Elasticsearch 常用术语"></a>Elasticsearch 常用术语</h3><p>Document 文档数据<br>Index 索引<br>Type 索引中的数据类型<br>Field 字段，文档属性<br>Query DSL查询语法</p><h3 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h3><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /accounts/person/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Bob&quot;,</span><br><span class="line">  &quot;job&quot;: &quot;developer&quot;,</span><br><span class="line">  &quot;sex&quot;: &quot;male&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这条语句表述的含义是在index为accounts的person类型下创建一条id为1的数据<br>Result：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /accounts/person/1</span><br></pre></td></tr></table></figure><p>Result：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bob&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;developer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /accounts/person/1/_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;John&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /accounts/person/1</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;deleted&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="查询语法"><a href="#查询语法" class="headerlink" title="查询语法"></a>查询语法</h3><h4 id="Query-String"><a href="#Query-String" class="headerlink" title="Query String"></a>Query String</h4><p>后面接?q形式</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /accounts/person/_search?q=John</span><br></pre></td></tr></table></figure><h4 id="Query-Dsl"><a href="#Query-Dsl" class="headerlink" title="Query Dsl"></a>Query Dsl</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /accounts/person/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;John&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>详细参考<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/query-dsl.html">query-dsl</a></p><h2 id="ElasticSearch初步介绍"><a href="#ElasticSearch初步介绍" class="headerlink" title="ElasticSearch初步介绍"></a>ElasticSearch初步介绍</h2><h3 id="正排-x2F-倒排索引"><a href="#正排-x2F-倒排索引" class="headerlink" title="正排&#x2F;倒排索引"></a>正排&#x2F;倒排索引</h3><p>正排索引：</p><table><thead><tr><th>文档ID</th><th>文档内容</th></tr></thead><tbody><tr><td>1</td><td>elasticsearch是最流行的搜索引擎</td></tr><tr><td>2</td><td>php是世界最好的语言</td></tr><tr><td>3</td><td>搜索引擎是如何诞生的</td></tr></tbody></table><p>倒排索引：</p><table><thead><tr><th>文档内容</th><th>文档ID</th></tr></thead><tbody><tr><td>elasticsearch</td><td>1</td></tr><tr><td>流行</td><td>1</td></tr><tr><td>搜索引擎</td><td>1,3</td></tr><tr><td>php</td><td>2</td></tr><tr><td>世界</td><td>2</td></tr><tr><td>最好</td><td>2</td></tr><tr><td>语言</td><td>2</td></tr><tr><td>如何</td><td>3</td></tr><tr><td>诞生</td><td>3</td></tr></tbody></table><p>查询包含搜索引擎的文档：</p><ol><li>通过倒排索引获得含有“搜索引擎”的文档ID是1,3</li><li>通过正排索引查看1,3的内容</li><li>返回结果</li></ol><h4 id="倒排索引基本概念"><a href="#倒排索引基本概念" class="headerlink" title="倒排索引基本概念"></a>倒排索引基本概念</h4><p>倒排索引(Inverted Index)：倒排索引是实现“单词-文档矩阵”的一种具体存储形式，通过倒排索引，可以根据单词快速获取包含这个单词的文档列表。倒排索引主要由两个部分组成：“单词词典”和“倒排文件”。</p><p>单词词典(Lexicon)：搜索引擎的通常索引单位是单词，单词词典是由文档集合中出现过的所有单词构成的字符串集合，单词词典内每条索引项记载单词本身的一些信息以及指向“倒排列表”的指针。</p><p>倒排列表(PostingList)：倒排列表记载了出现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息，每条记录称为一个倒排项(Posting)。根据倒排列表，即可获知哪些文档包含某个单词。</p><p>倒排文件(Inverted File)：所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件即被称之为倒排文件，倒排文件是存储倒排索引的物理文件。</p><h4 id="倒排索引的组成"><a href="#倒排索引的组成" class="headerlink" title="倒排索引的组成"></a>倒排索引的组成</h4><p>倒排索引是搜索引擎的核心，主要包含两个部分：</p><ol><li>单词词典（Trem Dictionary）：记录的是所有的文档分词后的结果</li><li>倒排列表（Posting List）：记录了单词对应文档的集合，由倒排索引项（Posting）组成。</li></ol><p><strong>单词字典的实现一般采用B+Tree的方式，来保证高效</strong></p><p>倒排索引项（Posting）主要包含如下的信息：</p><ol><li>文档ID，用于获取原始文档的信息</li><li>单词频率（TF，Term Frequency），记录该单词在该文档中出现的次数，用于后续相关性算分。</li><li>位置（Position），记录单词在文档中的分词位置（多个），用于做词语搜索。</li><li>偏移（Offset），记录单词在文档的开始和结束位置，用于高亮显示</li></ol><p>倒排列表：</p><p><img src="/img/in-post/2019-03-13/1.png"></p><blockquote><p>“elasticsearch是最流行的搜索引擎”可分为3个词语，搜索引擎在第二个位置，并且字符位置是18-22之间</p></blockquote><p><img src="/img/in-post/2019-03-13/2.png"></p><p>es存储的是一个json格式的文档，其中包含多个字段，每个字段都会有自己的倒排索引，类似这种</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;huangtoufa&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;job&quot;</span><span class="punctuation">:</span> <span class="string">&quot;programmer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>job和username都有自己的倒排索引</p><h3 id="分词介绍"><a href="#分词介绍" class="headerlink" title="分词介绍"></a>分词介绍</h3><p>分词是指将文本转换成一系列单词( term or token )的过程,也可以叫做文本分析,在es里面称为Analysis</p><p><img src="/img/in-post/2019-03-13/3.png"></p><p>·分词器是es中专门处理分词的组件,英文为Analyzer ,它的组成如下<br>　　- Character Filters<br>　　　-针对原始文本进行处理,比如去除html特殊标记符<br>　　- Tokenizer<br>　　　-将原始文本按照一定规则切分为单词<br>　　- Token Filters<br>　　　-针对tokenizer处理的单词就行再加工,比如转小写、删除或新增等处理</p><p>分词调用顺序：</p><p><img src="/img/in-post/2019-03-13/4.png"></p><h4 id="analyze-api"><a href="#analyze-api" class="headerlink" title="analyze_api"></a>analyze_api</h4><p> es提供了一个测试分词的api接口,方便验证分词效果, endpoint是_analyze<br>　　-可以直接指定analyzer进行测试<br>　　-可以直接指定索引中的字段进行测试<br>　　-可以自定义分词器进行测试</p><p><img src="/img/in-post/2019-03-13/5.png"></p><p>关键词解释：</p><p>analyzer：分词器<br>text：分词文本<br>token：分词结果<br>start_offset：开始偏移位置<br>end_offset：结束偏移位置<br>position：分词位置</p><p>当没有定义analyzer的时候会使用默认分词器”analyzer”:”standard”</p><p>指定field分词：</p><p><img src="/img/in-post/2019-03-13/6.png"></p><p>自定义分词器：tokenizer指名要用哪个分词器，filter指明的是token filter：</p><p><img src="/img/in-post/2019-03-13/7.png"></p><h4 id="自带分词器"><a href="#自带分词器" class="headerlink" title="自带分词器"></a>自带分词器</h4><p>es自带如下的分词器<br>　　- Standard Simple<br>　　- Whitespace<br>　　- Stop<br>　　- Keyword<br>　　- Pattern<br>　　- Language</p><p><img src="/img/in-post/2019-03-13/8.png"><br><img src="/img/in-post/2019-03-13/9.png"><br><img src="/img/in-post/2019-03-13/10.png"><br><img src="/img/in-post/2019-03-13/11.png"><br><img src="/img/in-post/2019-03-13/12.png"><br><img src="/img/in-post/2019-03-13/13.png"></p><h4 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h4><p>·难点<br>　　-中文分词指的是将一个汉字序列切分成一个一个单独的词。在英文中,单词之间是以空格作为自然分界符,汉语中词没有一个形式上的分界符。<br>　　-上下文不同,分词结果迥异,比如交叉歧义问题,比如下面两种分词都合理<br>　　　　-乒乓球拍&#x2F;卖完了<br>　　　　-乒乓球&#x2F;拍卖&#x2F;完了</p><p>·常用分词系统<br>　　-IK<br>　　　　-实现中英文单词的切分,支持ik smart, ik maxword等模式<br>　　　　-可自定义词库,支持热更新分词词典,<br>　　　　- <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a><br>　　- jieba<br>　　　　-python中最流行的分词系统,支持分词和词性标注<br>　　　　-支持繁体分词、自定义词典、并行分词等<br>　　　　- <a target="_blank" rel="noopener" href="https://github.com/sing1ee/elasticsearch-jieba-plugin">https://github.com/sing1ee/elasticsearch-jieba-plugin</a><br>·基于自然语言处理的分词系统<br>　　- Hanlp<br>　　　　-由一系列模型与算法组成的Java工具包,目标是普及自然语言处理在生产环境中的应用<br>　　　　- <a target="_blank" rel="noopener" href="https://github.com/hankcs/HanLP">https://github.com/hankcs/HanLP</a><br>　　-THULAC<br>　　　　-THU Lexical Analyzer for Chinese ,由清华大学自然语言处理与社会人文计算实验室研制推出的一套中文词法分析工具包,具有中文分词和词性标注功能<br>　　　　- <a target="_blank" rel="noopener" href="https://github.com/microbun/elasticsearch-thulac-plugin">https://github.com/microbun/elasticsearch-thulac-plugin</a></p><h4 id="自定义分词"><a href="#自定义分词" class="headerlink" title="自定义分词"></a>自定义分词</h4><p>CharacterFilter：</p><p>当自带的分词无法满足需求时,可以自定义分词</p><ul><li>通过自定义Character Filters, Tokenizer和Token Filter实现. Character Filters</li><li>在Tokenizer之前对原始文本进行处理,比如增加、删除或替换字符等</li><li>自带的如下:<ul><li>HTML Strip去除html标签和转换html实体</li><li>Mapping进行字符替换操作</li><li>Pattern Replace进行正则匹配替换</li></ul></li><li>会影响后续tokenizer解析的postion和offset信息</li></ul><p> Character Filters测试时可以采用如下api :<br><img src="/img/in-post/2019-03-13/14.png"></p><p>Tokenizer：<br>Tokenizer</p><ul><li>将原始文本按照一定规则切分为单词( term or token )</li><li>自带的如下:<ul><li>standard按照单词进行分割</li><li>letter按照非字符类进行分割</li><li>whitespace按照空格进行分割</li><li>UAX URL Email按照standard分割,但不会分割邮箱和url</li><li>NGram和Edge NGram连词分割</li><li>Path Hierarchy按照文件路径进行切割</li></ul></li></ul><p>api:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;path_hierarchy&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;one/two/three&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;one&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;one/two&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;one/two/three&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>TokenFilter:<br>Token Filters</p><ul><li>对于tokenizer输出的单词( term )进行增加、删除、修改等操作</li><li>自带的如下:<ul><li>lowercase将所有term转换为小写</li><li>stop删除stop words</li><li>NGram和Edge NGram连词分割</li><li>Synonym添加近义词的term</li></ul></li></ul><p>api:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;a Hello, world!&quot;,</span><br><span class="line">  &quot;filter&quot;: [</span><br><span class="line">    &quot;stop&quot;,</span><br><span class="line">    &quot;lowercase&quot;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;ngram&quot;,</span><br><span class="line">      &quot;min_gram&quot;: 4,</span><br><span class="line">      &quot;max_gram&quot;: 4</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hell&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ello&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;worl&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;orld&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Custorm：<br>自定义分词需要在索引的配置中设定,如下所示:</p><p><img src="/img/in-post/2019-03-13/15.png"></p><p>创建自定义分词器：</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_custom_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;html_strip&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;lowercase&quot;,</span><br><span class="line">            &quot;asciifolding&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_index</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test_index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aliases&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;provided_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;creation_date&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1552462361614&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analysis&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;my_custom_analyzer&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;asciifolding&quot;</span></span><br><span class="line">              <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;char_filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;html_strip&quot;</span></span><br><span class="line">              <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;custom&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;tokenizer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;novqTjprQE24bJPdtxydCA&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;created&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6050099&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-13/16.png"></p><p>自定义分词验证：</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分词结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;this&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;is&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="分词使用说明"><a href="#分词使用说明" class="headerlink" title="分词使用说明"></a>分词使用说明</h4><p>分词会在如下两个时机使用:</p><ul><li>创建或更新文档时(Index Time ) ,会对相应的文档进行分词处理</li><li>查询时( Search Time ) ,会对查询语句进行分词</li></ul><h4 id="索引时分词"><a href="#索引时分词" class="headerlink" title="索引时分词"></a>索引时分词</h4><p>索引时分词是通过配置Index Mapping中每个字段的analyzer属性实现的如下：不指定分词时,使用默认standard</p><p><img src="/img/in-post/2019-03-13/17.png"></p><h4 id="查询时分词"><a href="#查询时分词" class="headerlink" title="查询时分词"></a>查询时分词</h4><p>查询时分词的指定方式有如下几种:</p><ul><li>查询的时候通过analyzer指定分词器</li><li>通过index mapping设置search_analyzer实现</li></ul><p><img src="/img/in-post/2019-03-13/18.png"></p><p>实例1：我们做一个查询，我们试图通过搜索 message2 这个关键词来搜索这个文档</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET test_index1/doc/1</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;this Is a Message&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;this Is a Message2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;message2&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;standard&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;message&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;this Is a Message2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>查询时使用自定义分词器</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index1</span><br><span class="line"></span><br><span class="line">PUT test_index1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_custom_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;html_strip&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;lowercase&quot;,</span><br><span class="line">            &quot;asciifolding&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;&lt;a&gt;this Is a &lt;b&gt;Message&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;&lt;a&gt;this Is a &lt;b&gt;Message2&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;Message2&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="分词建议"><a href="#分词建议" class="headerlink" title="分词建议"></a>分词建议</h4><ul><li>明确字段是否需要分词,不需要分词的字段就将type设置为keyword ,可以节省空间和提高写性能</li><li>善用_analyze API ,查看文档的具体分词结果</li><li>动手测试</li></ul><h3 id="分词使用分析"><a href="#分词使用分析" class="headerlink" title="分词使用分析"></a>分词使用分析</h3><p>创建自定义分词</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index</span><br><span class="line"></span><br><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_custom_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;html_strip&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;lowercase&quot;,</span><br><span class="line">            &quot;asciifolding&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>插入数据：</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分词检索：</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;&lt;div&gt;this is&lt;/div&gt;&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;message&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>为什么会返回这条记录，我们使用分词分析来分析原因：</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;this&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;is&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>由上面的结果看一看出我们自定义的分词将<code>&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;</code> 分成了this,is,a,text<br>分成这种结果的原因是分词使用了如下图的分词器<br><img src="/img/in-post/2019-03-13/16.png"></p><p>我们由前面的分词器的解释可了解到lowercase将元文本规范化为小写，asciifolding 类型的词元过滤器，将不在前127个ASCII字符（“基本拉丁文”Unicode块）中的字母，数字和符号Unicode字符转换为ASCII等效项（如果存在）。<br>html strip将文本的html标签进行了过滤，standard见上面的介绍，所以最终自定义分词分成了this,is,a,text这样的结果，而上面query里面的<code>&lt;div&gt;this is&lt;div&gt;</code>首先html标签被过滤掉，所以不管什么标签都可以满足条件，其次<br>this is用_analyze分析会被拆成this,is也符合分词匹配结果，如果query里面的this is变为thisis就不符合当前匹配结果了</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/03/05/2022-03-05-elastic/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/03/05/2022-03-05-elastic/" class="post-title-link" itemprop="url">Elasticsearch Index API</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-05 13:30:00" itemprop="dateCreated datePublished" datetime="2022-03-05T13:30:00+08:00">2022-03-05</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><h3 id="什么是文档"><a href="#什么是文档" class="headerlink" title="什么是文档"></a>什么是文档</h3><p>程序中大多的实体或对象能够被序列化为包含键值对的JSON对象，键(key)是字段(field)或属性(property)的名字，值(value)可以是字符串、数字、布尔类型、另一个对象、值数组或者其他特殊类型，比如表示日期的字符串或者表示地理位置的对象</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>         <span class="string">&quot;John Smith&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span>          <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;confirmed&quot;</span><span class="punctuation">:</span>    <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;join_date&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;2014-06-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;home&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span>      <span class="number">51.5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span>      <span class="number">0.1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;facebook&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;johnsmith&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;twitter&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;johnsmith&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>通常，我们可以认为对象(object)和文档(document)是等价相通的。不过，他们还是有所差别：对象(Object)是一个JSON结构体——类似于哈希、hashmap、字典或者关联数组；对象(Object)中还可能包含其他对象(Object)。 在Elasticsearch中，文档(document)这个术语有着特殊含义。它特指最顶层结构或者根对象(root object)序列化成的JSON数据（以唯一ID标识并存储于Elasticsearch中）。</p></blockquote><h3 id="归结"><a href="#归结" class="headerlink" title="归结"></a>归结</h3><ol><li><p>Json Object,由字段组成：</p><ul><li>字符串：text, keyword</li><li>数值型：long,integer,short,byte,double,float,half_float,scled_float</li><li>布尔：boolean</li><li>日期：date</li><li>二进制：binary</li><li>范围类型：integer_range,float_range,long_range,double_range,date_range</li></ul></li><li><p>每个文档有唯一的id标识</p><ul><li>自行指定</li><li>es生成</li></ul></li><li><p>元数据，用于标注文档的相关信息</p><ul><li>_index：文档所在的索引名</li><li>_type：文档所在的类型名</li><li>_id：文档唯一id</li><li>_uid：组合id,由_type和_id组成(6.x_type不再起作用，同_id一样)</li><li>_source：文档的原始Json数据，可以从这里获取每个字段的内容</li><li>_all：整合所有字段内容到该字段，默认禁用</li></ul></li></ol><h3 id="文档元数据"><a href="#文档元数据" class="headerlink" title="文档元数据"></a>文档元数据</h3><p>一个文档不只有数据。它还包含了元数据(metadata)——关于文档的信息。三个必须的元数据节点是：</p><table><thead><tr><th>节点</th><th>说明</th></tr></thead><tbody><tr><td>_index</td><td>文档存储的地方</td></tr><tr><td>_type</td><td>文档代表的对象的类</td></tr><tr><td>_id</td><td>文档的唯一标识</td></tr></tbody></table><p><strong>_index</strong></p><p>索引(index)类似于关系型数据库里的“数据库”——它是我们存储和索引关联数据的地方。</p><blockquote><p>事实上，我们的数据被存储和索引在分片(shards)中，索引只是一个把一个或多个分片分组在一起的逻辑空间。然而，这只是一些内部细节——我们的程序完全不用关心分片。对于我们的程序而言，文档存储在索引(index)中。剩下的细节由Elasticsearch关心既可。</p></blockquote><p><strong>_type</strong><br>在应用中，我们使用对象表示一些“事物”，例如一个用户、一篇博客、一个评论，或者一封邮件。每个对象都属于一个类(class)，这个类定义了属性或与对象关联的数据。user类的对象可能包含姓名、性别、年龄和Email地址。<br>在关系型数据库中，我们经常将相同类的对象存储在一个表里，因为它们有着相同的结构。同理，在Elasticsearch中，我们使用相同类型(type)的文档表示相同的“事物”，因为他们的数据结构也是相同的。<br>每个类型(type)都有自己的映射(mapping)或者结构定义，就像传统数据库表中的列一样。所有类型下的文档被存储在同一个索引下，但是类型的映射(mapping)会告诉Elasticsearch不同的文档如何被索引。</p><blockquote><p>在7.0前，一个index可以设置多个type,在7.0后type统一为_doc</p></blockquote><p><strong>_id</strong></p><p>id仅仅是一个字符串，它与_index和_type组合时，就可以在Elasticsearch中唯一标识一个文档。当创建一个文档，你可以自定义_id，也可以让Elasticsearch帮你自动生成。</p><h2 id="Index-Api"><a href="#Index-Api" class="headerlink" title="Index Api"></a>Index Api</h2><p>以下操作均在es7.2版本操作</p><h3 id="Index-createorupdate"><a href="#Index-createorupdate" class="headerlink" title="Index(createorupdate)"></a>Index(createorupdate)</h3><p>PUT {_index}&#x2F;{_type}&#x2F;{_id}<br>POST {_index}&#x2F;{_type}&#x2F;{_id}(id可不指定)</p><p>创建一个索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br></pre></td></tr></table></figure><p>创建一个索引并指定文档内容和id</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;alfred&quot;,</span><br><span class="line">  &quot;age&quot;:1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建一个索引指定文档内容自动生成id</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;lili&quot;,</span><br><span class="line">  &quot;age&quot;:22</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文档不存在执行的是创建操作，存在的话回变为更新操作，并且_version会增加1</p><h3 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h3><p>有两种方式:</p><p>第一种方法使用op_type查询参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1?op_type=create</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;alfred&quot;,</span><br><span class="line">  &quot;age&quot;:1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者第二种方法是在URL后加&#x2F;_create做为端点：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1/_create</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;alfred&quot;,</span><br><span class="line">  &quot;age&quot;:1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果请求成功的创建了一个新文档，Elasticsearch将返回正常的元数据且响应状态码是201 Created。<br>另一方面，如果包含相同的_index、_type和_id的文档已经存在，Elasticsearch将返回409 Conflict响应状态码，错误信息类似如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [6])&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vENoH2YDQRiFHvu_pfzDcg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [6])&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vENoH2YDQRiFHvu_pfzDcg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">409</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>POST和PUT的区别是POST不用加具体的id，它是作用在一个集合资源之上的（&#x2F;uri），而PUT操作是作用在一个具体资源之上的（&#x2F;uri&#x2F;xxx）。<br>在ES中，如果不确定document的ID（documents具体含义见下），那么直接POST对应uri（ “POST &#x2F;website&#x2F;blog” ），ES可以自己生成不会发生碰撞的UUID；<br>如果确定document的ID，比如 “PUT &#x2F;website&#x2F;blog&#x2F;123”，那么执行创建或修改（修改时_version版本号提高1）</p></blockquote><h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;hobby&quot;: &quot;hit&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index</span><br></pre></td></tr></table></figure><h3 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h3><p>获取所有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_search</span><br></pre></td></tr></table></figure><p>指定id</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/1</span><br></pre></td></tr></table></figure><p>归结</p><table><thead><tr><th>操作</th><th>请求</th></tr></thead><tbody><tr><td>Create</td><td>PUT &#x2F;test_index&#x2F;_doc&#x2F;1&#x2F;_create<br>{“username”:”alfred”,”age”:1}<br>POST &#x2F;test_index&#x2F;_doc&#x2F;<br>{“username”:”alfred”,”age”:1}(不指定id自动生成)</td></tr><tr><td>Index</td><td>PUT Or POST &#x2F;test_index&#x2F;_doc&#x2F;1&#x2F;<br>{“username”:”alfred”,”age”:1}</td></tr><tr><td>Read</td><td>GET &#x2F;test_index&#x2F;_doc&#x2F;1</td></tr><tr><td>Update</td><td>POST &#x2F;test_index&#x2F;_update&#x2F;1<br>{“doc”: {“sex”: “女”}}</td></tr><tr><td>Delete</td><td>DELETE test_index2</td></tr></tbody></table><blockquote><p>Index和Update<br>Index实际上是文档不存在会创建一个文档，存在则会删除原来的文档，新的文档被索引，并且version加1<br>Update不会删除原来的文档，实现真正的更新，POST方法的payload需包含在”doc”里</p></blockquote><h3 id="Bulk"><a href="#Bulk" class="headerlink" title="Bulk"></a>Bulk</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;test_index&quot;,&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;username&quot;:&quot;alfred&quot;,&quot;age&quot;:20&#125;</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;test_index&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_id&quot;:&quot;2&quot;,&quot;_index&quot;:&quot;test_index&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;age&quot;:&quot;20&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="批量查询api"><a href="#批量查询api" class="headerlink" title="批量查询api"></a>批量查询api</h3><p>es允许一次查询多个文档，如果你需要从Elasticsearch中检索多个文档，相对于一个一个的检索，更快的方式是在一个请求中使用multi-get或者mget API。</p><p>mget API参数是一个docs数组，数组的每个节点定义一个文档的_index、_type、_id元数据。如果你只想检索一个或几个确定的字段，也可以定义一个_source参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST _mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 1,</span><br><span class="line">      &quot;_index&quot;:&quot;test_index&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 2,</span><br><span class="line">      &quot;_index&quot;:&quot;test_index&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>响应体也包含一个docs数组，每个文档还包含一个响应，它们按照请求定义的顺序排列。每个这样的响应与单独使用get request响应体相同：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;lili&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;john&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;40&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>如果你想检索的文档在同一个_index中，你就可以在URL中定义一个默认的&#x2F;_index。<br>你依旧可以在单独的请求中使用这些值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc/_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123; &quot;_id&quot; : 2 &#125;,</span><br><span class="line">      &#123; &quot;_id&quot; : 1 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在7.0以上版本后，_doc在mget中可以省略，不省略会提示#! Deprecation: [types removal] Specifying types in multi get requests is deprecated.</p></blockquote><p>事实上，如果所有文档具有相同_index，你可以通过简单的ids数组来代替完整的docs数组：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;ids&quot; : [ &quot;4&quot;, &quot;1&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不存在的文档会显示found:false</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;lili&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>尽管前面提到有一个文档没有被找到，但HTTP请求状态码还是200。事实上，就算所有文档都找不到，请求也还是返回200，原因是mget请求本身成功了。如果想知道每个文档是否都成功了，你需要检查found标志。</p></blockquote></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/02/24/2022-02-24-mysql(1)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/02/24/2022-02-24-mysql(1)/" class="post-title-link" itemprop="url">Mysql锁</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-02-24 22:30:00" itemprop="dateCreated datePublished" datetime="2022-02-24T22:30:00+08:00">2022-02-24</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><h3 id="事物隔离场景"><a href="#事物隔离场景" class="headerlink" title="事物隔离场景"></a>事物隔离场景</h3><p>repeatable-read</p><h3 id="表语句准备"><a href="#表语句准备" class="headerlink" title="表语句准备"></a>表语句准备</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `c` (`c`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>),(<span class="number">15</span>,<span class="number">15</span>,<span class="number">15</span>),(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),(<span class="number">25</span>,<span class="number">25</span>,<span class="number">25</span>);</span><br></pre></td></tr></table></figure><p>先假设一个没有堵塞的场景：</p><table><thead><tr><th></th><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>T1</td><td>begin;<br>select * from t where d&#x3D;5 for update;<br><font color="red">result:(5,5,5)</font></td><td></td><td></td></tr><tr><td>T2</td><td></td><td>update t set d&#x3D;5 where id&#x3D;0;</td><td></td></tr><tr><td>T3</td><td>select * from t where d&#x3D;5 for update;<br><font color="red">result:(0,0,5)(5,5,5)</font></td><td></td><td></td></tr><tr><td>T4</td><td></td><td></td><td>insert into t values(1,1,5);</td></tr><tr><td>T5</td><td>select * from t where d&#x3D;5 for update;<br><font color="red">result:(0,0,5)(1,1,5)(5,5,5)</font></td><td></td><td></td></tr><tr><td>T6</td><td>commit;</td><td></td><td></td></tr></tbody></table><p>可以看到，session A 里执行了三次查询，分别是 Q1、Q2 和 Q3。它们的 SQL 语句相同，都是 select * from t where d&#x3D;5 for update。查所有 d&#x3D;5 的行，而且使用的是当前读，并且加上写锁。现在，我们来看一下这三条 SQL 语句，分别会返回什么结果。</p><ol><li>Q1 只返回 id&#x3D;5 这一行；</li><li>在 T2 时刻，session B 把 id&#x3D;0 这一行的 d 值改成了 5，因此 T3 时刻 Q2 查出来的是 id&#x3D;0 和 id&#x3D;5 这两行；</li><li>在 T4 时刻，session C 又插入一行（1,1,5），因此 T5 时刻 Q3 查出来的是 id&#x3D;0、id&#x3D;1 和 id&#x3D;5 的这三行。</li></ol><p>其中，Q3 读到 id&#x3D;1 这一行的现象，被称为“幻读”。也就是说，幻读指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行。</p><h2 id="Mysql如何解决幻读"><a href="#Mysql如何解决幻读" class="headerlink" title="Mysql如何解决幻读"></a>Mysql如何解决幻读</h2><h3 id="本片需要用到的两种锁"><a href="#本片需要用到的两种锁" class="headerlink" title="本片需要用到的两种锁"></a>本片需要用到的两种锁</h3><p>LOCK IN SHARE MODE是读锁(只是不让别人写)，FOR UPDATE是写锁(还不让别人加读锁)</p><h3 id="InnoDB行锁"><a href="#InnoDB行锁" class="headerlink" title="InnoDB行锁"></a>InnoDB行锁</h3><p>InnoDB行锁是通过索引上的索引项来实现的，InnoDB这种行锁实现特点意味者：只有通过索引条件检索数据，InnoDB才会使用行级锁，否则，InnoDB将使用表锁！<br>如<code>select * from t where d=5 for update;</code>会锁住d&#x3D;5索引覆盖范围的相关行，如果没有索引则会锁住所有行</p><h3 id="间隙锁-Gap-Lock"><a href="#间隙锁-Gap-Lock" class="headerlink" title="间隙锁 (Gap Lock)"></a>间隙锁 (Gap Lock)</h3><p>行锁只能锁住行，但是新插入记录这个动作，要更新的是记录之间的“间隙”。因此，为了解决幻读问题，InnoDB 只好引入新的锁，也就是间隙锁 (Gap Lock)。<br>间隙锁，锁的就是两个值之间的空隙。比如文章开头的表 t，初始化插入了 6 个记录，这就产生了 7 个间隙。<br>这样，当你执行 select * from t where d&#x3D;5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。</p><h3 id="行锁和间隙锁比较"><a href="#行锁和间隙锁比较" class="headerlink" title="行锁和间隙锁比较"></a>行锁和间隙锁比较</h3><p>行锁，分成读锁和写锁。下图就是这两种类型行锁的冲突关系。</p><table><thead><tr><th></th><th>读锁</th><th>写锁</th></tr></thead><tbody><tr><td>读锁</td><td><font color="green">兼容</font></td><td><font color="red">冲突</font></td></tr><tr><td>写锁</td><td><font color="red">冲突</font></td><td><font color="red">冲突</font></td></tr></tbody></table><p>也就是说，跟行锁有冲突关系的是“另外一个行锁”。<br>但是间隙锁不一样，<strong>跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。</strong>间隙锁之间都不存在冲突关系。</p><table><thead><tr><th>SessionA</th><th>SessionB</th></tr></thead><tbody><tr><td>begin;<br>select * from t where c&#x3D;7 lock in share mode;</td><td></td></tr><tr><td></td><td>begin;<br>select * from t where c&#x3D;7 for update;</td></tr></tbody></table><p>这里 session B 并不会被堵住。因为表 t 里并没有 c&#x3D;7 这个记录，因此 session A 加的是间隙锁 (5,10)。而 session B 也是在这个间隙加的间隙锁。它们有共同的目标，即：保护这个间隙，不允许插入值。但，它们之间是不冲突的。</p><p>间隙锁和行锁合称 next-key lock，每个 next-key lock 是前开后闭区间。也就是说，我们的表 t 初始化以后，如果用 select * from t for update 要把整个表所有记录锁起来，就形成了 7 个 next-key lock，分别是 (-∞,0]、(0,5]、(5,10]、(10,15]、(15,20]、(20, 25]、(25, +supremum]。</p><p><strong>间隙锁和 next-key lock 的引入，帮我们解决了幻读的问题，但同时也带来了一些“困扰”。</strong></p><p>看下面的实例</p><table><thead><tr><th>SessionA</th><th>SessionB</th></tr></thead><tbody><tr><td>begin;<br>select * from t where id&#x3D;9 for update;</td><td></td></tr><tr><td></td><td>begin;<br>select * from t where id&#x3D;9 for update;</td></tr><tr><td></td><td>insert into t values(9,9,9);<br><font color="red">result:(blocked)</font></td></tr><tr><td>insert into t values(9,9,9);<br><font color="red">result:(Deadlock)</font></td><td></td></tr></tbody></table><p>上面的场景形成死锁了。我们按语句执行顺序来分析一下：</p><ol><li>session A 执行 select … for update 语句，由于 id&#x3D;9 这一行并不存在，因此会加上间隙锁 (5,10);</li><li>session B 执行 select … for update 语句，同样会加上间隙锁 (5,10)，间隙锁之间不会冲突，因此这个语句可以执行成功；</li><li>session B 试图插入一行 (9,9,9)，被 session A 的间隙锁挡住了，只好进入等待；</li><li>session A 试图插入一行 (9,9,9)，被 session B 的间隙锁挡住了。</li></ol><p>至此，两个 session 进入互相等待状态，形成死锁。当然，InnoDB 的死锁检测马上就发现了这对死锁关系，让 session A 的 insert 语句报错返回了。</p><h2 id="mysql锁类型"><a href="#mysql锁类型" class="headerlink" title="mysql锁类型"></a>mysql锁类型</h2><p>锁规则里面，包含了两个“原则”、两个“优化”和一个“bug”。</p><blockquote><p>MySQL 后面的版本可能会改变加锁策略，所以这个规则只限于截止到现在的最新版本，即 5.x 系列 &lt;&#x3D;5.7.24，8.0 系列 &lt;&#x3D;8.0.13。</p></blockquote><p>原则 1：加锁的基本单位是 next-key lock。希望你还记得，next-key lock 是前开后闭区间。<br>原则 2：查找过程中访问到的对象才会加锁。<br>优化 1：索引上的等值查询，给唯一索引加锁的时候，next-key lock 退化为行锁。<br>优化 2：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁。<br>一个特殊场景：唯一索引上的范围查询会访问到不满足条件的第一个值为止。</p><h3 id="等值查询间隙锁"><a href="#等值查询间隙锁" class="headerlink" title="等值查询间隙锁"></a>等值查询间隙锁</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>update t set d&#x3D;d+1 where id&#x3D;7;</td><td></td><td></td></tr><tr><td></td><td>insert into t values(8,8,8);<br><font color="red">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>update t set d&#x3D;d+1 where id&#x3D;10;<br><font color="green">result:(ok)</font></td></tr></tbody></table><p>由于表 t 中没有 id&#x3D;7 的记录，所以用我们上面提到的加锁规则判断一下的话：</p><ol><li>根据原则 1，加锁单位是 next-key lock，session A 加锁范围就是 (5,10]；</li><li>同时根据优化 2，这是一个等值查询 (id&#x3D;7)，而 id&#x3D;10 不满足查询条件，next-key lock 退化成间隙锁，因此最终加锁的范围是 (5,10)。</li></ol><p>所以，session B 要往这个间隙里面插入 id&#x3D;8 的记录会被锁住，但是 session C 修改 id&#x3D;10 这行是可以的。</p><h3 id="非唯一索引等值锁"><a href="#非唯一索引等值锁" class="headerlink" title="非唯一索引等值锁"></a>非唯一索引等值锁</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select id from t where c&#x3D;5 lock in share mode(读锁);</td><td></td><td></td></tr><tr><td></td><td>update t set d&#x3D;d+1 where id&#x3D;5;<br><font color="green">result:(ok)</font></td><td></td></tr><tr><td></td><td></td><td>insert into t values(7,7,7);<br><font color="red">result:(blocked)</font></td></tr></tbody></table><p>看到这个例子，你是不是有一种“该锁的不锁，不该锁的乱锁”的感觉？我们来分析一下吧。</p><ol><li>根据原则 1，加锁单位是 next-key lock，因此会给 (0,5] 加上 next-key lock。</li><li>要注意 c 是普通索引，因此仅访问 c&#x3D;5 这一条记录是不能马上停下来的，需要向右遍历，查到 c&#x3D;10 才放弃。根据原则 2，访问到的都要加锁，因此要给 (5,10] 加 next-key lock。</li><li>但是同时这个符合优化 2：等值判断，向右遍历，最后一个值不满足 c&#x3D;5 这个等值条件，因此退化成间隙锁 (5,10)。</li><li>根据原则 2 ，<strong>只有访问到的对象才会加锁</strong>，这个查询使用覆盖索引，并不需要访问主键索引，所以主键索引上没有加任何锁，这就是为什么 session B 的 update 语句可以执行完成。</li></ol><p>但 session C 要插入一个 (7,7,7) 的记录，就会被 session A 的间隙锁 (5,10) 锁住。</p><blockquote><p>需要注意，在这个例子中，lock in share mode 只锁覆盖索引，但是如果是 for update 就不一样了。 执行 for update 时，系统会认为你接下来要更新数据，因此会顺便给主键索引上满足条件的行加上行锁。</p></blockquote><p>这个例子说明，锁是加在索引上的；同时，它给我们的指导是，如果你要用 lock in share mode 来给行加读锁避免数据被更新的话，就必须得绕过覆盖索引的优化，在查询字段中加入索引中不存在的字段。比如，将 session A 的查询语句改成 select d from t where c&#x3D;5 lock in share mode。</p><h3 id="主键索引范围锁"><a href="#主键索引范围锁" class="headerlink" title="主键索引范围锁"></a>主键索引范围锁</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select * from t where id &gt;&#x3D;10 and id&lt;11 for update;</td><td></td><td></td></tr><tr><td></td><td>insert into t values(7,7,7);<br><font color="green">result:(ok)</font><br>insert into t values(13,13,13);<br><font color="red">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>update t set d&#x3D;d+1 where id&#x3D;15;<br><font color="red">result:(blocked)</font></td></tr></tbody></table><ol><li>开始执行的时候，要找到第一个 id&#x3D;10 的行，因此本该是 next-key lock(5,10]。 根据优化 1， 主键 id 上的等值条件，退化成行锁，只加了 id&#x3D;10 这一行的行锁。</li><li>范围查找就往后继续找，找到 id&#x3D;15 这一行停下来，因此需要加 next-key lock(10,15]。</li></ol><p>所以，session A 这时候锁的范围就是主键索引上，行锁 id&#x3D;10 和 next-key lock(10,15]。</p><h3 id="非唯一索引范围锁"><a href="#非唯一索引范围锁" class="headerlink" title="非唯一索引范围锁"></a>非唯一索引范围锁</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select * from t where c&gt;10 and c&lt;11 for update;</td><td></td><td></td></tr><tr><td></td><td>insert into t values(8,8,8);<br><font color="red">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>update t set d&#x3D;d+1 where id&#x3D;15;<br><font color="red">result:(blocked)</font></td></tr></tbody></table><p>这次 session A 用字段 c 来判断，加锁规则跟主键索引范围锁唯一的不同是：在第一次用 c&#x3D;10 定位记录的时候，索引 c 上加了 (5,10] 这个 next-key lock 后，由于索引 c 是非唯一索引，没有优化规则，也就是说不会蜕变为行锁，因此最终 sesion A 加的锁是，索引 c 上的 (5,10] 和 (10,15] 这两个 next-key lock。</p><h3 id="唯一索引范围锁特殊场景"><a href="#唯一索引范围锁特殊场景" class="headerlink" title="唯一索引范围锁特殊场景"></a>唯一索引范围锁特殊场景</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select * from t where id &gt;10 and id&lt;&#x3D;15 for update;</td><td></td><td></td></tr><tr><td></td><td>update t set d&#x3D;d+1 where id&#x3D;20;<br><font color="green">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>insert into t values(16,16,16);<br><font color="red">result:(blocked)</font></td></tr></tbody></table><p>session A 是一个范围查询，按照原则 1 的话，应该是索引 id 上只加 (10,15] 这个 next-key lock，并且因为 id 是唯一键，所以循环判断到 id&#x3D;15 这一行就应该停止了。<br>但是实现上，InnoDB 会往前扫描到第一个不满足条件的行为止，也就是 id&#x3D;20。而且由于这是个范围扫描，因此索引 id 上的 (15,20] 这个 next-key lock也会被锁上。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/01/20/2023-01-20-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E7%AE%97%E6%B3%95%E5%85%A5%E9%97%A8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/01/20/2023-01-20-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E7%AE%97%E6%B3%95%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">动态规划基础算法分析</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-01-20 19:30:00" itemprop="dateCreated datePublished" datetime="2022-01-20T19:30:00+08:00">2022-01-20</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="什么是动态规划"><a href="#什么是动态规划" class="headerlink" title="什么是动态规划"></a>什么是动态规划</h2><p>动态规划，英文:Dynamic Programming，简称DP，如果某一问题有很多重叠子问题，使 用动态规划是最有效的。</p><h2 id="动态规划的解题步骤"><a href="#动态规划的解题步骤" class="headerlink" title="动态规划的解题步骤"></a>动态规划的解题步骤</h2><p>结合自己之前的经历分析，做动规题目的时候，只是把递归推导公式推出来就拉到了，然后就开始解题，提交题目的时候经常发现解题总是会出现一些细节问题，比如dp数组初始化不对，或者遍历的数组对象有问题等等…甚至很多时候把题目AC之后，都不太清楚dp[i]表示的是什么。<br>这就是一种朦胧的状态，然后就把题给过了，遇到稍稍难一点的，可能直接就不会了，然后 看题解，然后继续照葫芦画瓢陷入这种恶性循环中。<br>最近看了<a target="_blank" rel="noopener" href="https://github.com/youngyangyang04">Carl</a>的动态规划分析专栏，对这套算法体系有了一定的理解，并对解题思路进行了总结</p><p>对于动态规划问题，可拆解为如下五步曲，这五步都搞清楚了，才能说把动态规划真的掌握了!</p><ol><li>确定dp数组(dp table)以及下标的含义</li><li>确定递推公式</li><li>dp数组如何初始化</li><li>确定遍历顺序</li><li>举例推导dp数组</li></ol><h2 id="动态规划入门题目分析"><a href="#动态规划入门题目分析" class="headerlink" title="动态规划入门题目分析"></a>动态规划入门题目分析</h2><h3 id="斐波那契数列"><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h3><p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/fibonacci-number/">斐波那契数</a><br>通常用 F(n) 表示，形成的序列称为 斐波那契数列 。该数列由 0 和 1 开始，后 面的每一项数字都是前面两项数字的和。也就是:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">F(0) = 0，F(1) = 1</span><br><span class="line">F(n) = F(n - 1) + F(n - 2)，其中 n &gt; 1</span><br></pre></td></tr></table></figure><p>给你n ，请计算 F(n) 。</p><p>示例 1:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入:2</span><br><span class="line">输出:1</span><br><span class="line">解释:F(2) = F(1) + F(0) = 1 + 0 = 1</span><br></pre></td></tr></table></figure><p>示例 2:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入:3 输出:2</span><br><span class="line">解释:F(3) = F(2) + F(1) = 1 + 1 = 2</span><br></pre></td></tr></table></figure><p>示例 3:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入:4</span><br><span class="line">输出:3</span><br><span class="line">解释:F(4) = F(3) + F(2) = 2 + 1 = 3</span><br></pre></td></tr></table></figure><p>提示:<code>0 &lt;= n &lt;= 30</code></p><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>这道题比较简单，题目中已经给出了递推公式，所以不需要分析，直接实现即可</p><h4 id="dp5部曲"><a href="#dp5部曲" class="headerlink" title="dp5部曲"></a>dp5部曲</h4><p>按照动态规划5部曲进行分析</p><ol><li>确定dp数组以及下标的含义：表示第i个数的斐波那契数值dp<code>[i]</code></li><li>确定递推公式 <code>dp[i] = dp[i - 1] + dp[i - 2]</code></li><li>dp数组如何初始化 <code>dp[0] = 0</code>, <code>dp[1] = 1</code></li><li>确定遍历顺序 由于要保证第i个数的值为前两个数的和，所以要正向遍历</li><li>举例推导dp数组 打印dp数组应该是1,1,2,3,5,8,13,21…</li></ol><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fib</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dp = <span class="built_in">make</span>([]<span class="type">int</span>, n+<span class="number">1</span>)</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    dp[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span>; i &lt;= n; i++ &#123;</span><br><span class="line">        dp[i] = dp[i<span class="number">-1</span>] + dp[i<span class="number">-2</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度O(n)</li><li>空间复杂度O(n)</li></ul><blockquote><p>动态规划题目一般往往可以优化空间复杂度，本道题也一样，可以将<code>dp[0]</code>、<code>dp[1]</code>作为两个变量值指针，然后用sum接收一下两个变量的和，在对dp[0]、dp[1]进行前移<code>dp[0] = dp[1]</code>,<code>dp[1] = sum</code></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fib</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dp, sum = [<span class="number">2</span>]<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">2</span>; i &lt;= n; i++ &#123;</span><br><span class="line">        sum = dp[<span class="number">0</span>] + dp[<span class="number">1</span>]</span><br><span class="line">		dp[<span class="number">0</span>] = dp[<span class="number">1</span>]</span><br><span class="line">		dp[<span class="number">1</span>] = sum</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度O(n)</li><li>空间复杂度O(1)</li></ul><h3 id="爬楼梯"><a href="#爬楼梯" class="headerlink" title="爬楼梯"></a>爬楼梯</h3><p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/climbing-stairs/">爬楼梯</a><br>假设你正在爬楼梯。需要 n 阶你才能到达楼顶。</p><p>每次你可以爬 1 或 2 个台阶。你有多少种不同的方法可以爬到楼顶呢？</p><p>示例 1：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">输入：n = 2</span><br><span class="line">输出：2</span><br><span class="line">解释：有两种方法可以爬到楼顶。</span><br><span class="line">1. 1 阶 + 1 阶</span><br><span class="line">2. 2 阶</span><br></pre></td></tr></table></figure><p>示例 2：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">输入：n = 3</span><br><span class="line">输出：3</span><br><span class="line">解释：有三种方法可以爬到楼顶。</span><br><span class="line">1. 1 阶 + 1 阶 + 1 阶</span><br><span class="line">2. 1 阶 + 2 阶</span><br><span class="line">3. 2 阶 + 1 阶</span><br></pre></td></tr></table></figure><p>提示：<br><code>1 &lt;= n &lt;= 45</code></p><h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>爬到第一层楼梯有一种方法，爬到二层楼梯有两种方法。</p><p>那么第一层楼梯再跨两步就到第三层 ，第二层楼梯再跨一步就到第三层。</p><p>所以到第三层楼梯的状态可以由第二层楼梯 和 到第一层楼梯状态推导出来，那么就可以想 到动态规划了。</p><h4 id="dp5部曲-1"><a href="#dp5部曲-1" class="headerlink" title="dp5部曲"></a>dp5部曲</h4><p>动态规划5步</p><ol><li>确定dp数组以及下标的含义：表示爬到第n阶有<code>dp[n]</code>种爬法的</li><li>确定递推公式<br>首先是<code>dp[i - 1]</code>，上<code>i-1</code>层楼梯，有<code>dp[i - 1]</code>种方法，那么再一步跳一个台阶不就是<code>dp[i]</code>了<br>么。<br>还有就是<code>dp[i - 2]</code>，上<code>i-2</code>层楼梯，有<code>dp[i - 2]</code>种方法，那么再一步跳两个台阶不就是<code>dp[i]</code>了 么。<br>那么<code>dp[i]</code>就是 <code>dp[i - 1]</code>与<code>dp[i - 2]</code>之和!<br>所以<code>dp[i] = dp[i - 1] + dp[i - 2]</code> 。</li><li>dp数组如何初始化 <code>dp[0] = 1, dp[1] = 1, dp[2] = 2</code></li><li>确定遍历顺序 从递推公式<code>dp[i] = dp[i - 1] + dp[i - 2]</code>;中可以看出，遍历顺序一定是从前向后遍历的</li><li>举例推导dp数组 打印dp数组应该是1,2,3,5,8</li></ol><p>通过dp5步分析后，得知这道题其实就是实现斐波那契数列，题目立马变得清晰了，这也是动态规划分析的重要性!</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ClimbStairs</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> n == <span class="number">1</span> || n == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> n == <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> dp [<span class="number">3</span>]<span class="type">int</span></span><br><span class="line">	dp[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">	dp[<span class="number">2</span>] = <span class="number">2</span></span><br><span class="line">	sum := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">3</span>; i &lt;= n; i++ &#123;</span><br><span class="line">		sum = dp[<span class="number">1</span>] + dp[<span class="number">2</span>]</span><br><span class="line">		dp[<span class="number">1</span>] = dp[<span class="number">2</span>]</span><br><span class="line">		dp[<span class="number">2</span>] = sum</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度O(n)</li><li>空间复杂度O(1)</li></ul><h3 id="使用最小花费爬楼梯"><a href="#使用最小花费爬楼梯" class="headerlink" title="使用最小花费爬楼梯"></a>使用最小花费爬楼梯</h3><p><a target="_blank" rel="noopener" href="https://leetcode-cn.com/problems/min-cost-climbing-stairs/">使用最小花费爬楼梯</a><br>数组的每个下标作为一个阶梯，第 i 个阶梯对应着一个非负数的体力花费值 <code>cost[i]</code>(下标从 0 开始)。</p><p>每当你爬上一个阶梯你都要花费对应的体力值，一旦支付了相应的体力值，你就可以选择向 上爬一个阶梯或者爬两个阶梯。</p><p>请你找出达到楼层顶部的最低花费。在开始时，你可以选择从下标为 0 或 1 的元素作为初始阶梯。</p><p>示例 1：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">输入：cost = [10,15,20]</span><br><span class="line">输出：15</span><br><span class="line">解释：你将从下标为 1 的台阶开始。</span><br><span class="line">- 支付 15 ，向上爬两个台阶，到达楼梯顶部。</span><br><span class="line">  总花费为 15 。</span><br></pre></td></tr></table></figure><p>示例 2：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">输入：cost = [1,100,1,1,1,100,1,1,100,1]</span><br><span class="line">输出：6</span><br><span class="line">解释：你将从下标为 0 的台阶开始。</span><br><span class="line">- 支付 1 ，向上爬两个台阶，到达下标为 2 的台阶。</span><br><span class="line">- 支付 1 ，向上爬两个台阶，到达下标为 4 的台阶。</span><br><span class="line">- 支付 1 ，向上爬两个台阶，到达下标为 6 的台阶。</span><br><span class="line">- 支付 1 ，向上爬一个台阶，到达下标为 7 的台阶。</span><br><span class="line">- 支付 1 ，向上爬两个台阶，到达下标为 9 的台阶。</span><br><span class="line">- 支付 1 ，向上爬一个台阶，到达楼梯顶部。</span><br><span class="line">  总花费为 6 。</span><br></pre></td></tr></table></figure><p>提示：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2 &lt;= cost.length &lt;= 1000</span><br><span class="line">0 &lt;= cost[i] &lt;= 999</span><br></pre></td></tr></table></figure><h4 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h4><p>这道题目可以说是昨天动态规划:爬楼梯的花费版本。 注意题目描述:每当你爬上一个阶梯你都要花费对应的体力值，一旦支付了相应的体力值，</p><p>你就可以选择向上爬一个阶梯或者爬两个阶梯</p><p>所以示例1中只花费一个15 就可以到阶梯顶，最后一步可以理解为 不用花费。</p><p><img src="/img/in-post/2023-01-20/img.png" alt="img.png"></p><h4 id="dp五部曲"><a href="#dp五部曲" class="headerlink" title="dp五部曲"></a>dp五部曲</h4><p>动态规划5步</p><p>cost &#x3D; <code>[0：10,1：15,2：20]</code></p><ol><li>确定dp数组以及下标的含义：<code>dp[i]</code>到达第i个台阶(顶层)的最小花费</li><li>确定递推公式<br>由题目可知，最小花费方案分为从第i-1阶走1步，或者从第i-2阶走2步到达两种方案<br>而不管选那种方案，由于最后一步一定要走，只不过选择的方案不同，所以，我的<code>dp[i]</code>都要固定花费<code>cost[i]</code><br>所以<code>dp[i] = dp[i-1] + cost[i -1]</code>或者<code>dp[i] = dp[i-2] + cost[i - 2]</code><br>最后的最小花费为<code>dp[i] = min(dp[i-1] + cost[i -1], dp[i-2] + cost[i - 2]) + 0</code><br>可得出爬i阶楼梯的最小花费为倒数第一步和倒数第二步的最小值 + 最后一步花费的费用<br><code>dp[i] = min(dp[i - 1], dp[i -2]) + cost[i]</code></li><li>dp数组如何初始化<br>那么看一下递归公式，<code>dp[i]</code>由<code>dp[i-1]，dp[i-2]</code>推出，既然初始化所有的<code>dp[i]</code>是不可能的，<br>那么只初始化<code>dp[0]</code>和<code>dp[1]</code>就够了，其他的最终都是<code>dp[0]dp[1]</code>推出。</li><li>确定遍历顺序 从递推公式<code>dp[i]</code>由<code>dp[i - 1]</code>和<code>dp[i - 2]</code>推导出的，所以遍历顺序一定是从前向后遍历的</li><li>举例推导dp数组 题目中打印dp数组应该是<br>题目中共有3阶<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dp[0] = 0 + cost[0] = 10</span><br><span class="line">dp[1] = 0 + cost[1] = 15</span><br><span class="line">dp[2] = min(dp[1], dp[0]) + cost[2] = 30</span><br><span class="line">dp[3] = min(dp[2], dp[1]) + cost[3] = 15 // cost[3] = 0</span><br></pre></td></tr></table></figure> <code>dp[3]</code>为我们最后返回的结果</li></ol><h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MinCostClimbingStairs</span><span class="params">(cost []<span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> dp = <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(cost))</span><br><span class="line">	dp[<span class="number">0</span>] = <span class="number">0</span> + cost[<span class="number">0</span>]</span><br><span class="line">	dp[<span class="number">1</span>] = <span class="number">0</span> + cost[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="built_in">len</span>(cost); i++ &#123;</span><br><span class="line">		dp[i] = min(dp[i<span class="number">-1</span>], dp[i<span class="number">-2</span>]) + cost[i]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 这里实际上是dp[3] = min(dp[2], dp[1]) + cost[3] = 15, cost[3]=0所以被我们省略了</span></span><br><span class="line">	<span class="keyword">return</span> min(dp[<span class="built_in">len</span>(cost)<span class="number">-1</span>], dp[<span class="built_in">len</span>(cost)<span class="number">-2</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">min</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> a &lt; b &#123;</span><br><span class="line">		<span class="keyword">return</span> a</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>时间复杂度O(n)</li><li>空间复杂度O(n)<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MinCostClimbingStairsPlus</span><span class="params">(cost []<span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">   <span class="keyword">var</span> dp0 = <span class="number">0</span> + cost[<span class="number">0</span>]</span><br><span class="line">   <span class="keyword">var</span> dp1 = <span class="number">0</span> + cost[<span class="number">1</span>]</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">2</span>; i &lt; <span class="built_in">len</span>(cost); i++ &#123;</span><br><span class="line">      dpi := min(dp0, dp1) + cost[i]</span><br><span class="line">      dp0 = dp1</span><br><span class="line">      dp1 = dpi</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> min(dp0, dp1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>优化空间复杂度后</p><ul><li>时间复杂度O(n)</li><li>空间复杂度O(1)</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/01/18/%E8%AE%B0%E4%B8%80%E6%AC%A1golang%20slice%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/01/18/%E8%AE%B0%E4%B8%80%E6%AC%A1golang%20slice%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">golang slice 问题排查</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-01-18 19:30:00" itemprop="dateCreated datePublished" datetime="2022-01-18T19:30:00+08:00">2022-01-18</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="前置知识点"><a href="#前置知识点" class="headerlink" title="前置知识点"></a>前置知识点</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> a = []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>&#125;</span><br><span class="line">    b := a</span><br><span class="line">    b[<span class="number">1</span>] = <span class="number">3</span></span><br><span class="line">    fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1 3]</span><br></pre></td></tr></table></figure><p>先上一段简单代码,修改b[1]的值发现a[1]的值也跟着变化，原因是a和b里成员的地址是指向同一处的</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>&#125;</span><br><span class="line">b := a</span><br><span class="line">b[<span class="number">1</span>] = <span class="number">3</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;a[0]地址:%p\n&quot;</span>, &amp;a[<span class="number">0</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;a[1]地址:%p\n&quot;</span>, &amp;a[<span class="number">1</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;b[0]地址:%p\n&quot;</span>, &amp;b[<span class="number">0</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;b[1]地址:%p\n&quot;</span>, &amp;b[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a[0]地址:0xc0000b2010</span><br><span class="line">a[1]地址:0xc0000b2018</span><br><span class="line">b[0]地址:0xc0000b2010</span><br><span class="line">b[1]地址:0xc0000b2018</span><br></pre></td></tr></table></figure><h3 id="踩坑背景"><a href="#踩坑背景" class="headerlink" title="踩坑背景"></a>踩坑背景</h3><p>踩坑经历是发生在刷力扣题<a target="_blank" rel="noopener" href="https://leetcode.cn/problems/combination-sum/description/">组合总和</a>这道题的时候，提交后发现一个case没通过<br><img src="/img/in-post/2022-01-15/img_1.png" alt="img_1.png"><br>思考🤔了几遍，没发现出代码逻辑上有什么问题，百思不得其解情况下在本地运行了下该case，发现出现了同样的情况😖<br>下面是当时刷题提交的代码:(为了方便问题分析，由于力扣原题输出项比较多，因此对该case简化了一下)</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	res1 := CombinationSum1([]<span class="type">int</span>&#123;<span class="number">7</span>,<span class="number">3</span>,<span class="number">2</span>&#125;, <span class="number">12</span>)</span><br><span class="line">	fmt.Println(res1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CombinationSum1</span><span class="params">(candidates []<span class="type">int</span>, target <span class="type">int</span>)</span></span> [][]<span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> res = <span class="built_in">make</span>([][]<span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">var</span> backtrack <span class="function"><span class="keyword">func</span><span class="params">([]<span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, []<span class="type">int</span>, <span class="type">int</span>)</span></span></span><br><span class="line">    backtrack = <span class="function"><span class="keyword">func</span><span class="params">(candidate[]<span class="type">int</span>, begin, size <span class="type">int</span>, ints []<span class="type">int</span>, val <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> val &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> val == <span class="number">0</span> &#123;</span><br><span class="line">            res = <span class="built_in">append</span>(res, ints)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i := begin; i &lt; size; i++ &#123;</span><br><span class="line">            backtrack(candidate, i, size, <span class="built_in">append</span>(ints, candidate[i]), val - candidate[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    backtrack(candidates, <span class="number">0</span>, <span class="built_in">len</span>(candidates), []<span class="type">int</span>&#123;&#125;, target)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看输出:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[7 3 2] [3 3 3 2] [3 3 2 2 2] [2 2 2 2 2 2]]</span><br></pre></td></tr></table></figure><blockquote><p>很明显[3 3 3 2]加起来不是12，和leetcode出现的问题是一样的</p></blockquote><h3 id="踩坑原因分析"><a href="#踩坑原因分析" class="headerlink" title="踩坑原因分析"></a>踩坑原因分析</h3><p>一开始，先是在append处打印下<code>ints</code>变量内容，看看是不是路径和计算有问题</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> val == <span class="number">0</span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;append ints %v\n&quot;</span>, ints)</span><br><span class="line">    res = <span class="built_in">append</span>(res, ints)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">append ints [7 3 2]</span><br><span class="line">append ints [3 3 3 3]</span><br><span class="line">append ints [3 3 2 2 2]</span><br><span class="line">append ints [2 2 2 2 2 2]</span><br><span class="line">[[7 3 2] [3 3 3 2] [3 3 2 2 2] [2 2 2 2 2 2]]</span><br></pre></td></tr></table></figure><p>此时，发现了事情的不妙，append<code>ints</code>时<code>ints</code>的成员是正确的，但是最终输出<code>ints</code>的成员确由<code>[3 3 3 3]</code>变为了<code>[3 3 3 2]</code>,<br>于是猜测一定函数<code>backtrack(...append(ints, candidate[i])...)</code>这个函数调用时<code>ints[3]</code>成员的地址的值在后面被修改了，因为通过先前的举例我们也知道了<code>slice</code>里的成员是引用的吗🔍<br>所以决定断点打印一下来印证自己的猜想，由于断点过程中需要每次查看栈空间函数各个参数的值已经函数递归调用是<code>ints</code>成员的地址值的变化，所以采用<code>gdb</code>工具进行断点</p><h3 id="断点追踪"><a href="#断点追踪" class="headerlink" title="断点追踪"></a>断点追踪</h3><p>通过上面的输出结果我们知道<code>ints</code>是在第二次append后输出的，所以直接从第二次append后开始分析,并且<code>ints[3]</code>发生了非预期结果，所以只分析<code>ints[3]</code>的地址和值即可</p><h4 id="追踪step1"><a href="#追踪step1" class="headerlink" title="追踪step1"></a>追踪step1</h4><p>首先，因为发现问题分歧的原因是在<code>res = append(res, ints)</code>这行产生的，因此在这里break一下(如下图所示)<br><img src="/img/in-post/2022-01-15/img_11.png" alt="img_11.png"></p><h4 id="追踪step2"><a href="#追踪step2" class="headerlink" title="追踪step2"></a>追踪step2</h4><p>看一下当前<code>栈</code>空间变量成员(如下图所示)<br><img src="/img/in-post/2022-01-15/img_12.png" alt="img_12.png"></p><blockquote><p>这时，<code>ints[3]</code>还是正常的，打印结果是<code>3</code>,我们记录下当前<code>ints[3]</code>的地址<code>0xc0000ae078</code>,ints变量的地址<code>0xc0000ae060</code>也记录下，后面会用到</p></blockquote><h4 id="追踪step3"><a href="#追踪step3" class="headerlink" title="追踪step3"></a>追踪step3</h4><p>当<code>beign=1;i=1</code>时(如下图所示)；<code>candidate[i]</code>会被append到ints中，看下<code>candidate[i] = 3</code>，这时即使<code>ints[3]</code>地址被重新赋值为<code>candidate[i]</code>，也还是会为3，看不出来什么变化，继续走<br><img src="/img/in-post/2022-01-15/img_13.png" alt="img_13.png"></p><h4 id="追踪step4"><a href="#追踪step4" class="headerlink" title="追踪step4"></a>追踪step4</h4><p>我们直接跳到i&#x3D;2;begin&#x3D;1(如下图所示)；此时发现下面的i&#x3D;1，证明函数还没开始调用，继续<br><img src="/img/in-post/2022-01-15/img_14.png" alt="img_14.png"></p><blockquote><p>为什么在i&#x3D;2后面i又变为了1，并且还有backtrack函数调用？<br>解释：因为在回溯递归场景中，当前循环里，函数可能还存在其他循环时递归调用的函数，而在其他循环里递归调用的函数成员内存地址是跟当前循环不一样的，所以这里不做追踪</p></blockquote><h4 id="追踪step5"><a href="#追踪step5" class="headerlink" title="追踪step5"></a>追踪step5</h4><p>打印<code>candidate[2]</code>，发现值为2(如下图所示),因为这时函数还未调用，<code>candidate[2]</code>还未append，函数将会在下一行调用，所以<code>ints[3]</code>还是3继续追踪<br><img src="/img/in-post/2022-01-15/img_15.png" alt="img_15.png"></p><h4 id="追踪step6"><a href="#追踪step6" class="headerlink" title="追踪step6"></a>追踪step6</h4><p>当backtrack函数执行后;<code>candidate[2]</code>被append到了<code>ints</code>中，此时<code>ints[3]</code>的地址的值发生了修改(如下图所示),所以<code>res</code>最后返回结果的切片也发生了修改<br><img src="/img/in-post/2022-01-15/img_16.png" alt="img_16.png"><br>此时<code>ints[]3</code>的地址<code>0xc0000ae078</code>还是之前的地址，证实了我们的猜想</p><h4 id="追踪step7"><a href="#追踪step7" class="headerlink" title="追踪step7"></a>追踪step7</h4><p>接着往下走，因为i&#x3D;2后，在++为3后不满足<code>i&lt;size</code>判断，所以退出当前循环，进入到下一次循环的函数栈<br><img src="/img/in-post/2022-01-15/img_17.png" alt="img_17.png"><br>此时ints[3]地址由<code>0xc0000ae078</code>变为了<code>0xc0000ac058</code>，ints地址由<code>0xc0000ae060</code>变为了<code>0xc0000ac040</code></p><blockquote><p>之前的ints地址和ints地址在追踪step2记录过</p></blockquote><h4 id="初步结论"><a href="#初步结论" class="headerlink" title="初步结论"></a>初步结论</h4><p>在当前函数栈内，ints成员的地址在每次循环调用时是不变的,所以在当前循环函数调用时,ints发生append后，由于是浅拷贝，所以会发生返回切片结果成员数据<code>被污染</code>的情况</p><h3 id="追踪结论印证"><a href="#追踪结论印证" class="headerlink" title="追踪结论印证"></a>追踪结论印证</h3><p>从前面的结论可知，由于<code>candidate[2]</code>是在循环最后被append的，所以对<code>ints[3]</code>地址指向的值发生了修改，我们可以通过在输入项中增加一个元素，来印证当前结论</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res1 := CombinationSum1([]<span class="type">int</span>&#123;<span class="number">7</span>,<span class="number">3</span>,<span class="number">2</span>, <span class="number">8</span>&#125;, <span class="number">12</span>)</span><br></pre></td></tr></table></figure><p>打印输出结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">append ints [7 3 2]</span><br><span class="line">append ints [3 3 3 3]</span><br><span class="line">append ints [3 3 2 2 2]</span><br><span class="line">append ints [2 2 2 2 2 2]</span><br><span class="line">append ints [2 2 8]</span><br><span class="line">[[7 3 2] [3 3 3 8] [3 3 2 2 2] [2 2 2 2 2 8] [2 2 8]]</span><br></pre></td></tr></table></figure><p>可以看到<code>[3 3 3 2]</code>变为了<code>[3 3 3 8]</code></p><h3 id="How-To-Fix"><a href="#How-To-Fix" class="headerlink" title="How To Fix"></a>How To Fix</h3><p>了解问题根本原因后想解决就很简单了，我们只要在append时深拷贝一次ints就可以了<br>解决后完整代码:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	res1 := CombinationSum2([]<span class="type">int</span>&#123;<span class="number">7</span>,<span class="number">3</span>,<span class="number">2</span>, <span class="number">8</span>&#125;, <span class="number">12</span>)</span><br><span class="line">	fmt.Println(res1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CombinationSum1</span><span class="params">(candidates []<span class="type">int</span>, target <span class="type">int</span>)</span></span> [][]<span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> res = <span class="built_in">make</span>([][]<span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">var</span> backtrack <span class="function"><span class="keyword">func</span><span class="params">([]<span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, []<span class="type">int</span>, <span class="type">int</span>)</span></span></span><br><span class="line">	backtrack = <span class="function"><span class="keyword">func</span><span class="params">(candidate[]<span class="type">int</span>, begin, size <span class="type">int</span>, ints []<span class="type">int</span>, val <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> val &lt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> val == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> tmp = <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(ints))</span><br><span class="line">			<span class="built_in">copy</span>(tmp, ints)</span><br><span class="line">			fmt.Println(<span class="string">&quot;append after copied ints&quot;</span>, tmp)</span><br><span class="line">			res = <span class="built_in">append</span>(res, tmp)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> i := begin; i &lt; size; i++ &#123;</span><br><span class="line">			backtrack(candidate, i, size, <span class="built_in">append</span>(ints, candidate[i]), val - candidate[i])</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	backtrack(candidates, <span class="number">0</span>, <span class="built_in">len</span>(candidates), []<span class="type">int</span>&#123;&#125;, target)</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">append</span> after copied ints [<span class="number">7</span> <span class="number">3</span> <span class="number">2</span>]</span><br><span class="line"><span class="built_in">append</span> after copied ints [<span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span>]</span><br><span class="line"><span class="built_in">append</span> after copied ints [<span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>]</span><br><span class="line"><span class="built_in">append</span> after copied ints [<span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>]</span><br><span class="line"><span class="built_in">append</span> after copied ints [<span class="number">2</span> <span class="number">2</span> <span class="number">8</span>]</span><br><span class="line">[[<span class="number">7</span> <span class="number">3</span> <span class="number">2</span>] [<span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span>] [<span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>] [<span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>] [<span class="number">2</span> <span class="number">2</span> <span class="number">8</span>]]</span><br></pre></td></tr></table></figure><p>算法提交通过👏<br><img src="/img/in-post/2022-01-15/img_18.png" alt="img_18.png"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/01/15/%E5%9B%9E%E6%BA%AF%E6%A8%A1%E7%89%88/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/01/15/%E5%9B%9E%E6%BA%AF%E6%A8%A1%E7%89%88/" class="post-title-link" itemprop="url">回溯模版</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-01-15 19:30:00" itemprop="dateCreated datePublished" datetime="2022-01-15T19:30:00+08:00">2022-01-15</time></span></div></header><div class="post-body" itemprop="articleBody"><h4 id="回溯模版总结"><a href="#回溯模版总结" class="headerlink" title="回溯模版总结"></a>回溯模版总结</h4><p>适用于结果路径里元素不可重复使用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">创建空slice</span><br><span class="line"><span class="keyword">for</span> 选择 in 选择列表:</span><br><span class="line">    # 做选择</span><br><span class="line">    将该选择从选择列表移除</span><br><span class="line">    slice = slice[<span class="number">1</span>:]</span><br><span class="line">    backtrack(路径.<span class="built_in">append</span>, 选择列表)</span><br><span class="line">    # 撤销选择</span><br><span class="line">	slice = slice[:<span class="built_in">len</span>(slice) - <span class="number">1</span>]</span><br><span class="line">    将该选择再加入选择列表</span><br></pre></td></tr></table></figure><p>适用于结果路径里元素可重复使用，排列顺序不能重复</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">创建空slice</span><br><span class="line"><span class="keyword">for</span> 选择 in 选择列表:</span><br><span class="line">    # 做选择</span><br><span class="line">    将该选择从选择列表移除</span><br><span class="line">    num := slice[i]</span><br><span class="line">    slice = <span class="built_in">append</span>(slice[:i], slice[i+<span class="number">1</span>:]...)</span><br><span class="line">    backtrack(路径.<span class="built_in">append</span>, 选择列表)</span><br><span class="line">    # 撤销选择</span><br><span class="line">	slice = <span class="built_in">append</span>(slice[:i], <span class="built_in">append</span>([]<span class="type">int</span>&#123;num&#125;, slice[i:]...)...)</span><br><span class="line">    将该选择再加入选择列表</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/01/14/%E5%9B%9E%E6%BA%AF%E7%AE%97%E6%B3%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/01/14/%E5%9B%9E%E6%BA%AF%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">回溯算法</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-01-14 19:30:00" itemprop="dateCreated datePublished" datetime="2022-01-14T19:30:00+08:00">2022-01-14</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="回溯算法"><a href="#回溯算法" class="headerlink" title="回溯算法"></a>回溯算法</h2><h4 id="回溯题目应用"><a href="#回溯题目应用" class="headerlink" title="回溯题目应用"></a>回溯题目应用</h4><p>以力扣<a target="_blank" rel="noopener" href="https://leetcode.cn/problems/generate-parentheses/submissions/393569541/" title="https://leetcode.cn/problems/generate-parentheses/submissions/393569541/">https://leetcode.cn/problems/generate-parentheses/submissions/393569541/</a>算法为例:</p><p>题目要求：输入一个数字n:数字 n 代表生成括号的对数，请你设计一个函数，用于能够生成所有可能的并且有效的括号组合</p><h3 id="回溯分析过程"><a href="#回溯分析过程" class="headerlink" title="回溯分析过程"></a>回溯分析过程</h3><h4 id="先枚举"><a href="#先枚举" class="headerlink" title="先枚举"></a>先枚举</h4><p>根据题目要求：可分析得到要生成n对括号，并且括号是有效括号，由于题目要求列出所有组合可能，所以我们要将括号拆分成<code>(</code>和<code>)</code>,这样我们一共需要生成2n个这样的括号 先发挥我们的大脑想象😇，列举出这2n个括号的所有排列组合</p><p>已n&#x3D;2为例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">))))</span><br><span class="line">)))(</span><br><span class="line">))()</span><br><span class="line">))((</span><br><span class="line">)())</span><br><span class="line">)()(</span><br><span class="line">)(()</span><br><span class="line">)(((</span><br><span class="line">()))</span><br><span class="line">())(</span><br><span class="line">()()</span><br><span class="line">()((</span><br><span class="line">(())</span><br><span class="line">(()(</span><br><span class="line">((()</span><br><span class="line">((((</span><br></pre></td></tr></table></figure><p>可枚举出16种可能，但是这些结果集并不是我们都需要的，因此我们需要针对有效括号的特性做出一些筛减；分析至此，会很轻易发现，这是不是和<code>回溯</code>的思想很类似呢?回溯的核心思想是:在for循环里面进行递归，枚举出所有可能，在递归调用之前「做选择」，在递归调用之后「撤销选择」；而<code>做选择</code>就是对穷举的排列组合进行筛减，判断出不合法的选择，然后过滤掉，这种过程通常被叫做<code>剪枝</code>。<code>撤销选择</code>即探索过程中发现并不优或达不到目标，就退回一步重新选择</p><p>枚举所有可能的代码很好实现：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenerateParenthesis</span><span class="params">(n <span class="type">int</span>)</span></span> []<span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> backtrack <span class="function"><span class="keyword">func</span> <span class="params">(<span class="type">int</span>, <span class="type">string</span>)</span></span></span><br><span class="line">	<span class="keyword">var</span> res = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line">	n = n * <span class="number">2</span></span><br><span class="line">	backtrack = <span class="function"><span class="keyword">func</span><span class="params">(n <span class="type">int</span>, back <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">			res = <span class="built_in">append</span>(res, back)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;)&quot;</span>)</span><br><span class="line">		backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;(&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	backtrack(n, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h4><p>递归为什么可实现枚举？</p><p>分析过程:</p><p>如果输入为2，要生成2n个括号可得出n&#x3D;4,因为函数是在<code>栈</code>中调用的,并且递归嵌套调用<br>所以当：</p><ul><li><p>n&#x3D;1时:<code>backtrack(0, back + &quot;)&quot;)</code>和<code>backtrack(0, back + &quot;(&quot;)</code>都被压入到栈中</p></li><li><p>n&#x3D;2时:<code>backtrack(1, back + &quot;)&quot;)</code>和<code>backtrack(1, back + &quot;(&quot;)</code>都被压入到栈中</p></li><li><p>n&#x3D;3时:<code>backtrack(2, back + &quot;)&quot;)</code>和<code>backtrack(3, back + &quot;(&quot;)</code>都被压入到栈中</p></li><li><p>n&#x3D;4时:<code>backtrack(3, back + &quot;)&quot;)</code>和<code>backtrack(3, back + &quot;(&quot;)</code>都被压入到栈中</p></li></ul><p>不难分析，当:</p><ul><li><p>n&#x3D;0时为终止条件，直接输出</p></li><li><p>n&#x3D;1时<code>n = n-1</code> 函数调用为<code>backtrack(0, back + &quot;)&quot;)</code>,对应了两种结果集：<code>)</code>和<code>(</code>都被压入栈中,会输出<code>)</code>和<code>(</code>两种可能;函数被压入栈中2次</p></li><li><p>n&#x3D;2时<code>n = n-1</code> 函数调用为<code>backtrack(1, back + &quot;)&quot;)</code>,对应了刚才n&#x3D;1时两种输出结果集;<code>backtrack(1, back + &quot;(&quot;)</code>也对应了n&#x3D;1的两种输出结果集,想加后一共会输出<code>))</code>、<code>((</code>、<code>()</code>、<code>)(</code>四种可能;函数被压入栈中4次</p></li><li><p>n&#x3D;3时<code>n = n-1</code> 函数调用为<code>backtrack(2, back + &quot;)&quot;)</code>,对应了刚才n&#x3D;2时的两种输出结果集;<code>backtrack(2, back + &quot;(&quot;)</code>也对应了n&#x3D;2的两种输出结果集,想加后一共会输出<code>)))</code> <code>))(</code> <code>)()</code> <code>)((</code> <code>())</code> <code>()(</code> <code>(()</code> <code>(((</code>八种可能;函数被压入栈中8次</p></li><li><p>n&#x3D;4时<code>n = n-1</code> 函数调用为<code>backtrack(3, back + &quot;)&quot;)</code>,对应了刚才n&#x3D;3时的两种输出结果集;<code>backtrack(3, back + &quot;(&quot;)</code>也对应了n&#x3D;3的两种输出结果集,想加后一共会输出…十六种可能;函数被压入栈中16次</p></li><li><p>n&#x3D;x时<code>n = x-1</code> 函数调用为<code>backtrack(x-1, back + &quot;)&quot;)</code>和<code>backtrack(x-1, back + &quot;(&quot;)</code>对应了<code>2 * (backtrack(x-1))</code>种可能);函数被压入栈中次<code>2 * (backtrack(x-1))</code>次</p></li></ul><blockquote><p>总结：枚举不同可能是一个不断搜索尝试的过程，由于枚举过程需要保存上一次枚举的结果集，而函数参数值在每次函数调用的过程中会保存下来，利用这一特性我们只要在递归终止条件中，将递归后的结果集保存下来就可以穷举出所有可能。</p></blockquote><h4 id="剪枝"><a href="#剪枝" class="headerlink" title="剪枝"></a>剪枝</h4><p>剪枝就是在穷举的结果集中过滤到不合法的结果集</p><p>根据题意可分析到剪枝条件:</p><ul><li><p>左括号数量不能超出n&#x2F;2</p></li><li><p>左括号一定要先于右括号出现</p></li><li><p>右括号数量不能超出n&#x2F;2</p></li></ul><p>所以我们要在递归调用中增加函数参数，来保存左括号和右括号出现的次数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> backtrack <span class="function"><span class="keyword">func</span> <span class="params">(<span class="type">int</span>, <span class="type">string</span>, <span class="type">int</span>, <span class="type">int</span>)</span></span></span><br><span class="line">backtrack = <span class="function"><span class="keyword">func</span><span class="params">(n <span class="type">int</span>, back <span class="type">string</span>, left, right <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;)&quot;</span>, left, right + <span class="number">1</span>) <span class="comment">// 通过right+1实现右括号计数</span></span><br><span class="line">    backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;(&quot;</span>, left + <span class="number">1</span>, right) <span class="comment">// 通过left+1实现左括号计数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据刚才的剪枝分析增加判断条件</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 必须先保证左括号先出现，才能出现右括号</span></span><br><span class="line"><span class="keyword">if</span> left &gt; right &#123;</span><br><span class="line">    backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;)&quot;</span>, left, right + <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 当左括号出现超过n/2时，剪掉多余的左括号，并且只添加右括号</span></span><br><span class="line"><span class="keyword">if</span> left &lt; n / <span class="number">2</span> &#123;</span><br><span class="line">    backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;(&quot;</span>, left + <span class="number">1</span>, right)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>由于保证了left出现次数不会超过n&#x2F;2,并且总出现次数限制为n（n&#x3D;0时函数会退出），所以右括号数量不能超出n&#x2F;2的判断代码不用实现</p></blockquote><p>由于函数在递归调用过程中,n由于减1会发生变化，我们需要在全局变量中声明<code>m</code>并保存<code>n</code>的初始值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> backtrack <span class="function"><span class="keyword">func</span> <span class="params">(<span class="type">int</span>, <span class="type">string</span>, <span class="type">int</span>, <span class="type">int</span>)</span></span></span><br><span class="line">n = n * <span class="number">2</span></span><br><span class="line">m := n</span><br><span class="line">backtrack = <span class="function"><span class="keyword">func</span><span class="params">(n <span class="type">int</span>, back <span class="type">string</span>, left, right <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;)&quot;</span>, left, right + <span class="number">1</span>) <span class="comment">// 通过right+1实现右括号计数</span></span><br><span class="line">    backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;(&quot;</span>, left + <span class="number">1</span>, right) <span class="comment">// 通过left+1实现左括号计数</span></span><br><span class="line">    <span class="keyword">if</span> left &gt; right &#123;</span><br><span class="line">        backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;)&quot;</span>, left, right + <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当左括号出现超过n/2时，剪掉多余的左括号，并且只添加右括号</span></span><br><span class="line">    <span class="keyword">if</span> left &lt; m / <span class="number">2</span> &#123;</span><br><span class="line">        backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;(&quot;</span>, left + <span class="number">1</span>, right)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="完整代码示例"><a href="#完整代码示例" class="headerlink" title="完整代码示例"></a>完整代码示例</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateParenthesis</span><span class="params">(n <span class="type">int</span>)</span></span> []<span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> backtrack <span class="function"><span class="keyword">func</span> <span class="params">(<span class="type">int</span>, <span class="type">string</span>, <span class="type">int</span>, <span class="type">int</span>)</span></span></span><br><span class="line">	<span class="keyword">var</span> res = <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line">	n = n * <span class="number">2</span></span><br><span class="line">	m := n</span><br><span class="line">	backtrack = <span class="function"><span class="keyword">func</span><span class="params">(n <span class="type">int</span>, back <span class="type">string</span>, left, right <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">			res = <span class="built_in">append</span>(res, back)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//必须先保证左括号先出现，才能出现右括号</span></span><br><span class="line">		<span class="keyword">if</span> left &gt; right &#123;</span><br><span class="line">			backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;)&quot;</span>, left, right + <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//当左括号出现超过n/2时，剪掉多余的左括号，并且只添加右括号</span></span><br><span class="line">		<span class="keyword">if</span> left &lt; m / <span class="number">2</span> &#123;</span><br><span class="line">			backtrack(n- <span class="number">1</span>, back + <span class="string">&quot;(&quot;</span>, left + <span class="number">1</span>, right)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	backtrack(n, <span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2022-01-15/img.png" alt="img.png"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/09/13/2021-09-13-%E9%A1%B5%E8%A1%A8%E5%8A%A0%E9%80%9F/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/09/13/2021-09-13-%E9%A1%B5%E8%A1%A8%E5%8A%A0%E9%80%9F/" class="post-title-link" itemprop="url">页表加速</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-09-13 19:30:00" itemprop="dateCreated datePublished" datetime="2021-09-13T19:30:00+08:00">2021-09-13</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="局部性原理"><a href="#局部性原理" class="headerlink" title="局部性原理"></a>局部性原理</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> a[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">while</span>(i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    a[i] = i</span><br><span class="line">    i++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个程序会很频繁的访问下图中的10号和20号内存块</p></blockquote><p><img src="/../img/in-post/2021-09-13/img.png" alt="img.png"></p><p><strong>时间局部性</strong>：如果执行了程序中的某条指令，那么不久后这条指令很有可能再次执行：如果某个数据被访问过，不久之后该数据很可能再次被访问。（因为程序中存在大量的循环）</p><p><strong>空间局部性</strong>： 一旦程序访问了某个存储单元，在不久之后，其附近的存储单元也很有可能被访问。（因为很多数据在内存中都是连续存放的）</p><p>在地址转化过程中，每次要访问一个逻辑地址，都需要查询内存中的页表。由于局部性原理，可能连续很多次查到的都是同一个页表项。既然如此，能否利用这个特性减少访问页表的次数呢？</p><h2 id="快表"><a href="#快表" class="headerlink" title="快表"></a>快表</h2><p>快表，又称联想寄存器(TLB) 是一种访问速度比内存快很多的高速缓冲存储器，用来存放当前访问的若干页表项，以加速地址变换的过程。与此对应，内存中的页表常称为<strong>慢表</strong>。</p><p><img src="/../img/in-post/2021-09-13/img_1.png" alt="img_1.png"></p><p>引入快表后，地址变换的过程的文字描述：</p><ol><li>CPU给出逻辑地址，由某个硬件算得页号、页内偏移量，将页号与快表中的所有页号进行比较。</li><li>如果找到匹配的页号，说明要访问的页表项在快表中有副本，则直接从中取出该页对应的内存块号， 再将内存块号与页内偏移量拼接形成物理地址，最后，访问该物理地址对应的内存单元。因此， 若快表命中，则访问某个逻辑地址<font color="#dd0000">仅需一次</font>访存即可。</li><li>如果没有找到匹配的页号，则需要访问内存中的页表，找到对应页表项，得到页面存放的内存块号，再将内存块号与页内偏移量拼接形成物理地址，最后，访问该物理地址对应的内存单元。因此， 若快表未命中，则访问某个逻辑地址需要<font color="#dd0000">两次访存</font>（注意：在找到页表项后，应同时将其存入快表， 以便后面可能的再次访问。但若快表己满，则必须按照一定的算法对旧的页表项进行替换,也就是页面置换算法）</li></ol><p>由于查询快表的速度比查询页表的速度快很多，因此只要快表命中，就可以节省很多时间。 因为局部性原理， 一般来说快表的命中率可以达到90%以上。 查询内存中的慢表(页表) 经过计算查询内存中物理地址的内存单元</p><p>例：某系统使用基本分页存储管理，并采用了具有快表的地址交换机构。访问一次快表耗时 1us,访 问一次内存耗时 100us。若快表的命中率为 90%，那么访问一个逻辑地址的平均耗时是多少？（1+100)* 0.9+ (1+100+100)<em>0.1&#x3D;111us 有的系统文持快表和投表同时查找，如果是这样，平均耗时应该是 (1+100)</em> 0.9 + (100+100) *0.1 &#x3D; 110.9 us 若未采用快表机制，则访问一个逻辑地址需要 100+100&#x3D;200us 显然，引入快表机制后，访问一个逻辑地址的速度快多了。</p><h2 id="单级页表所引发的问题"><a href="#单级页表所引发的问题" class="headerlink" title="单级页表所引发的问题"></a>单级页表所引发的问题</h2><p>某计算机系统按字节寻址，支持32位的逻辑地址，采用分页存储管理，页面大小为4KB，页表项长度为 4B。 4KB&#x3D; 2^12B，因此页内地址要用12位表示，剩余20位表示页号。 因此，该系统中用户进程最多有2^20页。相应的，一个进程的页表中，最多会有2^20 &#x3D;1M&#x3D;1,048,576个页表项，所以一个页表最大需要 2^20*4B&#x3D;2^22B，共需要 2^22&#x2F;2^12&#x3D;2^10 个页框存储该页表。 根据局部性原理可知，很多时候，进程在一段时间内只需要访问某几个页面就可以正常运行了。因此没有必要让整个页表都常驻内存。</p><ul><li>问题一：页表必须连续存放，因此当页表很大时，需要占用很多个连续的页框。</li><li>问题二：没有必要让整个页表常驻内存，因为进程在一段时间内可能只需要访问某几个特定的页面</li></ul><h3 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h3><p>上面提到了这两个问题，针对问题一，可以引入二级页表的概念来解决。</p><h3 id="二级页表"><a href="#二级页表" class="headerlink" title="二级页表"></a>二级页表</h3><p>在32位逻辑地址空间，页表项大小为4kb，页面大小4kb,页内地址占12位</p><table><thead><tr><th>31 … 12</th><th>11 … 0</th></tr></thead><tbody><tr><td>页号</td><td>页面偏移量</td></tr></tbody></table><p><img src="/../img/in-post/2021-09-13/img_9.png" alt="img_9.png"><br>将页表进行拆分<br><img src="/../img/in-post/2021-09-13/img_8.png" alt="img_8.png"><br>拆分后页表查找过程<br><img src="/../img/in-post/2021-09-13/img_7.png" alt="img_7.png"><br>二级页表的地转换过程：<br>例如：17407的32位二进制可表示为<code>(0000000000,0000000100,001111111111)</code></p><ul><li>先去根据<code>0000000000</code>到页目录表查找页表内存块3，然后访问内存块3得到页表信息</li><li>根据二级页表<code>0000000100</code>对应二级页表的下标为4，所以在<code>页表0</code>中<code>下标4</code>页号的内存块号为<code>16</code>；</li><li>由与4kb页表被拆分成<code>1024</code>个页表，可得知，每个页表大小为<code>4b</code>,所以<code>16内存号</code>的起始地址为<code>16*1024=16384</code></li><li>偏移量<code>001111111111</code>计算得知为1023，所以最终物理地址为<code>16384+1023=17407</code><br><img src="/../img/in-post/2021-09-13/img_6.png" alt="img_6.png"></li></ul><p>两级页表的访存次数分析（假设没有快表机制）</p><ul><li>第一次访存：访问内存中的页目录表</li><li>第二次访存：访问内存中的二级页表</li><li>第三次访存：访问目标内存单元</li></ul><h3 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h3><p>上面的部分我们解决了问题一，接下来是问题二，这里简单叙述一下,详细内容在<a target="_blank" rel="noopener" href="https://bithachi.blog.csdn.net/article/details/105997486">页面置换算法</a>文章中会提到</p><p><img src="/../img/in-post/2021-09-13/img_2.png" alt="img_2.png"></p><h3 id="多级页表"><a href="#多级页表" class="headerlink" title="多级页表"></a>多级页表</h3><p>若采用多级页表机制，则各级页表的大小不能超过一个页面</p><p>例：某系统按字节编址，采用 40 位逻银地址，页面大小为 4KB，页表项大小为 4B，假设采用纯页式存储，则要采用（）级页表，页内偏移量为（）位？</p><p>页面大小&#x3D;4KB&#x3D;2^12B，按字节编址，因此页内偏移量为12位 页号&#x3D;40-12&#x3D;28份 页面大小&#x3D;2^12B，页表项大小&#x3D;4B，则每个页面可存放 2^12&#x2F;4&#x3D;2^10个页表项 因此各级页表最多包含2^10个页表项， 需要10位二进制位才能映射到2^10个页表项，因此每一级的页表对应页号应为10位。总共28位的页号至少要分为三级</p><p><img src="/../img/in-post/2021-09-13/img_3.png" alt="img_3.png"></p><p>参考文献:王道计算机考研-操作系统</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/09/12/2021-09-12-%E9%9D%9E%E8%BF%9E%E7%BB%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%88%86%E9%A1%B5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/09/12/2021-09-12-%E9%9D%9E%E8%BF%9E%E7%BB%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%88%86%E9%A1%B5/" class="post-title-link" itemprop="url">非连续内存管理-分页存储</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-09-12 19:30:00" itemprop="dateCreated datePublished" datetime="2021-09-12T19:30:00+08:00">2021-09-12</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="为什么使用非连续内存分配"><a href="#为什么使用非连续内存分配" class="headerlink" title="为什么使用非连续内存分配"></a>为什么使用非连续内存分配</h2><p>考虑多道程序设计连续内存分配两种管理方式</p><ol><li>固定分配，缺乏灵活性，大量内部内存分片产生，内存利用率低</li><li>动态分配，大量外部内存分片产生，可通过”紧凑”技术解决，但是紧凑效率低<br>基于这一思想，产生了”非连续分配方式”</li></ol><p>非连续内存管理方式分为下图几种<br><img src="/../img/in-post/2021-09-12/img_1.png" alt="img.png"></p><h2 id="分页存储"><a href="#分页存储" class="headerlink" title="分页存储"></a>分页存储</h2><h3 id="分页存储思想"><a href="#分页存储思想" class="headerlink" title="分页存储思想"></a>分页存储思想</h3><p>假设进程A大小为23MB，但是每个分区大小只有10MB，如果进程只能占用一个分区，那显然放不下。</p><p>解决思路：如果允许进程占用多个分区，那么可以把进程拆分成<code>10MB+10MB+3MB</code>三个部分，再把这三个部分分别放到三个分区中（这些分区不要求连续）</p><p>进程A的最后一个部分是3MB，放入分区后会产生 7MB 的内部碎片。</p><p>如果每个分区大小为 2MB，那么进程A可以拆分成 11* 2MB + 1MB 共12个部分，只有最后一部分 1MB占不满分区，会产生 1MB 的内部碎片。</p><p>显然，如果把分区大小设置的更小一些，内部碎片会更小，内存利用率会更高。</p><h3 id="分页存储管理的重要概念"><a href="#分页存储管理的重要概念" class="headerlink" title="分页存储管理的重要概念"></a>分页存储管理的重要概念</h3><p>将内存空间分为一个个大小相等的分区（比如：每个分区4KB），每个分区就是一个“页框”，或称“页帧” “内存块” “物理块” 。每个页框有一个编号，即“页框号” （或 者“内存块号” “页帧号” “物理块号〞，页框号从O开 始 将用户进程的地址空问也分为与页框大人相等的一个个区城， 称为“页”或“页面” 。每个页面也有 一个编号，即“页号” 页号也是从0开始。</p><p>(注：进程的最后一个页面可能没有一个页框那么大。因此， 页框不能太大，否则可能产生过大的内部碎片）</p><p>操作系统以页框为单位为各个进程分配内存空间。进程的每个页面分别放入一个页框中。也就是说，进程的页面与内存的页 框有一对应的关系。 各个页面不必连续存放，也不必按先后顺序来，可以放到不相邻的各个页框中。</p><h3 id="地址转化"><a href="#地址转化" class="headerlink" title="地址转化"></a>地址转化</h3><h4 id="操作系统如何实现逻辑地址到物理地址的转化"><a href="#操作系统如何实现逻辑地址到物理地址的转化" class="headerlink" title="操作系统如何实现逻辑地址到物理地址的转化"></a>操作系统如何实现逻辑地址到物理地址的转化</h4><p>假设每页大小50b<br><img src="/../img/in-post/2021-09-12/img.png" alt="img.png"></p><p>逻辑地址为80的内存单元： 应该在1号页，该页在内存中的起始位置为450，逻辑地址为80的内存单元相对于该页的起始地址而言， “偏移量”应该是30。 实际物理地址450+30&#x3D;480</p><ol><li>要算出逻辑地址对应的页号</li><li>要知道该页号对应页面在内存中的起始地址</li><li>要算出逻辑地址在医面内的“偏移 量”</li><li>物理地址&#x3D;页面始址＋页内偏移量</li></ol><h4 id="偏移量和页号计算"><a href="#偏移量和页号计算" class="headerlink" title="偏移量和页号计算"></a>偏移量和页号计算</h4><p>页号：80 &#x2F; 50 &#x3D; 1</p><p>偏移量：80 % 50 &#x3D; 30</p><p>1号页在内存的起始位置为450</p><blockquote><p>为了方便计算页号，偏移量和页面大小一般为2的幂次方</p></blockquote><p>逻辑地址 4097，用二进制表示应该是 <code>00000000000000000001000000000001</code> 若 1号页在内存中的起始地址为x，则逻辑地址4097对应的物理地址应该是x+1000000000001</p><p>如何计算： 页号&#x3D;逻辑地址&#x2F; 页面长度（取除法的整数部分）</p><p>为了方便计算 页而大小一般 页内偏移量&#x3D;逻辑地址 % 页面长度（取除法的余数部分）<br>假设用32个二进制位表示逻辑地址，页面大小为 210B&#x3D;1024B&#x3D; 1KB</p><p>0号页的逻辑地址空间应该是 0~1023，用二进制表示应该是： <code>00000000000000000000000000000000 ~ 00000000000000000000001111111111</code></p><p>1号页的逻辑地址空间应该是 1024~2047，用二进制表示恩该是： <code>00000000000000000000010000000000 ~ 00000000000000000000011111111111</code></p><p>2号页的逻辑地址空间应该是 2048~3021，用二进制表示应该是： <code>00000000000000000000100000000000 ~ 00000000000000000000101111111111</code></p><p>结论：如果每个页面大小为 2^B，用二进制数表示逻辑地址，则末尾K位即为页内便宜量，其余部分就是页号，因此，如果让每个页面的大小为2的整数幂，计算机就可以很方便地得出一个逻辑地址和页内偏移量。</p><h4 id="为什么是2的幂次方？"><a href="#为什么是2的幂次方？" class="headerlink" title="为什么是2的幂次方？"></a>为什么是2的幂次方？</h4><p>例如计算1026和2055的页号和页面偏移量<br>1026的32位二进制表示为<code>00000000000000000000010000000010</code></p><p>如果每个页面大小为2^10,末尾10位为<code>0000000010</code>,可得出页面偏移量为2，其余部分为<code>0000000000000000000001</code>,可得出在1号页</p><p>2055的32位二进制表示为<code>00000000000000000000100000000111</code></p><p>如果每个页面大小为2^10,末尾10位为<code>0000000111</code>,可得出页面偏移量为7，其余部分为<code>0000000000000000000010</code>,可得出在2号页</p><h4 id="如何知道页面在内存的起始位置"><a href="#如何知道页面在内存的起始位置" class="headerlink" title="如何知道页面在内存的起始位置"></a>如何知道页面在内存的起始位置</h4><p>这里引入一个新概念<strong>页表</strong></p><p>为了能知道进程的每个页面在内存中存放的位置，操作系统要为每个进程建立一张页表。</p><ol><li>一个进程对应一张页表</li><li>进程每一页对应一个页表项</li><li>每个页表由页号和块号组成</li><li>页表记录进程页面和世纪存放的内存块对应关系</li><li>每个页表项的长度是相同的，页号是隐含的</li></ol><p>参考文献:王道计算机考研-操作系统</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2021/09/10/2021-09-10-%E8%BF%9E%E7%BB%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2021/09/10/2021-09-10-%E8%BF%9E%E7%BB%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">连续内存管理</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-09-10 19:30:00" itemprop="dateCreated datePublished" datetime="2021-09-10T19:30:00+08:00">2021-09-10</time></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/../img/in-post/2021-09-10/img.png" alt="img.png"></p><h2 id="单一连续分配"><a href="#单一连续分配" class="headerlink" title="单一连续分配"></a>单一连续分配</h2><ul><li>内存只能有一道用户程序，内存分成2块，操作系统区和用户区，用户程序放在用户区</li><li>没有外部碎片，因为分配的是整一块，干干净净，容不下第二道程序；但是有内部碎片，因为一道程序可能没那么大</li><li>因为是只支持单道程序，可以采用覆盖技术扩充内存</li></ul><h2 id="固定分区分配"><a href="#固定分区分配" class="headerlink" title="固定分区分配"></a>固定分区分配</h2><ul><li>支持多道程序，将内存用户空间（一部分是系统空间）划分若干个分区，每个分区只能装一道作业</li><li>没有外部碎片，有内部碎片</li><li>2种划分方式，分区大小相等，分区大小不相等</li></ul><h2 id="动态分区分配"><a href="#动态分区分配" class="headerlink" title="动态分区分配"></a>动态分区分配</h2><ol><li><p>支持多道程序，在进程进入内存时，动态根据进程大小划分分区</p></li><li><p>2种数据结构</p><ul><li>空闲分区表</li><li>空闲分区链</li></ul></li><li><p>进程多大，分区就多大，所以没有内部碎片，但是有外部碎片,外部碎片可以用紧凑技术解决</p></li><li><p>回收内存分区时，有4种情况</p><ul><li>情况一：回收区的后面有一个相邻的空闲分区</li><li>情况二：回收区的前面有一个相邻的空闲分区</li><li>情况三：回收区的前、后各有一个相邻的空闲分区</li><li>情况四：回收区的前、后都没有相邻的空闲分区</li></ul></li></ol><p>总之，相连的空闲分区要合并</p><ol start="5"><li>当多个空闲分区都能满足要求时，应该选择哪个分区进行分配？<ul><li>首次适应算法first fit</li><li>最佳适应算法best fit</li><li>最坏适应算法worst fit</li><li>邻近适应算法next fit</li></ul></li></ol><table><thead><tr><th>算法</th><th>思想</th><th>分区排列顺序</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>首次适应</td><td>从头到尾找到适合的分区</td><td>空闲分区以地址递增次序排列</td><td>性能最好，<strong>算法开销小</strong>回收后不需要对空闲分区重新排序</td><td></td></tr><tr><td>最佳适应</td><td>优先使用更小的分区，以保留更多的分区</td><td>空闲分区以容量递增次序排列</td><td>会有更多的大分区被保留下来，更能满足大进程需求</td><td>会产生很多小、难以利用的碎片，<strong>算法开销大</strong>，回收后可能需要对空闲分区队列重新排序</td></tr><tr><td>最坏适应</td><td>优先使用更大的分区，以防止产生太多太小的不可用的碎片</td><td>空闲分区以容量递增次序排列</td><td>可以减少许多难以利用的小碎片</td><td>大分区容易被用完，不利于大进程，<strong>算法开销大</strong></td></tr><tr><td>邻近适应</td><td>由首次适应演变而来，每次从上次查找结束位置开始查找</td><td>空闲分区以地址递增次序排列</td><td>不用每次都从低地址的小分区开始检索，<strong>算法开销小</strong></td><td></td></tr></tbody></table><p>参考文献:王道计算机考研-操作系统</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a> <a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">enpsl</p><div class="site-description" itemprop="description">my blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script></body></html>