<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"enpsl.github.io",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="my blog"><meta property="og:type" content="website"><meta property="og:title" content="å½­è¯—äº®çš„åšå®¢"><meta property="og:url" content="https://enpsl.github.io/index.html"><meta property="og:site_name" content="å½­è¯—äº®çš„åšå®¢"><meta property="og:description" content="my blog"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="enpsl"><meta property="article:tag" content="å½­è¯—äº® psl pengshiliang blog"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://enpsl.github.io/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>å½­è¯—äº®çš„åšå®¢</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">å½­è¯—äº®çš„åšå®¢</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> é¦–é¡µ</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> å½’æ¡£</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2023/01/17/2023-01-15-go-map%E5%8E%9F%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2023/01/17/2023-01-15-go-map%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">GO MAPåŸç†</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2023-01-17 19:30:00" itemprop="dateCreated datePublished" datetime="2023-01-17T19:30:00+08:00">2023-01-17</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="GO-MAPåŸç†"><a href="#GO-MAPåŸç†" class="headerlink" title="GO MAPåŸç†"></a>GO MAPåŸç†</h1><p>hmapç»“æ„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">	count     <span class="type">int</span>    <span class="comment">// mapçš„å…ƒç´ æ•°é‡</span></span><br><span class="line">	flags     <span class="type">uint8</span>  <span class="comment">//çŠ¶æ€æ ‡è¯†ï¼Œç”¨äºæ§åˆ¶goroutineå†™å…¥å’Œæ‰©å®¹çš„çŠ¶æ€</span></span><br><span class="line">	B         <span class="type">uint8</span>  <span class="comment">// ç”¨äºè®¡ç®—bucketsæ•°é‡ï¼Œè®¡ç®—å…¬å¼2^B</span></span><br><span class="line">	noverflow <span class="type">uint16</span> <span class="comment">// æº¢å‡ºæ¡¶æ•°é‡</span></span><br><span class="line">	hash0     <span class="type">uint32</span> <span class="comment">// hash ç§å­</span></span><br><span class="line">	buckets    unsafe.Pointer <span class="comment">// 2^B Buckets count ==0æ—¶å¯èƒ½ä¸ºnil(æ­¤å¤„æ˜¯ä¸‡èƒ½æŒ‡é’ˆç±»å‹ï¼Œå®é™…æ˜¯å¯¹åº”ä¸‹é¢çš„bmap)</span></span><br><span class="line">	oldbuckets unsafe.Pointer <span class="comment">// æ‰©å®¹åçš„æ—§bucketæ•°ç»„</span></span><br><span class="line">	nevacuate  <span class="type">uintptr</span>        <span class="comment">// è¿ç§»è®¡æ•°å™¨ï¼Œæ­¤æŒ‡é’ˆä¹‹å‰çš„æ‰€æœ‰æ¡¶å·²è¢«è¿ç§»ï¼Œå³nevacuateæŒ‡å‘æ¡¶æ•°ç»„å·²è¿ç§»æ¡¶çš„æœ€é«˜ä¸‹æ ‡</span></span><br><span class="line">	extra *mapextra <span class="comment">//æº¢å‡ºæ¡¶ç»“æ„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> bmap <span class="keyword">struct</span> &#123;</span><br><span class="line">	tophash [bucketCnt]<span class="type">uint8</span> <span class="comment">// bucketCnt == 8æ¯ä¸ªæ¡¶å›ºå®š8ä¸ªå…ƒç´ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><h3 id="make"><a href="#make" class="headerlink" title="make"></a>make</h3><p>é€šè¿‡makeå‡½æ•°å’ŒhintæŒ‡å®šå…ƒç´ æ•°é‡æ¥åˆå§‹åŒ–map</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>, hint)</span><br></pre></td></tr></table></figure><h3 id="å­—é¢é‡"><a href="#å­—é¢é‡" class="headerlink" title="å­—é¢é‡"></a>å­—é¢é‡</h3><p>ç›®å‰çš„ç°ä»£ç¼–ç¨‹è¯­è¨€åŸºæœ¬éƒ½æ”¯æŒä½¿ç”¨å­—é¢é‡çš„æ–¹å¼åˆå§‹åŒ–å“ˆå¸Œï¼Œä¸€èˆ¬éƒ½ä¼šä½¿ç”¨ key: value çš„è¯­æ³•æ¥è¡¨ç¤ºé”®å€¼å¯¹ï¼ŒGo è¯­è¨€ä¸­ä¹Ÿä¸ä¾‹å¤–ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hash := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;</span><br><span class="line">	<span class="string">&quot;1&quot;</span>: <span class="number">2</span>,</span><br><span class="line">	<span class="string">&quot;3&quot;</span>: <span class="number">4</span>,</span><br><span class="line">	<span class="string">&quot;5&quot;</span>: <span class="number">6</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡å°‘äºæˆ–è€…ç­‰äº 25 ä¸ªæ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å­—é¢é‡åˆå§‹åŒ–çš„ç»“æ„ä½“è½¬æ¢æˆä»¥ä¸‹çš„ä»£ç ï¼Œå°†æ‰€æœ‰çš„é”®å€¼å¯¹ä¸€æ¬¡åŠ å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hash := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>, <span class="number">3</span>)</span><br><span class="line">hash[<span class="string">&quot;1&quot;</span>] = <span class="number">2</span></span><br><span class="line">hash[<span class="string">&quot;3&quot;</span>] = <span class="number">4</span></span><br><span class="line">hash[<span class="string">&quot;5&quot;</span>] = <span class="number">6</span></span><br></pre></td></tr></table></figure><p>ä¸€æ—¦å“ˆå¸Œè¡¨ä¸­å…ƒç´ çš„æ•°é‡è¶…è¿‡äº† 25 ä¸ªï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨é”®å’Œå€¼ï¼Œè¿™äº›é”®å€¼å¯¹ä¼šé€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„ for å¾ªç¯åŠ å…¥å“ˆå¸Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hash := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>, <span class="number">26</span>)</span><br><span class="line">vstatk := []<span class="type">string</span>&#123;<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, ... ï¼Œ <span class="string">&quot;26&quot;</span>&#125;</span><br><span class="line">vstatv := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, ... , <span class="number">26</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(vstak); i++ &#123;</span><br><span class="line">    hash[vstatk[i]] = vstatv[i]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— è®ºæ˜¯<code>å­—é¢é‡</code>æˆ–æ˜¯<code>make</code>æ–¹å¼mapåº•å±‚éƒ½æ˜¯é€šè¿‡<code>makemap</code>å‡½æ•°æ¥åˆ›å»º</p><h3 id="makemap"><a href="#makemap" class="headerlink" title="makemap"></a>makemap</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makemap</span><span class="params">(t *maptype, hint <span class="type">int</span>, h *hmap)</span></span> *hmap &#123;</span><br><span class="line">	mem, overflow := math.MulUintptr(<span class="type">uintptr</span>(hint), t.bucket.size)</span><br><span class="line">	<span class="keyword">if</span> overflow || mem &gt; maxAlloc &#123;</span><br><span class="line">		hint = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// initialize Hmap</span></span><br><span class="line">	<span class="keyword">if</span> h == <span class="literal">nil</span> &#123;</span><br><span class="line">		h = <span class="built_in">new</span>(hmap)</span><br><span class="line">	&#125;</span><br><span class="line">	h.hash0 = fastrand()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find the size parameter B which will hold the requested # of elements.</span></span><br><span class="line">	<span class="comment">// For hint &lt; 0 overLoadFactor returns false since hint &lt; bucketCnt.</span></span><br><span class="line">	B := <span class="type">uint8</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> overLoadFactor(hint, B) &#123;</span><br><span class="line">		B++</span><br><span class="line">	&#125;</span><br><span class="line">	h.B = B</span><br><span class="line"></span><br><span class="line">	<span class="comment">// allocate initial hash table</span></span><br><span class="line">	<span class="comment">// if B == 0, the buckets field is allocated lazily later (in mapassign)</span></span><br><span class="line">	<span class="comment">// If hint is large zeroing this memory could take a while.</span></span><br><span class="line">	<span class="keyword">if</span> h.B != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> nextOverflow *bmap</span><br><span class="line">		h.buckets, nextOverflow = makeBucketArray(t, h.B, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">if</span> nextOverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">			h.extra = <span class="built_in">new</span>(mapextra)</span><br><span class="line">			h.extra.nextOverflow = nextOverflow</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>makemap</code> å‡½æ•°é€šè¿‡æŒ‡å®š<code>hint</code>æ¥é€šè¿‡<code>B</code>è®¡ç®—bucketæ•°é‡<br>è®¡ç®—å…¬å¼</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hint â‰¤ 2^B * 6.5</span><br></pre></td></tr></table></figure><p>é€šè¿‡Bæ•°é‡æŒ‡å®šhmapä¼šåˆ›å»º2^Bä¸ªæ¡¶å’Œä¸€äº›æº¢å‡ºæ¡¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> b &gt;= <span class="number">4</span> &#123;</span><br><span class="line">	<span class="comment">// Add on the estimated number of overflow buckets</span></span><br><span class="line">	<span class="comment">// required to insert the median number of elements</span></span><br><span class="line">	<span class="comment">// used with this value of b.</span></span><br><span class="line">	nbuckets += bucketShift(b - <span class="number">4</span>)</span><br><span class="line">	sz := t.bucket.size * nbuckets</span><br><span class="line">	up := roundupsize(sz)</span><br><span class="line">	<span class="keyword">if</span> up != sz &#123;</span><br><span class="line">		nbuckets = up / t.bucket.size</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“æ¡¶çš„æ•°é‡å°äº 2^4 æ—¶ï¼Œç”±äºæ•°æ®è¾ƒå°‘ã€ä½¿ç”¨æº¢å‡ºæ¡¶çš„å¯èƒ½æ€§è¾ƒä½ï¼Œä¼šçœç•¥åˆ›å»ºçš„è¿‡ç¨‹ä»¥å‡å°‘é¢å¤–å¼€é”€ï¼›</li><li>å½“æ¡¶çš„æ•°é‡å¤šäº 2^4 æ—¶ï¼Œä¼šé¢å¤–åˆ›å»º 2^ğµâˆ’4 ä¸ªæº¢å‡ºæ¡¶ï¼›</li></ul><h2 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h2><p>ä¸ºä»€ä¹ˆéœ€è¦æ‰©å®¹ï¼Œå½“<code>æº¢å‡ºæ¡¶</code>æ‰¿è£…å…ƒç´ è¶…è¿‡8ä¸ªæ—¶ï¼Œæº¢å‡ºæ¡¶çš„<code>mapextra</code>æŒ‡å‘æ–°çš„æº¢å‡ºæ¡¶ï¼Œç›´åˆ°èƒ½å¤Ÿæ»¡è¶³æ‰¿è£…å…ƒç´ æ•°ç›®,æ­¤æ—¶ï¼ŒhashæŸ¥æ‰¾ä¼šé€€åŒ–æˆé“¾è¡¨æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)<br>æ‰©å®¹åˆ¤æ–­æ¡ä»¶:</p><ul><li>å½“å‰æœªåœ¨æ‰©å®¹çŠ¶æ€å¹¶ä¸”è´Ÿè½½å› å­&gt;&#x3D;6.5</li><li>æœ‰å¤ªå¤šçš„<code>æº¢å‡ºæ¡¶</code><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> !h.growing() &amp;&amp; (overLoadFactor(h.count+<span class="number">1</span>, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) &#123;</span><br><span class="line">    hashGrow(t, h)</span><br><span class="line">    <span class="keyword">goto</span> again <span class="comment">// Growing the table invalidates everything, so try again</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> mapæ‰©å®¹ä¸ºæ¸è¿›å¼æ‰©å®¹ï¼Œåªåœ¨mapæ“ä½œå½“å‰æ¡¶æ—¶æ‰å¯¹å½“å‰æ¡¶è¿›è¡Œæ‰©å®¹<br>æ‰©å®¹æ­¥éª¤åˆ†ä¸º<code>hashGrow</code>å’Œ<code>growWork</code></li><li><code>hashGrow</code>ä¸åšæ¡¶å…ƒç´ è¿ç§»ï¼Œåªæ˜¯å°†å½“å‰æ¡¶æŒ‡å‘oldbucketsï¼Œç„¶ååˆ›å»ºç­‰é‡çš„bucketså’Œæº¢å‡ºæ¡¶ä½œä¸ºnewbucketsæŒ‡å‘hmap.buckets<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">h.B += bigger #æ›´æ–°B</span><br><span class="line">h.flags = flags #æ›´æ–°æ‰©å®¹çŠ¶æ€</span><br><span class="line">h.oldbuckets = oldbuckets</span><br><span class="line">h.buckets = newbuckets</span><br><span class="line">h.nevacuate = <span class="number">0</span> #æ‰©å®¹è®¡æ•°å™¨</span><br><span class="line">h.noverflow = <span class="number">0</span> #æº¢å‡ºæ¡¶æ•°é‡</span><br></pre></td></tr></table></figure></li><li>growWorkä¼šåœ¨å…ƒç´ èµ‹å€¼æ˜¯è§¦å‘å½“å‰æ¡¶æ“ä½œï¼Œç„¶åå¯¹å½“å‰æ¡¶è¿›è¡Œæ‰©å®¹,å°†å°†æ—§æ¡¶æ•°æ®é©±é€åˆ°æ–°æ¡¶,æ“ä½œæ­¥éª¤åœ¨growWork.evacuate</li></ul><p>evacuateé‡Œçš„æ‰©å®¹æ–¹å¼åˆ†ä¸ºç­‰é‡æ‰©å®¹å’Œéç­‰é‡æ‰©å®¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> !h.sameSizeGrow() &#123;</span><br><span class="line">    <span class="comment">// Only calculate y pointers if we&#x27;re growing bigger.</span></span><br><span class="line">    <span class="comment">// Otherwise GC can see bad pointers.</span></span><br><span class="line">    y := &amp;xy[<span class="number">1</span>]</span><br><span class="line">    y.b = (*bmap)(add(h.buckets, (oldbucket+newbit)*<span class="type">uintptr</span>(t.bucketsize)))</span><br><span class="line">    y.k = add(unsafe.Pointer(y.b), dataOffset)</span><br><span class="line">    y.e = add(y.k, bucketCnt*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç­‰é‡æ‰©å®¹"><a href="#ç­‰é‡æ‰©å®¹" class="headerlink" title="ç­‰é‡æ‰©å®¹"></a>ç­‰é‡æ‰©å®¹</h3><p>å¯¹hashåçš„keyåBä½è®¡ç®—æ¡¶å·ï¼Œç„¶åå°†å…ƒç´ ç­‰é‡åˆ†é…</p><p>ä¾‹å¦‚ï¼šhash(a)çš„äºŒè¿›åˆ¶ä¸º0101110001010110ï¼Œæ‰©å®¹å‰B&#x3D;2ï¼Œæ¡¶å·ä¸º10&#x3D;2ï¼Œæ‰©å®¹åæ¡¶å·ä¸º110ï¼Œæ¡¶å·ä¸º110&#x3D;6ï¼Œå°†å…ƒç´ å¹³å‡åˆ†é…åˆ°è¿™ä¸¤ä¸ªæ¡¶</p><h3 id="éç­‰é‡æ‰©å®¹"><a href="#éç­‰é‡æ‰©å®¹" class="headerlink" title="éç­‰é‡æ‰©å®¹"></a>éç­‰é‡æ‰©å®¹</h3><p>éç­‰é‡æ‰©å®¹ä¸æ‰©å®¹æ¡¶çš„æ•°é‡ï¼Œç”±äºä¹‹å‰äº§ç”Ÿè¿‡å¾ˆå¤šæº¢å‡ºæ¡¶ï¼Œä½†æ˜¯æº¢å‡ºæ¡¶çš„å…ƒç´ å¾ˆç¨€ç–ï¼Œæ‰€ä»¥åªæ˜¯å°†æ¡¶åºå·é‡æ–°æ•´ç†ï¼Œæ¸…åˆ°å¤šä½™çš„æº¢å‡ºæ¡¶ï¼Œç„¶åæ•´ç†åˆ°æ–°çš„bucketsï¼Œ</p><p>##æŸ¥æ‰¾å’Œå†™å…¥</p><h3 id="æŸ¥æ‰¾"><a href="#æŸ¥æ‰¾" class="headerlink" title="æŸ¥æ‰¾"></a>æŸ¥æ‰¾</h3><ul><li>æŸ¥æ‰¾ä¸»è¦åˆ†ä¸º<code>mapaccess1</code>å’Œ<code>mapaccess2</code>ä¸¤ä¸ªå‡½æ•°ï¼ŒåŒºåˆ«å°±æ˜¯<code>mapaccess2</code>åœ¨æ‰¾åˆ°ç›®æ ‡å€¼æ—¶ä¼šå¤šè¿”å›ä¸€ä¸ªtrueï¼Œåœ¨æœªæ‰¾åˆ°æ—¶ä¼šè¿”å›false</li><li>æŸ¥æ‰¾æµç¨‹hmapé‡Œé€šè¿‡tophashæ‰¾åˆ°å¯¹åº”bucketsæ¡¶å·,å†åˆ°bmapé‡ŒåŒºå¯»æ‰¾tophashé«˜8ä½å¯¹åº”çš„key,å¦‚æœä¸åœ¨å½“å‰æ¡¶å°±å»æº¢å‡ºæ¡¶é‡Œæ‰¾ï¼Œå¦‚æœæº¢å‡ºæ¡¶æ‰¾ä¸åˆ°è¯´æ˜å…ƒç´ ä¸åœ¨map,è¿”å›false</li><li>å¦‚æœæŸ¥æ‰¾æ—¶æ­£åœ¨æ‰©å®¹ï¼Œä¼šåˆ¤æ–­oldbucktesæ˜¯å¦ä¸ºnilï¼Œä¸ä¸ºnilæ‰¾æ—§æ¡¶ï¼Œç¼©å‡mæ‰¾åˆ°æ—§æ¡¶ç¼–å·å»æ‰¾æ—§æ¡¶å…ƒç´ ä½ç½®<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//hash&amp;mæ‰¾åˆ°æ¡¶ç¼–å·ä½œä¸ºåç§»å€¼æ‰¾åˆ°å¯¹åº”çš„bmapç»“æ„ä½“</span></span><br><span class="line">b := (*bmap)(add(h.buckets, (hash&amp;m)*<span class="type">uintptr</span>(t.bucketsize)))</span><br><span class="line"><span class="keyword">if</span> c := h.oldbuckets; c != <span class="literal">nil</span> &#123; 	<span class="comment">//å­˜åœ¨æ—§æ¡¶ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹çŠ¶æ€ä¸­</span></span><br><span class="line">	<span class="keyword">if</span> !h.sameSizeGrow() &#123; 			<span class="comment">//åˆ¤æ–­æ˜¯å¦ç¿»å€æ‰©å®¹</span></span><br><span class="line">		m &gt;&gt;= <span class="number">1</span> <span class="comment">//ç¿»å€æ‰©å®¹æ—¶ï¼Œæ–°çš„æ¡¶æ•°æ˜¯æ—§çš„2å€ï¼Œméœ€è¦å‡åŠæ‰èƒ½æ‰¾åˆ°æ—§æ¡¶ç¼–å·</span></span><br><span class="line">	&#125;</span><br><span class="line">	oldb := (*bmap)(add(c, (hash&amp;m)*<span class="type">uintptr</span>(t.bucketsize))) <span class="comment">//æ‰¾åˆ°å¯¹åº”çš„æ—§æ¡¶ä½ç½®</span></span><br><span class="line">	<span class="keyword">if</span> !evacuated(oldb) &#123;</span><br><span class="line">		b = oldb <span class="comment">//å¦‚æœæ—§æ¡¶æ²¡æœ‰å®Œæˆæ•°æ®è¿ç§»ï¼Œé‚£ä¹ˆæ›´æ–°bæŒ‡å‘æ—§æ¡¶bmap</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">top := tophash(hash) <span class="comment">//å–hashå€¼é«˜å…«ä½ï¼Œå› ä¸ºbmp.tophashä¸­0-4æ˜¯æ ‡å¿—ä½ï¼Œæ‰€ä»¥hashå€¼å°äº5çš„è‡ªåŠ¨åŠ 5</span></span><br><span class="line"> bucketloop:</span><br><span class="line"> <span class="comment">//éå†å½“å‰bmpå’Œæº¢å‡ºæ¡¶</span></span><br><span class="line"> ...</span><br></pre></td></tr></table></figure></li></ul><h3 id="å†™å…¥"><a href="#å†™å…¥" class="headerlink" title="å†™å…¥"></a>å†™å…¥</h3><ul><li>å‡½æ•°é¦–å…ˆä¼šæ£€æŸ¥ <code>map</code> çš„æ ‡å¿—ä½ <code>flags</code>ã€‚å¦‚æœ <code>flags</code> çš„å†™æ ‡å¿—ä½æ­¤æ—¶è¢«ç½® 1 äº†ï¼Œè¯´æ˜æœ‰å…¶ä»–åç¨‹åœ¨æ‰§è¡Œâ€œå†™â€æ“ä½œï¼Œè¿›è€Œå¯¼è‡´ç¨‹åº <code>panic</code>ã€‚è¿™ä¹Ÿè¯´æ˜äº† <code>map</code> å¯¹åç¨‹æ˜¯ä¸å®‰å…¨çš„ã€‚</li><li>æ‰©å®¹æ˜¯æ¸è¿›å¼çš„ï¼Œå¦‚æœ <code>map</code> å¤„åœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œé‚£ä¹ˆå½“ <code>key</code> å®šä½åˆ°äº†æŸä¸ª <code>bucket</code> åï¼Œéœ€è¦ç¡®ä¿è¿™ä¸ª <code>bucket</code> å¯¹åº”çš„è€ <code>bucket</code> å®Œæˆäº†è¿ç§»è¿‡ç¨‹ã€‚å³è€ <code>bucket</code> é‡Œçš„ <code>key</code> éƒ½è¦è¿ç§»åˆ°æ–°çš„ <code>bucket</code> ä¸­æ¥ï¼ˆåˆ†è£‚åˆ° 2 ä¸ªæ–° <code>bucket</code>ï¼‰ï¼Œæ‰èƒ½åœ¨æ–°çš„ <code>bucket</code> ä¸­è¿›è¡Œæ’å…¥æˆ–è€…æ›´æ–°çš„æ“ä½œã€‚<br>ä¸Šé¢è¯´çš„æ“ä½œæ˜¯åœ¨å‡½æ•°é å‰çš„ä½ç½®è¿›è¡Œçš„ï¼Œåªæœ‰è¿›è¡Œå®Œäº†è¿™ä¸ªæ¬è¿æ“ä½œåï¼Œæˆ‘ä»¬æ‰èƒ½æ”¾å¿ƒåœ°åœ¨æ–° <code>bucket</code> é‡Œå®šä½ <code>key</code> è¦å®‰ç½®çš„åœ°å€ï¼Œå†è¿›è¡Œä¹‹åçš„æ“ä½œã€‚</li><li>å¦‚æœè¿™ä¸ª <code>bucket</code> çš„ <code>8</code> ä¸ª <code>key</code> éƒ½å·²ç»æ”¾ç½®æ»¡äº†ï¼Œé‚£åœ¨è·³å‡ºå¾ªç¯åï¼Œå‘ç° <code>inserti</code> å’Œ <code>insertk</code> éƒ½æ˜¯ç©ºï¼Œè¿™æ—¶å€™éœ€è¦åœ¨ <code>bucket</code> åé¢æŒ‚ä¸Š <code>overflow bucket</code>ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯åœ¨ <code>overflow bucket</code> åé¢å†æŒ‚ä¸Šä¸€ä¸ª <code>overflow bucket</code>ã€‚è¿™å°±è¯´æ˜ï¼Œå¤ªå¤š <code>key hash</code> åˆ°äº†æ­¤ <code>bucket</code>ã€‚<br>åœ¨æ­£å¼å®‰ç½® <code>key</code> ä¹‹å‰ï¼Œè¿˜è¦æ£€æŸ¥ <code>map</code> çš„çŠ¶æ€ï¼Œçœ‹å®ƒæ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚å¦‚æœæ»¡è¶³æ‰©å®¹çš„æ¡ä»¶ï¼Œå°±ä¸»åŠ¨è§¦å‘ä¸€æ¬¡æ‰©å®¹æ“ä½œã€‚</li></ul><h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h3><ul><li>é¦–å…ˆä¼šæ£€æŸ¥ <code>h.flags</code> æ ‡å¿—ï¼Œå¦‚æœå‘ç°å†™æ ‡ä½æ˜¯ 1ï¼Œç›´æ¥ <code>panic</code>ï¼Œå› ä¸ºè¿™è¡¨æ˜æœ‰å…¶ä»–åç¨‹åŒæ—¶åœ¨è¿›è¡Œå†™æ“ä½œã€‚</li><li>è®¡ç®— key çš„å“ˆå¸Œï¼Œæ‰¾åˆ°è½å…¥çš„ <code>bucket</code>ã€‚æ£€æŸ¥æ­¤ <code>map</code> å¦‚æœæ­£åœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œç›´æ¥è§¦å‘ä¸€æ¬¡æ¬è¿æ“ä½œã€‚</li><li>åˆ é™¤æ“ä½œåŒæ ·æ˜¯ä¸¤å±‚å¾ªç¯ï¼Œæ ¸å¿ƒè¿˜æ˜¯æ‰¾åˆ° <code>key</code> çš„å…·ä½“ä½ç½®ã€‚å¯»æ‰¾è¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œåœ¨ <code>bucket</code> ä¸­æŒ¨ä¸ª <code>cell</code> å¯»æ‰¾ã€‚</li><li>æ‰¾åˆ°å¯¹åº”ä½ç½®åï¼Œå¯¹ <code>key</code> æˆ–è€… <code>value</code> è¿›è¡Œâ€œæ¸…é›¶â€æ“ä½œï¼š æœ€åï¼Œå°† <code>count</code> å€¼å‡ <code>1</code>ï¼Œå°†å¯¹åº”ä½ç½®çš„ <code>tophash</code> å€¼ç½®æˆ <code>Empty</code>ã€‚</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2023/01/15/2023-01-17-sync-map%E5%8E%9F%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2023/01/15/2023-01-17-sync-map%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">GO SYNC MAPåŸç†</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2023-01-15 19:30:00" itemprop="dateCreated datePublished" datetime="2023-01-15T19:30:00+08:00">2023-01-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="SYNC-MAP"><a href="#SYNC-MAP" class="headerlink" title="SYNC MAP"></a>SYNC MAP</h2><p>mapä¸æ”¯æŒå¹¶å‘è¯»å†™ï¼ŒåŸå› æ˜¯:</p><ul><li>mapåº•å±‚çš„<code>hmap</code>çš„<code>flags</code>åšäº†çŠ¶æ€æ ‡å¿—ï¼Œå¹¶å‘è¯»å†™ä¼španic</li><li>åº•å±‚æ§åˆ¶çš„æœ¬è´¨æ˜¯é˜²æ­¢æ‰©å®¹æ—¶ï¼Œè¯»mapæ“ä½œè¯»åˆ°æ—§æ¡¶ï¼Œå†™mapæ­£åœ¨åšæ‰©å®¹è¿ç§»ï¼Œå°†æ—§æ¡¶æ•°æ®è¿ç§»åˆ°æ–°æ¡¶ï¼Œä»è€Œé€ æˆæ•°æ®è¯»å–ä¸æ­£ç¡®</li></ul><h3 id="è§£å†³mapå¹¶å‘é—®é¢˜"><a href="#è§£å†³mapå¹¶å‘é—®é¢˜" class="headerlink" title="è§£å†³mapå¹¶å‘é—®é¢˜"></a>è§£å†³mapå¹¶å‘é—®é¢˜</h3><h4 id="åŠ é”-mutex"><a href="#åŠ é”-mutex" class="headerlink" title="åŠ é”(mutex)"></a>åŠ é”(mutex)</h4><p>åŠ é”ä¼šå¯¼è‡´åŒä¸€æ—¶åˆ»åªèƒ½ä¸€ä¸ªåç¨‹å°±æ“ä½œmap,æ€§èƒ½æ¯”è¾ƒå·®</p><h4 id="sync-map"><a href="#sync-map" class="headerlink" title="sync map"></a>sync map</h4><p>mapç»“æ„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu Mutex</span><br><span class="line">	read atomic.Value <span class="comment">// readOnly</span></span><br><span class="line">	dirty <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry</span><br><span class="line">	misses <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> readOnly <span class="keyword">struct</span> &#123;</span><br><span class="line">    m       <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry</span><br><span class="line">    amended <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    p unsafe.Pointer <span class="comment">// *interface&#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2023-01-17/syncmap.png" alt="map struct"></p><h5 id="æ­£å¸¸è¯»å†™"><a href="#æ­£å¸¸è¯»å†™" class="headerlink" title="æ­£å¸¸è¯»å†™"></a>æ­£å¸¸è¯»å†™</h5><p>æ­£å¸¸è¯»å†™æ“ä½œ<code>read map</code>ï¼Œå¯¹mapè¿›è¡Œè¯»å–æ·»åŠ æˆ–ä¿®æ”¹æ“ä½œ</p><h5 id="è¿½åŠ "><a href="#è¿½åŠ " class="headerlink" title="è¿½åŠ "></a>è¿½åŠ </h5><p>æ¯”å¦‚è¿½åŠ çš„d&#x3D;&gt;Dçš„kv:</p><p>å…ˆå»<code>read map</code>æŸ¥æ‰¾æœ‰æ²¡æœ‰<code>d</code>,éœ€è¦å¯¹<code>dirty map</code>ä¸Š<code>mutex</code>é”,é˜²æ­¢å…¶ä»–åç¨‹æ“ä½œ<code>dirty map</code>ï¼Œç„¶ååœ¨<code>dirty map</code>è¿½åŠ <code>d</code>ï¼Œå¹¶å°†d.entryæŒ‡å‘<code>ä¸‡èƒ½æŒ‡é’ˆ</code>,ç”±<code>ä¸‡èƒ½æŒ‡é’ˆ</code>æŒ‡å‘å¯¹åº”çš„å€¼<br>åŒæ—¶å°†<code>readmap</code>çš„<code>amended</code>èµ‹å€¼ä¸º<code>true</code><br><img src="/img/in-post/2023-01-17/mapappend.png" alt="append map"></p><p><img src="/img/in-post/2023-01-17/appendsuccess.png" alt="append map success"></p><h5 id="è¿½åŠ åçš„è¯»"><a href="#è¿½åŠ åçš„è¯»" class="headerlink" title="è¿½åŠ åçš„è¯»"></a>è¿½åŠ åçš„è¯»</h5><p>å…ˆå»<code>read map</code>å»çœ‹æœ‰æ²¡æœ‰è¯¥<code>k</code>ï¼Œæ²¡æœ‰æ£€æŸ¥<code>amended</code>ï¼Œå¦‚æœä¸º<code>true</code>åˆ™å»æŸ¥<code>dirty map</code>,å¹¶å°†<code>misses++</code>,å½“<code>misses</code>åŠ åˆ°å’Œ<code>dirty map</code> kvæ•°é‡ç›¸ç­‰æ—¶ï¼Œæå‡<code>dirty map</code>ä¸º<code>read map</code></p><p>sync map dirtyæå‡æµç¨‹:<br><img src="/img/in-post/2023-01-17/dirtyup.png" alt="remove read map"><br><img src="/img/in-post/2023-01-17/dirtyup1.png" alt="dirty map up"></p><p>å½“å†ä¸€æ¬¡è¿½åŠ æ–°å…ƒç´ æ—¶ä¼šé‡å»º<code>dirty map</code><br><img src="/img/in-post/2023-01-17/dirtyup2.png" alt="rebuild dirty map"></p><h5 id="è¿½åŠ åå†åˆ é™¤"><a href="#è¿½åŠ åå†åˆ é™¤" class="headerlink" title="è¿½åŠ åå†åˆ é™¤"></a>è¿½åŠ åå†åˆ é™¤</h5><ul><li>æ­£å¸¸åˆ é™¤dï¼š<br>æ­£å¸¸åˆ é™¤ä¸»è¦æ“ä½œ<code>read map</code>,åˆ é™¤æµç¨‹å‚è€ƒä¸‹å›¾<br> <img src="/img/in-post/2023-01-17/delete.png" alt="delete"></li><li>è¿½åŠ dåå†æ¬¡åˆ é™¤dï¼š<br>å…ˆå»<code>read map</code>å»çœ‹æœ‰æ²¡æœ‰è¯¥<code>k</code>,æ²¡æœ‰æ£€æŸ¥<code>amended</code>ï¼Œå¦‚æœä¸º<code>true</code>åŠ é”ï¼Œå»<code>dirty map</code>æŸ¥æ‰¾,æ‰¾åˆ°ååˆ é™¤k,å¹¶å°†<code>pointer</code>æŒ‡å‘<code>nil</code><br><img src="/img/in-post/2023-01-17/img_7.png" alt="append delete"><br>ç„¶åå°†<code>dirty map</code>æå‡è‡³<code>read map</code>,<code>amended</code>æ”¹ä¸ºfalse<br><img src="/img/in-post/2023-01-17/img_6.png" alt="append delete dirty up"><br>æœ€åä¸‹æ¬¡è¿½åŠ æ—¶é‡å»º<code>dirty map</code><br><img src="/img/in-post/2023-01-17/img_5.png" alt="append delete rebuild dirty"><br>é‡å»º<code>dirty map</code>æ—¶ï¼Œç”±äº<code>read map</code>æ­¤æ—¶<code>d</code>æŒ‡å‘<code>nil</code>ï¼Œæ‰€ä»¥é‡å»º<code>dirty map</code>ä¸ä¼šé‡å»º<code>d</code><br>ä¹‹åæ“ä½œ<code>read map</code>,å¹¶å°†<code>d</code>æ ‡è®°ä¸º<code>expunged</code>ï¼Œæé†’åé¢æ“ä½œ<code>read map</code>çš„dæ—¶ï¼Œä¸ç”¨æ”¹ä¸º<code>nil</code>ï¼Œç›´æ¥ä»<code>map</code>å½“å‰<code>buckets</code>åˆ é™¤</li></ul><blockquote><p>ç”±äºsync mapåªæœ‰åœ¨è¿½åŠ æ—¶æ‰ä¼šæ“ä½œ<code>dirty map</code>ï¼Œæ‰€ä»¥å¯ç†è§£è¿½åŠ ã€è¯»å†™åˆ†ç¦»</p></blockquote><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>mapåœ¨æ‰©å®¹æ—¶å­˜åœ¨å¹¶å‘é—®é¢˜</li><li>sync mapä½¿ç”¨<code>dirty map</code>å’Œ<code>read map</code>è§£å†³æ‰©å®¹é—®é¢˜</li><li>ä¸å­˜åœ¨æ‰©å®¹æ“ä½œæ—¶ç›´æ¥è¯»å†™<code>read map</code></li><li>å­˜åœ¨æ‰©å®¹æ“ä½œæ—¶æ“ä½œ<code>dirty map</code></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/12/01/2022-12-01-mysql-per-analysis/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/12/01/2022-12-01-mysql-per-analysis/" class="post-title-link" itemprop="url">mysqlè¯­å¥æŸ¥è¯¢æ€§èƒ½åˆ†æ</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-12-01 19:30:00" itemprop="dateCreated datePublished" datetime="2022-12-01T19:30:00+08:00">2022-12-01</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœè°ˆèµ·æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ï¼Œå¤šæ•°äººçš„ç¬¬ä¸€æ„ŸçŸ¥éƒ½æ˜¯æƒ³åˆ°ä¸€äº›å¤æ‚çš„è¯­å¥ï¼Œæƒ³åˆ°æŸ¥è¯¢éœ€è¦è¿”å›å¤§é‡çš„æ•°æ®ã€‚<br>ä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œâ€œæŸ¥ä¸€è¡Œâ€ï¼Œä¹Ÿä¼šæ‰§è¡Œå¾—ç‰¹åˆ«æ…¢ã€‚ä»Šå¤©ï¼Œå°±æ¥æ¢è®¨è¿™ä¸ªé—®é¢˜ï¼Œçœ‹çœ‹ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œä¼šå‡ºç°è¿™ä¸ªç°è±¡ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœ MySQL æ•°æ®åº“æœ¬èº«å°±æœ‰å¾ˆå¤§çš„å‹åŠ›ï¼Œå¯¼è‡´æ•°æ®åº“æœåŠ¡å™¨ CPU å ç”¨ç‡å¾ˆé«˜æˆ– ioutilï¼ˆIO åˆ©ç”¨ç‡ï¼‰å¾ˆé«˜ï¼Œ<br>è¿™ç§æƒ…å†µä¸‹æ‰€æœ‰è¯­å¥çš„æ‰§è¡Œéƒ½æœ‰å¯èƒ½å˜æ…¢ï¼Œä¸å±äºä»Šå¤©çš„æ¢è®¨èŒƒå›´ã€‚</p><h2 id="æ­£é¢˜"><a href="#æ­£é¢˜" class="headerlink" title="æ­£é¢˜"></a>æ­£é¢˜</h2><p>é¦–å…ˆï¼Œå…ˆåšä¸€ä¸ªæµ‹è¯•è¡¨åœ¨æ’å…¥1ä¸‡æ¡æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `t1` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `c` int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB;</span><br><span class="line"></span><br><span class="line">delimiter ;;</span><br><span class="line">create procedure idata()</span><br><span class="line">begin</span><br><span class="line">  declare i int;</span><br><span class="line">  set i=1;</span><br><span class="line">  while(i&lt;=10000)do</span><br><span class="line">    insert into t1 values(i,i);</span><br><span class="line">    set i=i+1;</span><br><span class="line">  end while;</span><br><span class="line">end;;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">call idata();</span><br></pre></td></tr></table></figure><h3 id="å‡ ç§åœºæ™¯ç±»å‹åˆ†æ"><a href="#å‡ ç§åœºæ™¯ç±»å‹åˆ†æ" class="headerlink" title="å‡ ç§åœºæ™¯ç±»å‹åˆ†æ"></a>å‡ ç§åœºæ™¯ç±»å‹åˆ†æ</h3><h4 id="ç¬¬ä¸€ç±»ï¼šæŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›"><a href="#ç¬¬ä¸€ç±»ï¼šæŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›" class="headerlink" title="ç¬¬ä¸€ç±»ï¼šæŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›"></a>ç¬¬ä¸€ç±»ï¼šæŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›</h4><p>æ‰§è¡Œä¸‹é¢çš„sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t1 where id=1;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢é•¿æ—¶é—´ä¸è¿”å›</p><p><img src="https://enpsl.github.io/img/in-post/2018-12-01/1.png"></p><p>ä¸€èˆ¬ç¢°åˆ°è¿™ç§æƒ…å†µçš„è¯ï¼Œå¤§æ¦‚ç‡æ˜¯è¡¨ t1 è¢«é”ä½äº†ã€‚æ¥ä¸‹æ¥åˆ†æåŸå› çš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½æ˜¯é¦–å…ˆæ‰§è¡Œä¸€ä¸‹ show processlist å‘½ä»¤ï¼Œçœ‹çœ‹å½“å‰è¯­å¥å¤„äºä»€ä¹ˆçŠ¶æ€ã€‚</p><p>ç„¶åå†æ ¹æ®çŠ¶æ€å»åˆ†æäº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠèƒ½å¦å¤ç°</p><p><strong>ç­‰MDLé”</strong></p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå°±æ˜¯ä½¿ç”¨ show processlist å‘½ä»¤æŸ¥çœ‹ Waiting for table metadata lock çš„ç¤ºæ„å›¾ã€‚<br><img src="https://enpsl.github.io/img/in-post/2018-12-01/2.png"><br>è¿™ä¸ªçŠ¶æ€è¡¨ç¤ºçš„æ˜¯ï¼Œç°åœ¨<strong>æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¡¨ t1 ä¸Šè¯·æ±‚æˆ–è€…æŒæœ‰ MDL å†™é”ï¼ŒæŠŠ select è¯­å¥å µä½äº†ã€‚</strong></p><p>ä¸è¿‡ï¼Œåœ¨ MySQL 5.7 ç‰ˆæœ¬ä¸‹å¤ç°è¿™ä¸ªåœºæ™¯ï¼Œä¹Ÿå¾ˆå®¹æ˜“ã€‚</p><table><tr><th>SessionA</th><th>SessionB</th></tr><tr><td>lock table t1 write</td><td></td></tr><tr><td></td><td>select * from t1 where id=1;</td></tr></table><p>session A é€šè¿‡ lock table å‘½ä»¤æŒæœ‰è¡¨ t1 çš„ MDL å†™é”ï¼Œè€Œ session B çš„æŸ¥è¯¢éœ€è¦è·å– MDL è¯»é”ã€‚æ‰€ä»¥ï¼Œsession B è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p><p>è¿™ç±»é—®é¢˜çš„å¤„ç†æ–¹å¼ï¼Œå°±æ˜¯æ‰¾åˆ°è°æŒæœ‰ MDL å†™é”ï¼Œç„¶åæŠŠå®ƒ kill æ‰ã€‚</p><p>ä½†æ˜¯ï¼Œç”±äºåœ¨ show processlist çš„ç»“æœé‡Œé¢ï¼Œsession A çš„ Command åˆ—æ˜¯â€œSleepâ€ï¼Œå¯¼è‡´æŸ¥æ‰¾èµ·æ¥å¾ˆä¸æ–¹ä¾¿ã€‚ä¸è¿‡æœ‰äº† performance_schema å’Œ sys ç³»ç»Ÿåº“ä»¥åï¼Œå°±æ–¹ä¾¿å¤šäº†ã€‚ï¼ˆMySQL å¯åŠ¨æ—¶éœ€è¦è®¾ç½® performance_schema&#x3D;onï¼Œç›¸æ¯”äºè®¾ç½®ä¸º off ä¼šæœ‰ 10% å·¦å³çš„æ€§èƒ½æŸå¤±)</p><p>æŸ¥çœ‹æ˜¯å¦æ”¯æŒperformance_schema</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.engines <span class="keyword">where</span> engine <span class="operator">=</span><span class="string">&#x27;performance_schema&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://enpsl.github.io/img/in-post/2018-12-01/3.png"><br>æ˜¯å¦å¼€å¯performance_schema</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;performance_schema&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://enpsl.github.io/img/in-post/2018-12-01/4.png"></p><p>é€šè¿‡æŸ¥è¯¢ sys.schema_table_lock_waits è¿™å¼ è¡¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ‰¾å‡ºé€ æˆé˜»å¡çš„ process idï¼ŒæŠŠè¿™ä¸ªè¿æ¥ç”¨ kill å‘½ä»¤æ–­å¼€å³å¯ã€‚</p><p><strong>ç­‰FLUSH</strong></p><p>å¦ä¸€ç§åœºæ™¯<br>æˆ‘åœ¨è¡¨t1ä¸Šæ‰§è¡Œè¿™æ ·ä¸€æ¡sql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from information_schema.processlist where id=1;</span><br></pre></td></tr></table></figure><p>æŸ¥å‡ºæ¥è¿™ä¸ªçº¿ç¨‹çš„çŠ¶æ€æ˜¯ Waiting for table flush</p><p>è¿™ä¸ªçŠ¶æ€è¡¨ç¤ºçš„æ˜¯ï¼Œç°åœ¨æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£è¦å¯¹è¡¨ t1 åš flush æ“ä½œã€‚MySQL é‡Œé¢å¯¹è¡¨åš flush æ“ä½œçš„ç”¨æ³•ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸¤ä¸ªï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flush tables t1 with read lock;</span><br><span class="line">flush tables with read lock;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ª flush è¯­å¥ï¼Œå¦‚æœæŒ‡å®šè¡¨ t1 çš„è¯ï¼Œä»£è¡¨çš„æ˜¯åªå…³é—­è¡¨ t1ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®šå…·ä½“çš„è¡¨åï¼Œåˆ™è¡¨ç¤ºå…³é—­ MySQL é‡Œæ‰€æœ‰æ‰“å¼€çš„è¡¨ã€‚</p><p>ä½†æ˜¯æ­£å¸¸è¿™ä¸¤ä¸ªè¯­å¥æ‰§è¡Œèµ·æ¥éƒ½å¾ˆå¿«ï¼Œé™¤éå®ƒä»¬ä¹Ÿè¢«åˆ«çš„çº¿ç¨‹å µä½äº†ã€‚</p><p>æ‰€ä»¥ï¼Œå‡ºç° Waiting for table flush çŠ¶æ€çš„å¯èƒ½æƒ…å†µæ˜¯ï¼šæœ‰ä¸€ä¸ª flush tables å‘½ä»¤è¢«åˆ«çš„è¯­å¥å µä½äº†ï¼Œç„¶åå®ƒåˆå µä½äº†æˆ‘ä»¬çš„ select è¯­å¥ã€‚</p><p>å¤ç°ä¸€ä¸‹è¿™ç§æƒ…å†µ:</p><table><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr><tr><td>select sleep(1) from t1</td><td></td><td></td></tr><tr><td></td><td>flush table t1</td><td></td></tr><tr><td></td><td></td><td>select * from t1 where id=1;</td></tr></table> åœ¨ session A ä¸­ï¼Œæˆ‘æ•…æ„æ¯è¡Œéƒ½è°ƒç”¨ä¸€æ¬¡ sleep(1)ï¼Œè¿™æ ·è¿™ä¸ªè¯­å¥é»˜è®¤è¦æ‰§è¡Œ 1 ä¸‡ç§’ï¼Œåœ¨è¿™æœŸé—´è¡¨ t ä¸€ç›´æ˜¯è¢« session Aâ€œæ‰“å¼€â€ç€ã€‚ç„¶åï¼Œsession B çš„ flush tables t å‘½ä»¤å†è¦å»å…³é—­è¡¨ tï¼Œå°±éœ€è¦ç­‰ session A çš„æŸ¥è¯¢ç»“æŸã€‚è¿™æ ·ï¼Œsession C è¦å†æ¬¡æŸ¥è¯¢çš„è¯ï¼Œå°±ä¼šè¢« flush å‘½ä»¤å µä½äº†ã€‚<p>ä¸‹é¢æ˜¯show processlist ç»“æœ<br> <img src="https://enpsl.github.io/img/in-post/2018-12-01/5.png"></p><p> <strong>ç­‰è¡Œé”</strong></p><p>ç°åœ¨ï¼Œç»è¿‡äº†è¡¨çº§é”çš„è€ƒéªŒï¼Œæˆ‘ä»¬çš„ select è¯­å¥ç»ˆäºæ¥åˆ°å¼•æ“é‡Œäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t1 where id=1 lock in share mode; </span><br></pre></td></tr></table></figure><p>ç”±äºè®¿é—® id&#x3D;1 è¿™ä¸ªè®°å½•æ—¶è¦åŠ è¯»é”ï¼Œå¦‚æœè¿™æ—¶å€™å·²ç»æœ‰ä¸€ä¸ªäº‹åŠ¡åœ¨è¿™è¡Œè®°å½•ä¸ŠæŒæœ‰ä¸€ä¸ªå†™é”ï¼Œæˆ‘ä»¬çš„ select è¯­å¥å°±ä¼šè¢«å µä½ã€‚</p><p>è¡Œé”æ“ä½œå¤ç°:</p><table><tr><th>SessionA</th><th>SessionB</th></tr><tr><td>begin;<br>update t1 set c=c+1 where id=1;</td><td></td></tr><tr><td></td><td>select * from t1 where id=1 lock in share mode;</td></tr></table> ä¸‹é¢æ˜¯show processlist ç»“æœ<p> <img src="https://enpsl.github.io/img/in-post/2018-12-01/6.png"></p><p>æ˜¾ç„¶ï¼Œsession A å¯åŠ¨äº†äº‹åŠ¡ï¼Œå æœ‰å†™é”ï¼Œè¿˜ä¸æäº¤ï¼Œæ˜¯å¯¼è‡´ session B è¢«å µä½çš„åŸå› ã€‚</p><p>è¿™ä¸ªé—®é¢˜å¹¶ä¸éš¾åˆ†æï¼Œä½†é—®é¢˜æ˜¯æ€ä¹ˆæŸ¥å‡ºæ˜¯è°å ç€è¿™ä¸ªå†™é”ã€‚å¦‚æœä½ ç”¨çš„æ˜¯ MySQL 5.7 ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ sys.innodb_lock_waits è¡¨æŸ¥åˆ°ã€‚</p><p>æŸ¥è¯¢æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t1 sys.innodb_lock_waits where locked_table=&#x27;`test`.`t1`&#x27;\G</span><br></pre></td></tr></table></figure><p> <img src="https://enpsl.github.io/img/in-post/2018-12-01/8.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªä¿¡æ¯å¾ˆå…¨ï¼Œ9957 å·çº¿ç¨‹æ˜¯é€ æˆå µå¡çš„ç½ªé­ç¥¸é¦–ã€‚è€Œå¹²æ‰è¿™ä¸ªç½ªé­ç¥¸é¦–çš„æ–¹å¼ï¼Œå°±æ˜¯ KILL QUERY 9957 æˆ– KILL 9957ã€‚</p><p>ä¸è¿‡ï¼Œè¿™é‡Œä¸åº”è¯¥æ˜¾ç¤ºâ€œKILL QUERY 9957â€ã€‚è¿™ä¸ªå‘½ä»¤è¡¨ç¤ºåœæ­¢ 9957 å·çº¿ç¨‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„è¯­å¥ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯æ²¡æœ‰ç”¨çš„ã€‚å› ä¸ºå æœ‰è¡Œé”çš„æ˜¯ update è¯­å¥ï¼Œè¿™ä¸ªè¯­å¥å·²ç»æ˜¯ä¹‹å‰æ‰§è¡Œå®Œæˆäº†çš„ï¼Œç°åœ¨æ‰§è¡Œ KILL QUERYï¼Œæ— æ³•è®©è¿™ä¸ªäº‹åŠ¡å»æ‰ id&#x3D;1 ä¸Šçš„è¡Œé”ã€‚</p><p>å®é™…ä¸Šï¼ŒKILL 9957 æ‰æœ‰æ•ˆï¼Œä¹Ÿå°±æ˜¯è¯´ç›´æ¥æ–­å¼€è¿™ä¸ªè¿æ¥ã€‚è¿™é‡Œéšå«çš„ä¸€ä¸ªé€»è¾‘å°±æ˜¯ï¼Œè¿æ¥è¢«æ–­å¼€çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å›æ»šè¿™ä¸ªè¿æ¥é‡Œé¢æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œä¹Ÿå°±é‡Šæ”¾äº† id&#x3D;1 ä¸Šçš„è¡Œé”ã€‚</p><h4 id="ç¬¬äºŒç±»ï¼šæŸ¥è¯¢æ…¢"><a href="#ç¬¬äºŒç±»ï¼šæŸ¥è¯¢æ…¢" class="headerlink" title="ç¬¬äºŒç±»ï¼šæŸ¥è¯¢æ…¢"></a>ç¬¬äºŒç±»ï¼šæŸ¥è¯¢æ…¢</h4><p>ç»è¿‡äº†é‡é‡å°â€œé”â€ï¼Œå†æ¥çœ‹çœ‹ä¸€äº›æŸ¥è¯¢æ…¢çš„ä¾‹å­</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c<span class="operator">=</span><span class="number">9000</span> limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>ç”±äºå­—æ®µ c ä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œè¿™ä¸ªè¯­å¥åªèƒ½èµ° id ä¸»é”®é¡ºåºæ‰«æï¼Œå› æ­¤éœ€è¦æ‰«æ 5 åƒè¡Œã€‚</p><p>é€šè¿‡slow_log çœ‹ä¸€ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log<span class="operator">=</span><span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">set</span> long_query_time<span class="operator">=</span><span class="number">0</span>;  #æˆ‘ä»¬è®©æ‰€æœ‰æŸ¥è¯¢éƒ½åŠ å…¥åˆ°slow_logä¸­</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%slow%&#x27;</span>;</span><br></pre></td></tr></table></figure><p> <img src="https://enpsl.github.io/img/in-post/2018-12-01/10.png"></p><p> slow_logç»“æœ</p><p> <img src="https://enpsl.github.io/img/in-post/2018-12-01/11.png"></p><p>Rows_examined æ˜¾ç¤ºæ‰«æäº† 9000 è¡Œã€‚ä½ å¯èƒ½ä¼šè¯´ï¼Œä¸æ˜¯å¾ˆæ…¢å‘€ï¼Œ6 æ¯«ç§’å°±è¿”å›äº†ï¼Œæˆ‘ä»¬çº¿ä¸Šä¸€èˆ¬éƒ½é…ç½®è¶…è¿‡ 1 ç§’æ‰ç®—æ…¢æŸ¥è¯¢ã€‚ä½†ä½ è¦è®°ä½ï¼š<br><strong>åæŸ¥è¯¢ä¸ä¸€å®šæ˜¯æ…¢æŸ¥è¯¢</strong>ã€‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­é‡Œé¢åªæœ‰ 1 ä¸‡è¡Œè®°å½•ï¼Œæ•°æ®é‡å¤§èµ·æ¥çš„è¯ï¼Œæ‰§è¡Œæ—¶é—´å°±çº¿æ€§æ¶¨ä¸Šå»äº†ã€‚</p><p>æ‰«æè¡Œæ•°å¤šï¼Œæ‰€ä»¥æ‰§è¡Œæ…¢ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚</p><p>ä½†æ˜¯æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸ªåªæ‰«æä¸€è¡Œï¼Œä½†æ˜¯æ‰§è¡Œå¾ˆæ…¢çš„è¯­å¥ã€‚</p><p>çœ‹ä¸‹é¢çš„ä¾‹å­</p><table><tr><th>SessionA</th><th>SessionB</th></tr><tr><td>start transaction with consistent snapshot;</td><td></td></tr><tr><td></td><td>update t1 set c=c+1 where id=1;//æ‰§è¡Œ100ä¸‡æ¬¡</td></tr><tr><td>select * from t1 where id = 1;</td><td></td></tr><tr><td>select * from t1 where id = 1 lock in share mode;</td><td></td></tr></table> å…ˆçœ‹çœ‹æ‰§è¡Œä¸€æ¬¡çš„ç»“æœ<p><img src="https://enpsl.github.io/img/in-post/2018-12-01/12.png"></p><p>ç”±æ­¤å¯æ¨å‡ºSessionBæ‰§è¡Œ100ä¸‡æ¬¡åç»“æœ<br>select * from t1 where id &#x3D; 1 lock in share mode;</p><table style="width:15%"><tr><th>id</th><th>c</th></tr><tr><td>1</td><td>1000001</td></tr></table> 1 row in set (0.00 sec)<p>æ­¤æ—¶ï¼Œsession A å…ˆç”¨ start transaction with consistent snapshot å‘½ä»¤å¯åŠ¨äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œä¹‹å session B æ‰å¼€å§‹æ‰§è¡Œ update è¯­å¥ã€‚</p><p>session B æ›´æ–°å®Œ 100 ä¸‡æ¬¡ï¼Œç”Ÿæˆäº† 100 ä¸‡ä¸ªå›æ»šæ—¥å¿— (undo log)ã€‚</p><p>å¸¦ lock in share mode çš„ SQL è¯­å¥ï¼Œæ˜¯å½“å‰è¯»ï¼Œå› æ­¤ä¼šç›´æ¥è¯»åˆ° 1000001 è¿™ä¸ªç»“æœï¼Œæ‰€ä»¥é€Ÿåº¦å¾ˆå¿«ï¼›è€Œ select * from t where id&#x3D;1 è¿™ä¸ªè¯­å¥ï¼Œæ˜¯ä¸€è‡´æ€§è¯»ï¼Œå› æ­¤éœ€è¦ä» 1000001 å¼€å§‹ï¼Œä¾æ¬¡æ‰§è¡Œ undo logï¼Œæ‰§è¡Œäº† 100 ä¸‡æ¬¡ä»¥åï¼Œæ‰å°† 1 è¿™ä¸ªç»“æœè¿”å›ã€‚</p><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>ä»Šå¤©åˆ—ä¸¾äº†åœ¨ä¸€ä¸ªç®€å•çš„è¡¨ä¸Šï¼Œæ‰§è¡Œâ€œæŸ¥ä¸€è¡Œâ€ï¼Œå¯èƒ½ä¼šå‡ºç°çš„è¢«é”ä½å’Œæ‰§è¡Œæ…¢çš„ä¾‹å­ã€‚è¿™å…¶ä¸­æ¶‰åŠåˆ°äº†è¡¨é”ã€è¡Œé”å’Œä¸€è‡´æ€§è¯»çš„æ¦‚å¿µã€‚<br>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œç¢°åˆ°çš„åœºæ™¯ä¼šæ›´å¤æ‚ã€‚ä½†å¤§åŒå°å¼‚ã€‚</p><blockquote><p>å‚è€ƒ</p><ul><li>ã€Šæå®¢æ—¶é—´æ—æ™“æ–ŒMysqlä¸“åœºã€‹</li></ul></blockquote></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/04/12/2022-04-12-elasticsearch-num6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/04/12/2022-04-12-elasticsearch-num6/" class="post-title-link" itemprop="url">Elasticsearch Searchè¿è¡Œæœºåˆ¶</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-12 14:30:00" itemprop="dateCreated datePublished" datetime="2022-04-12T14:30:00+08:00">2022-04-12</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="Query-Then-Fetch"><a href="#Query-Then-Fetch" class="headerlink" title="Query-Then-Fetch"></a>Query-Then-Fetch</h2><p>Searchæ‰§è¡Œçš„æ—¶å€™å®é™…åˆ†ä¸¤ä¸ªæ­¥éª¤è¿ä½œçš„</p><ul><li>Queryé˜¶æ®µ</li><li>Fetché˜¶æ®µ</li></ul><p>åœ¨esé‡Œè¢«ç§°ä¸ºQuery-Then-Fetchæœºåˆ¶</p><h3 id="Searchçš„è¿è¡Œæœºåˆ¶-Queryé˜¶æ®µ"><a href="#Searchçš„è¿è¡Œæœºåˆ¶-Queryé˜¶æ®µ" class="headerlink" title="Searchçš„è¿è¡Œæœºåˆ¶-Queryé˜¶æ®µ"></a>Searchçš„è¿è¡Œæœºåˆ¶-Queryé˜¶æ®µ</h3><p>node3åœ¨æ¥æ”¶åˆ°ç”¨æˆ·çš„searchè¯·æ±‚å,ä¼šå…ˆè¿›è¡ŒQueryé˜¶æ®µ(æ­¤æ—¶æ˜¯CoordinatingNodeè§’è‰²)<br>node3åœ¨6ä¸ªä¸»å‰¯åˆ†ç‰‡ä¸­éšæœºé€‰æ‹©3ä¸ªåˆ†ç‰‡,å‘é€search request<br>è¢«é€‰ä¸­çš„3ä¸ªåˆ†ç‰‡ä¼šåˆ†åˆ«æ‰§è¡ŒæŸ¥è¯¢å¹¶æ’åº,è¿”å›from+sizeä¸ªæ–‡æ¡£Idå’Œæ’åºå€¼<br>node3æ•´åˆ3ä¸ªåˆ†ç‰‡è¿”å›çš„from+sizeä¸ªæ–‡æ¡£Id ,æ ¹æ®æ’åºå€¼æ’åºåé€‰å–fromåˆ°from+sizeçš„æ–‡æ¡£Id</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 10,</span><br><span class="line">  &quot;size&quot;: 20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¡¨ç¤ºä»ç¬¬10ä¸ªæ–‡æ¡£å¼€å§‹ï¼Œæˆªå–ç¬¬10-29çš„æ–‡æ¡£</p></blockquote><h3 id="Searchçš„è¿è¡Œæœºåˆ¶-Fetché˜¶æ®µ"><a href="#Searchçš„è¿è¡Œæœºåˆ¶-Fetché˜¶æ®µ" class="headerlink" title="Searchçš„è¿è¡Œæœºåˆ¶-Fetché˜¶æ®µ"></a>Searchçš„è¿è¡Œæœºåˆ¶-Fetché˜¶æ®µ</h3><p>node3æ ¹æ®Queryé˜¶æ®µè·å–çš„æ–‡æ¡£Idåˆ—è¡¨å»å¯¹åº”çš„shardä¸Šè·å–æ–‡æ¡£è¯¦æƒ…æ•°æ®a</p><ul><li>node3å‘ç›¸å…³çš„åˆ†ç‰‡å‘é€multi-getè¯·æ±‚</li><li>3ä¸ªåˆ†ç‰‡è¿”å›æ–‡æ¡£è¯¦ç»†æ•°æ®</li><li>node3æ‹¼æ¥è¿”å›çš„ç»“æœå¹¶è¿”å›ç»™å®¢æˆ·</li></ul><h3 id="Searchçš„è¿è¡Œæœºåˆ¶-ç›¸å…³æ€§ç®—åˆ†é—®é¢˜"><a href="#Searchçš„è¿è¡Œæœºåˆ¶-ç›¸å…³æ€§ç®—åˆ†é—®é¢˜" class="headerlink" title="Searchçš„è¿è¡Œæœºåˆ¶-ç›¸å…³æ€§ç®—åˆ†é—®é¢˜"></a>Searchçš„è¿è¡Œæœºåˆ¶-ç›¸å…³æ€§ç®—åˆ†é—®é¢˜</h3><p>ç›¸å…³æ€§ç®—åˆ†åœ¨shardä¸shardé—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„,ä¹Ÿå°±æ„å‘³ç€åŒä¸€ä¸ªTermçš„IDFç­‰å€¼åœ¨ä¸åŒshardä¸Šæ˜¯ä¸åŒçš„ã€‚æ–‡æ¡£çš„ç›¸å…³æ€§ç®—åˆ†å’Œå®ƒæ‰€å¤„çš„shardç›¸å…³</p><p>åœ¨æ–‡æ¡£æ•°é‡ä¸å¤šæ—¶,ä¼šå¯¼è‡´ç›¸å…³æ€§ç®—åˆ†ä¸¥é‡ä¸å‡†çš„æƒ…å†µå‘ç”Ÿ</p><p>åŠ ä¸Š<code>explain</code>å‚æ•°å¯æŸ¥çœ‹æ–‡æ¡£å†…å®¹æ‰€åœ¨shard</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: true, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;genre&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;Comedy Children&quot;,</span><br><span class="line">        &quot;operator&quot;: &quot;and&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£å†³æ€è·¯æœ‰ä¸¤ä¸ª:</p><p>ä¸€æ˜¯è®¾ç½®åˆ†ç‰‡æ•°ä¸º1ä¸ª,ä»æ ¹æœ¬ä¸Šæ’é™¤é—®é¢˜,åœ¨æ–‡æ¡£æ•°é‡ä¸å¤šçš„æ—¶å€™å¯ä»¥è€ƒè™‘è¯¥æ–¹ã€‚æ¡ˆ,æ¯”å¦‚ç™¾ä¸‡åˆ°åƒä¸‡çº§åˆ«çš„æ–‡æ¡£æ•°é‡<br>äºŒæ˜¯ä½¿ç”¨<code>DFS Query-then-Fetch</code>æŸ¥è¯¢æ–¹å¼.<code>DFS Query-then-Fetch</code>æ˜¯åœ¨æ‹¿åˆ°æ‰€æœ‰æ–‡æ¡£åå†é‡æ–°å®Œæ•´çš„è®¡ç®—ä¸€æ¬¡ç›¸å…³æ€§ç®—åˆ†,è€—è´¹æ›´å¤šçš„cpuå’Œå†…å­˜,æ‰§è¡Œæ€§èƒ½ä¹Ÿæ¯”è¾ƒä½ä¸‹,ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search?search_type=dfs_query_then_fetch</span><br><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: false, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;genre&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;Comedy Children&quot;,</span><br><span class="line">        &quot;operator&quot;: &quot;and&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sorting"><a href="#sorting" class="headerlink" title="sorting"></a>sorting</h3><p>esé»˜è®¤ä¼šé‡‡ç”¨ç›¸å…³æ€§ç®—åˆ†æ’åº,ç”¨æˆ·å¯ä»¥é€šè¿‡è®¾å®š<code>sort</code>å‚æ•°æ¥è‡ªè¡Œè®¾å®šæ’åºè§„åˆ™</p><p>æ’åºçš„è¿‡ç¨‹å®è´¨æ˜¯å¯¹å­—æ®µåŸå§‹å†…å®¹æ’åºçš„è¿‡ç¨‹,è¿™ä¸ªè¿‡ç¨‹ä¸­å€’æ’ç´¢å¼•æ— æ³•å‘æŒ¥ä½œç”¨,éœ€è¦ç”¨åˆ°æ­£æ’ç´¢å¼•,ä¹Ÿå°±æ˜¯é€šè¿‡æ–‡æ¡£Idå’Œå­—æ®µå¯ä»¥å¿«é€Ÿå¾—åˆ°å­—æ®µåŸå§‹å†…å®¹ã€‚</p><p>eså¯¹æ­¤æä¾›äº†2ç§å®ç°æ–¹å¼:</p><ul><li>fielddataé»˜è®¤ç¦ç”¨</li><li>doc valuesé»˜è®¤å¯ç”¨,é™¤äº†textç±»å‹</li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>response:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [title] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;search_phase_execution_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all shards failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grouped&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;movies&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6pljLZ0vQQKObirnkOOsnw&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [title] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [title] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [title] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•:</p><ul><li>ä½¿ç”¨keywordæ’åº</li><li>fielddataå¼€å¯<figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;title.keyword&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="Fileddata-vs-DocValues"><a href="#Fileddata-vs-DocValues" class="headerlink" title="Fileddata vs DocValues"></a>Fileddata vs DocValues</h3><table><thead><tr><th>å¯¹æ¯”</th><th>Fileddata</th><th>DocValues</th></tr></thead><tbody><tr><td>åˆ›å»ºæ—¶æœº</td><td>æœç´¢æ—¶å³æ—¶åˆ›å»º</td><td>ç´¢å¼•æ—¶åˆ›å»º</td></tr><tr><td>åˆ›å»ºä½ç½®</td><td>JVM Heap</td><td>ç£ç›˜</td></tr><tr><td>ä¼˜ç‚¹</td><td>ä¸å ç”¨ç£ç›˜ç©ºé—´</td><td>ä¸å ç”¨Heapå†…å­˜</td></tr><tr><td>ç¼ºç‚¹</td><td>æ–‡æ¡£è¿‡å¤šæ—¶ï¼Œå³æ—¶åˆ›å»ºèŠ±è´¹æ—¶é—´é•¿ï¼Œå†…å­˜å ç”¨é«˜</td><td>å‡æ…¢ç´¢å¼•çš„é€Ÿåº¦ï¼Œå ç”¨ç£ç›˜ç©ºé—´</td></tr></tbody></table><p>Fielddataé»˜è®¤æ˜¯å…³é—­çš„,å¯ä»¥é€šè¿‡å¦‚ä¸‹apiå¼€å¯:</p><ul><li>æ­¤æ—¶å­—ç¬¦ä¸²æ˜¯æŒ‰ç…§åˆ†è¯åçš„termæ’åº,å¾€å¾€ç»“æœå¾ˆéš¾ç¬¦åˆé¢„æœŸ</li><li>ä¸€èˆ¬æ˜¯åœ¨å¯¹åˆ†è¯åšèšåˆåˆ†æçš„æ—¶å€™å¼€å¯,</li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT movies/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;title&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;fielddata&quot;: true     # å¯éšæ—¶å¼€å¯</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># å¼€å¯ååœ¨æŸ¥è¯¢ä¸ä¼šæŠ¥é”™</span><br><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;title.keyword&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Doc Valuesé»˜è®¤æ˜¯å¯ç”¨çš„,å¯ä»¥åœ¨åˆ›å»ºç´¢å¼•çš„æ—¶å€™å…³é—­:-å¦‚æœåé¢è¦å†å¼€å¯doc values ,éœ€è¦åšreindexæ“ä½œ</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_doc_values</span><br><span class="line">PUT test_doc_values</span><br><span class="line">PUT test_doc_values/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;username&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">      &quot;doc_values&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é—­ååœ¨æ’åºä¼šæŠ¥é”™</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET test_doc_values/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;username&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Can&#x27;t load fielddata on [username] because fielddata is unsupported on fields of type [keyword]. Use doc values instead.&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;search_phase_execution_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all shards failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grouped&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_doc_values&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6pljLZ0vQQKObirnkOOsnw&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Can&#x27;t load fielddata on [username] because fielddata is unsupported on fields of type [keyword]. Use doc values instead.&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Can&#x27;t load fielddata on [username] because fielddata is unsupported on fields of type [keyword]. Use doc values instead.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Can&#x27;t load fielddata on [username] because fielddata is unsupported on fields of type [keyword]. Use doc values instead.&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>textç±»å‹ä¸æ”¯æŒDoc Values,Fielddataåªèƒ½æ”¯æŒä¸textç±»å‹</p></blockquote><h3 id="åˆ†é¡µä¸éå†"><a href="#åˆ†é¡µä¸éå†" class="headerlink" title="åˆ†é¡µä¸éå†"></a>åˆ†é¡µä¸éå†</h3><p>åˆ†é¡µä¸éå†-fromsize</p><p>esæä¾›äº†3ç§æ–¹å¼æ¥è§£å†³åˆ†é¡µä¸éå†çš„é—®é¢˜:</p><ul><li>from&#x2F;size</li><li>scroll</li><li>search_after<br>from&#x2F;sizeæœ€å¸¸ç”¨çš„åˆ†é¡µæ–¹æ¡ˆ</li></ul><p>fromæŒ‡æ˜å¼€å§‹ä½ç½®sizeæŒ‡æ˜è·å–æ€»æ•°</p><p><strong>æ·±åº¦åˆ†é¡µæ˜¯ä¸€ä¸ªç»å…¸çš„é—®é¢˜:åœ¨æ•°æ®åˆ†ç‰‡å­˜å‚¨çš„æƒ…å†µä¸‹å¦‚ä½•è·å–å‰1000ä¸ªæ–‡æ¡£?</strong><br>è·å–ä»990-1000çš„æ–‡æ¡£æ—¶,ä¼šåœ¨æ¯ä¸ªåˆ†ç‰‡ä¸Šéƒ½å…ˆè·å–1000ä¸ªæ–‡æ¡£,ç„¶åå†ç”±.Coordinating Nodeèšåˆæ‰€æœ‰åˆ†ç‰‡çš„ç»“æœåå†æ’åºé€‰å–å‰1000ä¸ªæ–‡æ¡£<br>é¡µæ•°è¶Šæ·±,å¤„ç†æ–‡æ¡£è¶Šå¤š,å ç”¨å†…å­˜è¶Šå¤š,è€—æ—¶è¶Šé•¿,å°½é‡é¿å…æ·±åº¦åˆ†é¡µ, esé€šè¿‡ index.max_result_windowé™å®šæœ€å¤šåˆ°10000æ¡æ•°æ®</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 10,</span><br><span class="line">  &quot;size&quot;: 10000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 10000,</span><br><span class="line">  &quot;size&quot;: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>response</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Result window is too large, from + size must be less than or equal to: [10000] but was [10010]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;search_phase_execution_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all shards failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grouped&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;movies&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6pljLZ0vQQKObirnkOOsnw&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Result window is too large, from + size must be less than or equal to: [10000] but was [10010]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Result window is too large, from + size must be less than or equal to: [10000] but was [10010]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Result window is too large, from + size must be less than or equal to: [10000] but was [10010]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†é¡µä¸éå†-scroll"><a href="#åˆ†é¡µä¸éå†-scroll" class="headerlink" title="åˆ†é¡µä¸éå†-scroll"></a>åˆ†é¡µä¸éå†-scroll</h3><p>éå†æ–‡æ¡£é›†çš„api ,ä»¥å¿«ç…§çš„æ–¹å¼æ¥é¿å…æ·±åº¦åˆ†é¡µçš„é—®é¢˜</p><ul><li>ä¸èƒ½ç”¨æ¥åšå®æ—¶æœç´¢,å› ä¸ºæ•°æ®ä¸æ˜¯å®æ—¶çš„</li><li>å°½é‡ä¸è¦ä½¿ç”¨å¤æ‚çš„sortæ¡ä»¶,ä½¿ç”¨_docæœ€é«˜æ•ˆ</li><li>ä½¿ç”¨ç¨å«Œå¤æ‚</li></ul><p>ç¬¬ä¸€æ­¥éœ€è¦å‘èµ·1ä¸ªscroll search:</p><p>esåœ¨æ”¶åˆ°è¯¥è¯·æ±‚åä¼šæ ¹æ®æŸ¥è¯¢æ¡ä»¶åˆ›å»ºæ–‡æ¡£Idåˆé›†çš„å¿«ç…§</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search?scroll=5m</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">5mè‡³å¿«ç…§æœ‰æ•ˆæ—¶å¸¸ï¼Œsizeè¿”å›æ¡æ•°</span><br></pre></td></tr></table></figure><p>response</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_scroll_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;DnF1ZXJ5VGhlbkZldGNoAgAAAAAAAAagFnY3WnRoVnRLVDNtWncyZ3k4QzlKU1EAAAAAAAAGnxZ2N1p0aFZ0S1QzbVp3Mmd5OEM5SlNR&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">9743</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;movies&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;movieId&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;year&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;title&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;@version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genre&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;genres&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;movieId&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥è°ƒç”¨scroll searchçš„api ,è·å–æ–‡æ¡£é›†åˆ</p><p>ä¸æ–­è¿­ä»£è°ƒç”¨ç›´åˆ°è¿”å›hits.hitsæ•°ç»„ä¸ºç©ºæ—¶åœæ­¢</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  &quot;scroll&quot;: &quot;5m&quot;,</span><br><span class="line">  &quot;scroll_id&quot;: &quot;DnF1ZXJ5VGhlbkZldGNoAgAAAAAAAAagFnY3WnRoVnRLVDNtWncyZ3k4QzlKU1EAAAAAAAAGnxZ2N1p0aFZ0S1QzbVp3Mmd5OEM5SlNR&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡å¤šçš„scrollè°ƒç”¨ä¼šå ç”¨å¤§é‡å†…å­˜,å¯ä»¥é€šè¿‡clear apiåˆ é™¤è¿‡å¤šçš„scrollå¿«ç…§:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DELETE _search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  &quot;scroll_id&quot;:[&quot;DnF1ZXJ5VGhlbkZldGNoAgAAAAAAAAagFnY3WnRoVnRLVDNtWncyZ3k4QzlKU1EAAAAAAAAGnxZ2N1p0aFZ0S1QzbVp3Mmd5OEM5SlNR&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE _search/scroll/_all</span><br></pre></td></tr></table></figure><h3 id="åˆ†é¡µä¸éå†-search-after"><a href="#åˆ†é¡µä¸éå†-search-after" class="headerlink" title="åˆ†é¡µä¸éå†-search_after"></a>åˆ†é¡µä¸éå†-search_after</h3><p>é¿å…æ·±åº¦åˆ†é¡µçš„æ€§èƒ½é—®é¢˜,æä¾›å®æ—¶çš„ä¸‹ä¸€é¡µæ–‡æ¡£è·å–åŠŸèƒ½</p><ul><li>ç¼ºç‚¹æ˜¯ä¸èƒ½ä½¿ç”¨fromå‚æ•°,å³ä¸èƒ½æŒ‡å®šé¡µæ•°</li><li>åªèƒ½ä¸‹ä¸€é¡µ,ä¸èƒ½ä¸Šä¸€é¡µ</li><li>ä½¿ç”¨ç®€å•</li></ul><p>ç¬¬ä¸€æ­¥ä¸ºæ­£å¸¸çš„æœç´¢,ä½†è¦æŒ‡å®šsortå€¼,å¹¶ä¿è¯å€¼å”¯ä¸€<br>ç¬¬äºŒæ­¥ä¸ºä½¿ç”¨ä¸Šä¸€æ­¥æœ€åä¸€ä¸ªæ–‡æ¡£çš„sortå€¼è¿›è¡ŒæŸ¥è¯¢</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 1, </span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;year&quot;: &quot;desc&quot;,</span><br><span class="line">      &quot;title&quot;: &quot;desc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">9743</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;movies&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;187717&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;year&quot;</span> <span class="punctuation">:</span> <span class="number">2018</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Won&#x27;t You Be My Neighbor?&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;@version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genre&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;Documentary&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;187717&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">2018</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;you&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 1,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;year&quot;: &quot;desc&quot;,</span><br><span class="line">      &quot;title&quot;: &quot;desc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;search_after&quot;: [2018,&quot;you&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä½•é¿å…æ·±åº¦åˆ†é¡µé—®é¢˜?<br>é€šè¿‡å”¯ä¸€æ’åºå€¼å®šä½å°†æ¯æ¬¡è¦å¤„ç†çš„æ–‡æ¡£æ•°éƒ½æ§åˆ¶åœ¨sizeå†…</p><p>è¿”å›æ’åºå€¼åœ¨search afterä¹‹åçš„sizeä¸ªæ–‡æ¡£ï¼Œå‡å¦‚size&#x3D;10,æœ‰5ä¸ªåˆ†ç‰‡ï¼ŒCoordinating Nodeåªéœ€è¦èšåˆ5ä¸ªåˆ†ç‰‡å–10ä¸ªæ–‡æ¡£å…±50ä¸ªæ–‡æ¡£ï¼Œç„¶ååœ¨å–å‰10ä¸ªæ–‡æ¡£è¿”å›å³å¯<br>æœ‰æ•ˆçš„æ§åˆ¶äº†èšåˆçš„æ–‡æ¡£çš„æ•°é‡</p><h3 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯:"></a>åœºæ™¯:</h3><table><thead><tr><th>ç±»å‹</th><th>åœºæ™¯</th></tr></thead><tbody><tr><td>from&#x2F;size</td><td>éœ€è¦å®æ—¶è·å–é¡¶éƒ¨çš„æ–‡æ¡£ï¼Œå¯è‡ªç”±åˆ†é¡µ</td></tr><tr><td>scroll</td><td>éœ€è¦å…¨éƒ¨æ–‡æ¡£ï¼Œå¸¸ç”¨äºå¯¼å‡ºï¼Œæ•°æ®éå®æ—¶</td></tr><tr><td>search after</td><td>éœ€è¦å…¨éƒ¨çš„æ–‡æ¡£ï¼Œä¸éœ€è¦è‡ªç”±åˆ†é¡µï¼Œæ•°æ®å®æ—¶</td></tr></tbody></table><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search.html">search å®˜æ–¹æ–‡æ¡£</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/03/31/2022-03-31-elasticsearch-term/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/03/31/2022-03-31-elasticsearch-term/" class="post-title-link" itemprop="url">Elasticsearch Term Match</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-31 14:30:00" itemprop="dateCreated datePublished" datetime="2022-03-31T14:30:00+08:00">2022-03-31</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="Term"><a href="#Term" class="headerlink" title="Term"></a>Term</h2><p><code>term query</code>ä¼šå»å€’æ’ç´¢å¼•ä¸­å¯»æ‰¾ç¡®åˆ‡çš„<code>term</code>ï¼Œå®ƒå¹¶ä¸çŸ¥é“åˆ†è¯å™¨çš„å­˜åœ¨ï¼Œè¿™ç§æŸ¥è¯¢é€‚åˆ<code>keyword</code>ã€<code>numeric</code>ã€<code>date</code>ç­‰æ˜ç¡®å€¼çš„</p><p>termï¼šæŸ¥è¯¢æŸä¸ªå­—æ®µé‡Œå«æœ‰æŸä¸ªå…³é”®è¯çš„æ–‡æ¡£</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &quot;alfred&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.636667</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java senior engineer and java specialist&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1980-05-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.48898652</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.39691794</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred junior way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ruby engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1989-08-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>å‘ç°ï¼Œ<code>username</code>é‡Œæœ‰å…³<code>alfred</code>çš„å…³é”®å­—éƒ½æŸ¥å‡ºæ¥äº†ï¼Œä½†æ˜¯æˆ‘åªæƒ³ç²¾ç¡®åŒ¹é…<code>alfred way</code>è¿™ä¸ªï¼ŒæŒ‰ç…§ä¸‹é¢çš„å†™æ³•çœ‹çœ‹èƒ½ä¸èƒ½æŸ¥å‡ºæ¥ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &quot;alfred way&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘ç°æ— æ•°æ®ï¼Œä»æ¦‚å¿µä¸Šçœ‹ï¼Œ<code>term</code>å±äºç²¾ç¡®åŒ¹é…ï¼Œåªèƒ½æŸ¥å•ä¸ªè¯ã€‚æˆ‘æƒ³ç”¨<code>term</code>åŒ¹é…å¤šä¸ªè¯æ€ä¹ˆåšï¼Ÿå¯ä»¥ä½¿ç”¨termsæ¥ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;terms&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: [&quot;alfred&quot;, &quot;way&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°å…¨éƒ¨æŸ¥è¯¢å‡ºæ¥ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸º<code>terms</code>é‡Œçš„<code>[ ]</code>å¤šä¸ªæ˜¯æˆ–è€…çš„å…³ç³»ï¼Œåªè¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªè¯å°±å¯ä»¥ã€‚æƒ³è¦é€šçŸ¥æ»¡è¶³ä¸¤ä¸ªè¯çš„è¯ï¼Œå°±å¾—ä½¿ç”¨åœ¨search apié‚£ç¯‡ä¸­æåˆ°çš„<code>bool</code>æŸ¥è¯¢æ¥åšäº†</p><p>matchæŸ¥è¯¢ï¼š</p><p>match query çŸ¥é“åˆ†è¯å™¨çš„å­˜åœ¨ï¼Œä¼šå¯¹fieldè¿›è¡Œåˆ†è¯æ“ä½œï¼Œç„¶åå†æŸ¥è¯¢</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &quot;alfred&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>match_allï¼šæŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£<br>{ â€œmatch_allâ€: {}} åŒ¹é…æ‰€æœ‰çš„ï¼Œ å½“ä¸ç»™æŸ¥è¯¢æ¡ä»¶æ—¶ï¼Œé»˜è®¤ã€‚</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;</span><br><span class="line">      &quot;boost&quot;: 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_score</code>éšboostå€¼æ”¹å˜è€Œæ”¹å˜:</p><p>multi_matchï¼šå¯ä»¥æŒ‡å®šå¤šä¸ªå­—æ®µ</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot; : &quot;alfred java&quot;,</span><br><span class="line">      &quot;fields&quot;:  [&quot;username&quot;,&quot;job&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.636667</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred way&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.636667</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java senior engineer and java specialist&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1980-05-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.48898652</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;lee&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java and ruby engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1985-08-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.39691794</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred junior way&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ruby engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1989-08-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/03/15/2022-03-15-elasticsearch-num5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/03/15/2022-03-15-elasticsearch-num5/" class="post-title-link" itemprop="url">Elasticsearch Search API</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-15 14:30:00" itemprop="dateCreated datePublished" datetime="2022-03-15T14:30:00+08:00">2022-03-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search.html">å®˜æ–¹æ–‡æ¡£</a><br>å®ç°å¯¹esä¸­å­˜å‚¨çš„æ•°æ®è¿›è¡ŒæŸ¥è¯¢åˆ†æï¼Œendpointä¸º<code>_search</code>ï¼ŒæŸ¥è¯¢ä¸»è¦æœ‰ä¸¤ç§å½¢å¼ï¼š</p><ul><li>URI Searchï¼šæ“ä½œç®€ä¾¿ï¼Œæ–¹ä¾¿é€šè¿‡å‘½ä»¤è¡Œæµ‹è¯•ï¼Œä»…åŒ…å«éƒ¨åˆ†æŸ¥è¯¢è¯­æ³•</li><li>Request Body Searchï¼šesæä¾›å®Œå¤‡æŸ¥è¯¢è¯­æ³•Query DSL</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /user/_search?q=gender:M</span><br><span class="line">GET /user/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;gender&quot;: &quot;M&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="URI-Searchè¯¦è§£"><a href="#URI-Searchè¯¦è§£" class="headerlink" title="URI Searchè¯¦è§£"></a>URI Searchè¯¦è§£</h2><p>é€šè¿‡url queryå‚æ•°æ¥å®ç°æœç´¢ï¼Œå¸¸ç”¨å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>q: æŒ‡å®šæŸ¥è¯¢è¯­å¥ï¼Œè¯­æ³•ä¸º Query String Syntax</li><li>df: qä¸­ä¸æŒ‡å®šå­—æ®µæ—¶é»˜è®¤æŸ¥è¯¢çš„å­—æ®µï¼Œå¦‚æœä¸æŒ‡å®šï¼Œesä¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µ</li><li>sortï¼šæ’åº</li><li>timeoutï¼šæŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸è¶…æ—¶</li><li>from,sizeï¼šç”¨äºåˆ†é¡µ</li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /myindex/_search?q=alfred&amp;df=user&amp;sort=age:asc&amp;from=4&amp;size=10&amp;timeout=1s</span><br><span class="line">#æŸ¥è¯¢userå­—æ®µåŒ…å«alfredçš„æ–‡æ¡£ï¼Œç»“æœæŒ‰ç…§ageå‡åºæ’åˆ—ï¼Œè¿”å›ç¬¬5-14ä¸ªæ–‡æ¡£ï¼Œå¦‚æœè¶…è¿‡1sæ²¡æœ‰ç»“æŸï¼Œåˆ™ä»¥è¶…æ—¶ç»“æŸ</span><br></pre></td></tr></table></figure><h2 id="Query-String-Syntax"><a href="#Query-String-Syntax" class="headerlink" title="Query String Syntax"></a>Query String Syntax</h2><h3 id="è¯­æ³•ä»‹ç»"><a href="#è¯­æ³•ä»‹ç»" class="headerlink" title="è¯­æ³•ä»‹ç»"></a>è¯­æ³•ä»‹ç»</h3><ol><li><p>termä¸phrase</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alfred way ç­‰æ•ˆäº alfred OR way</span><br><span class="line">&quot;alfred way&quot; è¯è¯­æŸ¥è¯¢ï¼Œè¦æ±‚å…ˆåé¡ºåº</span><br></pre></td></tr></table></figure></li><li><p>æ³›æŸ¥è¯¢</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alfredç­‰æ•ˆäºåœ¨æ‰€æœ‰å­—æ®µå»åŒ¹é…è¯¥term</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šå­—æ®µ</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name:alfred</span><br></pre></td></tr></table></figure></li><li><p>Groupåˆ†ç»„æŒ‡å®šï¼Œä½¿ç”¨æ‹¬å·æŒ‡å®šåŒ¹é…çš„è§„åˆ™</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(quick OR brown) AND fox</span><br><span class="line">status:(active OR pending) title:(full text search)</span><br></pre></td></tr></table></figure><blockquote><p>q&#x3D;&lt;â€¦&gt;å†…å®¹å¦‚æœæœ‰ç©ºæ ¼ä¼šå½“ä½œorå¤„ç†</p></blockquote></li></ol><blockquote><p>åŠ æ‹¬å·å’Œä¸åŠ æ‹¬å·çš„åŒºåˆ«ï¼šåŠ æ‹¬å·è¡¨ç¤ºstatusæ˜¯activeæˆ–statusæ˜¯pengdingç»“æœï¼Œä¸åŠ æ‹¬å·è¡¨ç¤º<br>statusæ˜¯activeæˆ–è€…ç»“æœä¸­åŒ…å«pending</p></blockquote><ol start="5"><li><p>å¸ƒå°”æ“ä½œç¬¦<br>AND(&amp;&amp;),OR(||),NOT(!)</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name:(tom NOT lee) æ³¨æ„å¤§å†™ï¼Œä¸èƒ½å°å†™</span><br></pre></td></tr></table></figure></li><li><p>â€œ+ -â€œåˆ†åˆ«å¯¹åº”mustå’Œmust_not</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name:(tom +lee -alfred)</span><br><span class="line">ç­‰ä»·äº</span><br><span class="line">name:((lee &amp;&amp; !alfred)||(tom &amp;&amp; lee &amp;&amp; !alfred))</span><br></pre></td></tr></table></figure><blockquote><p>+åœ¨urlä¸­ä¼šè¢«è§£æä¸ºç©ºæ ¼ï¼Œè¦ä½¿ç”¨encodeåçš„ç»“æœæ‰å¯ä»¥ï¼Œä¸º%2B</p></blockquote></li><li><p>èŒƒå›´æŸ¥è¯¢ï¼Œæ”¯æŒæ•°å€¼å’Œæ—¥å¿—</p></li></ol><ul><li>åŒºé—´å†™æ³•ï¼Œé—­åŒºé—´ç”¨[],å¼€åŒºé—´ç”¨{}<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">age: [1 TO 10]æ„ä¸º 1&lt;=age&lt;=10</span><br><span class="line">age: [1 TO 10&#125;æ„ä¸º 1&lt;=age&lt;10</span><br><span class="line">age: [1 TO ]æ„ä¸º age&gt;=1</span><br><span class="line">age: [* TO 10]æ„ä¸º age&lt;=10</span><br></pre></td></tr></table></figure></li><li>ç®—æ•°ç¬¦å·å†™æ³•<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">age:&gt;=1</span><br><span class="line">age:(&gt;=1&amp;&amp;&lt;=10)æˆ–è€…age:(+&gt;=1 +&lt;=10)</span><br></pre></td></tr></table></figure></li></ul><ol start="8"><li><p>é€šé…ç¬¦æŸ¥è¯¢ï¼šï¼Ÿä»£è¡¨ä¸€ä¸ªå­—ç¬¦ï¼Œ*ä»£è¡¨0æˆ–å¤šä¸ªå­—ç¬¦</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">name:t?m</span><br><span class="line">name:tom*</span><br><span class="line"></span><br><span class="line">é€šé…ç¬¦åŒ¹é…æ‰§è¡Œæ•ˆç‡ä½ï¼Œä¸”å ç”¨è¾ƒå¤šå†…å­˜ï¼Œä¸å»ºè®®ä½¿ç”¨</span><br><span class="line">å¦‚æ— ç‰¹æ®Šéœ€æ±‚ï¼Œä¸è¦å°†?/<span class="emphasis">*æ”¾åœ¨æœ€å‰é¢</span></span><br></pre></td></tr></table></figure></li><li><p>æ­£åˆ™è¡¨è¾¾å¼</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name:/[mb]oat/</span><br></pre></td></tr></table></figure></li><li><p>æ¨¡ç³ŠåŒ¹é… fuzzy query</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name:roam~1</span><br><span class="line">åŒ¹é…ä¸roamå·®ä¸€ä¸ªcharacterçš„è¯ï¼Œæ¯”å¦‚foam roamsç­‰</span><br></pre></td></tr></table></figure></li><li><p>è¿‘ä¼¼åº¦æŸ¥è¯¢ proximity search</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;fox quick&quot;~5</span><br><span class="line">å…è®¸fox å’Œquick ä¹‹é—´å·®5ä¸ªè¯è¯­</span><br><span class="line">ä»¥termä¸ºå•ä½è¿›è¡Œå·®å¼‚æ¯”è¾ƒï¼Œæ¯”å¦‚&quot;quick fox&quot; &quot;quick brown fox&quot;éƒ½ä¼šè¢«åŒ¹é…</span><br></pre></td></tr></table></figure></li></ol><h3 id="æŸ¥è¯¢ç¤ºä¾‹"><a href="#æŸ¥è¯¢ç¤ºä¾‹" class="headerlink" title="æŸ¥è¯¢ç¤ºä¾‹"></a>æŸ¥è¯¢ç¤ºä¾‹</h3><p>æ·»åŠ ä¸€äº›æ•°æ®</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_search_index</span><br><span class="line"></span><br><span class="line">PUT test_search_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index&quot;:&#123;</span><br><span class="line">        &quot;number_of_shards&quot;: &quot;1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_search_index/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;username&quot;:&quot;alfred way&quot;,&quot;job&quot;:&quot;java engineer&quot;,&quot;age&quot;:18,&quot;birth&quot;:&quot;1990-01-02&quot;,&quot;isMarried&quot;:false&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;username&quot;:&quot;alfred&quot;,&quot;job&quot;:&quot;java senior engineer and java specialist&quot;,&quot;age&quot;:28,&quot;birth&quot;:&quot;1980-05-07&quot;,&quot;isMarried&quot;:true&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;username&quot;:&quot;lee&quot;,&quot;job&quot;:&quot;java and ruby engineer&quot;,&quot;age&quot;:22,&quot;birth&quot;:&quot;1985-08-07&quot;,&quot;isMarried&quot;:false&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;4&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;username&quot;:&quot;alfred junior way&quot;,&quot;job&quot;:&quot;ruby engineer&quot;,&quot;age&quot;:23,&quot;birth&quot;:&quot;1989-08-07&quot;,&quot;isMarried&quot;:false&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢æ‰€æœ‰å…³é”®è¯ä¸­æœ‰alfredçš„</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=alfred</span><br><span class="line">#profileè®¾ç½®ä¸ºtrueå¯ä»¥åˆ†æelasticsearchçš„å…·ä½“è¿‡ç¨‹</span><br><span class="line">GET test_search_index/_search?q=alfred</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢æ‰€æœ‰å…³é”®è¯ä¸­æœ‰alfredçš„å¹¶æŒ‡å®šä¸ºusernameå­—æ®µ</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alfred</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢æ‰€æœ‰å…³é”®è¯ä¸­æœ‰alfredæˆ–è€…wayçš„å¹¶æŒ‡å®šä¸ºusernameå­—æ®µ</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alfred way</span><br></pre></td></tr></table></figure><p>å¦‚æœåŠ ä¸Šâ€â€åˆ™è¡¨ç¤ºå…³é”®è¯ä¸­å¿…é¡»åŒ…å«alfred way</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:&quot;alfred way&quot;</span><br></pre></td></tr></table></figure><p>usernameå­—æ®µä¸­å¿…é¡»åŒ…å«alfredå’Œå…¶å®ƒå­—æ®µåŒ…å«wayçš„</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alfred AND way</span><br></pre></td></tr></table></figure><p>usernameå­—æ®µä¸­å¿…é¡»åŒ…å«alfredå’Œwayçš„</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred AND way)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä¾¿äºåŒºåˆ«()çš„ä½œç”¨ï¼Œåœ¨åŠ å…¥ä¸€æ¡æ•°æ®</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST test_search_index/doc/_bulk/</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;7&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;username&quot;:&quot;alfred&quot;,&quot;job&quot;:&quot;java engineer way&quot;,&quot;age&quot;:18,&quot;birth&quot;:&quot;1990-01-02&quot;,&quot;isMarried&quot;:false&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#q=username<span class="punctuation">:</span>alfred AND waydçš„ç»“æœ</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.329832</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;7&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">2.329832</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.2048805</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.966926</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred junior way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ruby engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1989-08-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#q=username<span class="punctuation">:</span>(alfred AND way)çš„ç»“æœ</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.2048805</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.2048805</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.966926</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred junior way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ruby engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1989-08-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>usernameå­—æ®µä¸­å¿…é¡»åŒ…å«alfredä½†æ˜¯æ²¡æœ‰wayçš„</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred NOT way)</span><br></pre></td></tr></table></figure><p>usernameå¿…é¡»å«æœ‰wayçš„</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:(alfred +way)  +ä¼šè¢«è¯†åˆ«ä¸ºç©ºæ ¼</span><br><span class="line">GET test_search_index/_search?q=username:(alfred %2Bway)</span><br></pre></td></tr></table></figure><p>èŒƒå›´æŸ¥è¯¢ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alfred age:&gt;26</span><br><span class="line">#usernameå­—æ®µåŒ…å«alfredæˆ–è€…ageå¤§äº26</span><br><span class="line">GET test_search_index/_search?q=username:alfred AND age:&gt;20</span><br><span class="line">#usernameå­—æ®µåŒ…å«alfredå¹¶ä¸”ageå¤§äº20</span><br><span class="line">GET test_search_index/_search?q=birth:(&gt;1980 AND &lt;1990)</span><br><span class="line">#birthå­—æ®µåœ¨1980åˆ°1990ä¹‹é—´</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¡¨è¾¾å¼å’Œé€šé…ç¬¦:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alf*</span><br><span class="line">GET test_search_index/_search?q=username:/[a]?l.*/</span><br></pre></td></tr></table></figure><p>æ¨¡ç³ŠæŸ¥è¯¢å’Œè¿‘ä¼¼åº¦ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?q=username:alfed~1</span><br><span class="line">GET test_search_index/_search?q=username:alfd~2</span><br><span class="line">GET test_search_index/_search?q=job:&quot;java engineer&quot;</span><br><span class="line">GET test_search_index/_search?q=job:&quot;java engineer&quot;~1</span><br></pre></td></tr></table></figure><h2 id="Request-Body-Search"><a href="#Request-Body-Search" class="headerlink" title="Request Body Search"></a>Request Body Search</h2><p>å°†æŸ¥è¯¢è¯­å¥é€šè¿‡http request body å‘é€åˆ°esï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹å‚æ•°ï¼š</p><ul><li>query: ç¬¦åˆQuery DSLè¯­æ³•çš„æŸ¥è¯¢è¯­å¥</li><li>from,size</li><li>timeout</li><li>sort</li><li>â€¦</li></ul><h3 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h3><p>Query DSL: åŸºäºjsonå®šä¹‰çš„æŸ¥è¯¢è¯­è¨€ï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹ä¸¤ç§ç±»å‹:</p><ul><li>å­—æ®µç±»æŸ¥è¯¢ï¼šå¦‚termã€matchã€rangeç­‰ï¼Œåªé’ˆå¯¹æŸä¸€å­—æ®µè¿›è¡ŒæŸ¥è¯¢</li><li>å¤åˆæŸ¥è¯¢ï¼šå¦‚boolæŸ¥è¯¢ç­‰ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µç±»æŸ¥è¯¢æˆ–è€…å¤åˆæŸ¥è¯¢è¯­å¥</li></ul><h4 id="å­—æ®µç±»æŸ¥è¯¢"><a href="#å­—æ®µç±»æŸ¥è¯¢" class="headerlink" title="å­—æ®µç±»æŸ¥è¯¢"></a>å­—æ®µç±»æŸ¥è¯¢</h4><p>å­—æ®µç±»æŸ¥è¯¢ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸¤ç±»ï¼š</p><ul><li>å…¨æ–‡åŒ¹é…ï¼šé’ˆå¯¹textç±»å‹çš„å­—æ®µè¿›è¡Œå…¨æ–‡æ£€ç´¢ï¼Œä¼šå¯¹æŸ¥è¯¢è¯­å¥å…ˆè¿›è¡Œåˆ†è¯å¤„ç†ï¼Œå¦‚match,match_phraseç­‰queryç±»å‹</li><li>å•è¯åŒ¹é…ï¼šä¸ä¼šå¯¹æŸ¥è¯¢è¯­å¥åšåˆ†è¯å¤„ç†ï¼Œç›´æ¥å»åŒ¹é…å­—æ®µçš„å€’æ’ç´¢å¼•ï¼Œå¦‚term,terms,rangeç­‰queryç±»å‹</li></ul><p>æŸ¥è¯¢ç¤ºä¾‹</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &quot;alfred way&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="/img/in-post/2019-03-15/1.png"></p><p>é€šè¿‡operatorå‚æ•°å¯ä»¥æ§åˆ¶å•è¯é—´çš„åŒ¹é…å…³ç³»ï¼Œå¯é€‰é¡¹ä¸ºorå’Œandï¼ˆé»˜è®¤ä¸ºorï¼‰<br>é€šè¿‡minimum_should_matchå‚æ•°å¯ä»¥æ§åˆ¶éœ€è¦åŒ¹é…çš„å•è¯æ•°</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;alfred way&quot;, </span><br><span class="line">        &quot;operator&quot;: &quot;and&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;alfred way&quot;, </span><br><span class="line">        &quot;minimum_should_match&quot;: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#`alfred` å’Œ `way`å¿…é¡»åŒæ—¶å­˜åœ¨æ‰èƒ½æ»¡è¶³</span><br></pre></td></tr></table></figure><h4 id="ç›¸å…³æ€§ç®—åˆ†"><a href="#ç›¸å…³æ€§ç®—åˆ†" class="headerlink" title="ç›¸å…³æ€§ç®—åˆ†"></a>ç›¸å…³æ€§ç®—åˆ†</h4><p>ç›¸å…³æ€§ç®—åˆ†æ˜¯æŒ‡æ–‡æ¡£ä¸æŸ¥è¯¢è¯­å¥é—´çš„ç›¸å…³åº¦ï¼Œè‹±æ–‡ä¸ºrelevance<br>é€šè¿‡å€’æ’ç´¢å¼•å¯ä»¥è·å–ä¸æŸ¥è¯¢è¯­å¥ç›¸åŒ¹é…çš„æ–‡æ¡£åˆ—è¡¨ï¼Œé‚£ä¹ˆå¦‚ä½•å°†æœ€ç¬¦åˆç”¨æˆ·æŸ¥è¯¢éœ€æ±‚çš„æ–‡æ¡£æ”¾åˆ°å‰åˆ—å‘¢ï¼Ÿæœ¬è´¨æ˜¯ä¸€ä¸ªæ’åºé—®é¢˜ï¼Œæ’åºä¾æ®æ˜¯ç›¸å…³æ€§ç®—åˆ†ã€‚</p><p>ç›¸å…³æ€§ç®—åˆ†çš„å‡ ä¸ªé‡è¦æ¦‚å¿µï¼š</p><ul><li><code>Term Frequencyï¼ˆTFï¼‰</code>: è¯é¢‘ï¼Œå³å•è¯åœ¨è¯¥æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚è¯é¢‘è¶Šé«˜ï¼Œç›¸å…³åº¦è¶Šé«˜</li><li><code>Document Frequencyï¼ˆDFï¼‰</code>: æ–‡æ¡£é¢‘ç‡ï¼Œå³å•è¯å‡ºç°çš„æ–‡æ¡£æ•°</li><li><code>Inverse Document Frequencyï¼ˆIDFï¼‰</code>:é€†å‘æ–‡æ¡£é¢‘ç‡ï¼Œä¸æ–‡æ¡£é¢‘ç‡ç›¸åï¼Œç®€å•ç†è§£ä¸º1&#x2F;DFã€‚å³å•è¯å‡ºç°çš„æ–‡æ¡£æ•°è¶Šå°‘ï¼Œç›¸å…³åº¦è¶Šé«˜ã€‚</li><li><code>Field-length Norm</code>: æ–‡æ¡£è¶ŠçŸ­ï¼Œç›¸å…³æ€§è¶Šé«˜</li></ul><p>ESç›®å‰ä¸»è¦æœ‰ä¸¤ä¸ªç›¸å…³æ€§ç®—åˆ†æ¨¡å‹ï¼š</p><ul><li>TF&#x2F;IDFæ¨¡å‹</li><li>BM25æ¨¡å‹ï¼š5.xä¹‹åçš„é»˜è®¤æ¨¡å‹</li></ul><p>å¯ä»¥é€šè¿‡explainå‚æ•°æ¥æŸ¥çœ‹å…·ä½“çš„è®¡ç®—æ–¹æ³•ï¼Œä½†è¦æ³¨æ„ï¼šesçš„ç®—åˆ†æ˜¯æŒ‰ç…§shardè¿›è¡Œçš„ï¼Œå³shardåˆ†æ•°è®¡ç®—æ—¶äº’ç›¸ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨explainçš„æ—¶å€™æ³¨æ„åˆ†ç‰‡æ•°ï¼›å¯ä»¥é€šè¿‡è®¾ç½®ç´¢å¼•çš„åˆ†ç‰‡æ•°ä¸º1æ¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;FIELD&quot;: &quot;TEXT&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Match-Phrase-Query"><a href="#Match-Phrase-Query" class="headerlink" title="Match-Phrase-Query"></a>Match-Phrase-Query</h4><p>å¯¹å­—æ®µä½œæ£€ç´¢,æœ‰é¡ºåºè¦æ±‚ï¼ŒAPIç¤ºä¾‹ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;job&quot;: &quot;engineer java&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡slopå‚æ•°å¯ä»¥æ§åˆ¶å•è¯é—´çš„é—´éš”,ç±»ä¼¼url searché‡Œçš„è¿‘ä¼¼åº¦åŒ¹é…</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;job&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;java engineer&quot;,</span><br><span class="line">        &quot;slop&quot;: 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Query-String-Query"><a href="#Query-String-Query" class="headerlink" title="Query-String-Query"></a>Query-String-Query</h4><p>ç±»ä¼¼äºURI Searchä¸­çš„qå‚æ•°æŸ¥è¯¢</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;default_field&quot;: &quot;job&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;engineer AND java&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤šå­—æ®µæŸ¥è¯¢</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;: [&quot;username&quot;, &quot;job&quot;],</span><br><span class="line">      &quot;query&quot;: &quot;engineer AND alfred&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Simple-Query-String-Query"><a href="#Simple-Query-String-Query" class="headerlink" title="Simple-Query-String-Query"></a>Simple-Query-String-Query</h4><p>ç±»ä¼¼Query String ,ä½†æ˜¯ä¼šå¿½ç•¥é”™è¯¯çš„æŸ¥è¯¢è¯­æ³•,å¹¶ä¸”ä»…æ”¯æŒéƒ¨åˆ†æŸ¥è¯¢è¯­æ³•<br>å…¶å¸¸ç”¨çš„é€»è¾‘ç¬¦å·å¦‚ä¸‹,ä¸èƒ½ä½¿ç”¨AND, OR, NOTç­‰å…³é”®è¯</p><ul><li>+ä»£æŒ‡AND</li><li>|ä»£æŒ‡OR</li><li>-ä»£æŒ‡NOTè¯·æ±‚</li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;simple_query_string&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;: [&quot;username&quot;],</span><br><span class="line">      &quot;query&quot;: &quot;alfred +way&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸?q&#x3D;alfred +wayä¸åŒçš„æ˜¯è¿™é‡Œçš„alfred å’Œ wayå¿…é¡»åŒæ—¶å­˜åœ¨</p></blockquote><h4 id="Term-Terms-Query"><a href="#Term-Terms-Query" class="headerlink" title="Term-Terms-Query"></a>Term-Terms-Query</h4><p>å°†æŸ¥è¯¢è¯­å¥ä½œä¸ºæ•´ä¸ªå•è¯è¿›è¡ŒæŸ¥è¯¢,å³ä¸å¯¹æŸ¥è¯¢è¯­å¥åšåˆ†è¯å¤„ç†:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &quot;alfred way&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ¬¡ä¼ å…¥å¤šä¸ªå•è¯è¿›è¡ŒæŸ¥è¯¢:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;terms&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: [</span><br><span class="line">        &quot;alfred&quot;,</span><br><span class="line">        &quot;way&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Range-Query"><a href="#Range-Query" class="headerlink" title="Range Query"></a>Range Query</h4><p>èŒƒå›´æŸ¥è¯¢ä¸»è¦é’ˆå¯¹æ•°å€¼å’Œæ—¥æœŸç±»å‹:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;gt&quot;: 20,</span><br><span class="line">        &quot;lt&quot;: 40</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>range è¿‡æ»¤å™¨æ—¢èƒ½åŒ…å«ä¹Ÿèƒ½æ’é™¤èŒƒå›´ï¼Œé€šè¿‡ä¸‹é¢çš„é€‰é¡¹ï¼š</p><ul><li>gt: &gt; å¤§äº</li><li>lt: &lt; å°äº</li><li>gte: &gt;&#x3D; å¤§äºæˆ–ç­‰äº</li><li>lte: &lt;&#x3D; å°äºæˆ–ç­‰äº</li></ul><p><code>range</code>è¿‡æ»¤å™¨ä¹Ÿå¯ä»¥ç”¨äºæ—¥æœŸå­—æ®µï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gt&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2014-01-01 00:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lt&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2014-01-07 00:00:00&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡æ»¤å™¨å°†å§‹ç»ˆèƒ½æ‰¾å‡ºæ‰€æœ‰æ—¶é—´æˆ³å¤§äºå½“å‰æ—¶é—´å‡ 1 å°æ—¶çš„æ–‡æ¡£ï¼Œè®©è¿™ä¸ªè¿‡æ»¤å™¨åƒç§»çª—ä¸€æ ·é€šè¿‡ä½ çš„æ–‡æ¡£ã€‚</p><p>æ—¥æœŸè®¡ç®—ä¹Ÿèƒ½ç”¨äºå®é™…çš„æ—¥æœŸï¼Œè€Œä¸æ˜¯ä»…ä»…æ˜¯ä¸€ä¸ªåƒ now ä¸€æ ·çš„å ä½ç¬¦ã€‚åªè¦åœ¨æ—¥æœŸååŠ ä¸ŠåŒç«–çº¿ ||ï¼Œå°±èƒ½ä½¿ç”¨æ—¥æœŸæ•°å­¦è¡¨è¾¾å¼äº†ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;range&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gt&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2014-01-01 00:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lt&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2014-01-01 00:00:00||+1M&quot;</span> &lt;<span class="number">1</span>&gt;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>&lt;1&gt; æ—©äº 2014 å¹´ 1 æœˆ 1 å·åŠ ä¸€ä¸ªæœˆ<br>æ—¥æœŸè®¡ç®—æ˜¯ä¸æ—¥å†ç›¸å…³çš„ï¼Œæ‰€ä»¥å®ƒçŸ¥é“æ¯ä¸ªæœˆçš„å¤©æ•°ï¼Œæ¯å¹´çš„å¤©æ•°ï¼Œç­‰ç­‰ã€‚æ›´è¯¦ç»†çš„å…³äºæ—¥æœŸçš„ä¿¡æ¯å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°<br><a target="_blank" rel="noopener" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-date-format.html">æ—¥æœŸæ ¼å¼æ‰‹å†Œ</a></p><p><code>range</code>è¿‡æ»¤å™¨ä¹Ÿå¯ä»¥ç”¨äºå­—ç¬¦ä¸²ã€‚å­—ç¬¦ä¸²èŒƒå›´æ ¹æ®å­—å…¸æˆ–å­—æ¯é¡ºåºæ¥è®¡ç®—ã€‚ä¾‹å¦‚ï¼Œè¿™äº›å€¼æŒ‰ç…§å­—å…¸é¡ºåºæ’åºï¼š<br>å‡å¦‚æˆ‘ä»¬æƒ³è®©èŒƒå›´ä» a å¼€å§‹è€Œä¸åŒ…å« bï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç±»ä¼¼çš„ range è¿‡æ»¤å™¨è¯­æ³•ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;range&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gte&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lt&quot;</span> <span class="punctuation">:</span>  <span class="string">&quot;b&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>æ•°å­—å’Œæ—¥æœŸå­—æ®µçš„ç´¢å¼•æ–¹å¼è®©ä»–ä»¬åœ¨è®¡ç®—èŒƒå›´æ—¶ååˆ†é«˜æ•ˆã€‚ä½†å¯¹äºå­—ç¬¦ä¸²æ¥è¯´å´ä¸æ˜¯è¿™æ ·ã€‚ä¸ºäº†åœ¨å­—ç¬¦ä¸²ä¸Šæ‰§è¡ŒèŒƒå›´æ“ä½œï¼ŒElasticsearch ä¼šåœ¨è¿™ä¸ªèŒƒå›´å†…çš„æ¯ä¸ªçŸ­è¯­æ‰§è¡Œ term æ“ä½œã€‚è¿™æ¯”æ—¥æœŸæˆ–æ•°å­—çš„èŒƒå›´æ“ä½œæ…¢å¾—å¤šã€‚<br> å­—ç¬¦ä¸²èŒƒå›´é€‚ç”¨äºä¸€ä¸ªåŸºæ•°è¾ƒå°çš„å­—æ®µï¼Œä¸€ä¸ªå”¯ä¸€çŸ­è¯­ä¸ªæ•°è¾ƒå°‘çš„å­—æ®µã€‚ä½ çš„å”¯ä¸€çŸ­è¯­æ•°è¶Šå¤šï¼Œæœç´¢å°±è¶Šæ…¢ã€‚</p></blockquote><h4 id="å¤åˆæŸ¥è¯¢"><a href="#å¤åˆæŸ¥è¯¢" class="headerlink" title="å¤åˆæŸ¥è¯¢"></a>å¤åˆæŸ¥è¯¢</h4><p>å¤åˆæŸ¥è¯¢æ˜¯æŒ‡åŒ…å«å­—æ®µç±»æŸ¥è¯¢æˆ–å¤åˆæŸ¥è¯¢çš„ç±»å‹,ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç±»:</p><ul><li>constant_score query</li><li>bool query</li><li>dis_max query</li><li>function_score query</li><li>boosting query</li></ul><p><strong>Constant Score Query</strong><br>è¯¥æŸ¥è¯¢å°†å…¶å†…éƒ¨çš„æŸ¥è¯¢ç»“æœæ–‡æ¡£å¾—åˆ†éƒ½è®¾å®šä¸º1æˆ–è€…boostçš„å€¼<br>å¤šç”¨äºç»“åˆboolæŸ¥è¯¢å®ç°è‡ªå®šä¹‰å¾—åˆ†</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;username&quot;: &quot;alfred&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java senior engineer and java specialist&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1980-05-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred junior way&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ruby engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1989-08-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Bool-Query"><a href="#Bool-Query" class="headerlink" title="Bool Query"></a>Bool Query</h4><p>å¸ƒå°”æŸ¥è¯¢ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå¸ƒå°”å­å¥ç»„æˆ,ä¸»è¦åŒ…å«å¦‚ä¸‹4ä¸ª:</p><table><thead><tr><th>å­å¥</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>filter</td><td>åªè¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£ï¼Œä¸è®¡ç®—ç›¸å…³æ€§ç®—åˆ†</td></tr><tr><td>must</td><td>æ–‡æ¡£å¿…é¡»ç¬¦åˆmustä¸­æ‰€æœ‰æ¡ä»¶ï¼Œå½±å“ç›¸å…³æ€§ç®—åˆ†</td></tr><tr><td>must_not</td><td>æ–‡æ¡£å¿…é¡»ä¸ç¬¦åˆmustä¸­æ‰€æœ‰æ¡ä»¶</td></tr><tr><td>should</td><td>æ–‡æ¡£å¯ä»¥ç¬¦åˆshouldä¸­çš„æ¡ä»¶ï¼Œä¸è®¡ç®—ç›¸å…³æ€§ç®—åˆ†</td></tr></tbody></table><p><strong>filter</strong><br>API:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Filter</code>æŸ¥è¯¢åªè¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£,ä¸ä¼šè¿›è¡Œç›¸å…³æ€§ç®—åˆ†</p><p>esé’ˆå¯¹<code>filter</code>ä¼šæœ‰æ™ºèƒ½ç¼“å­˜,å› æ­¤å…¶æ‰§è¡Œæ•ˆç‡å¾ˆé«˜<br>åšç®€å•åŒ¹é…æŸ¥è¯¢ä¸”ä¸è€ƒè™‘ç®—åˆ†æ—¶,æ¨èä½¿ç”¨<code>filter</code>æ›¿ä»£<code>query</code>ç­‰</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;username&quot;:&quot;alfred&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>must</strong>:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;username&quot;:&quot;alfred&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;job&quot;:&quot;java&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœ:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.2314217</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java senior engineer and java specialist&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1980-05-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.1256535</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred way&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p><code>_score</code>ä¸ºä¸¤ä¸ªmatchæŸ¥è¯¢åˆ°çš„åˆ†æ•°ä¹‹å’Œ</p></blockquote><p><strong>must_not</strong>:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;username&quot;:&quot;alfred&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;job&quot;:&quot;specialist&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åŒ¹é…usernameåŒ…å«<code>alfred</code>å¹¶ä¸”jobä¸èƒ½åŒ…å«<code>specialist</code></p></blockquote><p><strong>Should</strong>:</p><ul><li>Shouldä½¿ç”¨åˆ†ä¸¤ç§æƒ…å†µ:<ul><li>boolæŸ¥è¯¢ä¸­åªåŒ…å«should ,ä¸åŒ…å«mustæŸ¥è¯¢</li><li>boolæŸ¥è¯¢ä¸­åŒæ—¶åŒ…å«shouldå’ŒmustæŸ¥è¯¢</li></ul></li><li>åªåŒ…å«shouldæ—¶,æ–‡æ¡£å¿…é¡»æ»¡è¶³è‡³å°‘ä¸€ä¸ªæ¡ä»¶<ul><li>minimum_should_matchå¯ä»¥æ§åˆ¶æ»¡è¶³æ¡ä»¶çš„ä¸ªæ•°æˆ–è€…ç™¾åˆ†æ¯”</li></ul></li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;username&quot;: &quot;alfred&quot;&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;username&quot;: &quot;way&quot;&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;username&quot;: &quot;junior&quot;&#125;&#125;</span><br><span class="line">      ], </span><br><span class="line">      &quot;minimum_should_match&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.8147054</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred junior way&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ruby engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1989-08-07&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_search_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.97797304</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;alfred way&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;java engineer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;birth&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1990-01-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isMarried&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>minimum_should_matchåŠ ä¸Šååªè¿”å›äº†ä¸¤ä¸ªç»“æœ</p></blockquote><p>åŒæ—¶åŒ…å«shouldå’Œmustæ—¶,æ–‡æ¡£ä¸å¿…æ»¡è¶³shouldä¸­çš„æ¡ä»¶,ä½†æ˜¯å¦‚æœæ»¡è¶³æ¡ä»¶,ä¼šå¢åŠ ç›¸å…³æ€§å¾—åˆ†</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;job&quot;: &quot;ruby&quot;&#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;username&quot;: &quot;alfred&quot;&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>job</code> ä¸º<code>ruby</code>çš„ä¼šå¢åŠ åˆ†æ•°æ’åæ›´é å‰</p></blockquote><h4 id="Query-Context-VS-Filter-Context"><a href="#Query-Context-VS-Filter-Context" class="headerlink" title="Query Context VS Filter Context"></a>Query Context VS Filter Context</h4><p>å½“ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ä½äºQueryæˆ–è€…Filterä¸Šä¸‹æ–‡æ—¶, esæ‰§è¡Œçš„ç»“æœä¼šä¸åŒ,å¯¹æ¯”å¦‚ä¸‹:</p><table><thead><tr><th>ä¸Šä¸‹æ–‡ç±»å‹</th><th>æ‰§è¡Œç±»å‹</th><th>ä½¿ç”¨æ–¹å¼</th></tr></thead><tbody><tr><td>æŸ¥æ‰¾ä¸æŸ¥è¯¢è¯­å¥æœ€åŒ¹é…çš„æ–‡æ¡£ï¼Œå¯¹æ‰€æœ‰æ–‡æ¡£è¿›è¡Œç®—åˆ†å’Œæ’åº</td><td>query<br>boolä¸­çš„<code>must</code>å’Œ<code>should</code></td><td></td></tr><tr><td>æŸ¥æ‰¾ä¸æŸ¥è¯¢è¯­å¥ç›¸åŒ¹é…çš„æ–‡æ¡£</td><td>boolä¸­çš„<code>filter</code>ä¸<code>must_not</code><br>constant_scoreä¸­çš„<code>filter</code></td><td></td></tr></tbody></table><h4 id="Count-And-Source-Filtering"><a href="#Count-And-Source-Filtering" class="headerlink" title="Count And Source Filtering"></a>Count And Source Filtering</h4><p><strong>count</strong></p><p>è·å–ç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£æ•°, endpointä¸º<code>_count</code></p><p><strong>source filtering</strong><br>è¿‡æ»¤è¿”å›ç»“æœä¸­sourceä¸­çš„å­—æ®µ,ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼:</p><p><strong>uri:</strong></p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search?_source=username</span><br></pre></td></tr></table></figure><p><strong>ç¦ç”¨source:</strong></p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼ å­—æ®µå:</strong></p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: [&quot;username&quot;,&quot;job&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŒ…æ‹¬å’Œä¸åŒ…æ‹¬æ¨¡ç³ŠåŒ¹é…</strong></p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;includes&quot;: &quot;*i*&quot;,</span><br><span class="line">    &quot;excludes&quot;: &quot;birth&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/03/14/2022-03-14-elasticsearch-num-4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/03/14/2022-03-14-elasticsearch-num-4/" class="post-title-link" itemprop="url">elasticsearchå…¥é—¨(äºŒ)</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-14 14:30:00" itemprop="dateCreated datePublished" datetime="2022-03-14T14:30:00+08:00">2022-03-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="mapping"><a href="#mapping" class="headerlink" title="mapping"></a>mapping</h2><p>mappingæ˜¯ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„è¡¨ç»“æ„å®šä¹‰ï¼Œä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li>å®šä¹‰indexä¸‹çš„å­—æ®µå</li><li>å®šä¹‰å­—æ®µç±»å‹ï¼Œæ¯”å¦‚æ•°å€¼å‹ã€æµ®ç‚¹å‹ã€å¸ƒå°”å‹ç­‰</li><li>å®šä¹‰å€’æ’ç´¢å¼•ç›¸å…³çš„è®¾ç½®ï¼Œæ¯”å¦‚æ˜¯å¦ç´¢å¼•ã€è®°å½•positionç­‰</li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;: &quot;jack&quot;,</span><br><span class="line">  &quot;age&quot;: 15</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_index/_mapping</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-14/1.png"></p><h3 id="è‡ªå®šä¹‰mapping"><a href="#è‡ªå®šä¹‰mapping" class="headerlink" title="è‡ªå®šä¹‰mapping"></a>è‡ªå®šä¹‰mapping</h3><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic&quot;: false,</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;username&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mappingä¸­çš„å­—æ®µç±»å‹ä¸€æ—¦è®¾ç½®ï¼Œç¦æ­¢ç›´æ¥ä¿®æ”¹ï¼Œå› ä¸º luceneå®ç°çš„å€’æ’ç´¢å¼•ç”Ÿæˆåä¸å…è®¸ä¿®æ”¹ï¼Œåº”è¯¥é‡æ–°å»ºç«‹æ–°çš„ç´¢å¼•ï¼Œç„¶ååšreindexæ“ä½œã€‚</p><p>ä½†æ˜¯å¯ä»¥æ–°å¢å­—æ®µï¼Œé€šè¿‡ dynamic å‚æ•°æ¥æ§åˆ¶å­—æ®µçš„æ–°å¢ï¼Œè¿™ä¸ªå‚æ•°çš„å€¼å¦‚ä¸‹ï¼š</p><p>trueï¼šé»˜è®¤å€¼ï¼Œè¡¨ç¤ºå…è®¸é€‰è‡ªåŠ¨æ–°å¢å­—æ®µ<br>falseï¼šä¸å…è®¸è‡ªåŠ¨æ–°å¢å­—æ®µï¼Œä½†æ˜¯æ–‡æ¡£å¯ä»¥æ­£å¸¸å†™å…¥ï¼Œä½†æ— æ³•å¯¹å­—æ®µè¿›è¡ŒæŸ¥è¯¢ç­‰æ“ä½œ<br>strictï¼šä¸¥æ ¼æ¨¡å¼ï¼Œæ–‡æ¡£ä¸èƒ½å†™å…¥ï¼ŒæŠ¥é”™</p><p>ç„¶åå†™å…¥ä¸€ä¸ªæ–‡æ¡£:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;: &quot;lili&quot;,</span><br><span class="line">  &quot;desc&quot;: &quot;this is my index&quot;,</span><br><span class="line">  &quot;age&quot;: 20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨mappingè®¾ç½®ä¸­ï¼Œâ€dynamicâ€: falseï¼Œè¡¨ç¤ºåœ¨å†™å…¥æ–‡æ¡£æ—¶ï¼Œå¦‚æœå†™å…¥å­—æ®µä¸å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚è¿™é‡Œçš„descå­—æ®µå°±æ˜¯ä¸å­˜åœ¨çš„å­—æ®µã€‚</p></blockquote><p>æŸ¥è¯¢æ–‡æ¡£</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &quot;lili&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;desc&quot;: &quot;this is my index&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;lili&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;desc&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;this is my index&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯¹æ¯”ä¸¤ä¸ªç»“æœå¯ä»¥çœ‹å‡ºèƒ½é€šè¿‡mappingä¸­è®¾ç½®çš„å­—æ®µæŸ¥è¯¢åˆ°</p><h3 id="copy-to"><a href="#copy-to" class="headerlink" title="copy_to"></a>copy_to</h3><p>ä½œç”¨æ˜¯å°†è¯¥å­—æ®µçš„å€¼å¤åˆ¶åˆ°ç›®æ ‡å­—æ®µï¼Œå®ç°ç±»ä¼¼ï¼ˆ6.0ç‰ˆæœ¬ä¹‹å‰çš„ï¼‰_allçš„ä½œç”¨ã€‚ä¸ä¼šå‡ºç°åœ¨_sourceä¸­ï¼Œåªèƒ½ç”¨æ¥æœç´¢ã€‚</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;first_name&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;copy_to&quot;: &quot;full_name&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;last_name&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;copy_to&quot;: &quot;full_name&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;full_name&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PUTï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index2/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;first_name&quot;: &quot;David&quot;,</span><br><span class="line">  &quot;last_name&quot;: &quot;john&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET my_index2/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;full_name&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;David john&quot;,</span><br><span class="line">        &quot;operator&quot;: &quot;and&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœ:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">316</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;my_index2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;first_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;David&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;last_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;john&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>å¯ä»¥é€šè¿‡full_nameæ¥æŸ¥è¯¢first_nameï¼Œlastnameä¸¤ä¸ªå­—æ®µï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™ï¼Œä½†æ˜¯ä¸€æ—¦æœ‰ä¸€ä¸ªå­—æ®µçš„å€¼åŒ¹é…ä¸ä¸Šï¼Œå°±ä¼šè¿”å›ä¸ºç©º</p></blockquote><h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p>indexå‚æ•°ä½œç”¨æ˜¯æ§åˆ¶å½“å‰å­—æ®µæ˜¯å¦è¢«ç´¢å¼•ï¼Œé»˜è®¤ä¸ºtrueï¼Œfalseè¡¨ç¤ºä¸è®°å½•ï¼Œå³ä¸å¯è¢«æœç´¢ã€‚</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;cookie&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;index&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;index&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index3/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;cookie&quot;: &quot;efdfsdiadsasd&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is a cookie&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢æµ‹è¯•ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET my_index3/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;cookie&quot;: &quot;efdfsdiadsasd&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index3/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;this is a cookie&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>cookieå­—æ®µä¸å¯è¢«æŸ¥è¯¢</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query_shard_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;failed to create query: &#123;\n  \&quot;match\&quot; : &#123;\n    \&quot;cookie\&quot; : &#123;\n      \&quot;query\&quot; : \&quot;efdfsdiadsasd\&quot;,\n      \&quot;operator\&quot; : \&quot;OR\&quot;,\n      \&quot;prefix_length\&quot; : 0,\n      \&quot;max_expansions\&quot; : 50,\n      \&quot;fuzzy_transpositions\&quot; : true,\n      \&quot;lenient\&quot; : false,\n      \&quot;zero_terms_query\&quot; : \&quot;NONE\&quot;,\n      \&quot;auto_generate_synonyms_phrase_query\&quot; : true,\n      \&quot;boost\&quot; : 1.0\n    &#125;\n  &#125;\n&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5iLoJa4vRmiWA23sZ8-4TQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index3&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;search_phase_execution_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all shards failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grouped&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index3&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IWeH0fFvQD604ZiJ9OAdRw&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query_shard_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;failed to create query: &#123;\n  \&quot;match\&quot; : &#123;\n    \&quot;cookie\&quot; : &#123;\n      \&quot;query\&quot; : \&quot;efdfsdiadsasd\&quot;,\n      \&quot;operator\&quot; : \&quot;OR\&quot;,\n      \&quot;prefix_length\&quot; : 0,\n      \&quot;max_expansions\&quot; : 50,\n      \&quot;fuzzy_transpositions\&quot; : true,\n      \&quot;lenient\&quot; : false,\n      \&quot;zero_terms_query\&quot; : \&quot;NONE\&quot;,\n      \&quot;auto_generate_synonyms_phrase_query\&quot; : true,\n      \&quot;boost\&quot; : 1.0\n    &#125;\n  &#125;\n&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5iLoJa4vRmiWA23sZ8-4TQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index3&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cannot search on field [cookie] since it is not indexed.&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="index-options"><a href="#index-options" class="headerlink" title="index_options"></a>index_options</h3><ul><li><p>index_optionsçš„ä½œç”¨æ˜¯ç”¨äºæ§åˆ¶å€’æ’ç´¢å¼•è®°å½•çš„å†…å®¹ï¼Œæœ‰å¦‚ä¸‹å››ç§é…ç½®ï¼š</p><ul><li>docsï¼šåªè®°å½•doc id</li><li>freqsï¼šè®°å½•doc id å’Œterm frequencies</li><li>positionsï¼šè®°å½•doc idã€ term frequencieså’Œterm position</li><li>offsetsï¼šè®°å½•doc idã€ term frequenciesã€term positionã€character offsets</li></ul></li><li><p>textç±»å‹çš„é»˜è®¤é…ç½®ä¸ºpositionsï¼Œå…¶ä»–é»˜è®¤ä¸ºdocsã€‚</p></li><li><p>è®°å½•çš„å†…å®¹è¶Šå¤šï¼Œå æ®çš„ç©ºé—´è¶Šå¤§ã€‚</p></li></ul><p>index_optionsè®¾å®šï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;text&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;index_options&quot;: &quot;offsets&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PUT:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index4/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: &quot;Quick brown fox&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET my_index4/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;text&quot;: &quot;brown fox&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;text&quot;: &#123;&#125; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">68</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;my_index4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Quick brown fox&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;highlight&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;Quick &lt;em&gt;brown&lt;/em&gt; &lt;em&gt;fox&lt;/em&gt;&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>brown foxä¼šè¢«é«˜äº®æ˜¾ç¤º</p><h3 id="null-value"><a href="#null-value" class="headerlink" title="null_value"></a>null_value</h3><p>è¿™ä¸ªå‚æ•°çš„ä½œç”¨æ˜¯å½“å­—æ®µé‡åˆ°nullå€¼çš„æ—¶å€™çš„å¤„ç†ç­–ç•¥ï¼Œé»˜è®¤ä¸ºnullï¼Œå³ç©ºå€¼ï¼Œæ­¤æ—¶esä¼šå¿½ç•¥è¯¥å€¼ã€‚å¯ä»¥é€šè¿‡è¿™ä¸ªå‚æ•°è®¾ç½®æŸä¸ªå­—æ®µçš„é»˜è®¤å€¼</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;status_code&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;null_value&quot;: &quot;NULL&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index5/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status_code&quot;: null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index5/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status_code&quot;: [] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index5/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;status_code&quot;: &quot;NULL&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;my_index5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;status_code&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ol><li>ç”¨æœ¯è¯­nullæ›¿æ¢æ˜¾å¼nullå€¼ã€‚</li><li>ç©ºæ•°ç»„ä¸åŒ…å«æ˜¾å¼nullï¼Œå› æ­¤ä¸ä¼šç”¨null_valueæ›¿æ¢ã€‚</li><li>å¯¹NULLçš„æŸ¥è¯¢è¿”å›æ–‡æ¡£1ï¼Œè€Œä¸æ˜¯æ–‡æ¡£2ã€‚<blockquote><p>null_valueéœ€è¦ä¸å­—æ®µå…·æœ‰ç›¸åŒçš„æ•°æ®ç±»å‹ã€‚ä¾‹å¦‚ï¼Œé•¿å­—æ®µä¸èƒ½æœ‰å­—ç¬¦ä¸²null_valueã€‚<br>null_valueåªå½±å“æ•°æ®çš„ç´¢å¼•æ–¹å¼ï¼Œå®ƒä¸ä¿®æ”¹_sourceæ–‡æ¡£ã€‚</p></blockquote></li></ol><p>æ›´å¤šè¯¦è§<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html">Mapping parameters</a></p><h3 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h3><p><strong>æ ¸å¿ƒæ•°æ®ç±»å‹</strong></p><ul><li>å­—ç¬¦ä¸²å‹ï¼štextã€keywordï¼ˆä¸ä¼šåˆ†è¯ï¼‰</li><li>æ•°å€¼å‹ï¼šlongã€integerã€shortã€byteã€doubleã€floatã€half_floatç­‰</li><li>æ—¥æœŸç±»å‹ï¼šdate</li><li>å¸ƒå°”ç±»å‹ï¼šboolean</li><li>äºŒè¿›åˆ¶ç±»å‹ï¼šbinary</li><li>èŒƒå›´ç±»å‹ï¼šinteger_rangeã€float_rangeã€long_rangeã€double_rangeã€date_range</li></ul><p><strong>å¤æ‚æ•°æ®ç±»å‹</strong></p><ul><li>æ•°ç»„ç±»å‹ï¼šarray</li><li>å¯¹è±¡ç±»å‹ï¼šobject</li><li>åµŒå¥—ç±»å‹ï¼šnested object</li><li>åœ°ç†ä½ç½®æ•°æ®ç±»å‹ï¼šgeo_pointã€geo_shape</li><li>ä¸“ç”¨ç±»å‹ï¼šipï¼ˆè®°å½•ipåœ°å€ï¼‰ã€completionï¼ˆå®ç°è‡ªåŠ¨è¡¥å…¨ï¼‰ã€token_countï¼ˆè®°å½•åˆ†è¯æ•°ï¼‰ã€murmur3ï¼ˆè®°å½•å­—ç¬¦ä¸²hashå€¼ï¼‰</li></ul><p><strong>å¤šå­—æ®µç‰¹æ€§</strong></p><ul><li>å¤šå­—æ®µç‰¹æ€§ï¼ˆmulti-fieldsï¼‰ï¼Œè¡¨ç¤ºå…è®¸å¯¹åŒä¸€å­—æ®µé‡‡ç”¨ä¸åŒçš„é…ç½®ï¼Œæ¯”å¦‚åˆ†è¯ã€‚</li></ul><p>å¸¸è§ä¾‹å­æ˜¯å¯¹äººåå®ç°æ‹¼éŸ³æœç´¢ï¼Œåªéœ€è¦åœ¨äººåä¸­æ–°å¢ä¸€ä¸ªå­—æ®µpinyinå³å¯ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼ä¸æ˜¯ååˆ†ä¼˜é›…ï¼Œmulti-fieldså¯ä»¥åœ¨ä¸æ”¹å˜æ•´ä½“ç»“æ„çš„å‰æä¸‹ï¼Œå¢åŠ ä¸€ä¸ªå­å­—æ®µï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index6</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;username&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;pinyin&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;analyzer&quot;: &quot;pinyin&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET my_index6</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;username.pinyin&quot;: &quot;pinyin&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Dynamic-mapping"><a href="#Dynamic-mapping" class="headerlink" title="Dynamic mapping"></a>Dynamic mapping</h3><p>Elasticsearchæœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯ï¼Œå®ƒè¯•å›¾æ‘†è„±æ‚¨çš„é˜»ç¢ï¼Œè®©æ‚¨å°½å¯èƒ½å¿«åœ°å¼€å§‹ç ”ç©¶æ‚¨çš„æ•°æ®ã€‚è¦ä¸ºæ–‡æ¡£å»ºç«‹ç´¢å¼•ï¼Œæ‚¨ä¸éœ€è¦é¦–å…ˆåˆ›å»ºç´¢å¼•ã€å®šä¹‰æ˜ å°„ç±»å‹å’Œå­—æ®µâ€”â€”æ‚¨åªéœ€è¦ä¸ºæ–‡æ¡£å»ºç«‹ç´¢å¼•ï¼Œç´¢å¼•ã€ç±»å‹å’Œå­—æ®µå°±ä¼šè‡ªåŠ¨å‡ºç°:</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“åœ¨æ–‡æ¡£ä¸­å‘ç°ä»¥å‰æ²¡æœ‰çœ‹åˆ°çš„å­—æ®µæ—¶ï¼ŒElasticsearchå°†æŠŠæ–°å­—æ®µæ·»åŠ åˆ°ç±»å‹æ˜ å°„ä¸­ã€‚é€šè¿‡å°†åŠ¨æ€å‚æ•°è®¾ç½®ä¸ºfalse(å¿½ç•¥æ–°å­—æ®µ)æˆ–strict(é‡åˆ°æœªçŸ¥å­—æ®µæ—¶æŠ›å‡ºå¼‚å¸¸)ï¼Œå¯ä»¥åœ¨æ–‡æ¡£å’Œå¯¹è±¡çº§åˆ«ç¦ç”¨æ­¤è¡Œä¸º</p><p>å­—æ®µæ˜ å°„è§„åˆ™</p><table><thead><tr><th>JSONç±»å‹</th><th>ESç±»å‹</th></tr></thead><tbody><tr><td>null</td><td>å¿½ç•¥</td></tr><tr><td>true or false</td><td>boolean</td></tr><tr><td>floating point number</td><td>float</td></tr><tr><td>integer</td><td>long</td></tr><tr><td>object</td><td>object</td></tr><tr><td>array</td><td>å–å†³äºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªéç©ºå€¼ã€‚</td></tr><tr><td>string</td><td>è¦ä¹ˆæ˜¯ä¸€ä¸ªæ—¥æœŸå­—æ®µ(å¦‚æœå€¼é€šè¿‡äº†æ—¥æœŸæ£€æµ‹)ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªåŒå­—æ®µæˆ–é•¿å­—æ®µ(å¦‚æœå€¼é€šè¿‡äº†æ•°å€¼æ£€æµ‹)ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªå¸¦æœ‰å…³é”®å­—å­å­—æ®µçš„æ–‡æœ¬å­—æ®µã€‚</td></tr></tbody></table><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index</span><br><span class="line">PUT /test_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;alfred&quot;,</span><br><span class="line">  &quot;age&quot;:1.2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;username.keyword&quot;: &quot;alfred&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä½ ç´¢å¼•ä¸€ä¸ªåŒ…å«æ–°å­—æ®µçš„æ–‡æ¡£â€”â€”ä¸€ä¸ªä¹‹å‰æ²¡æœ‰çš„å­—æ®µâ€”â€”Elasticsearchå°†ä½¿ç”¨åŠ¨æ€æ˜ å°„çŒœæµ‹å­—æ®µç±»å‹ï¼Œè¿™ç±»å‹æ¥è‡ªäºJSONçš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä½¿ç”¨ä»¥ä¸‹è§„åˆ™ï¼š</p><table><thead><tr><th>JSON type</th><th>Field type</th></tr></thead><tbody><tr><td>Boolean: <code>true</code> or <code>false</code></td><td><code>&quot;boolean&quot;</code></td></tr><tr><td>Whole number: <code>123</code></td><td><code>&quot;long&quot;</code></td></tr><tr><td>Floating point: <code>123.45</code></td><td><code>&quot;double&quot;</code></td></tr><tr><td>String, valid date: <code>&quot;2014-09-15&quot;</code></td><td><code>&quot;date&quot;</code></td></tr><tr><td>String: <code>&quot;foo bar&quot;</code></td><td><code>&quot;string&quot;</code></td></tr></tbody></table><blockquote><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ ç´¢å¼•ä¸€ä¸ªå¸¦å¼•å·çš„æ•°å­—â€”â€”<code>&quot;123&quot;</code>ï¼Œå®ƒå°†è¢«æ˜ å°„ä¸º<code>&quot;string&quot;</code>ç±»å‹ï¼Œè€Œä¸æ˜¯<code>&quot;long&quot;</code>ç±»å‹ã€‚ç„¶è€Œï¼Œå¦‚æœå­—æ®µå·²ç»è¢«æ˜ å°„ä¸º<code>&quot;long&quot;</code>ç±»å‹ï¼ŒElasticsearchå°†å°è¯•è½¬æ¢å­—ç¬¦ä¸²ä¸ºlongï¼Œå¹¶åœ¨è½¬æ¢å¤±è´¥æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p></blockquote><h3 id="æ—¥æœŸè‡ªåŠ¨è¯†åˆ«"><a href="#æ—¥æœŸè‡ªåŠ¨è¯†åˆ«" class="headerlink" title="æ—¥æœŸè‡ªåŠ¨è¯†åˆ«"></a>æ—¥æœŸè‡ªåŠ¨è¯†åˆ«</h3><p>æ—¥æœŸçš„è‡ªåŠ¨è¯†åˆ«å¯ä»¥è‡ªè¡Œé…ç½®æ—¥æœŸçš„æ ¼å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;strict_date_opeional_time&quot;</span>, <span class="string">&quot;yyyy/MM/dd HH:mm:ss Z||yyyy/MM/dd Z&quot;</span>]</span><br></pre></td></tr></table></figure><p>strict_date_opeional_time æ˜¯ISO æ ‡å‡†çš„æ—¥æœŸæ ¼å¼ï¼Œå®Œæ•´çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YYYY-MM-DDhh:mm:ssTZD(eg:1997-07-16y19:20:30+01:00)</span><br></pre></td></tr></table></figure><p>dynamic_date_formatsï¼šå¯ä»¥è‡ªå®šä¹‰æ—¥æœŸç±»å‹<br>date_detectionï¼šå¯ä»¥å…³é—­æ—¥æœŸè‡ªåŠ¨è¯†åˆ«æœºåˆ¶ï¼ˆé»˜è®¤å¼€å¯ï¼‰<br>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ—¥æœŸè‡ªåŠ¨è¯†åˆ«çš„ç´¢å¼•ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_index</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_date_formats&quot;: [&quot;MM/dd/yyyy&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;create_time&quot;: &quot;09/21/2016&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_mapping</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;my_index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic_date_formats&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;MM/dd/yyyy&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;create_time&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;MM/dd/yyyy&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å…³é—­æ—¥æœŸè‡ªåŠ¨è¯†åˆ«å¯ä»¥å¦‚ä¸‹ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;date_detection&quot;: false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index1/_doc/1 </span><br><span class="line">&#123;</span><br><span class="line">  &quot;create&quot;: &quot;2015/09/02&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰æ—¶é—´ç±»å‹:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_date_formats&quot;: [&quot;MM/dd/yyyy&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index2/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;create_date&quot;: &quot;09/25/2015&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°å­—è‡ªåŠ¨è¯†åˆ«"><a href="#æ•°å­—è‡ªåŠ¨è¯†åˆ«" class="headerlink" title="æ•°å­—è‡ªåŠ¨è¯†åˆ«"></a>æ•°å­—è‡ªåŠ¨è¯†åˆ«</h3><p>å­—ç¬¦ä¸²ä¸ºæ•°å­—çš„æ—¶å€™ï¼Œé»˜è®¤ä¸ä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºæ•´å‹ï¼Œå› ä¸ºå­—ç¬¦ä¸²ä¸­å‡ºç°æ•°å­—æ˜¯å®Œå…¨åˆç†çš„ã€‚numeric_detection å¯ä»¥å¼€å¯å­—ç¬¦ä¸²ä¸­æ•°å­—çš„è‡ªåŠ¨è¯†åˆ«</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_index3</span><br><span class="line">PUT my_index3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;numeric_detection&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index3/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;my_float&quot;:   &quot;1.0&quot;, </span><br><span class="line">  &quot;my_integer&quot;: &quot;1&quot; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index3/_mapping</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;my_index3&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;numeric_detection&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;my_float&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;float&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;my_integer&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="Dynamic-Template"><a href="#Dynamic-Template" class="headerlink" title="Dynamic Template"></a>Dynamic Template</h3><p>å…è®¸æ ¹æ®esè‡ªåŠ¨è¯†åˆ«çš„æ•°æ®ç±»å‹ã€å­—æ®µåç­‰åŠ¨æ€è®¾å®šå­—æ®µç±»å‹ï¼Œå¯ä»¥å®ç°å¦‚ä¸‹æ•ˆæœ:</p><ul><li>æ‰€æœ‰å­—ç¬¦ä¸²éƒ½è®¾å®šä¸º<code>keyword</code>ç±»å‹ï¼Œå³é»˜è®¤ä¸åˆ†è¯</li><li>æ‰€æœ‰ä»¥messageå¼€å¤´å­—æ®µéƒ½è®¾å®šä¸º<code>text</code>ç±»å‹ï¼Œå³åˆ†è¯</li><li>æ‰€æœ‰ä»¥long_å¼€å¤´çš„å­—æ®µéƒ½è®¾å®šä¸º<code>long</code>ç±»å‹</li><li>æ‰€æœ‰è‡ªåŠ¨åŒ¹é…ä¸ºdoubleç±»å‹çš„éƒ½è®¾å®šä¸º<code>float</code>ç±»å‹ï¼Œä»¥èŠ‚çœç©ºé—´</li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;strings&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT test_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;alfred&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test_index/_mapping </span><br></pre></td></tr></table></figure><p>åŒ¹é…è§„åˆ™ä¸€èˆ¬æœ‰å¦‚ä¸‹å‡ ä¸ªå‚æ•°ï¼š</p><ul><li>match_mapping_type: åŒ¹é…esè‡ªåŠ¨è¯†åˆ«çš„å­—æ®µç±»å‹ï¼Œå¦‚<code>boolean</code>,<code>long</code>,<code>string</code>ç­‰</li><li>match,unmatchï¼šåŒ¹é…å­—æ®µå</li><li>path_match,path_unmatch: åŒ¹é…è·¯å¾„</li></ul><p><strong>è®¾ç½®ä»¥messageå¼€å¤´çš„å­—æ®µéƒ½è®¾ç½®ä¸ºtextç±»å‹ ï¼ˆé¡ºåºç”±ä¸Šè€Œä¸‹ï¼‰</strong></p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;message_as_text&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;match&quot;: &quot;message*&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Index-Template"><a href="#Index-Template" class="headerlink" title="Index Template"></a>Index Template</h3><p><code>Index Template</code>å¸®ä½ è®¾å®šmappingså’Œsettings,å¹¶æŒ‰ç…§ä¸€å®šè§„åˆ™ï¼Œè‡ªåŠ¨åŒ¹é…åˆ°æ–°åˆ›å»ºçš„ç´¢å¼•ä¸Š</p><ul><li>ä»…ç”Ÿæ•ˆä¸æ–°åˆ›å»ºçš„ç´¢å¼•ï¼Œä¸ä¼šå½±å“ä¹‹å‰çš„ç´¢å¼•</li><li>å¯è®¾å®šå¤šä¸ªï¼Œä¼šè‡ªåŠ¨<code>merge</code>åœ¨ä¸€èµ·</li><li>å¯æŒ‡å®š<code>order</code>å€¼,æ§åˆ¶mergingçš„è¿‡ç¨‹</li></ul><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/default_template</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index_patterns&quot;: [&quot;*&quot;],</span><br><span class="line">  &quot;order&quot;: 0,</span><br><span class="line">  &quot;version&quot;: 1,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 3,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT _template/default_template1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index_patterns&quot;: [&quot;*&quot;],</span><br><span class="line">  &quot;order&quot;: 1,</span><br><span class="line">  &quot;version&quot;: 1,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 3,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å·¥ä½œæ–¹å¼:</p><p>å½“ä¸€ä¸ªç´¢å¼•è¢«åˆ›å»ºæ—¶ï¼š</p><ul><li>åº”ç”¨é»˜è®¤çš„settingså’Œmappings</li><li>åº”ç”¨<code>order</code>æ•°å€¼ä½çš„index templateçš„è®¾å®š</li><li>åº”ç”¨<code>order</code>é«˜çš„index templateçš„è®¾å®šï¼Œä¹‹å‰è®¾å®šè¢«è¦†ç›–</li><li>ç”¨æˆ·æŒ‡å®šçš„settingså’Œmappingsä¼šè¦†ç›–é»˜è®¤çš„æ¨¡ç‰ˆè®¾å®š</li></ul><blockquote><p>ä¸Šé¢çš„ä¸¤ä¸ªè®¾å®šéƒ½ä¼šè¢«åº”ç”¨ï¼Œä½†æ˜¯orderé«˜çš„ä¼šè¦†ç›–ä½çš„è®¾å®š</p></blockquote></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/03/08/2022-03-08-elasticsearch/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/03/08/2022-03-08-elasticsearch/" class="post-title-link" itemprop="url">elasticsearchå…¥é—¨</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-08 14:30:00" itemprop="dateCreated datePublished" datetime="2022-03-08T14:30:00+08:00">2022-03-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="å…¥é—¨ä»‹ç»"><a href="#å…¥é—¨ä»‹ç»" class="headerlink" title="å…¥é—¨ä»‹ç»"></a>å…¥é—¨ä»‹ç»</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><ol><li>ElasticSearchéœ€è¦çš„jdkç‰ˆæœ¬è‡³å°‘æ˜¯1.8çš„ï¼Œæ‰€ä»¥å®‰è£…ä¹‹å‰å…ˆæŸ¥çœ‹jdkç‰ˆæœ¬å·</li></ol><p>2.ä¸‹è½½ElasticSearch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/elastic/elasticsearch/archive/v6.5.0.tar.gz</span><br><span class="line">tar -zxvf elasticsearch-6.5.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> elasticsearch-6.5.0</span><br></pre></td></tr></table></figure><p>ç®€å•æœ¬åœ°é›†ç¾¤ç¯å¢ƒæ­å»º</p><p>vim config&#x2F;elasticsearch.yml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: my-application    æ³¨é‡Šæ‰“å¼€</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ä¸‰ä¸ªé›†ç¾¤å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch -Ehttp.port=7200 -Epath.data=node3</span><br><span class="line">./bin/elasticsearch -Ehttp.port=8200 -Epath.data=node2</span><br><span class="line">./bin/elasticsearch</span><br></pre></td></tr></table></figure><p>é›†ç¾¤çŠ¶æ€æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pengshiliang@pengshiliang-OptiPlex-3020:~$ curl 127.0.0.1:9200/_cat/nodes?v</span><br><span class="line">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">127.0.0.1           30          98   2    2.03    0.96     0.53 mdi       -      dRA_DV4</span><br><span class="line">127.0.0.1           30          98   2    2.03    0.96     0.53 mdi       -      j8_g2SD</span><br><span class="line">127.0.0.1           31          98   3    2.03    0.96     0.53 mdi       *      3cYY9cL</span><br><span class="line">pengshiliang@pengshiliang-OptiPlex-3020:~$ curl 127.0.0.1:9200/_cluster/stats</span><br><span class="line">&#123;<span class="string">&quot;_nodes&quot;</span>:&#123;<span class="string">&quot;total&quot;</span>:3,<span class="string">&quot;successful&quot;</span>:3,<span class="string">&quot;failed&quot;</span>:0&#125;,<span class="string">&quot;cluster_name&quot;</span>:<span class="string">&quot;my-application&quot;</span>,<span class="string">&quot;cluster_uuid&quot;</span>:<span class="string">&quot;5nD6JB_MRyiin3n7QTCoDg&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:1552028850410,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;green&quot;</span>,<span class="string">&quot;indices&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:0,<span class="string">&quot;shards&quot;</span>:&#123;&#125;,<span class="string">&quot;docs&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:0,<span class="string">&quot;deleted&quot;</span>:0&#125;,<span class="string">&quot;store&quot;</span>:&#123;<span class="string">&quot;size_in_bytes&quot;</span>:0&#125;,<span class="string">&quot;fielddata&quot;</span>:&#123;<span class="string">&quot;memory_size_in_bytes&quot;</span>:0,<span class="string">&quot;evictions&quot;</span>:0&#125;,<span class="string">&quot;query_cache&quot;</span>:&#123;<span class="string">&quot;memory_size_in_bytes&quot;</span>:0,<span class="string">&quot;total_count&quot;</span>:0,<span class="string">&quot;hit_count&quot;</span>:0,<span class="string">&quot;miss_count&quot;</span>:0,<span class="string">&quot;cache_size&quot;</span>:0,<span class="string">&quot;cache_count&quot;</span>:0,<span class="string">&quot;evictions&quot;</span>:0&#125;,<span class="string">&quot;completion&quot;</span>:&#123;<span class="string">&quot;size_in_bytes&quot;</span>:0&#125;,<span class="string">&quot;segments&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:0,<span class="string">&quot;memory_in_bytes&quot;</span>:0,<span class="string">&quot;terms_memory_in_bytes&quot;</span>:0,<span class="string">&quot;stored_fields_memory_in_bytes&quot;</span>:0,<span class="string">&quot;term_vectors_memory_in_bytes&quot;</span>:0,<span class="string">&quot;norms_memory_in_bytes&quot;</span>:0,<span class="string">&quot;points_memory_in_bytes&quot;</span>:0,<span class="string">&quot;doc_values_memory_in_bytes&quot;</span>:0,<span class="string">&quot;index_writer_memory_in_bytes&quot;</span>:0,<span class="string">&quot;version_map_memory_in_bytes&quot;</span>:0,<span class="string">&quot;fixed_bit_set_memory_in_bytes&quot;</span>:0,<span class="string">&quot;max_unsafe_auto_id_timestamp&quot;</span>:-9223372036854775808,<span class="string">&quot;file_sizes&quot;</span>:&#123;&#125;&#125;&#125;,<span class="string">&quot;nodes&quot;</span>:&#123;<span class="string">&quot;count&quot;</span>:&#123;<span class="string">&quot;total&quot;</span>:3,<span class="string">&quot;data&quot;</span>:3,<span class="string">&quot;coordinating_only&quot;</span>:0,<span class="string">&quot;master&quot;</span>:3,<span class="string">&quot;ingest&quot;</span>:3&#125;,<span class="string">&quot;versions&quot;</span>:[<span class="string">&quot;6.5.0&quot;</span>],<span class="string">&quot;os&quot;</span>:&#123;<span class="string">&quot;available_processors&quot;</span>:12,<span class="string">&quot;allocated_processors&quot;</span>:12,<span class="string">&quot;names&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Linux&quot;</span>,<span class="string">&quot;count&quot;</span>:3&#125;],<span class="string">&quot;mem&quot;</span>:&#123;<span class="string">&quot;total_in_bytes&quot;</span>:24839368704,<span class="string">&quot;free_in_bytes&quot;</span>:437612544,<span class="string">&quot;used_in_bytes&quot;</span>:24401756160,<span class="string">&quot;free_percent&quot;</span>:2,<span class="string">&quot;used_percent&quot;</span>:98&#125;&#125;,<span class="string">&quot;process&quot;</span>:&#123;<span class="string">&quot;cpu&quot;</span>:&#123;<span class="string">&quot;percent&quot;</span>:0&#125;,<span class="string">&quot;open_file_descriptors&quot;</span>:&#123;<span class="string">&quot;min&quot;</span>:305,<span class="string">&quot;max&quot;</span>:306,<span class="string">&quot;avg&quot;</span>:305&#125;&#125;,<span class="string">&quot;jvm&quot;</span>:&#123;<span class="string">&quot;max_uptime_in_millis&quot;</span>:74396,<span class="string">&quot;versions&quot;</span>:[&#123;<span class="string">&quot;version&quot;</span>:<span class="string">&quot;1.8.0_171&quot;</span>,<span class="string">&quot;vm_name&quot;</span>:<span class="string">&quot;Java HotSpot(TM) 64-Bit Server VM&quot;</span>,<span class="string">&quot;vm_version&quot;</span>:<span class="string">&quot;25.171-b11&quot;</span>,<span class="string">&quot;vm_vendor&quot;</span>:<span class="string">&quot;Oracle Corporation&quot;</span>,<span class="string">&quot;count&quot;</span>:3&#125;],<span class="string">&quot;mem&quot;</span>:&#123;<span class="string">&quot;heap_used_in_bytes&quot;</span>:972703928,<span class="string">&quot;heap_max_in_bytes&quot;</span>:3116630016&#125;,<span class="string">&quot;threads&quot;</span>:143&#125;,<span class="string">&quot;fs&quot;</span>:&#123;<span class="string">&quot;total_in_bytes&quot;</span>:483753484288,<span class="string">&quot;free_in_bytes&quot;</span>:438342832128,<span class="string">&quot;available_in_bytes&quot;</span>:413745967104&#125;,<span class="string">&quot;plugins&quot;</span>:[],<span class="string">&quot;network_types&quot;</span>:&#123;<span class="string">&quot;transport_types&quot;</span>:&#123;<span class="string">&quot;security4&quot;</span>:3&#125;,<span class="string">&quot;http_types&quot;</span>:&#123;<span class="string">&quot;security4&quot;</span>:3&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤šæœºéƒ¨ç½²"><a href="#å¤šæœºéƒ¨ç½²" class="headerlink" title="å¤šæœºéƒ¨ç½²"></a>å¤šæœºéƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">network.host: your ip <span class="comment">#ï¼ˆä¸»æœºåœ°å€ï¼‰å¯¹å¤–å‘å¸ƒçš„ç½‘ç»œåœ°å€ </span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;<span class="variable">$ip</span>&quot;</span>]  <span class="variable">$ip</span>ä¸€å®šè¦åŒ…å«è¯¥é›†ç¾¤ä¸­å…¶ä»–æœºå™¨çš„ip</span><br></pre></td></tr></table></figure><h3 id="Elasticsearch-å¸¸ç”¨æœ¯è¯­"><a href="#Elasticsearch-å¸¸ç”¨æœ¯è¯­" class="headerlink" title="Elasticsearch å¸¸ç”¨æœ¯è¯­"></a>Elasticsearch å¸¸ç”¨æœ¯è¯­</h3><p>Document æ–‡æ¡£æ•°æ®<br>Index ç´¢å¼•<br>Type ç´¢å¼•ä¸­çš„æ•°æ®ç±»å‹<br>Field å­—æ®µï¼Œæ–‡æ¡£å±æ€§<br>Query DSLæŸ¥è¯¢è¯­æ³•</p><h3 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h3><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /accounts/person/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Bob&quot;,</span><br><span class="line">  &quot;job&quot;: &quot;developer&quot;,</span><br><span class="line">  &quot;sex&quot;: &quot;male&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ¡è¯­å¥è¡¨è¿°çš„å«ä¹‰æ˜¯åœ¨indexä¸ºaccountsçš„personç±»å‹ä¸‹åˆ›å»ºä¸€æ¡idä¸º1çš„æ•°æ®<br>Resultï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /accounts/person/1</span><br></pre></td></tr></table></figure><p>Resultï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bob&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;job&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;developer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;male&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /accounts/person/1/_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;John&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /accounts/person/1</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;accounts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;deleted&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥è¯¢è¯­æ³•"><a href="#æŸ¥è¯¢è¯­æ³•" class="headerlink" title="æŸ¥è¯¢è¯­æ³•"></a>æŸ¥è¯¢è¯­æ³•</h3><h4 id="Query-String"><a href="#Query-String" class="headerlink" title="Query String"></a>Query String</h4><p>åé¢æ¥?qå½¢å¼</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /accounts/person/_search?q=John</span><br></pre></td></tr></table></figure><h4 id="Query-Dsl"><a href="#Query-Dsl" class="headerlink" title="Query Dsl"></a>Query Dsl</h4><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /accounts/person/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;John&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¦ç»†å‚è€ƒ<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/query-dsl.html">query-dsl</a></p><h2 id="ElasticSearchåˆæ­¥ä»‹ç»"><a href="#ElasticSearchåˆæ­¥ä»‹ç»" class="headerlink" title="ElasticSearchåˆæ­¥ä»‹ç»"></a>ElasticSearchåˆæ­¥ä»‹ç»</h2><h3 id="æ­£æ’-x2F-å€’æ’ç´¢å¼•"><a href="#æ­£æ’-x2F-å€’æ’ç´¢å¼•" class="headerlink" title="æ­£æ’&#x2F;å€’æ’ç´¢å¼•"></a>æ­£æ’&#x2F;å€’æ’ç´¢å¼•</h3><p>æ­£æ’ç´¢å¼•ï¼š</p><table><thead><tr><th>æ–‡æ¡£ID</th><th>æ–‡æ¡£å†…å®¹</th></tr></thead><tbody><tr><td>1</td><td>elasticsearchæ˜¯æœ€æµè¡Œçš„æœç´¢å¼•æ“</td></tr><tr><td>2</td><td>phpæ˜¯ä¸–ç•Œæœ€å¥½çš„è¯­è¨€</td></tr><tr><td>3</td><td>æœç´¢å¼•æ“æ˜¯å¦‚ä½•è¯ç”Ÿçš„</td></tr></tbody></table><p>å€’æ’ç´¢å¼•ï¼š</p><table><thead><tr><th>æ–‡æ¡£å†…å®¹</th><th>æ–‡æ¡£ID</th></tr></thead><tbody><tr><td>elasticsearch</td><td>1</td></tr><tr><td>æµè¡Œ</td><td>1</td></tr><tr><td>æœç´¢å¼•æ“</td><td>1,3</td></tr><tr><td>php</td><td>2</td></tr><tr><td>ä¸–ç•Œ</td><td>2</td></tr><tr><td>æœ€å¥½</td><td>2</td></tr><tr><td>è¯­è¨€</td><td>2</td></tr><tr><td>å¦‚ä½•</td><td>3</td></tr><tr><td>è¯ç”Ÿ</td><td>3</td></tr></tbody></table><p>æŸ¥è¯¢åŒ…å«æœç´¢å¼•æ“çš„æ–‡æ¡£ï¼š</p><ol><li>é€šè¿‡å€’æ’ç´¢å¼•è·å¾—å«æœ‰â€œæœç´¢å¼•æ“â€çš„æ–‡æ¡£IDæ˜¯1,3</li><li>é€šè¿‡æ­£æ’ç´¢å¼•æŸ¥çœ‹1,3çš„å†…å®¹</li><li>è¿”å›ç»“æœ</li></ol><h4 id="å€’æ’ç´¢å¼•åŸºæœ¬æ¦‚å¿µ"><a href="#å€’æ’ç´¢å¼•åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="å€’æ’ç´¢å¼•åŸºæœ¬æ¦‚å¿µ"></a>å€’æ’ç´¢å¼•åŸºæœ¬æ¦‚å¿µ</h4><p>å€’æ’ç´¢å¼•(Inverted Index)ï¼šå€’æ’ç´¢å¼•æ˜¯å®ç°â€œå•è¯-æ–‡æ¡£çŸ©é˜µâ€çš„ä¸€ç§å…·ä½“å­˜å‚¨å½¢å¼ï¼Œé€šè¿‡å€’æ’ç´¢å¼•ï¼Œå¯ä»¥æ ¹æ®å•è¯å¿«é€Ÿè·å–åŒ…å«è¿™ä¸ªå•è¯çš„æ–‡æ¡£åˆ—è¡¨ã€‚å€’æ’ç´¢å¼•ä¸»è¦ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šâ€œå•è¯è¯å…¸â€å’Œâ€œå€’æ’æ–‡ä»¶â€ã€‚</p><p>å•è¯è¯å…¸(Lexicon)ï¼šæœç´¢å¼•æ“çš„é€šå¸¸ç´¢å¼•å•ä½æ˜¯å•è¯ï¼Œå•è¯è¯å…¸æ˜¯ç”±æ–‡æ¡£é›†åˆä¸­å‡ºç°è¿‡çš„æ‰€æœ‰å•è¯æ„æˆçš„å­—ç¬¦ä¸²é›†åˆï¼Œå•è¯è¯å…¸å†…æ¯æ¡ç´¢å¼•é¡¹è®°è½½å•è¯æœ¬èº«çš„ä¸€äº›ä¿¡æ¯ä»¥åŠæŒ‡å‘â€œå€’æ’åˆ—è¡¨â€çš„æŒ‡é’ˆã€‚</p><p>å€’æ’åˆ—è¡¨(PostingList)ï¼šå€’æ’åˆ—è¡¨è®°è½½äº†å‡ºç°è¿‡æŸä¸ªå•è¯çš„æ‰€æœ‰æ–‡æ¡£çš„æ–‡æ¡£åˆ—è¡¨åŠå•è¯åœ¨è¯¥æ–‡æ¡£ä¸­å‡ºç°çš„ä½ç½®ä¿¡æ¯ï¼Œæ¯æ¡è®°å½•ç§°ä¸ºä¸€ä¸ªå€’æ’é¡¹(Posting)ã€‚æ ¹æ®å€’æ’åˆ—è¡¨ï¼Œå³å¯è·çŸ¥å“ªäº›æ–‡æ¡£åŒ…å«æŸä¸ªå•è¯ã€‚</p><p>å€’æ’æ–‡ä»¶(Inverted File)ï¼šæ‰€æœ‰å•è¯çš„å€’æ’åˆ—è¡¨å¾€å¾€é¡ºåºåœ°å­˜å‚¨åœ¨ç£ç›˜çš„æŸä¸ªæ–‡ä»¶é‡Œï¼Œè¿™ä¸ªæ–‡ä»¶å³è¢«ç§°ä¹‹ä¸ºå€’æ’æ–‡ä»¶ï¼Œå€’æ’æ–‡ä»¶æ˜¯å­˜å‚¨å€’æ’ç´¢å¼•çš„ç‰©ç†æ–‡ä»¶ã€‚</p><h4 id="å€’æ’ç´¢å¼•çš„ç»„æˆ"><a href="#å€’æ’ç´¢å¼•çš„ç»„æˆ" class="headerlink" title="å€’æ’ç´¢å¼•çš„ç»„æˆ"></a>å€’æ’ç´¢å¼•çš„ç»„æˆ</h4><p>å€’æ’ç´¢å¼•æ˜¯æœç´¢å¼•æ“çš„æ ¸å¿ƒï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>å•è¯è¯å…¸ï¼ˆTrem Dictionaryï¼‰ï¼šè®°å½•çš„æ˜¯æ‰€æœ‰çš„æ–‡æ¡£åˆ†è¯åçš„ç»“æœ</li><li>å€’æ’åˆ—è¡¨ï¼ˆPosting Listï¼‰ï¼šè®°å½•äº†å•è¯å¯¹åº”æ–‡æ¡£çš„é›†åˆï¼Œç”±å€’æ’ç´¢å¼•é¡¹ï¼ˆPostingï¼‰ç»„æˆã€‚</li></ol><p><strong>å•è¯å­—å…¸çš„å®ç°ä¸€èˆ¬é‡‡ç”¨B+Treeçš„æ–¹å¼ï¼Œæ¥ä¿è¯é«˜æ•ˆ</strong></p><p>å€’æ’ç´¢å¼•é¡¹ï¼ˆPostingï¼‰ä¸»è¦åŒ…å«å¦‚ä¸‹çš„ä¿¡æ¯ï¼š</p><ol><li>æ–‡æ¡£IDï¼Œç”¨äºè·å–åŸå§‹æ–‡æ¡£çš„ä¿¡æ¯</li><li>å•è¯é¢‘ç‡ï¼ˆTFï¼ŒTerm Frequencyï¼‰ï¼Œè®°å½•è¯¥å•è¯åœ¨è¯¥æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œç”¨äºåç»­ç›¸å…³æ€§ç®—åˆ†ã€‚</li><li>ä½ç½®ï¼ˆPositionï¼‰ï¼Œè®°å½•å•è¯åœ¨æ–‡æ¡£ä¸­çš„åˆ†è¯ä½ç½®ï¼ˆå¤šä¸ªï¼‰ï¼Œç”¨äºåšè¯è¯­æœç´¢ã€‚</li><li>åç§»ï¼ˆOffsetï¼‰ï¼Œè®°å½•å•è¯åœ¨æ–‡æ¡£çš„å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œç”¨äºé«˜äº®æ˜¾ç¤º</li></ol><p>å€’æ’åˆ—è¡¨ï¼š</p><p><img src="/img/in-post/2019-03-13/1.png"></p><blockquote><p>â€œelasticsearchæ˜¯æœ€æµè¡Œçš„æœç´¢å¼•æ“â€å¯åˆ†ä¸º3ä¸ªè¯è¯­ï¼Œæœç´¢å¼•æ“åœ¨ç¬¬äºŒä¸ªä½ç½®ï¼Œå¹¶ä¸”å­—ç¬¦ä½ç½®æ˜¯18-22ä¹‹é—´</p></blockquote><p><img src="/img/in-post/2019-03-13/2.png"></p><p>eså­˜å‚¨çš„æ˜¯ä¸€ä¸ªjsonæ ¼å¼çš„æ–‡æ¡£ï¼Œå…¶ä¸­åŒ…å«å¤šä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µéƒ½ä¼šæœ‰è‡ªå·±çš„å€’æ’ç´¢å¼•ï¼Œç±»ä¼¼è¿™ç§</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;huangtoufa&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;job&quot;</span><span class="punctuation">:</span> <span class="string">&quot;programmer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>jobå’Œusernameéƒ½æœ‰è‡ªå·±çš„å€’æ’ç´¢å¼•</p><h3 id="åˆ†è¯ä»‹ç»"><a href="#åˆ†è¯ä»‹ç»" class="headerlink" title="åˆ†è¯ä»‹ç»"></a>åˆ†è¯ä»‹ç»</h3><p>åˆ†è¯æ˜¯æŒ‡å°†æ–‡æœ¬è½¬æ¢æˆä¸€ç³»åˆ—å•è¯( term or token )çš„è¿‡ç¨‹,ä¹Ÿå¯ä»¥å«åšæ–‡æœ¬åˆ†æ,åœ¨esé‡Œé¢ç§°ä¸ºAnalysis</p><p><img src="/img/in-post/2019-03-13/3.png"></p><p>Â·åˆ†è¯å™¨æ˜¯esä¸­ä¸“é—¨å¤„ç†åˆ†è¯çš„ç»„ä»¶,è‹±æ–‡ä¸ºAnalyzer ,å®ƒçš„ç»„æˆå¦‚ä¸‹<br>ã€€ã€€- Character Filters<br>ã€€ã€€ã€€-é’ˆå¯¹åŸå§‹æ–‡æœ¬è¿›è¡Œå¤„ç†,æ¯”å¦‚å»é™¤htmlç‰¹æ®Šæ ‡è®°ç¬¦<br>ã€€ã€€- Tokenizer<br>ã€€ã€€ã€€-å°†åŸå§‹æ–‡æœ¬æŒ‰ç…§ä¸€å®šè§„åˆ™åˆ‡åˆ†ä¸ºå•è¯<br>ã€€ã€€- Token Filters<br>ã€€ã€€ã€€-é’ˆå¯¹tokenizerå¤„ç†çš„å•è¯å°±è¡Œå†åŠ å·¥,æ¯”å¦‚è½¬å°å†™ã€åˆ é™¤æˆ–æ–°å¢ç­‰å¤„ç†</p><p>åˆ†è¯è°ƒç”¨é¡ºåºï¼š</p><p><img src="/img/in-post/2019-03-13/4.png"></p><h4 id="analyze-api"><a href="#analyze-api" class="headerlink" title="analyze_api"></a>analyze_api</h4><p> esæä¾›äº†ä¸€ä¸ªæµ‹è¯•åˆ†è¯çš„apiæ¥å£,æ–¹ä¾¿éªŒè¯åˆ†è¯æ•ˆæœ, endpointæ˜¯_analyze<br>ã€€ã€€-å¯ä»¥ç›´æ¥æŒ‡å®šanalyzerè¿›è¡Œæµ‹è¯•<br>ã€€ã€€-å¯ä»¥ç›´æ¥æŒ‡å®šç´¢å¼•ä¸­çš„å­—æ®µè¿›è¡Œæµ‹è¯•<br>ã€€ã€€-å¯ä»¥è‡ªå®šä¹‰åˆ†è¯å™¨è¿›è¡Œæµ‹è¯•</p><p><img src="/img/in-post/2019-03-13/5.png"></p><p>å…³é”®è¯è§£é‡Šï¼š</p><p>analyzerï¼šåˆ†è¯å™¨<br>textï¼šåˆ†è¯æ–‡æœ¬<br>tokenï¼šåˆ†è¯ç»“æœ<br>start_offsetï¼šå¼€å§‹åç§»ä½ç½®<br>end_offsetï¼šç»“æŸåç§»ä½ç½®<br>positionï¼šåˆ†è¯ä½ç½®</p><p>å½“æ²¡æœ‰å®šä¹‰analyzerçš„æ—¶å€™ä¼šä½¿ç”¨é»˜è®¤åˆ†è¯å™¨â€analyzerâ€:â€standardâ€</p><p>æŒ‡å®šfieldåˆ†è¯ï¼š</p><p><img src="/img/in-post/2019-03-13/6.png"></p><p>è‡ªå®šä¹‰åˆ†è¯å™¨ï¼štokenizeræŒ‡åè¦ç”¨å“ªä¸ªåˆ†è¯å™¨ï¼ŒfilteræŒ‡æ˜çš„æ˜¯token filterï¼š</p><p><img src="/img/in-post/2019-03-13/7.png"></p><h4 id="è‡ªå¸¦åˆ†è¯å™¨"><a href="#è‡ªå¸¦åˆ†è¯å™¨" class="headerlink" title="è‡ªå¸¦åˆ†è¯å™¨"></a>è‡ªå¸¦åˆ†è¯å™¨</h4><p>esè‡ªå¸¦å¦‚ä¸‹çš„åˆ†è¯å™¨<br>ã€€ã€€- Standard Simple<br>ã€€ã€€- Whitespace<br>ã€€ã€€- Stop<br>ã€€ã€€- Keyword<br>ã€€ã€€- Pattern<br>ã€€ã€€- Language</p><p><img src="/img/in-post/2019-03-13/8.png"><br><img src="/img/in-post/2019-03-13/9.png"><br><img src="/img/in-post/2019-03-13/10.png"><br><img src="/img/in-post/2019-03-13/11.png"><br><img src="/img/in-post/2019-03-13/12.png"><br><img src="/img/in-post/2019-03-13/13.png"></p><h4 id="ä¸­æ–‡åˆ†è¯"><a href="#ä¸­æ–‡åˆ†è¯" class="headerlink" title="ä¸­æ–‡åˆ†è¯"></a>ä¸­æ–‡åˆ†è¯</h4><p>Â·éš¾ç‚¹<br>ã€€ã€€-ä¸­æ–‡åˆ†è¯æŒ‡çš„æ˜¯å°†ä¸€ä¸ªæ±‰å­—åºåˆ—åˆ‡åˆ†æˆä¸€ä¸ªä¸€ä¸ªå•ç‹¬çš„è¯ã€‚åœ¨è‹±æ–‡ä¸­,å•è¯ä¹‹é—´æ˜¯ä»¥ç©ºæ ¼ä½œä¸ºè‡ªç„¶åˆ†ç•Œç¬¦,æ±‰è¯­ä¸­è¯æ²¡æœ‰ä¸€ä¸ªå½¢å¼ä¸Šçš„åˆ†ç•Œç¬¦ã€‚<br>ã€€ã€€-ä¸Šä¸‹æ–‡ä¸åŒ,åˆ†è¯ç»“æœè¿¥å¼‚,æ¯”å¦‚äº¤å‰æ­§ä¹‰é—®é¢˜,æ¯”å¦‚ä¸‹é¢ä¸¤ç§åˆ†è¯éƒ½åˆç†<br>ã€€ã€€ã€€ã€€-ä¹’ä¹“çƒæ‹&#x2F;å–å®Œäº†<br>ã€€ã€€ã€€ã€€-ä¹’ä¹“çƒ&#x2F;æ‹å–&#x2F;å®Œäº†</p><p>Â·å¸¸ç”¨åˆ†è¯ç³»ç»Ÿ<br>ã€€ã€€-IK<br>ã€€ã€€ã€€ã€€-å®ç°ä¸­è‹±æ–‡å•è¯çš„åˆ‡åˆ†,æ”¯æŒik smart, ik maxwordç­‰æ¨¡å¼<br>ã€€ã€€ã€€ã€€-å¯è‡ªå®šä¹‰è¯åº“,æ”¯æŒçƒ­æ›´æ–°åˆ†è¯è¯å…¸,<br>ã€€ã€€ã€€ã€€- <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a><br>ã€€ã€€- jieba<br>ã€€ã€€ã€€ã€€-pythonä¸­æœ€æµè¡Œçš„åˆ†è¯ç³»ç»Ÿ,æ”¯æŒåˆ†è¯å’Œè¯æ€§æ ‡æ³¨<br>ã€€ã€€ã€€ã€€-æ”¯æŒç¹ä½“åˆ†è¯ã€è‡ªå®šä¹‰è¯å…¸ã€å¹¶è¡Œåˆ†è¯ç­‰<br>ã€€ã€€ã€€ã€€- <a target="_blank" rel="noopener" href="https://github.com/sing1ee/elasticsearch-jieba-plugin">https://github.com/sing1ee/elasticsearch-jieba-plugin</a><br>Â·åŸºäºè‡ªç„¶è¯­è¨€å¤„ç†çš„åˆ†è¯ç³»ç»Ÿ<br>ã€€ã€€- Hanlp<br>ã€€ã€€ã€€ã€€-ç”±ä¸€ç³»åˆ—æ¨¡å‹ä¸ç®—æ³•ç»„æˆçš„Javaå·¥å…·åŒ…,ç›®æ ‡æ˜¯æ™®åŠè‡ªç„¶è¯­è¨€å¤„ç†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„åº”ç”¨<br>ã€€ã€€ã€€ã€€- <a target="_blank" rel="noopener" href="https://github.com/hankcs/HanLP">https://github.com/hankcs/HanLP</a><br>ã€€ã€€-THULAC<br>ã€€ã€€ã€€ã€€-THU Lexical Analyzer for Chinese ,ç”±æ¸…åå¤§å­¦è‡ªç„¶è¯­è¨€å¤„ç†ä¸ç¤¾ä¼šäººæ–‡è®¡ç®—å®éªŒå®¤ç ”åˆ¶æ¨å‡ºçš„ä¸€å¥—ä¸­æ–‡è¯æ³•åˆ†æå·¥å…·åŒ…,å…·æœ‰ä¸­æ–‡åˆ†è¯å’Œè¯æ€§æ ‡æ³¨åŠŸèƒ½<br>ã€€ã€€ã€€ã€€- <a target="_blank" rel="noopener" href="https://github.com/microbun/elasticsearch-thulac-plugin">https://github.com/microbun/elasticsearch-thulac-plugin</a></p><h4 id="è‡ªå®šä¹‰åˆ†è¯"><a href="#è‡ªå®šä¹‰åˆ†è¯" class="headerlink" title="è‡ªå®šä¹‰åˆ†è¯"></a>è‡ªå®šä¹‰åˆ†è¯</h4><p>CharacterFilterï¼š</p><p>å½“è‡ªå¸¦çš„åˆ†è¯æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶,å¯ä»¥è‡ªå®šä¹‰åˆ†è¯</p><ul><li>é€šè¿‡è‡ªå®šä¹‰Character Filters, Tokenizerå’ŒToken Filterå®ç°. Character Filters</li><li>åœ¨Tokenizerä¹‹å‰å¯¹åŸå§‹æ–‡æœ¬è¿›è¡Œå¤„ç†,æ¯”å¦‚å¢åŠ ã€åˆ é™¤æˆ–æ›¿æ¢å­—ç¬¦ç­‰</li><li>è‡ªå¸¦çš„å¦‚ä¸‹:<ul><li>HTML Stripå»é™¤htmlæ ‡ç­¾å’Œè½¬æ¢htmlå®ä½“</li><li>Mappingè¿›è¡Œå­—ç¬¦æ›¿æ¢æ“ä½œ</li><li>Pattern Replaceè¿›è¡Œæ­£åˆ™åŒ¹é…æ›¿æ¢</li></ul></li><li>ä¼šå½±å“åç»­tokenizerè§£æçš„postionå’Œoffsetä¿¡æ¯</li></ul><p> Character Filtersæµ‹è¯•æ—¶å¯ä»¥é‡‡ç”¨å¦‚ä¸‹api :<br><img src="/img/in-post/2019-03-13/14.png"></p><p>Tokenizerï¼š<br>Tokenizer</p><ul><li>å°†åŸå§‹æ–‡æœ¬æŒ‰ç…§ä¸€å®šè§„åˆ™åˆ‡åˆ†ä¸ºå•è¯( term or token )</li><li>è‡ªå¸¦çš„å¦‚ä¸‹:<ul><li>standardæŒ‰ç…§å•è¯è¿›è¡Œåˆ†å‰²</li><li>letteræŒ‰ç…§éå­—ç¬¦ç±»è¿›è¡Œåˆ†å‰²</li><li>whitespaceæŒ‰ç…§ç©ºæ ¼è¿›è¡Œåˆ†å‰²</li><li>UAX URL EmailæŒ‰ç…§standardåˆ†å‰²,ä½†ä¸ä¼šåˆ†å‰²é‚®ç®±å’Œurl</li><li>NGramå’ŒEdge NGramè¿è¯åˆ†å‰²</li><li>Path HierarchyæŒ‰ç…§æ–‡ä»¶è·¯å¾„è¿›è¡Œåˆ‡å‰²</li></ul></li></ul><p>api:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;path_hierarchy&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;one/two/three&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;one&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;one/two&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;one/two/three&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>TokenFilter:<br>Token Filters</p><ul><li>å¯¹äºtokenizerè¾“å‡ºçš„å•è¯( term )è¿›è¡Œå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ç­‰æ“ä½œ</li><li>è‡ªå¸¦çš„å¦‚ä¸‹:<ul><li>lowercaseå°†æ‰€æœ‰termè½¬æ¢ä¸ºå°å†™</li><li>stopåˆ é™¤stop words</li><li>NGramå’ŒEdge NGramè¿è¯åˆ†å‰²</li><li>Synonymæ·»åŠ è¿‘ä¹‰è¯çš„term</li></ul></li></ul><p>api:</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;a Hello, world!&quot;,</span><br><span class="line">  &quot;filter&quot;: [</span><br><span class="line">    &quot;stop&quot;,</span><br><span class="line">    &quot;lowercase&quot;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;ngram&quot;,</span><br><span class="line">      &quot;min_gram&quot;: 4,</span><br><span class="line">      &quot;max_gram&quot;: 4</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;hell&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ello&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;worl&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;orld&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Custormï¼š<br>è‡ªå®šä¹‰åˆ†è¯éœ€è¦åœ¨ç´¢å¼•çš„é…ç½®ä¸­è®¾å®š,å¦‚ä¸‹æ‰€ç¤º:</p><p><img src="/img/in-post/2019-03-13/15.png"></p><p>åˆ›å»ºè‡ªå®šä¹‰åˆ†è¯å™¨ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_custom_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;html_strip&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;lowercase&quot;,</span><br><span class="line">            &quot;asciifolding&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test_index</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test_index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aliases&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;provided_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;creation_date&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1552462361614&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analysis&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;my_custom_analyzer&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;asciifolding&quot;</span></span><br><span class="line">              <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;char_filter&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;html_strip&quot;</span></span><br><span class="line">              <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;custom&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;tokenizer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;novqTjprQE24bJPdtxydCA&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;created&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6050099&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-03-13/16.png"></p><p>è‡ªå®šä¹‰åˆ†è¯éªŒè¯ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†è¯ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;this&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;is&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="åˆ†è¯ä½¿ç”¨è¯´æ˜"><a href="#åˆ†è¯ä½¿ç”¨è¯´æ˜" class="headerlink" title="åˆ†è¯ä½¿ç”¨è¯´æ˜"></a>åˆ†è¯ä½¿ç”¨è¯´æ˜</h4><p>åˆ†è¯ä¼šåœ¨å¦‚ä¸‹ä¸¤ä¸ªæ—¶æœºä½¿ç”¨:</p><ul><li>åˆ›å»ºæˆ–æ›´æ–°æ–‡æ¡£æ—¶(Index Time ) ,ä¼šå¯¹ç›¸åº”çš„æ–‡æ¡£è¿›è¡Œåˆ†è¯å¤„ç†</li><li>æŸ¥è¯¢æ—¶( Search Time ) ,ä¼šå¯¹æŸ¥è¯¢è¯­å¥è¿›è¡Œåˆ†è¯</li></ul><h4 id="ç´¢å¼•æ—¶åˆ†è¯"><a href="#ç´¢å¼•æ—¶åˆ†è¯" class="headerlink" title="ç´¢å¼•æ—¶åˆ†è¯"></a>ç´¢å¼•æ—¶åˆ†è¯</h4><p>ç´¢å¼•æ—¶åˆ†è¯æ˜¯é€šè¿‡é…ç½®Index Mappingä¸­æ¯ä¸ªå­—æ®µçš„analyzerå±æ€§å®ç°çš„å¦‚ä¸‹ï¼šä¸æŒ‡å®šåˆ†è¯æ—¶,ä½¿ç”¨é»˜è®¤standard</p><p><img src="/img/in-post/2019-03-13/17.png"></p><h4 id="æŸ¥è¯¢æ—¶åˆ†è¯"><a href="#æŸ¥è¯¢æ—¶åˆ†è¯" class="headerlink" title="æŸ¥è¯¢æ—¶åˆ†è¯"></a>æŸ¥è¯¢æ—¶åˆ†è¯</h4><p>æŸ¥è¯¢æ—¶åˆ†è¯çš„æŒ‡å®šæ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§:</p><ul><li>æŸ¥è¯¢çš„æ—¶å€™é€šè¿‡analyzeræŒ‡å®šåˆ†è¯å™¨</li><li>é€šè¿‡index mappingè®¾ç½®search_analyzerå®ç°</li></ul><p><img src="/img/in-post/2019-03-13/18.png"></p><p>å®ä¾‹1ï¼šæˆ‘ä»¬åšä¸€ä¸ªæŸ¥è¯¢ï¼Œæˆ‘ä»¬è¯•å›¾é€šè¿‡æœç´¢ message2 è¿™ä¸ªå…³é”®è¯æ¥æœç´¢è¿™ä¸ªæ–‡æ¡£</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET test_index1/doc/1</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;this Is a Message&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;this Is a Message2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;message2&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;standard&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;message&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;this Is a Message2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢æ—¶ä½¿ç”¨è‡ªå®šä¹‰åˆ†è¯å™¨</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index1</span><br><span class="line"></span><br><span class="line">PUT test_index1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_custom_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;html_strip&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;lowercase&quot;,</span><br><span class="line">            &quot;asciifolding&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;&lt;a&gt;this Is a &lt;b&gt;Message&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;&lt;a&gt;this Is a &lt;b&gt;Message2&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test_index1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;Message2&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ†è¯å»ºè®®"><a href="#åˆ†è¯å»ºè®®" class="headerlink" title="åˆ†è¯å»ºè®®"></a>åˆ†è¯å»ºè®®</h4><ul><li>æ˜ç¡®å­—æ®µæ˜¯å¦éœ€è¦åˆ†è¯,ä¸éœ€è¦åˆ†è¯çš„å­—æ®µå°±å°†typeè®¾ç½®ä¸ºkeyword ,å¯ä»¥èŠ‚çœç©ºé—´å’Œæé«˜å†™æ€§èƒ½</li><li>å–„ç”¨_analyze API ,æŸ¥çœ‹æ–‡æ¡£çš„å…·ä½“åˆ†è¯ç»“æœ</li><li>åŠ¨æ‰‹æµ‹è¯•</li></ul><h3 id="åˆ†è¯ä½¿ç”¨åˆ†æ"><a href="#åˆ†è¯ä½¿ç”¨åˆ†æ" class="headerlink" title="åˆ†è¯ä½¿ç”¨åˆ†æ"></a>åˆ†è¯ä½¿ç”¨åˆ†æ</h3><p>åˆ›å»ºè‡ªå®šä¹‰åˆ†è¯</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index</span><br><span class="line"></span><br><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_custom_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;html_strip&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;lowercase&quot;,</span><br><span class="line">            &quot;asciifolding&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ’å…¥æ•°æ®ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†è¯æ£€ç´¢ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;&lt;div&gt;this is&lt;/div&gt;&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ç»“æœï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.5753642</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;message&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¼šè¿”å›è¿™æ¡è®°å½•ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ†è¯åˆ†ææ¥åˆ†æåŸå› ï¼š</p><figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST test_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_custom_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Result:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;this&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;is&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;a&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢çš„ç»“æœçœ‹ä¸€çœ‹å‡ºæˆ‘ä»¬è‡ªå®šä¹‰çš„åˆ†è¯å°†<code>&lt;a&gt;This is a &lt;b&gt;Text&lt;/b&gt;&lt;/a&gt;</code> åˆ†æˆäº†this,is,a,text<br>åˆ†æˆè¿™ç§ç»“æœçš„åŸå› æ˜¯åˆ†è¯ä½¿ç”¨äº†å¦‚ä¸‹å›¾çš„åˆ†è¯å™¨<br><img src="/img/in-post/2019-03-13/16.png"></p><p>æˆ‘ä»¬ç”±å‰é¢çš„åˆ†è¯å™¨çš„è§£é‡Šå¯äº†è§£åˆ°lowercaseå°†å…ƒæ–‡æœ¬è§„èŒƒåŒ–ä¸ºå°å†™ï¼Œasciifolding ç±»å‹çš„è¯å…ƒè¿‡æ»¤å™¨ï¼Œå°†ä¸åœ¨å‰127ä¸ªASCIIå­—ç¬¦ï¼ˆâ€œåŸºæœ¬æ‹‰ä¸æ–‡â€Unicodeå—ï¼‰ä¸­çš„å­—æ¯ï¼Œæ•°å­—å’Œç¬¦å·Unicodeå­—ç¬¦è½¬æ¢ä¸ºASCIIç­‰æ•ˆé¡¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚<br>html stripå°†æ–‡æœ¬çš„htmlæ ‡ç­¾è¿›è¡Œäº†è¿‡æ»¤ï¼Œstandardè§ä¸Šé¢çš„ä»‹ç»ï¼Œæ‰€ä»¥æœ€ç»ˆè‡ªå®šä¹‰åˆ†è¯åˆ†æˆäº†this,is,a,textè¿™æ ·çš„ç»“æœï¼Œè€Œä¸Šé¢queryé‡Œé¢çš„<code>&lt;div&gt;this is&lt;div&gt;</code>é¦–å…ˆhtmlæ ‡ç­¾è¢«è¿‡æ»¤æ‰ï¼Œæ‰€ä»¥ä¸ç®¡ä»€ä¹ˆæ ‡ç­¾éƒ½å¯ä»¥æ»¡è¶³æ¡ä»¶ï¼Œå…¶æ¬¡<br>this isç”¨_analyzeåˆ†æä¼šè¢«æ‹†æˆthis,isä¹Ÿç¬¦åˆåˆ†è¯åŒ¹é…ç»“æœï¼Œå¦‚æœqueryé‡Œé¢çš„this iså˜ä¸ºthisiså°±ä¸ç¬¦åˆå½“å‰åŒ¹é…ç»“æœäº†</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/03/05/2022-03-05-elastic/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/03/05/2022-03-05-elastic/" class="post-title-link" itemprop="url">Elasticsearch Index API</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-05 13:30:00" itemprop="dateCreated datePublished" datetime="2022-03-05T13:30:00+08:00">2022-03-05</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h2><h3 id="ä»€ä¹ˆæ˜¯æ–‡æ¡£"><a href="#ä»€ä¹ˆæ˜¯æ–‡æ¡£" class="headerlink" title="ä»€ä¹ˆæ˜¯æ–‡æ¡£"></a>ä»€ä¹ˆæ˜¯æ–‡æ¡£</h3><p>ç¨‹åºä¸­å¤§å¤šçš„å®ä½“æˆ–å¯¹è±¡èƒ½å¤Ÿè¢«åºåˆ—åŒ–ä¸ºåŒ…å«é”®å€¼å¯¹çš„JSONå¯¹è±¡ï¼Œé”®(key)æ˜¯å­—æ®µ(field)æˆ–å±æ€§(property)çš„åå­—ï¼Œå€¼(value)å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”ç±»å‹ã€å¦ä¸€ä¸ªå¯¹è±¡ã€å€¼æ•°ç»„æˆ–è€…å…¶ä»–ç‰¹æ®Šç±»å‹ï¼Œæ¯”å¦‚è¡¨ç¤ºæ—¥æœŸçš„å­—ç¬¦ä¸²æˆ–è€…è¡¨ç¤ºåœ°ç†ä½ç½®çš„å¯¹è±¡</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>         <span class="string">&quot;John Smith&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span>          <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;confirmed&quot;</span><span class="punctuation">:</span>    <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;join_date&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;2014-06-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;home&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span>      <span class="number">51.5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span>      <span class="number">0.1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;accounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;facebook&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;johnsmith&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;twitter&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;johnsmith&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºå¯¹è±¡(object)å’Œæ–‡æ¡£(document)æ˜¯ç­‰ä»·ç›¸é€šçš„ã€‚ä¸è¿‡ï¼Œä»–ä»¬è¿˜æ˜¯æœ‰æ‰€å·®åˆ«ï¼šå¯¹è±¡(Object)æ˜¯ä¸€ä¸ªJSONç»“æ„ä½“â€”â€”ç±»ä¼¼äºå“ˆå¸Œã€hashmapã€å­—å…¸æˆ–è€…å…³è”æ•°ç»„ï¼›å¯¹è±¡(Object)ä¸­è¿˜å¯èƒ½åŒ…å«å…¶ä»–å¯¹è±¡(Object)ã€‚ åœ¨Elasticsearchä¸­ï¼Œæ–‡æ¡£(document)è¿™ä¸ªæœ¯è¯­æœ‰ç€ç‰¹æ®Šå«ä¹‰ã€‚å®ƒç‰¹æŒ‡æœ€é¡¶å±‚ç»“æ„æˆ–è€…æ ¹å¯¹è±¡(root object)åºåˆ—åŒ–æˆçš„JSONæ•°æ®ï¼ˆä»¥å”¯ä¸€IDæ ‡è¯†å¹¶å­˜å‚¨äºElasticsearchä¸­ï¼‰ã€‚</p></blockquote><h3 id="å½’ç»“"><a href="#å½’ç»“" class="headerlink" title="å½’ç»“"></a>å½’ç»“</h3><ol><li><p>Json Object,ç”±å­—æ®µç»„æˆï¼š</p><ul><li>å­—ç¬¦ä¸²ï¼štext, keyword</li><li>æ•°å€¼å‹ï¼šlong,integer,short,byte,double,float,half_float,scled_float</li><li>å¸ƒå°”ï¼šboolean</li><li>æ—¥æœŸï¼šdate</li><li>äºŒè¿›åˆ¶ï¼šbinary</li><li>èŒƒå›´ç±»å‹ï¼šinteger_range,float_range,long_range,double_range,date_range</li></ul></li><li><p>æ¯ä¸ªæ–‡æ¡£æœ‰å”¯ä¸€çš„idæ ‡è¯†</p><ul><li>è‡ªè¡ŒæŒ‡å®š</li><li>esç”Ÿæˆ</li></ul></li><li><p>å…ƒæ•°æ®ï¼Œç”¨äºæ ‡æ³¨æ–‡æ¡£çš„ç›¸å…³ä¿¡æ¯</p><ul><li>_indexï¼šæ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•å</li><li>_typeï¼šæ–‡æ¡£æ‰€åœ¨çš„ç±»å‹å</li><li>_idï¼šæ–‡æ¡£å”¯ä¸€id</li><li>_uidï¼šç»„åˆid,ç”±_typeå’Œ_idç»„æˆ(6.x_typeä¸å†èµ·ä½œç”¨ï¼ŒåŒ_idä¸€æ ·)</li><li>_sourceï¼šæ–‡æ¡£çš„åŸå§‹Jsonæ•°æ®ï¼Œå¯ä»¥ä»è¿™é‡Œè·å–æ¯ä¸ªå­—æ®µçš„å†…å®¹</li><li>_allï¼šæ•´åˆæ‰€æœ‰å­—æ®µå†…å®¹åˆ°è¯¥å­—æ®µï¼Œé»˜è®¤ç¦ç”¨</li></ul></li></ol><h3 id="æ–‡æ¡£å…ƒæ•°æ®"><a href="#æ–‡æ¡£å…ƒæ•°æ®" class="headerlink" title="æ–‡æ¡£å…ƒæ•°æ®"></a>æ–‡æ¡£å…ƒæ•°æ®</h3><p>ä¸€ä¸ªæ–‡æ¡£ä¸åªæœ‰æ•°æ®ã€‚å®ƒè¿˜åŒ…å«äº†å…ƒæ•°æ®(metadata)â€”â€”å…³äºæ–‡æ¡£çš„ä¿¡æ¯ã€‚ä¸‰ä¸ªå¿…é¡»çš„å…ƒæ•°æ®èŠ‚ç‚¹æ˜¯ï¼š</p><table><thead><tr><th>èŠ‚ç‚¹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>_index</td><td>æ–‡æ¡£å­˜å‚¨çš„åœ°æ–¹</td></tr><tr><td>_type</td><td>æ–‡æ¡£ä»£è¡¨çš„å¯¹è±¡çš„ç±»</td></tr><tr><td>_id</td><td>æ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†</td></tr></tbody></table><p><strong>_index</strong></p><p>ç´¢å¼•(index)ç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“é‡Œçš„â€œæ•°æ®åº“â€â€”â€”å®ƒæ˜¯æˆ‘ä»¬å­˜å‚¨å’Œç´¢å¼•å…³è”æ•°æ®çš„åœ°æ–¹ã€‚</p><blockquote><p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„æ•°æ®è¢«å­˜å‚¨å’Œç´¢å¼•åœ¨åˆ†ç‰‡(shards)ä¸­ï¼Œç´¢å¼•åªæ˜¯ä¸€ä¸ªæŠŠä¸€ä¸ªæˆ–å¤šä¸ªåˆ†ç‰‡åˆ†ç»„åœ¨ä¸€èµ·çš„é€»è¾‘ç©ºé—´ã€‚ç„¶è€Œï¼Œè¿™åªæ˜¯ä¸€äº›å†…éƒ¨ç»†èŠ‚â€”â€”æˆ‘ä»¬çš„ç¨‹åºå®Œå…¨ä¸ç”¨å…³å¿ƒåˆ†ç‰‡ã€‚å¯¹äºæˆ‘ä»¬çš„ç¨‹åºè€Œè¨€ï¼Œæ–‡æ¡£å­˜å‚¨åœ¨ç´¢å¼•(index)ä¸­ã€‚å‰©ä¸‹çš„ç»†èŠ‚ç”±Elasticsearchå…³å¿ƒæ—¢å¯ã€‚</p></blockquote><p><strong>_type</strong><br>åœ¨åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯¹è±¡è¡¨ç¤ºä¸€äº›â€œäº‹ç‰©â€ï¼Œä¾‹å¦‚ä¸€ä¸ªç”¨æˆ·ã€ä¸€ç¯‡åšå®¢ã€ä¸€ä¸ªè¯„è®ºï¼Œæˆ–è€…ä¸€å°é‚®ä»¶ã€‚æ¯ä¸ªå¯¹è±¡éƒ½å±äºä¸€ä¸ªç±»(class)ï¼Œè¿™ä¸ªç±»å®šä¹‰äº†å±æ€§æˆ–ä¸å¯¹è±¡å…³è”çš„æ•°æ®ã€‚userç±»çš„å¯¹è±¡å¯èƒ½åŒ…å«å§“åã€æ€§åˆ«ã€å¹´é¾„å’ŒEmailåœ°å€ã€‚<br>åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸å°†ç›¸åŒç±»çš„å¯¹è±¡å­˜å‚¨åœ¨ä¸€ä¸ªè¡¨é‡Œï¼Œå› ä¸ºå®ƒä»¬æœ‰ç€ç›¸åŒçš„ç»“æ„ã€‚åŒç†ï¼Œåœ¨Elasticsearchä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒç±»å‹(type)çš„æ–‡æ¡£è¡¨ç¤ºç›¸åŒçš„â€œäº‹ç‰©â€ï¼Œå› ä¸ºä»–ä»¬çš„æ•°æ®ç»“æ„ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚<br>æ¯ä¸ªç±»å‹(type)éƒ½æœ‰è‡ªå·±çš„æ˜ å°„(mapping)æˆ–è€…ç»“æ„å®šä¹‰ï¼Œå°±åƒä¼ ç»Ÿæ•°æ®åº“è¡¨ä¸­çš„åˆ—ä¸€æ ·ã€‚æ‰€æœ‰ç±»å‹ä¸‹çš„æ–‡æ¡£è¢«å­˜å‚¨åœ¨åŒä¸€ä¸ªç´¢å¼•ä¸‹ï¼Œä½†æ˜¯ç±»å‹çš„æ˜ å°„(mapping)ä¼šå‘Šè¯‰Elasticsearchä¸åŒçš„æ–‡æ¡£å¦‚ä½•è¢«ç´¢å¼•ã€‚</p><blockquote><p>åœ¨7.0å‰ï¼Œä¸€ä¸ªindexå¯ä»¥è®¾ç½®å¤šä¸ªtype,åœ¨7.0åtypeç»Ÿä¸€ä¸º_doc</p></blockquote><p><strong>_id</strong></p><p>idä»…ä»…æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒä¸_indexå’Œ_typeç»„åˆæ—¶ï¼Œå°±å¯ä»¥åœ¨Elasticsearchä¸­å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ–‡æ¡£ã€‚å½“åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰_idï¼Œä¹Ÿå¯ä»¥è®©Elasticsearchå¸®ä½ è‡ªåŠ¨ç”Ÿæˆã€‚</p><h2 id="Index-Api"><a href="#Index-Api" class="headerlink" title="Index Api"></a>Index Api</h2><p>ä»¥ä¸‹æ“ä½œå‡åœ¨es7.2ç‰ˆæœ¬æ“ä½œ</p><h3 id="Index-createorupdate"><a href="#Index-createorupdate" class="headerlink" title="Index(createorupdate)"></a>Index(createorupdate)</h3><p>PUT {_index}&#x2F;{_type}&#x2F;{_id}<br>POST {_index}&#x2F;{_type}&#x2F;{_id}(idå¯ä¸æŒ‡å®š)</p><p>åˆ›å»ºä¸€ä¸ªç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªç´¢å¼•å¹¶æŒ‡å®šæ–‡æ¡£å†…å®¹å’Œid</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;alfred&quot;,</span><br><span class="line">  &quot;age&quot;:1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªç´¢å¼•æŒ‡å®šæ–‡æ¡£å†…å®¹è‡ªåŠ¨ç”Ÿæˆid</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;lili&quot;,</span><br><span class="line">  &quot;age&quot;:22</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–‡æ¡£ä¸å­˜åœ¨æ‰§è¡Œçš„æ˜¯åˆ›å»ºæ“ä½œï¼Œå­˜åœ¨çš„è¯å›å˜ä¸ºæ›´æ–°æ“ä½œï¼Œå¹¶ä¸”_versionä¼šå¢åŠ 1</p><h3 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h3><p>æœ‰ä¸¤ç§æ–¹å¼:</p><p>ç¬¬ä¸€ç§æ–¹æ³•ä½¿ç”¨op_typeæŸ¥è¯¢å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1?op_type=create</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;alfred&quot;,</span><br><span class="line">  &quot;age&quot;:1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…ç¬¬äºŒç§æ–¹æ³•æ˜¯åœ¨URLååŠ &#x2F;_createåšä¸ºç«¯ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/1/_create</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;alfred&quot;,</span><br><span class="line">  &quot;age&quot;:1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¯·æ±‚æˆåŠŸçš„åˆ›å»ºäº†ä¸€ä¸ªæ–°æ–‡æ¡£ï¼ŒElasticsearchå°†è¿”å›æ­£å¸¸çš„å…ƒæ•°æ®ä¸”å“åº”çŠ¶æ€ç æ˜¯201 Createdã€‚<br>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœåŒ…å«ç›¸åŒçš„_indexã€_typeå’Œ_idçš„æ–‡æ¡£å·²ç»å­˜åœ¨ï¼ŒElasticsearchå°†è¿”å›409 Conflictå“åº”çŠ¶æ€ç ï¼Œé”™è¯¯ä¿¡æ¯ç±»ä¼¼å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [6])&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vENoH2YDQRiFHvu_pfzDcg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [6])&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vENoH2YDQRiFHvu_pfzDcg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">409</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>POSTå’ŒPUTçš„åŒºåˆ«æ˜¯POSTä¸ç”¨åŠ å…·ä½“çš„idï¼Œå®ƒæ˜¯ä½œç”¨åœ¨ä¸€ä¸ªé›†åˆèµ„æºä¹‹ä¸Šçš„ï¼ˆ&#x2F;uriï¼‰ï¼Œè€ŒPUTæ“ä½œæ˜¯ä½œç”¨åœ¨ä¸€ä¸ªå…·ä½“èµ„æºä¹‹ä¸Šçš„ï¼ˆ&#x2F;uri&#x2F;xxxï¼‰ã€‚<br>åœ¨ESä¸­ï¼Œå¦‚æœä¸ç¡®å®šdocumentçš„IDï¼ˆdocumentså…·ä½“å«ä¹‰è§ä¸‹ï¼‰ï¼Œé‚£ä¹ˆç›´æ¥POSTå¯¹åº”uriï¼ˆ â€œPOST &#x2F;website&#x2F;blogâ€ ï¼‰ï¼ŒESå¯ä»¥è‡ªå·±ç”Ÿæˆä¸ä¼šå‘ç”Ÿç¢°æ’çš„UUIDï¼›<br>å¦‚æœç¡®å®šdocumentçš„IDï¼Œæ¯”å¦‚ â€œPUT &#x2F;website&#x2F;blog&#x2F;123â€ï¼Œé‚£ä¹ˆæ‰§è¡Œåˆ›å»ºæˆ–ä¿®æ”¹ï¼ˆä¿®æ”¹æ—¶_versionç‰ˆæœ¬å·æé«˜1ï¼‰</p></blockquote><h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;hobby&quot;: &quot;hit&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE test_index</span><br></pre></td></tr></table></figure><h3 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h3><p>è·å–æ‰€æœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_search</span><br></pre></td></tr></table></figure><p>æŒ‡å®šid</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/1</span><br></pre></td></tr></table></figure><p>å½’ç»“</p><table><thead><tr><th>æ“ä½œ</th><th>è¯·æ±‚</th></tr></thead><tbody><tr><td>Create</td><td>PUT &#x2F;test_index&#x2F;_doc&#x2F;1&#x2F;_create<br>{â€œusernameâ€:â€alfredâ€,â€ageâ€:1}<br>POST &#x2F;test_index&#x2F;_doc&#x2F;<br>{â€œusernameâ€:â€alfredâ€,â€ageâ€:1}(ä¸æŒ‡å®šidè‡ªåŠ¨ç”Ÿæˆ)</td></tr><tr><td>Index</td><td>PUT Or POST &#x2F;test_index&#x2F;_doc&#x2F;1&#x2F;<br>{â€œusernameâ€:â€alfredâ€,â€ageâ€:1}</td></tr><tr><td>Read</td><td>GET &#x2F;test_index&#x2F;_doc&#x2F;1</td></tr><tr><td>Update</td><td>POST &#x2F;test_index&#x2F;_update&#x2F;1<br>{â€œdocâ€: {â€œsexâ€: â€œå¥³â€}}</td></tr><tr><td>Delete</td><td>DELETE test_index2</td></tr></tbody></table><blockquote><p>Indexå’ŒUpdate<br>Indexå®é™…ä¸Šæ˜¯æ–‡æ¡£ä¸å­˜åœ¨ä¼šåˆ›å»ºä¸€ä¸ªæ–‡æ¡£ï¼Œå­˜åœ¨åˆ™ä¼šåˆ é™¤åŸæ¥çš„æ–‡æ¡£ï¼Œæ–°çš„æ–‡æ¡£è¢«ç´¢å¼•ï¼Œå¹¶ä¸”versionåŠ 1<br>Updateä¸ä¼šåˆ é™¤åŸæ¥çš„æ–‡æ¡£ï¼Œå®ç°çœŸæ­£çš„æ›´æ–°ï¼ŒPOSTæ–¹æ³•çš„payloadéœ€åŒ…å«åœ¨â€docâ€é‡Œ</p></blockquote><h3 id="Bulk"><a href="#Bulk" class="headerlink" title="Bulk"></a>Bulk</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;test_index&quot;,&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;username&quot;:&quot;alfred&quot;,&quot;age&quot;:20&#125;</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;test_index&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_id&quot;:&quot;2&quot;,&quot;_index&quot;:&quot;test_index&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;age&quot;:&quot;20&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰¹é‡æŸ¥è¯¢api"><a href="#æ‰¹é‡æŸ¥è¯¢api" class="headerlink" title="æ‰¹é‡æŸ¥è¯¢api"></a>æ‰¹é‡æŸ¥è¯¢api</h3><p>eså…è®¸ä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªæ–‡æ¡£ï¼Œå¦‚æœä½ éœ€è¦ä»Elasticsearchä¸­æ£€ç´¢å¤šä¸ªæ–‡æ¡£ï¼Œç›¸å¯¹äºä¸€ä¸ªä¸€ä¸ªçš„æ£€ç´¢ï¼Œæ›´å¿«çš„æ–¹å¼æ˜¯åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­ä½¿ç”¨multi-getæˆ–è€…mget APIã€‚</p><p>mget APIå‚æ•°æ˜¯ä¸€ä¸ªdocsæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªèŠ‚ç‚¹å®šä¹‰ä¸€ä¸ªæ–‡æ¡£çš„_indexã€_typeã€_idå…ƒæ•°æ®ã€‚å¦‚æœä½ åªæƒ³æ£€ç´¢ä¸€ä¸ªæˆ–å‡ ä¸ªç¡®å®šçš„å­—æ®µï¼Œä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ª_sourceå‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST _mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 1,</span><br><span class="line">      &quot;_index&quot;:&quot;test_index&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 2,</span><br><span class="line">      &quot;_index&quot;:&quot;test_index&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“åº”ä½“ä¹ŸåŒ…å«ä¸€ä¸ªdocsæ•°ç»„ï¼Œæ¯ä¸ªæ–‡æ¡£è¿˜åŒ…å«ä¸€ä¸ªå“åº”ï¼Œå®ƒä»¬æŒ‰ç…§è¯·æ±‚å®šä¹‰çš„é¡ºåºæ’åˆ—ã€‚æ¯ä¸ªè¿™æ ·çš„å“åº”ä¸å•ç‹¬ä½¿ç”¨get requestå“åº”ä½“ç›¸åŒï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;lili&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;john&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;40&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³æ£€ç´¢çš„æ–‡æ¡£åœ¨åŒä¸€ä¸ª_indexä¸­ï¼Œä½ å°±å¯ä»¥åœ¨URLä¸­å®šä¹‰ä¸€ä¸ªé»˜è®¤çš„&#x2F;_indexã€‚<br>ä½ ä¾æ—§å¯ä»¥åœ¨å•ç‹¬çš„è¯·æ±‚ä¸­ä½¿ç”¨è¿™äº›å€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc/_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123; &quot;_id&quot; : 2 &#125;,</span><br><span class="line">      &#123; &quot;_id&quot; : 1 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨7.0ä»¥ä¸Šç‰ˆæœ¬åï¼Œ_docåœ¨mgetä¸­å¯ä»¥çœç•¥ï¼Œä¸çœç•¥ä¼šæç¤º#! Deprecation: [types removal] Specifying types in multi get requests is deprecated.</p></blockquote><p>äº‹å®ä¸Šï¼Œå¦‚æœæ‰€æœ‰æ–‡æ¡£å…·æœ‰ç›¸åŒ_indexï¼Œä½ å¯ä»¥é€šè¿‡ç®€å•çš„idsæ•°ç»„æ¥ä»£æ›¿å®Œæ•´çš„docsæ•°ç»„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;ids&quot; : [ &quot;4&quot;, &quot;1&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸å­˜åœ¨çš„æ–‡æ¡£ä¼šæ˜¾ç¤ºfound:false</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;lili&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>å°½ç®¡å‰é¢æåˆ°æœ‰ä¸€ä¸ªæ–‡æ¡£æ²¡æœ‰è¢«æ‰¾åˆ°ï¼Œä½†HTTPè¯·æ±‚çŠ¶æ€ç è¿˜æ˜¯200ã€‚äº‹å®ä¸Šï¼Œå°±ç®—æ‰€æœ‰æ–‡æ¡£éƒ½æ‰¾ä¸åˆ°ï¼Œè¯·æ±‚ä¹Ÿè¿˜æ˜¯è¿”å›200ï¼ŒåŸå› æ˜¯mgetè¯·æ±‚æœ¬èº«æˆåŠŸäº†ã€‚å¦‚æœæƒ³çŸ¥é“æ¯ä¸ªæ–‡æ¡£æ˜¯å¦éƒ½æˆåŠŸäº†ï¼Œä½ éœ€è¦æ£€æŸ¥foundæ ‡å¿—ã€‚</p></blockquote></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2022/02/24/2022-02-24-mysql(1)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å½­è¯—äº®çš„åšå®¢"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/2022/02/24/2022-02-24-mysql(1)/" class="post-title-link" itemprop="url">Mysqlé”</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-24 22:30:00" itemprop="dateCreated datePublished" datetime="2022-02-24T22:30:00+08:00">2022-02-24</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-19 15:31:17" itemprop="dateModified" datetime="2023-01-19T15:31:17+08:00">2023-01-19</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><h3 id="äº‹ç‰©éš”ç¦»åœºæ™¯"><a href="#äº‹ç‰©éš”ç¦»åœºæ™¯" class="headerlink" title="äº‹ç‰©éš”ç¦»åœºæ™¯"></a>äº‹ç‰©éš”ç¦»åœºæ™¯</h3><p>repeatable-read</p><h3 id="è¡¨è¯­å¥å‡†å¤‡"><a href="#è¡¨è¯­å¥å‡†å¤‡" class="headerlink" title="è¡¨è¯­å¥å‡†å¤‡"></a>è¡¨è¯­å¥å‡†å¤‡</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `d` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `c` (`c`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),</span><br><span class="line">(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>),(<span class="number">15</span>,<span class="number">15</span>,<span class="number">15</span>),(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),(<span class="number">25</span>,<span class="number">25</span>,<span class="number">25</span>);</span><br></pre></td></tr></table></figure><p>å…ˆå‡è®¾ä¸€ä¸ªæ²¡æœ‰å µå¡çš„åœºæ™¯ï¼š</p><table><thead><tr><th></th><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>T1</td><td>begin;<br>select * from t where d&#x3D;5 for update;<br><font color="red">result:(5,5,5)</font></td><td></td><td></td></tr><tr><td>T2</td><td></td><td>update t set d&#x3D;5 where id&#x3D;0;</td><td></td></tr><tr><td>T3</td><td>select * from t where d&#x3D;5 for update;<br><font color="red">result:(0,0,5)(5,5,5)</font></td><td></td><td></td></tr><tr><td>T4</td><td></td><td></td><td>insert into t values(1,1,5);</td></tr><tr><td>T5</td><td>select * from t where d&#x3D;5 for update;<br><font color="red">result:(0,0,5)(1,1,5)(5,5,5)</font></td><td></td><td></td></tr><tr><td>T6</td><td>commit;</td><td></td><td></td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°ï¼Œsession A é‡Œæ‰§è¡Œäº†ä¸‰æ¬¡æŸ¥è¯¢ï¼Œåˆ†åˆ«æ˜¯ Q1ã€Q2 å’Œ Q3ã€‚å®ƒä»¬çš„ SQL è¯­å¥ç›¸åŒï¼Œéƒ½æ˜¯ select * from t where d&#x3D;5 for updateã€‚æŸ¥æ‰€æœ‰ d&#x3D;5 çš„è¡Œï¼Œè€Œä¸”ä½¿ç”¨çš„æ˜¯å½“å‰è¯»ï¼Œå¹¶ä¸”åŠ ä¸Šå†™é”ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸‰æ¡ SQL è¯­å¥ï¼Œåˆ†åˆ«ä¼šè¿”å›ä»€ä¹ˆç»“æœã€‚</p><ol><li>Q1 åªè¿”å› id&#x3D;5 è¿™ä¸€è¡Œï¼›</li><li>åœ¨ T2 æ—¶åˆ»ï¼Œsession B æŠŠ id&#x3D;0 è¿™ä¸€è¡Œçš„ d å€¼æ”¹æˆäº† 5ï¼Œå› æ­¤ T3 æ—¶åˆ» Q2 æŸ¥å‡ºæ¥çš„æ˜¯ id&#x3D;0 å’Œ id&#x3D;5 è¿™ä¸¤è¡Œï¼›</li><li>åœ¨ T4 æ—¶åˆ»ï¼Œsession C åˆæ’å…¥ä¸€è¡Œï¼ˆ1,1,5ï¼‰ï¼Œå› æ­¤ T5 æ—¶åˆ» Q3 æŸ¥å‡ºæ¥çš„æ˜¯ id&#x3D;0ã€id&#x3D;1 å’Œ id&#x3D;5 çš„è¿™ä¸‰è¡Œã€‚</li></ol><p>å…¶ä¸­ï¼ŒQ3 è¯»åˆ° id&#x3D;1 è¿™ä¸€è¡Œçš„ç°è±¡ï¼Œè¢«ç§°ä¸ºâ€œå¹»è¯»â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹»è¯»æŒ‡çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨å‰åä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ—¶å€™ï¼Œåä¸€æ¬¡æŸ¥è¯¢çœ‹åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰çœ‹åˆ°çš„è¡Œã€‚</p><h2 id="Mysqlå¦‚ä½•è§£å†³å¹»è¯»"><a href="#Mysqlå¦‚ä½•è§£å†³å¹»è¯»" class="headerlink" title="Mysqlå¦‚ä½•è§£å†³å¹»è¯»"></a>Mysqlå¦‚ä½•è§£å†³å¹»è¯»</h2><h3 id="æœ¬ç‰‡éœ€è¦ç”¨åˆ°çš„ä¸¤ç§é”"><a href="#æœ¬ç‰‡éœ€è¦ç”¨åˆ°çš„ä¸¤ç§é”" class="headerlink" title="æœ¬ç‰‡éœ€è¦ç”¨åˆ°çš„ä¸¤ç§é”"></a>æœ¬ç‰‡éœ€è¦ç”¨åˆ°çš„ä¸¤ç§é”</h3><p>LOCK IN SHARE MODEæ˜¯è¯»é”(åªæ˜¯ä¸è®©åˆ«äººå†™)ï¼ŒFOR UPDATEæ˜¯å†™é”(è¿˜ä¸è®©åˆ«äººåŠ è¯»é”)</p><h3 id="InnoDBè¡Œé”"><a href="#InnoDBè¡Œé”" class="headerlink" title="InnoDBè¡Œé”"></a>InnoDBè¡Œé”</h3><p>InnoDBè¡Œé”æ˜¯é€šè¿‡ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹æ¥å®ç°çš„ï¼ŒInnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³è€…ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä¼šä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ï¼<br>å¦‚<code>select * from t where d=5 for update;</code>ä¼šé”ä½d&#x3D;5ç´¢å¼•è¦†ç›–èŒƒå›´çš„ç›¸å…³è¡Œï¼Œå¦‚æœæ²¡æœ‰ç´¢å¼•åˆ™ä¼šé”ä½æ‰€æœ‰è¡Œ</p><h3 id="é—´éš™é”-Gap-Lock"><a href="#é—´éš™é”-Gap-Lock" class="headerlink" title="é—´éš™é” (Gap Lock)"></a>é—´éš™é” (Gap Lock)</h3><p>è¡Œé”åªèƒ½é”ä½è¡Œï¼Œä½†æ˜¯æ–°æ’å…¥è®°å½•è¿™ä¸ªåŠ¨ä½œï¼Œè¦æ›´æ–°çš„æ˜¯è®°å½•ä¹‹é—´çš„â€œé—´éš™â€ã€‚å› æ­¤ï¼Œä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼ŒInnoDB åªå¥½å¼•å…¥æ–°çš„é”ï¼Œä¹Ÿå°±æ˜¯é—´éš™é” (Gap Lock)ã€‚<br>é—´éš™é”ï¼Œé”çš„å°±æ˜¯ä¸¤ä¸ªå€¼ä¹‹é—´çš„ç©ºéš™ã€‚æ¯”å¦‚æ–‡ç« å¼€å¤´çš„è¡¨ tï¼Œåˆå§‹åŒ–æ’å…¥äº† 6 ä¸ªè®°å½•ï¼Œè¿™å°±äº§ç”Ÿäº† 7 ä¸ªé—´éš™ã€‚<br>è¿™æ ·ï¼Œå½“ä½ æ‰§è¡Œ select * from t where d&#x3D;5 for update çš„æ—¶å€™ï¼Œå°±ä¸æ­¢æ˜¯ç»™æ•°æ®åº“ä¸­å·²æœ‰çš„ 6 ä¸ªè®°å½•åŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜åŒæ—¶åŠ äº† 7 ä¸ªé—´éš™é”ã€‚è¿™æ ·å°±ç¡®ä¿äº†æ— æ³•å†æ’å…¥æ–°çš„è®°å½•ã€‚</p><h3 id="è¡Œé”å’Œé—´éš™é”æ¯”è¾ƒ"><a href="#è¡Œé”å’Œé—´éš™é”æ¯”è¾ƒ" class="headerlink" title="è¡Œé”å’Œé—´éš™é”æ¯”è¾ƒ"></a>è¡Œé”å’Œé—´éš™é”æ¯”è¾ƒ</h3><p>è¡Œé”ï¼Œåˆ†æˆè¯»é”å’Œå†™é”ã€‚ä¸‹å›¾å°±æ˜¯è¿™ä¸¤ç§ç±»å‹è¡Œé”çš„å†²çªå…³ç³»ã€‚</p><table><thead><tr><th></th><th>è¯»é”</th><th>å†™é”</th></tr></thead><tbody><tr><td>è¯»é”</td><td><font color="green">å…¼å®¹</font></td><td><font color="red">å†²çª</font></td></tr><tr><td>å†™é”</td><td><font color="red">å†²çª</font></td><td><font color="red">å†²çª</font></td></tr></tbody></table><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè·Ÿè¡Œé”æœ‰å†²çªå…³ç³»çš„æ˜¯â€œå¦å¤–ä¸€ä¸ªè¡Œé”â€ã€‚<br>ä½†æ˜¯é—´éš™é”ä¸ä¸€æ ·ï¼Œ<strong>è·Ÿé—´éš™é”å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œæ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œã€‚</strong>é—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»ã€‚</p><table><thead><tr><th>SessionA</th><th>SessionB</th></tr></thead><tbody><tr><td>begin;<br>select * from t where c&#x3D;7 lock in share mode;</td><td></td></tr><tr><td></td><td>begin;<br>select * from t where c&#x3D;7 for update;</td></tr></tbody></table><p>è¿™é‡Œ session B å¹¶ä¸ä¼šè¢«å µä½ã€‚å› ä¸ºè¡¨ t é‡Œå¹¶æ²¡æœ‰ c&#x3D;7 è¿™ä¸ªè®°å½•ï¼Œå› æ­¤ session A åŠ çš„æ˜¯é—´éš™é” (5,10)ã€‚è€Œ session B ä¹Ÿæ˜¯åœ¨è¿™ä¸ªé—´éš™åŠ çš„é—´éš™é”ã€‚å®ƒä»¬æœ‰å…±åŒçš„ç›®æ ‡ï¼Œå³ï¼šä¿æŠ¤è¿™ä¸ªé—´éš™ï¼Œä¸å…è®¸æ’å…¥å€¼ã€‚ä½†ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯ä¸å†²çªçš„ã€‚</p><p>é—´éš™é”å’Œè¡Œé”åˆç§° next-key lockï¼Œæ¯ä¸ª next-key lock æ˜¯å‰å¼€åé—­åŒºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„è¡¨ t åˆå§‹åŒ–ä»¥åï¼Œå¦‚æœç”¨ select * from t for update è¦æŠŠæ•´ä¸ªè¡¨æ‰€æœ‰è®°å½•é”èµ·æ¥ï¼Œå°±å½¢æˆäº† 7 ä¸ª next-key lockï¼Œåˆ†åˆ«æ˜¯ (-âˆ,0]ã€(0,5]ã€(5,10]ã€(10,15]ã€(15,20]ã€(20, 25]ã€(25, +supremum]ã€‚</p><p><strong>é—´éš™é”å’Œ next-key lock çš„å¼•å…¥ï¼Œå¸®æˆ‘ä»¬è§£å†³äº†å¹»è¯»çš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€äº›â€œå›°æ‰°â€ã€‚</strong></p><p>çœ‹ä¸‹é¢çš„å®ä¾‹</p><table><thead><tr><th>SessionA</th><th>SessionB</th></tr></thead><tbody><tr><td>begin;<br>select * from t where id&#x3D;9 for update;</td><td></td></tr><tr><td></td><td>begin;<br>select * from t where id&#x3D;9 for update;</td></tr><tr><td></td><td>insert into t values(9,9,9);<br><font color="red">result:(blocked)</font></td></tr><tr><td>insert into t values(9,9,9);<br><font color="red">result:(Deadlock)</font></td><td></td></tr></tbody></table><p>ä¸Šé¢çš„åœºæ™¯å½¢æˆæ­»é”äº†ã€‚æˆ‘ä»¬æŒ‰è¯­å¥æ‰§è¡Œé¡ºåºæ¥åˆ†æä¸€ä¸‹ï¼š</p><ol><li>session A æ‰§è¡Œ select â€¦ for update è¯­å¥ï¼Œç”±äº id&#x3D;9 è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šåŠ ä¸Šé—´éš™é” (5,10);</li><li>session B æ‰§è¡Œ select â€¦ for update è¯­å¥ï¼ŒåŒæ ·ä¼šåŠ ä¸Šé—´éš™é” (5,10)ï¼Œé—´éš™é”ä¹‹é—´ä¸ä¼šå†²çªï¼Œå› æ­¤è¿™ä¸ªè¯­å¥å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼›</li><li>session B è¯•å›¾æ’å…¥ä¸€è¡Œ (9,9,9)ï¼Œè¢« session A çš„é—´éš™é”æŒ¡ä½äº†ï¼Œåªå¥½è¿›å…¥ç­‰å¾…ï¼›</li><li>session A è¯•å›¾æ’å…¥ä¸€è¡Œ (9,9,9)ï¼Œè¢« session B çš„é—´éš™é”æŒ¡ä½äº†ã€‚</li></ol><p>è‡³æ­¤ï¼Œä¸¤ä¸ª session è¿›å…¥äº’ç›¸ç­‰å¾…çŠ¶æ€ï¼Œå½¢æˆæ­»é”ã€‚å½“ç„¶ï¼ŒInnoDB çš„æ­»é”æ£€æµ‹é©¬ä¸Šå°±å‘ç°äº†è¿™å¯¹æ­»é”å…³ç³»ï¼Œè®© session A çš„ insert è¯­å¥æŠ¥é”™è¿”å›äº†ã€‚</p><h2 id="mysqlé”ç±»å‹"><a href="#mysqlé”ç±»å‹" class="headerlink" title="mysqlé”ç±»å‹"></a>mysqlé”ç±»å‹</h2><p>é”è§„åˆ™é‡Œé¢ï¼ŒåŒ…å«äº†ä¸¤ä¸ªâ€œåŸåˆ™â€ã€ä¸¤ä¸ªâ€œä¼˜åŒ–â€å’Œä¸€ä¸ªâ€œbugâ€ã€‚</p><blockquote><p>MySQL åé¢çš„ç‰ˆæœ¬å¯èƒ½ä¼šæ”¹å˜åŠ é”ç­–ç•¥ï¼Œæ‰€ä»¥è¿™ä¸ªè§„åˆ™åªé™äºæˆªæ­¢åˆ°ç°åœ¨çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå³ 5.x ç³»åˆ— &lt;&#x3D;5.7.24ï¼Œ8.0 ç³»åˆ— &lt;&#x3D;8.0.13ã€‚</p></blockquote><p>åŸåˆ™ 1ï¼šåŠ é”çš„åŸºæœ¬å•ä½æ˜¯ next-key lockã€‚å¸Œæœ›ä½ è¿˜è®°å¾—ï¼Œnext-key lock æ˜¯å‰å¼€åé—­åŒºé—´ã€‚<br>åŸåˆ™ 2ï¼šæŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ã€‚<br>ä¼˜åŒ– 1ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œç»™å”¯ä¸€ç´¢å¼•åŠ é”çš„æ—¶å€™ï¼Œnext-key lock é€€åŒ–ä¸ºè¡Œé”ã€‚<br>ä¼˜åŒ– 2ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶çš„æ—¶å€™ï¼Œnext-key lock é€€åŒ–ä¸ºé—´éš™é”ã€‚<br>ä¸€ä¸ªç‰¹æ®Šåœºæ™¯ï¼šå”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚</p><h3 id="ç­‰å€¼æŸ¥è¯¢é—´éš™é”"><a href="#ç­‰å€¼æŸ¥è¯¢é—´éš™é”" class="headerlink" title="ç­‰å€¼æŸ¥è¯¢é—´éš™é”"></a>ç­‰å€¼æŸ¥è¯¢é—´éš™é”</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>update t set d&#x3D;d+1 where id&#x3D;7;</td><td></td><td></td></tr><tr><td></td><td>insert into t values(8,8,8);<br><font color="red">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>update t set d&#x3D;d+1 where id&#x3D;10;<br><font color="green">result:(ok)</font></td></tr></tbody></table><p>ç”±äºè¡¨ t ä¸­æ²¡æœ‰ id&#x3D;7 çš„è®°å½•ï¼Œæ‰€ä»¥ç”¨æˆ‘ä»¬ä¸Šé¢æåˆ°çš„åŠ é”è§„åˆ™åˆ¤æ–­ä¸€ä¸‹çš„è¯ï¼š</p><ol><li>æ ¹æ®åŸåˆ™ 1ï¼ŒåŠ é”å•ä½æ˜¯ next-key lockï¼Œsession A åŠ é”èŒƒå›´å°±æ˜¯ (5,10]ï¼›</li><li>åŒæ—¶æ ¹æ®ä¼˜åŒ– 2ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰å€¼æŸ¥è¯¢ (id&#x3D;7)ï¼Œè€Œ id&#x3D;10 ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ï¼Œnext-key lock é€€åŒ–æˆé—´éš™é”ï¼Œå› æ­¤æœ€ç»ˆåŠ é”çš„èŒƒå›´æ˜¯ (5,10)ã€‚</li></ol><p>æ‰€ä»¥ï¼Œsession B è¦å¾€è¿™ä¸ªé—´éš™é‡Œé¢æ’å…¥ id&#x3D;8 çš„è®°å½•ä¼šè¢«é”ä½ï¼Œä½†æ˜¯ session C ä¿®æ”¹ id&#x3D;10 è¿™è¡Œæ˜¯å¯ä»¥çš„ã€‚</p><h3 id="éå”¯ä¸€ç´¢å¼•ç­‰å€¼é”"><a href="#éå”¯ä¸€ç´¢å¼•ç­‰å€¼é”" class="headerlink" title="éå”¯ä¸€ç´¢å¼•ç­‰å€¼é”"></a>éå”¯ä¸€ç´¢å¼•ç­‰å€¼é”</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select id from t where c&#x3D;5 lock in share mode(è¯»é”);</td><td></td><td></td></tr><tr><td></td><td>update t set d&#x3D;d+1 where id&#x3D;5;<br><font color="green">result:(ok)</font></td><td></td></tr><tr><td></td><td></td><td>insert into t values(7,7,7);<br><font color="red">result:(blocked)</font></td></tr></tbody></table><p>çœ‹åˆ°è¿™ä¸ªä¾‹å­ï¼Œä½ æ˜¯ä¸æ˜¯æœ‰ä¸€ç§â€œè¯¥é”çš„ä¸é”ï¼Œä¸è¯¥é”çš„ä¹±é”â€çš„æ„Ÿè§‰ï¼Ÿæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å§ã€‚</p><ol><li>æ ¹æ®åŸåˆ™ 1ï¼ŒåŠ é”å•ä½æ˜¯ next-key lockï¼Œå› æ­¤ä¼šç»™ (0,5] åŠ ä¸Š next-key lockã€‚</li><li>è¦æ³¨æ„ c æ˜¯æ™®é€šç´¢å¼•ï¼Œå› æ­¤ä»…è®¿é—® c&#x3D;5 è¿™ä¸€æ¡è®°å½•æ˜¯ä¸èƒ½é©¬ä¸Šåœä¸‹æ¥çš„ï¼Œéœ€è¦å‘å³éå†ï¼ŒæŸ¥åˆ° c&#x3D;10 æ‰æ”¾å¼ƒã€‚æ ¹æ®åŸåˆ™ 2ï¼Œè®¿é—®åˆ°çš„éƒ½è¦åŠ é”ï¼Œå› æ­¤è¦ç»™ (5,10] åŠ  next-key lockã€‚</li><li>ä½†æ˜¯åŒæ—¶è¿™ä¸ªç¬¦åˆä¼˜åŒ– 2ï¼šç­‰å€¼åˆ¤æ–­ï¼Œå‘å³éå†ï¼Œæœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ c&#x3D;5 è¿™ä¸ªç­‰å€¼æ¡ä»¶ï¼Œå› æ­¤é€€åŒ–æˆé—´éš™é” (5,10)ã€‚</li><li>æ ¹æ®åŸåˆ™ 2 ï¼Œ<strong>åªæœ‰è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”</strong>ï¼Œè¿™ä¸ªæŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¹¶ä¸éœ€è¦è®¿é—®ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥ä¸»é”®ç´¢å¼•ä¸Šæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ session B çš„ update è¯­å¥å¯ä»¥æ‰§è¡Œå®Œæˆã€‚</li></ol><p>ä½† session C è¦æ’å…¥ä¸€ä¸ª (7,7,7) çš„è®°å½•ï¼Œå°±ä¼šè¢« session A çš„é—´éš™é” (5,10) é”ä½ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œlock in share mode åªé”è¦†ç›–ç´¢å¼•ï¼Œä½†æ˜¯å¦‚æœæ˜¯ for update å°±ä¸ä¸€æ ·äº†ã€‚ æ‰§è¡Œ for update æ—¶ï¼Œç³»ç»Ÿä¼šè®¤ä¸ºä½ æ¥ä¸‹æ¥è¦æ›´æ–°æ•°æ®ï¼Œå› æ­¤ä¼šé¡ºä¾¿ç»™ä¸»é”®ç´¢å¼•ä¸Šæ»¡è¶³æ¡ä»¶çš„è¡ŒåŠ ä¸Šè¡Œé”ã€‚</p></blockquote><p>è¿™ä¸ªä¾‹å­è¯´æ˜ï¼Œé”æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šçš„ï¼›åŒæ—¶ï¼Œå®ƒç»™æˆ‘ä»¬çš„æŒ‡å¯¼æ˜¯ï¼Œå¦‚æœä½ è¦ç”¨ lock in share mode æ¥ç»™è¡ŒåŠ è¯»é”é¿å…æ•°æ®è¢«æ›´æ–°çš„è¯ï¼Œå°±å¿…é¡»å¾—ç»•è¿‡è¦†ç›–ç´¢å¼•çš„ä¼˜åŒ–ï¼Œåœ¨æŸ¥è¯¢å­—æ®µä¸­åŠ å…¥ç´¢å¼•ä¸­ä¸å­˜åœ¨çš„å­—æ®µã€‚æ¯”å¦‚ï¼Œå°† session A çš„æŸ¥è¯¢è¯­å¥æ”¹æˆ select d from t where c&#x3D;5 lock in share modeã€‚</p><h3 id="ä¸»é”®ç´¢å¼•èŒƒå›´é”"><a href="#ä¸»é”®ç´¢å¼•èŒƒå›´é”" class="headerlink" title="ä¸»é”®ç´¢å¼•èŒƒå›´é”"></a>ä¸»é”®ç´¢å¼•èŒƒå›´é”</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select * from t where id &gt;&#x3D;10 and id&lt;11 for update;</td><td></td><td></td></tr><tr><td></td><td>insert into t values(7,7,7);<br><font color="green">result:(ok)</font><br>insert into t values(13,13,13);<br><font color="red">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>update t set d&#x3D;d+1 where id&#x3D;15;<br><font color="red">result:(blocked)</font></td></tr></tbody></table><ol><li>å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦æ‰¾åˆ°ç¬¬ä¸€ä¸ª id&#x3D;10 çš„è¡Œï¼Œå› æ­¤æœ¬è¯¥æ˜¯ next-key lock(5,10]ã€‚ æ ¹æ®ä¼˜åŒ– 1ï¼Œ ä¸»é”® id ä¸Šçš„ç­‰å€¼æ¡ä»¶ï¼Œé€€åŒ–æˆè¡Œé”ï¼ŒåªåŠ äº† id&#x3D;10 è¿™ä¸€è¡Œçš„è¡Œé”ã€‚</li><li>èŒƒå›´æŸ¥æ‰¾å°±å¾€åç»§ç»­æ‰¾ï¼Œæ‰¾åˆ° id&#x3D;15 è¿™ä¸€è¡Œåœä¸‹æ¥ï¼Œå› æ­¤éœ€è¦åŠ  next-key lock(10,15]ã€‚</li></ol><p>æ‰€ä»¥ï¼Œsession A è¿™æ—¶å€™é”çš„èŒƒå›´å°±æ˜¯ä¸»é”®ç´¢å¼•ä¸Šï¼Œè¡Œé” id&#x3D;10 å’Œ next-key lock(10,15]ã€‚</p><h3 id="éå”¯ä¸€ç´¢å¼•èŒƒå›´é”"><a href="#éå”¯ä¸€ç´¢å¼•èŒƒå›´é”" class="headerlink" title="éå”¯ä¸€ç´¢å¼•èŒƒå›´é”"></a>éå”¯ä¸€ç´¢å¼•èŒƒå›´é”</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select * from t where c&gt;10 and c&lt;11 for update;</td><td></td><td></td></tr><tr><td></td><td>insert into t values(8,8,8);<br><font color="red">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>update t set d&#x3D;d+1 where id&#x3D;15;<br><font color="red">result:(blocked)</font></td></tr></tbody></table><p>è¿™æ¬¡ session A ç”¨å­—æ®µ c æ¥åˆ¤æ–­ï¼ŒåŠ é”è§„åˆ™è·Ÿä¸»é”®ç´¢å¼•èŒƒå›´é”å”¯ä¸€çš„ä¸åŒæ˜¯ï¼šåœ¨ç¬¬ä¸€æ¬¡ç”¨ c&#x3D;10 å®šä½è®°å½•çš„æ—¶å€™ï¼Œç´¢å¼• c ä¸ŠåŠ äº† (5,10] è¿™ä¸ª next-key lock åï¼Œç”±äºç´¢å¼• c æ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œæ²¡æœ‰ä¼˜åŒ–è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šèœ•å˜ä¸ºè¡Œé”ï¼Œå› æ­¤æœ€ç»ˆ sesion A åŠ çš„é”æ˜¯ï¼Œç´¢å¼• c ä¸Šçš„ (5,10] å’Œ (10,15] è¿™ä¸¤ä¸ª next-key lockã€‚</p><h3 id="å”¯ä¸€ç´¢å¼•èŒƒå›´é”ç‰¹æ®Šåœºæ™¯"><a href="#å”¯ä¸€ç´¢å¼•èŒƒå›´é”ç‰¹æ®Šåœºæ™¯" class="headerlink" title="å”¯ä¸€ç´¢å¼•èŒƒå›´é”ç‰¹æ®Šåœºæ™¯"></a>å”¯ä¸€ç´¢å¼•èŒƒå›´é”ç‰¹æ®Šåœºæ™¯</h3><table><thead><tr><th>SessionA</th><th>SessionB</th><th>SessionC</th></tr></thead><tbody><tr><td>begin;<br>select * from t where id &gt;10 and id&lt;&#x3D;15 for update;</td><td></td><td></td></tr><tr><td></td><td>update t set d&#x3D;d+1 where id&#x3D;20;<br><font color="green">result:(blocked)</font></td><td></td></tr><tr><td></td><td></td><td>insert into t values(16,16,16);<br><font color="red">result:(blocked)</font></td></tr></tbody></table><p>session A æ˜¯ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢ï¼ŒæŒ‰ç…§åŸåˆ™ 1 çš„è¯ï¼Œåº”è¯¥æ˜¯ç´¢å¼• id ä¸ŠåªåŠ  (10,15] è¿™ä¸ª next-key lockï¼Œå¹¶ä¸”å› ä¸º id æ˜¯å”¯ä¸€é”®ï¼Œæ‰€ä»¥å¾ªç¯åˆ¤æ–­åˆ° id&#x3D;15 è¿™ä¸€è¡Œå°±åº”è¯¥åœæ­¢äº†ã€‚<br>ä½†æ˜¯å®ç°ä¸Šï¼ŒInnoDB ä¼šå¾€å‰æ‰«æåˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„è¡Œä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯ id&#x3D;20ã€‚è€Œä¸”ç”±äºè¿™æ˜¯ä¸ªèŒƒå›´æ‰«æï¼Œå› æ­¤ç´¢å¼• id ä¸Šçš„ (15,20] è¿™ä¸ª next-key lockä¹Ÿä¼šè¢«é”ä¸Šã€‚</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a></nav></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview"> ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">enpsl</p><div class="site-description" itemprop="description">my blog</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">31</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span></div><div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script></body></html>